!function(){function e(){this.data={}}function i(e){var i=e.q,t=e.r,r=-i-t,n=Math.round(i),o=Math.round(r),a=Math.round(t),l=Math.abs(n-i),s=Math.abs(o-r),c=Math.abs(a-t);return l>s&&l>c?n=-o-a:s>c?o=-n-a:a=-n-o,{q:n,r:a}}function t(e,t,r){var n=e.x+t.x0,o=e.y+t.y0;return i({q:(Math.sqrt(3)*n-o)/3/r,r:2*o/3/r})}function r(e,i,t){return{x:(t*Math.sqrt(3)*(e.q+e.r/2)|0)-i.x0,y:3*t/2*e.r-i.y0}}function n(e,i){var t=Si.tile(i),r={x:0,y:0};return r.x+=t.a*(e<<1)-e|0,r.y+=t.a*(e<<1)-e|0,r}function o(e){var i=e.getContext("2d"),t=40;return{hexSize:t,origin:{x0:0,y0:0},canvas:e,ctx:i,width:e.width,height:e.height}}function a(e,i,t,n,o,a){var s=e.ctx,c=e.hexSize,u=e.origin;s.beginPath();var m=[];for(var v in i)for(var y=Si.tileFromKey(v),d=(r(y,u,c),0);6>d;d++){var g=Si.neighborFromTile(y,d);void 0===i[Si.keyFromTile(g)]&&(m=m.concat(l(v,d)))}f(e,h(e,m,t,o),!!a)}function l(e,i){var t=(i+4)%6,r=(t+1)%6;return[s(e,t),s(e,r)]}function s(e,i){return 0===i?Si.keyFromTile(Si.neighborFromTile(Si.tileFromKey(e),2))+":0":1===i?Si.keyFromTile(Si.neighborFromTile(Si.tileFromKey(e),3))+":1":2===i?Si.keyFromTile(Si.neighborFromTile(Si.tileFromKey(e),3))+":0":3===i?Si.keyFromTile(Si.neighborFromTile(Si.tileFromKey(e),4))+":1":4===i?e+":0":5===i?e+":1":"invalid:vertex:key"}function c(e,i,t,o){var a=e.hexSize,l=e.origin,s=+i.slice(-1),c=i.slice(0,-2),h=Si.tileFromKey(c),u=r(h,l,a),f=0|u.x,m=0|u.y,v=t/2|0,y=a/2|0,d=o?n(a,h):{x:0,y:0};return 0===s?{x:f+v+d.x,y:m+y+d.y}:1===s?{x:f+v,y:m-y}:void 0}function h(e,i,t,r){for(var n=(e.hexSize,e.origin,new Array(i.length)),o=0;o<i.length;o++)n[o]=i[o];for(var a=[];n.length>0;){for(var l=n.shift(),s=n.shift(),h=[c(e,l,t,r),c(e,s,t,r)],u=1e4;s!==l&&u-->0;)for(var o=0;o<n.length;o+=2){if(n[o]===s){h.push(c(e,n[o+1],t,r)),s=n[o+1],n.splice(o,2);break}if(n[o+1]===s){h.push(c(e,n[o],t,r)),s=n[o],n.splice(o,2);break}}h.pop(),a.push(h)}return a}function u(e,i){var t=e.ctx;t.moveTo(i[0].x,i[0].y);for(var r=1;r<i.length;r++)t.lineTo(i[r].x,i[r].y);t.closePath()}function f(e,i,t){var r=e.ctx;r.beginPath();for(var n=0;n<i.length;n++)v(e,i[n],!!t)}function m(e,i){return{x:e.x+i.x>>1,y:e.y+i.y>>1}}function v(e,i,t){t=!!t;var r=e.ctx;if(i.length<3)return u(e,i);for(var n,o=new Array(i.length),a=0;a<i.length;a++)n=m(i[a],i[(a+1)%i.length]),o[a]=n;var n=m(o[0],o[1]);r.moveTo(n.x,n.y);for(var a=1;a<o.length;a++)n=m(o[a],o[(a+1)%o.length]),t&&a%2===0?r.moveTo(n.x,n.y):r.quadraticCurveTo(o[a].x,o[a].y,n.x,n.y);t||(n=m(o[0],o[1]),r.quadraticCurveTo(o[0].x,o[0].y,n.x,n.y))}function y(e,i){var t=(e.ctx,e.hexSize),n=e.origin;if(null!=yi&&null!=Mi){d(e,yi,I(Ai.turn,50,40),5);var o=r(yi,n,t);for(var a in i){var l=r(Si.tileFromKey(a),n,t);L(e,o,l,"rgba(200,200,200,0.5)")}}for(var a in i){var s="rgba(255,255,255,0.3)";Si.transitionTile(yi,Si.tileFromKey(a))&&(s="rgba(255,140,140,0.3)"),d(e,Si.tileFromKey(a),s,5)}}function d(e,i,t,n){var o=e.ctx,a=e.hexSize,l=e.origin,s=(a*Math.sqrt(3),3*a/2),c=r(i,l,a),h=s>>2;o.beginPath(),o.arc(c.x,c.y,h,0,2*Math.PI,!0),o.closePath(),o.strokeStyle=t,o.lineWidth=n?n:3,o.stroke(),o.lineWidth=1}function g(e){if(null===ni){ri=Object.create(null),ni=Object.create(null);for(var i=e.width,n=e.height,o=(e.ctx,e.hexSize),a=e.origin,l=t({x:0,y:0},a,o),s=r({q:l.q,r:l.r-1},a,o),c=s.x,h=s.y,u=o*Math.sqrt(3),f=3*o/2,m=!0,c=s.x,h=s.y;n>h-f;){for(;i>c-u;)l=t({x:c,y:h},a,o),ri[Si.keyFromTile(l)]=!0,c-u/2>0&&c+u/2<e.width&&h-f/2>0&&h+f/2<e.height&&(ni[Si.keyFromTile(l)]=!0),c+=u;h+=f,c=s.x,m?(c-=u/2,m=!1):m=!0,c=0|c,h=0|h}}}function x(e){e.ctx.fillStyle=oi[_.earth],e.ctx.fill()}function T(e){e.ctx.fillStyle=oi[_.fire],e.ctx.fill()}function F(e){e.ctx.fillStyle=oi[_.air],e.ctx.fill()}function p(e){e.ctx.fillStyle=oi[_.water],e.ctx.fill()}function k(e,i){var t=e.ctx,r=e.hexSize,n=(e.origin,r*Math.sqrt(3)),o=3*r/2,l=[];l[_.earth]=x,l[_.fire]=T,l[_.air]=F,l[_.water]=p;for(var s=0;4>s;s++){var c=Object.create(null);for(var h in ri){var u=Si.tileFromKey(h),f=Si.tile(u);f.t>=s&&(c[h]=!0)}a(e,c,n,o,!0),t.save(),t.clip(),l[s](e),t.restore()}b(e,function(){w(e),i()})}function b(e,i){var t=1e3*Math.random()|0,r=.3,n='<svg xmlns="http://www.w3.org/2000/svg" width="'+e.width+'" height="'+e.height+'"><filter id="a" x="0" y="0" width="100%" height="100%"><feTurbulence type="fractalNoise" baseFrequency=".01" numOctaves="5" seed="'+t+'"/><feColorMatrix values="1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0 '+r+'"/></filter><rect width="100%" height="100%" filter="url(#a)"/></svg>',o=new Image;o.src="data:image/svg+xml;base64,"+btoa(n),o.onload=function(){e.ctx.drawImage(o,0,0),i()}}function w(e){for(var i=e.width,n=e.height,o=e.ctx,a=e.hexSize,l=e.origin,s=t({x:0,y:0},l,a),c=r({q:s.q,r:s.r-1},l,a),h=c.x,u=c.y,f=a*Math.sqrt(3),m=3*a/2,v=0;9>v;v++)for(var y=!0,h=c.x,u=c.y;n>u-m;){for(;i>h-f;){s=t({x:h,y:u},l,a);var d=Si.tile(s);d.r&&(o.beginPath(),o.arc(h,u,7,0,2*Math.PI,!0),o.closePath(),o.strokeStyle="black",o.stroke()),h+=f}u+=m,h=c.x,y?(h-=f/2,y=!1):y=!0,h=0|h,u=0|u}}function C(e){for(var i in ni)S(e,i)}function S(e,i){for(var t=e.ctx,n=Si.tileFromKey(i),o=Si.tile(n),a=r(n,e.origin,e.hexSize),l=0;l<o.n.length;l++){var s=o.n[l],c=r(Si.tileFromKey(s),e.origin,e.hexSize),h=I(o.c,50,40);L(e,a,c,h),t.setLineDash([2,10]),t.lineDashOffset=mi,t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(a.x,a.y),t.strokeStyle=h,t.lineWidth=4,t.stroke(),t.setLineDash([])}}function q(e,i){if(null==si){si=document.createElement("canvas"),si.width=e.width,si.height=e.height;var t=o(si);t.hexSize=e.hexSize,t.origin=e.origin,k(t,function(){e.ctx.drawImage(si,0,0),i()})}else e.ctx.drawImage(si,0,0),i()}function M(e){q(e,function(){z(e)})}function K(e){return{x:e.clientX-ci.clientX,y:e.clientY-ci.clientY}}function L(e,i,t,r){r=r||"#333";var n=e.ctx,o=t.x-i.x,a=t.y-i.y,l=20,s=o/l,c=a/l;n.strokeStyle=r,n.lineCap="round";for(var h=i.x,u=i.y,f=0;l>f;f++){n.beginPath(),n.moveTo(h,u),h+=s,u+=c,n.lineTo(h,u);var m=f/l-.5;n.lineWidth=7*(4*m*m+.1),n.stroke()}n.beginPath(),n.lineTo(t.x,t.y),n.lineWidth=5,n.stroke(),n.lineWidth=1}function z(e){e.ctx,e.hexSize,e.origin;if(C(e),y(e,vi),Fi){var i=r(t(K(gi),e.origin,e.hexSize),e.origin,e.hexSize),n=K(xi);L(e,i,n,"#333")}O(e),X(e),void 0!==Li&&E(e,[Li.winType+" Victory.",Li.winners[0]===Mi?"YOU WON! ("+A(localStorage.getItem("gamesWon"))+" win!)":"YOU NEARLY WON! ("+A(Li.winners.indexOf(Mi)+1)+" place!)","You can reload to engage in the next game!"],I(Li.winners[0])),hi&&E(e,["Welcome to Thaddée Tyl's…","A Verse On Leverage","Give me a lever long enough; I shall lift the universe!"],"silver"),fi.drawImage(ii,0,0)}function A(e){e=0|e;var i=""+e;if(49===i.charCodeAt(i.length-2))return i+"th";var t=e%10;return 1===t?i+"st":2===t?i+"nd":3===t?i+"rd":i+"th"}function E(e,i,t){var r=e.ctx,n=e.width,o=e.height,a=i[0],l=i[1],s=i[2];r.fillStyle=t||"black",t&&(r.strokeStyle="black"),r.textAlign="center",r.font=o/16+'px "Linux Biolinum", sans-serif',r.fillText(a,n/2,1*o/3),t&&r.strokeText(a,n/2,1*o/3),r.font=o/8+'px "Linux Biolinum", sans-serif',r.fillText(l,n/2,13*o/24),t&&r.strokeText(l,n/2,13*o/24),r.font=o/16+'px "Linux Biolinum", sans-serif',r.fillText(s,n/2,2*o/3),t&&r.strokeText(s,n/2,2*o/3),r.textAlign="start"}function P(){mi+=1,mi>=ei&&(mi=0),M(ti)}function O(e){for(var i in ni)Y(e,i)}function Y(e,i){var t=e.ctx,n=(e.hexSize,e.origin,Si.tileFromKey(i)),o=Si.tile(n);if(void 0!==o.c&&o.p>0){var a=r(n,e.origin,e.hexSize),l=10;t.beginPath(),t.arc(a.x,a.y,l,0,2*Math.PI,!0),t.closePath(),t.fillStyle=I(o.c,50,40),t.fill(),t.beginPath(),t.arc(a.x,a.y,l-2,0,2*Math.PI,!0),t.closePath(),t.strokeStyle="white",t.stroke(),t.font=l+"px sans-serif",t.textAlign="center",t.fillStyle="white";{var s=""+o.p;t.measureText(s).width}t.fillText(s,a.x,a.y+l/4)}}function I(e,i,t,r){return null==i&&(i=100),null==t&&(t=45),null==r&&(r=1),"hsla("+W(e)+","+i+"%,"+t+"%,"+r+")"}function W(e){return e>0?(W(e-1)+60)%360:270}function X(e){e.ctx,e.hexSize,e.origin}function D(){ti.canvas.removeEventListener("mousemove",j),ti.canvas.removeEventListener("mouseup",D)}function j(){ti.canvas.style.cursor="move",ti.canvas.removeEventListener("mousemove",j),ti.canvas.removeEventListener("mouseup",D),ti.canvas.addEventListener("mouseup",B),ti.canvas.addEventListener("mousemove",N),Fi=!0,R(),pi=setInterval(R,Ci)}function B(){ti.canvas.style.cursor="",ti.canvas.removeEventListener("mousemove",N),ti.canvas.removeEventListener("mouseup",B),Fi=!1,clearInterval(pi),U(),V(),Ai.move({type:zi.move,at:Si.keyFromTile(yi),to:Si.keyFromTile(di)}),M(ti)}function N(e){if(!Ti){Ti=!0;{xi.clientX-e.clientX,xi.clientY-e.clientY}xi.clientX=e.clientX,xi.clientY=e.clientY,ai.paused&&ai.play(),di=t(K(xi),ti.origin,ti.hexSize),M(ti),requestAnimationFrame(function(){Ti=!1})}}function R(){wi=Date.now(),bi[0]=ti.origin.x0,bi[1]=ti.origin.y0}function U(){wi=Date.now()-wi,bi[0]=ti.origin.x0-bi[0],bi[1]=ti.origin.y0-bi[1];var e=.03*wi;ki[0]=bi[0]/e|0,ki[1]=bi[1]/e|0}function V(){ti.origin.x0+=ki[0],ti.origin.y0+=ki[1],ki[0]=ki[0]/1.1|0,ki[1]=ki[1]/1.1|0,M(ti),requestAnimationFrame(function(){(0!==ki[0]||0!==ki[1])&&V()})}function G(e){this.camp=e}function H(e){var i=[];for(var t in ni){var r=Si.tileFromKey(t),n=Si.tile(r);e(r,n)&&i.push(r)}return i}function J(){this.id=Ki,Ki++;var e=H(function(e,i){for(var t=i.t===_.earth,r=void 0===i.c,n=!1,o=0;6>o;o++){var a=Si.neighborFromTile(e,o);if(ni[Si.keyFromTile(e)]&&Si.tile(a).r){n=!0;break}}return t&&r&&n});this.baseTile=e[Math.random()*e.length|0];var i=Si.tile(this.baseTile);i.c=this.id,i.p=1}function Q(){this.camps=new Array(qi);for(var e=0;qi>e;e++)this.camps[e]=new J;for(var i in ni)Si.tile(Si.keyFromTile(i))&&this.resources++;this.ai=new G(this.camps[1])}function Z(){Si=new e,ri=null,ni=null,g(ti),Ki=0,Ai=new Q,M(ti)}function $(){Ei=uiai.checked}var _={water:0,fire:1,earth:2,air:3},ei=9007199254740992;e.prototype={data:{},tile:function(e){var i=this.keyFromTile(e);return null==this.data[i]&&(this.data[i]={t:4*Math.random()|0,r:e.q%3===0&&e.r%3===2,a:Math.random(),p:0,n:[],v:[]}),this.data[i]},neighborFromTile:function(e,i){return 0===i?{q:e.q+1,r:e.r}:1===i?{q:e.q+1,r:e.r-1}:2===i?{q:e.q,r:e.r-1}:3===i?{q:e.q-1,r:e.r}:4===i?{q:e.q-1,r:e.r+1}:5===i?{q:e.q,r:e.r+1}:void 0},keyFromTile:function(e){return e.q+":"+e.r},tileFromKey:function(e){var i=e.split(":");return{q:0|i[0],r:0|i[1]}},accessibleTiles:function(e){var i=this.tile(e),t=Object.create(null);if(null==i.c)return t;if(i.p<=0)return t;var r;if(i.t===_.earth)for(var n=0;6>n;n++){var o=this.neighborFromTile(e,n);r=this.keyFromTile(o),t[r]=[r]}else if(i.t===_.fire){var o=this.neighborFromTile(e,1),a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,1),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,2);var a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,2),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,5);var a=this.keyFromTile(o);o=this.neighborFromTile(o,5),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,4);var a=this.keyFromTile(o);o=this.neighborFromTile(o,4),r=this.keyFromTile(o),t[r]=[a,r]}else if(i.t===_.air){var o=this.neighborFromTile(e,1),a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,0),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,5);var a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,4),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,3);var a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,2),r=this.keyFromTile(o),t[r]=[a,r]}else if(i.t===_.water){var o=this.neighborFromTile(e,0),a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,0),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,3);var a=this.keyFromTile(o);t[a]=[a],o=this.neighborFromTile(o,3),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,1);var a=this.keyFromTile(o);o=this.neighborFromTile(o,2),r=this.keyFromTile(o),t[r]=[a,r],o=this.neighborFromTile(e,4);var a=this.keyFromTile(o);o=this.neighborFromTile(o,5),r=this.keyFromTile(o),t[r]=[a,r]}for(var l in t)for(var n=0;n<t[l].length;n++){var r=t[l][n],e=this.tileFromKey(r),s=this.tile(e);if(!ni[r]||s.c===i.c||n<t[l].length-1&&null!=s.c){delete t[l];break}}return t},transitionElement:function(e){switch(e){case _.fire:return _.air;case _.air:return _.water;case _.water:return _.fire}},antiTransitionElement:function(e){switch(e){case _.fire:return _.water;case _.air:return _.fire;case _.water:return _.air}},transitionTile:function(e,i){var t=Si.tile(e).t,r=Si.tile(i).t;return r===this.transitionElement(t)},powerAgainst:function(e){var i=0,t=this.tile(e),r=this.keyFromTile(e);for(var n in ni){var o=this.tile(this.tileFromKey(n));o.v.indexOf(r)>=0&&o.c!==t.c&&(i+=o.p)}return i}};var ii=document.getElementById("canvas");ii.width=1280,ii.height=720,ii.style.marginLeft=(document.documentElement.clientWidth-ii.width>>1)+"px";var ti=o(ii),ri=(-Math.PI/3,null),ni=null,oi=new Array(4);oi[_.earth]="#7a4",oi[_.fire]="#b94",oi[_.air]="#974",oi[_.water]="#44a";var ai=new Audio,li=new Audio;window.addEventListener("load",function(){ai.src="cr.mp3",li.src="pop.mp3"});var si,ci={clientX:ii.offsetLeft,clientY:ii.offsetTop},hi=!0;setTimeout(function(){hi=!1,M(ti)},8e3);var ui=document.createElement("canvas");ui.width=ti.width,ui.height=ti.height;{var fi=ui.getContext("2d"),mi=0;setInterval(P,200)}window.onkeydown=function(e){var i=!1,t=!1;39===e.keyCode||68===e.keyCode?(ti.origin.x0+=ti.width/2|0,t=!0):38===e.keyCode||87===e.keyCode?(ti.origin.y0-=ti.height/2|0,t=!0):37===e.keyCode||65===e.keyCode?(ti.origin.x0-=ti.width/2|0,t=!0):40===e.keyCode||83===e.keyCode?(ti.origin.y0+=ti.height/2|0,t=!0):187===e.keyCode||61===e.keyCode?(ti.hexSize*=2,ti.origin.x0=2*ti.origin.x0+ti.width/2|0,ti.origin.y0=2*ti.origin.y0+ti.height/2|0,i=!0,t=!0):173===e.keyCode||189===e.keyCode||109===e.keyCode||219===e.keyCode||169===e.keyCode?(ti.hexSize=ti.hexSize/2,ti.origin.x0=ti.origin.x0/2-ti.width/4|0,ti.origin.y0=ti.origin.y0/2-ti.height/4|0,i=!0,t=!0):84===e.keyCode?enterMode(selectionModes.travel):67===e.keyCode?enterMode(selectionModes.build):70===e.keyCode?enterMode(selectionModes.split):192===e.keyCode?sendBuild(yi,null):27===e.keyCode?(enterMode(selectionModes.normal),helpPane.style.display="none"):48<=e.keyCode&&e.keyCode<=57&&sendBuild(yi,buildHotKeys[e.keyCode]),i&&(cachedPaint={}),t&&M(ti)};var vi,yi,di;ti.canvas.onmousedown=function(e){hi=!1;var i=t(K(e),ti.origin,ti.hexSize);yi=i;var r=Si.tile(yi);switch(r.t){case _.earth:uitile.textContent="Earth";break;case _.fire:uitile.textContent="Fire";break;case _.air:uitile.textContent="Air";break;case _.water:uitile.textContent="Water"}uitile.style.color=oi[r.t],vi=Si.accessibleTiles(yi),M(ti),0===e.button?(ti.canvas.addEventListener("mouseup",D),ti.canvas.addEventListener("mousemove",j),gi.clientX=e.clientX,gi.clientY=e.clientY,xi.clientX=e.clientX,xi.clientY=e.clientY):2===e.button&&D(e)},ti.canvas.oncontextmenu=function(e){e.preventDefault()},function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,0)};window.requestAnimationFrame=e}();var gi={clientX:0,clientY:0},xi={clientX:0,clientY:0},Ti=!1,Fi=!1;ii.onselectstart=function(){return!1};var pi,ki=[0,0],bi=[0,0],wi=0,Ci=200;G.prototype={camp:null,move:function(){var e=[];for(var i in ni){var t=Si.tileFromKey(i),r=Si.tile(t);if(r.c===this.camp.id){var n=Si.accessibleTiles(t);for(var o in n){var a=Si.tileFromKey(o);e.push({tile:t,nextTile:a,score:this.scoreTile(a,t)})}}}for(var l=e[0],s=0;s<e.length;s++)e[s].score>l&&(l=e[s]);return{type:zi.move,at:Si.keyFromTile(l.tile),to:Si.keyFromTile(l.nextTile)}},scoreTile:function(e,i){var t=0,r=Si.tile(e),n=Si.tile(i);return r.r&&(t+=10),r.c!==this.camp.id&&(r.p>n.p?t++:t+=5),Si.transitionElement(n.t,r.t)&&(t+=5),t}};var Si,qi=2,Mi=0,Ki=0;J.prototype={id:0,baseTile:null,resources:0,bases:1,addTerrain:function(e){e.c!==this.id&&(this.bases++,e.r&&this.resources++,null!=e.c&&Ai.camps[e.c].rmTerrain(e))},rmTerrain:function(e){e.c===this.id&&(this.bases--,e.r&&this.resources--)}};var Li,zi={move:1,build:2};Q.prototype={camps:[],ai:null,turn:0,resources:0,nextTurn:function(){li.paused&&li.play(),this.turn=(this.turn+1)%qi,uiresources.textContent=this.camps.map(function(e){return e.resources}).join(" / "),uibases.textContent=this.camps.map(function(e){return e.bases}).join(" / "),this.checkWinConditions(),Ei&&1===this.turn&&this.move(this.ai.move())},validMove:function(e){var i=Si.tileFromKey(e.at),t=Si.tile(i);if(t.c!==this.turn)return!1;if(t.p<=0)return!1;if(e.type===zi.move){if(null==e.to)return!1;if(!Si.accessibleTiles(i)[e.to])return!1}else{if(e.type!==zi.build)return!1;if(null==zi.element)return!1;if(zi.element<0||zi.element>3)return!1;if(null!=t.f)return!1}return!0},move:function(e){if(this.validMove(e)){var i=Si.tileFromKey(e.at),t=Si.tile(i);if(e.type===zi.move){var r=Si.tileFromKey(e.to),n=Si.tile(r),o=Si.accessibleTiles(i),a=o[e.to];null!=n.c&&n.p<Si.powerAgainst(r)+t.p&&this.killSubgraph(r,n.c),t.v.indexOf(e.to)<0&&t.v.push(e.to);for(var l=t,s=0;s<a.length;s++){var c=Si.tile(Si.tileFromKey(a[s]));l.n.indexOf(a[s])<0&&l.n.push(a[s]),l=c}if(null==n.c||null!=n.c&&n.p<Si.powerAgainst(r)){for(var s=0;s<a.length-1;s++){var c=Si.tile(Si.tileFromKey(a[s]));this.camps[this.turn].addTerrain(c),c.c=this.turn,c.p=0}this.camps[this.turn].addTerrain(n),n.c=this.turn,n.p=t.p}Si.transitionTile(i,r)&&n.p++,this.clearDeadSegments()}else e.type===zi.build&&(t.f=e.element);this.nextTurn()}},killSubgraph:function(e,i,t){if(null==t&&(t=Object.create(null)),!t[Si.keyFromTile(e)]){t[Si.keyFromTile(e)]=!0;var r=Si.tile(e);if(r.c===i){for(var n=0;n<r.n.length;n++){{var o=r.n[n],a=Si.tileFromKey(o);Si.tile(a)}this.killSubgraph(a,i,t)}null!=this.camps[r.c]&&this.camps[r.c].rmTerrain(r),r.c=void 0,r.p=0,r.f=void 0,r.n=[],r.v=[]}}},clearDeadSegments:function(){for(var e in ni){var i=Si.tileFromKey(e),t=Si.tile(i);(null==t.c||t.p<=0&&0===t.n.length)&&(t.n=[],t.v=[],this.killLinksTo(i))}},killLinksTo:function(e){var i=(Si.tile(e),Si.keyFromTile(e));for(var t in ni){var r=Si.tileFromKey(t),n=Si.tile(r),o=n.n.indexOf(i);o>=0&&n.n.splice(o,1)}},checkWinConditions:function(){for(var e=this,i=0;qi>i;i++){if(this.countCampLocations(i)<=0)return Li={winners:this.listCamps().sort(function(i,t){return e.countCampLocations(t)-e.countCampLocations(i)}),winType:"Supremacy"};if(this.camps[i].resources>=this.resources>>1)return Li={winners:this.listCamps().sort(function(i,t){return e.resources(t)-e.resources(i)}),winType:"Economy"}}},listCamps:function(){for(var e=new Array(qi),i=0;qi>i;i++)e[i]=i;return e},countCampLocations:function(e){var i=0;for(var t in ni)Si.tile(Si.tileFromKey(t)).c===e&&i++;return i}};var Ai,Ei=!0;uihotseat.addEventListener("change",$),uiai.addEventListener("change",$),Z()}();