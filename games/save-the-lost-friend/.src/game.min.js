var Game={scale:20,gamePaused:!1,width:800,height:500,currentLevel:null,inInteraction:!1,nextLevel:null,levelKeys:{},gemsCollected:{},numberOfGemsCollected:0,gemsPlaced:{},numberOfGemsPlaced:0,GameFirstStart:!0,GameOver:!1},Vector=function(a,b){this.x=a;this.y=b};Vector.prototype.plus=function(a){return new Vector(this.x+a.x,this.y+a.y)};Vector.prototype.times=function(a){return new Vector(a*this.x,a*this.y)};
var getDirectionalPos=function(a){var b=[];b.push(new Vector(a.x,a.y-1));b.push(new Vector(a.x+1,a.y-1));b.push(new Vector(a.x+1,a.y));b.push(new Vector(a.x+1,a.y+1));b.push(new Vector(a.x,a.y+1));b.push(new Vector(a.x-1,a.y+1));b.push(new Vector(a.x-1,a.y));b.push(new Vector(a.x-1,a.y-1));return b},drawArc=function(a,b,c,d,e,f,g){a.beginPath();a.arc(b,c,d,e,f);a.stroke();g&&a.fill()},getRandomElement=function(a){return a[Math.floor(Math.random()*a.length)]},drawTree=function(a,b,c,d,e,f){var g=40,
g=20,c=c-150,j=Math.PI,k=2*Math.PI,i=c-(2*g*e-g),h,l=b-(g*d-25),m=360*Math.PI/360,n=i+2*e*g-2.5;a.fillStyle=f;a.beginPath();for(f=0;f<d;f++)h=l+g+2*f*g,drawArc(a,h,i,g,j,k),a.fill(),drawArc(a,h,n,g,0,m),a.fill();j=540*Math.PI/360;k=180*Math.PI/360;i=l+2*d*g-2.5;m=c-(2*g*e-2*g);for(f=0;f<e;f++)c1Y=m+2*f*g-2.5,drawArc(a,i,c1Y,g,j,k),a.fill(),drawArc(a,l,c1Y,g,k,j),a.fill();a.fillRect(b-(g*d-25),c-(2*g*e-g),2*g*d,2*g*e);a.fillStyle="brown";a.fillRect(b,c,50,150);a.strokeRect(b-1,c,52,150)},drawCloud=
function(a,b,c,d,e,f){a.lineWidth=3;a.lineCap="round";a.fillStyle=f;a.strokeStyle="#606060";var f=Math.PI,g=2*Math.PI;drawArc(a,b+d,c+d/2,d,f,g,!0);drawArc(a,b+2*d+e,c+d/2,e,f,g,!0);a.beginPath();a.moveTo(b,c+d/2);a.lineTo(b+2*d+2*e,c+d/2);a.stroke()};function drawTriangle(a,b,c,d,e,f){a.fillStyle=e;a.beginPath();a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.lineTo(d.x,d.y);a.closePath();f||a.stroke();a.fill()}
function drawDiamond(a,b,c,d,e){var f=Game.scale;a.fillStyle=e;a.fillRect(b+f/2,c-3*f,2*f,f);a.strokeRect(b+f/2,c-3*f,2*f,f);for(var g=0;3>g;g++){var j=new Vector(b+g*f,c-2*f),k=new Vector(b+g*f+f/2,c-3*f),i=new Vector(b+(g+1)*f,c-2*f);drawTriangle(a,j,k,i,d)}for(var h,g=0;6>g;g++)h=0==g%2?d:e,j=new Vector(b+g*f-g*f/2,c-2*f),k=new Vector(b+g*f/2+f/2,c-2*f),i=new Vector(b+1.5*f,c),drawTriangle(a,j,k,i,h)}
function drawEagle(a,b,c,d){a.lineWidth=2;a.lineCap="round";a.fillStyle="gold";a.beginPath();a.moveTo(b,c-8*d);a.quadraticCurveTo(b-0.5*d,c-8*d-d/2,b+1.5*d,c-9.5*d);a.moveTo(b,c-8*d);a.quadraticCurveTo(b,c-8*d-d/2,b+2.5*d,c-8*d-d/2);a.lineTo(b+1.5*d,c-9.5*d);a.fill();a.stroke();a.fillStyle="#FAFAD2";a.beginPath();a.moveTo(b+1.5*d,c-9.5*d);a.bezierCurveTo(b+5.5*d,c-15*d-d/2,b+7.8*d,c-10*d-d/2,b+7.7*d,c-5*d);a.moveTo(b+2.5*d,c-8*d-d/2);a.bezierCurveTo(b+4.5*d,c-6*d-d/2,b+0.5*d,c-5*d-d/2,b+0.4*d,c-4*
d);a.lineTo(b+7.7*d,c-5*d);a.stroke();a.fill();a.beginPath();a.moveTo(b+2.4*d,c-9*d);a.bezierCurveTo(b+3.5*d,c-9.5*d-d/2,b+4*d,c-9.9*d-d/2,b+5*d,c-9.7*d-d/2);a.bezierCurveTo(b+5*d,c-9.5*d-d/2,b+4*d,c-8.9*d-d/2,b+2.4*d,c-9*d);a.stroke();a.fillStyle="#DEB887";a.beginPath();a.moveTo(b+0.4*d,c-4*d);a.bezierCurveTo(b-1.5*d,c,b+3.5*d,c+4*d,b+5.5*d,c+6*d);a.lineTo(b+10*d,c+6*d);a.stroke();a.fill();drawTriangle(a,new Vector(b+0.4*d,c-4*d),new Vector(b+5.5*d,c+6*d),new Vector(b+7.7*d,c-5*d),"#DEB887",!0);
a.fillStyle="#DEA857";a.beginPath();a.moveTo(b+7.7*d,c-5*d);a.bezierCurveTo(b+13*d,c-1*d,b+12*d,c+2*d,b+12*d,c+6*d);a.moveTo(b+7.7*d,c-5*d);a.bezierCurveTo(b+1*d,c-3*d,b+5*d,c+2*d,b+10*d,c+6*d);a.lineTo(b+12*d,c+6*d);a.stroke();a.fill()}
function drawTurtoise(a,b,c,d){a.lineWidth=2;a.lineCap="round";a.fillStyle="#9ACD32";a.beginPath();a.moveTo(b+2*d,c-2.5*d);a.bezierCurveTo(b+2.3*d,c-6*d,b+4.5*d,c-6.2*d,b+7*d,c-6.5*d);a.bezierCurveTo(b+8*d,c-7.2*d,b+9.5*d,c-8*d,b+10.5*d,c-6.5*d);a.bezierCurveTo(b+11.5*d,c-6.5*d,b+13*d,c-5*d,b+12*d,c);a.bezierCurveTo(b+12.5*d,c+0.5*d,b+13*d,c+1*d,b+15.5*d,c+1.5*d);a.lineTo(b+14*d,c+3.5*d);a.bezierCurveTo(b+13*d,c+3*d,b+12*d,c+3*d,b+9.5*d,c+0.5*d);a.bezierCurveTo(b+7*d,c+1*d,b+3*d,c-0.5*d,b+2.5*d,c-
2.5*d);a.stroke();a.fill();a.beginPath();a.lineWidth=5;a.moveTo(b+2*d,c-2.5*d);a.bezierCurveTo(b+4.5*d,c-5*d,b+8*d,c,b+10*d,c-2.5*d);a.stroke();a.beginPath();a.lineWidth=3;a.moveTo(b+9.5*d,c+0.5*d);a.bezierCurveTo(b+9.5*d,c+0.5*d,b+10.5*d,c+0.3*d,b+10.6*d,c-0.5*d);a.moveTo(b+9.5*d,c-3*d);a.bezierCurveTo(b+9.5*d,c-3*d,b+10*d,c-3*d,b+10.2*d,c-2*d);a.stroke();a.fillStyle="#CCFFCC";a.beginPath();a.moveTo(b+8.7*d,c-5*d);a.arc(b+8.7*d,c-5*d,1.5*d,0,2*Math.PI);a.fill();a.fillStyle="#FFFFFF";a.beginPath();
a.arc(b+8.7*d,c-5*d,1.5*d-5,0,2*Math.PI);a.fill();a.fillStyle="#000000";a.beginPath();a.arc(b+8.7*d,c-5*d,d-3,0,2*Math.PI);a.fill();a.fillStyle="#EEE8AA";a.fillRect(b+14*d,c+2*d,24*d,3*d);a.fillStyle="#708090";a.beginPath();a.moveTo(b+26*d,c+3*d);a.arc(b+26*d,c+3*d,12*d,Math.PI,0);a.fill();a.fillStyle="#70a090";a.beginPath();a.arc(b+26*d,c+3*d,10*d,Math.PI,0);a.fill()}
function drawCrabEyes(a,b,c,d,e){a.fillStyle="#FEEEEE";a.beginPath();a.arc(b+e*d,c-7*d,1*d,0,2*Math.PI);a.fill();a.stroke();a.fillStyle="#222222";a.beginPath();a.arc(b+e*d,c-7*d,0.2*d,0,2*Math.PI);a.fill()}
function drawCrabClaws(a,b,c,d,e,f,g,j,k,i){a.fillStyle="#EE3500";a.lineWidth=4;a.beginPath();a.moveTo(b+d*i,c-4.2*i);a.lineTo(b+e*i,c-6*i);a.lineTo(b+f*i,c-8.5*i);a.lineTo(b+g*i,c-8.5*i);a.lineTo(b+g*i,c-6.5*i);a.lineTo(b+d*i,c-4.5*i);a.closePath();a.stroke();a.fill();a.lineWidth=3;a.beginPath();a.moveTo(b+j*i,c-9.8*i);a.arc(b+k*i,c-10.3*i,2*i-5,Math.PI+1*Math.PI/1.7,0,!0);a.fill();a.stroke()}
function drawCrab(a,b,c,d){a.lineWidth=2;a.lineCap="round";a.fillStyle="#FF4500";a.beginPath();a.moveTo(b+10*d,c-4.4*d);a.arc(b+10*d,c,8*d-5,Math.PI+1*Math.PI/5,1*-Math.PI/5);a.fill();a.fillStyle="#EE3500";a.beginPath();a.moveTo(b+10*d,c-4.4*d);a.arc(b+10*d,c-6*d,6.5*d-5,Math.PI-Math.PI/14,Math.PI/14,!0);a.fill();a.strokeStyle="#222222";a.lineWidth=4;a.beginPath();a.moveTo(b+6*d,c-4.4*d);a.bezierCurveTo(b+6*d,c-4.4*d,b+10*d,c-2*d,b+14*d,c-4.4*d);a.stroke();drawCrabEyes(a,b,c,d,7);drawCrabEyes(a,b,
c,d,13);drawCrabClaws(a,b,c,4.2,0,0.2,1,0.4,0.6,d);drawCrabClaws(a,b,c,15.7,19.9,20.1,18.9,19.6,19.4,d)}function drawOwlEyes(a,b,c,d,e){function f(b,c,d,e,f){a.fillStyle=e;a.beginPath();a.moveTo(b,c);a.arc(b,c,d,0,2*Math.PI);f&&a.stroke();a.fill()}f(b,c+3*e,4*e,"#EEEEEE",!0);f(b+e/3,c+2.8*e,2.4*e,"#B8860B",!0);f(b+e/3,c+2.8*e,1*e,"#222222",!0);f(b-0.4*e,c+1.7*e,0.8*e,"#EEEEEE",!1)}
function drawOwl(a,b,c,d){a.lineCap="round";a.fillStyle="#B8860B";a.strokeStyle="#B8860B";a.lineWidth=4;a.beginPath();a.moveTo(b-3*d,c+6.3*d);a.bezierCurveTo(b-4*d,c+10*d,b-5*d,c+12*d,b+1*d,c+20*d);a.moveTo(b+11*d,c+6.3*d);a.bezierCurveTo(b+12*d,c+10*d,b+13*d,c+12*d,b+8*d,c+20*d);a.stroke();a.fill();a.beginPath();a.moveTo(b-3*d,c+6.3*d);a.lineTo(b+1*d,c+20*d);a.lineTo(b+8*d,c+20*d);a.lineTo(b+11*d,c+6.3*d);a.closePath();a.fill();a.stroke();a.strokeStyle="#222222";a.lineWidth=10;a.beginPath();a.moveTo(b-
3.5*d,c+6.3*d);a.bezierCurveTo(b-4.5*d,c+10*d,b-5*d,c+12*d,b-2.8*d,c+15*d);a.moveTo(b+11.5*d,c+6.3*d);a.bezierCurveTo(b+12.5*d,c+10*d,b+13*d,c+12*d,b+11.3*d,c+15*d);a.stroke();a.strokeStyle="#222222";a.lineWidth=8;drawOwlEyes(a,b,c,0,d);drawOwlEyes(a,b+8*d,c,0,d);a.fillStyle="#B8860B";drawTriangle(a,new Vector(b,c-2*d),new Vector(b+4*d,c),new Vector(b+8*d,c-2*d),"#B8860B",!1);a.fillRect(b+3.5*d,c,1*d,5*d);a.lineWidth=4;a.strokeRect(b+3.5*d,c,1*d,5*d);drawTriangle(a,new Vector(b+3.5*d,c+5*d),new Vector(b+
7*d,c+6*d),new Vector(b+3.5*d,c+7.5*d),"#FFD700",!1)}var reducePlayerHealth=function(a,b,c){0==b.player.playerHitTimer&&(b.player.health-=a,b.player.playerHitTimer=b.player.playerHitTimerMax,Game.hud.setGameMessage(c))};var createPlan=function(a,b,c,d,e,f){var g=[];for(y=0;y<b;y++){var j=[];for(x=0;x<a;x++)j.push(null);g.push(j)}for(var j=~~(a*c),c=~~(b*c),k=~~(a/2-j/2),i=~~(b/2-c/2),h=0;h<a;h++)h>=k&&h<k+j?(g[0][h]="E",g[1][h]="E",g[2][h]="E",g[b-1][h]="W",g[b-2][h]="W",g[b-3][h]="W"):(g[0][h]="x",g[b-1][h]="x");for(var l=0;l<b;l++)l>=i&&l<i+c?(g[l][0]="A",g[l][1]="A",g[l][2]="A",g[l][a-1]="F",g[l][a-2]="F",g[l][a-3]="F"):(g[l][0]="x",g[l][a-1]="x");var i=new Vector(0,0),h=getDirectionalPos(i),l=function(c,d,e,
f,i){var h=0,j=[],k=[],l=[],c=new Vector(c,d);null==g[c.y][c.x]&&(g[c.y][c.x]=f,k.push(c),h=1);for(;h<e;){for(var d=i,j=[],n=0;n<d.length;n++){var m=d[n].plus(c);!(1>m.x||m.x>a-2||1>m.y||m.y>b-2)&&j.push(m)}j.map(function(a){if(g[a.y][a.x]==null){g[a.y][a.x]=f;k.push(a);l.push(a);h=h+1}});if(0==l.length)break;c=getRandomElement(l);if(!c)break}return k},m=Math.floor(3*a/4),n=Math.floor(3*b/4),o=~~(a/4),p=~~(b/4),j=Math.floor(a/2),c=Math.floor(b/2);l(j,c,f,"q",h);i=l(m,n,f,"q",h);k=l(o,p,f,"q",h);n=
l(o,n,f,"q",h);f=l(m,p,f,"q",h);for(h=1;h<b-2;h++)for(l=1;l<a-2;l++)null==g[h][l]&&(Math.random()>d?g[h][l]="s":Math.random()>e&&(g[h][l]="l"));allStructs=[f,i,n,k];for(charsToPlace=["B","T","U","C"];0!=allStructs.length;)d=getRandomElement(charsToPlace),e=charsToPlace.indexOf(d),-1!=e&&charsToPlace.splice(e,1),f=getRandomElement(allStructs),e=allStructs.indexOf(f),-1!=e&&allStructs.splice(e,1),i=getRandomElement(f),g[i.y][i.x]=d;for(g[c][j]="P";;)if(d=~~(2+Math.random()*(a/2)),e=~~(b/2+Math.random()*
(b-2)/2),null==g[e][d]&&null==g[e-1][d]){g[e][d]="@";break}return g};var MessageType={HEALTHBAR:0,GAME_MESSAGE:1};
function InGameHUD(a){this.canvas=document.createElement("canvas");this.canvas.id="hud";this.canvas.width=Game.width;this.canvas.height=Game.height+40;this.canvas.style="z-index:2;padding:0;margin:auto;display:block;width:"+this.canvas.width+"px;height:"+this.canvas.height+"px;position:absolute;top:0;bottom:0;left:0;right:0;";this.cx=this.canvas.getContext("2d");a.appendChild(this.canvas);this.gameMessage=this.healthBar=null;this.maxGameMessageSize=0;this.width=this.canvas.width;this.height=this.canvas.height;
this.cx.fillStyle="rgb(238, 238, 170)";this.questionIndex=0}InGameHUD.prototype.setHealthBar=function(a,b,c){this.healthBar={context:a,funcToCall:b,maxValue:c}};InGameHUD.prototype.setPlayerProgress=function(a,b,c){this.playerProgressBar={context:a,funcToCall:b,maxValue:c}};InGameHUD.prototype.setGameMessage=function(a,b){this.gameMessage=a;b||setTimeout(function(){Game.hud.gameMessage=null},2E3)};
InGameHUD.prototype.drawBar=function(a,b,c,d,e,f,g){this.cx.save();e>f&&(e=f);e=~~(e/f*c);this.cx.fillStyle="red";this.cx.fillRect(a+e,b,c-e,d);this.cx.fillStyle="green";this.cx.fillRect(a,b,e,d);this.cx.restore();this.cx.fillStyle="grey";this.cx.font="14pt Georgia";c=this.cx.measureText(g).width;this.cx.fillText(g,a-c-5,b+10)};
InGameHUD.prototype.drawGameMessage=function(a,b,c){this.cx.save();this.cx.font="14pt Georgia";var d=b?b:0,e=this.cx.measureText(a).width;this.maxGameMessageSize=~~Math.max(e,this.maxGameMessageSize);var f=e,e=this.maxGameMessageSize,b=parseInt(this.cx.font),g=Game.width/2-5-e/2,d=this.height-15-5-b-d*(20+b),e=10+e,j=10+b,f=Game.width/2-f/2;this.cx.fillStyle="rgba(255, 255, 255, 0.5)";this.cx.fillRect(g,d,e,j);this.cx.fillStyle="rgba(170, 170, 170, 0.9)";this.cx.fillRect(g+4,d+4,e-8,j-8);this.cx.fillStyle=
c?"#DC143C":"black";this.cx.fillText(a,f,d+5+b);this.cx.restore()};
InGameHUD.prototype.drawQuestions=function(a){this.clearScreen();0>Game.currentQuestionNo&&(Game.currentQuestionNo=Game.numberOfQuestions-1);Game.currentQuestionNo>=Game.numberOfQuestions&&(Game.currentQuestionNo=0);for(var b=0;b<Game.numberOfQuestions&&!(Game.currentQuestionNo>Game.numberOfQuestions);b++)b==Game.currentQuestionNo?this.drawGameMessage(a[""+b].question,Game.numberOfQuestions-b,!0):this.drawGameMessage(a[""+b].question,Game.numberOfQuestions-b,!1)};
InGameHUD.prototype.clearScreen=function(){this.cx.clearRect(0,0,this.canvas.width,this.canvas.height)};InGameHUD.prototype.clear=function(){this.canvas.parentNode.removeChild(this.canvas)};
InGameHUD.prototype.draw=function(){Game.inInteraction||this.clearScreen();this.cx.fillStyle="rgb(238, 238, 170)";this.cx.fillRect(0,Game.height,Game.width,40);if(this.healthBar){var a=this.healthBar.context[this.healthBar.funcToCall]();this.drawBar(Game.width-130,Game.height+25,100,10,a,this.healthBar.maxValue,"Health")}this.playerProgressBar&&(a=this.playerProgressBar.context[this.playerProgressBar.funcToCall](),this.drawBar(80,Game.height+25,200,10,a,this.playerProgressBar.maxValue,"Progress"));
this.gameMessage&&this.drawGameMessage(this.gameMessage);this.cx.fillText("Press P for Help",Game.width-135,Game.height+17)};
InGameHUD.prototype.drawMenuScreen=function(){this.draw();this.cx.save();var a=this.width/2,b=this.height/2,c=function(a,b){var c=a.measureText(b).width,d=parseInt(a.font);return{message:b,width:c,height:d}},d=function(a,b,c,d,i){a.fillText(e.message,c,d);i||a.strokeText(e.message,c,d)};this.cx.fillStyle="rgb(238, 238, 170)";this.cx.fillRect(a-300,b-200,600,400);this.cx.font="32pt Georgia";this.cx.fillStyle="red";this.cx.strokeStyle="black";var e=c(this.cx,"Save the Lost Friend");d(this.cx,e.message,
a-e.width/2,b-400/2.7-e.height/2);Game.GameOver?(this.cx.font="14pt Georgia",e=c(this.cx,"You have Won."),d(this.cx,e.message,a-e.width/2,b-4*e.height/2,!0),e=c(this.cx,"You have rescued your friend and others trapped in the portal"),d(this.cx,e.message,a-e.width/2,b-1*e.height/2,!0)):(this.cx.font="10pt Georgia",e=c(this.cx,"Talk to the 4 guardians and get the keys to the 4 islands. Get the gems from the 4 islands."),d(this.cx,e.message,a-e.width/2,b-400/3+2*e.height,!0),e=c(this.cx,"Place the gems in the circular portal in central island to rescue your lost friend"),
d(this.cx,e.message,a-e.width/2,b-400/3+4*e.height,!0),drawTurtoise(this.cx,a-50,b,5),drawCrab(this.cx,a-300+10,b+30,5),drawEagle(this.cx,a-300+150,b,5),drawOwl(this.cx,a+200,b-50,4),this.cx.fillStyle="#DC143C",this.cx.font="12pt Georgia",e=c(this.cx,"Controls"),d(this.cx,e.message,a-e.width/2,b+80,!0),e=c(this.cx,"Arrow keys for movement, Up arrow to fly and double jump."),d(this.cx,e.message,a-e.width/2,b+80+2*e.height,!0),e=c(this.cx,"Enter key to proceed in dialog, Esc key to exit dialog."),d(this.cx,
e.message,a-e.width/2,b+80+4*e.height,!0),e=c(this.cx,"Press P to play"),this.cx.fillStyle="#7FFFD4",this.cx.fillRect(a-e.width/2,b+200-2.2*e.height,e.width,1.5*e.height),this.cx.fillStyle="#DC143C",this.cx.fillText(e.message,a-e.width/2,b+200-e.height),this.cx.restore())};var Level=function(a){a.generateLevel();var b=a.level;this.levelInfo=a;this.width=b[0].length;this.height=b.length;this.grid=[];this.actors=[];this.islandGrid=[];var c;Game.currentLevel=this;for(y=0;y<this.height;y++){var d=[];for(x=0;x<this.width;x++)d.push(null)}for(y=0;y<this.height;y++){var d=b[y],e=[],f=[];for(x=0;x<this.width;x++){c=d[x];var g=null,j=null,k=a.actorChars[c];k?(this.actors.push(new k(new Vector(x,y),c)),a.islandChars&&a.islandChars[c]&&(j=a.actorChars[c])):g=a.backgroundChars[c];
e.push(g);f.push(j)}this.grid.push(e);this.islandGrid.push(f)}this.player=this.actors.filter(function(a){return"player"==a.type})[0];this.status=this.finishDelay=null};Level.prototype.isFinished=function(){return null!=this.status&&0>this.finishDelay};
Level.prototype.collisionWith=function(a,b,c){var d=Math.floor(a.x),e=Math.ceil(a.x+b.x),f=Math.floor(a.y),a=Math.ceil(a.y+b.y),g;if("obstacle"==c){if(0>d||e>this.width||0>f)return"wall";if(a>this.height)return"lava";g=this.grid}else"island"==c&&(g=this.islandGrid);for(c=f;c<a;c++)for(f=d;f<e;f++)if(b=g[c][f])return b};
Level.prototype.actorAt=function(a){for(var b,c=0;c<this.actors.length;c++)if(b=this.actors[c],b!=a&&a.pos.x+a.size.x>b.pos.x&&a.pos.x<b.pos.x+b.size.x&&a.pos.y+a.size.y>b.pos.y&&a.pos.y<b.pos.y+b.size.y&&!b.collisionNotRequired)return b};Level.prototype.animate=function(a,b){null!=this.status&&(this.finishDelay-=a);for(;0<a;){var c=Math.min(a,0.05);this.actors.forEach(function(a){a.act(c,this,b)},this);a-=c}};
Level.prototype.playerTouched=function(a,b){var c=this.levelInfo.playerTouched(a,b,this);if("lost"==c||"won"==c)this.status=c,this.finishDelay=2};Level.prototype.getPlayerProgress=function(){if("horizontal"==this.levelInfo.platformerType)return~~this.player.pos.x;if("vertical"==this.levelInfo.platformerType)return~~(this.height-this.player.pos.y)};
var keyCodes={37:"left",38:"up",39:"right",40:"down",70:"fly",71:"revokeFly",80:"pause",27:"skip",13:"enter"},trackKeys=function(a){function b(b){if(a.hasOwnProperty(b.keyCode)){var f="keyup"==b.type;c[a[b.keyCode]]="keydown"==b.type;d[a[b.keyCode]]=f;b.preventDefault()}}var c={},d={};addEventListener("keydown",b);addEventListener("keyup",b);return{down:c,up:d}},pauseIsDown=!1;
function pauseKeyHandler(){keys.pause&&(pauseIsDown=!0);pauseIsDown&&!keys.pause&&(Game.gamePaused=!Game.gamePaused,pauseIsDown=!1,Game.hud.clearScreen())}
var runAnimation=function(a){function b(d){pauseKeyHandler();var e=!1;if(null!=c){var f=Math.min(d-c,100)/1E3;Game.gamePaused?(Game.inInteraction=!1,Game.hud.drawMenuScreen()):e=!1==a(f);if(Game.GameFirstStart||Game.GameOver)Game.gamePaused=!0,Game.GameFirstStart=!1}c=d;e||requestAnimationFrame(b)}var c=null;requestAnimationFrame(b)},keyUpDown=trackKeys(keyCodes),keys=keyUpDown.down,keyPressed=keyUpDown.up,resetKeyPressed=function(){keyPressed.up=!1;keyPressed.down=!1;keyPressed.enter=!1};
function runLevel(a,b,c){var d=new b(document.body,a),e=new InGameHUD(document.body);e.setHealthBar(a.player,"getHealth",100);a.levelInfo.type==LEVEL_TYPE.PLATFORMER&&("horizontal"==a.levelInfo.platformerType?e.setPlayerProgress(a,"getPlayerProgress",a.width):"vertical"==a.levelInfo.platformerType&&e.setPlayerProgress(a,"getPlayerProgress",a.height));Game.hud=e;runAnimation(function(b){a.animate(b,keys);d.drawFrame(b);e.draw();if(a.isFinished())return d.clear(),e.clear(),c&&c(a.status),!1})}
function runGame(a){function b(c){Game.inInteraction=!1;Game.nextLevel=null;runLevel(new Level(c),a.display,function(d){"lost"==d?b(c):Game.nextLevel?b(Game.nextLevel):(console.log("You win!"),b(a))})}b(a)};function CanvasDisplay(a,b){this.canvas=document.createElement("canvas");this.canvas.id="gameScreen";this.canvas.width=Math.min(Game.width,b.width*Game.scale);this.canvas.height=Math.min(Game.height,b.height*Game.scale);this.canvas.style="z-index: 1;padding:0;margin:auto;display:block;width:"+this.canvas.width+"px;height:"+this.canvas.height+"px;position:absolute;top:0;bottom:0;left:0;right:0;";a.appendChild(this.canvas);this.cx=this.canvas.getContext("2d");this.level=b;this.viewport={left:0,top:0,
width:this.canvas.width/Game.scale,height:this.canvas.height/Game.scale};this.drawFrame(0)}CanvasDisplay.prototype.clear=function(){this.canvas.parentNode.removeChild(this.canvas)};CanvasDisplay.prototype.drawFrame=function(){this.updateViewport();this.clearDisplay();this.drawBackground();this.drawActors()};
CanvasDisplay.prototype.updateViewport=function(){var a=this.viewport,b=a.width/3,c=a.height/3,d=this.level.player,d=d.pos.plus(d.size.times(0.5));d.x<a.left+b?a.left=Math.max(d.x-b,0):d.x>a.left+a.width-b&&(a.left=Math.min(d.x+b-a.width,this.level.width-a.width));d.y<a.top+c?a.top=Math.max(d.y-c,0):d.y>a.top+a.height-c&&(a.top=Math.min(d.y+c-a.height,this.level.height-a.height));this.xStart=Math.floor(a.left);this.xEnd=Math.ceil(a.left+a.width);this.yStart=Math.floor(a.top);this.yEnd=Math.ceil(a.top+
a.height)};CanvasDisplay.prototype.clearDisplay=function(){this.cx.fillStyle="won"==this.level.status?"rgb(68, 191, 255)":"lost"==this.level.status?"rgb(44, 136, 214)":"rgb(52, 166, 251)";this.cx.fillRect(0,0,this.canvas.width,this.canvas.height)};
CanvasDisplay.prototype.drawBackground=function(){for(var a=this.viewport,b=this.yStart;b<this.yEnd;b++)for(var c=this.xStart;c<this.xEnd;c++){var d=null;this.level.grid[b]&&(d=this.level.grid[b][c]);null!=d&&this.level.levelInfo.drawBackground(d,this.cx,(c-a.left)*Game.scale,(b-a.top)*Game.scale)}};
CanvasDisplay.prototype.drawActors=function(){var a=[];this.level.actors.forEach(function(b){b.drawLast&&a.push(b);b.pos.x>=this.xStart&&(b.pos.x<this.xEnd&&b.pos.y>=this.yStart&&b.pos.y<this.yEnd)&&b.draw(this.cx,(b.pos.x-this.viewport.left)*Game.scale,(b.pos.y-this.viewport.top)*Game.scale)},this);a.forEach(function(a){a.pos.x>this.xStart&&(a.pos.x<this.xEnd&&a.pos.y>this.yStart&&a.pos.y<this.yEnd)&&a.draw(this.cx,(a.pos.x-this.viewport.left)*Game.scale,(a.pos.y-this.viewport.top)*Game.scale)},
this)};function Dialog(){this.messages={}}Dialog.prototype.setNextQuestionBatch=function(){var a=String(Number(this.messages.currentBatchKey)+1);this.messages[a]&&(this.messages.currentBatchKey=a)};Dialog.prototype.getNextQuestionBatch=function(){return this.messages[this.messages.currentBatchKey]};Dialog.prototype.lastBatch=function(){var a=Object.keys(this.messages).length-2;return Number(this.messages.currentBatchKey)==a};
var gaurdianCreatures={crab:{island:"earth",direction:"north"},tortoise:{island:"water",direction:"south"},eagle:{island:"fire",direction:"east"},owl:{island:"air",direction:"west"}},initNPCDialog=function(a){return Object.create({"0":{welcomeMessage:"Glad to see you have not yet given up on your quest to rescue your lost friend.","0":{question:"Do you know me? I have lost all memory and do not remember.",answer:"You are the brave adventurer, who is risking his life to save his lost friend.",askedStatus:0},
1:{question:" Do you know what happened to my lost friend?",answer:"Yes, a portal opened. Your friend and many people got lost.",askedStatus:0}},1:{welcomeMessage:"Rescue your friend.","0":{question:"Who are you.?",answer:"I am the gaurdian of the "+gaurdianCreatures[a].island+" island.",askedStatus:0},1:{question:"What do I need to do to rescue my friend?",answer:"Retrieve the "+gaurdianCreatures[a].island+" gem from the "+gaurdianCreatures[a].island+" island.",askedStatus:0},2:{question:" How do I get the gem?",
answer:"Take the key from me to enter the island in the  "+gaurdianCreatures[a].direction+" to get the gem.",askedStatus:0},3:{question:"Where should I go next?",answer:"To one of the islands",askedStatus:0}},2:{welcomeMessage:"Go to the "+gaurdianCreatures[a].island+" island in the "+gaurdianCreatures[a].direction+" to get the gem."},3:{welcomeMessage:"Great! you got the "+gaurdianCreatures[a].island+" island gem. Get gems from other islands."},4:{welcomeMessage:"Save your friend by placing the gems in central island and opening the portal."},
currentBatchKey:"0"})},crabDialogue=initNPCDialog("crab"),tortoiseDialogue=initNPCDialog("tortoise"),eagleDialogue=initNPCDialog("eagle"),owlDialogue=initNPCDialog("owl");function Player(a){this.pos=a.plus(new Vector(0,-0.5));this.size=new Vector(0.8,1.5);this.speed=new Vector(0,0);this.facingRight=!0;this.health=100;this.playerHitTimer=0;this.playerHitTimerMax=100;this.skipDialogTimer=0;this.skipDialogTimerMax=200;this.type="player"}Player.prototype.getHealth=function(){return this.health};var playerXSpeed=7;
Player.prototype.moveX=function(a,b,c){this.speed.x=0;c.left&&(this.speed.x-=playerXSpeed,this.facingRight=!1);c.right&&(this.speed.x+=playerXSpeed,this.facingRight=!0);a=new Vector(this.speed.x*a,0);a=this.pos.plus(a);(c=b.collisionWith(a,this.size,"obstacle"))?b.playerTouched(c):this.pos=a};
Player.prototype.moveY=function(a,b,c){this.speed.y+=a*this.gravity;var a=new Vector(0,this.speed.y*a),a=this.pos.plus(a),d=b.collisionWith(a,this.size,"obstacle");if(d)b.playerTouched(d),c.up&&0<this.speed.y?(this.speed.y=-this.jumpSpeed,this.onKeyUpEnableDoubleJump=!0,this.flyPower=this.flyPower):this.speed.y=0;else{if(!1==c.up&&this.onKeyUpEnableDoubleJump&&(this.enableDoubleJump=!0,!this.fly||1>=this.flyPower))this.onKeyUpEnableDoubleJump=!1;c.up&&(!0==this.enableDoubleJump&&-2<this.speed.y)&&
(this.speed.y=-this.jumpSpeed,this.enableDoubleJump=!1,this.flyPower-=1);this.pos=a}};Player.prototype.move=function(a,b,c){this.moveX(a,b,c);this.moveY(a,b,c)};
Player.prototype.act=function(a,b,c){Game.inInteraction||this.move(a,b,c);var d=b.actorAt(this);d&&(b.playerTouched(d.type,d),d.hasDialog&&b.levelInfo.playerInteract(d,b));"lost"==b.status&&(this.pos.y+=a,this.size.y-=a);c.fly&&(this.fly=!0);c.revokeFly&&(this.fly=!1);0<b.player.playerHitTimer&&b.player.playerHitTimer--;0<b.player.skipDialogTimer&&b.player.skipDialogTimer--};
Player.prototype.draw=function(a,b,c){a.save();a.fillStyle=0<Game.currentLevel.player.playerHitTimer?"rgba(200, 0, 0, 0.7)":"gold";a.fillRect(b,c,3*Game.scale/4,3*Game.scale/2);a.fillStyle="black";this.facingRight?(a.fillRect(b+1*Game.scale/2,c+1*Game.scale/5,1*Game.scale/7,1*Game.scale/7),a.fillStyle="black",a.fillRect(b+1*Game.scale/3,c+1*Game.scale/2,1*Game.scale/3,1*Game.scale/10)):(a.fillRect(b,c+1*Game.scale/5,1*Game.scale/7,1*Game.scale/7),a.fillStyle="black",a.fillRect(b,c+1*Game.scale/2,
1*Game.scale/3,1*Game.scale/10));a.restore()};var FLY_POWER_MAX=3;function PlayerPlatformer(a){Player.call(this,a);this.fly=this.enableDoubleJump=this.onKeyUpEnableDoubleJump=!1;this.flyPower=FLY_POWER_MAX;this.gravityConst=this.gravity=30;this.jumpSpeed=17}PlayerPlatformer.prototype=Object.create(Player.prototype);function PlayerNonPlatformer(a){Player.call(this,a)}PlayerNonPlatformer.prototype=Object.create(Player.prototype);PlayerNonPlatformer.prototype.draw=Player.prototype.draw;
PlayerNonPlatformer.prototype.move=function(a,b,c){this.speed.x=0;this.speed.y=0;c.left&&(this.speed.x-=4,this.facingRight=!1);c.right&&(this.speed.x+=4,this.facingRight=!0);c.up&&(this.speed.y-=4);c.down&&(this.speed.y+=4);a=new Vector(this.speed.x*a,this.speed.y*a);a=this.pos.plus(a);this.checkCollision(a,b)};PlayerNonPlatformer.prototype.checkCollision=function(a,b){var c=b.collisionWith(a,this.size,"obstacle");c?b.playerTouched(c):this.pos=a};PlayerNonPlatformer.prototype.act=Player.prototype.act;
function Berry(a){this.pos=a;this.size=new Vector(1,1)}Berry.prototype.type="berry";Berry.prototype.act=function(){};Berry.prototype.draw=function(a,b,c){a.save();a.fillStyle="#DC143C";drawArc(a,b,c,Game.scale/2,0,2*Math.PI,!0);a.restore()};function Gem(a,b,c,d,e){this.pos=a;this.type=b;this.size=new Vector(2,2);this.color1=c;this.color2=d;this.winMessage="You have succeeded in getting the "+e;this.drawLast=!0}Gem.prototype.act=function(){};
Gem.prototype.draw=function(a,b,c){a.save();drawDiamond(a,b,c+2.5*Game.scale,this.color1,this.color2);a.restore()};var LEVEL_TYPE={PLATFORMER:0,NONPLATFORMER:1};function LevelInfo(a,b,c,d){this.type=a;this.level=b;this.backgroundChars=c;this.actorChars=d;this.display=CanvasDisplay}LevelInfo.prototype.initializeChain=function(a,b){this.nextLevel=b;this.prevLevel=a};function generateFireBasicLevel(a,b){for(var c=~~(2*b/3),d=[],e=0;e<b;e++){for(var f=[],g=0;g<a;g++)e>c?f.push("x"):f.push(" ");d.push(f)}d[c-1][1]="@";return d}var fireLevelConstants={fireBirdMaxWidth:11,fireBirdMinHeight:5};
function generateFireLevelWithObstacles(a){var b=a[0].length,c,d=~~(2*a.length/3),e=!0;c=5;for(var f={"0":"FIREBIRD",1:"VOLCANO",2:"TREE"};c<b-12;){var g=f[String(~~(Math.random()*Object.keys(f).length))];if("FIREBIRD"==g&&!0==e)e=~~(fireLevelConstants.fireBirdMinHeight+6*Math.random()),a[d-e][c+~~(fireLevelConstants.fireBirdMaxWidth/2)]="f",c+=fireLevelConstants.fireBirdMaxWidth,e=!1;else if("VOLCANO"==g&&!0==e){for(var e=getRandomElement([13,17,21]),j=g=Math.floor(e/4),k=g+j-1,i=d-j+1;i<d+g;i++){for(var h=
c;h<c+e;h++)if(h>c+k&&h<c+(e-k)&&(a[i][h]="!",i==d-j+1&&(a[i-2][h]="v")),h==c+k||h==c+(e-k))a[i][h]="n";k-=1}c+=e;e=!1}else"TREE"==g&&!0==e?(a[d][c+2]="t",c+=5,e=!1):!1==e&&(c+=8,e=!0)}a[d-2][b-3]="g";return a}var fireLevelMap=generateFireLevelWithObstacles(generateFireBasicLevel(300,50));function FireBolt(a){this.pos=a;this.size=new Vector(0.5,1);this.speed=new Vector(0,20)}FireBolt.prototype.type="fireBolt";
FireBolt.prototype.act=function(a,b){var c=this.pos.plus(this.speed.times(a)),d=this;b.collisionWith(c,this.size,"obstacle")?b.actors=b.actors.filter(function(a){return a!=d}):this.pos=c};FireBolt.prototype.draw=function(a,b,c){a.save();a.fillStyle="yellow";a.fillRect(b,c,this.size.x*Game.scale,this.size.y*Game.scale+4);a.fillStyle="red";a.fillRect(b+2,c+2,this.size.x*Game.scale-4,this.size.y*Game.scale-4);a.restore()};
function FireBird(a){this.pos=a;this.size=new Vector(3,1);this.speed=0.5<Math.random()?new Vector(2,0):new Vector(-2,0);this.origSpeed=new Vector(2,0);this.maxLeft=this.pos.x-~~(fireLevelConstants.fireBirdMaxWidth/2);this.maxRight=this.pos.x+~~(fireLevelConstants.fireBirdMaxWidth/2)}FireBird.prototype.type="fireBird";
FireBird.prototype.act=function(a,b){var c=this.pos.plus(this.speed.times(a));c.x>this.maxRight?this.speed.x=-1*this.origSpeed.x:c.x<this.maxLeft&&(this.speed.x=this.origSpeed.x);this.pos=c;0==~~c.x%3&&b.actors.push(new FireBolt(this.pos.plus(new Vector(0,1)),"b"))};FireBird.prototype.draw=function(a,b,c){a.save();a.fillStyle="red";a.fillRect(b,c,this.size.x*Game.scale,this.size.y*Game.scale);a.fillStyle="yellow";a.fillRect(b+4,c+4,this.size.x*Game.scale-8,this.size.y*Game.scale-8);a.restore()};
function FireTree(a){this.pos=a;this.size=new Vector(3,12);this.horizBranchNos=3+getRandomElement([2,4]);this.vertBranchNos=4+~~(4*Math.random());this.treeColor="green";this.addFruits=!1}FireTree.prototype.type="tree";
FireTree.prototype.act=function(a,b){if(!this.addFruits){for(var c=4+~~(4*Math.random()),d=0;d<c;d++){var e=getRandomElement([-(this.horizBranchNos-1),-1,0,1,2,this.horizBranchNos+1]),f=-1*(7+~~(Math.random()*this.vertBranchNos)),e=new Berry(new Vector(this.pos.x+e,this.pos.y+f));e.drawLast=!0;b.actors.push(e)}this.addFruits=!0}};FireTree.prototype.draw=function(a,b,c){a.save();drawTree(a,b,c+1*Game.scale,this.horizBranchNos,this.vertBranchNos,this.treeColor);a.restore()};
function VolcanoLava(a){this.origPos=this.pos=a;this.size=new Vector(1,1);this.getSpeed();this.gravity=0.005;this.gravity=30}VolcanoLava.prototype.getSpeed=function(){var a=0.5<Math.random()?~~(10*Math.random()):-1*~~(10*Math.random()),b=-15+-1*~~(10*Math.random());this.speed=new Vector(a,b)};VolcanoLava.prototype.type="volcanoLava";
VolcanoLava.prototype.act=function(a,b){this.speed.y+=a*this.gravity;var c=new Vector(this.speed.x*a,this.speed.y*a),c=this.pos.plus(c);b.collisionWith(c,this.size,"obstacle")?(this.pos=this.origPos,this.getSpeed()):this.pos=c};VolcanoLava.prototype.draw=function(a,b,c){a.save();a.fillStyle="yellow";a.fillRect(b,c,this.size.x*Game.scale,this.size.y*Game.scale);a.fillStyle="red";a.fillRect(b+2,c+2,this.size.x*Game.scale-4,this.size.y*Game.scale-4);a.restore()};
function FirePlayer(a){PlayerPlatformer.call(this,a);this.drawLast=!0}FirePlayer.prototype=Object.create(PlayerPlatformer.prototype);function FireStoneGem(a){Gem.call(this,a,"FireStoneGem","#FE7777","#FE2222","fire gem.")}FireStoneGem.prototype=Object.create(Gem.prototype);
var fireLevelBackgroundChars={x:"wall","!":"lava",n:"volcanoWall"},fireLevelActorChars={"@":FirePlayer,v:VolcanoLava,f:FireBird,b:FireBolt,t:FireTree,g:FireStoneGem},fireLevel=new LevelInfo(LEVEL_TYPE.PLATFORMER,fireLevelMap,fireLevelBackgroundChars,fireLevelActorChars);fireLevel.platformerType="horizontal";fireLevel.generateLevel=function(){this.level=generateFireLevelWithObstacles(generateFireBasicLevel(300,50))};
fireLevel.drawBackground=function(a,b,c,d){"wall"==a?(b.fillStyle="rgba(170, 170, 50, 255)",b.fillRect(c,d,Game.scale+1,Game.scale+1)):"lava"==a?(b.fillStyle="red",b.fillRect(c,d,Game.scale+1,Game.scale+1)):"volcanoWall"==a&&(b.fillStyle="brown",b.fillRect(c,d,Game.scale+1,Game.scale+1))};
fireLevel.playerTouched=function(a,b,c){if("lava"==a&&null==c.status)return Game.hud.setGameMessage("Lava killed you."),"lost";if("fireBolt"==a&&null==c.status)reducePlayerHealth(50,c,"Beware of the Fire Bolt.");else if("volcanoLava"==a&&null==c.status)reducePlayerHealth(50,c,"Beware of the Volcanic Lava.");else if("berry"==a)c.actors=c.actors.filter(function(a){return a!=b}),c.player.health+=10,Game.hud.setGameMessage("Gained health");else{if("FireStoneGem"==a&&null==c.status)return c.actors=c.actors.filter(function(a){return a!=
b}),Game.level=waterLevel,Game.numberOfGemsCollected++,Game.gemsCollected.fire=!0,Game.hud.setGameMessage(b.winMessage),"won";c.player.gravity="tree"==a?20:c.player.gravityConst}if(0>=c.player.health&&null==c.status)return"lost"};function generateRiverBasicLevel(a,b,c){for(var d=a-2*c,e=[],f=0;f<b;f++){for(var g=[],j=0;j<a;j++)j>d||j<c?g.push("x"):f==b-1?g.push("x"):g.push(" ");e.push(g)}return e}
function generateRiverLevelWithObstacles(a){for(var b=a[0].length,c=b-1,d=a.length-2,e,f=!0;4<d;){e=~~(b/2+Math.random()*(c-b/2-10));a[d][e]="n";e=~~(1+Math.random()*(b/2-10));a[d][e]="n";f&&(a[d][e+1]="@",f=!1);d-=2;if(2>d)break;e=~~(1+Math.random()*(c-1-10));a[d][e]="|";d-=2}a[1][~~(b/2)-1]="n";a[2][~~(b/2)-1]="n";a[3][~~(b/2)-1]="n";a[4][~~(b/2)-1]="|";a[1][~~(b/2)-1]="g";return a}var xMargin=1,riverLevelMap=generateRiverLevelWithObstacles(generateRiverBasicLevel(40,90,xMargin));
function RiverPlayer(a){PlayerNonPlatformer.call(this,a);this.health=100;this.drawLast=!0}RiverPlayer.prototype=Object.create(PlayerNonPlatformer.prototype);
RiverPlayer.prototype.move=function(a,b,c){this.inCollision||(this.speed.x=0,this.speed.y=0);c.left&&(this.speed.x=this.inCollision?this.speed.x+-4:-4,this.facingRight=!1);c.right&&(this.speed.x=this.inCollision?this.speed.x+4:4,this.facingRight=!0);c.up&&(this.speed.y=-4);c.down&&(this.speed.y=4);a=new Vector(this.speed.x*a,this.speed.y*a);a=this.pos.plus(a);this.checkCollision(a,b)};RiverPlayer.prototype.checkCollision=function(a,b){this.newPos=b.collisionWith(a,this.size,"obstacle")?this.pos:a};
RiverPlayer.prototype.act=function(a,b,c){Game.inInteraction||this.move(a,b,c);(c=b.actorAt(this))?(c.speed&&(this.speed.x=c.speed.x,this.speed.y=c.speed.y),this.pos=this.newPos,this.inCollision=!0,"RiverGem"==c.type&&b.playerTouched("RiverGem",c)):(this.inCollision=!1,b.playerTouched("fierce river",null));"lost"==b.status&&(this.pos.y+=a,this.size.y-=a);0<b.player.playerHitTimer&&b.player.playerHitTimer--;0<b.player.skipDialogTimer&&b.player.skipDialogTimer--};
function RiverGem(a){Gem.call(this,a,"RiverGem","#7777FE","#2222FE","river gem.")}RiverGem.prototype=Object.create(Gem.prototype);function RiverObject(a,b,c,d){this.pos=a;this.type=b;this.size=d;this.color=c}RiverObject.prototype.draw=function(a,b,c){a.save();a.fillStyle=this.color;a.fillRect(b,c,this.size.x*Game.scale,this.size.y*Game.scale);a.restore()};RiverObject.prototype.act=function(){};
function MovingLog(a){var b=~~(2+5*Math.random()),b=new Vector(b,1),c=~~~(7+4*Math.random());this.speed=new Vector(c,0);RiverObject.call(this,a,"MovingLog","brown",b)}MovingLog.prototype=Object.create(RiverObject.prototype);MovingLog.prototype.act=function(a,b){var c=this.pos.plus(this.speed.times(a));b.collisionWith(c,this.size,"obstacle")?this.speed=this.speed.times(-1):this.pos=c};
function StandingPlatform(a){var b=~~(3+7*Math.random()),b=new Vector(b,1);RiverObject.call(this,a,"StandingPlatform","grey",b);this.speed=new Vector(0,0)}StandingPlatform.prototype=Object.create(RiverObject.prototype);var riverLevelBackgroundChars={x:"wall"},riverLevelActorChars={"@":RiverPlayer,n:StandingPlatform,"|":MovingLog,g:RiverGem},riverLevel=new LevelInfo(LEVEL_TYPE.PLATFORMER,riverLevelMap,riverLevelBackgroundChars,riverLevelActorChars);riverLevel.platformerType="vertical";
riverLevel.generateLevel=function(){this.level=generateRiverLevelWithObstacles(generateRiverBasicLevel(40,90,xMargin))};riverLevel.drawBackground=function(a,b,c,d){"wall"==a?(b.fillStyle="gold",b.fillRect(c,d,Game.scale+1,Game.scale+1)):"fierceRiver"==a&&(b.fillStyle="green",b.fillRect(c,d,Game.scale+1,Game.scale+1))};
riverLevel.playerTouched=function(a,b,c){if("fierce river"==a&&null==c.status)return Game.hud.setGameMessage("Drowned in the fierce river."),"lost";if("RiverGem"==a&&null==c.status)return c.actors=c.actors.filter(function(a){return a!=b}),Game.level=waterLevel,Game.gemsCollected.water=!0,Game.numberOfGemsCollected++,Game.hud.setGameMessage(b.winMessage),"won"};function generateSteps(a,b,c){for(var d=a[0].length,e=a.length,f=d-b,g=!0,j=~~(d/5),k=~~(d/4),i=~~(1.5*c),h=e-2,l,m,n=0;5<h;){l=~~(j+Math.random()*(k-j));m=g?b:f-l;for(var o=0;o<l;o++)a[h][m+o]="x";g=!g;a[h-1][m+1]="t";h<0.75*e&&10<n&&(a[h][~~(d/2)]="C",n=0);nextY=~~(c+Math.random()*(i-c));h=h-nextY-1;n=n+nextY+1}a[2][~~(d/2)]="g";a[e-5][~~(d/2)]="@";firstTime=!1;return a}
function generateAirBasicLevel(a,b,c,d){for(var e=a-2*c,f=[],g=0;g<b;g++){for(var j=[],k=0;k<a;k++)k>e||k<c?j.push("x"):g==b-1?j.push("x"):j.push(" ");f.push(j)}return f=generateSteps(f,c,d)}function AirPlayer(a){PlayerPlatformer.call(this,a);this.drawLast=!0;this.flyPower=9E3;this.fly=!0}AirPlayer.prototype=Object.create(PlayerPlatformer.prototype);function AirGem(a){Gem.call(this,a,"AirGem","#DCDCDC","#ECECEC","air gem.")}AirGem.prototype=Object.create(Gem.prototype);
function EvilCloud(a){var b=~~~(5+10*Math.random());this.speed=new Vector(b,0);this.pos=a;a=2*Game.scale;b=Game.scale;this.r1=b+Math.random()*(a-b);this.r2=b+Math.random()*(a-b);this.size=new Vector(2*(this.r1/Game.scale)+2*(this.r2/Game.scale),Math.min(this.r1/Game.scale,this.r2/Game.scale));this.type="EvilCloud"}EvilCloud.prototype.act=function(a,b){var c=this.pos.plus(this.speed.times(a));b.collisionWith(c,this.size,"obstacle")?this.speed=this.speed.times(-1):this.pos=c};
EvilCloud.prototype.draw=function(a,b,c){a.save();drawCloud(a,b,c,this.r1,this.r2,"grey");a.restore()};function Tree(a){this.pos=a;this.size=new Vector(3,12);this.horizBranchNos=1+getRandomElement([2,4]);this.vertBranchNos=2+~~(4*Math.random());this.treeColor="green"}Tree.prototype.type="tree";Tree.prototype.act=function(){};Tree.prototype.draw=function(a,b,c){a.save();drawTree(a,b,c+1*Game.scale,this.horizBranchNos,this.vertBranchNos,this.treeColor);a.restore()};
var airLevelBackgroundChars={x:"wall"},airLevelActorChars={"@":AirPlayer,t:Tree,C:EvilCloud,g:AirGem},xMargin=1,treeHeight=5,airLevelMap=generateAirBasicLevel(40,200,xMargin,treeHeight),airLevel=new LevelInfo(LEVEL_TYPE.PLATFORMER,airLevelMap,airLevelBackgroundChars,airLevelActorChars);airLevel.platformerType="vertical";airLevel.generateLevel=function(){this.level=generateAirBasicLevel(40,200,xMargin,treeHeight)};
airLevel.drawBackground=function(a,b,c,d){"wall"==a?(b.fillStyle="gold",b.fillRect(c,d,Game.scale+1,Game.scale+1)):"fierceRiver"==a&&(b.fillStyle="green",b.fillRect(c,d,Game.scale+1,Game.scale+1))};
airLevel.playerTouched=function(a,b,c){if("AirGem"==a&&null==c.status)return c.player.gravity=0,c.player.speed.y=-c.player.jumpSpeed,c.actors=c.actors.filter(function(a){return a!=b}),Game.level=waterLevel,Game.numberOfGemsCollected++,Game.gemsCollected.air=!0,Game.hud.setGameMessage(b.winMessage),"won";"EvilCloud"==a&&reducePlayerHealth(50,c,"Beware of the Evil Cloud.");if(0>=c.player.health&&null==c.status)return"lost"};function generateEarthLevelWithObstacles(a){for(var b=a[0].length,c=0,d=~~(2*a.length/3),e=!1,c=5;c<b-20;)!0==e?(a[d-1][c+2]="C",c+=5,e=!1):!1==e&&(c+=12+~~(7*Math.random()),e=!0);a[d-2][b-3]="g";return a}var earthLevelMap=generateEarthLevelWithObstacles(generateFireBasicLevel(300,50));function Cactus(a){this.size=new Vector(3,2+~~(8*Math.random()));this.pos=a;this.pos.y-=this.size.y-2;this.type="cactus"}Cactus.prototype.act=function(){};
Cactus.prototype.draw=function(a,b,c){a.save();a.fillStyle="green";a.fillRect(b,c,Game.scale-6,2*this.size.y/3*Game.scale);a.fillRect(b,c+2*this.size.y/3*Game.scale,Game.scale,12);a.fillRect(b+Game.scale,c,Game.scale-6,this.size.y*Game.scale);a.fillRect(b+Game.scale,c+1*this.size.y/3*Game.scale,1.7*Game.scale,12);a.fillRect(b+2*Game.scale,c,Game.scale-6,1*this.size.y/3*Game.scale);a.restore()};function EarthPlayer(a){PlayerPlatformer.call(this,a);this.drawLast=!0;this.jumpSpeed=20}
EarthPlayer.prototype=Object.create(PlayerPlatformer.prototype);EarthPlayer.prototype.moveX=function(a,b,c){this.pos.x>b.width-4?PlayerPlatformer.prototype.moveX.call(this,a,b,c):(this.speed.x=8,a=new Vector(this.speed.x*a,0),this.pos=this.pos.plus(a))};function EarthStoneGem(a){Gem.call(this,a,"EarthStoneGem","#DEB887","#DE8857","earth gem.");this.size=new Vector(4,4)}EarthStoneGem.prototype=Object.create(Gem.prototype);
var earthLevelBackgroundChars={x:"wall"},earthLevelActorChars={"@":EarthPlayer,C:Cactus,g:EarthStoneGem},earthLevel=new LevelInfo(LEVEL_TYPE.PLATFORMER,earthLevelMap,earthLevelBackgroundChars,earthLevelActorChars);earthLevel.platformerType="horizontal";earthLevel.generateLevel=function(){this.level=generateEarthLevelWithObstacles(generateFireBasicLevel(300,50))};earthLevel.drawBackground=function(a,b,c,d){"wall"==a&&(b.fillStyle="rgba(170, 170, 50, 255)",b.fillRect(c,d,Game.scale+1,Game.scale+1))};
earthLevel.playerTouched=function(a,b,c){if("cactus"==a)reducePlayerHealth(20,c,"Beware of the cactus.");else if("EarthStoneGem"==a&&null==c.status)return c.actors=c.actors.filter(function(a){return a!=b}),Game.level=waterLevel,Game.numberOfGemsCollected++,Game.gemsCollected.earth=!0,Game.hud.setGameMessage(b.winMessage),"won";if(0>=c.player.health&&null==c.status)return"lost"};var rowWidth=100,rowHeight=100,isLandSizePercent=0.2,remSharkPercent=0.995,remLogPercent=0.99,numberOfTilesInIsland=100;waterLevelPlan=createPlan(rowWidth,rowHeight,isLandSizePercent,remSharkPercent,remLogPercent,numberOfTilesInIsland);function NPC(a,b,c,d){this.pos=a;this.hasDialog=!0;this.dialog=new Dialog;this.dialog.messages=d;this.type=c;this.drawLast=!0;waterLevel.npcs.push(this)}
NPC.prototype.draw=function(a,b,c){a.save();"eagle"==this.type?drawEagle(a,b+Game.scale,c+3*Game.scale,Game.scale/4):"tortoise"==this.type?drawTurtoise(a,b,c+2*Game.scale,Game.scale/5):"crab"==this.type?drawCrab(a,b+1*Game.scale,c+3.5*Game.scale,Game.scale/3):(this.type="owl")&&drawOwl(a,b+1.8*Game.scale,c+1.3*Game.scale,Game.scale/4);a.restore()};NPC.prototype.act=function(){};function Tortoise(a,b){NPC.call(this,a,b,"tortoise",tortoiseDialogue);this.island="water";this.size=new Vector(8,4)}
Tortoise.prototype=Object.create(NPC.prototype);function Crab(a,b){NPC.call(this,a,b,"crab",crabDialogue);this.island="earth";this.size=new Vector(8,4)}Crab.prototype=Object.create(NPC.prototype);function Eagle(a,b){NPC.call(this,a,b,"eagle",eagleDialogue);this.island="fire";this.size=new Vector(4.5,5)}Eagle.prototype=Object.create(NPC.prototype);function Owl(a,b){NPC.call(this,a,b,"owl",owlDialogue);this.island="air";this.size=new Vector(5.5,7)}Owl.prototype=Object.create(NPC.prototype);
function Island(a,b,c){this.pos=a;this.size=new Vector(1,1);this.color=c;this.type=b}Island.prototype.draw=function(a,b,c){a.save();a.fillStyle=this.color;a.fillRect(b,c,Game.scale+1,Game.scale+1);a.restore()};Island.prototype.act=function(){};function EarthIsland(a){Island.call(this,a,"earth","brown")}EarthIsland.prototype=Object.create(Island.prototype);function WaterIsland(a){Island.call(this,a,"water","green")}WaterIsland.prototype=Object.create(Island.prototype);
function FireIsland(a){Island.call(this,a,"fire","red")}FireIsland.prototype=Object.create(Island.prototype);function AirIsland(a){Island.call(this,a,"air","grey")}AirIsland.prototype=Object.create(Island.prototype);function IsLandStruct(a){Island.call(this,a,"isLandStruct","#F4A460");this.collisionNotRequired=!0}IsLandStruct.prototype=Object.create(Island.prototype);function Portal(a){this.pos=a;this.drawLast=!0;this.size=new Vector(8,8);this.type="portal"}
Portal.prototype.drawPortalArc=function(a,b,c,d,e,f){a.fillStyle=f;a.beginPath();a.moveTo(b+4*Game.scale,c+4*Game.scale);a.arc(b+4*Game.scale,c+4*Game.scale,4*Game.scale,d,e);a.fill()};
Portal.prototype.draw=function(a,b,c){a.save();a.fillStyle="#2F4F4F";this.drawPortalArc(a,b,c,0,Math.PI/2,"green");this.drawPortalArc(a,b,c,Math.PI/2,Math.PI,"brown");this.drawPortalArc(a,b,c,Math.PI,1.5*Math.PI,"grey");this.drawPortalArc(a,b,c,1.5*Math.PI,2*Math.PI,"red");Game.gemsPlaced.water&&drawDiamond(a,b+4.5*Game.scale,c+7*Game.scale,"#7777FE","#2222FE");Game.gemsPlaced.earth&&drawDiamond(a,b+0.5*Game.scale,c+7*Game.scale,"#DEB887","#DE8857");Game.gemsPlaced.air&&drawDiamond(a,b+0.5*Game.scale,
c+3*Game.scale,"#DCDCDC","#ECECEC");Game.gemsPlaced.fire&&drawDiamond(a,b+4.5*Game.scale,c+3*Game.scale,"#FE7777","#FE2222");a.restore()};Portal.prototype.act=function(){};function Shark(a){this.pos=a;this.size=new Vector(1,1);this.dir=Math.random();0.5<this.dir?(this.speedX=~~(28*Math.max(Math.random(),0.2)),this.speedY=0):(this.speedX=0,this.speedY=~~(28*Math.max(Math.random(),0.2)));this.speed=new Vector(this.speedX,this.speedY)}Shark.prototype.type="shark";
Shark.prototype.act=function(a,b){var c=this.pos.plus(this.speed.times(a));!b.collisionWith(c,this.size,"obstacle")&&!b.collisionWith(c,this.size,"island")?this.pos=c:this.speed=this.speed.times(-1)};
Shark.prototype.draw=function(a,b,c){a.save();a.fillStyle="grey";0!=this.speed.x?(a.fillRect(b,c,20,10),a.beginPath(),a.strokeStyle="white",0<this.speed.x?(a.moveTo(b,c),a.lineTo(b-50,c-20),a.moveTo(b,c+10),a.lineTo(b-50,c+30),a.moveTo(b+20,c),a.quadraticCurveTo(b+40,c+5,b+20,c+10)):(a.moveTo(b+20,c),a.lineTo(b+50,c-20),a.moveTo(b+20,c+10),a.lineTo(b+50,c+30),a.moveTo(b,c),a.quadraticCurveTo(b-20,c+5,b,c+10))):(a.fillRect(b,c,10,20),a.beginPath(),a.strokeStyle="white",0<this.speed.y?(a.moveTo(b,c),
a.lineTo(b-20,c-50),a.moveTo(b+10,c),a.lineTo(b+30,c-50),a.moveTo(b,c+20),a.quadraticCurveTo(b+5,c+40,b+10,c+20)):(a.moveTo(b,c+20),a.lineTo(b-20,c+50),a.moveTo(b+10,c+20),a.lineTo(b+30,c+50),a.moveTo(b,c),a.quadraticCurveTo(b+5,c-20,b+10,c)));a.stroke();a.fill();a.restore()};function WaterPlayer(a){PlayerNonPlatformer.call(this,a);this.drawLast=!0}WaterPlayer.prototype=Object.create(PlayerNonPlatformer.prototype);
var waterLevelBackgroundChars={x:"wall",l:"log"},waterLevelActorChars={"@":WaterPlayer,s:Shark,W:WaterIsland,E:EarthIsland,F:FireIsland,A:AirIsland,q:IsLandStruct,P:Portal,B:Tortoise,T:Owl,C:Crab,U:Eagle},waterLevel=new LevelInfo(LEVEL_TYPE.NONPLATFORMER,waterLevelPlan,waterLevelBackgroundChars,waterLevelActorChars);waterLevel.generateLevel=function(){this.level=waterLevelPlan};waterLevel.npcs=[];npcIslandType={earth:"crab",water:"tortoise",air:"owl",fire:"eagle"};
islandLevel={earth:earthLevel,water:riverLevel,air:airLevel,fire:fireLevel};waterLevel.islandChars={q:"0",E:"1",W:"2",F:"3",A:"4"};
function islandTouch(a){var b="You need to collect the key from "+npcIslandType[a]+" to enter the "+a+" island",c="Welcome to the "+a+" island",d="You have already collected the gem from "+a+" island";if(Game.levelKeys[a])if(Game.gemsCollected[a])Game.hud.setGameMessage(d);else return Game.hud.setGameMessage(c),Game.nextLevel=islandLevel[a],"won";else Game.hud.setGameMessage(b)}
function placeGem(a){return Game.gemsCollected[a]&&!Game.gemsPlaced[a]?(Game.gemsPlaced[a]=!0,Game.numberOfGemsPlaced++," "+a+" "):""}
waterLevel.playerTouched=function(a,b,c){if("shark"==a&&(null==c.status&&!Game.inInteraction)&&(0==c.player.playerHitTimer&&(c.player.health-=10,c.player.playerHitTimer=c.player.playerHitTimerMax,Game.hud.setGameMessage("Shark Attacked. "+c.player.health)),0>=c.player.health))return"lost";if(null==c.status&&islandLevel[a])return islandTouch(a,null);if(null==c.status&&"portal"==a&&(a=""+placeGem("water"),a+=placeGem("earth"),a+=placeGem("air"),a+=placeGem("fire"),""!=a&&Game.hud.setGameMessage(a+" gem placed in the portal"),
4==Game.numberOfGemsPlaced))return Game.GameOver=!0,"won"};
waterLevel.playerInteract=function(a,b){var c=a.dialog.getNextQuestionBatch();if("2"==a.dialog.messages.currentBatchKey&&!Game.gemsCollected[a.island])Game.levelKeys[a.island]=!0,Game.inInteraction=!1,b.player.skipDialogTimer=4*b.player.skipDialogTimerMax,Game.hud.setGameMessage(c.welcomeMessage,!1);else if("3"==a.dialog.messages.currentBatchKey&&4!=Game.numberOfGemsCollected)Game.inInteraction=!1,b.player.skipDialogTimer=4*b.player.skipDialogTimerMax,Game.hud.setGameMessage(c.welcomeMessage,!1);
else{Game.numberOfQuestions=Object.keys(c).length-1;for(var d=0,e=0;e<Game.numberOfQuestions;e++)0==c[""+e].askedStatus&&d++;0==d&&!a.dialog.lastBatch()&&(a.dialog.setNextQuestionBatch(),c=a.dialog.getNextQuestionBatch(),Game.currentQuestionNo=0,Game.numberOfQuestions=Object.keys(c).length-1,Game.nextQuestionReady=!0);"1"==a.dialog.messages.currentBatchKey&&!Game.currentBatchKey&&(waterLevel.npcs.forEach(function(a){a.dialog.messages.currentBatchKey="1"}),Game.currentBatchKey=!0);0==Game.numberOfQuestions?
(Game.hud.clearScreen(),Game.hud.setGameMessage(c.welcomeMessage)):!Game.inInteraction&&(0!=Game.numberOfQuestions&&0>=b.player.skipDialogTimer)&&(Game.inInteraction=!0,Game.currentQuestionNo=0,Game.hud.clearScreen(),Game.hud.setGameMessage(c.welcomeMessage,!0),Game.inQuestion=!1,Game.nextQuestionReady=!1);keys.skip&&(Game.hud.clearScreen(),Game.hud.setGameMessage("",!0),Game.inInteraction=!1,b.player.skipDialogTimer=b.player.skipDialogTimerMax);if(c&&0!=Game.numberOfQuestions&&(keyPressed.up&&Game.inQuestion&&
(Game.currentQuestionNo--,Game.hud.drawQuestions(c),resetKeyPressed()),keyPressed.down&&Game.inQuestion&&(Game.currentQuestionNo++,Game.hud.drawQuestions(c),resetKeyPressed()),keyPressed.enter))Game.inQuestion?(Game.hud.clearScreen(),Game.hud.setGameMessage(c[Game.currentQuestionNo].answer,!0),c[Game.currentQuestionNo].askedStatus=1,Game.inQuestion=!1):(Game.inQuestion=!0,Game.hud.setGameMessage("",!0),Game.hud.clearScreen(),Game.nextQuestionReady||Game.hud.drawQuestions(c)),Game.nextQuestionReady&&
(Game.nextQuestionReady=!1,Game.inInteraction=!1),resetKeyPressed()}};waterLevel.drawBackground=function(a,b,c,d){b.save();b.fillStyle={wall:"yellow",log:"brown"}[a];"log"==a?(b.fillStyle="white",b.fillRect(c-4,d+Game.scale-1,Game.scale+8,4),drawTriangle(b,new Vector(c,d+Game.scale),new Vector(c+0.5*Game.scale,d),new Vector(c+Game.scale,d+Game.scale),"brown")):(b.fillRect(c,d,Game.scale+1,Game.scale+1),b.restore())};
