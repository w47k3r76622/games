var scoreFactor=40,thrust=-.01,grav=.002,maxVel=.9,highscore=0,baseDelta=7,delT,currentScreen,tutorial,ents,score,camY,velY,running,can,ctx,hero,joystick,bg,TUT_INTRO=0,TUT_GRAB=1,TUT_RELEASE=2,TUT_REVERSE=3,TUT_AVOID=4,TUT_OVER=5,TUT_FAIL=6;function Tutorial(){this.fadeDelay=10;this._state=TUT_INTRO;this._delTV=.04;delT=this._t=0;joystick.disabled=!0}
Tutorial.prototype={_changeState(a){this._state=a;this._t=0},_retry(){this._sinceRelease=this._sinceGrab=null},update(){this._t+=1;switch(this._state){case TUT_INTRO:80<=this._t&&(this._changeState(TUT_GRAB),joystick.disabled=!1);break;case TUT_GRAB:3>delT&&(delT+=this._delTV);this._sinceGrab&&this._t>=this._sinceGrab+this.fadeDelay&&this._changeState(TUT_RELEASE);break;case TUT_RELEASE:.7<delT&&(delT-=this._delTV);this._sinceRelease&&(delT+=this._delTV,this._t>=this._sinceRelease+this.fadeDelay&&
this._changeState(TUT_REVERSE));break;case TUT_REVERSE:150<=this._t&&this._changeState(TUT_AVOID);break;case TUT_AVOID:5>delT&&(delT+=this._delTV);500<=this._t&&this._changeState(TUT_OVER);break;case TUT_OVER:delT<baseDelta&&(delT+=this._delTV);break;case TUT_FAIL:80<=this._t&&(transition($("start-screen")),running=!1,tutorial=null)}},_drawText(a,b,d,e,f,g){ctx.save();ctx.font=(g?"bold ":"")+"32px Arial";ctx.fillStyle=e||"black";ctx.shadowColor=e||"black";ctx.shadowBlur=7;ctx.globalAlpha=f;ctx.fillText(a,
b,d-camY);ctx.restore()},_ease(a,b){return this._t<a?0:this._t<a+this.fadeDelay?(this._t-a)/this.fadeDelay:this._t>b-this.fadeDelay?(b-this._t)/this.fadeDelay:1},draw(){var a=Math.Infinity,b,d;switch(this._state){case TUT_INTRO:this._drawText("this is you",150,100,"black",this._ease(0,80));break;case TUT_GRAB:this._sinceGrab&&(a=this._sinceGrab+this.fadeDelay);this._drawText("grab the",180,300,"black",this._ease(30,a));this._drawText("blue dot",305,300,"blue",this._ease(30,a));break;case TUT_RELEASE:this._sinceRelease&&
(a=this._sinceRelease+this.fadeDelay);b=180;d=400;this._drawText("blue dot",b,d,"blue",this._ease(10,a));this._drawText("moves",b+125,d,"black",this._ease(10,a));this._drawText("only",b+225,d,"black",this._ease(10,a),!0);this._drawText("in the",b,d+40,"black",this._ease(10,a));this._drawText("green semicircle",b+85,d+40,"green",this._ease(10,a));this._drawText("pull and release to",b,d+110,"black",this._ease(50,a));this._drawText("thrust",b+265,d+110,"black",this._ease(50,a),!0);break;case TUT_REVERSE:a=
150;b=250;d=joystick.pos.y-joystick.wellSize-60;this._drawText("green region",b,d,"green",this._ease(0,a));this._drawText("reverses",b+185,d,"black",this._ease(0,a),!0);this._drawText("every time you thrust",b,d+40,"black",this._ease(10,a));break;case TUT_AVOID:a=500;this._drawText("avoid the edges of the screen",150,300,"black",this._ease(30,a));this._drawText("keep climbing",100,150,"black",this._ease(170,a));this._drawText("dodge falling ",150,30,"black",this._ease(270,a));this._drawText("red boxes",
345,30,"red",this._ease(270,a));break;case TUT_FAIL:this._drawText("mediocre",240,50,"black",this._ease(0,80),!0)}},touchDown(){this._sinceGrab=this._t},touchUp(){this._sinceRelease=this._t},end(){this._state===TUT_OVER?(tutorial=null,endGame()):this._changeState(TUT_FAIL)}};function $(a){return document.getElementById(a)}function resetScreen(a){hide(a)}function transition(a){hide(currentScreen);show(a);currentScreen=a}function hide(a){a.style.display="none"}function show(a){a.style.display=""}
function forEach(a,b){for(var d=0;d<a.length;d++)b(a[d])}function randRange(a,b){return Math.random()*(b-a)+a}function motion(a){a.vel.fAdd(delT,a.acc);a.pos.fAdd(delT,a.vel)}function drawCircle(a,b,d,e,f){a.beginPath();a.arc(b,d,e,0,2*Math.PI);!0===f?a.fill():a.stroke()}function drawText(a,b,d){ctx.textAlign="center";ctx.fillText(a,b,d)}function drawBox(a,b,d,e,f){a.fillRect(b-e/2,d-f/2,e,f)}
function drawCan(a,b,d,e){e?(ctx.save(),ctx.translate(b,d),ctx.rotate(e),ctx.drawImage(a,-a.width/2,-a.height/2),ctx.restore()):ctx.drawImage(a,b-a.width/2,d-a.height/2)}function preDraw(a){var b=document.createElement("canvas"),d=b.getContext("2d");a(d,b);return b}function V(a,b){this.x=a||0;this.y=b||0}V.fromTouch=(a)=>new V(a.clientX,a.clientY);V.fromMouse=(a)=>new V(a.offsetX,a.offsetY);
V.prototype={add(a){this.x+=a.x;this.y+=a.y},fAdd(a,b){this.x+=a*b.x;this.y+=a*b.y},scale(a){this.x*=a;this.y*=a},sub(a){this.x-=a.x;this.y-=a.y},set(a,b){this.x=a;this.y=b},angle(){return Math.atan2(this.y,this.x)},rotate(a){var b=this.x,d=this.y;this.x=b*Math.cos(a)-d*Math.sin(a);this.y=b*Math.sin(a)+d*Math.cos(a)},i(){return new V(this.x,this.y)},r(){return this.x*this.x+this.y*this.y},limit(a){var b=this.r();b>a*a&&(a/=Math.sqrt(b),this.x*=a,this.y*=a)}};
function Box(a,b){this.pos=new V;this._left=this._top=0;this.w=a;this.h=b;this.can=preDraw(this._drawBox.bind(this))}
Box.prototype={_drawBox(a,b){b.width=this.w+10;b.height=this.h+10;a.globalAlpha=.8;a.fillStyle="#e55";a.lineWidth=5;a.strokeStyle="#e77";a.shadowBlur=4;a.shadowColor="red";a.beginPath();a.moveTo(5,5);a.lineTo(5+this.w,5);a.lineTo(5+this.w,5+this.h);a.lineTo(5,5+this.h);a.closePath();a.fill();a.stroke()},update(){this.pos.y+=boxes.speed*delT;this._top=this.pos.y-this.h/2},outOfView(){return this._top>camY+can.height},checkCollide(a,b,d,e){return this._top+this.h>a&&this._top<a+e&&this._left+this.w>
b&&this._left<b+d}};function Boxes(){var a;this._lastInc=0;this._bs=[];this.numBoxes=0;this.maxBoxes=7;this.baseDelay=1E3;this.numChannels=6;this.speed=.1;this.incAmt=.065;this.incInt=1E3;this.acc=.001;this._targetSpeed=.1;this._t=0;this._chs=[];this._chSep=can.width/this.numChannels;for(a=0;a<this.numChannels;a++)this._chs[a]=[]}
Boxes.prototype={collides(a,b,d,e){var f=~~(b/this._chSep),g=~~((b+d)/this._chSep);return this._checkChannel(f,a,b,d,e)||g!==f&&this._checkChannel(g,a,b,d,e)?!0:!1},_checkChannel(a,b,d,e,f){if(0>a||a>=this._chs.length)return!1;a=this._chs[a];var g,h;for(g=0;g<a.length;g++)if(h=a[g],h.checkCollide(b,d,e,f))return!0;return!1},_spawnBox(a){var b,d,e;d=~~randRange(this._chSep/2,3*this._chSep/4);e=~~randRange(70,140);b=new Box(d,e);b.pos.x=this._chSep*a+randRange(0,this._chSep-d-2)+d/2;b.pos.y=camY-e-
randRange(30,60);b._top=b.pos.y-e/2;b._left=b.pos.x-d/2;this._checkChannel(a,b._top,b._left,d,e)?this._trySpawn():(this._chs[a].push(b),this.numBoxes+=1)},update(){var a,b;this.speed<this._targetSpeed&&(this.speed+=this.acc);for(a=0;a<this.numChannels;a++)for(c=this._chs[a],b=c.length-1;0<=b;b--)c[b].update(),c[b].outOfView()&&(c.splice(b,1),--this.numBoxes);for(a=this._bs.length-1;0<=a;a--)this._bs[a].outOfView();this._t+=delT;if(this._t>this.baseDelay&&!hero._dead){this._t=0;if(this.numBoxes>this.maxBoxes)return;
this._trySpawn()}-hero.pos.y>-this._lastInc+this.incInt&&(this._targetSpeed+=this.incAmt,this._lastInc=hero.pos.y)},draw(){var a,b,d,e;for(a=0;a<this.numChannels;a++)for(d=this._chs[a],b=d.length-1;0<=b;b--)e=d[b],drawCan(e.can,e.pos.x,e.pos.y-camY)},_trySpawn(){var a=~~randRange(0,10),b=~~(hero.pos.x/this._chSep);4>a?this._spawnBox(b):6>a?(0<b&&this._spawnBox(b-1),b<this.numChannels-1&&this._spawnBox(b+1)):this._spawnBox(~~randRange(0,this.numChannels-1))}};
function Fragment(a,b){this.alpha=1;this.size=30;this.speed=.55;this.pos=a;this.vec=b;this.vec.limit(this.speed);this.can=preDraw(this._drawCan.bind(this));this._t=0}
Fragment.prototype={_drawCan(a,b){b.width=b.height=2*this.size;a.beginPath();a.arc(this.size,this.size,this.size,0,2*Math.PI);a.closePath();a.fill()},update(){this._t+=delT;this.alpha*=.87},draw(){ctx.save();ctx.translate(this.pos.x+this.vec.x*this._t,this.pos.y+this.vec.y*this._t-camY);ctx.scale(this.alpha,this.alpha);ctx.drawImage(this.can,-this.can.width/2,-this.can.height/2);ctx.restore()}};
function Hero(){this.size=45;this.pos=new V;this.vel=new V;this.acc=new V;this.numFragments=8;this.explodeTime=40;this._can=preDraw(this._drawChar.bind(this));this._dead=!1;this._fs=[]}
Hero.prototype={_drawChar(a,b){var d=~~(1.2*this.size);b.width=b.height=d;a.globalAlpha=.9;a.fillStyle="#222";a.strokeStyle="#333";a.shadowColor="#444";a.shadowBlur=2;a.beginPath();a.moveTo(d/2,0);a.lineTo(d,d/2);a.lineTo(d/2,d);a.lineTo(0,d/2);a.closePath();a.fill();a.stroke()},update(){motion(this);this.vel.limit(maxVel);if(this._dead)--this.explodeTime,0===this.explodeTime?tutorial?tutorial.end():endGame():this._fs.forEach((a)=>{a.update()});else{var a=this.pos.y-this.size/2,b=this.pos.x-this.size/
2;0>b||b+this.size>can.width||a<camY||a+this.size>camY+can.height?this.explode():boxes.collides(a,b,this.size,this.size)?this.explode():this._trackCam3()}},draw(){this._dead?this._fs.forEach((a)=>{a.draw()}):drawCan(this._can,this.pos.x,this.pos.y-camY,joystick._angle)},explode(){this._dead=!0;var a=new V(1,0),b=2*Math.PI/this.numFragments,d,e;for(e=0;e<this.numFragments;e++)d=a.i(),a.rotate(b),this._fs.push(new Fragment(this.pos.i(),d,b,this.pos))},impulse(a){a.scale(thrust);hero.vel.set(a.x,a.y);
hero.acc.y=grav;a.scale(-1)},_trackCam1(){0!==this.vel.y&&(velY=0>this.vel.y?-Math.pow(-this.vel.y,1.3)*(camY+can.height-this.pos.y)*2/can.height:Math.pow(this.vel.y,2));camY=~~(camY+velY*delT)},_trackCam2(){camY=~~Math.min(camY,this.pos.y-can.height/2)},_trackCam3(){0!==this.vel.y&&0>this.vel.y&&(velY=-Math.pow(-this.vel.y,1.3)*(camY+can.height-this.pos.y)*2/can.height,camY=~~(camY+velY*delT))}};var STICK_ENGAGED=1,STICK_RESETTING=2,STICK_FREE=3,DIR_LEFT=1,DIR_RIGHT=2;
function Joystick(){this.wellSize=100;this.dotSize=40;this.pos=new V;this.disabled=!1;this.reset();this._dotR2=this.dotSize*this.dotSize;this._dotCan=preDraw(this._drawDot.bind(this));this._wellCan=preDraw(this._drawWell.bind(this));isMobile()?(can.addEventListener("touchstart",this._touchStart.bind(this)),can.addEventListener("touchmove",this._touchMove.bind(this)),can.addEventListener("touchend",this._touchEnd.bind(this)),can.addEventListener("touchcancel",this._touchEnd.bind(this)),can.addEventListener("touchleave",
this._touchEnd.bind(this))):(can.addEventListener("mouseout",this._mouseUp.bind(this)),can.addEventListener("mouseup",this._mouseUp.bind(this)),can.addEventListener("mousedown",this._mouseDown.bind(this)),can.addEventListener("mousemove",this._mouseMove.bind(this)))}
Joystick.prototype={reset(){this.resetTime=130;this.dot=new V;this.direction=DIR_LEFT;this.state=STICK_FREE;this._angle=0;this._dotV=new V;this._initTouch=new V;this._id=null;this._t=0},update(){var a;switch(this.state){case STICK_RESETTING:this._t+=delT,a=this._t/this.resetTime,this.dot.scale(1-a),this._angle=(this.direction===DIR_RIGHT?-a:1-a)*Math.PI,this._t>this.resetTime&&(this.state=STICK_FREE,this.dot.set(0,0),this._t=0,this._angle=this.direction===DIR_RIGHT?Math.PI:0)}},draw(){drawCan(this._wellCan,
this.pos.x,this.pos.y,this._angle);drawCan(this._dotCan,this.pos.x+this.dot.x,this.pos.y+this.dot.y)},_start(a){a.sub(this.pos);return a.r()<this._dotR2?(this._initTouch.set(a.x,a.y),this.state=STICK_ENGAGED,tutorial&&tutorial.touchDown(),!0):!1},_move(a){a.sub(this.pos);a.sub(this._initTouch);this.dot.set(a.x,a.y);this.dot.x=this.direction===DIR_LEFT?Math.min(0,this.dot.x):Math.max(0,this.dot.x);this.dot.limit(this.wellSize)},_touchStart(a){var b=this;forEach(a.changedTouches,(a)=>{b.state===STICK_FREE&&
!b.disabled&&b._start(V.fromTouch(a))&&(b._id=a.identifier)})},_touchMove(a){if(this.state===STICK_ENGAGED){var b=this;forEach(a.changedTouches,(a)=>{a.identifier===b._id&&b._move(V.fromTouch(a))})}},_touchEnd(a){if(this.state===STICK_ENGAGED){var b=this;forEach(a.changedTouches,(a)=>{a.identifier===b._id&&b._release()})}},_mouseUp(a){this.state===STICK_ENGAGED&&this._id===a.button&&(this._id=null,this._release())},_mouseDown(a){this.state===STICK_FREE&&this._start(V.fromMouse(a))&&(this._id=a.button)},
_mouseMove(a){this.state===STICK_ENGAGED&&this._id===a.button&&this._move(V.fromMouse(a))},_release(){this.state=STICK_RESETTING;hero.impulse(this.dot.i());this._lf=0;this.direction=this.direction===DIR_LEFT?DIR_RIGHT:DIR_LEFT;tutorial&&tutorial.touchUp()},_drawDot(a,b){var d=this.dotSize;b.height=b.width=2*d+14;a.fillStyle="#55e";a.shadowBlur=8;a.lineWidth=6;a.shadowColor="#33a";var e=d+7;a.beginPath();a.arc(e,e,d,0,2*Math.PI);a.fill()},_drawWell(a,b){var d=this.wellSize;b.width=b.height=2*d+18;
a.fillStyle="#7f7";a.strokeStyle="#5e5";a.shadowBlur=10;a.lineWidth=8;a.shadowColor="#3a3";var e=this.wellSize+9;a.beginPath();a.arc(e,e,d,Math.PI/2,-Math.PI/2);a.closePath();a.stroke();a.globalAlpha=.7;a.fill()}};
function Background(){this.bgColor="#fffacd";this.lineColor="#eed8ae";this.numX=22;this.numY=~~(this.numX*can.height/can.width);this.sepX=~~(can.width/this.numX);this.sepY=~~(can.height/this.numY);this.subDiv=5;this.rulerRes=this.sepY*this.subDiv;this.rulerWidth=2*this.sepX;this.rulerStart=can.height-can.height%this.rulerRes;this.numR=~~(can.height/this.rulerRes)+1;this.gridCan=preDraw(this._drawGrid.bind(this))}
Background.prototype={_drawGrid(a,b){b.width=can.width;b.height=can.height+this.sepY;var d,e;a.fillStyle=this.bgColor;a.fillRect(0,0,b.width,b.height);a.strokeStyle=this.lineColor;a.lineWidth=1;for(d=0;d<this.numX;d++)e=d*this.sepX,a.beginPath(),a.moveTo(e,0),a.lineTo(e,b.height),a.closePath(),a.stroke();for(d=0;d<=this.numY+1;d++)e=d*this.sepY,a.beginPath(),a.moveTo(0,e),a.lineTo(b.width,e),a.closePath(),a.stroke()},update(){},draw(){ctx.drawImage(this.gridCan,0,-camY%this.sepY-this.sepY);ctx.fillStyle=
"black";ctx.font="20px sans-serif";ctx.textAlign="start";var a,b;for(i=-this.subDiv;i<=this.numR*this.subDiv;i++)a=~~(i*this.rulerRes/this.subDiv-camY%this.rulerRes),b=this.rulerWidth/2,0==i%this.subDiv&&(ctx.fillText(""+(-a-camY+this.rulerStart),5,a-2),b=this.rulerWidth),ctx.beginPath(),ctx.moveTo(0,a),ctx.lineTo(b,a),ctx.stroke()}};function updateScore(a){score=~~Math.max(score,-hero.pos.y/scoreFactor)}
function tick(){if(running){tutorial&&tutorial.update();boxes.update();hero.update();joystick.update();bg.update();updateScore();ctx.clearRect(0,0,can.width,can.height);bg.draw();tutorial&&tutorial.draw();hero.draw();boxes.draw();joystick.draw();var a;for(a=ents.length-1;0<=a;a--)ents[a]._dead?ents.splice(a,1):(ents[a].update(),ents[a].draw());requestAnimationFrame(tick)}}
function reset(){delT=7;velY=camY=0;ents=[];score=0;boxes=new Boxes;hero=new Hero;hero.pos.set(100,100);hero.acc.y=grav;running=!0;joystick.reset();tick()}function displayScore(){if(!highscore)try{highscore=+localStorage.getItem("highscore")}catch(a){highscore=0}$("end-score").innerHTML=score;highscore=Math.max(score,highscore);$("end-highscore").innerHTML=highscore;try{localStorage.setItem("highscore",highscore)}catch(b){}}
function startGame(a){transition($("game-canvas"));reset();a&&(tutorial=new Tutorial)}function endGame(){running=!1;displayScore();transition($("end-screen"))}function backToMenu(){transition($("start-screen"))}function restartGame(){transition($("game-canvas"));reset()}
function isMobile(){var a=!1,b=navigator.userAgent||navigator.vendor||window.opera;if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,
4)))a=!0;return a}window.onload=()=>{currentScreen=$("start-screen");resetScreen($("end-screen"));resetScreen($("game-canvas"));can=$("game-canvas");ctx=can.getContext("2d");can.width=600;can.height=document.documentElement.clientHeight;bg=new Background;joystick=new Joystick;joystick.pos.set(470,.95*can.height-joystick.wellSize)};window.oncontextmenu=(a)=>{a.preventDefault();return!1};document.ontouchmove=(a)=>{a.preventDefault();return!1};
