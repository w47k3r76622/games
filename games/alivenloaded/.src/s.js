function k(){var t="g"+Math.random();return l[t]=new m,t}function n(){for(var t=[],i=l[q],a=0;a<i.a.length;++a)t.push(!i.a[a].f);return t}function u(){for(var t in l){var i=l[t];if(3==i.v&&0<=i.u){var a=-1,e=-1,h=-1;if(2<++i.u){var a=Math.floor(4+16*Math.random()),h=Math.floor(4*Math.random()),n=i.i[a].j[h];-1!=n&&(12!=i.j[n]?(i.j[n]=12,i.i[a].items[h].type=48+h,i.i[a].items.push({x:[4,8,4,0][h],y:[8,4,0,4][h],type:68+h}),e=v(a,h),i.i[e].items[2^h].type=48+(2^h),i.i[e].items.push({x:[4,0,4,8][h],y:[0,4,8,4][h],type:68+(2^h)})):a=-1)}for(n=0;3>n;++n){i.a[n].m=i.a[n].s;var s=Math.max(0,5-i.a[n].m-Math.max(0,Math.floor((i.a[n].g.length-1)/3)));i.a[n].h=Math.min(12,i.a[n].h+s),i.a[n].f.c.emit("cy",i.a[n].h,i.a[n].m,i.u,i.a[n].b==a?h:i.a[n].b==e?2^h:-1,i.i[i.a[n].b])}}}setTimeout(u,1e4)}function v(t,i){var a,e;return a=(3&t)+[0,1,0,-1][i],e=(t>>2)+[-1,0,1,0][i],4*e+a}function m(){this.a=[{b:0,x:0,y:2,orientation:0,h:2,g:[],m:0,s:0,f:0},{b:0,x:2,y:2,orientation:0,h:2,g:[],m:0,s:0,f:0},{b:0,x:4,y:2,orientation:0,h:2,g:[],m:0,s:0,f:0}],this.v=0,this.j=[],this.i=[];for(var t=this.u=0;40>t;++t)this.j.push(3&t?5:0);for(var i=0;5>i;++i)for(var a=0;4>a;++a){for(var e={items:[],j:[1>i||1==i&&1!=a?-1:8*i+a-4,1>i||3==a?-1:8*i+a,1>i&&1!=a||4==i?-1:8*i+a+4,1>i||0==a?-1:8*i+a-1]},t=0;4>t;++t)e.items[t]={type:-1==e.j[t]?-1:4*this.j[e.j[t]]+t,x:[4,9,4,-1][t],y:[9,4,-1,4][t]};i>0&&e.items.push({type:128+(a+i)%5*4,x:a*i&7,y:(8-a)*(2+i)&7}),this.i.push(e)}}function t(t){this.c=t,t.on("chooseCharacter",this.A.bind(this))}io=require("sandbox-io"),io.on("connection",function(i){r[i.id]=new t(i),i.emit("cA",n())}),m.prototype={},t.prototype={A:function(t){var i=l[q];this.o=q,this.l=t,this.c.emit("eW",i.i[1]);for(var a=0;a<i.a.length;++a)i.a[a].f&&this.c.emit("n3",a,!0,1,30,i.a[a].x,i.a[a].y);if(i.a[t].f=this,io.to(q).emit("n3",t,!0,i.a[t].b=1,30,i.a[t].x,i.a[t].y),delete r[this.c.id],this.c.on("move",this.B.bind(this)),this.c.on("speak",this.speak.bind(this)),this.c.on("cA",this.w.bind(this)),3==++l[q].v){for(a=0;3>a;++a)t=i.a[a].f,t.c.on("action",t.C.bind(t)),t.c.emit("cy",2,i.a[a].m,0,-1,i.i[1]);q=k()}for(var e in r)r[e].c.emit("cA",n())},B:function(t,i,a){var e=l[this.o];e.a[this.l].x=t,e.a[this.l].y=i;for(var h=0;h<e.a.length;++h)e.a[h].b==e.a[this.l].b&&e.a[h].f.c.emit("pM",this.l,t,i,a)},C:function(t,i,a){if(i=l[this.o],i.a[this.l].h>=[1,1,1,1,1,1,1,1,1,2][t])switch(t){case 0:t=this.l;var e=i.a[t];if(!(11<e.g.length)){--e.h;var h=i.i[e.b],n=h.items[a].type;e.g.push(n),h.items.splice(a,1);for(var s=0;s<i.a.length;++s)s==t?e.f.c.emit("rR",0,0,1,n>>2,h,e.g,e.h):i.a[s].b==e.b&&i.a[s].f.c.emit("n0",t,a,n>>2,h)}break;case 1:case 2:e=this.l,h=i.a[e],--h.h;var n=i.i[h.b],o=n.j[a];if(i.j[o]==6-t)for(i.j[o]+=[0,-1,1][t],s=v(h.b,a),i.i[s].items[2^a].type=(2^a)+4*i.j[o],n.items[a].type=a+4*i.j[o],o=0;o<i.a.length;++o)o==e?h.f.c.emit("rR",t,0,1,a,n,h.g,h.h):i.a[o].b==h.b?i.a[o].f.c.emit("nR",e,t,a,n):i.a[o].b==s&&i.a[o].f.c.emit("nR",e,t,2^a,i.i[s]);break;case 3:for(t=this.l,e=i.a[t],--e.h,h=e.b,e.b=v(e.b,a),e.x=[4,0,4,8][a],e.y=[0,4,8,4][a],n=[],s=0;s<i.a.length;++s){if(o=-1,1==i.a[s].b)for(var r=o=0;r<i.a[s].g.length;++r)var f=i.a[s].g[r],o=o+(128>f?0:[1,2,3,3,5,0,0,0][f>>2&7]);n.push({x:i.a[s].x,y:i.a[s].y,b:i.a[s].b,D:o})}for(s=0;s<i.a.length;++s)s==t?e.f.c.emit("r3",a,i.i[e.b],n,e.h):i.a[s].b==e.b?i.a[s].f.c.emit("n3",t,!0,e.b,2^a,e.x,e.y):i.a[s].b==h&&i.a[s].f.c.emit("n3",t,!1,e.b,a,e.x,e.y);break;case 8:for(t=this.l,e=i.a[t],--e.h,h=i.i[e.b],n=e.g[a],h.items.push({x:e.x+[0,1,0,-1][e.orientation],y:e.y+[-1,0,1,0][e.orientation],type:n}),e.g.splice(a,1),a=0;a<i.a.length;++a)a==t?e.f.c.emit("rR",8,0,2,n>>2,h,e.g,e.h):i.a[a].b==e.b&&i.a[a].f.c.emit("nR",t,8,n>>2,h);break;case 9:for(t=this.l,e=i.a[t],h=i.a[a],e.h-=2,n=[.2,.5,.8][h.m],s=Math.random(),n=n>s?n>2*s?2:1:0,s=-1,n||(h.g.length?(s=h.g.splice(Math.floor(Math.random()*h.g.length))[0],e.g.push(s)):n=3),o=0;o<i.a.length;++o)o==t?e.f.c.emit("rR",9+n,a,1,s>>2,i.i[e.b],e.g,e.h):o==a?i.a[o].f.c.emit("n9",t,n,a,h.g):i.a[o].b==e.b&&i.a[o].f.c.emit("n9",t,n,a,0)}},speak:function(t){io.to(this.o).emit("sp",this.l,t)},w:function(t){l[this.o].a[this.l].s=t,this.c.emit("ac",t)}};var l={},q=k(),r={};u();