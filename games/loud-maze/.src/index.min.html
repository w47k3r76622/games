<style>#c{position:absolute;top:calc(50% - 256px);left:calc(50% - 256px);background-color:#222;box-shadow:0 0 5px #333}p{position:absolute;top:calc(50% + 256px);left:calc(50% - 256px);width:512px;text-align:center;font:16px monospace;color:#eee}body{background-color:#111}@media all and (max-width:512px){#c{width:100vw;height:100vw;top:calc(50% - 50vw);left:0}p{width:100vw;top:calc(50% + 50vw);left:0}}@media all and (max-height:512px){#c{width:100vh;height:100vh;top:0;left:calc(50% - 50vh)}}@media all and (max-width:100vh) and (max-height:512px){#c{width:100vw;height:100vw;top:calc(50% - 50vw);left:0}}@media all and (max-width:512px) and (max-height:100vw){#c{width:100vh;height:100vh;top:0;left:calc(50% - 50vh)}}</style><canvas id=c></canvas><p>hold ESC for help</p><script>const s=c.width=c.height=512,ctx=c.getContext('2d'),[EMPTY,WALL,END,MENU,LOADING,PLAYING,FINISHED,CAN_MOVE,HIT_WALL,HIT_FINISH,NO_INTERACTION]=Array(100).fill().map((a,b)=>b);let highestLevel=+localStorage.highestLevel||0,currentLevel=highestLevel,levelMap,levelSize,levelCellSize=10,levelBaseX,levelBaseY,playerX,playerY,playerMoves,playerWallsHit,playerAlreadyHitWalls,playerBeginTime;const genLevel=()=>{levelSize=2*currentLevel+5,levelCellSize=10>currentLevel?20:(s-40)/levelSize,levelBaseX=levelBaseY=s/2-(levelSize-2)*levelCellSize/2;let a=[[1,1]],b=1,d=['1,1'],f;levelMap=Array(levelSize).fill(()=>Array(levelSize).fill(WALL)).map(h=>h()),levelMap[1][1]=EMPTY;const g=setInterval(()=>{let h=!1,j=a[a.length-1];for(let k=0;100>k;++k){const l=[[-2,0],[2,0],[0,-2],[0,2]].filter(m=>{const n=j[0]+m[0],o=j[1]+m[1];return 0<=n&&0<=o&&n<levelSize&&o<levelSize&&!d.includes([n,o]+'')});if(0<l.length){const m=l[0|Math.random()*l.length],n=j[0]+m[0],o=j[1]+m[1];levelMap[n][o]=levelMap[j[0]+m[0]/2][j[1]+m[1]/2]=EMPTY,j=[n,o],a.push(j),d.push(j+''),a.length>b&&(b=a.length,f=j)}else{if(1===a.length){h=!0;break}a.pop(),j=a[a.length-1]}}h&&(clearInterval(g),levelMap[1][1]=END,[playerX,playerY]=f,playerMoves=0,playerWallsHit=0,playerAlreadyHitWalls=[],playerBeginTime=new Date,setState(PLAYING))},16)},[LEFT,UP,RIGHT,DOWN,NEXT,VOL_UP,VOL_DOWN,HELP]=Array(20).fill().map((a,b)=>b);let keys=[,,,,,].fill(!1),keyCodes=[[37,65,72],[38,87,75],[39,68,76],[40,83,74],[13,32],[77],[78],[27]];const setKey=(a,b)=>{for(let d=0;d<keyCodes.length;++d)if(keyCodes[d].includes(a.keyCode))return keys[d]=b,b?(d===VOL_UP?masterGain.gain.value=Math.min(masterGain.gain.value/.9+.01,1):d===VOL_DOWN&&(masterGain.gain.value=Math.max(.9*masterGain.gain.value-.01,0)),d===HELP&&state!==HELP&&setState(HELP)):d===HELP&&state===HELP&&setState(prevState),a.preventDefault()};window.addEventListener('keydown',a=>setKey(a,!0)),window.addEventListener('keyup',a=>setKey(a,!1));const setKeyFromTouch=(a,b)=>{const d=a.clientX-window.innerWidth/2,f=a.clientY-window.innerHeight/2;let g=!0;d**2+f**2<2500?keys[NEXT]=b:d<f&&d<-f?keys[LEFT]=b:d>f&&d<-f?keys[UP]=b:d>f&&d>-f?keys[RIGHT]=b:d<f&&d>-f?keys[DOWN]=b:g=!1,g&&a.preventDefault()};window.addEventListener('mousedown',a=>setKeyFromTouch(a,!0)),window.addEventListener('mouseup',()=>keys.fill(!1)),window.addEventListener('touchstart',a=>setKeyFromTouch(a.touches[0],!0)),window.addEventListener('touchend',()=>keys.fill(!1));const menuTitle=`
x            x
x  xxx x x xxx
x  x x x x x x
xx xxx xxx xxx
`.trim().split('\n').map(a=>a.split('').map(b=>'x'===b)),titleCellSize=20,titleBaseX=s/2-(menuTitle[0].length-2)*titleCellSize/2,titleBaseY=s/4-menuTitle.length*titleCellSize/2,loadingSizeX=20,loadingSizeY=20,menuLevelTexts=['you are welcome','we understand','there are answers','some things begin','coffee is almost ready','you do you','that\'s nice','time to go'],playingTexts=[['I need to take my time. I don\'t know where I am.','I can\'t see, but I can hear. It feels like a maze.','Someone tipped me about arrow keys a bit back'],['Who knew? I have no clue where I am, but','I am finding it oddly relaxing. I still need to','concentrate. It\'s not as easy as it looks'],['It is slightly unsettling. I didn\'t even notice','my arms are missing. It doesn\'t hurt. What was I','doing before getting here? Who am I?'],['It is as if I was one with myself, finally. I don\'t','feel hungry or thirsty. In fact, I don\'t need','anything from life. Is this how you\'ve always been?'],['I can really push my limits in here. A simple goal,','and it\'s on the top left. Looks like I always need','to take the longest path. This might take a while'],['I\'m going to spend some time going through these.','','I hope you don\'t mind. There\'s no rush here.'],['','...',''],['','I don\'t need answers anymore','']],finishedTexts=['Am I watching myself?','what is this even made of?','What\'s around me?','I like this place','Am I alone?','I don\'t even care','What is anything anyway?','I am no longer lost'];let menuTicksSinceLastInteraction=0,menuTicks=0;const draw3dCell=(a,b,d,f,g,h,j)=>{const k=d-b,l=f-b/2;ctx.fillStyle=g,ctx.fillRect(k-a,l-a,a,a),ctx.fillStyle=h,ctx.beginPath(),ctx.moveTo(k,l),ctx.lineTo(d,f),ctx.lineTo(d-a,f),ctx.lineTo(k-a,l),ctx.fill(),ctx.fillStyle=j,ctx.beginPath(),ctx.moveTo(k,l),ctx.lineTo(d,f),ctx.lineTo(d,f-a),ctx.lineTo(k,l-a),ctx.fill()},printText=(a,b,d,f,g)=>{ctx.font=`${a}px monospace`,ctx.fillText(b,d-(g?ctx.measureText(b).width/2:0),f)};let moveTicksSinceLastInteraction=0;const moveInDirection=(a,b)=>{const d=playerX+2*a,f=playerY+2*b,g=playerX+a,h=playerY+b;switch(++playerMoves,levelMap[g][h]){case WALL:const j=[g,h]+'';return playerAlreadyHitWalls.includes(j)?++playerWallsHit:playerAlreadyHitWalls.push(j),HIT_WALL;}switch(levelMap[d][f]){case EMPTY:return playerX=d,playerY=f,CAN_MOVE;case END:return HIT_FINISH;}},movePlayer=()=>{++moveTicksSinceLastInteraction;let a=NO_INTERACTION;if(10<moveTicksSinceLastInteraction)switch(ctx.beginPath(),ctx.moveTo(s/2,s/2),keys[LEFT]?(a=moveInDirection(-1,0),ctx.lineTo(0,0),ctx.lineTo(0,s)):keys[UP]?(a=moveInDirection(0,-1),ctx.lineTo(0,0),ctx.lineTo(s,0)):keys[RIGHT]?(a=moveInDirection(1,0),ctx.lineTo(s,0),ctx.lineTo(s,s)):keys[DOWN]&&(a=moveInDirection(0,1),ctx.lineTo(s,s),ctx.lineTo(0,s)),a){case NO_INTERACTION:break;case CAN_MOVE:moveTicksSinceLastInteraction=0,ctx.globalAlpha=1,ctx.fillStyle='#eee',ctx.fill(),globalAlphaTick=0,soundPlayMove();break;case HIT_WALL:moveTicksSinceLastInteraction=0,ctx.globalAlpha=1,ctx.fillStyle='#111',ctx.fill(),globalAlphaTick=0,soundPlayHit();break;case HIT_FINISH:moveTicksSinceLastInteraction=0,ctx.globalAlpha=1,ctx.fillStyle='#3e7',ctx.fill(),globalAlphaTick=0,soundPlayFinish();}return a},actx=new AudioContext,masterGain=actx.createGain();masterGain.connect(actx.destination);const getOscGainAndTime=()=>{const a=actx.createOscillator(),b=actx.createGain();return a.connect(b),b.connect(masterGain),[a,b,actx.currentTime]},soundPlayMove=()=>{const[a,b,d]=getOscGainAndTime();a.frequency.value=440,a.frequency.exponentialRampToValueAtTime(550,d+.3),a.type='sine',b.gain.setValueAtTime(.25,d),b.gain.exponentialRampToValueAtTime(.5,d+.1),b.gain.exponentialRampToValueAtTime(.001,d+.3),a.start(d),a.stop(d+.3)},soundPlayHit=()=>{const[a,b,d]=getOscGainAndTime();a.frequency.value=300,a.frequency.exponentialRampToValueAtTime(200,d+.6),a.type='sine',b.gain.setValueAtTime(.5,d),b.gain.exponentialRampToValueAtTime(1,d+.2),b.gain.exponentialRampToValueAtTime(.001,d+.6),a.start(d),a.stop(d+.3)},soundPlayFinish=()=>{const[a,b,d]=getOscGainAndTime();a.frequency.value=440,a.frequency.exponentialRampToValueAtTime(880,d+.3),a.type='sine',b.gain.setValueAtTime(.5,d),b.gain.exponentialRampToValueAtTime(1,d+.2),b.gain.exponentialRampToValueAtTime(.001,d+.6),a.start(d),a.stop(d+.6)};let globalAlphaTick,state,prevState;const setState=a=>{prevState=state,state=a,globalAlphaTick=0},anim=()=>{switch(requestAnimationFrame(anim),state){case HELP:100>globalAlphaTick&&(++globalAlphaTick,ctx.globalAlpha=globalAlphaTick/100),ctx.fillStyle='#333',ctx.fillRect(0,0,s,s),ctx.fillStyle='#eee',printText(30,'HELP',s/2,60,!0),printText(16,'try and navigate the mazes by memory.',10,120),printText(16,'aim for never re-hitting the same wall.',10,150),printText(16,'skip past seeing the layout with space/enter.',10,180),printText(20,'navigate around blind maze',s/2,240,!0),printText(16,'awsd, hjkl, arrows or click/tap away from center',s/2,270,!0),printText(20,'progress or choose level',s/2,330,!0),printText(16,'space, enter, or click/tap around center',s/2,350,!0),printText(20,'- volume +',s/2,410,!0),printText(16,'N and M',s/2,440,!0);break;case MENU:if(100>globalAlphaTick&&(++globalAlphaTick,ctx.globalAlpha=globalAlphaTick/100),ctx.fillStyle='#111',ctx.fillRect(0,0,s,s),++menuTicks,++menuTicksSinceLastInteraction,10<menuTicksSinceLastInteraction){let d=!0;keys[NEXT]||keys[UP]||keys[DOWN]?(setState(LOADING),soundPlayFinish(),genLevel()):keys[LEFT]?0<currentLevel?(--currentLevel,soundPlayMove()):soundPlayHit():keys[RIGHT]?currentLevel<highestLevel?(++currentLevel,soundPlayMove()):soundPlayHit():d=!1,d&&(menuTicksSinceLastInteraction=0)}menuTitle.forEach((d,f)=>d.forEach((g,h)=>{if(g){const j=Math.sin(4*(h+f)+menuTicks/30)*titleCellSize/6+titleCellSize/2;draw3dCell(titleCellSize,j,titleBaseX+h*titleCellSize,titleBaseY+f*titleCellSize,'#eee','#bbb','#888')}})),ctx.fillStyle='#eee',printText(60,currentLevel,s/2,265,!0),printText(20,menuLevelTexts[currentLevel]||`enjoy level ${currentLevel}!`,s/2,320,!0),ctx.fillStyle='#888',printText(16,'@MateiCopot',235,410),printText(16,'/towc.eu',235,440),printText(16,'matei@copot.eu',235,380),ctx.fillStyle='#89e',printText(16,'t',180,410),ctx.fillStyle='#45a',printText(16,'f',180,440),ctx.fillStyle='#a45',printText(16,'m',180,380),ctx.fillStyle=0<currentLevel?'#aaa':'#333',ctx.beginPath(),ctx.moveTo(100,243),ctx.lineTo(120,223),ctx.lineTo(120,263),ctx.fill(),ctx.fillStyle=currentLevel<highestLevel?'#aaa':'#333',ctx.beginPath(),ctx.moveTo(412,243),ctx.lineTo(392,223),ctx.lineTo(392,263),ctx.fill();break;case LOADING:30>globalAlphaTick&&(++globalAlphaTick,ctx.globalAlpha=globalAlphaTick/30),ctx.fillStyle='#eee',ctx.fillRect(0,0,s,s),++menuTicks,levelMap.forEach((d,f)=>d.forEach((g,h)=>{const j=Math.sin(f+h+menuTicks/10)*levelCellSize/6+levelCellSize/2,k=titleBaseX+f*levelCellSize,l=titleBaseY+h*levelCellSize;draw3dCell(levelCellSize,j,k,l,'#eee','#bbb','#888')}));break;case PLAYING:700>globalAlphaTick&&(++globalAlphaTick,ctx.globalAlpha=globalAlphaTick/700),ctx.fillStyle='#888',ctx.fillRect(0,0,s,s),ctx.fillStyle='#f22';let a=new Date-playerBeginTime;printText(100,0|a/1e3,s/2,200,!0),printText(50,playerWallsHit,s/2,320,!0),ctx.fillStyle='#333',printText(20,'seconds',s/2,230,!0),printText(16,'walls re-hit',s/2,350,!0),ctx.fillStyle='#111';const b=playingTexts[currentLevel]||['','',''];switch(printText(16,b[0],s/2,400,!0),printText(16,b[1],s/2,430,!0),printText(16,b[2],s/2,460,!0),movePlayer()){case HIT_FINISH:currentLevel+1>highestLevel&&(highestLevel=currentLevel+1,localStorage.highestLevel=highestLevel),setState(FINISHED);}++menuTicksSinceLastInteraction,keys[NEXT]&&10<menuTicksSinceLastInteraction&&(menuTicksSinceLastInteraction=0,setState(MENU));break;case FINISHED:switch(30>globalAlphaTick&&(++globalAlphaTick,ctx.globalAlpha=globalAlphaTick/30),ctx.fillStyle='#111',ctx.fillRect(0,0,s,s),++menuTicks,levelMap.forEach((d,f)=>d.forEach((g,h)=>{switch(g){case EMPTY:if(playerX===f&&playerY===h){const j=Math.sin(menuTicks/30)*levelCellSize/6+levelCellSize,k=levelBaseX+f*levelCellSize,l=levelBaseY+h*levelCellSize;draw3dCell(1*levelCellSize/2,j,k,l,'#e55','#a33','#822')}break;case WALL:{const j=Math.sin(f+h**2+menuTicks/50)*levelCellSize/6+levelCellSize/4,k=levelBaseX+f*levelCellSize,l=levelBaseY+h*levelCellSize;draw3dCell(levelCellSize,j,k,l,'#eee','#bbb','#888')}break;case END:{const j=Math.sin(menuTicks/30)*levelCellSize/6+levelCellSize,k=levelBaseX+f*levelCellSize,l=levelBaseY+h*levelCellSize;draw3dCell(levelCellSize,j,k,l,'#3e7','#2b5','#183')}}})),ctx.fillStyle='#f22',printText(20,finishedTexts[currentLevel]||'',s/2,460,!0),movePlayer()){case CAN_MOVE:case HIT_WALL:case HIT_FINISH:setState(FINISHED);};keys[NEXT]&&(menuTicksSinceLastInteraction=0,++currentLevel,setState(MENU));}};setState(MENU),anim();const getMusicRound=()=>{const a=0|12*Math.random(),b=actx.createOscillator(),d=actx.createGain(),f=actx.currentTime,g=4*Math.random();b.connect(d),d.connect(masterGain),b.type=.2>Math.random()?'square':'sine',b.frequency.value=220*a,b.frequency.exponentialRampToValueAtTime(440*a+(.2>Math.random()?-220:220),f+g/2),d.gain.setValueAtTime(state===MENU?.1:.005,f),d.gain.exponentialRampToValueAtTime(1e-4,f+g),b.start(f),b.stop(f+g)};setInterval(getMusicRound,200);</script>
