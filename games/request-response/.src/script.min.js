const chars="abcdefghijklmnopqrstuvwxyz";function timeStamp(){return window.performance&&window.performance.now?window.performance.now():Date.now()}function ID(){return"_"+Math.random().toString(36).substr(2,9)}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t))+t}function randomFromArray(t){return t[Math.floor(Math.random()*t.length)]}function numberEnding(t){return 1===t?"":"s"}function humanTime(t){let e=Math.floor(t/1e3),s=Math.floor(e/31536e3);if(s)return s+" year"+numberEnding(s);let i=Math.floor((e%=31536e3)/86400);if(i)return i+" day"+numberEnding(i);let n=Math.floor((e%=86400)/3600);if(n)return n+" hour"+numberEnding(n);let a=Math.floor((e%=3600)/60);if(a)return a+" minute"+numberEnding(a);let r=e%60;return r?r+" second"+numberEnding(r):"less than a second"}function Req(t){this.id=ID(),this.path=t||Req.paths[0],this.at=timeStamp(),this.status="waiting",this.dead=!1,this.collected=!1,this.resAt,this.el}function Game(t){this.el={usersList:document.getElementById(t.ids.usersList),fileList:document.getElementById(t.ids.fileList),stats:{reqs:document.getElementById(t.ids.reqsStats),strikes:document.getElementById(t.ids.strikesStats),points:document.getElementById(t.ids.pointsStats)},buttons:{start:document.getElementById(t.ids.startButton),toMain:document.getElementById(t.ids.toMainButton)},screens:{main:document.getElementById(t.ids.mainScreen),play:document.getElementById(t.ids.playScreen),over:document.getElementById(t.ids.gameOverScreen)},log:document.getElementById(t.ids.log),results:{points:document.getElementById(t.ids.resultsPoints),requests:document.getElementById(t.ids.resultsRequests),time:document.getElementById(t.ids.resultsTime)}},this.activeScreen="main",this.requests=[],this.stats={points:0,reqs:0,strikes:0},this.startedAt,this.lastSpawn,this.lastTime,this.animationId}String.prototype.removeCharAt=function(t){const e=this.split("");return e.splice(t-1,1),e.join("")},String.prototype.insertCharAt=function(t,e){return this.slice(0,t)+e+this.slice(t)},Req.waitTime=7e3,Req.timeToDelete=2500,Req.paths=["","about","contact","gallery","legal","orders","portfolio","products","services","about.html","contact.html","gallery.html","index.html","legal.html","orders.html","portfolio.html","products.html","services.html","profile.html","bonus.php"],Req.prototype={getEffect:function(){return"bonus.php"===this.path&&"random"},setStatus:function(t){this.status=t,"success"!==t&&"error"!==t||(this.el.container.dataset.result=this.status,this.dead=!0)},getPoints:function(){return"waiting"!==this.status&&Math.ceil((Req.waitTime-(this.resAt-this.at))/1e3)},collect:function(t){this.collected=t},fullPath:function(){return""===this.path?"index.html":this.path.split(".")[1]?this.path:this.path+".html"},pathMatch:function(t){return t===(-1===Game.files.indexOf(this.fullPath())?"404.html":this.fullPath())},onDrop:function(t){if(t.preventDefault(),"waiting"!==this.status)return;const e=t.dataTransfer.getData("text/plain");this.resAt=timeStamp(),this.setStatus(this.pathMatch(e)?"success":"error"),t.target.classList.remove("user__dragEnter")},onDragOver:function(t){t.preventDefault(),t.dataTransfer.dropEffect="copy"},onDragEnter:function(t){this.classList.add("user__dragEnter")},onDragLeaveOrEnd:function(t){this.classList.remove("user__dragEnter")},getElementTemplate:function(){const t=document.createElement("li");return t.className="user",t.dataset.userId=this.id,t.innerHTML=`\n      <div class="user-status">\n        <progress class="user-waitBar" value="100" max="100"></progress>\n        <i class="user-resultIcon js-icon"></i>\n      </div>\n      <div class="user-info">\n        <div class="user-req js-req">GET <em>/<span class="js-req-path">${this.path}</span></em></div>\n      </div>\n    `,t.addEventListener("drop",this.onDrop.bind(this)),t.addEventListener("dragover",this.onDragOver),t.addEventListener("dragenter",this.onDragEnter),t.addEventListener("dragleave",this.onDragLeaveOrEnd),t.addEventListener("dragend",this.onDragLeaveOrEnd),t},generateElement:function(t){this.el={},this.el.container=this.getElementTemplate(),this.el.progressBar=this.el.container.querySelector("progress"),this.el.inDOMTree=!0,t.insertBefore(this.el.container,t.firstChild)},remove:function(){this.el.inDOMTree&&(this.el.container.parentElement.removeChild(this.el.container),this.el.inDOMTree=!1)},update:function(t){if("waiting"===this.status){const e=t-this.at;this.el.progressBar.value=100*(Req.waitTime-e)/Req.waitTime,e>Req.waitTime&&(this.resAt=t,this.setStatus("error"))}}},Game.baseSpawnRate=3500,Game.maxStrikes=3,Game.activeScreenClassName="window__active",Game.files=["404.html","about.html","contact.html","gallery.html","index.html","legal.html","portfolio.html","products.html","services.html","bonus.php"],Game.logTemplates={message:t=>t.text,newRequest:t=>`Someone is requesting <em>/${t}</em>`,success:t=>`Correct response: <span class="log-item-good">+${t.points} points</span>.`,error:t=>'Incorrect response: <span class="log-item-bad">+1 strike</span>.',timeout:t=>'Request timeout: <span class="log-item-bad">+1 strike</span>.',bonus:t=>{let e=`BONUS: '${t.name}'.`;return t.points&&(e+=` <span class="log-item-good">${t.points.sign}${t.points.value} points</span>.`),t.strikes&&(e+=` <span class="log-item-bad">${t.strikes.sign}${t.strikes.value} strikes</span>.`),e}},Game.bonus=["extraPoints","deleteStrike","clear"],Game.prototype={applyBonus:function(){switch(randomFromArray(Game.bonus)){case"extraPoints":const t=10;this.updateStats("points",this.stats.points+=t),this.log("bonus",{name:"Extra points",points:{sign:"+",value:t}});break;case"deleteStrike":const e=this.stats.strikes>0?1:0;this.updateStats("strikes",this.stats.strikes-=e),this.log("bonus",{name:"Delete strike",strikes:{sign:"-",value:e}});break;case"clear":this.log("bonus",{name:"Clear all!."}),this.requests.forEach(t=>{t.resAt=this.lastTime,t.status="success",t.dead=!0,t.setStatus("success")})}},getRandomPath:function(){let t=randomFromArray(Req.paths);if(""!==t&&Math.random()<.3){let e=getRandomInt(0,2);for(;e>0&&t.length;)t=t.removeCharAt(getRandomInt(0,t.length-1)),e--;let s=getRandomInt(0,2);for(;s>0;)t=t.insertCharAt(getRandomInt(0,t.length-1),randomFromArray(chars)),s--}return t},spawn:function(){const t=new Req(this.getRandomPath());t.generateElement(this.el.usersList),this.requests.push(t),this.updateStats("reqs",this.stats.reqs+1),this.lastSpawn=this.lastTime,this.log("newRequest",t.path)},isTimeToSpawn:function(){return this.lastTime-this.lastSpawn>=Game.baseSpawnRate-300*Math.floor(this.stats.reqs/10)},getFileElementTemplate:function(t){const e=document.createElement("li");return e.draggable=!0,e.innerHTML=t,e.className="file",e.addEventListener("dragstart",this.onDragStartFile),e},renderFileTree:function(){Game.files.forEach(t=>{this.el.fileList.append(this.getFileElementTemplate(t))})},updateStats:function(t,e){this.stats[t]=e,this.el.stats[t].innerHTML=e},getLogTemplate:function(t,e){const s=document.createElement("p");return s.className="log-item",s.innerHTML=Game.logTemplates[t](e),s},log:function(t,e){for(this.el.log.append(this.getLogTemplate(t,e));this.el.log.childElementCount>10;)this.el.log.removeChild(this.el.log.firstChild);this.el.log.scrollTop=this.el.log.scrollHeight},switchScreens:function(t){this.activeScreen!==t&&(this.el.screens[this.activeScreen].classList.remove(Game.activeScreenClassName),this.el.screens[t].classList.add(Game.activeScreenClassName),this.activeScreen=t)},onDragStartFile:function(t){t.dataTransfer.setData("text/plain",t.target.innerHTML),t.dataTransfer.dropEffect="copy"},listen:function(){this.el.buttons.start.addEventListener("click",function(){this.start()}.bind(this)),this.el.buttons.toMain.addEventListener("click",function(){this.switchScreens("main")}.bind(this))},start:function(){const t=timeStamp();this.startedAt=t,this.log("message",{text:"Server is up and listening for requests."}),this.lastSpawn=t,this.spawn(),this.switchScreens("play")},gameOver:function(){this.el.results.points.innerHTML=this.stats.points,this.el.results.requests.innerHTML=this.stats.reqs,this.el.results.time.innerHTML=humanTime(this.lastTime-this.startedAt),this.switchScreens("over"),this.reset()},reset:function(){this.startedAt=!1,this.lastSpawn=!1,this.requests.length=0,this.stats={points:0,reqs:0,strikes:0},this.el.usersList.innerHTML="",this.el.log.innerHTML=""},update:function(t){this.isTimeToSpawn()&&this.spawn();for(let t=this.requests.length-1;t>=0;t--){const e=this.requests[t];if(e.update(this.lastTime),e.dead&&!e.collected){if("error"===e.status){this.updateStats("strikes",this.stats.strikes+1);let t=e.resAt-e.at>=Req.waitTime?"timeout":"error";if(this.log(t,{strikes:this.stats.strikes}),this.stats.strikes>=Game.maxStrikes)return void this.gameOver()}else if("success"===e.status){const t=e.getPoints();this.updateStats("points",this.stats.points+t),this.log("success",{points:t}),e.getEffect()&&this.applyBonus()}e.collect(this.lastTime)}else e.dead&&this.lastTime-e.collected>=Req.timeToDelete&&(e.remove(),this.requests.splice(t,1))}},loop:function(){const t=timeStamp();let e=t-this.lastTime;e>999?e=1/60:e/=1e3,this.lastTime=t,this.startedAt&&this.update(e),this.animationId=window.requestAnimationFrame(this.loop.bind(this))},init:function(){this.listen(),this.el.buttons.start.disabled=!1,this.renderFileTree(),this.lastTime=timeStamp(),this.loop()}};const elementsIds={startButton:"start-button",toMainButton:"return-to-main-button",mainScreen:"main-screen",playScreen:"play-screen",gameOverScreen:"gameover-screen",reqsStats:"stats-reqs",strikesStats:"stats-strikes",pointsStats:"stats-points",fileList:"files",usersList:"users",log:"log",resultsPoints:"results-points",resultsRequests:"results-requests",resultsTime:"results-time"};document.addEventListener("DOMContentLoaded",(function(t){new Game({ids:elementsIds}).init()}));