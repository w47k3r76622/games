const cvs=document.getElementById("cvs"),ctx=cvs.getContext("2d");let cvsPos=gprtc(cvs),mouseX=0,mouseY=0;const blu="#6a6aff",grn="#bad500",red="#ff6a6a",rrr="#ff0000",gry="#6a6a6a";let tick=0,score=0,rndScr=0,isColNow=!1;const tup=33;let hasSound=!1;const info=document.getElementById("info"),go=document.getElementById("go"),goSound=document.getElementById("go-sound"),roundInfo=document.getElementById("round-info"),lastHighScore=localStorage.getItem("parryHighScore")||0;class Sword{constructor({pos:t={x:0,y:0},color:e=gry,colCol:n=red,width:o=10,height:s=100,ra:r=0,isCol:a=!1,tsCol:i=0,tsOS:l=0,id:c=tick,sliced:h=!1}){this.pos=t,this.color=e,this.colCol=n,this.width=o,this.height=s,this.ra=r,this.isCol=a,this.tsCol=i,this.tsOS=l,this.id=c,this.sliced=h}draw(){ctx.beginPath(),this.id<50?ctx.fillStyle=isColNow?this.drawGrad(this.tsCol*(100/33)/100):this.color:(this.slicing&&(this.color=rrr),this.sliced||(ctx.fillStyle=this.drawGrad(this.tsOS*(100/this.tus)/100)));const t=this.pos.x,e=this.pos.y;ctx.moveTo(t-5,e),ctx.lineTo(t-5,e-this.height),ctx.lineTo(t,e-this.height-10),ctx.lineTo(t+5,e-this.height),ctx.lineTo(t+5,e),ctx.lineTo(t-5,e),ctx.fill()}drawRot(){ctx.save(),ctx.translate(this.pos.x,this.pos.y),ctx.rotate(this.ra*Math.PI/180),ctx.translate(-this.pos.x,-this.pos.y),this.draw(),ctx.restore()}drawGrad(t){let e=t>1?1:t;const n=ctx.createLinearGradient(this.pos.x-this.width/2,this.pos.y,this.pos.x+this.width/2,this.pos.y-this.height-10);return n.addColorStop(0,this.color),n.addColorStop(e,this.color),n.addColorStop(e,this.colCol),n.addColorStop(1,this.colCol),n}}class PlayerSword extends Sword{constructor(){super({pos:{x:mouseX,y:mouseY},color:blu,colCol:grn})}csr(){ksfpsr.q&&this.ra>=-81&&(this.ra-=9),ksfpsr.e&&this.ra<=81&&(this.ra+=9),this.drawRot()}dTSCol(){this.isCol&&this.tsCol++}}const ps=new PlayerSword;let ksfpsr={q:!1,e:!1};document.addEventListener("keydown",(t=>{"q"===t.key?ksfpsr.q=!0:"e"===t.key&&(ksfpsr.e=!0)})),document.addEventListener("keyup",(t=>{"q"===t.key?ksfpsr.q=!1:"e"===t.key&&(ksfpsr.e=!1)}));class EnemySword extends Sword{constructor(t=!1,e=!1,n=75){super({color:red,colCol:gry}),this.parried=t,this.slicing=e,this.tus=n}handleSlice(){this.tsOS>=this.tus&&(this.slicing=!0,tick%50==0&&(changeScore(90,!1),this.slicing=!1,this.sliced=!0,hasSound&&zzfx(...[,,1e3,.02,.1,.12,1,1.78,-9.5,.2,,,,.1,,,,.47,.02,.06])))}handleParry(){if(this.tsCol>=33){changeScore(calcPts(this.ra,ps.ra),!0),this.parried=!0,isColNow=!1,hasSound&&zzfx(...[,,1300,.02,.1,.12,1,1.78,-9.5,.2,,,,.1,,,,.47,.02,.06])}this.isCol?(this.tsCol++,isColNow=!0):(this.tsOS++,this.tsCol>0&&this.tsCol--)}}let lastCI,enemyState=-1,gameState=!1,numEs=0;function goInfo(){if(enemyState>-1&&(goSound.style.display="none"),roundInfo.style.display="flex",stopGameLoop(),enemyState>-1){let t=ENEMIES[enemyState].numAtt;document.getElementById("rating").textContent=determineRoundRating(t),document.getElementById("score-percent").textContent=Math.max(Math.round(rndScr/(100*t)*100),0),document.getElementById("your-score").textContent=rndScr,document.getElementById("possible-score").textContent=100*t}else roundInfo.style.display="none";enemyState+=1,info.style.display="flex",enemyState===ENEMIES.length?(document.getElementById("last-info").style.display="flex",document.getElementById("enemy-info").style.display="none",updateLocalStorage()):(document.getElementById("next-enemy").textContent=ENEMIES[enemyState].name,go.textContent=ENEMIES[enemyState].button)}function stopGameLoop(){cancelAnimationFrame(reqId),gameState=!1}function updateLocalStorage(){score>lastHighScore&&(localStorage.setItem("parryHighScore",score),document.getElementById("new-high-score").style.display="block"),document.getElementById("high-score").textContent=localStorage.getItem("parryHighScore")}function determineRoundRating(t){const e=["Parrylously bad.","Perrible...","Not up to par(ry).","Not parryticularly notable.","Somewhat imparryssive...","Parretty good...","Parry good!","Extraordinparry!","Legendparry!"];for(let n=1;n<=e.length;n++)if(rndScr<=100*t*(n/e.length))return e[n-1]}function goGame(){rndScr=0,numEs=0,actSw.length=0,actSw.push(ps),info.style.display="none",gameState=!0,reqId=requestAnimationFrame(gameLoop)}function peasant(){numEs<5?pshSw(250,100,600,100,400,Math.random()>.5?0:90):numEs<10?pshSw(100,100,600,100,400,ranInt(0,359)):goNext(375)}function bpal(){const t=1==enemyState?1:0,e=numEs%4*150+100;let n=t?90:ranInt(0,359);numEs<16?(numEs<4?y=110:numEs<8?(y=220,n=t?0:n):numEs<12?y=330:numEs<16&&(y=440,n=t?0:ranInt(-100,100)),pshSw(50,e,e,y,y,n)):goNext()}function duelist(){const t=[100,225,350,475];let e;numEs<16?(numEs<4?e=150:numEs<8?e=600:numEs<12?e=300:numEs<16&&(e=500),pshSw(50,numEs%2==0?e:e-45,numEs%2==0?e:e-45,t[numEs%4],t[numEs%4],numEs%2==0?-45:45)):goNext(700)}function archer(){const t=[{x:25,y:100,a:45},{x:675,y:100,a:-45},{x:100,y:475,a:-45},{x:600,y:475,a:45}];let e,n;if(numEs<10)tick%75==0&&(n=ranInt(0,3),n===lastCI&&(n=lastCI===t.length-1?0:lastCI+1),e=t[n],lastCI=n,pshSw(1,e.x,e.x,e.y,e.y,e.a));else if(numEs<26){if(tick%150==0){let e=ranInt(0,3),n=ranInt(0,3);for(;e===n;)n=ranInt(0,3);pshSw(1,t[e].x,t[e].x,t[e].y,t[e].y,t[e].a,125),pshSw(1,t[n].x,t[n].x,t[n].y,t[n].y,t[n].a,125,!1)}}else goNext(666)}function dualWielder(){if(numEs<32){const t=ranInt(75,600),e=ranInt(100,475),n=[{a:0,x2a:30,y2a:0},{a:90,x2a:0,y2a:-30},{a:45,x2a:20,y2a:20}],o=Math.floor(Math.random()*n.length);let s=t+n[o].x2a,r=e+n[o].y2a;pshSw(75,t,t,e,e,n[o].a,37),pshSw(75,s,s,r,r,n[o].a,37,!1)}else goNext(400)}function goNext(t=200){tick%t==0&&goInfo()}go.onclick=()=>{gameState<ENEMIES.length-1&&goGame()},goSound.onclick=()=>{goGame(),zzfxX=new AudioContext,hasSound=!0};const ENEMIES=[{name:"Peasant",button:"Start (without sound)",fx:peasant,numAtt:10},{name:"Barbarian",button:"I'm barbarian to it",fx:bpal,numAtt:16},{name:"Paladin",button:"I'm paladin to it",fx:bpal,numAtt:16},{name:"Archer",button:"Ready, set, bow",fx:archer,numAtt:26},{name:"Duelist",button:"Let's duel it",fx:duelist,numAtt:16},{name:"Dual Wielder",button:"Let's dual it",fx:dualWielder,numAtt:32}];function pshSw(t,e,n,o,s,r,a=75,i=!0){if(tick%t==0){const t=new EnemySword;t.pos=getRanLoc(e,n,o,s),t.ra=r,t.tus=a,actSw.push(t),hasSound&&i&&zzfx(...[,,90,.02,.06,.07,1,.13,,,,,,.2,,.3,,.91,.08,.15]),numEs++}}function rch(t,e,n,o,s){s=s*Math.PI/180;let r=n-t,a=o-e,i=Math.sqrt(r*r+a*a),l=Math.atan2(a,r);return{x:t+i*Math.cos(l+s),y:e+i*Math.sin(l+s)}}function getRc(t){let e=t.pos.x+t.width/2,n=t.pos.y+t.height;return{tL:rch(e,n,t.pos.x,t.pos.y,t.ra),tR:rch(e,n,t.pos.x+t.width,t.pos.y,t.ra),bL:rch(e,n,t.pos.x,t.pos.y+t.height,t.ra),bR:rch(e,n,t.pos.x+t.width/2,t.pos.y+t.height,t.ra)}}function xy(t,e){this.x=t,this.y=e}function polygon(t,e){this.vertex=t,this.edge=e}function isCol(t,e){let n=null,o=0,s=[],r=null,a=null,i=null,l=null;for(let e=0;e<t.edge.length;e++)n=new xy(-t.edge[e].y,t.edge[e].x),s.push(n);for(let t=0;t<e.edge.length;t++)n=new xy(-e.edge[t].y,e.edge[t].x),s.push(n);for(let n=0;n<s.length;n++){r=null,a=null,i=null,l=null;for(let e=0;e<t.vertex.length;e++)o=t.vertex[e].x*s[n].x+t.vertex[e].y*s[n].y,(null===a||o>a)&&(a=o),(null===r||o<r)&&(r=o);for(let t=0;t<e.vertex.length;t++)o=e.vertex[t].x*s[n].x+e.vertex[t].y*s[n].y,(null===l||o>l)&&(l=o),(null===i||o<i)&&(i=o);if(!(r<l&&r>i||i<a&&i>r))return!1}return!0}function detectCol(t){if(0===t)return;const e=actSw[t];if(e.slicing)return;const n=actSw[0];let o=getRc(e),s=getRc(n),r=[new xy(o.tR.x,o.tR.y),new xy(o.bR.x,o.bR.y),new xy(o.bL.x,o.bL.y),new xy(o.tL.x,o.tL.y)],a=[new xy(o.bR.x-o.tR.x,o.bR.y-o.tR.y),new xy(o.bL.x-o.bR.x,o.bL.y-o.bR.y),new xy(o.tL.x-o.bL.x,o.tL.y-o.bL.y),new xy(o.tR.x-o.tL.x,o.tR.y-o.tL.y)],i=[new xy(s.tR.x,s.tR.y),new xy(s.bR.x,s.bR.y),new xy(s.bL.x,s.bL.y),new xy(s.tL.x,s.tL.y)],l=[new xy(s.bR.x-s.tR.x,s.bR.y-s.tR.y),new xy(s.bL.x-s.bR.x,s.bL.y-s.bR.y),new xy(s.tL.x-s.bL.x,s.tL.y-s.bL.y),new xy(s.tR.x-s.tL.x,s.tR.y-s.tL.y)];isCol(new polygon(r,a),new polygon(i,l))?(e.isCol=!0,n.isCol=!0,n.tsCol=e.tsCol):(e.isCol=!1,n.isCol=!1,0===e.ra&&0===n.ra&&(e.pos.x>n.pos.x+n.width||e.pos.x+e.width<n.pos.x||e.pos.y>n.pos.y+n.height||e.pos.y+e.height<n.pos.y||(e.color=red)))}function gprtc(t){let e=0,n=0;for(;t;)e+=t.offsetLeft-t.scrollLeft+t.clientLeft,n+=t.offsetTop-t.scrollTop+t.clientTop,t=t.offsetParent;return{x:e,y:n}}function setPos(t){mouseX=t.clientX-cvsPos.x,mouseY=t.clientY-cvsPos.y,ps.pos.x=mouseX,ps.pos.y=mouseY}function ranInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function getRanLoc(t,e,n,o){return{x:Math.random()*(e-t+1)+t,y:Math.random()*(o-n+1)+n}}function calcPts(t,e){const n=Math.abs(((t-e+180)%360+360)%360-180),o=Math.round(100-Math.abs(90-n)/90*100);return Math.max(0,Math.min(100,o))}function changeScore(t,e){e?(score+=t,rndScr+=t):(score-=t,rndScr-=t),document.getElementById("score").textContent=score}cvs.addEventListener("mousemove",setPos),zzfxV=.3,zzfx=(t=1,e=.05,n=220,o=0,s=0,r=.1,a=0,i=1,l=0,c=0,h=0,d=0,u=0,y=0,x=0,m=0,g=0,p=1,f=0,S=0,w=Math,E=44100,C=2*w.PI,I=(l*=500*C/E/E),b=(n*=(1-e+2*e*w.random(e=[]))*C/E),L=0,R=0,M=0,k=1,v=0,P=0,z=0,N,B)=>{for(c*=500*C/E**3,x*=C/E,h*=C/E,d*=E,u=E*u|0,B=(o=E*o+9)+(f*=E)+(s*=E)+(r*=E)+(g*=E)|0;M<B;e[M++]=z)++P%(100*m|0)||(z=a?1<a?2<a?3<a?w.sin((L%C)**3):w.max(w.min(w.tan(L),1),-1):1-(2*L/C%2+2)%2:1-4*w.abs(w.round(L/C)-L/C):w.sin(L),z=(u?1-S+S*w.sin(C*M/u):1)*(0<z?1:-1)*w.abs(z)**i*zzfxV*t*(M<o?M/o:M<o+f?1-(M-o)/f*(1-p):M<o+f+s?p:M<B-g?(B-M-g)/r*p:0),z=g?z/2+(g>M?0:(M<B-g?1:(B-M)/g)*e[M-g|0]/2):z),L+=(N=(n+=l+=c)*w.cos(x*R++))-N*y*(1-1e9*(w.sin(M)+1)%2),k&&++k>d&&(n+=h,b+=h,k=0),!u||++v%u||(n=b,l=I,k||1);return(t=zzfxX.createBuffer(1,B,E)).getChannelData(0).set(e),(n=zzfxX.createBufferSource()).buffer=t,n.connect(zzfxX.destination),n.start(),n};const actSw=[ps];let reqId;function gameLoop(){gameState&&(tick++,ctx.clearRect(0,0,cvs.width,cvs.height),ps.csr(),ps.dTSCol(),actSw.forEach(((t,e)=>{0===e||t.parried||t.sliced||(detectCol(e),t.drawRot(),t.handleParry(),t.handleSlice())})),ENEMIES[enemyState].fx(),reqId=requestAnimationFrame(gameLoop))}actSw.forEach(((t,e)=>{detectCol(e)})),goInfo();
