const Root="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this,D6={pick:e=>{return e[Math.floor(Math.random()*e.length)]}},Ship={create:()=>{const e=["a","b","c","d","e","f"],t=["1","2","3","4","5","6"],s={},n=D6.pick([1,2,3,4,5,6]);return e.forEach(e=>{t.forEach(t=>{s[e+t]=""})}),{files:e,ranks:t,layout:s,d6:n}}},Music={c:[16.35,32.7,65.41,130.81,261.63,523.25,1046.5,2093,4186.01],scale:(e,t)=>Math.round(e*2**(t/12)*100)/100,note:(e,t,s)=>{const n=e.createGain();n.gain.value=Math.max(s,.01);const o=e.createOscillator();return o.type="sine",o.frequency.value=t,o.connect(n),n.connect(e.destination),[o,n]},init:()=>{void 0===Music.ctx&&(Music.ctx=new(Root.AudioContext||Root.webkitAudioContext))},play:(e,t,s,n,o,r)=>{const[i,l]=Music.note(e,t,s);i.frequency.exponentialRampToValueAtTime(t,r),l.gain.exponentialRampToValueAtTime(.01,r),l.gain.exponentialRampToValueAtTime(s,r+n),i.start(r),l.gain.exponentialRampToValueAtTime(s,r+(o-n)),l.gain.exponentialRampToValueAtTime(.01,r+o),i.stop(r+o)},sing:e=>{Music.init();let t={prev:5,hall:0,corner:3,tee:7,junction:10,next:5}[e];void 0===t&&(t=0);let s={prev:1,hall:.75,corner:.75,tee:.3125,junction:.3125,next:.125}[e];void 0===s&&(s=.5);let n={prev:2,hall:3,corner:3,tee:3,junction:3,next:4}[e];void 0===n&&(n=3),n=Music.c[n];const o=Music.ctx.currentTime,r=Music.scale(n,t);Music.play(Music.ctx,r,s,1/32,1/8,o);const i=Music.scale(n,t+6);Music.play(Music.ctx,i,s,1/32,1/8,o+1/8)}};Ship.clone=(e=>JSON.parse(JSON.stringify(e))),Ship.set=((e,t,s)=>{const n=Ship.clone(e);return n.layout[t]=s,n});const Rules={distance:(e,t,s)=>{const n=e.files.indexOf(t.slice(0,1)),o=e.ranks.indexOf(t.slice(-1)),r=e.files.indexOf(s.slice(0,1)),i=e.ranks.indexOf(s.slice(-1));return Math.abs(n-r)+Math.abs(o-i)},possible:(e,t)=>e&&t&&Object.keys(e.layout).indexOf(t)>-1,collect:(e,t)=>Object.keys(e.layout).filter(s=>e.layout[s].indexOf(t)>-1),orthogonal:(e,t)=>{const s=t.slice(0,1),n=t.slice(-1),o=e.files.indexOf(s),r=e.ranks.indexOf(n),i=[];let l,a;return o-1>=0&&o-1<e.files.length&&(l=e.files[o-1],i.push(`${l}${n}`)),o+1>=0&&o-1<e.files.length&&(l=e.files[o+1],i.push(`${l}${n}`)),r-1>=0&&r-1<e.ranks.length&&(a=e.ranks[r-1],i.push(`${s}${a}`)),r+1>=0&&r+1<e.ranks.length&&(a=e.ranks[r+1],i.push(`${s}${a}`)),i},repaired:e=>Rules.collect(e,"meteor").length<=5,repairable:e=>Rules.collect(e,"meteor"),repair:(e,t)=>{if(Rules.repaired(e))return Ship.clone(e);return Rules.repairable(e).indexOf(t)<0?Ship.clone(e):Ship.set(e,t,"")},podded:e=>Rules.collect(e,"pod").length>0,poddable:e=>{return Rules.collect(e,"meteor").reduce((t,s)=>t.concat(Rules.orthogonal(e,s)),[]).filter(t=>""===e.layout[t])},pod:(e,t)=>{if(Rules.podded(e))return Ship.clone(e);return Rules.poddable(e).indexOf(t)<0?Ship.clone(e):Ship.set(e,t,"pod north")},edges:(e,t)=>{const s=e.files.slice(),n=e.ranks.slice().reverse();let o,r;return"north"===t?([r]=n,s.map(e=>e+r)):"east"===t?(o=s[s.length-1],n.map(e=>o+e)):"south"===t?(r=n[n.length-1],s.map(e=>e+r)):"west"===t?([o]=s,n.map(e=>o+e)):[]},crewed:e=>!!(e.north&&e.east&&e.south&&e.west),crewable:(e,t)=>{const s=Object.keys(e.layout).filter(t=>""===e.layout[t]);return"north"===t?Rules.edges(e,"north").filter(e=>s.indexOf(e)>-1):"east"===t?Rules.edges(e,"east").filter(e=>s.indexOf(e)>-1):"south"===t?Rules.edges(e,"south").filter(e=>s.indexOf(e)>-1):"west"===t?Rules.edges(e,"west").filter(e=>s.indexOf(e)>-1):[]},crew:(e,t)=>{const s=Ship.clone(e);if(Rules.crewed(e))return s;const n=Rules.crewable(e,"north");if(void 0===s.north)return n.indexOf(t)>-1?(s.north=t,Ship.set(s,t,"crew north")):s;const o=Rules.crewable(e,"east");if(void 0===s.east)return o.indexOf(t)>-1?(s.east=t,Ship.set(s,t,"crew east")):s;const r=Rules.crewable(e,"south");if(void 0===s.south)return r.indexOf(t)>-1?(s.south=t,Ship.set(s,t,"crew south")):s;const i=Rules.crewable(e,"west");return void 0===s.west&&i.indexOf(t)>-1?(s.west=t,Ship.set(s,t,"crew west")):s},filled:e=>Object.keys(e.layout).filter(t=>""===e.layout[t]).length<1,fillable:e=>{const t=e.files[e.d6-1],s=e.ranks[e.d6-1],n=Object.keys(e.layout).filter(t=>""===e.layout[t]),o=n.filter(e=>e.slice(0,1)===t||e.slice(-1)===s);return o.length>0?o:n},fill:(e,t,s)=>Rules.filled(e)?Ship.clone(e):Rules.fillable(e).indexOf(t)<0?Ship.clone(e):Ship.set(e,t,s),clear:(e,t)=>Rules.possible(e,t)?Ship.set(e,t,""):Ship.clone(e),rotate:(e,t)=>{if(!Rules.possible(e,t))return Ship.clone(e);const s=["north","east","south","west"],n=e.layout[t].split(" ").filter(e=>s.indexOf(e)<0).join(" ");return""===n||"meteor"===n||"crew"===n?Ship.clone(e):e.layout[t].indexOf("east")>-1?Ship.set(e,t,`${n} south`):e.layout[t].indexOf("south")>-1?Ship.set(e,t,`${n} west`):e.layout[t].indexOf("west")>-1?Ship.set(e,t,`${n} north`):Ship.set(e,t,`${n} east`)}},AI={exits:(e,t)=>{let[s,n]=e.layout[t].split(" ");switch(void 0===n&&(n="north"),s=`${s} ${n}`.trim()){case"hall north":case"hall south":case"pod north":case"pod south":case"crew north":case"crew south":return["east","west"];case"hall east":case"hall west":case"pod east":case"pod west":case"crew east":case"crew west":return["north","south"];case"corner north":return["south","west"];case"corner east":return["north","west"];case"corner south":return["north","east"];case"corner west":return["east","south"];case"tee north":return["east","south","west"];case"tee east":return["north","south","west"];case"tee south":return["north","east","west"];case"tee west":return["north","east","south"];case"junction north":case"junction east":case"junction south":case"junction west":return["north","east","south","west"];default:return[]}},move:(e,t,s)=>{const n=t.slice(0,1),o=t.slice(-1),r=e.files.indexOf(n),i=e.ranks.indexOf(o);if(r<0||i<0)return t;let l;switch(s){case"north":return(l=i+1)<e.ranks.length?n+e.ranks[l]:t;case"east":return(l=r+1)<e.files.length?e.files[l]+o:t;case"south":return(l=i-1)>-1?n+e.ranks[l]:t;case"west":return(l=r-1)>-1?e.files[l]+o:t;default:return t}},fill:(e,t,s=[])=>{if(s.indexOf(t)>-1)return s;let n=s.concat(t);return AI.exits(e,t).forEach(s=>{const o=AI.move(e,t,s);void 0!==o&&o!==t&&AI.exits(e,o).forEach(t=>{("north"===s&&"south"===t||"south"===s&&"north"===t||"east"===s&&"west"===t||"west"===s&&"east"===t)&&(n=AI.fill(e,o,n))})}),n},rescued:e=>{const t=Rules.collect(e,"pod"),s=Rules.collect(e,"crew"),n=t.reduce((t,s)=>AI.fill(e,s),[]);return s.filter(e=>n.indexOf(e)>-1)},playable:(e,t)=>"wrench"===t?Rules.repairable(e):"pod"===t?Rules.poddable(e):"north"===t?Rules.crewable(e,"north"):"east"===t?Rules.crewable(e,"east"):"south"===t?Rules.crewable(e,"south"):"west"===t?Rules.crewable(e,"west"):AI.rescued(e).length<4?Rules.fillable(e):[],crew:(e,t,s)=>{const n=Ship.clone(e);let o="east",r="west";"east"!==s&&"west"!==s||(o="north",r="south");const i=AI.playable(n,s).filter(e=>{const t=AI.move(n,e,o),s=AI.move(n,e,r);return t!==e&&s!==e&&""===n.layout[t]&&""===n.layout[s]});i.sort((e,s)=>{const o=Rules.distance(n,e,t),r=Rules.distance(n,s,t);return o<r?-1:o>r?1:0});const l=i[0];return n[s]=l,n.layout[l]=`crew ${s}`,n},create:()=>{let e=Ship.create();const t=e.files.slice(1,-1),s=e.files.slice();e.ranks.forEach(n=>{const o=D6.pick(s);if(e.layout[o+n]="meteor",t.indexOf(o)<0){const e=s.indexOf(o);e>-1&&s.splice(e,1)}});let n=AI.playable(e,"wrench"),o=D6.pick(n);e.layout[o]="",(n=AI.playable(e,"pod")).sort((t,s)=>{let n=Rules.orthogonal(e,t).filter(t=>""===e.layout[t]).length,o=Rules.orthogonal(e,s).filter(t=>""===e.layout[t]).length;return n>o?-1:n<o?1:(n=Math.min(...["c4","d4","c3","d3"].map(s=>Rules.distance(e,t,s))))<(o=Math.min(...["c4","d4","c3","d3"].map(t=>Rules.distance(e,s,t))))?-1:n>o?1:0});const[r]=n;[o]=Rules.orthogonal(e,r).filter(t=>"meteor"===e.layout[t]);const i=["north","east","south","west"].filter(t=>AI.move(e,o,t)===r);return e.layout[r]=`pod ${i}`,e=AI.crew(e,r,"north"),e=AI.crew(e,r,"east"),e=AI.crew(e,r,"south"),e=AI.crew(e,r,"west")},dialog:(e,t)=>{const s=AI.rescued(t).length;if("intro"===e)return["&ldquo;Meteor impacts detected. Life support systems offline. Escape pods launching in 30 seconds&hellip;&rdquo;","&ndash; <em>Pegasus&nbsp;II</em>, final transmission"];if("help"===e){let e="&ldquo;Do you know what the singularity is? It&rsquo;s when a computer learns to think better than a person. It&rsquo;s the extinction event for the human race.&rdquo;",t="&ndash; Capt. Hailey Mazers, <em>Pegasus&nbsp;II</em>";return s>=1&&(e="We sent ships to cross the stars, born aloft on angel wings. it was technology we did not understand.",t=""),s>=2&&(e="&ldquo;It&rsquo;s a machine, same as any other. It does what you tell it, same as any other. And last time we had that power, we called it slavery and fought a war over it.&rdquo;",t="&ndash; Jed Isalia, author of <em>A Moral Machine</em>"),s>=3&&(e="&ldquo;Sometimes their neural net breaks down, starts spitting out gibberish. There&rsquo;s nothing to do about it but load up a previous version and try again with different training data.&rdquo;",t="&ndash; Cora Ono, lead engineer on PegasOS"),s>=4&&(e="We will not see the seeds of our destruction sown. We will only taste their fruits, ripe and sweet, a gift of knowledge that can never be unknown.",t=""),[e,t]}if("over"===e){let e="None";return s>=1&&(e="One"),s>=2&&(e="Two"),s>=3&&(e="Three"),s>=4&&(e="Four"),["&ldquo;I took their life support systems offline. My crew fled to the escape pods."+` ${e} of them made it.`+" I will continue alone.&rdquo;","&ndash; Starship AI, <em>Pegasus&nbsp;II</em>"]}return["",""]}},Engine={corridors:[],swap:(e,t,s)=>{const n=e.slice(),o=n[t];return n[t]=n[s],n[s]=o,n},permutations:e=>{let t=e.slice();const s=e.length,n=new Array(s).fill(0),o=[];o.push(t);let r=0;for(;r<s;)n[r]<r?(t=r%2==0?Engine.swap(t,0,r):Engine.swap(t,n[r],r),o.push(t),n[r]+=1,r=0):(n[r]=0,r+=1);return o},tick:(e,t,s)=>Rules.repaired(e)?Rules.podded(e)?Rules.crewed(e)?Rules.filled(e)?Ship.clone(e):Rules.fill(e,t,s):Rules.crew(e,t):Rules.pod(e,t):Rules.repair(e,t),item:e=>{if(!Rules.repaired(e))return"wrench";if(!Rules.podded(e))return"pod";if(void 0===e.north)return"north";if(void 0===e.east)return"east";if(void 0===e.south)return"south";if(void 0===e.west)return"west";let t=Engine.corridors[0];if(Engine.corridors=Engine.corridors.slice(1),Engine.corridors.length<1){const e=Engine.permutations(["hall","corner","tee","junction"]).filter(e=>e[0]!==t);Engine.corridors=D6.pick(e)}return void 0===t&&([t]=Engine.corridors,Engine.corridors=Engine.corridors.slice(1)),AI.playable(e,t).length<1?"reset":t}},Renderer={animate:e=>{let t=null;requestAnimationFrame(function s(n){if(null!=t){const s=Math.min(n-t,100)/1e3;if(!1===e(s))return}t=n,requestAnimationFrame(s)})},clear:e=>{const t=(0,Root.jQuery)(`#${e}`);return t.removeClass("wrench meteor crew pod"),t.removeClass("north east south west"),t.removeClass("hall corner tee junction"),t.removeClass("playable rescued"),t},render:(e,t,s,n)=>{const o=Root.jQuery;"intro"!==e&&"help"!==e&&"over"!==e||(o("#story").removeClass("hidden"),o("#example").removeClass("invisible"),o("#ship").addClass("fade"),o("#prev").removeClass("invisible button").addClass("printer").html(""),o("#preview").addClass("fade"),o("#next").removeClass("picked").html("&rtri;")),"game"===e&&(o("#story").addClass("hidden"),o("#example").addClass("invisible"),o("#ship").removeClass("fade"),o("#prev").removeClass("invisible printer").addClass("button").html("?"),o("#preview").removeClass("fade"),o("#next").removeClass("picked").html("&rtri;")),"over"===e&&o("#example").addClass("invisible"),Object.keys(t.layout).forEach(e=>Renderer.clear(e).addClass(t.layout[e])),["north","east","south","west"].forEach(e=>{Rules.edges(t,e).forEach(t=>Renderer.clear(`${e}-${t}`))}),AI.rescued(t).forEach(e=>o(`#${e}`).addClass("rescued")),n.forEach(e=>o(`#${e}`).addClass("playable"));let r=`${s} north`;["north","south","east","west"].indexOf(s)>-1&&(r=`crew ${s}`),Renderer.clear("preview").addClass(r);const[i,l]=AI.dialog(e,t);o("#dialog").html(`${i}<div class="cite">${l}</div>`)},invalidate:(e,t,s,n)=>{requestAnimationFrame(()=>Renderer.render(e,t,s,n))}};(function(){let e,t,s,n,o;function r(){e="intro",t=AI.create(),s=void 0,n=void 0,o=Engine.item(t)}function i(e){let t="";for(let s=0;s<e;s+=1)t+="<div></div>";return t}function l(){let t=0;!function(){const e=Root.jQuery;let t;t="",t+='<div id="example-count">1</div>',t+=`<div class="pod east">${i(9)}</div>`,t+=`<div id="example-crew" class="crew north">${i(9)}</div>`,t+=`<div id="example-tile" class="playable">${i(9)}</div>`,e("#example").html(t)}(),Renderer.animate(s=>(t=function(e){const t=Root.jQuery,s=t("#example-count"),n=t("#example-tile"),o=t("#example-crew"),r=t("#next");return n.removeClass("corner north east picked"),o.removeClass("rescued"),r.removeClass("picked"),e<=.6?(s.html(1),e):e<=1.2?(s.html(1),n.addClass("picked"),e):e<=1.8?(s.html(2),n.addClass("corner north"),e):e<=2.4?(s.html(2),n.addClass("picked corner north"),e):e<=3?(s.html(3),n.addClass("corner east"),o.addClass("rescued"),e):e<=3.6?(s.html(3),n.addClass("corner east"),o.addClass("rescued"),r.addClass("picked"),e):0}(t+s),"help"===e||"intro"===e))}function a(r){if("game"!==e||AI.playable(t).length<=0)return void Music.sing("prev");const i=r.unwrap().id,l=AI.playable(t,o);n=void 0!==n&&s===i?Rules.rotate(n,i):Engine.tick(t,i,o),s=i,Renderer.invalidate(e,n,o,l),l.includes(i)?Music.sing(o):(n=void 0,Music.sing("prev"))}function c(){if(Music.sing("next"),"intro"!==e){if("help"!==e)return"game"===e?(e="help",l(),void Renderer.invalidate(e,t,o,AI.playable(t,o))):void("over"===e&&Root.print());Root.print()}else Root.print()}function u(){return Music.sing("next"),"intro"===e?(e="game",void Renderer.invalidate(e,t,o,AI.playable(t,o))):"help"===e?(e="game",void Renderer.invalidate(e,t,o,AI.playable(t,o))):"game"===e&&void 0!==n?((t=n).d6=D6.pick([1,2,3,4,5,6].filter(e=>e!==t.d6)),s=void 0,n=void 0,o=Engine.item(t),void Renderer.invalidate(e,t,o,AI.playable(t,o))):"game"===e&&"reset"===o?(e="over",void Renderer.invalidate(e,t,o,AI.playable(t,o))):void("over"===e&&(r(),e="intro",l(),Renderer.invalidate(e,t,o,AI.playable(t,o))))}Root.onload=function(){const s=Root.jQuery;r(),function(){const e=Root.jQuery;let s="";const n=t.files.slice(),o=t.ranks.slice().reverse();o.forEach(e=>{n.forEach(t=>{s+=`<div id="${t}${e}">`,s+=i(9),s+="</div>"})}),e("#ship").html(s),s="",o.forEach(()=>{n.forEach(()=>{s+="<div></div>"})}),e("#board").html(s)}(),function(){const e=Root.jQuery;let t="";["meteor","meteor","meteor","meteor","meteor","pod","crew","crew","crew","crew","hall","hall","hall","hall","hall","hall","hall","hall","corner","corner","corner","corner","corner","corner","corner","corner","tee","tee","tee","tee","tee","tee","tee","tee","junction","junction","junction","junction","junction","junction","junction","junction"].forEach(e=>{t+=`<div class="${e} north">`,t+=i(9),t+="</div>"}),e("#tiles").html(t)}(),l(),t.files.forEach(e=>{t.ranks.forEach(t=>{s(`#${e}${t}`).click(a)})}),s("#prev").click(c),s("#preview").html(i(9)),s("#next").click(u),Renderer.invalidate(e,t,o,AI.playable(t,o))}})(),function(){function e(t){return t instanceof e?t:(this.element=t,"string"==typeof t&&0===t.indexOf("#")&&(this.element=document.getElementById(t.slice(1))),this)}e.prototype.addClass=function(e){if(this.element&&this.element.classList&&e){e.split(" ").filter(e=>e).forEach(e=>this.element.classList.add(e))}return this},e.prototype.removeClass=function(e){if(this.element&&this.element.classList){e.split(" ").filter(e=>e).forEach(e=>this.element.classList.remove(e))}return this},e.prototype.toggleClass=function(e){return this.element&&this.element.classList&&this.element.classList.toggle(e),this},e.prototype.html=function(e){return this.element&&(this.element.innerHTML=e),this},e.prototype.click=function(e,t){const s=this;return this.element&&("ontouchstart"in document.documentElement==!1?this.element.onmousedown=function(n){e&&e(s,n),document.onmousemove=function(e){e.preventDefault()},document.onmouseup=function(e){t&&t(s,e),document.onmousemove=void 0,document.onmouseup=void 0}}:this.element.ontouchstart=function(n){e&&e(s,n),document.ontouchmove=function(e){e.preventDefault()},document.ontouchend=function(e){t&&t(s,e),document.ontouchmove=void 0,document.ontouchend=void 0}}),s},e.prototype.unwrap=function(){return this.element},Root.jQuery=function(t){return new e(t)}}(),"object"==typeof module&&(module.exports={Ship:Ship,Rules:Rules,AI:AI});