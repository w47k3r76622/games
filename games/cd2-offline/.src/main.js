var Display=function(){function e(){this.tileSize=GameModel.getInstance().TILE}return e.prototype.draw=function(){var e=GameModel.getInstance(),t=e.ctx,i=4===GameModel.getInstance().currentLevel;t.fillStyle="#14486e",t.fillRect(15*this.tileSize,10*this.tileSize,3*this.tileSize,this.tileSize),t.fillRect(16*this.tileSize,9*this.tileSize,this.tileSize,this.tileSize),t.fillStyle="#910429",0===e.lifes?(e.currentLevel=0,t.fillStyle="#910429"):i?t.fillStyle="#269113":e.currentLevel>0&&(t.fillStyle="#65666a"),t.fillRect(14*this.tileSize,6*this.tileSize,5*this.tileSize,3*this.tileSize),0===e.lifes&&(t.fillStyle="#000000"),t.fillStyle=i?"#FFFFFF":"#000000",t.font="40px arial",t.fillText(["Offline","   li   ","O  li  e ","O line ","Online)"][GameModel.getInstance().currentLevel],14*this.tileSize+15,8*this.tileSize,300)},e}(),Engine=function(e){var t=e.window,i=t.document.getElementById("c").getContext("2d");function s(){GameModel.getInstance().ctx=i,this.elementsToUpdate=[],this.elementsToDraw=[]}return s.prototype.init=function(){this.prevTime=Date.now(),this.enterFrame()},s.prototype.enterFrame=function(){GameModel.getInstance().ctx.clearRect(0,0,i.canvas.width,i.canvas.height);var e=Date.now(),s=(e-this.prevTime)/1e3;s>.5&&(s=0),this.draw(s),this.update(s),this.prevTime=e,t.requestAnimationFrame(this.enterFrame.bind(this))},s.prototype.update=function(e){for(var t=0;t<this.elementsToUpdate.length;t++)this.elementsToUpdate[t].update(e)},s.prototype.draw=function(e){for(var t=0;t<this.elementsToDraw.length;t++){this.elementsToDraw[t].draw(e)}},s}(this);init=function(){var e=new Engine,t=new Level;e.elementsToDraw.push(t);var i=new Server;e.elementsToDraw.push(i);var s=new Display;e.elementsToDraw.push(s);var l=new Player;e.elementsToDraw.push(l),e.elementsToUpdate.push(l),addEventListener("keydown",function(e){return l.onkey(e,e.keyCode,!0)},!1),addEventListener("keyup",function(e){return l.onkey(e,e.keyCode,!1)},!1),e.init()},addEventListener("load",init,!1);var GameModel=function(){var e;return{getInstance:function(){return e||(e=function(){return this.level=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,2,1,1,1,0,1,1,4,1,1,0],[0,1,0,0,0,0,0,1,0,1,0,0,0,1,0],[0,1,0,0,0,0,0,1,1,1,0,0,0,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,0,0,0,0,1,1,1,1,1,1,1,1,0],[0,1,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,1,0,0,1,0,1,0,1,1,1,0,1,1,0],[0,1,0,0,1,0,1,0,1,0,1,0,1,0,0],[0,1,1,1,1,0,1,0,1,0,1,0,1,0,0],[0,0,0,0,0,0,1,0,1,0,1,0,1,0,0],[0,1,1,1,1,1,1,0,1,0,1,0,1,0,0],[0,1,0,0,0,0,0,0,1,0,1,0,1,0,0],[0,1,1,1,1,1,1,1,1,0,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],{ctx:"",TILE:32,columns:15,rows:15,level:this.level,currentLevel:0,gameEnded:!1,lifes:3,showTutor:!0}}()),e}}}(),Level=function(){function e(){this.columns=GameModel.getInstance().columns,this.rows=GameModel.getInstance().rows,this.tileSize=GameModel.getInstance().TILE,this.level=GameModel.getInstance().level,this.lostMessage=Math.floor(3*Math.random())}return e.prototype.draw=function(){var e=GameModel.getInstance(),t=e.ctx;for(i=0;i<this.rows;i++)for(j=0;j<this.columns;j++){var s=this.level[i][j];1===this.level[i][j]&&(t.fillStyle="#000000",t.fillRect(j*this.tileSize,i*this.tileSize,this.tileSize,this.tileSize)),8===this.level[i][j]&&(t.fillStyle="#ff1037",t.fillRect(j*this.tileSize,i*this.tileSize,this.tileSize,this.tileSize));var l=null;2===s&&(l=270),3===s&&(l=360),4===s&&(l=90),5===s&&(l=180),l&&this.drawArrow(t,j*this.tileSize,i*this.tileSize,j*this.tileSize+this.tileSize/2,i*this.tileSize+this.tileSize/2,l)}t.fillStyle="#343434",t.font="20px arial",e.showTutor&&(t.fillText("press up arrow to fix",50,25),t.fillText("press down arrow to fix",270,25)),1===e.currentLevel&&t.fillText("You will need to use all the arrow keys to get online!",50,25),2===e.currentLevel&&t.fillText("Internet is hard! But you can Do It!",100,25),3===e.currentLevel&&t.fillText("That's how dial up looks like!",100,25),4===e.currentLevel&&t.fillText("U are the winner! Thanks for playing!",80,25),0===e.lifes&&(0===this.lostMessage&&t.fillText("Ooops... cd2 server is down",130,25),1===this.lostMessage&&t.fillText("There is no internet connection",110,25),2===this.lostMessage&&t.fillText("Server is unavailable",150,25))},e.prototype.drawArrow=function(e,t,i,s,l,h){var n,o,d,r=10;e.fillStyle="#ffffff",e.fillRect(t,i,this.tileSize,this.tileSize),e.beginPath(),n=h*Math.PI/180,o=r*Math.cos(n)+s,d=r*Math.sin(n)+l,e.fillStyle="#ff1037",e.moveTo(o,d),n+=1/3*(2*Math.PI),o=r*Math.cos(n)+s,d=r*Math.sin(n)+l,e.lineTo(o,d),n+=1/3*(2*Math.PI),o=r*Math.cos(n)+s,d=r*Math.sin(n)+l,e.lineTo(o,d),e.closePath(),e.fill()},e}(),Player=function(){function e(){this.model=GameModel.getInstance(),this.tileSize=this.model.TILE,this.x=4*this.tileSize,this.y=7*this.tileSize,this.speed=100,this.dx=0,this.ddx=this.speed,this.dy=0,this.ddy=0,this.levelWidth=this.model.columns,this.level=this.model.level,this.cells=[],this.cellsToFixIndexes=[2,3,4,5],s.call(this)}function t(e,t,i){return Math.max(t,Math.min(i,e))}function s(){this.cells=[];for(var e=0;e<this.model.level.length;e++)this.cells=this.cells.concat(this.model.level[e])}return e.prototype.draw=function(e){var t=this.model.ctx;t.fillStyle="#ffcf3d",0==this.model.lifes&&(t.fillStyle="#ff1037"),t.fillRect(this.x+this.dx*e+this.tileSize/4,this.y+this.dy*e+this.tileSize/4,this.tileSize/2,this.tileSize/2)},e.prototype.update=function(e){if(this.model.gameEnded||0===this.model.lifes)return this.dx=0,void(this.dy=0);this.x=this.x+e*this.dx,this.y=this.y+e*this.dy,this.dx=t(this.dx+e*this.ddx,-this.speed,this.speed),this.dy=t(this.dy+e*this.ddy,-this.speed,this.speed);var i=this.p2t(this.x),s=this.p2t(this.y),l=this.x%this.tileSize,h=this.y%this.tileSize,n=this.tcell(i,s),o=this.tcell(i+1,s),d=this.tcell(i+2,s),r=this.tcell(i-1,s),a=this.tcell(i,s+1),c=this.tcell(i,s+2),f=this.tcell(i+1,s+1),p=this.tcell(i,s-1);this.dx<0&&(-1!==this.cellsToFixIndexes.indexOf(n)&&l<=this.tileSize/2?this.onBrokenTileEntered(i,s):l<=this.tileSize/2&&-1!==this.cellsToFixIndexes.indexOf(o)&&this.onBrokenTileEntered(i+1,s),-1!==this.cellsToFixIndexes.indexOf(d)&&this.setNotFixed(i+2,s)),this.dx>0&&(-1!==this.cellsToFixIndexes.indexOf(n)&&l>=this.tileSize/2?this.onBrokenTileEntered(i,s):l>=this.tileSize/2&&-1!==this.cellsToFixIndexes.indexOf(o)&&this.onBrokenTileEntered(i+1,s),-1!==this.cellsToFixIndexes.indexOf(r)&&this.setNotFixed(i-1,s)),this.dy>0&&(h>=this.tileSize/2&&-1!==this.cellsToFixIndexes.indexOf(a)&&this.onBrokenTileEntered(i,s+1),h>=this.tileSize/2&&-1!==this.cellsToFixIndexes.indexOf(n)&&this.onBrokenTileEntered(i,s),-1!==this.cellsToFixIndexes.indexOf(p)&&this.setNotFixed(i,s-1)),this.dy<0&&(h<=this.tileSize/2&&-1!==this.cellsToFixIndexes.indexOf(a)&&this.onBrokenTileEntered(i,s+1),h<=this.tileSize/2&&-1!==this.cellsToFixIndexes.indexOf(n)&&this.onBrokenTileEntered(i,s),-1!==this.cellsToFixIndexes.indexOf(c)&&this.setNotFixed(i,s+2)),this.dy>0?!a&&r?(this.y=this.t2p(s),this.ddx=-this.speed,this.dx=-this.speed,this.ddy=0,this.dy=0):!a&&o&&(this.y=this.t2p(s),this.ddx=this.speed,this.dx=this.speed,this.ddy=0,this.dy=0):this.dy<0?!n&&f?(this.y=this.t2p(s+1),this.ddx=this.speed,this.dx=this.speed,this.ddy=0,this.dy=0):n||(this.y=this.t2p(s+1),this.ddx=-this.speed,this.dx=-this.speed,this.ddy=0,this.dy=0,4===i&&6===s&&this.onServerReached()):this.dx>0?!o&&a?(this.x=this.t2p(i),this.ddy=this.speed,this.dy=this.speed,this.ddx=0,this.dx=0):!o&&p?(this.x=this.t2p(i),this.ddy=-this.speed,this.dy=-this.speed,this.ddx=0,this.dx=0):!o&&n&&(this.x=this.t2p(i),this.ddx=-this.speed,this.dx=-this.speed,this.ddy=0,this.dy=0,this.onDisplayReached()):this.dx<0&&(n||f?!n&&f&&(this.x=this.t2p(i+1),this.ddy=this.speed,this.dy=this.speed,this.ddx=0,this.dx=0):(this.x=this.t2p(i+1),this.ddy=-this.speed,this.dy=-this.speed,this.ddx=0,this.dx=0))},e.prototype.onBrokenTileEntered=function(e,t){var i=!1,s=this.model.level[t][e];return 2===s&&this.upPressed&&(i=!0),3===s&&this.rightPressed&&(i=!0),4===s&&this.downPressed&&(i=!0),5===s&&this.leftPressed&&(i=!0),i&&-1!==this.cellsToFixIndexes.indexOf(s)&&(this.model.level[t][e]=1,this.cells[e+t*this.levelWidth]=1,this.brokenTiles--),i},e.prototype.setNotFixed=function(e,t){8!==this.model.level[t][e]&&(this.model.level[t][e]=8,this.model.lifes--)},e.prototype.onDisplayReached=function(){this.model.currentLevel++,4===this.model.currentLevel&&(this.model.gameEnded=!0),this.speed=800;var e=GameModel.getInstance().columns,t=GameModel.getInstance().rows;for(i=0;i<t;i++)for(j=0;j<e;j++){8===this.model.level[i][j]&&(this.model.level[i][j]=1)}this.model.showTutor=!1,s.call(this)},e.prototype.onServerReached=function(){var e=GameModel.getInstance().columns,t=GameModel.getInstance().rows;1===this.model.currentLevel&&(this.speed=150),2===this.model.currentLevel&&(this.speed=200),3===this.model.currentLevel&&(this.speed=250),4===this.model.currentLevel&&(this.speed=300);for(var l=[36,41,42,44,48,49,50,51,52,56,60,69,73,84],h=0,n=[],o=1;o<84;o++)-1===l.indexOf(o)&&n.push(o);for(var d=[0,5,8,10,5,8,10][this.model.currentLevel],r=[],a=0;a<=d;a++){var c=Math.floor(Math.random()*n.length),f=n.splice(c,1);r.push(f[0])}for(i=0;i<t;i++)for(j=0;j<e;j++){var p=this.model.level[i][j];if(8===p&&(this.model.level[i][j]=1),0!==p&&(h++,-1!==r.indexOf(h))){var u=Math.floor(4*Math.random())+2;this.model.level[i][j]=u}}s.call(this)},e.prototype.t2p=function(e){return e*this.tileSize},e.prototype.p2t=function(e){return Math.floor(e/this.tileSize)},e.prototype.cell=function(e,t){return this.tcell(this.p2t(e),this.p2t(t))},e.prototype.tcell=function(e,t){return this.cells[e+t*this.levelWidth]},e.prototype.onkey=function(e,t,i){switch(t){case KEY.LEFT:return this.leftPressed=i,e.preventDefault(),!1;case KEY.RIGHT:return this.rightPressed=i,e.preventDefault(),!1;case KEY.UP:return this.upPressed=i,e.preventDefault(),!1;case KEY.DOWN:return this.downPressed=i,e.preventDefault(),!1}},KEY={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40},e}(),Server=function(){function e(){this.tileSize=GameModel.getInstance().TILE}return e.prototype.draw=function(){var e=GameModel.getInstance().lifes,t=GameModel.getInstance().ctx;t.fillStyle="#694a15",t.fillRect(3*this.tileSize,3*this.tileSize,2*this.tileSize,4*this.tileSize),t.fillStyle="#09e900",0===e&&(t.fillStyle="#ff1037"),t.fillRect(3*this.tileSize+10,3*this.tileSize+10,10,10);for(var i=0;i<3;i++)t.fillStyle=i<=e-1?"#ffcf3d":"#ff1037",t.fillRect(3*this.tileSize+10*(i+1)+3*i,3*this.tileSize+40,10,10)},e}();