(()=>{"use strict";var t={877:t=>{const s=[];function e(t,s){t.splice(t.indexOf(s),1)}const i=(t,s)=>getNeighbours(t.row,t.col).map((([t,e])=>Object.values(s).find((s=>s.row==t&&s.col==e)))).filter((t=>t));class o{interval=SOL_DURATION;#t;constructor(t,s,e,i){this.#t=t,Object.assign(this,{row:s,col:e,id:i,stock:0})}broadcast(){this.#t.broadcast("tile",this)}produce(t){this.#t.safeTimeout((()=>{const{out:s,use:e}=t;if(!e||this.#t.stats[e[0]]>=1){const t=s[2]>10?Math.ceil(this.ppl/s[2]):s[2]||1;this.stock+=t,e&&(this.#t.stats[e[0]]-=s[2]>10?Math.ceil(this.ppl/s[2]):1,this.#t.broadcastStats()),this.stop=!1}else this.stop=!0;this.broadcast(),this.produce(t)}),this.interval)}setBuild(t,s){const[e,o]=s.cost;e>this.#t.stats[o]||(this.#t.stats[o]-=e,this.#t.broadcastStats(),this.build="wip",this.willBe=t,this.until=Math.ceil(this.#t.getSol()/SOL_DURATION+s.days),this.broadcast(),i(this,this.#t.tiles).forEach((t=>{t.free=!0,t.broadcast()})),this.#t.safeTimeout((()=>{this.build=t,this.willBe=null,s.cap&&(this.ppl=0),this.broadcast(),s.use&&(this.#t.stats[s.use[0]+"_use"]+=1),s.out&&this.produce(s)}),s.days*SOL_DURATION))}}class a{tiles=[];users=[];events=[];init=()=>{this.solCount=0,this.lastTime=Date.now(),this.timeStarted=0,this.gameRunning=!1,this.eventCount=0,this.totalPopulation=0,this.deaths=0,this.stats={...stats},this.generateTiles(),console.log("ü§ñ Initializing events"),this.events=[],this.initScheduler(),this.initConvoySchedule(),this.initRiotSchedule(),this.initStormSchedule()};generateTiles=()=>{console.log("ü§ñ Generating tiles"),this.tiles={};let t=Math.floor(6.5);for(let s=0;s<13;s++){const e=0===s||12===s||12===t?t-2:t;for(let t=0;t<e;t++){const e=`${String.fromCharCode(65+s)}${t}`;this.tiles[e]=new o(this,s,t,e)}s>=Math.floor(6.5)?t--:t++}this.tiles.G1.build="center",this.tiles.G2.build="camp",this.tiles.G2.ppl=0,i(this.tiles.G1,this.tiles).concat(i(this.tiles.G2,this.tiles)).forEach((t=>t.free=!0));let s=[];for(;s.length<6;){const t=Math.floor(Math.random()*(Object.values(this.tiles).length-1)),e=Object.values(this.tiles)[t];e.free||e.build||s.includes(e.id)||(e.build="mount",i(e,this.tiles).forEach((t=>{t.mine=!0})),s.push(e.id))}};getSol=()=>this.gameRunning?(this.solCount+=Date.now()-this.lastTime,this.lastTime=Date.now(),this.solCount):this.solCount;safeTimeout=(t,s)=>{this.gameRunning?setTimeout(t,s):setTimeout((()=>this.safeTimeout(t,s)),1e3)};createEvent=(t,s,e,i,o,a,h)=>{this.events.push(new n(t,s,e,i,o,a,h))};broadcast=(t,s)=>{this.users.forEach((e=>{e.socket.emit(t,s)}))};broadcastStats=()=>{this.broadcast("sol",{sol:this.getSol(),start:this.timeStarted,events:this.eventCount,deaths:this.deaths,saved:this.totalPopulation}),this.broadcast("stats",this.stats)};broadcastUsers=()=>{const t=this.users.map((t=>({id:t.id,name:t.name})));this.users.forEach((s=>{s.socket.emit("users",{id:s.id,users:t})}))};initScheduler=()=>{setInterval((()=>{this.gameRunning&&this.events.forEach((t=>{const{alertTime:s,wait:i,old:o,fn:a}=t,h=this.getSol();!o&&h>s&&(this.broadcast("event",t),t.old=!0,a&&a()),h>s+i*SOL_DURATION&&e(this.events,t)}))}),1e3)};initConvoySchedule=()=>{const t=t=>()=>{this.tiles.G2.ppl+=t,this.tiles.G2.broadcast(),this.stats.population+=t,this.stats.workforce+=Math.round(.4*t),this.totalPopulation+=t,this.eventCount++,this.broadcastStats()},s=this.getSol();this.createEvent("convoy1","‚ÑπÔ∏è",s,1),this.createEvent("convoy2","‚ÑπÔ∏è",s+SOL_DURATION,0,9e3,t(9e3)),this.convoyCount=0;const e=()=>{const s=this.convoyCount+10*Math.random();this.convoyCount++,console.log("next convoy: sol",s);const i=10*Math.round(5e3*Math.random()+1e3);this.safeTimeout((()=>{const s=this.getSol();this.createEvent("convoy1","‚ÑπÔ∏è",s,4),this.createEvent("convoy2","‚ÑπÔ∏è",s+4*SOL_DURATION,0,i,t(i)),this.safeTimeout(e,4*SOL_DURATION)}),(s-4)*SOL_DURATION)};e()};updateRiot=t=>{const s=0==t.ppl?0:t.ppl/buildings[t.build].cap+(t.stop?-.5:-1);if(s>Math.random()){const s=Math.ceil(.02*t.ppl);this.createEvent("riot","‚ö†Ô∏è",this.getSol(),0,s,null,t.id),t.ppl-=s,t.riot=!0,t.broadcast(),this.stats.population-=s,this.stats.workforce-=Math.round(.4*s),this.broadcastStats(),this.deaths+=s}else t.riot&&s<=0&&(t.riot=!1,t.broadcast())};initRiotSchedule=()=>{this.safeTimeout((()=>{Object.values(this.tiles).filter((t=>void 0!==t.ppl)).forEach(this.updateRiot),this.initRiotSchedule()}),1e4)};initStormSchedule=()=>{this.safeTimeout((()=>{const t=Math.random();if(t<.01){const s=Math.floor(Object.values(this.tiles).length*t/.01),e=Object.values(this.tiles)[s];e.dust=!0,e.broadcast();const o=i(e,this.tiles);o.forEach((t=>{t.dust=!0,t.broadcast()}));const a=5*Math.random();this.createEvent("dust1","‚ö†Ô∏è",this.getSol(),a,0,null,e.id),this.createEvent("dust2","‚ÑπÔ∏è",this.getSol()+SOL_DURATION,0,a,(()=>{e.dust=!1,e.broadcast(),o.forEach((t=>{t.dust=!1,t.broadcast()}))}),e.id),e.broadcast()}this.initStormSchedule()}),1e3)};collect=(t,s)=>{if(this.tiles[t]&&this.tiles[t].stock>0){const s=buildings[this.tiles[t].build].out[0],e=this.tiles[t].stock;this.stats[s]+=e,this.tiles[t].stock=0,this.tiles[t].broadcast(),this.broadcastStats()}else s.socket.emit("collect-fail")};build=(t,s,e)=>{this.tiles[t]&&!this.tiles[t].build&&buildings[s]?this.tiles[t].setBuild(s,buildings[s]):e.socket.emit("build-fail")};move=(t,s,e)=>{if(e<100||e>1e5||"house"!=this.tiles[t].build)return;const i=Math.min(e,"movein"==s?this.tiles.G2.ppl:this.tiles[t].ppl);this.tiles[t].ppl+=i*("movein"==s?1:-1),this.tiles.G2.ppl+=i*("movein"==s?-1:1),this.tiles[t].broadcast(),this.tiles.G2.broadcast(),this.updateRiot(this.tiles[t]),this.updateRiot(this.tiles.G2)};constructor(){}}class h{constructor(t,s){const e=(t,s)=>t+Math.round(Math.random()*(s-1)),i=()=>String.fromCharCode(e(65,26)),o=i(),a=i(),h=e(1,10);this.socket=t,this.name=`${o}${a}${h}`,this.id=t.id.substr(0,6),this.game=s}join=t=>{"solo"===t?(this.game=new a,this.game.init()):this.game=l,this.game.timeStarted||(this.game.timeStarted=Date.now()),this.game.gameRunning=!0,0===this.game.users.length&&(this.game.lastTime=Date.now()),this.game.users.push(this),this.socket.on("msg",(t=>{const s=t.replace(/[&/\\#,+()$~%.^'":*<>{}]/g," ").substr(0,22);this.game.broadcast("msg",{user:this.name,msg:s})})),this.socket.on("build",(({id:t,choice:s})=>{this.game.build(t,s,this)})),this.socket.on("collect",(t=>{this.game.collect(t,this)})),this.socket.on("move",(({id:t,action:s,count:e})=>{this.game.move(t,s,e)})),this.game.broadcastUsers(),this.game.broadcastStats(),this.socket.emit("world",{tiles:this.game.tiles,stats:this.game.stats}),this.socket.emit("events",this.game.events.filter((t=>t.old)))}}class n{constructor(t,s,e,i,o,a,h){Object.assign(this,{name:t,type:s,alertTime:e,wait:i,count:o,fn:a,tileId:h}),this.sol=Math.ceil(e/SOL_DURATION+i)}}let l=new a;l.init(),t.exports={io:t=>{console.info("Connected: "+t.id);let i=new h(t,l);s.push(i),t.on("join",(t=>{console.info("Player: "+i.name+" joined.",t),i.join(t)})),t.on("disconnect",(()=>{console.info("Disconnected: "+i.name),0===i.game.users.length&&(i.game.gameRunning=!1,i.game.solCount+=Date.now()-i.game.lastTime,i.game.lastTime=Date.now()),e(s,i),e(i.game.users,i),i=null}))},reset:(t,e)=>{const i='<form method="POST"><input name="pwd" type=text/><button>Reset Game</button>';if("POST"===t.method){const h=-105377644===(o=t.body.pwd,Array.from(o).reduce(((t,s)=>0|31*t+s.charCodeAt(0)),0));s.forEach((t=>t.socket.emit("restart"))),e.send(h+i),l=new a,l.init()}else e.send(i);var o}}}},s={},e=function e(i){var o=s[i];if(void 0!==o)return o.exports;var a=s[i]={exports:{}};return t[i](a,a.exports,e),a.exports}(877),i=exports;for(var o in e)i[o]=e[o];e.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();