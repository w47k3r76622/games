(()=>{const e=.43,t="#0f0b0b",s="#881f1a";phase=null,tiles={},stats={},$selectedTile=null,msg={convoy1:"Refugee convoy departed from Earth and will arrive on sol %s.",convoy2:"Convoy arrived with %c refugees.",riot:"Riots in sector %t have caused %c deaths.",asteroid:"Danger: asteroid heading to Mars.",conjunction:"Solar conjunction for the next 7 sols; Earth link down.",dust1:"Dust storm around %t forecasted until sol %s affecting radio.",dust2:"Dust storm around %t ended."};const n=()=>{let e=6;for(let t=0;13>t;t++){const s=document.createElement("div");s.className="row";const n=0===t||12===t||12===e?e-2:e;for(let e=0;n>e;e++){const a=document.createElement("div");a.className="T";const i=`${String.fromCharCode(65+t)}${e}`;a.dataset.n=i,s.appendChild(a),tiles[i]={$tile:a,id:i,row:t,col:(e+2/n)/n,stock:0}}tileset.appendChild(s),6>t?e++:e--}},a=e=>e>2e4?null:Math.sin(e/20-Math.sin(e/100)*Math.sin(e/61))*Math.sin(2*e/2e4*Math.PI)*.5,i=e=>e>8e3?null:Math.sin(e/5-Math.sin(e/2))*Math.sin(e/4e3*Math.PI)*.2,l=e=>{var t=2e4;return e>t?null:Math.sin(6e-4*e*Math.sin(.009*e)+Math.sin(e/400))*(t-e)/t*.5},o=e=>{var t=2e4;return e>t?null:Math.sin(6e-4*(e=t-e)*Math.sin(.009*e)+Math.sin(e/400))*(t-e)/t*.5},c=e=>{if(!p||!g)return;const t=p.createBuffer(1,96e3,48e3),s=t.getChannelData(0);for(let t=96e3;t--;)s[t]=e(t);const n=p.createBufferSource();n.buffer=t,n.connect(p.destination),n.start()},r=()=>{for(var e=2*p.sampleRate,t=p.createBuffer(1,e,p.sampleRate),s=t.getChannelData(0),n=0;e>n;n++)s[n]=2*Math.random()-1;return t},d=e=>{const t=new AudioContext;g=t.createBufferSource(),g.loop=!0,g.buffer=r();var s=t.createBiquadFilter();s.type="lowpass",s.frequency.value=200,g.connect(s);const n=t.createGain();s.connect(n),n.connect(t.destination),e?(n.gain.setValueAtTime(.01,t.currentTime),n.gain.linearRampToValueAtTime(.35,t.currentTime+.5)):n.gain.setValueAtTime(.35,t.currentTime),g.start(t.currentTime)},u=[9,7,9,13,17,13,9,7,9,13,17,13,9,7,9,13,17,12,9,7,9,12,18,12,9,7,9,12,18,12,9,7,9,12,18,13,10,8,10,13,18,13,10,8,10,13,18,13,10,8,10,13,17,12],h=.9,m=[420,400,420,440,460,480,460,440];let p,g,f=m.pop(),b=!0,v=0,y=0;const $=()=>{b&&(p.currentTime>y+v*h&&(((e,t,s)=>{const n=p.createOscillator(),a=p.createGain();n.connect(a),a.connect(p.destination),a.gain.setValueAtTime(.01,t),a.gain.exponentialRampToValueAtTime(.5,t+.08*h),a.gain.setValueAtTime(.5,t+.27),a.gain.exponentialRampToValueAtTime(.01,t+1.35),n.frequency.value=s/1.06**e,n.start(t),n.stop(t+1.35)})(u[v],y+v*h,f),v++,v==u.length&&(y=p.currentTime+h,v=0,m.unshift(f),f=m.pop())),setTimeout($,10))},w=()=>{p=new AudioContext,y=p.currentTime,$(),d(!0)},T=()=>{g?(g.stop(),g=null):d(!0),_sound.classList.toggle("off",!g)},L=()=>{b?b=!1:(b=!0,y=p.currentTime-v*h,$()),_music.classList.toggle("off",!b)};let M;const k=({id:e,build:t,stock:s,willBe:n,ppl:a,dust:i,riot:l,mine:o,free:c,stop:r,until:d})=>{const u=tiles[e];if(u){if(u.$tile.classList.toggle("dust",!!i),"road"===t)u.$tile.innerHTML="",u.$tile.classList.add("road");else if(t&&t!=u.build){const e=document.createElement("span");if(e.classList.add(t),"mount"===t&&u.$tile.classList.add("deco"),u.$tile.replaceChildren(e),e.innerText=buildings[t].icon,u.build=t,"center"===t&&"undefined"==typeof rocket2){const e=rocket.cloneNode(!0);e.id="rocket2",u.$tile.appendChild(e)}}[["new",s>0],["mine",!!o],["free",!!c],["stop",!!r],["bad",!!l]].forEach((([e,t])=>u.$tile.classList.toggle(e,t))),Object.assign(u,{stock:s,willBe:n,ppl:a,dust:i,mine:o,free:c,stop:r,until:d}),u.$tile===$selectedTile&&(i?(S(),E()):A($selectedTile))}};function _({target:e}){buildings[e.id]&&(document.body.removeEventListener("click",_),G($selectedTile.dataset.n,e.id),S(),E())}const S=()=>{$selectedTile?.classList.remove("selected"),$selectedTile=null},E=()=>{_dialog.classList.contains("show")&&c(l),document.body.removeEventListener("click",_),_dialog.classList.remove("show"),_choices.innerHTML="",R([0,0],1),M=!1},C=(e,t,s)=>{_prompt.innerHTML=(e?`<b>Sector ${e.id} ${e?.mine?"🔵 Rocky area":0===e?.row?"⚪️ Glaciar":e?"🟤 Open plains":""}</b><br>`:"")+t,_choices.innerHTML=s,c(o),_dialog.classList.add("show")},O=(e,t)=>{const s=Math.round(100*e.ppl/t.cap);return[`${e.ppl||0} ${t.count.join(" ")}`,"Capacity: "+t.cap,`At ${s}% capacity`,s>99?"<br>🚨 WARNING. This many people<br>cannot be supported!":"Operating normally"].join("<br>")},A=e=>{S(),$selectedTile=e;const t=tiles[e.dataset.n];if(!t.dust){if(t.build&&"road"!=t.build){const e=buildings[t.build];if(e.out){const[s,n,a]=e.out;C(t,e.label,`<p>Producing ${a>10?Math.ceil(t.ppl/a):a||1} ${n} daily</p>`+(t.stop?`<p class="red">Not enough ${e.use[0]} ${e.use[1]}.<br>Production halted.</p>`:"")+`<p>Stock: ${t.stock}</p>`+`<ul><btn class="${0==t.stock?'off"':'" id="getall"'}>Collect stock<br><small>or ctrl + click the tile</small></btn></ul>`+(e.count?O(t,e)+'<br><aside>\n<p>Move residents ↕️</p>\n<btn class="radio" id="movein">From camp</btn>\n<btn class="radio" id="moveout">To camp</btn>\n<btn id="div">÷ 5</btn>\n<btn id="mul">× 5</btn>\n<span id="_val">100</span>\n<btn id="ok">MOVE&nbsp;➡️</btn>\n</aside>':""))}else C(t,buildings[t.willBe]?.label||e.label,`<p>${e.count?O(t,e):t.willBe?"🚧 Under construction until sol "+t.until:"Waiting for new convoy arrival"}</p>`)}else{const e=e=>([t,{out:s,use:n,label:a,icon:i,cost:l,days:o}])=>{const c=e.free&&stats[l[1]]>=l[0]?"":"red";return`<btn i="${i}" id="${c?"":t}">${a}<br><small>${[`<span class="${c}">costs ${l[0]} ${l[1]}</span>`,`builds in ${o} sols`,s?.length?`out: ${s[1]} `+(s[2]>10?" per 25k daily":"daily"):"connects sectors",n?`<span>in: ${n[1]} ${n[2]>10?" per 25k daily":"daily"}</span>`:""].join("<br>")}</small></btn>`},s=["road"].concat(0===t.row?["water"]:t.mine?["minery","nuclear"]:["house","solar","greenhouse"]);C(t,t.build?"Replace path with:":"Choose new building",`${t.free?"":'<p class="red">This area isn\'t connected to your colony yet</p>'}<ul>${Object.entries(buildings).filter((([e,t])=>s.includes(e))).map(e(t)).join("")}</ul>`),_dialog.addEventListener("click",_)}e.classList.add("selected"),j(e)}},R=(e,t)=>{wrapper.style.transform=`scale(${t}) translate(${e[0]}px, ${e[1]}px)`},j=e=>{if(!M){M=!0;let{left:t,top:s}=e.getBoundingClientRect();s+=.1*innerHeight,R([-(t-innerWidth/2),-(s-innerHeight/2)],3)}},I=()=>{C(null,"Player List",`<ul id="players">${F.map((e=>`<li>${e}</li>`)).join("")}</ul>`)},D=()=>{const e=W.length>0?W.map((({user:e,msg:t})=>`<li><b>${e}:</b> ${t}</li>`)).join(""):"<b>No messages</b>";C(null,"Comms Panel",`<ul id="chatlist" />${e}</ul><input maxlength="22" id="_input" />`),_input.focus(),chatlist.scrollTo(0,chatlist.clientHeight)},P=()=>{C(null,"Game stats",`<p>${["<b>☀️ Sol:</b> "+Math.ceil(z/SOL_DURATION),"<b>🎉 Events:</b> "+K.events,"<b>⚰️ Deaths:</b> "+K.deaths,"<b>👨‍👨‍👧‍👧 Total refugees:</b> "+K.saved,"<br><b>🕐 Game start:</b><br>"+new Date(K.start).toLocaleString("pt",{timeZone:"Europe/Lisbon"}),"(UTC+0 Earth Time)","<br>Feedback welcome 🐦 @mrlopis"].join("<br>")}</p>`)},N=e=>{0!==e.length&&setTimeout((()=>{let t;e.forEach((e=>{t=t||"⚠️"===e.type,x(e,!1)})),c(t?a:i)}),500)},x=(e,t=!0)=>{const s=document.createElement("p");s.setAttribute("i",e.type);const n=msg[e.name].replace("%c",e.count).replace("%t",e.tileId).replace("%s",e.sol);s.innerHTML="<span>"+n+(e.wait?"":`</br><small>date: sol ${e.sol}</small>`)+"</span>",_notices.prepend(s),t&&c("⚠️"===e.type?a:i),B[e.name]?.(e)},B={convoy1(){rocket.classList.add("go"),setTimeout((()=>{rocket.classList.remove("go")}),6e3)},convoy2(){rocket2.classList.add("go"),setTimeout((()=>{rocket2.classList.remove("go")}),6e3)},asteroid(){},conjunction(){},dust(){}};let H;const U=()=>{io&&(H=io?.({upgrade:!1,transports:["websocket"]}),window.emit=H.emit,Object.entries({disconnect(){C(null,"<br>Server Side Error",'<p class="red">Unfortunately, the server<br>has crashed or restarted.<br>Please refresh the page.</p>')},users({id:e,users:t}){Q(e,t),_users.dataset.count=t.length},restart:()=>window.location.reload(),msg({user:e,msg:t}){X(e,t),"undefined"!=typeof _input?D():_comms.dataset.new=!0},sol(e){phase=e.sol%SOL_DURATION/SOL_DURATION,Y(e)},world({tiles:e,stats:t}){Object.entries(e).forEach((([e,t])=>{k(t)})),document.querySelectorAll(".hidden").forEach((e=>e.classList.add("show"))),ee(t)},tile:k,build:k,stats:ee,events:N,event:x}).forEach((([e,t])=>H.on(e,t))))},V=e=>{H.emit("join",e)},G=(e,t)=>{H.emit("build",{id:e,choice:t})},q=()=>{const e=$selectedTile.dataset.n;H.emit("collect",e)};let F=[],W=[],z=0,K={},Z=!1;const J=e=>{ce(e),Object.values(tiles).forEach((e=>{e.build&&"mount"!==e.build&&(2*phase- -.1>1-e.col&&e.$tile.classList.add("night"),2*(phase-.5)+.1<1-e.col||e.$tile.classList.remove("night"))}));const t=Date.now();requestAnimationFrame((()=>J(Date.now()-t)))},Q=(e,t)=>{console.log(e,t),F=t.map((({id:t,name:s})=>t===e?s+" (you)":s))},X=(e,t)=>{W.push({user:e,msg:t})},Y=e=>{e?(K&&e.start>K.start&&window.location.reload(),K=e,z=K.sol):z+=SOL_DURATION,_sol.dataset.count=Math.ceil(z/SOL_DURATION)},ee=e=>{stats=e,Object.entries(e).forEach((([e,t])=>{t=t>1e3?Math.floor(t/1e3)+"k":t>1e6?Math.floor(t/1e6)+"M":t,document.getElementById(e)&&(document.getElementById(e).dataset.count=t)}))},te=()=>{Z||(Z=!0,w(),intro.classList.add("gone"),U(),V("solo"),n())},se=()=>{Z||(Z=!0,w(),intro.classList.add("gone"),U(),V(),n())};let ne=.4*canvas.clientHeight;const ae=()=>{ne=.4*Math.min(canvas.width,canvas.height)},ie=(e,t,s)=>{re.beginPath(),re.arc(e,t,s,0,2*Math.PI,!0)},le=e=>{re.fillStyle=e,ie(canvas.width/2,canvas.height/2,ne),re.fill()},oe=(t,s,n)=>{re.beginPath(),re.ellipse(canvas.width/2,canvas.height/2,ne,ne*t,Math.PI/2+e,Math.PI*n,Math.PI*s),re.fill()},ce=e=>{for(phase+=e/SOL_DURATION;phase>1;)phase-=1,Y()};let re,de;const ue=()=>{const t=canvas.width/2,n=canvas.height/2,a=2*ne;de=re.createRadialGradient(t+a*Math.sin(e),n-a*Math.cos(e),0,t-a*Math.sin(e),n+a*Math.cos(e),2*a),de.addColorStop(.14,"white"),de.addColorStop(.17,s),de.addColorStop(.83,s),de.addColorStop(.86,"white")},he=()=>{document.body.classList.toggle("fast"),_fast.classList.toggle("off")},me=()=>{document.body.classList.toggle("a11y"),_a11y.classList.toggle("off")};let pe,ge;const fe=e=>()=>{ge=Math.round(Math.max(10,Math.min(1e5,ge*e))),_val.innerText=ge>1e3?Math.round(ge/100)/10+"k":ge},be=e=>{movein.classList.remove("checked"),moveout.classList.remove("checked"),pe=e.id,e.classList.add("checked")},ve=()=>{pe&&H.emit("move",{id:$selectedTile.dataset.n,action:pe,count:ge})};window.addEventListener("load",(()=>{re=canvas.getContext("2d"),canvas.width=innerWidth,canvas.height=innerHeight,ae(),ue(),window.addEventListener("resize",(()=>{canvas.width=innerWidth,canvas.height=innerHeight,ae(),ue()})),addEventListener("keyup",(({target:e,key:t})=>{"Escape"===t&&(E(),S()),"Enter"===t&&e===_input&&e.value?.length>0&&((e=>{H.emit("msg",e)})(e.value),e.value="")})),addEventListener("click",(({target:e,ctrlKey:t})=>{if(e?.dataset?.n)return void(t?($selectedTile=e,q(),S()):(A(e),pe=null,ge=120));const s={movein:be,moveout:be,div:fe(.2),mul:fe(5),ok:ve}[e.id];if(s)return void s(e);const n={offline:te,global:se,_users:I,_comms:D,_sol:P,dismiss:E}[e.id];n&&(n(),S()),{_sound:T,_music:L,_fast:he,_a11y:me,getall:q}[e.id]?.()})),phase,setInterval((()=>{(()=>{try{re.clearRect(0,0,canvas.width,canvas.height),(e=>{re.fillStyle="white";const t=4*e-1.5;1>t&&t>0&&(ie(canvas.width*t,canvas.height*(.3+.2*(t-.5)**2),.01*canvas.height),re.fill())})(phase),(e=>{re.beginPath(),.25>e?(le(de),re.fillStyle=t,oe(1,0,1),re.fillStyle=de,oe(1,1,0),oe(4*(.25-e),0,1)):.5>e?(le(t),re.fillStyle=de,oe(1,1,0),re.fillStyle=t,oe(1,0,1),oe(4*(e-.25),1,0)):.75>e?(le(t),re.fillStyle=de,oe(1,0,1),re.fillStyle=t,oe(1,1,0),oe(4*(.75-e),0,1)):(le(de),re.fillStyle=t,oe(1,1,0),re.fillStyle=de,oe(1,0,1),oe(4*(e-.75),1,0),re.stroke()),re.fill()})(phase),re.strokeStyle=t,ie(canvas.width/2,canvas.height/2,ne),re.stroke()}catch(e){console.error(e),emit("halt")}})()}),16),requestAnimationFrame((()=>{J(0)}))}),!1)})();