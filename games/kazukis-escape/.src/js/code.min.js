var ClassicalNoise=function(a){void 0==a&&(a=Math);this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];this.p=[];for(var b=0;256>b;b++)this.p[b]=Math.floor(256*a.random());this.perm=[];for(b=0;512>b;b++)this.perm[b]=this.p[b&255]};ClassicalNoise.prototype.dot=function(a,b,c,d){return a[0]*b+a[1]*c+a[2]*d};ClassicalNoise.prototype.mix=function(a,b,c){return(1-c)*a+c*b};ClassicalNoise.prototype.fade=function(a){return a*a*a*(a*(6*a-15)+10)};ClassicalNoise.prototype.noise=function(a,b,c){var d=Math.floor(a),e=Math.floor(b),f=Math.floor(c);a-=d;b-=e;c-=f;var d=d&255,e=e&255,f=f&255,g=this.perm[d+this.perm[e+this.perm[f+1]]]%12,k=this.perm[d+this.perm[e+1+this.perm[f]]]%12,h=this.perm[d+this.perm[e+1+this.perm[f+1]]]%12,l=this.perm[d+1+this.perm[e+this.perm[f]]]%12,m=this.perm[d+1+this.perm[e+this.perm[f+1]]]%12,n=this.perm[d+1+this.perm[e+1+this.perm[f]]]%12,p=this.perm[d+1+this.perm[e+1+this.perm[f+1]]]%12,d=this.dot(this.grad3[this.perm[d+this.perm[e+this.perm[f]]]%12],a,b,c),l=this.dot(this.grad3[l],a-1,b,c),k=this.dot(this.grad3[k],a,b-1,c),n=this.dot(this.grad3[n],a-1,b-1,c),g=this.dot(this.grad3[g],a,b,c-1),m=this.dot(this.grad3[m],a-1,b,c-1),h=this.dot(this.grad3[h],a,b-1,c-1),p=this.dot(this.grad3[p],a-1,b-1,c-1);a=this.fade(a);b=this.fade(b);c=this.fade(c);d=this.mix(d,l,a);l=this.mix(g,m,a);k=this.mix(k,n,a);a=this.mix(h,p,a);d=this.mix(d,k,b);b=this.mix(l,a,b);return this.mix(d,b,c)};function hslToRgb(a,b,c){if(0==b)c=b=a=c;else{var d=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-c):a},e=0.5>c?c*(1+b):c+b-c*b,f=2*c-e;c=d(f,e,a+1/3);b=d(f,e,a);a=d(f,e,a-1/3)}return[255*c,255*b,255*a]}function generate_map(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;for(var d=c.getContext("2d"),e=d.createImageData(c.width,c.height),f=new ClassicalNoise,g=0,k=e.data.length;g<k;g+=4){var h=f.noise(Math.floor(g/4%c.width)/64,Math.floor(g/4/c.width)/64,0,c.width),h=hslToRgb(0.325,0.5,(h/25+0.3)/2);e.data[g]=h[0];e.data[g+1]=h[1];e.data[g+2]=h[2];e.data[g+3]=255}d.putImageData(e,0,0);return e}function generate_level(a,b){var c={};c.map=generate_map(a,b);return c}var mobs_data=[["Guardian",2,1,60,100,10,2,1],["Officer",1.25,0.5,60,80,6,2,2],["Enforcer",1,0.5,100,90,20,3,3],["SWAT",1.75,2,50,70,40,5,4]],bosses=[["Captain",["Hiro","Toshi"],"black"],["Sergent",["Hideki","Jiro","Kobe"],"grey"],["Amiral",["Kaito","Hiroshi"],"red"],["Sergeant",["Hideo","Akira"],"white"]];function detect_player(a,b,c,d,e){a+=15*Math.cos(Math.radians(c+35));b+=15*Math.sin(Math.radians(c+35));px=player.x;py=player.y;a=px-a;b=py-b;var f=180*Math.atan2(b,a)/Math.PI,f=f+(0>f?360:0);return Math.sqrt(a*a+b*b)<=e&&f>c-d&&f<c+d?!0:!1}function Mob(a){this.x=a.x;this.y=a.y;this.angle=a.angle;this.new_angle;this.angle_increment=this.rotate_speed=a.rotate_speed;this.lantern=a.lantern;this.distance;this.state=0;this.speed=a.movement_speed;this.health=this.max_health=a.health;this.name=a.name;this.points=a.points;this.boss=a.boss;this.img_type=a.img_type;this.update=function(){if(detect_player(this.x,this.y,this.angle,this.lantern.angle/2,this.lantern.distance))return end_game(),0;switch(this.state){case 0:this.new_angle=Math.floor(360*Math.random());this.angle_increment=Math.abs(this.rotate_speed)*(this.angle<this.new_angle?1:-1);this.state=1;break;case 1:this.angle+=this.angle_increment;if(this.angle>this.new_angle&&0<this.angle_increment||this.angle<this.new_angle&&0>this.angle_increment)this.distance=Math.floor(100*Math.random()+50),this.state=2;break;case 2:var a=Math.sin(Math.radians(this.angle)),c=Math.cos(Math.radians(this.angle));this.distance-=this.speed;0>this.x-16||this.x+16>ww||0>this.y-16||this.y+16>wh?(0>this.x-16&&(this.x=16,this.distance=0),0>this.y-16&&(this.y=16,this.distance=0),this.x+16>ww&&(this.x=ww-16,this.distance=0),this.y+16>wh&&(this.y=wh-16,this.distance=0)):(this.x+=c*this.speed,this.y+=a*this.speed,0>=this.distance&&(this.state=0))}};this.render=function(){eCtx.save();eCtx.translate(this.x,this.y);eCtx.rotate(Math.radians(this.angle)+Math.PI/2);eCtx.drawImage(enemyCanvas,26*this.img_type,0,26,28,-13,-14,26,28);eCtx.restore();drawHealthbar(eaCtx,this.x,this.y-20,100*(this.health/this.max_health),50,2);drawText(this.name,this.x+1,this.y-34,{textSize:12,ctx:eaCtx,textColor:"black"});drawText(this.name,this.x,this.y-35,{textSize:12,ctx:eaCtx,textColor:this.boss?"red":"white"});castLight(this.angle,this.lantern.angle,this.lantern.distance,this.x+15*Math.cos(Math.radians(this.angle+35)),this.y+15*Math.sin(Math.radians(this.angle+35)))}}var mCanvas,eCanvas,eCtx,gCanvas,gCtx,sCanvas,sCtx,lCanvas,lCtx,fxCanvas,fxCtx,eaCanvas,eaCtx,enemyCanvas,enemyCtx,bloodCanvas,bloodCtx,game_state=0,ww,wh,level_data,player={},keys=[],mouse={x:0,y:0},mobs=[],view_distance,blood=[],level=1,story_running=!0;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();Math.radians=function(a){return a*Math.PI/180};function toangle(a,b,c,d){a=180*Math.atan2(d-b,c-a)/Math.PI;return a+(0>a?360:0)}function drawText(a,b,c,d){d||(d={});var e=d.ctx?d.ctx:gCtx;e.font=(d.textSize?d.textSize:"20")+"px monospace";e.textAlign=d.textAlign?d.textAlign:"center";e.fillStyle=d.textColor?d.textColor:"white";e.fillText(a,b,c+(d.textSize?parseInt(d.textSize):20))}function showStory(a){-320>a||!1==story_running?start_game():(gCtx.clearRect(0,0,ww,wh),gCtx.fillStyle="black",gCtx.fillRect(0,0,ww,wh),drawText("Press space to skip",ww-5,wh-15,{textSize:10,textAlign:"right"}),drawText("On a summer night , after five years in prison",ww/2,a,{textSize:20}),drawText("for an uncommitted murder, Kazuki finnaly found a",ww/2,a+30,{textSize:20}),drawText("way to escape and return to his family.",ww/2,a+60,{textSize:20}),drawText("However, when he reached the courtyard",ww/2,a+90,{textSize:20}),drawText("he heard the alarm going off!",ww/2,a+120,{textSize:20}),drawText("Help Kazuki fight his way through",ww/2,a+180,{textSize:20}),drawText("security and stay out of the lights!",ww/2,a+210,{textSize:20}),setTimeout(function(){showStory(a-1.2)},1E3/30))}function core_init(){gCanvas=document.getElementById("gui");gCtx=gCanvas.getContext("2d");ww=gCanvas.width=800;wh=gCanvas.height=480;console.log(gCanvas.width+" x "+gCanvas.height);console.log(window.innerWidth+" x "+window.innerHeight);gCtx.fillStyle="black";gCtx.fillRect(0,0,ww,wh);drawText("Kazuki's escape",ww/2,wh/2-100,{textSize:60});drawText("Press space to start",ww/2,wh/2+40,{textSize:20});window.onresize=function(){0===game_state&&(gCtx.clearRect(0,0,gCanvas.width,gCanvas.height),gCtx.fillStyle="black",gCtx.fillRect(0,0,ww,wh),ww=gCanvas.width=window.innerWidth,wh=gCanvas.height=window.innerHeight,drawText("Kazuki's escape",ww/2,wh/2-100,{textSize:60}),drawText("Press space to start",ww/2,wh/2+40,{textSize:20}))};document.onkeydown=function(a){0!==game_state||32!=a.keyCode&&32!=a.which?2!==game_state||32!=a.keyCode&&32!=a.which?3!==game_state||32!=a.keyCode&&32!=a.which?(a=a||window.event,keys[a.keyCode||a.which]=1):story_running=!1:(game_state=1,restart_game()):(game_state=3,showStory(wh))};document.onkeyup=function(a){a=a||window.event;keys[a.keyCode||a.which]=0};document.onmousemove=function(a){a=a||window.event;mouse.x=a.x||a.clientX;mouse.y=a.y||a.clientY};document.onmousedown=function(){1===game_state&&attack(mouse)}}function spawn_mob(){if(!(mobs.length>=Math.floor(10*(ww/wh)/2))){var a=10;do var b=Math.floor(Math.random()*mobs_data.length),b=mobs_data[b];while(b[7]>level&&0<a--);if(!(0>=a)){a=10;do var c=Math.random()*ww,d=Math.random()*wh;while(Math.sqrt((c-player.x)*(c-player.x)+(d-player.y)*(d-player.y))<view_distance+116&&0<a--);0!=a&&mobs.push(new Mob({x:c,y:d,angle:Math.floor(360*Math.random()),rotate_speed:b[1]*Math.floor((10+level)/10),movement_speed:b[2]*Math.floor((10+level)/10),lantern:{angle:b[3],distance:b[4]},health:b[5],name:b[0],points:b[6],img_type:0}))}}}function spawn_more_mobs(){spawn_mob();setTimeout(spawn_more_mobs,5E3/level)}function summonBoss(a){do var b=Math.random()*ww,c=Math.random()*wh;while(Math.sqrt((b-player.x)*(b-player.x)+(c-player.y)*(c-player.y))<view_distance+116);var d=Math.floor(Math.random()*bosses.length),e=bosses[d],e=e[0]+" "+e[1][Math.floor(Math.random()*e[1].length)];a={x:b,y:c,angle:Math.floor(360*Math.random()),rotate_speed:2*((10+a)/10),movement_speed:1.5*((10+a)/10),lantern:{angle:80,distance:50*((10+a)/10)},health:30*((8+a)/10),name:e,points:Math.floor(15*a/10),boss:1,img_type:d+1};console.log(a);mobs.push(new Mob(a))}function attack(a){a=toangle(player.x+document.getElementsByTagName("canvas")[0].offsetLeft,player.y+document.getElementsByTagName("canvas")[0].offsetTop,a.x,a.y);for(var b=0;b<mobs.length;b++){var c=toangle(player.x,player.y,mobs[b].x,mobs[b].y);if(48>=Math.sqrt((player.x-mobs[b].x)*(player.x-mobs[b].x)+(player.y-mobs[b].y)*(player.y-mobs[b].y))&&c>a-30&&c<a+30)if(mobs[b].health-=player.damage*((10+level)/10),mobs[b].new_angle=a+180,mobs[b].angle_increment=2*Math.abs(mobs[b].rotate_speed)*(mobs[b].angle<mobs[b].new_angle?1:-1),mobs[b].state=1,0>=mobs[b].health)addBlood(mobs[b].x,mobs[b].y,0,{dir:a+180}),player.kills++,player.score+=mobs[b].points,c=Math.floor(player.kills/10)+1,c>level&&(summonBoss(c),level=c),draw_gui(),mobs.splice(b,1);else{var c=Math.radians(360*Math.random()),d=4*Math.random()+4;addBlood(mobs[b].x+Math.cos(c)*d,mobs[b].y+Math.sin(c)*d,1,{radius:1.5*Math.random()+1});c=Math.radians(360*Math.random());d=4*Math.random()+4;addBlood(mobs[b].x+Math.cos(c)*d,mobs[b].y+Math.sin(c)*d,1,{radius:1.5*Math.random()+1});c=Math.radians(360*Math.random());d=4*Math.random()+4;addBlood(mobs[b].x+Math.cos(c)*d,mobs[b].y+Math.sin(c)*d,1,{radius:1.5*Math.random()+1});c=Math.radians(360*Math.random());d=4*Math.random()+4;addBlood(mobs[b].x+Math.cos(c)*d,mobs[b].y+Math.sin(c)*d,1,{radius:1.5*Math.random()+1})}}}function addBlood(a,b,c,d){a={x:a,y:b,type:c,opacity:1};0===c?a.dir=d.dir:1===c&&(a.radius=d.radius);blood.push(a)}function drawBlood(a,b,c,d,e){a.beginPath();a.arc(b,c,0.25*e,0,2*Math.PI,!1);a.arc(b-3,c+3,0.25*e,0,2*Math.PI,!1);a.arc(b-4,c,0.25*e,0,2*Math.PI,!1);b+=0.25*Math.cos(Math.radians(d))*e;c+=0.25*Math.sin(Math.radians(d))*e;for(var f=0;15>f;f++){var g=80*Math.random()-40,k=Math.random()*e+0.5*e,h=Math.random()*(e/3)-e/6;a.moveTo(b,c+h);a.lineTo(b+Math.cos(Math.radians(d+g))*k,c+Math.sin(Math.radians(d+g))*k)}a.closePath();a.strokeStyle="red";a.fillStyle="red";a.stroke();a.fill()}function drawHealthbar(a,b,c,d,e,f){a.beginPath();a.rect(b-e/2,c,e*(d/100),f);a.fillStyle=63<d?"green":37<d?"gold":13<d?"orange":"red";a.closePath();a.fill()}function drawChar(a,b,c,d,e,f){f?(a.fillStyle="grey",a.strokeStyle="black",a.fillRect(b+6,c-12,4,14),a.rect(b+6,c-12,4,14),a.strokeStyle="black",a.stroke()):drawEllipseByCenter(a,b+8,c-5,4,20,"black","lightgrey");drawEllipseByCenter(a,b,c,26,14,d,e);drawEllipseByCenter(a,b,c,10,10,"black","#FFDFC4")}function drawEllipseByCenter(a,b,c,d,e,f,g){drawEllipse(a,b-d/2,c-e/2,d,e,f,g)}function drawEllipse(a,b,c,d,e,f,g){var k=0.5522848*(d/2),h=0.5522848*(e/2),l=b+d,m=c+e;d=b+d/2;e=c+e/2;a.beginPath();a.moveTo(b,e);a.bezierCurveTo(b,e-h,d-k,c,d,c);a.bezierCurveTo(d+k,c,l,e-h,l,e);a.bezierCurveTo(l,e+h,d+k,m,d,m);a.bezierCurveTo(d-k,m,b,e+h,b,e);a.fillStyle=g;a.fill();a.strokeStyle=f;a.stroke()}function start_game(){game_state=1;drawText("Generating level ...",gCanvas.width/2,gCanvas.height/2+33,{textSize:20});level_data=generate_level(ww,wh);console.log(level_data);mCanvas=document.getElementById("map");mCanvas.width=ww;mCanvas.height=wh;mCtx=mCanvas.getContext("2d");mCtx.putImageData(level_data.map,0,0);delete level_data.map;eCanvas=document.getElementById("entities");eCanvas.width=ww;eCanvas.height=wh;eCtx=eCanvas.getContext("2d");sCanvas=document.getElementById("shadow");sCanvas.width=ww;sCanvas.height=wh;sCtx=sCanvas.getContext("2d");lCanvas=document.getElementById("lights");lCanvas.width=ww;lCanvas.height=wh;lCtx=lCanvas.getContext("2d");fxCanvas=document.getElementById("fx");fxCanvas.width=ww;fxCanvas.height=wh;fxCtx=fxCanvas.getContext("2d");eaCanvas=document.getElementById("entities_addons");eaCanvas.width=ww;eaCanvas.height=wh;eaCtx=eaCanvas.getContext("2d");enemyCanvas=document.createElement("canvas");enemyCanvas.width=26*(bosses.length+1);enemyCanvas.height=28;enemyCtx=enemyCanvas.getContext("2d");drawChar(enemyCtx,13,14,"black","darkred",!0);for(var a=1;a<=bosses.length;a++)drawChar(enemyCtx,13+26*a,14,"black",bosses[a-1][2],!0);bloodCanvas=document.createElement("canvas");bloodCanvas.width=64;bloodCanvas.height=32;bloodCtx=bloodCanvas.getContext("2d");drawBlood(bloodCtx,16,16,0,16);view_distance=ww/4-5*player.kills;view_distance=125<view_distance?view_distance:125;player.x=ww/2;player.y=wh/2;player.angle=0;player.kills=0;player.speed=3;player.running=1;player.damage=5;for(a=player.score=0;8>a;a++)spawn_mob();spawn_more_mobs();draw_gui();loop()}function restart_game(){eCtx.clearRect(0,0,ww,wh);sCtx.clearRect(0,0,ww,wh);lCtx.clearRect(0,0,ww,wh);eaCtx.clearRect(0,0,ww,wh);fxCtx.clearRect(0,0,ww,wh);mobs=[];blood=[];level=1;start_game()}function end_game(){game_state=2;drawText("Game Over",ww/2,wh/2-100,{textSize:40});drawText("Your score: "+player.score+" (kills: "+player.kills+")",ww/2,wh/2-50,{textSize:20});drawText("Press space to restart the game",ww/2,wh/2-10,{textSize:20})}function castLight(a,b,c,d,e){var f=lCtx.createRadialGradient(d,e,0,d,e,c);f.addColorStop(0,"rgba(240,230,140,1)");f.addColorStop(1,"rgba(240,230,140,0)");lCtx.fillStyle=f;lCtx.beginPath();lCtx.arc(d,e,c,Math.radians(a-b/2),Math.radians(a+b/2),!1);lCtx.moveTo(d,e);lCtx.lineTo(d+Math.cos(Math.radians(a-b/2))*c,e+Math.sin(Math.radians(a-b/2))*c);lCtx.lineTo(d+Math.cos(Math.radians(a+b/2))*c,e+Math.sin(Math.radians(a+b/2))*c);lCtx.lineTo(d,e);lCtx.closePath();lCtx.fill()}function draw_gui(){gCtx.clearRect(0,0,ww,wh);drawText("Level: "+level,20,wh-70,{textSize:20,textAlign:"left"});drawText("Score: "+player.score,20,wh-40,{textSize:20,textAlign:"left"})}function tick(){eCtx.clearRect(0,0,ww,wh);sCtx.clearRect(0,0,ww,wh);lCtx.clearRect(0,0,ww,wh);eaCtx.clearRect(0,0,ww,wh);fxCtx.clearRect(0,0,ww,wh);keys[87]&&(player.y-=player.speed*player.running*((10+level)/15));keys[65]&&(player.x-=player.speed*player.running*((10+level)/15));keys[83]&&(player.y+=player.speed*player.running*((10+level)/15));keys[68]&&(player.x+=player.speed*player.running*((10+level)/15));player.running=keys[16]?1:1;0>player.x-16&&(player.x=16);0>player.y-16&&(player.y=16);player.x+16>ww&&(player.x=ww-16);player.y+16>wh&&(player.y=wh-16);player.angle=Math.radians(toangle(player.x+document.getElementsByTagName("canvas")[0].offsetLeft,player.y+document.getElementsByTagName("canvas")[0].offsetTop,mouse.x,mouse.y));for(var a=0;a<blood.length;a++)0===blood[a].type?(fxCtx.save(),fxCtx.globalAlpha=blood[a].opacity,fxCtx.translate(blood[a].x,blood[a].y),fxCtx.rotate(Math.radians(blood[a].dir)),fxCtx.drawImage(bloodCanvas,-16,-16,64,32),fxCtx.restore()):1===blood[a].type&&(fxCtx.beginPath(),fxCtx.globalAlpha=blood[a].opacity,fxCtx.arc(blood[a].x,blood[a].y,blood[a].radius,0,2*Math.PI,!1),fxCtx.closePath(),fxCtx.fillStyle="red",fxCtx.fill()),blood[a].opacity-=0.005,0>=blood[a].opacity&&blood.splice(a--,1);eCtx.save();eCtx.translate(player.x,player.y);eCtx.rotate(player.angle+Math.PI/2);drawChar(eCtx,0,0,"#0066FF","#6699FF");eCtx.restore();view_distance=ww/4-5*player.kills;view_distance=125<view_distance?view_distance:125;for(a=0;a<mobs.length;a++)mobs[a].update(),mobs[a].render();sCtx.beginPath();sCtx.rect(0,0,ww,wh);a=sCtx.createRadialGradient(player.x,player.y,100,player.x,player.y,view_distance);a.addColorStop(0,"rgba(0, 0, 0, 0)");a.addColorStop(1,"rgba(0, 0, 0, 1");sCtx.fillStyle=a;sCtx.fill()}function loop(){1===game_state&&(requestAnimFrame(loop),tick())}window.onload=function(){core_init()};