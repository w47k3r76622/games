const t="error:";class s{constructor(s,i,h){this.t=this.s(s,s.VERTEX_SHADER,i),this.i=this.s(s,s.FRAGMENT_SHADER,h),this.h=s.createProgram(),s.attachShader(this.h,this.t),s.attachShader(this.h,this.i),s.linkProgram(this.h),s.getProgramParameter(this.h,s.LINK_STATUS)||alert(t+s.getProgramInfoLog(this.h)),this.l={o:{u:s.getAttribLocation(this.h,"p"),color:s.getAttribLocation(this.h,"c"),p:s.getAttribLocation(this.h,"l"),g:s.getAttribLocation(this.h,"u")},m:{v:s.getUniformLocation(this.h,"pm"),M:s.getUniformLocation(this.h,"mvm"),k:s.getUniformLocation(this.h,"h"),A:s.getUniformLocation(this.h,"s")}}}s(s,i,h){const e=s.createShader(i);return s.shaderSource(e,h),s.compileShader(e),s.getShaderParameter(e,s.COMPILE_STATUS)?e:(alert(t+s.getShaderInfoLog(e)),s.deleteShader(e),null)}}function i(){let t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function h(){let t=new Float32Array(4);return t[3]=1,t}function e(t,s,i,h){let e=.5*Math.PI/180;s*=e,i*=e,h*=e;let r=Math.sin(s),n=Math.cos(s),a=Math.sin(i),l=Math.cos(i),o=Math.sin(h),c=Math.cos(h);return t[0]=r*l*c-n*a*o,t[1]=n*a*c+r*l*o,t[2]=n*l*o-r*a*c,t[3]=n*l*c+r*a*o,t}function r(t,s,i){i*=.5;let h=s[0],e=s[1],r=s[2],n=s[3],a=Math.sin(i),l=Math.cos(i);return t[0]=h*l+n*a,t[1]=e*l+r*a,t[2]=r*l-e*a,t[3]=n*l-h*a,t}function n(t,s,i){i*=.5;let h=s[0],e=s[1],r=s[2],n=s[3],a=Math.sin(i),l=Math.cos(i);return t[0]=h*l-r*a,t[1]=e*l+n*a,t[2]=r*l+h*a,t[3]=n*l-e*a,t}class a{constructor(t,s,e,r){this.T=t,this.C=i(),this.position={x:s,y:e,z:r},this.F=0,this.P(),this.I(),this.S=h()}rotate(t){this.F+=t,this.R()}D(t){this.F=t*Math.PI/180,this.R()}R(){this.F=this.F%(2*Math.PI),this.F<0&&(this.F=2*Math.PI),e(this.S,0,this.L(),0)}L(){return this.F*(180/Math.PI)}B(){return this.S}W(t){this.position=t,this.P(),this.I()}P(){return function(t,s,i,h,e){let r,n=1/Math.tan(s/2);return t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=e&&e!==1/0?(r=1/(h-e),t[10]=(e+h)*r,t[14]=2*e*h*r):(t[10]=-1,t[14]=-2*h),t}(this.C,64*Math.PI/180,this.T.canvas.clientWidth/this.T.canvas.clientHeight,.1,30)}U(){return{x:Math.sin(this.F),y:0,z:Math.cos(this.F)}}I(){!function(t,s,i){let h=Math.sin(i),e=Math.cos(i),r=s[0],n=s[1],a=s[2],l=s[3],o=s[8],c=s[9],u=s[10],d=s[11];s!==t&&(t[4]=s[4],t[5]=s[5],t[6]=s[6],t[7]=s[7],t[12]=s[12],t[13]=s[13],t[14]=s[14],t[15]=s[15]),t[0]=r*e-o*h,t[1]=n*e-c*h,t[2]=a*e-u*h,t[3]=l*e-d*h,t[8]=r*h+o*e,t[9]=n*h+c*e,t[10]=a*h+u*e,t[11]=l*h+d*e}(this.C,this.C,-this.F),function(t,s,i){let h,e,r,n,a,l,o,c,u,d,p,g,f=i[0],w=i[1],m=i[2];s===t?(t[12]=s[0]*f+s[4]*w+s[8]*m+s[12],t[13]=s[1]*f+s[5]*w+s[9]*m+s[13],t[14]=s[2]*f+s[6]*w+s[10]*m+s[14],t[15]=s[3]*f+s[7]*w+s[11]*m+s[15]):(h=s[0],e=s[1],r=s[2],n=s[3],a=s[4],l=s[5],o=s[6],c=s[7],u=s[8],d=s[9],p=s[10],g=s[11],t[0]=h,t[1]=e,t[2]=r,t[3]=n,t[4]=a,t[5]=l,t[6]=o,t[7]=c,t[8]=u,t[9]=d,t[10]=p,t[11]=g,t[12]=h*f+a*w+u*m+s[12],t[13]=e*f+l*w+d*m+s[13],t[14]=r*f+o*w+p*m+s[14],t[15]=n*f+c*w+g*m+s[15])}(this.C,this.C,[-this.position.x,-this.position.y,-this.position.z])}}class l{constructor(t,s){this.H=t.createTexture();let i=new Image;i.onload=()=>{t.bindTexture(t.TEXTURE_2D,this.H),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)},i.src=s}}class o{constructor(t,s,i,h,e){this.x=s,this.y=i,this.width=h,this.height=e,this.N=t,this.V=!0}_(){if(this.V){let t=1/65,s=1/65,i=this.x*t%1,h=this.y*s%1,e=this.width*t+i,r=this.height*s+h;this.Y=[[i,r,0],[e,r,0],[e,h,0],[i,h,0]],this.V=!1}return this.Y}}class c{static j;static k;static G;static K;static X;static q;static O;static floor;static J;static Z;static $;static tt;static st;static it;static ht;static et;constructor(t,s){this.rt=s,this.T=t,this.V=!0,c.j=new a(t),c.j.D(180),this.nt=new l(t,"a.png"),c.G=this.at(16,16,16,16),c.K=this.at(16,48,16,16),c.X=this.at(3,35,10,10),c.q=this.at(48,16,16,16),c.floor=this.at(0,32,16,16),c.J=this.at(32,32,15,15),c.tt=this.at(0,20,6,6),c.$=this.at(7,20,6,6),c.st=this.at(32,0,15,15),c.it=this.at(1,49,12,13),c.ht=this.at(1,28,1,1),c.et=this.at(0,27,5,5),c.Z=this.at(34,17,12,14),c.wand=this.at(18,34,13,12),c.O=new Array;for(let t=0;t<2;t++)c.O.push(new o(this.nt,16*t,0,16,14));c.k=0}at(t,s,i,h){return new o(this.nt,t,s,i,h)}lt(){this.V||(this.ot.lt(this.T,this.rt,c.j.C,this.nt,c.k),this.ct.lt(this.T,this.rt,c.j.C,this.nt,c.k),this.ut.lt(this.T,this.rt,c.j.C,this.nt,c.k))}dt(t){t.lt(this.T,this.rt,c.j.C,c.k)}pt(t){t.lt(this.T,this.rt,c.j.C,c.k,!0)}}class u{constructor(t){this.N=t,this.gt=!0,this.height=2,this.ft=0}_(){return this.N._()}wt(t){return!0}vt(t){return!1}yt(t){return this.height=t,this}Mt(t){return this.ft=t,this}xt(t){return this.gt=t,this}}class d extends u{constructor(t){super(t)}vt(t){return!0}}class p extends u{constructor(){super()}wt(t){return!1}}class g extends u{constructor(){super(c.ht),this.yt(2),this.Mt(-.9),this.xt(!1)}wt(t){return"pp"!=t.n&&"ba"!=t.n}}class f{static kt;static bt;static At;static p;static ht;static zt;constructor(){f.At=new d(c.G).yt(3).Mt(0),f.Tt=new d(c.K).yt(3).Mt(0),f.kt=(new p).xt(!1),f.p=new p,f.ht=new g,f.zt=(new g).yt(1).Mt(-.9).xt(!1)}}class w{constructor(t,s,i,h,e,r){this.n=t,this.Ct={x:s,y:i,z:h},this.Ft=e,this.Et=.4,this.Pt=0,this.It=r,this.St=!0,this.reset()}reset(){this.Rt={x:this.Ct.x,y:this.Ct.y,z:this.Ct.z},null==this.Ft||0==this.Ft?this.Dt=!0:(this.Lt=this.Ft,this.Bt=this.Ft),this.Wt=!1,this.Ut=!0,this.Ht={x:0,z:0},this.Nt=Math.round(this.Rt.x),this.Vt=Math.round(this.Rt.z)}_t(t){this.Lt+=t}Yt(t,s,i){if(this.Pt>=.5){let t=s.Rt.x-this.Rt.x,h=s.Rt.z-this.Rt.z;this.Pt=0,this.jt(t,h),this.Lt-=i}}Gt(t){this.Wt=!0,this.Kt(t,this.Nt,this.Vt),this.St?this.Qt=40+40*this.Xt():t.qt(this)}Ot(){return this.St=!1,this}Jt(t,s){if(this.Wt)return void(this.Qt>0?this.Qt-=t:(this.Qt=0,this.reset()));if(this.Ut&&(this.Zt(s,this.Nt,this.Vt),this.Ut=!1),this.Lt<=0&&!this.Dt&&this.Gt(s),this.Ht.x>-.2&&this.Ht.x<.2&&(this.Ht.x=0),this.Ht.z>-.2&&this.Ht.z<.2&&(this.Ht.z=0),0!=this.Ht.x||0!=this.Ht.z){let i=this.Rt.x-5*this.Ht.x*t,h=this.Rt.z-5*this.Ht.z*t;this.$t(s,i,this.Rt.z)&&(this.Rt.x=i),this.$t(s,this.Rt.x,h)&&(this.Rt.z=h),this.Ht.x/=65*t,this.Ht.z/=65*t}this.Pt+=t;let i=Math.round(this.Rt.x),h=Math.round(this.Rt.z);this.Nt!=i&&(this.Kt(s,this.Nt,this.Vt),this.Nt=i,this.Zt(s,this.Nt,this.Vt)),this.Vt!=h&&(this.Kt(s,this.Nt,this.Vt),this.Vt=h,this.Zt(s,this.Nt,this.Vt));for(let t=this.Nt-2;t<this.Nt+2;t++)for(let i=this.Vt-2;i<this.Vt+2;i++){let h=s.ts(t,i);null!=h&&h.ss().forEach(t=>{t!=this&&t.hs(this,s)})}}hs(t,s){}es(t,s){}rs(t,s){}Zt(t,s,i){t.ts(s,i).ns(this)}Kt(t,s,i){t.ts(s,i).as(this)}jt(t,s){0==this.Ht.x&&0==this.Ht.z&&(this.Ht.x=t,this.Ht.z=s,this.normalize(this.Ht))}lt(t,s,i,h){}$t(t,s,i){let h=Math.round(s+this.Et),e=Math.round(i+this.Et),r=Math.round(s-this.Et),n=Math.round(i-this.Et);return!t.ls(h,e).wt(this)&&(!t.ls(r,e).wt(this)&&(!t.ls(h,n).wt(this)&&!t.ls(r,n).wt(this)))}normalize(t){let s=t.x*t.x+t.z*t.z;s>0&&(s=1/Math.sqrt(s)),t.x*=s,t.z*=s}os(t,s){let i=t.x-s.x,h=t.z-s.z;return Math.hypot(i,h)}cs(t){return this.os(this.Rt,t.Rt)}Xt(){return Math.random()}}class m{constructor(){this.is=new Array(3),this.us=1,this.ds=0}Jt(){let t=Z.ps;for(let s=49;s<52;s++)t.gs(s)&&(this.us=3-(51-s))}fs(t){this.ds>0&&(this.ms(3).ws(t),this.ds--,this.ds<=0&&(this.is[2]=null))}vs(t,s){"dagger"==s.n?this.ys(t,0,s):"wand"==s.n?this.ys(t,1,s):(this.is[2]=s,this.ds++)}ys(t,s,i){null!=this.is[s]?(this.Ms(t,"Replaced "+this.is[s].n+" ("+this.is[s].xs()+" damage)"," with "+i.n+" ("+i.xs()+" damage)"),this.is[s]=i):this.is[s]=i}Ms(t,s,i){t.ks(s,i,4)}bs(t){if(3==t)return this.ds--,void(this.ds<=0&&(this.is[2]=null));this.is[t-1]=null}ms(t){return this.is[t-1]}}const v=[0,1,2,0,2,3];class y{constructor(t,s,e,r){this.As=[],this.M=i(),this.position={x:s,y:e,z:r},this.scale=[1,1,1],this.T=t,this.S=h(),this.zs=0,this.Ts=0,this.arrayBuffer=t.ARRAY_BUFFER,this.Cs=t.DYNAMIC_DRAW,this.Fs=t.ELEMENT_ARRAY_BUFFER,this.Es=t.FLOAT,this.Ps=t.createBuffer(),this.Is=t.createBuffer(),this.Ss=t.createBuffer(),this.Rs=t.createBuffer(),this.Ds=t.createBuffer()}Ls(t,s,i,h){t.forEach(t=>{this.As.push(t)}),this.Bs(s),this.Ws(i),this.Us(h)}Hs(){let t=this.As.length/6;this.Ns=new Float32Array(3*this.As.length),this.Vs=new Float32Array(4*this.As.length),this._s=new Float32Array(8*this.As.length),this.Ys=new Uint16Array(6*t);let s=0,i=0;this.Ns.set(this.As);for(let h=0;h<t;h++){for(let t=0;t<6;t++)this.Ys[i+t]=v[t]+s;s+=4,i+=6}this.js=i,this.T.bindBuffer(this.arrayBuffer,this.Ps),this.T.bufferData(this.arrayBuffer,this.Ns,this.Cs),this.Gs(),this.Ks(),this.Qs(),this.T.bindBuffer(this.Fs,this.Ds),this.T.bufferData(this.Fs,this.Ys,this.Cs)}Xs(t,s,i){this.position.x+=t,this.position.y+=s,this.position.z+=i,this.qs()}W(t,s,i){this.position.x=t,this.position.y=s,this.position.z=i,this.qs()}Os(t){this.scale[0]=t,this.scale[1]=t,this.scale[2]=t,this.qs()}Js(t){r(this.S,this.S,t),this.qs()}Zs(t){n(this.S,this.S,t),this.qs()}$s(t){this.S=t,this.qs()}ti(t){this.zs=t,e(this.S,this.zs,this.Ts,0),this.qs()}si(t){this.Ts=t,e(this.S,this.zs,this.Ts,0),this.qs()}qs(){!function(t,s,i,h){let e=s[0],r=s[1],n=s[2],a=s[3],l=e+e,o=r+r,c=n+n,u=e*l,d=e*o,p=e*c,g=r*o,f=r*c,w=n*c,m=a*l,v=a*o,y=a*c,M=h[0],x=h[1],k=h[2];t[0]=(1-(g+w))*M,t[1]=(d+y)*M,t[2]=(p-v)*M,t[3]=0,t[4]=(d-y)*x,t[5]=(1-(u+w))*x,t[6]=(f+m)*x,t[7]=0,t[8]=(p+v)*k,t[9]=(f-m)*k,t[10]=(1-(u+g))*k,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1}(this.M,this.S,[this.position.x,this.position.y,this.position.z],this.scale)}Bs(t){this.ii=[],t.forEach(t=>{t.forEach(t=>{this.ii.push(t)})})}Us(t){this.hi=[],t.forEach(t=>{t.forEach(t=>{this.hi.push(t)})})}Ws(t){this.Y=[],t.forEach(t=>{this.Y.push(t)})}Gs(){this.Vs.set(this.ii),this.T.bindBuffer(this.arrayBuffer,this.Is),this.T.bufferData(this.arrayBuffer,this.Vs,this.Cs)}Ks(){this.ei=new Float32Array(4*this.As.length),this.ei.set(this.hi),this.T.bindBuffer(this.arrayBuffer,this.Ss),this.T.bufferData(this.arrayBuffer,this.ei,this.Cs)}Qs(){let t=0;this.Y.forEach(s=>{this._s[t]=s[0],this._s[t+1]=s[1],t+=2}),this.T.bindBuffer(this.arrayBuffer,this.Rs),this.T.bufferData(this.arrayBuffer,this._s,this.Cs)}lt(t,s,i,h,e,r,n){null!=r&&(this.Ws(r),this.Qs()),null!=n&&(this.Bs(n),this.Gs()),t.bindBuffer(this.arrayBuffer,this.Ps),t.vertexAttribPointer(s.l.o.u,3,this.Es,!1,0,0),t.enableVertexAttribArray(s.l.o.u),t.bindBuffer(this.arrayBuffer,this.Is),t.vertexAttribPointer(s.l.o.color,4,this.Es,!1,0,0),t.enableVertexAttribArray(s.l.o.color),t.bindBuffer(this.arrayBuffer,this.Ss),t.vertexAttribPointer(s.l.o.p,4,this.Es,!1,0,0),t.enableVertexAttribArray(s.l.o.p),t.bindBuffer(this.arrayBuffer,this.Rs),t.vertexAttribPointer(s.l.o.g,2,this.Es,!1,0,0),t.enableVertexAttribArray(s.l.o.g),t.useProgram(s.h),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,h.H),t.uniform1i(s.l.m.A,0),t.uniform1f(s.l.m.k,e),t.uniformMatrix4fv(s.l.m.v,!1,i),t.uniformMatrix4fv(s.l.m.M,!1,this.M),t.bindBuffer(this.Fs,this.Ds),t.drawElements(t.TRIANGLES,this.js,t.UNSIGNED_SHORT,0)}}const M=[1,1,1,1];class x{static start(t,s,i,h){return{ri:new y(t,s,i,h),As:[],ni:[],Y:[],hi:[]}}static ai(t,s){null==s&&(s=M),t.push(s,s,s,s)}static li(t,s){let i=[s,s,s,1];t.push(i,i,i,i)}static oi(t){return t.ri.Ls(t.As,t.ni,t.Y,t.hi),t.ri.Hs(),t.ri}static left(t,s,i,h,e,r,n,a,l){null==n&&(n=1),null!=a&&(h+=a);for(let a=0;a<n;a++)x.ai(s.ni,l),x.li(s.hi,r),t.forEach(t=>{s.Y.push(t)}),s.As.push(i-.5,h+a-.5,e-.5,i-.5,h+a-.5,e+.5,i-.5,h+a+.5,e+.5,i-.5,h+a+.5,e-.5)}static right(t,s,i,h,e,r,n,a,l){null==n&&(n=1),null!=a&&(h+=a);for(let a=0;a<n;a++)x.ai(s.ni,l),x.li(s.hi,r),t.forEach(t=>{s.Y.push(t)}),s.As.push(i+.5,h+a-.5,e-.5,i+.5,h+a+.5,e-.5,i+.5,h+a+.5,e+.5,i+.5,h+a-.5,e+.5)}static ci(t,s,i,h,e,r,n,a,l){null==n&&(n=1),null!=a&&(h+=a);for(let a=0;a<n;a++)x.ai(s.ni,l),x.li(s.hi,r),t.forEach(t=>{s.Y.push(t)}),s.As.push(i-.5,h+a-.5,e+.5,i+.5,h+a-.5,e+.5,i+.5,h+a+.5,e+.5,i-.5,h+a+.5,e+.5)}static back(t,s,i,h,e,r,n,a,l){null==n&&(n=1),null!=a&&(h+=a);for(let a=0;a<n;a++)x.ai(s.ni,l),x.li(s.hi,r),t.forEach(t=>{s.Y.push(t)}),s.As.push(i-.5,h+a-.5,e-.5,i-.5,h+a+.5,e-.5,i+.5,h+a+.5,e-.5,i+.5,h+a-.5,e-.5)}static top(t,s,i,h,e,r,n,a){null!=n&&(h+=n),x.ai(s.ni,a),x.li(s.hi,r),t.forEach(t=>{s.Y.push(t)}),s.As.push(i-.5,h-.5,e-.5,i+.5,h-.5,e-.5,i+.5,h-.5,e+.5,i-.5,h-.5,e+.5)}static bottom(t,s,i,h,e,r,n,a){null!=n&&(h+=n),x.ai(s.ni,a),x.li(s.hi,r),t.forEach(t=>{s.Y.push(t)}),s.As.push(i-.5,h+.5,e-.5,i-.5,h+.5,e+.5,i+.5,h+.5,e+.5,i+.5,h+.5,e-.5)}}class k extends w{constructor(t,s,i,h,e,r,n,a){super(t,s,i,h,n,a),e instanceof Array?(this.ui=!0,this.di=e.length,this.N=e[0],this.pi=e,this.gi=0,this.fi=0):(this.N=e,this.ui=!1),this.c=this.wi=[1,1,1,1],this.p=.7,this.mi=0,this.vi=!1;let l=x.start(r,s,i,h);x.ci(this.N._(),l,0,0,0,this.p,1),this.ri=x.oi(l)}yi(t){this.c=t,this.Mi=!0}Os(t){return this.ri.Os(t),this}Yt(t,s,i){this.Pt>=.3&&(this.yi([1,0,0,1]),this.mi=.5,this.vi=!0),super.Yt(t,s,i)}Jt(t,s){super.Jt(t,s),this.vi&&this.mi>0&&(this.mi-=t),this.vi&&this.mi<=0&&(this.yi(this.wi),this.vi=!1),this.ri.W(this.Rt.x,this.Rt.y,this.Rt.z),this.ui&&(this.fi+=t,this.fi>=.24&&(this.xi=!0,this.gi++,this.gi>this.di-1&&(this.gi=0),this.N=this.pi[this.gi],this.fi=0))}lt(t,s,i,h){this.Wt||(this.xi?(this.ri.lt(t,s,i,this.N.N,h,this.N._()),this.xi=!1):(this.ri.lt(t,s,i,this.N.N,h,null,this.Mi?[this.c,this.c,this.c,this.c]:null),this.Mi=!1))}}class b extends k{constructor(t,s,i,h,e,r,n,a){super(t,s,i,h,e,r,n,a)}Jt(t,s){super.Jt(t,s),this.ri.$s(c.j.B())}ki(t,s){let i=new A(s,this.Rt.x,-.2,this.Rt.z,s.N,t.T).Ot();t.bi(i)}}class A extends b{constructor(t,s,i,h,e,r){super(t.n,s,i,h,e,r,1),this.Ai=t,this.yi(t.c),this.zi=0,this.Et=.1,this.ri.Os(t.Ti)}hs(t,s){this.Wt||"p"==t.n&&this.cs(t)<1&&(s.ks("Press Shift: Pickup","dagger"==this.n||"wand"==this.n?this.n+" ("+this.Ai.xs()+" damage)":this.n,.1),Z.ps.gs(16)&&(t.Ci(s,this.Ai),this.Gt(s)))}Jt(t,s){super.Jt(t,s),this.zi+=t;let i=Math.sin(3*this.zi)/400;this.Rt.y+=i}}class z extends b{constructor(t,s,i,h,e,r,n,a,l,o,c){super("pa",t,s,i,h,e,r,0),this.Fi=n,this.Ei=a,this.Pi=l,this.Os(o),this.yi(c),this.Ot()}Jt(t,s){this.Lt-=t,this.Rt.x+=this.Fi*t,this.Rt.y+=this.Ei*t,this.Rt.z+=this.Pi*t,super.Jt(t,s)}}class T extends b{constructor(t,s,i,h,e,r,n,a,l){super("pp",t,s,i,c.et,h,0),this.ri.Os(.15),this.Et=.2,this.Ii=e,this.Si=r,this.Ri=.2,this.yi(l),this.St=!1,this.Di=n,this.source=a}Jt(t,s){super.Jt(t,s),this.Ri+=t,this.$t(s,this.Rt.x+this.Ii*t,this.Rt.z+this.Si*t)?(this.Rt.x+=this.Ii*t,this.Rt.z+=this.Si*t):this.Gt(s),this.Ri>=.1&&(s.bi(new z(this.Rt.x-.3+this.Xt()/5,.2+this.Xt()/5,this.Rt.z-.3+this.Xt()/5,c.ht,s.T,.15,this.Li(),this.Li(),this.Li(),.05,this.c)),this.Ri=0)}Li(){return(2*this.Xt()-1)/5}}const C={x:0,y:1,z:0},F={x:0,y:-1,z:0};class E extends w{constructor(t,s,i){super("p",t,s,i,5),this.Bi=!1,this.Wi=new m,this.Ui=!1,this.Hi=0,this.Ni=0,this.Vi=0,this._i=0,this.Pt=.5,this.Yi={x:0,z:0},this.ji={x:0,z:0},this.Gi={x:0,z:0}}Ki(t){t.ks("Respawned","",2),this.Lt=this.Ft,this.Rt.x=this.Qi.x,this.Rt.z=this.Qi.z}Jt(t,s){if(super.Jt(t,s),this.Lt<=0||s.Xi)return s.Xi&&(this.Ai=null),c.j.rotate(.15*t),c.j.W(this.Rt),void(Z.ps.gs(32)&&!s.Xi&&Z.qi());if(c.k=this.Pt<.1?1:0,this.Wi.Jt(t,s),this.Ai=this.Wi.ms(this.Wi.us),this.Ui&&this.Hi>0&&(this.Hi-=t),this.Hi<=0&&(this.Ui=!1),this.Ni>0&&(this.Ni-=t),0==this.Ht.x||0==this.Ht.z){this.Yi.x=0,this.Yi.z=0,this.ji.x=0,this.ji.z=0;let i=Z.ps;this.zi+=t,c.j.rotate(i.Oi()/9*t);let h=c.j.U();i.gs(87)&&(this.Yi.z=-1),i.gs(83)&&(this.Yi.z=1),i.gs(65)&&this.Ji(this.ji,h,C),i.gs(68)&&this.Ji(this.ji,h,F),i.Zi()&&this.Hi<=0?(this.Bi=this.Ui=!0,this.Hi=.3,this.attack(s)):this.Bi=!1,i.gs(69)&&this.fs(),i.gs(81)&&(this.$i(s),i.th[81]=!1),0==this.Yi.x&&0==this.Yi.z&&0==this.ji.x&&0==this.ji.z||(this.Gi.x=h.x*this.Yi.z+this.ji.x,this.Gi.z=h.z*this.Yi.z+this.ji.z,this.normalize(this.Gi),this.Gi.x*=2.5*t,this.Gi.z*=2.5*t,this.Gi.x+=this.Rt.x,this.Gi.z+=this.Rt.z,this.$t(s,this.Gi.x,this.Rt.z)&&(this.Rt.x+=this.Gi.x-this.Rt.x),this.$t(s,this.Rt.x,this.Gi.z)&&(this.Rt.z+=this.Gi.z-this.Rt.z))}if(null!=this.Ai&&(this.Lt>0||!s.Xi)){let t={x:this.Rt.x-c.j.U().x/4,y:0,z:this.Rt.z-c.j.U().z/4};this.Ui?this.Ai.sh(t,.1):this.Ai.ih(t,.11)}c.j.W(this.Rt),32==Math.round(this.Rt.x)&&47==Math.round(this.Rt.z)&&s.ks("Prepare for boss fight!","",4)}Ji(t,s,i){return t.x=s.y*i.z-s.z*i.y,t.y=s.z*i.x-s.x*i.z,t.z=s.x*i.y-s.y*i.x,t}Gt(t){t.ks("You have died.","Press space to try again")}$i(t){if(null!=this.Ai){let s=new A(this.Ai,this.Rt.x-c.j.U().x/2,-.2,this.Rt.z-c.j.U().z/2,this.Ai.N,t.T);s.jt(c.j.U().x,c.j.U().z),t.bi(s),this.Wi.bs(this.Wi.us)}}hh(){this.Wi.bs(this.Wi.us)}Ci(t,s){Z.eh(350,.1),this.Wi.vs(t,s),"dagger"==s.n&&this.Vi<s.level&&(this.Vi=s.level),"wand"==s.n&&this._i<s.level&&(this._i=s.level)}fs(){this.Lt<this.Ft&&this.Ni<=0&&(this.Wi.fs(this),this.Ni=.2)}hs(t,s){s.Xi||(super.hs(t,s),("ba"==t.n||"pp"==t.n&&t.source!=this)&&this.cs(t)<.6&&this.Pt>=1&&(Z.eh(60,.3),super.jt(t.Rt.x-2*this.Rt.x,t.Rt.z-2*this.Rt.z),this.Yt(s,t,1)))}rh(t,s){this.nh=this.Qi,this.Qi={x:t,z:s}}ah(){this.Qi=this.nh}attack(t){null!=this.Ai&&("wand"==this.Ai.n?t.bi(new T(this.Rt.x-c.j.U().x,.3,this.Rt.z-c.j.U().z,t.T,7*-c.j.U().x,7*-c.j.U().z,this.Ai.xs(),this,[.3,.3,0,1])):this.lh(t,t.ts(Math.round(this.Rt.x-c.j.U().x),Math.round(this.Rt.z-c.j.U().z)))||this.lh(t,t.ts(Math.round(this.Rt.x-2*c.j.U().x),Math.round(this.Rt.z-2*c.j.U().z))))}lh(t,s){return s.ss().forEach(s=>{if(s!=this)return"ba"==s.n||"po"==s.n||"b"==s.n?(s.Yt(t,this,this.Ai.xs()),!0):void 0}),!1}}class P extends b{constructor(t,s,i,h,e){super("ba",t,s,i,c.O,h,252==e?150:253==e?6:5,e),this.ri.Os(252==e?3:253==e?1:.5),this.zi=0,this.random=this.Xt(),this.Et=252==e?.6:.2,this.fi=Math.round(this.random),this.c=this.wi=252==e?[.6,.6,1,1]:253==e?[0,.8,0,1]:[1,1,1,1],this.Mi=!0,this.oh=0,this.uh=252==this.It?2:5,this.p=1}Jt(t,s){if(252==this.It&&this.Lt<=0&&(this.Qt=20,s.Xi=!0),super.Jt(t,s),0!=this.Ht.x||0!=this.Ht.z)return;this.zi+=t;let i=Math.sin(4*this.zi*.9+this.random)/100,h=Math.cos(.7*this.zi+this.random)/50,e=0;e=this.random<.5?Math.cos(this.zi/2*.9+this.random)/30:Math.sin(this.zi/2*.9+this.random)/30,this.$t(s,h+this.Rt.x,e+this.Rt.z)?(this.Rt.x+=h,this.Rt.y+=i,this.Rt.z+=e):this.Rt.y+=i,this.It<254&&(this.oh+=t,this.oh>=this.uh&&(this.cs(s.dh)<this.It==252||10)&&(this.oh=0,this.ph(s)))}hs(t,s){super.hs(t,s),"pp"==t.n&&t.source!=this&&this.cs(t)<1.3&&this.Pt>=.5&&this.Yt(s,t,t.Di)}Gt(t){252==this.It&&t.ks("The bat drops dead revelaing a note that says","04 is in another dungeon. /Thanks for playing",500),this.gh(t,.12,-.8),this.Xt()<.15&&t.ls(Math.round(this.Rt.x),Math.round(this.Rt.z))!=f.ht&&(254==this.It&&this.ki(t,t.fh(t.dh.Vi+1)),253==this.It&&this.ki(t,t.wh(t.dh._i+1))),Z.mh(.9),super.Gt(t),253==this.It&&(this.Qt=25*(this.Xt()+1))}ph(t){let s={x:t.dh.Rt.x-this.Rt.x,y:0,z:t.dh.Rt.z-this.Rt.z};this.normalize(s),t.bi(new T(this.Rt.x,.3,this.Rt.z,t.T,5*s.x,5*s.z,0,this,this.wi))}Yt(t,s,i){null!=i&&(this.Pt>=.3&&i>0&&(Z.eh(100,.2),this.gh(t,.02,-.4)),super.Yt(t,s,i))}gh(t,s,i,h,e){h=null==h?.8:h,e=null==e?5:e;for(let r=0;r<e;r++)t.bi(new z(this.Rt.x-.2+this.Xt()/3,.2,this.Rt.z-.2+this.Xt()/3,c.ht,t.T,h,0,i,0,s,[1,0,0,1]))}}class I extends k{constructor(t,s,i,h,e){super("br",t,s+1,i,c.J,h,0,e);let r=x.start(h,t,s+1,i);for(let t=0;t<4;t++)for(let s=0;s<8;s++)x.ci(this.N._(),r,.24*t,-.24*s,0,this.p,1);this.ri=x.oi(r),this.ri.si(270),196==e&&(this.ri.si(180),this.Rt.z+=.5,this.ri.Xs(0,0,.5)),this.vh=199==e||197==e?2:191==e?3:196==e||193==e?4:1,this.yh=0,this.Mh=!1}es(t,s){super.es(t,s),s!=this&&(this.yh++,this.Mh||this.yh!=this.vh||(this.Rt.y+=1,196==this.It?t.xh(this.Rt.x,this.Rt.z-.5):t.xh(this.Rt.x,this.Rt.z),t.dh.rh(Math.round(this.Rt.x),Math.round(this.Rt.z)),this.Mh=!0))}rs(t,s){if(super.rs(t,s),s!=this&&(this.yh--,this.Mh)){if(253==this.It)return;this.Rt.y-=1,t.kh(this.Rt.x,this.Rt.z,new u),this.Mh=!1,t.dh.ah()}}Jt(t,s){super.Jt(t,s)}lt(t,s,i,h){t.disable(t.CULL_FACE),super.lt(t,s,i,h),t.enable(t.CULL_FACE)}}class S{constructor(){this.e=[]}ns(t){this.e.push(t)}as(t){for(let s=this.e.length-1;s>=0;s--)this.e[s]===t&&this.e.splice(s,1)}ss(){return this.e}}const R=[1,1,1,1],D=[0,1,1,1],L=[.5,.3,.5,1];class B{constructor(t,s,i,h,e,r,n,a){this.N=e,this.Rt={x:s,y:i,z:h},this.rotation={x:s,y:i,z:h},this.n=t,this.c=1==a?R:2==a?D:L,this.p=1,this.level=null==a?1:Math.min(a,3),this.bh=1,this.Ti=n;let l=x.start(r,s,i,h);x.ci(this.N._(),l,.75,0,0,this.p,1,null,this.c),this.ri=x.oi(l)}sh(t,s){this.ri.W(t.x,t.y+.22,t.z),this.Ah(-.8,-.4,.1),this.ri.Os(s)}xs(){return this.level*this.bh}ih(t,s){this.ri.W(t.x,t.y+.15,t.z),this.Ah(-.1,-0,.3),this.ri.Os(s)}Ah(t,s,i){let h=[c.j.B()[0],c.j.B()[1],c.j.B()[2],c.j.B()[3]];!function(t,s,i){i*=.5;let h=s[0],e=s[1],r=s[2],n=s[3],a=Math.sin(i),l=Math.cos(i);t[0]=h*l+e*a,t[1]=e*l-h*a,t[2]=r*l+n*a,t[3]=n*l-r*a}(h,h,i),n(h,h,s),r(h,h,t),this.ri.$s(h)}lt(t,s,i,h){this.ri.lt(t,s,i,this.N.N,h)}}class W extends B{constructor(t,s,i,h,e,r){super("dagger",t,s,i,c.Z,h,e,r),this.bh=1==r?1:2}}class U extends B{constructor(t,s,i,h,e,r){super("wand",t,s,i,c.wand,h,e,r),this.bh=1==r?2:4}}class H extends k{constructor(t,s,i,h,e){super("",t,s-.98,i,c.tt,h,0,e),200==e||198==e||197==e||this.It<195?this.yi([.5,.5,.6,1]):this.yi([.8,.6,.3,1]),this.ri.ti(-90),this.zi=0,this.zh=!1,this.Th=0}Jt(t,s){super.Jt(t,s),this.Th+=t,!this.zh&&this.Mh&&(this.Mh=!1,this.xi=!0,this.N=c.tt,s.rs(this.It,this),Z.eh(120,.1)),this.Th>.1&&(this.zh=!1)}hs(t,s){"ba"!=t.n&&"pp"!=t.n&&"pa"!=t.n&&((200==this.It||198==this.It||197==this.It||this.It<195)&&"b"!=t.n||this.cs(t)<.8&&(this.zh=!0,this.Th=0,this.Mh||(s.es(this.It,this),this.xi=!0,this.N=c.$,this.Mh=!0,Z.eh(150,.1))))}}class N extends b{constructor(t,s,i,h,e){super("po",t,s-.2,i,c.st,h,2,e),this.ri.Os(.6)}Gt(t){Z.mh(.9),this.Xt()<.17&&this.ki(t,t.Ch());for(let s=0;s<20;s++)t.bi(new z(this.Rt.x-.2+this.Xt()/3,-.2,this.Rt.z-.2+this.Xt()/3,c.ht,t.T,this.Xt(),0,this.Xt(),0,this.Xt()/7,this.Xt()<.5?[.6,.5,.4,1]:[.4,.3,.2,1]));super.Gt(t)}hs(t,s){super.hs(t,s),"pp"==t.n&&"p"==t.source.n&&this.cs(t)<.8&&this.Pt>=.5&&this.Yt(s,t,t.Di)}Yt(t,s,i){for(let s=0;s<5;s++)t.bi(new z(this.Rt.x-.2+this.Xt()/3,-.2,this.Rt.z-.2+this.Xt()/3,c.ht,t.T,this.Xt(),0,this.Xt(),0,this.Xt()/14,this.Xt()<.5?[.6,.5,.4,1]:[.4,.3,.2,1]));Z.mh(.5),super.Yt(t,s,i)}}class V extends B{constructor(t,s,i,h,e){super("Apple",t,s,i,c.it,h,e),this.St=!1}ws(t){t._t(1)}}const _=[.5,.5,.7,1];class Y extends w{constructor(t,s,i,h,e){super("b",t,s-.2,i,1,e);let r=x.start(h,t,s,i);this.N=c.X,x.left(this.N._(),r,0,0,0,1,1,0,_),x.right(this.N._(),r,0,0,0,1,1,0,_),x.back(this.N._(),r,0,0,0,1,1,0,_),x.ci(this.N._(),r,0,0,0,1,1,0,_),x.top(this.N._(),r,0,0,0,1,0,_),x.bottom(this.N._(),r,0,0,0,1,0,_),this.ri=x.oi(r),this.ri.Os(.5),this.Fh=-.5}Gt(t){this.Kt(t,this.Nt,this.Vt);for(let s=0;s<20;s++)t.bi(new z(this.Rt.x-.2+this.Xt()/3,-.2,this.Rt.z-.2+this.Xt()/3,c.ht,t.T,this.Xt(),0,this.Xt(),0,this.Xt()/7,[.25,.25,.35,1]));this.reset(),Z.mh(.9),t.ks("A new box appears","",3)}lt(t,s,i,h){this.ri.W(this.Rt.x,this.Rt.y-.1,this.Rt.z),this.ri.lt(t,s,i,this.N.N,h)}jt(t,s,i){this.Ht.x=t,this.Ht.z=s,this.normalize(this.Ht),this.Ht.x*=i,this.Ht.z*=i}hs(t,s){if(super.hs(t,s),"p"==t.n){if(this.Pt<.1)return;let s=t.Rt.x-this.Rt.x,i=t.Rt.z-this.Rt.z;this.cs(t)<.8&&(Z.mh(.2),this.jt(Math.round(s),Math.round(i),.75),this.Pt=0)}}}class j extends k{constructor(t,s,i,h,e){super("",t,s-1,i,c.floor,h,0,e),this.yh=0,this.vh=200==e?2:196==e?4:0,this.ri.ti(-90),this.Eh=!1}es(t,s){s!=this&&(this.yh++,this.yh==this.vh&&(t.xh(this.Rt.x,this.Rt.z),this.Eh=!0))}rs(t,s){s!=this&&this.yh--}lt(t,s,i,h){this.Eh&&super.lt(t,s,i,h)}}class G extends k{constructor(t,s,i,h,e){super("",t,s+.3,i,c.$,h.T,0,e),this.zi=3.5,this.Mh=!1,this.Ph=!1,this.ri.Os(.2),this.Ih=192==this.It?1+this.Xt():3.5}Sh(t,s,i,h){this.ri.si(t),this.dir=s,this.Rt.x+=i,this.Rt.z+=h,this.ri.Xs(i,0,h)}Jt(t,s){if(!this.Ph){let t=s.ls(this.Rt.x-1,this.Rt.z)==f.At,i=s.ls(this.Rt.x+1,this.Rt.z)==f.At,h=s.ls(this.Rt.x,this.Rt.z+1)==f.At,e=s.ls(this.Rt.x,this.Rt.z-1)==f.At;h&&this.Sh(180,{x:0,z:-3},0,.5),t&&this.Sh(90,{x:3,z:0},-.5,0),i&&this.Sh(270,{x:-3,z:0},.5,0),e&&this.Sh(0,{x:0,z:3},.5,-.5),this.Ph=!0}super.Jt(t,s),this.Mh&&(this.zi+=t,this.zi>=this.Ih&&(s.bi(new T(this.Rt.x+this.dir.x/10,.3,this.Rt.z+this.dir.z/10,s.T,this.dir.x,this.dir.z,0,this,[1,1,1,1])),this.zi=0))}es(t,s){s!=this&&(this.Mh=!0)}}class K extends w{constructor(t,s,i){super("",t,s,i,0),this.zi=5*this.Xt()}Jt(t,s){this.os(this.Rt,s.dh.Rt)>10||(super.Jt(t,s),this.zi-=t,this.zi<=0&&(s.bi(new z(this.Rt.x+this.Xt()/2,-.5,this.Rt.z+this.Xt()/2,c.ht,s.T,2*this.Xt(),0,this.Xt(),0,this.Xt()/8,this.Xt()<.5?[1,.4,0,.1]:[.8,.2,0,1])),this.zi=5*this.Xt()))}}class Q{constructor(t,s){this.Rh=new c(t,s),new f,this.T=t,this.Dh=new Array(4096),this.Dh.fill(f.kt),this.Lh=new Array(4096),this.Bh=new Array(4096);for(let t=0;t<64;t++)for(let s=0;s<64;s++)this.Bh[t+64*s]=new S;this.Wh=new S(-1,-1),this.Uh=new Array(4096),this.Uh.fill(0),this.e=new Array,this.Ai=new Array,this.read(()=>{this.parse()}),this.Hh="",this.Nh="",this.dh=null,this.Vh=.1,this.Xi=!1}read(t){let s=this;fetch("m.txt").then(t=>t.text()).then(i=>{for(let t=0;t<64;t++)for(let h=0;h<64;h++)s.Lh[t+64*h]=Math.abs(126-(255+i.charCodeAt(t+64*h)));fetch("l.txt").then(t=>t.text()).then(i=>{for(let t=0;t<64;t++)for(let h=0;h<64;h++){let e=i.charAt(t+64*h),r=s.Lh[t+64*h];"s"==e&&s.kh(t,h,f.At),"g"==e&&s.kh(t,h,f.Tt),"p"==e&&(s.dh=new E(t,.3,h),s.bi(s.dh),s.ks("Where am I? I can't find my things","and where is 04?",10)),"l"==e&&(s.kh(t,h,f.ht),Math.random()<.5&&s.bi(new K(t,0,h))),"b"==e&&s.bi(new P(t,.2,h,s.T,r)),"d"==e&&s.bi(new A(this.fh(1),t,0,h,c.Z,s.T).Ot()),"w"==e&&s.bi(new A(this.wh(1),t,0,h,c.wand,s.T).Ot()),"j"==e&&s.bi(new N(t,0,h,s.T)),"c"==e&&s.bi(new Y(t,0,h,s.T,r).Ot()),"f"==e&&(s.bi(new j(t,0,h,s.T,r).Ot()),s.kh(t,h,f.zt)),"a"==e&&s.bi(new A(this.Ch(),t,0,h,c.it,s.T)),"e"==e&&(s.bi(new I(t,0,h,s.T,r)),s.kh(t,h,(new u).xt(!1))),"t"==e&&s.bi(new H(t,0,h,s.T,r).Ot()),"o"==e&&s.bi(new G(t,0,h,s,r).Ot())}t()})})}fh(t){return new W(0,0,0,this.T,.3,t)}wh(t){return new U(0,0,0,this.T,.3,t)}Ch(){return new V(0,0,0,this.T,.6)}bi(t){this.e.push(t)}_h(){let t=!0;for(;t;){t=!1;for(let s=0;s<64;s++)for(let i=0;i<64;i++){let h=this.Yh(s,i);h!=this.jh(s,i)&&(t=this.Gh(s,i,h))}}}Yh(t,s){let i=this.Dh[t+64*s];if(i==f.p||i==f.ht)return 2;let h=.2;i.gt&&(h=2),i==f.zt&&(h=0);let e=this.jh(t-1,s),r=this.jh(t+1,s),n=this.jh(t,s+1),a=this.jh(t,s-1),l=0;return e>l&&(l=e-h),r>l&&(l=r-h),n>l&&(l=n-h),a>l&&(l=a-h),l>2?2:l<0?0:l}parse(){this._h();let t=x.start(this.T),s=x.start(this.T),i=x.start(this.T);for(let h=0;h<64;h++)for(let e=0;e<64;e++){let r=this.Dh[h+64*e];if(r==f.Kh||r==f.At||r==f.Tt)this.ls(h-1,e).vt(r)||x.left(r._(),t,h,0,e,this.jh(h-1,e),r.height,r.ft),this.ls(h+1,e).vt(r)||x.right(r._(),t,h,0,e,this.jh(h+1,e),r.height,r.ft),this.ls(h,e+1).vt(r)||x.ci(r._(),t,h,0,e,this.jh(h,e+1),r.height,r.ft),this.ls(h,e-1).vt(r)||x.back(r._(),t,h,0,e,this.jh(h,e-1),r.height,r.ft);else if(r==f.ht||r==f.zt){let t=this.jh(h,e);x.bottom(r._(),s,h,-.15,e,t/3,r.ft,[1,.4,0,1]),x.top(c.X._(),i,h,2.9,e,t,r.ft,[.4,.4,.45,1])}else{let t=this.jh(h,e);h<16&&e<16||h>32&&h<56&&e>19&&e<38?(x.bottom(c.q._(),s,h,-1,e,t,r.ft),x.top(c.X._(),i,h,2,e,t,r.ft,[.9,.5,0,1])):(x.bottom(c.floor._(),s,h,-1,e,t,r.ft),x.top(c.X._(),i,h,2,e,t,r.ft,[.4,.4,.45,1]))}}this.Rh.ot=x.oi(t),this.Rh.ct=x.oi(i),this.Rh.ut=x.oi(s),this.Rh.V=!1}ls(t,s){let i=this.Dh[t+64*s];return null==i?f.kt:i}jh(t,s){return this.Uh[t+64*s]}Gh(t,s,i){return this.Uh[t+64*s]!=i&&(this.Uh[t+64*s]=i,!0)}kh(t,s,i){this.Dh[t+64*s]=i}xh(t,s){this.Dh[t+64*s]=f.kt}ts(t,s){let i=this.Bh[t+64*s];return null==i&&(i=this.Wh),i}es(t,s){this.e.forEach(i=>{null!=i.It&&i.It==t&&i.es(this,s)})}rs(t,s){this.e.forEach(i=>{null!=i.It&&i.It==t&&i.rs(this,s)})}ks(t,s,i){this.Hh=t,this.Nh=s,this.Vh=i}qt(t){for(let s=this.e.length-1;s>=0;s--)this.e[s]===t&&this.e.splice(s,1);this.Qh()}Qh(){for(let t=0;t<this.e.length;t++)("pa"==this.e[t].n||"pp"==this.e[t].n)&&this.e[t].Lt<=0&&this.e.splice(t,1)}Jt(t){this.Vh>0&&(this.Vh-=t),this.Vh<=0&&(this.Hh="",this.Nh="");let s=this;this.e.sort((function(t,i){let h=t.cs(s.dh),e=i.cs(s.dh);return h>e?-1:e>h?1:0})),this.e.forEach(s=>{s.Jt(t,this)}),this.Ai.forEach(s=>{s.Jt(t,this,!0)})}lt(){this.Rh.lt(),this.T.enable(this.T.BLEND),this.T.blendFunc(this.T.SRC_ALPHA,this.T.ONE_MINUS_SRC_ALPHA),this.e.forEach(t=>{t.cs(this.dh)<15&&this.Rh.dt(t)}),this.Ai.forEach(t=>{this.Rh.pt(t)}),null!=this.dh&&null!=this.dh.Ai&&this.Rh.dt(this.dh.Ai)}qi(){this.dh.Ki(this)}}class X{constructor(t){this.c=t,this.c.imageSmoothingEnabled=!1,this.Xh=this.c.canvas.width/2,this.qh=this.c.canvas.height/2,this.nt=new Image,this.nt.src="a.png",this.Oh=3,this.Jh=32}Zh(){this.c.clearRect(0,0,this.c.canvas.width,this.c.canvas.height),this.$h("Searching for 04",70,"30px monospace"),this.$h("by Nicklas Löf for JS13k 2020",145),this.$h("Graphics by Nicklas Löf and Elthen at patreon.com",210),this.$h("WASD+mouse Q:drop item,E:eat",310),this.$h("Press 1:Permadeaths",400),this.$h("Press 2:Checkpoints",420)}lt(t){this.c.clearRect(0,0,this.c.canvas.width,this.c.canvas.height),this.$h(t.Hh,250),this.$h(t.Nh,270),null!=t.dh&&t.dh.Lt>0&&(this.te(t),this.se(t),this.ie(t))}te(t){this.he(t),this.ee(t)}se(t){this.re("Health "+t.dh.Lt+"/"+t.dh.Bt,70,450)}ie(t){null!=t.dh.Ai&&"wand"==t.dh.Ai.n&&this.c.drawImage(this.nt,8,27,3,3,this.Xh-6,this.qh-6,9,9)}he(t){let s=t.dh.Wi.us;for(let t=1;t<this.Oh+1;t++)this.c.strokeStyle=t==s?"#ffffff":"#444444",this.ne(this.Jh*t+this.Xh-(this.Oh/2+1.5)*this.Jh+5*t,10,this.Jh)}ee(t){for(let s=0;s<this.Oh+1;s++){let i=t.dh.Wi.ms(s);if(null!=i){let h=this.Jh*s+this.Xh-(this.Oh/2+1.5)*this.Jh+5*s;this.c.drawImage(this.nt,i.N.x,i.N.y,i.N.width,i.N.height,h+3,12,2*i.N.width,2*i.N.height),3==s&&this.re(""+t.dh.Wi.ds,340,38)}}}ne(t,s,i){this.c.beginPath(),this.c.moveTo(t,s),this.c.lineTo(t+i,s),this.c.lineTo(t+i,s+i),this.c.lineTo(t,s+i),this.c.lineTo(t,s),this.c.closePath(),this.c.stroke(),this.c.fillStyle="#22222299",this.c.fill()}$h(t,s,i){this.re(t,this.Xh,s,i)}re(t,s,i,h){this.c.font=null==h?"14px monospace":h,this.c.fillStyle="white",this.c.textAlign="center",this.c.fillText(t,s,i)}}class q{constructor(t,s,i){this.level=new Q(t,i),this.ae=new X(s)}Jt(t){this.level.Jt(t)}lt(){this.level.lt(),this.ae.lt(this.level)}}class O{constructor(t,s,i){this.level=new Q(t,i),this.ae=new X(s),this.le={x:45,y:.3,z:45}}Jt(t,s){isNaN(t)||(c.j.rotate(.15*t),c.j.W(this.le),Z.ps.gs(49)&&Z.oe(),Z.ps.gs(50)&&Z.ce())}lt(){this.level.lt(),this.ae.Zh()}}class J{constructor(t){this.th=[],this.ue=0,t.addEventListener("keydown",this.de.bind(this)),t.addEventListener("keyup",this.pe.bind(this)),t.addEventListener("mousemove",this.ge.bind(this)),t.addEventListener("mousedown",this.fe.bind(this)),t.addEventListener("mouseup",this.we.bind(this))}de(t){this.th[t.keyCode]=!0}pe(t){this.th[t.keyCode]=!1}ge(t){this.ue=-t.movementX}fe(t){this.me=0==t.button}we(t){this.me=!1}Zi(){let t=this.me;return this.me=!1,t}Oi(){let t=this.ue;return this.ue=0,t}gs(t){return this.th[t]}}class Z{static ps;static ve;static St;constructor(){this.ye=document.getElementById("u"),this.Me=document.getElementById("g"),this.Me.requestPointerLock(),this.xe(),this.ke(this.Me),this.ke(this.ye),Z.ve=!1,Z.St=!1,this.T=this.Me.getContext("webgl"),Z.ps=new J(document),this.h=new s(this.T,"precision lowp float;attribute vec4 p;attribute vec4 c;attribute vec4 l;attribute vec2 u;uniform mat4 mvm;uniform mat4 pm;varying vec4 vc;varying vec2 uv;varying float d;varying vec4 li;void main(){gl_Position=pm*mvm*p;vc=c;li=l;uv=u;d=gl_Position.z/27.0;}","precision lowp float;varying vec4 vc;varying vec2 uv;varying float d;varying vec4 li;uniform sampler2D s;uniform float h;void main(){vec4 col=texture2D(s,uv)*vc;float z=gl_FragCoord.z/gl_FragCoord.w;float fogFactor=exp2(-0.15*0.15*z*z*1.4);fogFactor=clamp(fogFactor,0.0,1.0);vec4 c=vec4(col.rgb-d,col.a)+(col.rgba*(li*1.2));if(c.a<0.2)discard;if(h>0.0)gl_FragColor=vec4(1,0,0,1);else gl_FragColor=mix(vec4(0.05,0.05,0.15,1),c,fogFactor);}"),this.be=new O(this.T,this.ye.getContext("2d"),this.h)}Ae(t){Z.ve&&(this.be=new q(this.T,this.ye.getContext("2d"),this.h),Z.ve=!1),Z.St&&(this.be.level.qi(),Z.St=!1),this.T.clear(this.T.COLOR_BUFFER_BIT|this.T.DEPTH_BUFFER_BIT),this.T.clearColor(0,0,0,1),this.T.enable(this.T.DEPTH_TEST),this.T.depthFunc(this.T.LESS),this.T.enable(this.T.CULL_FACE),this.T.disable(this.T.BLEND);let s=t-this.ze;this.ze=t,s>32&&(s=32),this.be.Jt(s/1e3,this),this.be.lt()}ke(t){t.width=this.width=640,t.height=this.height=480,t.addEventListener("click",t=>{this.Me.requestPointerLock()})}xe(){if(null!=Z.Te)return;Z.Te=new AudioContext;var t=0;Z.Ce=Z.Te.createGain(),Z.Ce.connect(Z.Te.destination);let s=Z.Te.createScriptProcessor(512,1,1);s.onaudioprocess=function(s){for(var i=s.outputBuffer.getChannelData(0),h=0;h<512;h++){var e=2*Math.random()-1;i[h]=(t+.02*e)/1.02,t=i[h],i[h]*=3.5}return!0},s.connect(Z.Ce),Z.Ce.gain.value=0}static eh(t,s){if(null==Z.Te)return;let i=Z.Te.createOscillator(),h=Z.Te.createGain();i.connect(h),h.connect(Z.Te.destination),i.start(),i.frequency.value=t,h.gain.linearRampToValueAtTime(h.gain.value,Z.Te.currentTime),h.gain.exponentialRampToValueAtTime(1e-5,Z.Te.currentTime+s+.2),i.stop(Z.Te.currentTime+s+.2)}static mh(t){null!=Z.Te&&(Z.Ce.gain.cancelScheduledValues(Z.Te.currentTime),Z.Ce.gain.linearRampToValueAtTime(1,Z.Te.currentTime),Z.Ce.gain.exponentialRampToValueAtTime(1e-5,Z.Te.currentTime+t+.1))}static oe(){Z.ve=!0}static ce(){Z.Fe=!0,Z.oe()}static qi(){Z.Fe?Z.St=!0:window.location.reload(!1)}}window.onload=function(){document.getElementById("s").addEventListener("click",t=>{t.target.style.display="none";let s=new Z;requestAnimationFrame((function t(){requestAnimationFrame(t),s.Ae(performance.now())}))})};