function Game(e,t){this.canvas=e,this.context=e.getContext("2d"),this.canvasWidth=this.canvas.width,this.canvasHeight=this.canvas.height,this.messageElement=t,this.currMessage=null,this.state=GameState.Start,this.tileSize=20,this.mapCenterX=this.canvasWidth/2,this.mapCenterY=this.canvasHeight/2,this.player=new Player({x:0,y:0,size:this.tileSize}),this.tileMap=null,this.healthBar=new HealthBar(0,0,.85*this.canvasWidth,20),this.woodInventory=new WoodInventory(.86*this.canvasWidth,0,.14*this.canvasWidth,20,5),this.isUpPressed=!1,this.isDownPressed=!1,this.isLeftPressed=!1,this.isRightPressed=!1,this.isActionPressed=!1,this.isActionActive=!1,this.canActivateAction=!1,this.maxPlayerHealth=100,this.playerHealth=this.maxPlayerHealth,this.playerWalkingSpeed=2,this.playerSwimmingSpeed=1,this.playerSpeed=this.playerWalkingSpeed,this.maxWoodCount=5,this.playerWoodCount=0,this.isPlayerClimbing=!1,self.preClimbingX=null,self.preClimbingY=null,this.maxZoomLevel=100,this.zoomLevel=0,this.zoomPercentage=1,this.zonesCompleted=0,this.hasPlayerMoved=!1,this.hasPlayerEatenFruit=!1,this.hasPlayerChoppedTree=!1,this.hasPlayerBuiltTower=!1,this.hasPlayerClimbedTower=!1,this.hasPlayerDismounted=!1,this.hasPlayerSwam=!1,this.hasPlayerDiscoveredIsland=!1,this.hasCompletedTutorial=!1,this.waterTileImage=ImageCache.waterTileImage}function HealthBar(e,t,i,a){this.x=e,this.y=t,this.width=i,this.height=a,this.borderWidth=2,this.marginWidth=3,this.playerHealthPercentage=1}function Island(e,t,i,a,s){this.tiles=this.generateTiles(e,t,i,a,s),this.isDiscovered=s}function Player(e){this.x=e.x,this.y=e.y,this.height=e.size,this.width=e.size,this.halfHeight=this.height/2,this.halfWidth=this.width/2,this.boundBuffer=4,this.isFacingUp=!1,this.isFacingLeft=!1,this.isFacingRight=!1,this.isFacingDown=!0,this.isSwimming=!1,this.upImage=ImageCache.upImage,this.downImage=ImageCache.downImage,this.leftImage=ImageCache.leftImage,this.rightImage=ImageCache.rightImage,this.upSwimImage=ImageCache.upSwimImage,this.downSwimImage=ImageCache.downSwimImage,this.leftSwimImage=ImageCache.leftSwimImage,this.rightSwimImage=ImageCache.rightSwimImage}function Tile(e,t,i,a){this.x=e,this.y=t,this.type=null,this.isPassable=!0,this.height=i,this.width=i,this.halfHeight=this.height/2,this.halfWidth=this.width/2,this.updateTileType(a),this.isIntersecting=!1,this.isActive=!1,this.waterTileImage=ImageCache.waterTileImage,this.landTileImage=ImageCache.landTileImage,this.treeWithFruitTileImage=ImageCache.treeWithFruitTileImage,this.treeTileImage=ImageCache.treeTileImage,this.towerTileImage=ImageCache.towerTileImage,this.markerTileImage=ImageCache.markerTileImage}function TileMap(e,t,i,a){this.mapSize=60,this.tiles=[],this.tileSize=i,this.type=null,this.islands=this.generateIslands(a);var s=this.generateGlyphs(this.islands);this.width=s[0].length*this.tileSize,this.height=s.length*this.tileSize,this.x=e-this.width/2,this.y=t-this.height/2,this.initialize(s)}function WoodInventory(e,t,i,a,s){this.x=e,this.y=t,this.width=i,this.height=a,this.count=0,this.maxWoodCount=s,this.marginWidth=.2*this.width/s,this.barWidth=.8*this.width/s}Game.prototype.update=function(){switch(this.state){case GameState.Start:return void this.updateStartScreen();case GameState.Playing:return void this.updateGameplay();case GameState.ZoneComplete:return void this.updateZoneCompleteScreen();case GameState.GameOver:return void this.updateGameOverScreen()}},Game.prototype.draw=function(){switch(this.state){case GameState.Start:return void this.drawStartScreen();case GameState.Playing:return void this.drawGameplay();case GameState.ZoneComplete:return void this.drawZoneCompleteScreen();case GameState.GameOver:return void this.drawGameOverScreen()}},Game.prototype.start=function(){function e(e,t){switch(e){case 38:i.isUpPressed=t;break;case 39:i.isRightPressed=t;break;case 37:i.isLeftPressed=t;break;case 40:i.isDownPressed=t;break;case 88:i.isActionPressed=t}}function t(){i.update(),i.draw(),requestAnimationFrame(t)}var i=this;i.canvas.addEventListener("keydown",function(t){e(t.keyCode,!0)},!1),i.canvas.addEventListener("keyup",function(t){e(t.keyCode,!1)},!1),t()},Game.prototype.updateStartScreen=function(){var e=this;e.isActionPressed&&(e.advanceLevel(),e.state=GameState.Playing)},Game.prototype.drawStartScreen=function(){var e=this;e.context.clearRect(0,0,e.canvasWidth,e.canvasHeight),e.context.font="25px Arial",e.context.fillStyle="rgb(255, 255, 255)",e.context.fillText("Island Hopper",0,50)},Game.prototype.updateZoneCompleteScreen=function(){var e=this;e.updateMessage("<em>Press X</em> to head to the next zone!"),e.isActionPressed&&(e.state=GameState.Playing,e.advanceLevel())},Game.prototype.drawZoneCompleteScreen=function(){var e=this;e.context.clearRect(0,0,e.canvasWidth,e.canvasHeight),e.context.font="25px Arial",e.context.fillStyle="rgb(255, 255, 255)",e.context.fillText("Completed Zone #"+e.zonesCompleted,0,50)},Game.prototype.updateGameOverScreen=function(){var e=this;e.isActionPressed&&(e.resetGame(),e.state=GameState.Start)},Game.prototype.drawGameOverScreen=function(){var e=this;e.context.clearRect(0,0,e.canvasWidth,e.canvasHeight),e.context.font="25px Arial",e.context.fillStyle="rgb(255, 255, 255)",e.context.fillText("Game Over",0,50)},Game.prototype.updateGameplay=function(){var e=this;e.updateMessages();var t=e.player.x,i=e.player.y;e.player.isSwimming=!1,e.isUpPressed&&(e.player.y-=e.playerSpeed,e.player.isFacingUp=!0,e.player.isFacingLeft=!1,e.player.isFacingRight=!1,e.player.isFacingDown=!1),e.isDownPressed&&(e.player.y+=e.playerSpeed,e.player.isFacingUp=!1,e.player.isFacingLeft=!1,e.player.isFacingRight=!1,e.player.isFacingDown=!0),e.isLeftPressed&&!e.isPlayerClimbing&&(e.player.x-=e.playerSpeed,e.player.isFacingUp=!1,e.player.isFacingLeft=!0,e.player.isFacingRight=!1,e.player.isFacingDown=!1),e.isRightPressed&&!e.isPlayerClimbing&&(e.player.x+=e.playerSpeed,e.player.isFacingUp=!1,e.player.isFacingLeft=!1,e.player.isFacingRight=!0,e.player.isFacingDown=!1),(e.isUpPressed||e.isDownPressed||e.isLeftPressed||e.isRightPressed)&&(e.hasPlayerMoved=!0),e.isActionPressed&&e.canActivateAction&&(e.isActionActive=!0,e.canActivateAction=!1),e.isActionPressed||(e.canActivateAction=!0),(e.player.x<=e.tileMap.x||e.player.x+e.player.width>=e.tileMap.x+e.tileMap.width)&&(e.player.x=t),(e.player.y<=e.tileMap.y||e.player.y+e.player.height>=e.tileMap.y+e.tileMap.height)&&(e.player.y=i);var a=null,s=null,r=null,n=null,l=null,h=null,o=null,p=!1,g=!1,m=e.player.x-2*e.tileSize,d=e.player.x+2*e.tileSize,y=e.player.y-2*e.tileSize,c=e.player.y+2*e.tileSize;if(e.tileMap.forEachTile(function(t,i,u){if(t.isActive&&(t.isActive=!1),!(t.x<m||t.x>d||t.y<y||t.y>c)){var w=Utility.getIntersection(e.player.getBoundingRectangle(),t.getBoundingRectangle());if(null!=w){if((null===o||w.width>o.width&&w.height>o.height)&&(o=w,n=t,l=i,h=u),e.isPlayerClimbing){if(t.x<e.player.x||t.x>=e.player.x+e.player.width)return;return void(t.type!=TileType.Tower&&(p=!0,g=!0))}t.isPassable||(0!=w.height&&(p=!0),0!=w.width&&(g=!0))}null==a&&Utility.intersects(t.getBoundingRectangle(),e.player.getActionBoundingRectangle())&&(a=t,s=i,r=u)}}),null!=a&&(a.isActive=!0),e.playerHealth<=0)return void(e.state=GameState.GameOver);if(null!=n&&!e.isPlayerClimbing)if(n.type===TileType.Water)e.playerHealth-=.1,e.hasPlayerSwam=!0,e.playerSpeed=e.playerSwimmingSpeed,e.player.isSwimming=!0;else if(n.type===TileType.Marker){var u=e.tileMap.getUndiscoveredIsland(l,h);null!=u&&(u.isDiscovered=!0,n.updateTileType(TileType.Land),e.hasPlayerDiscoveredIsland=!0)}else n.type===TileType.Land&&(e.playerSpeed=e.playerWalkingSpeed);if(!e.isPlayerClimbing||p&&g||(e.isUpPressed&&e.zoomLevel++,e.isDownPressed&&e.zoomLevel--),p&&(e.player.x=t),g&&(e.player.y=i),e.isActionActive&&e.isPlayerClimbing)e.isPlayerClimbing=!1,e.zoomLevel=0,e.player.x=e.preClimbingX,e.player.y=e.preClimbingY,e.hasPlayerDismounted=!0;else if(e.isActionActive&&null!=a)if(a.type===TileType.TreeWithFruit)a.updateTileType(TileType.Tree),e.hasPlayerEatenFruit=!0,e.playerHealth+=10,e.playerHealth>e.maxPlayerHealth&&(e.playerHealth=e.maxPlayerHealth);else if(a.type===TileType.Tree)e.playerWoodCount<5&&(a.updateTileType(TileType.Land),e.hasPlayerChoppedTree=!0,e.playerWoodCount++);else if(a.type===TileType.Tower)e.player.isFacingUp&&(e.preClimbingX=e.player.x,e.preClimbingY=e.player.y,e.player.x=a.x,e.player.y=a.y,e.isPlayerClimbing=!0,e.hasPlayerClimbedTower=!0);else if(a.type===TileType.Land&&e.player.isFacingUp&&e.playerWoodCount>0){a.updateTileType(TileType.Tower);for(var w=r;e.playerWoodCount>0;)w--,e.tileMap.tiles[w][s].updateTileType(TileType.Tower),e.playerWoodCount--;e.hasPlayerBuiltTower=!0}e.healthBar.playerHealthPercentage=e.playerHealth/100,e.woodInventory.count=e.playerWoodCount,e.zoomLevel<0&&(e.zoomLevel=0),e.zoomLevel>e.maxZoomLevel&&(e.zoomLevel=e.maxZoomLevel),e.isPlayerClimbing||(e.zoomLevel=0),e.zoomPercentage=1-e.zoomLevel/e.maxZoomLevel;var v=e.tileMap.islands.length,f=0;e.tileMap.islands.forEach(function(t){t.isDiscovered&&f++,v===f&&(e.state=GameState.ZoneComplete)}),e.isActionActive=!1,e.mapCenterX-=e.player.x-t,e.mapCenterY-=e.player.y-i},Game.prototype.drawGameplay=function(){var e=this;e.context.clearRect(0,0,e.canvasWidth,e.canvasHeight);for(var t=e.tileSize*e.zoomPercentage,i=0;i<e.canvasWidth;i+=t)for(var a=0;a<e.canvasHeight;a+=t)e.context.drawImage(e.waterTileImage,Math.ceil(i),Math.ceil(a),Math.ceil(t),Math.ceil(t));e.tileMap.draw(e.context,e.canvasWidth,e.canvasHeight,e.mapCenterX,e.mapCenterY,e.zoomPercentage),e.player.draw(e.context,e.canvasWidth,e.canvasHeight,e.mapCenterX,e.mapCenterY,e.zoomPercentage),e.context.fillStyle="rgb(0, 0, 0)",e.context.fillRect(0,0,e.canvasWidth,25),e.healthBar.draw(e.context),e.woodInventory.draw(e.context)},Game.prototype.advanceLevel=function(){this.player.x=0,this.player.y=0,this.playerHealth=this.maxPlayerHealth,this.playerWoodCount=0,0===this.zonesCompleted?this.playerHealth=80:this.clearMessage(),this.mapCenterX=this.canvasWidth/2,this.mapCenterY=this.canvasHeight/2,this.zonesCompleted++,this.tileMap=this.generateLevel()},Game.prototype.generateLevel=function(){return new TileMap(0,0,this.tileSize,this.zonesCompleted)},Game.prototype.resetGame=function(){this.zonesCompleted=0},Game.prototype.updateMessage=function(e){this.currMessage!==e&&(this.currMessage=e,this.messageElement.innerHTML='"'+e+'"')},Game.prototype.clearMessage=function(e){this.currMessage=null,this.messageElement.innerHTML=""},Game.prototype.updateMessages=function(){var e=this;1===e.zonesCompleted&&(e.hasPlayerDiscoveredIsland?e.updateMessage("You discovered a new island! Now <em>discover all five islands in this zone</em> to move onto the next one!"):e.hasPlayerSwam?e.updateMessage("Be careful! Swimming depletes your health!"):e.hasPlayerDismounted?e.updateMessage("Let's swim over to that island and <em>stand in its center circle</em>!"):e.hasPlayerClimbedTower?e.updateMessage("Ooh! Look at that island over there! <em>Dismount with X</em>."):e.hasPlayerBuiltTower?e.updateMessage("Beautiful! <em>Climb the tower with X</em>. Collect more wood to build taller towers."):e.hasPlayerChoppedTree?e.updateMessage("Now we're cooking! <em>Face up towards an empty spot of land and press X</em> to build a tower!"):e.hasPlayerEatenFruit?e.updateMessage("You're a natural! Now <em>stand near a fruitless tree and chop it down with X</em> to get some wood!"):e.hasPlayerMoved?e.updateMessage("Great! Now it's time to eat and refill some health! <em>Stand near a tree with fruit and press X</em>."):e.updateMessage("Hello Explorer! Move with the <em>arrow keys</em>!"))},GameState={Start:0,Playing:1,ZoneComplete:2,GameOver:3},HealthBar.prototype.draw=function(e){var t=this;e.fillStyle="rgb(255, 255, 255)",e.fillRect(t.x,t.y,t.width,t.height),e.fillStyle="rgb(0, 0, 0)",e.fillRect(t.x+t.borderWidth,t.y+t.borderWidth,t.width-2*t.borderWidth,t.height-2*t.borderWidth),e.fillStyle="rgb(255, 0, 0)",e.fillRect(t.x+t.borderWidth+t.marginWidth,t.y+t.borderWidth+t.marginWidth,(t.width-2*t.borderWidth-2*t.marginWidth)*t.playerHealthPercentage,t.height-2*t.borderWidth-2*t.marginWidth)};var ImageCache=function(){var e=new Image;e.src="images/water.png";var t=new Image;t.src="images/land.png";var i=new Image;i.src="images/tree_with_fruit.png";var a=new Image;a.src="images/tree.png";var s=new Image;s.src="images/tower.png";var r=new Image;r.src="images/marker.png";var n=new Image;n.src="images/player_up.png";var l=new Image;l.src="images/player_down.png";var h=new Image;h.src="images/player_left.png";var o=new Image;o.src="images/player_right.png";var p=new Image;p.src="images/player_swim_up.png";var g=new Image;g.src="images/player_swim_down.png";var m=new Image;m.src="images/player_swim_left.png";var d=new Image;return d.src="images/player_swim_right.png",{waterTileImage:e,landTileImage:t,treeWithFruitTileImage:i,treeTileImage:a,towerTileImage:s,markerTileImage:r,upImage:n,downImage:l,leftImage:h,rightImage:o,upSwimImage:p,downSwimImage:g,leftSwimImage:m,rightSwimImage:d}}();Island.prototype.containsCoordinate=function(e,t){var i=this,a=!1;return i.tiles.forEach(function(i){i.x===e&&i.y===t&&(a=!0)}),a},Island.prototype.generateTiles=function(e,t,i,a,s){for(var r=[],n=Math.floor(e-i/2),l=Math.floor(t-a/2),h=Math.ceil(e+i/2),o=Math.ceil(t+a/2),p=n;p<=h;p++)for(var g=l;g<=o;g++){var m=p===n||p===h||g===l||g===o;if(!(m&&Math.random()>.5)){var d=TileType.Land;p===e&&g===t?s||(d=TileType.Marker):!m&&Math.random()>.8&&(d=TileType.TreeWithFruit),r.push({x:p,y:g,type:d})}}return r},Player.prototype.draw=function(e,t,i,a,s,r){e.fillStyle="rgb(255, 255, 255)";var n=(this.x-this.halfWidth+a)*r,l=(this.y-this.halfHeight+s)*r;n+=t/2*(1-r),l+=i/2*(1-r);var h=this.width*r,o=this.height*r,p=null;this.isFacingUp&&(p=this.upImage,this.isSwimming&&(p=this.upSwimImage)),this.isFacingDown&&(p=this.downImage,this.isSwimming&&(p=this.downSwimImage)),this.isFacingLeft&&(p=this.leftImage,this.isSwimming&&(p=this.leftSwimImage)),this.isFacingRight&&(p=this.rightImage,this.isSwimming&&(p=this.rightSwimImage)),e.drawImage(p,n,l,h,o)},Player.prototype.update=function(){},Player.prototype.getBoundingRectangle=function(){return{x:this.x+this.boundBuffer,y:this.y+this.boundBuffer,height:this.height-this.boundBuffer,width:this.width-this.boundBuffer}},Player.prototype.getActionBoundingRectangle=function(){return this.isFacingUp?{x:this.x+this.width/2,y:this.y-this.height/2-5,height:1,width:1}:this.isFacingDown?{x:this.x+this.width/2,y:this.y+this.height+this.height/2+5,height:1,width:1}:this.isFacingLeft?{x:this.x-this.width/2-5,y:this.y+this.height/2,height:1,width:1}:this.isFacingRight?{x:this.x+this.width+this.width/2+5,y:this.y+this.height/2,height:1,width:1}:void 0},Tile.prototype.draw=function(e,t,i,a,s,r){var n=(this.x-this.halfWidth+a)*r,l=(this.y-this.halfHeight+s)*r;n+=t/2*(1-r),l+=i/2*(1-r);var h=this.width*r,o=this.height*r;n=Math.ceil(n),l=Math.ceil(l),h=Math.ceil(h),o=Math.ceil(o),this.type===TileType.Water||(this.type===TileType.Land?e.drawImage(this.landTileImage,n,l,h,o):this.type===TileType.TreeWithFruit?e.drawImage(this.treeWithFruitTileImage,n,l,h,o):this.type===TileType.Tree?e.drawImage(this.treeTileImage,n,l,h,o):this.type===TileType.Tower?e.drawImage(this.towerTileImage,n,l,h,o):this.type===TileType.Marker&&e.drawImage(this.markerTileImage,n,l,h,o)),this.isActive&&(e.fillStyle="rgba(255, 255, 255, 0.5)",e.fillRect(n,l,h,o))},Tile.prototype.getBoundingRectangle=function(){return{x:this.x,y:this.y,height:this.height,width:this.width}},Tile.prototype.updateTileType=function(e){switch(this.type=e,this.type){case TileType.Land:case TileType.Water:this.isPassable=!0;break;case TileType.Tree:case TileType.TreeWithFruit:case TileType.Tower:this.isPassable=!1}},TileMap.prototype.initialize=function(e){for(var t=this,i=0;i<e.length;i++){t.tiles[i]=[];for(var a=0;a<e[i].length;a++)t.tiles[i][a]=new Tile(a*t.tileSize+t.x,i*t.tileSize+t.y,t.tileSize,e[i][a])}},TileMap.prototype.draw=function(e,t,i,a,s,r){for(var n=this,l=0;l<n.tiles.length;l++)for(var h=0;h<n.tiles[l].length;h++)n.tiles[l][h].draw(e,t,i,a,s,r)},TileMap.prototype.forEachTile=function(e){for(var t=this,i=0;i<t.tiles.length;i++)for(var a=0;a<t.tiles[i].length;a++)e(t.tiles[i][a],a,i)},TileMap.prototype.getUndiscoveredIsland=function(e,t){var i=this,a=null;return i.islands.forEach(function(i){i.isDiscovered||i.containsCoordinate(e,t)&&(a=i)}),a},TileMap.prototype.generateGlyphs=function(e){for(var t=this,i=[],a=0;a<t.mapSize;a++){i.push([]);for(var s=0;s<t.mapSize;s++)i[a][s]=TileType.Water}return t.islands.forEach(function(e){e.tiles.forEach(function(e){i[e.y][e.x]=e.type})}),i},TileMap.prototype.generateIslands=function(e){var t=this,i=t.mapSize/2;if(1===e)return[new Island(i,i,8,8,!0),new Island(i,i-17,8,8,!1),new Island(i,i+17,8,8,!1),new Island(i+19,i,8,8,!1),new Island(i-19,i,8,8,!1)];for(var a=[new Island(i,i,8,8,!0)],s=0;s<4;s++){var r=Utility.getRandom(6,this.mapSize-6),n=Utility.getRandom(6,this.mapSize-6);a.push(new Island(r,n,6,6))}return a},TileType={Land:0,Water:1,Tree:2,TreeWithFruit:3,Tower:4,Marker:5},Utility={},Utility.intersects=function(e,t){return null!=Utility.getIntersection(e,t)},Utility.getIntersection=function(e,t){var i=Math.max(e.x,t.x),a=Math.min(e.x+e.width,t.x+t.width),s=Math.max(e.y,t.y),r=Math.min(e.y+e.height,t.y+t.height);return a>=i&&r>=s?{x:i,y:s,width:a-i,height:r-s}:null},Utility.getRandom=function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e},WoodInventory.prototype.draw=function(e){for(var t=this,i=0;i<t.maxWoodCount;i++)e.fillStyle="rgb(20, 20, 20)",t.count>i&&(e.fillStyle="rgb(172, 114, 0)"),e.fillRect(t.marginWidth+t.x+(t.barWidth+t.marginWidth)*i,t.y,t.barWidth,t.height)};var gameElement=document.getElementById("game");gameElement.focus();var gameMessageElement=document.getElementById("game-message"),game=new Game(gameElement,gameMessageElement);game.start();