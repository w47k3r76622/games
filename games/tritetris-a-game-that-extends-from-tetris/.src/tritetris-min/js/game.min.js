function Game(t,e){this.squareSide=t,this.numOfSquareRow=10,this.cx=e,this.gap=.25*this.squareSide,this.initialize(),this.setup()}Game.prototype.initialize=function(){this.triangleSide=this.squareSide*this.numOfSquareRow+this.gap*(this.numOfSquareRow+1),this.prepareTriangle(),this.prepareLine();var t=-this.squareSide,e=-this.triangle.r/2-this.triangle.thickness/2-12*(this.squareSide+this.gap);this.blockTopleft=new Vector(t,e),this.inputManager=new InputManager,this.storageManager=new StorageManager,this.uiManager=new UIManager,this.storageManager.init();var i=this.storageManager.getBestScore();this.uiManager.displayBest(i),this.addEvents(),window.focus()},Game.prototype.setup=function(){this.gameOver=!1,this.paused=!1,this.stillSquares=[],this.score=0,this.uiManager.displayScore(this.score),this.fallingInterval=1e3,this.decideNextBlock(),this.prepareBlock(),this.uiManager.showLandingInterval(this.fallingInterval),this.giveBlockHint(),this.line.reset(),this.triangle.display()},Game.prototype.addEvents=function(){this.inputManager.on("rotate",this.rotate.bind(this)),this.inputManager.on("move",this.moveBlock.bind(this)),this.inputManager.on("deform",this.deformBlock.bind(this)),this.inputManager.on("pause",this.pause.bind(this)),this.inputManager.on("continue",this["continue"].bind(this)),this.inputManager.on("replay",this.replay.bind(this))},Game.prototype.pause=function(){this.gameOver||(this.interval&&clearInterval(this.interval),this.paused=!0,this.uiManager.changeInnerText(".pause-or-continue-btn","Continue"))},Game.prototype["continue"]=function(){this.gameOver||(this.paused=!1,this.makeBlockFall(),this.uiManager.changeInnerText(".pause-or-continue-btn","Pause"))},Game.prototype.replay=function(){this.uiManager.removeDialog(),this.uiManager.clearContext(this.cx),this.setup()},Game.prototype.prepareTriangle=function(){var t=Math.sqrt(3)/3*this.triangleSide;this.triangle=new Triangle(Math.PI/2,t,"gray",this.cx),this.triangle.display()},Game.prototype.prepareLine=function(){var t=this.triangle.r/2+this.triangle.thickness/2+4*(this.squareSide+this.gap)+1.5;this.line=new Line(this.triangleSide,t,"gray",this.cx),this.line.display()},Game.prototype.prepareBlock=function(){this.fallingBlock=new Block(this.blockTopleft.copy(),this.nextBlockType,this.squareSide,this.gap,this.cx),this.makeBlockFall()},Game.prototype.makeBlockFall=function(){var t=this.fallingBlock,e=this.squareSide+this.gap,i=this,a=new Vector(0,e);i.interval=setInterval(function(){i.canFall(a)?t.move(a):(clearInterval(i.interval),t.squares.forEach(function(t){i.stillSquares.push(t)}),i.lose()||(i.checkIfShouldClear(),i.prepareBlock(),i.giveBlockHint()))},i.fallingInterval),i.line.reset()},Game.prototype.deformBlock=function(){if(!this.gameOver&&!this.paused){var t,e=this.fallingBlock,i=e.width;this.canDeform()&&(e.deform(!0),this.blockHitsRightEdge(e)&&(t=new Vector(-(e.width-i),0),this.canMove(t)?e.move(t):e.deform(!1)))}},Game.prototype.moveBlock=function(t){if(!this.gameOver&&!this.paused&&t){var e,i=this.fallingBlock,a=this.squareSide+this.gap;switch(t){case"left":e=new Vector(-a,0);break;case"right":e=new Vector(a,0);break;case"down":e=new Vector(0,a)}this.canMove(e)&&i.move(e),this.line.reset()}},Game.prototype.rotate=function(t){if(!this.gameOver&&!this.paused&&this.canRotate()){this.triangle.rotate(t);var e=this;this.stillSquares.forEach(function(i){e.rotateSquare(i,t)})}},Game.prototype.rotateSquare=function(t,e){function i(){l.fallingBlock.display(),l.line.reset(),s=Math.abs(e-r),a=e>0?Math.min(o,s):-Math.min(o,s),t.rotate(a),r+=a,r===e?(cancelAnimationFrame(n),l.blockHitsSquare(l.fallingBlock)&&(l.fallingBlock.move(new Vector(0,-(l.fallingBlock.height+l.gap))),l.stillSquares.forEach(function(t){t.display()}))):n=requestAnimationFrame(i)}var a,s,n,o=.08,r=0,l=this;n=requestAnimationFrame(i)},Game.prototype.canRotate=function(){return this.fallingBlock.topleft.y>=-this.line.r2center?!1:!0},Game.prototype.checkIfShouldClear=function(){for(var t,e=0,i=this.squareSide+this.gap,a=this.getTopStillY(),s=-this.triangle.r/2-this.triangle.thickness/2-i,n=[],o=this,r=s;r>a-i/2;r-=i)o.stillSquares.forEach(function(t){o.approximatelyEqual(r,t.topleft.y)&&n.push(t)}),10===n.length?(n.forEach(function(t){t.disappear(),o.stillSquares.splice(o.stillSquares.indexOf(t),1)}),e++):e>0&&n.forEach(function(t){t.fall(i*e)}),n=[];e>0&&(o.fallingInterval>500&&(o.fallingInterval-=20*e,o.uiManager.showLandingInterval(o.fallingInterval)),t=e*e*10,o.uiManager.displayScoreAddition(t),o.score+=t,o.uiManager.displayScore(o.score),o.checkForUpdatingBest())},Game.prototype.lose=function(){var t=-this.cx.canvas.height/2;return this.getTopStillY()<t?(this.afterLosing(),!0):void 0},Game.prototype.decideNextBlock=function(){var t=["I","J","L","O","S","Z","T"];this.nextBlockType=t[Math.floor(7*Math.random())]},Game.prototype.giveBlockHint=function(){this.decideNextBlock(),this.hintBlock&&this.hintBlock.disappear();var t=new Vector(0,0);this.hintBlock=new Block(t,this.nextBlockType,this.squareSide,this.gap,this.cx),this.hintBlock.setTopleft(-this.hintBlock.width/2,2*-this.squareSide),this.hintBlock.setSquareCoors(),this.hintBlock.display()},Game.prototype.afterLosing=function(){this.gameOver=!0,this.uiManager.lose()},Game.prototype.checkForUpdatingBest=function(){this.score>this.storageManager.getBestScore()&&(this.storageManager.updateBestScore(this.score),this.uiManager.displayBest(this.score))},Game.prototype.approximatelyEqual=function(t,e){return Math.abs(t-e)<.1},Game.prototype.getTopStillY=function(){var t=0;return this.stillSquares.forEach(function(e){e.topleft.y<t&&(t=e.topleft.y)}),t},Game.prototype.canFall=function(t){var e=this.fallingBlock.copy();return e.invisiblyMove(t),this.blockHitsSquare(e)||this.blockHitsBottom(e)?!1:!0},Game.prototype.canMove=function(t){var e=this.fallingBlock.copy();return e.invisiblyMove(t),this.blockHitsSquare(e)||this.blockHitsBottom(e)||this.blockHitsLeftEdge(e)||this.blockHitsRightEdge(e)?!1:!0},Game.prototype.canDeform=function(){var t=this.fallingBlock.copy();return t.invisiblyDeform(),this.blockHitsSquare(t)||this.blockHitsBottom(t)?!1:!0},Game.prototype.blockHitsSquare=function(t){for(var e=-this.triangle.r/2,i=0,a=t.squares.length;a>i;i++)for(var s=t.squares[i].topleft.x,n=t.squares[i].topleft.y,o=0;o<this.stillSquares.length;o++){var r=this.stillSquares[o].topleft.x,l=this.stillSquares[o].topleft.y;if(e>l&&this.approximatelyEqual(s,r)&&this.approximatelyEqual(n,l))return!0}return!1},Game.prototype.blockHitsBottom=function(t){var e=-this.triangle.r/2;return t.topleft.y+t.height>e-this.triangle.thickness/2-this.gap?!0:!1},Game.prototype.blockHitsLeftEdge=function(t){return t.topleft.x<-this.triangleSide/2?!0:!1},Game.prototype.blockHitsRightEdge=function(t){return t.topleft.x+t.width>this.triangleSide/2?!0:!1};