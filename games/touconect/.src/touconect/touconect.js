
	var musicString = {
	    "songLen": 37,
	    "songData": [
	        {
	            "osc1_oct": 7,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 192,
	            "osc1_waveform": 3,
	            "osc2_oct": 7,
	            "osc2_det": 0,
	            "osc2_detune": 7,
	            "osc2_xenv": 0,
	            "osc2_vol": 201,
	            "osc2_waveform": 3,
	            "noise_fader": 0,
	            "env_attack": 789,
	            "env_sustain": 1234,
	            "env_release": 13636,
	            "env_master": 191,
	            "fx_filter": 2,
	            "fx_freq": 5839,
	            "fx_resonance": 254,
	            "fx_delay_time": 6,
	            "fx_delay_amt": 121,
	            "fx_pan_freq": 6,
	            "fx_pan_amt": 147,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 1,
	            "lfo_freq": 6,
	            "lfo_amt": 195,
	            "lfo_waveform": 0,
	            "p": [
	                1,
	                2,
	                0,
	                0,
	                1,
	                2,
	                1,
	                2
	            ],
	            "c": [
	                {
	                    "n": [
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        157,
	                        0,
	                        0,
	                        0,
	                        156,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        157,
	                        0,
	                        0,
	                        0,
	                        159,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 7,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 255,
	            "osc1_waveform": 2,
	            "osc2_oct": 8,
	            "osc2_det": 0,
	            "osc2_detune": 18,
	            "osc2_xenv": 1,
	            "osc2_vol": 191,
	            "osc2_waveform": 2,
	            "noise_fader": 0,
	            "env_attack": 3997,
	            "env_sustain": 56363,
	            "env_release": 100000,
	            "env_master": 255,
	            "fx_filter": 2,
	            "fx_freq": 392,
	            "fx_resonance": 255,
	            "fx_delay_time": 8,
	            "fx_delay_amt": 69,
	            "fx_pan_freq": 5,
	            "fx_pan_amt": 67,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 1,
	            "lfo_freq": 4,
	            "lfo_amt": 57,
	            "lfo_waveform": 3,
	            "p": [
	                1,
	                2,
	                1,
	                2,
	                1,
	                2,
	                1,
	                2
	            ],
	            "c": [
	                {
	                    "n": [
	                        130,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        123,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 8,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 0,
	            "osc1_waveform": 0,
	            "osc2_oct": 8,
	            "osc2_det": 0,
	            "osc2_detune": 0,
	            "osc2_xenv": 0,
	            "osc2_vol": 0,
	            "osc2_waveform": 0,
	            "noise_fader": 60,
	            "env_attack": 50,
	            "env_sustain": 419,
	            "env_release": 4607,
	            "env_master": 130,
	            "fx_filter": 1,
	            "fx_freq": 10332,
	            "fx_resonance": 120,
	            "fx_delay_time": 4,
	            "fx_delay_amt": 16,
	            "fx_pan_freq": 5,
	            "fx_pan_amt": 108,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 0,
	            "lfo_freq": 5,
	            "lfo_amt": 187,
	            "lfo_waveform": 0,
	            "p": [
	                0,
	                0,
	                0,
	                0,
	                1,
	                1
	            ],
	            "c": [
	                {
	                    "n": [
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        147,
	                        147,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        147,
	                        0,
	                        147,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        147,
	                        147,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        147,
	                        0,
	                        147
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 7,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 1,
	            "osc1_vol": 255,
	            "osc1_waveform": 0,
	            "osc2_oct": 7,
	            "osc2_det": 0,
	            "osc2_detune": 0,
	            "osc2_xenv": 1,
	            "osc2_vol": 255,
	            "osc2_waveform": 0,
	            "noise_fader": 0,
	            "env_attack": 50,
	            "env_sustain": 150,
	            "env_release": 4800,
	            "env_master": 200,
	            "fx_filter": 2,
	            "fx_freq": 600,
	            "fx_resonance": 254,
	            "fx_delay_time": 0,
	            "fx_delay_amt": 0,
	            "fx_pan_freq": 0,
	            "fx_pan_amt": 0,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 0,
	            "lfo_freq": 0,
	            "lfo_amt": 0,
	            "lfo_waveform": 0,
	            "p": [
	                1,
	                1,
	                1,
	                1,
	                1,
	                1
	            ],
	            "c": [
	                {
	                    "n": [
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 7,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 255,
	            "osc1_waveform": 2,
	            "osc2_oct": 7,
	            "osc2_det": 0,
	            "osc2_detune": 9,
	            "osc2_xenv": 0,
	            "osc2_vol": 154,
	            "osc2_waveform": 2,
	            "noise_fader": 0,
	            "env_attack": 2418,
	            "env_sustain": 1075,
	            "env_release": 10614,
	            "env_master": 240,
	            "fx_filter": 3,
	            "fx_freq": 2962,
	            "fx_resonance": 255,
	            "fx_delay_time": 6,
	            "fx_delay_amt": 117,
	            "fx_pan_freq": 3,
	            "fx_pan_amt": 73,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 1,
	            "lfo_freq": 5,
	            "lfo_amt": 124,
	            "lfo_waveform": 0,
	            "p": [
	                0,
	                0,
	                0,
	                0,
	                1,
	                2,
	                1,
	                2
	            ],
	            "c": [
	                {
	                    "n": [
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        157,
	                        0,
	                        0,
	                        0,
	                        156,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        154,
	                        0,
	                        154,
	                        0,
	                        152,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        147,
	                        0,
	                        152,
	                        0,
	                        157,
	                        0,
	                        0,
	                        0,
	                        159,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 7,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 192,
	            "osc1_waveform": 1,
	            "osc2_oct": 6,
	            "osc2_det": 0,
	            "osc2_detune": 9,
	            "osc2_xenv": 0,
	            "osc2_vol": 192,
	            "osc2_waveform": 1,
	            "noise_fader": 0,
	            "env_attack": 137,
	            "env_sustain": 2000,
	            "env_release": 4611,
	            "env_master": 192,
	            "fx_filter": 1,
	            "fx_freq": 982,
	            "fx_resonance": 89,
	            "fx_delay_time": 6,
	            "fx_delay_amt": 25,
	            "fx_pan_freq": 6,
	            "fx_pan_amt": 77,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 1,
	            "lfo_freq": 3,
	            "lfo_amt": 69,
	            "lfo_waveform": 0,
	            "p": [
	                1,
	                2,
	                1,
	                3,
	                1,
	                3
	            ],
	            "c": [
	                {
	                    "n": [
	                        130,
	                        0,
	                        130,
	                        0,
	                        142,
	                        0,
	                        130,
	                        130,
	                        0,
	                        142,
	                        130,
	                        0,
	                        142,
	                        0,
	                        130,
	                        0,
	                        130,
	                        0,
	                        130,
	                        0,
	                        142,
	                        0,
	                        130,
	                        130,
	                        0,
	                        142,
	                        130,
	                        0,
	                        142,
	                        0,
	                        130,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        123,
	                        0,
	                        123,
	                        0,
	                        135,
	                        0,
	                        123,
	                        123,
	                        0,
	                        135,
	                        123,
	                        0,
	                        135,
	                        0,
	                        123,
	                        0,
	                        123,
	                        0,
	                        123,
	                        0,
	                        135,
	                        0,
	                        123,
	                        123,
	                        0,
	                        135,
	                        123,
	                        0,
	                        135,
	                        0,
	                        123,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        135,
	                        0,
	                        135,
	                        0,
	                        147,
	                        0,
	                        135,
	                        135,
	                        0,
	                        147,
	                        135,
	                        0,
	                        147,
	                        0,
	                        135,
	                        0,
	                        135,
	                        0,
	                        135,
	                        0,
	                        147,
	                        0,
	                        135,
	                        135,
	                        0,
	                        147,
	                        135,
	                        0,
	                        147,
	                        0,
	                        135,
	                        0
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 7,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 255,
	            "osc1_waveform": 3,
	            "osc2_oct": 8,
	            "osc2_det": 0,
	            "osc2_detune": 0,
	            "osc2_xenv": 0,
	            "osc2_vol": 255,
	            "osc2_waveform": 0,
	            "noise_fader": 127,
	            "env_attack": 22,
	            "env_sustain": 88,
	            "env_release": 3997,
	            "env_master": 255,
	            "fx_filter": 3,
	            "fx_freq": 4067,
	            "fx_resonance": 234,
	            "fx_delay_time": 4,
	            "fx_delay_amt": 33,
	            "fx_pan_freq": 2,
	            "fx_pan_amt": 84,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 1,
	            "lfo_freq": 3,
	            "lfo_amt": 28,
	            "lfo_waveform": 0,
	            "p": [
	                0,
	                0,
	                1,
	                2,
	                1,
	                2,
	                1,
	                3
	            ],
	            "c": [
	                {
	                    "n": [
	                        0,
	                        0,
	                        142,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        142,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        142,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        142,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        0,
	                        0,
	                        147,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        154,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0
	                    ]
	                },
	                {
	                    "n": [
	                        0,
	                        0,
	                        147,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        154,
	                        0,
	                        0,
	                        0,
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                }
	            ]
	        },
	        {
	            "osc1_oct": 8,
	            "osc1_det": 0,
	            "osc1_detune": 0,
	            "osc1_xenv": 0,
	            "osc1_vol": 0,
	            "osc1_waveform": 0,
	            "osc2_oct": 8,
	            "osc2_det": 0,
	            "osc2_detune": 0,
	            "osc2_xenv": 0,
	            "osc2_vol": 0,
	            "osc2_waveform": 0,
	            "noise_fader": 255,
	            "env_attack": 140347,
	            "env_sustain": 9216,
	            "env_release": 133417,
	            "env_master": 208,
	            "fx_filter": 2,
	            "fx_freq": 2500,
	            "fx_resonance": 16,
	            "fx_delay_time": 2,
	            "fx_delay_amt": 157,
	            "fx_pan_freq": 8,
	            "fx_pan_amt": 207,
	            "lfo_osc1_freq": 0,
	            "lfo_fx_freq": 1,
	            "lfo_freq": 2,
	            "lfo_amt": 51,
	            "lfo_waveform": 0,
	            "p": [
	                0,
	                0,
	                1,
	                1,
	                1,
	                1,
	                1,
	                1
	            ],
	            "c": [
	                {
	                    "n": [
	                        147,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0,
	                        0
	                    ]
	                }
	            ]
	        }
	    ],
	    "rowLen": 5513,
	    "endPattern": 9
	};

        var canvas = document.createElement("canvas"),
			width = canvas.width = window.innerWidth,
			height = canvas.height = window.innerHeight,
			ctx = canvas.getContext("2d"),
            bcanvas = document.createElement("canvas"),
            bwidth = bcanvas.width = window.innerWidth,
			bheight = bcanvas.height = window.innerHeight,
			bctx = bcanvas.getContext("2d");

      var outerBarWidth = (width * 0.35),
          outerBarHeight = height * 0.08,
          innerBarWidth = 0,
          innerBarStep = 2;

        var mouse_cordinate = {},
             mousepress = false,
             radius = 20,
             dirRate = 1000,
             score = 0,
             scoreStep = 1000,
             health = 100,
             healthloss = 1,
             updatehealth = false,
             updatescore = false,
             updatelevel = false,
             gameover = false,
             destroyed = 0,
             connect = [],
             maxOrbs = 2,
             orbsConnected = 0,
             level = 1,
						 pause = false,
            connectedOrbsColor = "#CCFFCC",
					  levellist = document.getElementsByClassName('levelno'),
         		orbs = generate(maxOrbs,generate_orbs),
						songGen = new sonantx.MusicGenerator(musicString),
						backgroundMusic,
						BGSoundbtn = document.getElementById("toggleBgMusic"),
						orbshadowcolor = "rgb(102, 204, 255)"
						isLoading = true
						animationLoop = null;

        function generate(length,fn)
        {
            var arr = [];
            for(var i = 0; i < length; i++)
            {
                    arr.push(fn());
            }

            return arr;
        }

        function randomLetter()
        {
            var text = "";
            var possible = "abcdefghijklmnopqrstuvwxyz";

                text = possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }

    function inArray(ele,array)
    {
        for(var i = 0; i < array.length ; i++)
        {
            if(ele.x == array[i].x
               && ele.y == array[i].y
               && ele.letter == array[i].letter)
                {
                    return true;
                }
        }

        return false;
    }

    function map_range(value, low1, high1, low2, high2) {
			    return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
			}

    function distanceXY(x1,y1,x2,y2)
    {
      return Math.sqrt((x2-x1)*(x2-x1) + (y2-y1)*(y2-y1));
    }

    function lineIntersect(x1,y1,x2,y2, x3,y3,x4,y4) {
            var x=((x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4))/((x1-x2)*(y3-y4)-(y1-y2)*(x3-x4));
            var y=((x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4))/((x1-x2)*(y3-y4)-(y1-y2)*(x3-x4));
            if (isNaN(x)||isNaN(y)) {
                return false;
            } else {
                if (x1>=x2) {
                    if (!(x2<=x&&x<=x1)) {return false;}
                } else {
                    if (!(x1<=x&&x<=x2)) {return false;}
                }
                if (y1>=y2) {
                    if (!(y2<=y&&y<=y1)) {return false;}
                } else {
                    if (!(y1<=y&&y<=y2)) {return false;}
                }
                if (x3>=x4) {
                    if (!(x4<=x&&x<=x3)) {return false;}
                } else {
                    if (!(x3<=x&&x<=x4)) {return false;}
                }
                if (y3>=y4) {
                    if (!(y4<=y&&y<=y3)) {return false;}
                } else {
                    if (!(y3<=y&&y<=y4)) {return false;}
                }
            }
            return true;
    }

    //RETURNS NUMBER BETWEEN X AND Y, FLOAT VAL IS DECIMAL PLACES
    function randomXToY(minVal,maxVal,floatVal){
      var randVal = minVal+(Math.random()*(maxVal-minVal));
      return typeof floatVal=='undefined'?Math.round(randVal):randVal.toFixed(floatVal);
    }

        var handleMouseup = function(e){
             mouse_cordinate = {};
             mousepress = false;
             connect = [];
             orbsConnected = 0;
        },
        handleMousemove = function(e){
            e.preventDefault();
              mouse_cordinate.x = e.pageX;
             mouse_cordinate.y = e.pageY;
        }
        ,
        handleMousedown = function(e){
            e.preventDefault();
             mouse_cordinate.x = e.pageX;
             mouse_cordinate.y = e.pageY;
            mousepress = true;
        },
        handleTouchdown = function(e){
             e.preventDefault();
             mouse_cordinate.x = e.touches[0].pageX;
             mouse_cordinate.y = e.touches[0].pageY;
            mousepress = true;
        },
        handleTouchmove = function(e){
             e.preventDefault();
             mouse_cordinate.x = e.touches[0].pageX;
             mouse_cordinate.y = e.touches[0].pageY;
        }


        function render_background()
        {
            var grid = 40;
            bctx.fillStyle = "#000";
            bctx.fillRect(0,0,bwidth,bheight);

            bctx.shadowColor = "#DDECEF";
            bctx.shadowOffsetX = 0;
            bctx.shadowOffsetY = 0;
            bctx.shadowBlur    = 10;
            bctx.globalAlpha = 0.4;
            for(var i = 0;i < bwidth; i+= grid)
            {
                    bctx.beginPath();
                    bctx.moveTo(i,0);
                    bctx.lineTo(i,bheight);
                    bctx.strokeStyle = "#DDECEF";
                    bctx.stroke();
            }

            for(var i = 0;i < bheight; i+= grid)
            {
                    bctx.beginPath();
                    bctx.moveTo(0,i);
                    bctx.lineTo(bwidth,i);
                    bctx.strokeStyle = "#DDECEF";
                    bctx.stroke();
            }
        }

        function generate_orbs()
        {
                          return {
                              x:randomXToY(40,width-40),
                              y:randomXToY(80,height-40),
                              color:"rgb(102, 204, 255)",
                              letter : randomLetter(),
                              vx:randomXToY(-1,1),
                              vy:randomXToY(-1,1)

                          }
        }


      window.onresize = function(){
          var oldheight = height,
              oldwidth = width;

            width = canvas.width = window.innerWidth;
						height = canvas.height = window.innerHeight;
            bwidth = bcanvas.width = window.innerWidth;
						bheight = bcanvas.height = window.innerHeight;

          canvas.style.top = 0;
          canvas.style.left = 0;
          bcanvas.style.top = 0;
          bcanvas.style.top = 0;
           render_background();

          for(var i = 0; i < orbs.length; i++)
         {
                orbs[i].x = map_range(orbs[i].x,0,oldwidth,0,width);
                orbs[i].y = map_range(orbs[i].y,0,oldheight,0,height);
         }
      }
	  window.onload = function(){

       document.body.appendChild(bcanvas);
       document.body.appendChild(canvas);

      drawLoading();

      document.body.addEventListener("mousedown", handleMousedown, false);
      document.body.addEventListener("mousemove", handleMousemove, false);
      document.body.addEventListener("touchstart",handleTouchdown, false);
      document.body.addEventListener("touchend", handleMouseup, false);
      document.body.addEventListener("touchmove", handleTouchmove, false);

      document.body.addEventListener('mouseup',handleMouseup,false);
      document.getElementById('play').addEventListener('click',start_game,false);
      document.getElementById('play_again').addEventListener('click',start_game,false);
      document.getElementById('play_continue').addEventListener('click',continue_game,false);

	}


          function update_health()
          {
            document.getElementById('health').style.width  = health+'%';
          }

          function update_score()
          {
              document.getElementById('score').innerHTML  = score;
              document.getElementById('afterscore').innerHTML  = score;
          }

          function update_level()
          {
              removeLevelClass(levellist);
							levellist[level-1].classList.add('active');
              document.getElementById('level').innerHTML  = level;
          }


function update(){

            ctx.clearRect(0,0,width,height);
            ctx.lineCap = "round";

            for(var i = 0; i < orbs.length; i++)
            {


                if(inArray(orbs[i],connect))
                {
                     orbshadowcolor = connectedOrbsColor;
                }
                else
                {
                    	orbshadowcolor = "rgb(102, 204, 255)";
                }

								drawOrb(orbs[i].x,orbs[i].y,radius,orbs[i].color,orbshadowcolor);

                if(mousepress)
                {

                    var dist = distanceXY(orbs[i].x,orbs[i].y,mouse_cordinate.x,mouse_cordinate.y);

                    if(dist <= radius && !inArray(orbs[i],connect))
                    {
                            connect.push(orbs[i]);
                            orbsConnected++;
                    }

                }

                if(dirRate)
                {
                  dirRate -= 5;
                }
                else
                {
                if(!inArray(orbs[i],connect))
                {
                 orbs[i].vx = randomXToY(-1,1);
                 orbs[i].vy = randomXToY(-1,1);

                 if(orbs[i].vy == 0)
                 {
                   orbs[i].vy = 0.5
                 }
                 if(orbs[i].xy == 0)
                 {
                   orbs[i].xy = 0.5
                 }
                }
                 dirRate = 1000;

                if(scoreStep > 100)
                    scoreStep--;
                }

                //console.log(dirRate);

              if(orbs[i].y+radius >= height
                  || orbs[i].y-radius-40 <= 0
                  )
                {
                    orbs[i].vy = -orbs[i].vy
                }

                if(orbs[i].x+radius >= width
                  || orbs[i].x-radius <= 0
                  )
                {
                    orbs[i].vx = -orbs[i].vx
                }

                for(var k = 0; k < orbs.length; k++)
                {
                  if(k != i)
                  {
                    var dis = distanceXY(orbs[i].x,orbs[i].y,orbs[k].x,orbs[k].y);
                    if(dis <= radius*2)
                    {
                      orbs[i].vy = -orbs[i].vy;
                      orbs[i].vx = -orbs[i].vx

                      orbs[k].vy = -orbs[k].vy;
                      orbs[k].vx = -orbs[k].vx
                    }
                  }
                }

                if(!inArray(orbs[i],connect))
                {
                 orbs[i].x += orbs[i].vx;
                 orbs[i].y += orbs[i].vy;
                 orbs[i].color = "rgb(102, 204, 255)";
                }
                else
                {
                   orbs[i].color = connectedOrbsColor;
                }
            }
              var intersecting = false;
                  connectedOrbsColor = "#CCFFCC";
              if(mousepress)
              {

                  for(var i = 0; i < connect.length - 1 ; i++)
                  {
                     for(var j = connect.length-1; j > 1 ; j--)
                     {
                       if((connect[j].x == connect[i].x &&
                         connect[j].y == connect[i].y)
                         ||
                         (connect[j-1].x == connect[i].x &&
                         connect[j-1].y == connect[i].y)
                          ||
                         (connect[j].x == connect[i+1].x &&
                         connect[j].y == connect[i+1].y)
                         ||
                         (connect[j-1].x == connect[i+1].x &&
                         connect[j-1].y == connect[i+1].y))
                           continue;
                      if(lineIntersect(connect[j].x,connect[j].y,
                                      connect[j-1].x,connect[j-1].y,
                                      connect[i].x,connect[i].y,
                                      connect[i+1].x,connect[i+1].y))
                        {
                           intersecting = true;
                           connectedOrbsColor = "#F59F9F";
                        }

                     }

                  }
                  //console.log(intersecting);
                    ctx.beginPath();
                    ctx.shadowColor =connectedOrbsColor;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    ctx.shadowBlur    = 25;
                    ctx.strokeStyle= connectedOrbsColor;
                    ctx.lineWidth = 5;
                    for(var i = 0; i < connect.length ; i++)
                    {

                            if(i == 0)
                            {
                                ctx.moveTo(connect[i].x,connect[i].y);
                            }
                            else
                            {
                                ctx.lineTo(connect[i].x,connect[i].y);
                            }
                       var lcon = connect[i];
                    }
                    ctx.lineTo(mouse_cordinate.x,mouse_cordinate.y);
                    ctx.stroke();
                    if(lcon)
                      drawOrb(lcon.x,lcon.y,radius,lcon.color,connectedOrbsColor);
              }

             if(intersecting)
             {
                 health--;
                 updatehealth = true;
             }

                //console.log(intersecting +" "+ connectedOrbsColor);
            if(orbsConnected == orbs.length && !intersecting)
            {
                handleMouseup();
                score += scoreStep;
                updatescore = true;
                updatelevel = true;
                level++;
                maxOrbs = level*2;
								pause = true;
                //console.log(connect);
              //drawOrb(connect[i].x,connect[i].y,radius,connect[i].color,connectedOrbsColor);
               show_levelcomplet();

            }


            if(updatehealth)
            {
                updatehealth = false;
                update_health();
            }

            if(updatescore)
            {

                updatescore = false;
                update_score();
            }

            if(updatelevel)
            {
                updatelevel = false;
                update_level();
            }

            if(health <= 0)
            {
                update_health();
                gameover = true;
            }

            if(!gameover && !pause)
            {
			        animationLoop = requestAnimationFrame(update);
                //console.log(r);
            }
            else
            {
							if(gameover && !pause)
							{
                game_over();
							}
            }
		}



		function drawLoading()
		{


				if(innerBarWidth < outerBarWidth)
				{
					innerBarWidth += innerBarStep;
				}
				bctx.fillStyle = "#000";
			  bctx.fillRect(0,0,width,height);
				bctx.font	= "50px sans-serif"
				bctx.textAlign = "middle";
				bctx.fillStyle = "#fff";
				bctx.fillText("Loading...",(width/2-outerBarWidth/2),(height/2-outerBarHeight/2)-12);
        //console.log(width * 0.35);
        //console.log(width/2-outerBarWidth/2,height/2-outerBarHeight/2,outerBarWidth,outerBarHeight);
				bctx.fillRect(width/2-outerBarWidth/2,height/2-outerBarHeight/2,outerBarWidth,outerBarHeight);
				bctx.fillStyle = "rgb(102, 204, 255)";
				bctx.fillRect(width/2-outerBarWidth/2,height/2-outerBarHeight/2,innerBarWidth,outerBarHeight);
				bctx.fill();
				animationLoop = requestAnimationFrame(drawLoading);
	  }

    function start_game()
    {
            gameover = false;
             score = 0;
             scoreStep = 1000;
             health = 100;
             updatehealth = false,
             updatescore = false,
             gameover = false;
             dirRate = 1000;
             level = getLevel();
            maxOrbs = level*2;
            orbs = generate(maxOrbs,generate_orbs);
        document.getElementById('levelcomplet').style.display = "none";
        document.getElementById('gameover').style.display = "none";
        document.getElementById('gamestart').style.display = "none";
        document.getElementById('container').style.display = "none";
        update_health();
        update_score();
        update_level();
        update();

    }

		function continue_game()
    {
				pause = false;
        document.getElementById('levelcomplet').style.display = "none";
        document.getElementById('container').style.display = "none";
				orbs = generate(maxOrbs,generate_orbs);
        update_health();
        update_score();
        update_level();
        update();
    }

		function show_levelcomplet()
		{
			pause = true;
			document.getElementById('levelcomplet').style.display = "block";
			document.getElementById('container').style.display = "block";
      cancelAnimationFrame(animationLoop);
		}

    function game_over()
    {
        document.getElementById('container').style.display = "block";
        document.getElementById('gameover').style.display = "block";
        cancelAnimationFrame(animationLoop);
    }

		function removeLevelClass(levellist)
		{
			for (var i = 0; i < levellist.length; i++){
						levellist[i].classList.remove('active');
			}
		}

		function getLevel()
		{
			for (var i = 0; i < levellist.length; i++){
						if(levellist[i].classList.contains('active'))
						{
							return i+1;
						}
			}
		}


function drawOrb(x,y,size,color,shadowcolor)
{
	ctx.beginPath();
	ctx.shadowColor = shadowcolor;
	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur    = 25;
	ctx.fillStyle=color;
	ctx.arc(x,y,radius,Math.PI*2,false);
	ctx.fill();
}

	function playBackgroundMusic() {
		if(BGSoundbtn.classList.contains('activeBtn'))
		{
			  backgroundMusic.pause();
			  backgroundMusic.currentTime = 0;
			  backgroundMusic.play();
		}
	}

	function toggleBgMusic()
	{

		BGSoundbtn.classList.toggle('activeBtn');
		if(BGSoundbtn.classList.contains('activeBtn'))
		{
			backgroundMusic.play();
		}
		else {
			backgroundMusic.pause();
		}
	}

		BGSoundbtn.addEventListener('click',toggleBgMusic,false);

		for (var i = 0; i < levellist.length; i++) {
			levellist[i].addEventListener('click',function(){
				removeLevelClass(levellist);
				this.classList.add('active');
				level = this.innerHTML;
			},false);
		}


		songGen.createAudio(function(audio) {
		    backgroundMusic = audio;
		    backgroundMusic.play();
				render_background();
				document.getElementById('container').style.display = "block";
				document.getElementsByTagName('header')[0].style.display = "block";
				cancelAnimationFrame(animationLoop);
		});

		setInterval(playBackgroundMusic , 30000);
