"use strict";let server,game,_o,_oI,_p,_pI,_state,_s,_sI,_i,_iI,_b,_bI,_tV,_tV2,_hit,_hw,_n,_d1,_d2,_dist,_dir,_X,_Y,_W,_H,_ship,_hInt,PI=Math.PI,objID=0,_beat=0,_beatTime=0,input=[],_actors=[],cInput=[0,0,0,0],_wasMoving=!1,lR=0,cList=[],cTypes={},rnd=t=>Math.floor(1e3*t)/1e3,bWs=[8,12,6,4,4],nearestPlayer=t=>{for(_pI in _n=null,game.players)(_p=game.players[_pI])&&(_n||(_n=_p),_d1=t.pos.dist(_n.pos),(_d2=t.pos.dist(_p.pos))<_d1&&(_n=_p,_d1=_d2));return t.target=_n,_d1},randomShip=t=>{switch(_ship="",t){case 0:_ship+=1+3*Math.random()|0,_ship+=5*Math.random()|0,_ship+=10*Math.random()|0,_ship+=1+3*Math.random()|0;break;case 1:_ship+=0,_ship+=Math.random()>.5?1:5,_ship+=10*Math.random()|0,_ship+=4;break;case 2:_ship+=4,_ship+=3*Math.random()|0,_ship+=3*Math.random()|0,_ship+=3*Math.random()|0,_ship+=0,_ship+=3*Math.random()|0}},mStats=[10,2.375,9],shipStats=t=>[(1*t[1]+t[2]%5)/2+6,1.25+(10-(1*t[1]+1*t[3]))/8,3.5+1*t[3]+(5-t[2]%5)/2],collision=(t,e)=>{t.collidedWith[e.id]=!0,e.collidedWith[t.id]=!0,t.collided(e),e.collided(t)},gotHit=t=>{_p=game.player,cam.shake(),emitParticle(_p.pos,0,"splosion"),playBuffer("splode",.05,Math.floor(Math.max(_p.life,0)/1e3*16)+40)};class Game{constructor(t,e){server=t,game=this,this.states=[],this._points=[],this._pTime=0,this._eTime=2e3,this.pCol=1,this.id=e,this.players={},this.actors={},this.player=null,server||(this.cam=new Obj),this.bp=new BroadPhase({w:1e3,h:1e3,size:24}),this.objPool=ObjectPool(Obj),_tV=vec(),_tV2=vec(),_hit=vec(),this.GL=createGameLoop(),this.GL.setBegin(this.begin),this.GL.setUpdate(this.update),this.GL.setEnd(this.end),server||this.GL.setDraw(this.render),setTimeout(this.GL.start,100)}addPlayer(t,e){e=e||{},_p=this.players[t]=new Obj(t,e.socket,95*Math.random(),95*Math.random()),this.actors[t]=_p,server&&(e.ship+=this.pCol++,this.pCol>4&&(this.pCol=1),_p.sprite=e.ship,_o=shipStats(e.ship),_p.life=100*_o[0],_p.mLife=100*_o[0],_p.boost=_o[1],_p.tSpd=_o[2],"2"===e.ship[0]&&(_p.fSpeed=150),"3"===e.ship[0]&&(_p.fSpeed=300)),t===this.id&&(this.player=_p),server&&this.sendState()}removeObj(t){if((_p=game.actors[t])&&!_p.dead)switch(_p.type){case"player":delete this.players[t],server&&(removeUser(users[t]),this.sendState());break;case"enemy":case"cargo":!server&&_p.pos.dist(game.player.pos)<500&&playBuffer("splode",.01,40);default:_p.release()}delete game.actors[t]}sendState(){for(_pI in _state={rT:Date.now()},this.actors)_p=this.actors[_pI],_state[_p.id]=[_p.pos.x,_p.pos.y,_p.vel.x,_p.vel.y,_p.dir,"B"===_p.type.substr(1,1)?_p.pID:_p.input,_p.type.substr(0,2),_p.life,!!_p.input&&_p.axis.dir(),_p.sprite];for(_pI in this.players)this.players[_pI].socket.emit("state",_state)}receiveState(t){game.states.push(t)}applyState(t){for(_oI in t)if("rT"!==_oI){switch(_o=t[_oI],(_p=game.actors[_oI])&&_p.type.substr(0,2)!==_o[6]&&(game.removeObj(_oI),_p=null),_o[6]){case"pl":_p||(addShip(_o[9]),this.addPlayer(_oI)),_o[7]<_p.life&&(_p.life=_o[7],_p.hurt=Date.now(),emitParticle(_p.pos,0,"splosion"),_oI===game.id?(gotHit(),_p.life<=0&&(_p.dead=!0,localStorage.highScore=Math.max(localStorage.highScore||0,_p.points),_hInt=setInterval(gotHit,200),setTimeout(()=>{clearInterval(_hInt)},2600))):playBuffer("hit",.1,Math.floor(16*(1-_p.life/1e3))+40)),_p.life=_o[7],1===_p.mLife&&(_p.mLife=_p.life);break;case"pB":case"eB":_p||(_p=game.fireBullet(0,_o,_oI),_o[5]===game.id&&cam.shake(game.player.dir+.001),playBuffer("shoot",.05,"eB"===_o[6]?76:80));break;case"en":case"ca":_p||(addShip(_o[9]),game.addEnemy(_o,_oI)),_o[7]<_p.life&&(_p.life=_o[7],_p.hurt=Date.now(),emitParticle(_p.pos,0,"splosion"),playBuffer("hit",.05,Math.floor(16*(1-_p.life/1e3))+40))}_p&&(_p.pos.x=_o[0],_p.pos.y=_o[1],_p.vel.x=_o[2],_p.vel.y=_o[3],_p.dir=_o[4],_p.input=_o[5],_p.axis.vFrD(_o[8]),_p.sprite=_o[9])}for(_pI in this.actors)(_p=this.actors[_pI])&&!t[_pI]&&game.removeObj(_pI)}sendInput(){if(_p=game.player){if((cInput[2]||cInput[3])&&(_wasMoving=!0),cInput=[socket.id,0,0,0,null],(mouse.pressed||touchIDs[1])&&(cInput[1]=1),keys[32]&&(cInput[1]=2),_tV.clr(),_tID=touchIDs[0],null!==_tID?(_t=touches[_tID],_tP=touchPos(_t),_tV.copy(_tP).sub(touchPos(touchStart[0]))):((keys[65]||keys[81]||keys[37])&&(_tV.x-=1),(keys[87]||keys[90]||keys[38])&&(_tV.y-=1),(keys[68]||keys[39])&&(_tV.x+=1),(keys[83]||keys[40])&&(_tV.y+=1)),_tV.unit(),cInput[2]=_tV.x,cInput[3]=_tV.y,_tID=touchIDs[1],null!==_tID?(_t=touches[_tID],_tP=touchPos(_t),cInput[4]=_tP.sub(touchPos(touchStart[1])).dir()):_tV.dir()+PI>=0&&(cInput[4]=_tV.dir()),!_tID)switch(cInput[1]){case 1:cInput[4]=_tV.copy(mouse).sub(game.player.pos).dir();break;case 2:cInput[4]=_tV.dir()}null===cInput[4]&&(cInput[4]=lR),(cInput[1]||cInput[2]||cInput[3]||cInput[4]!==lR||_wasMoving)&&(_wasMoving=!1,socket.emit("input",cInput),lR=cInput[4])}}receiveInput(t){input[t[0]]||(input[t[0]]=[]),input[t[0]].push(t)}checkCollision(t,e){return!(!t||!e)&&(_hit.copy(t.pos).sub(e.pos),_hw=t.w/2+e.w/2,_hit.mag()<_hw&&(_hw-=_hit.m,_hit.unit().scl(_hw)))}fireBullet(t,e,s){if(server){if(!t.firing)switch(t.firing=!0,t.fTime=Date.now(),_tV.vFrD(t.dir).scl("player"===t.type?8:5),4==t.sprite[0]&&_tV.scl(-1),_o={type:"player"===t.type?"pBullet":"eBullet",x:t.pos.x+_tV.x,y:t.pos.y+_tV.y,dir:t.dir,vx:t.vel.x+_tV.x,vy:t.vel.y+_tV.y,pID:t.id,w:bWs[t.sprite[0]]},t.sprite[0]){case"2":t.fI=(t.fI+1)%2,_tV2.vFrD(t.dir+PI/2*(t.fI?1:-1)).scl(4),_o.x+=_tV2.x,_o.y+=_tV2.y,_b=game.objPool.newObject(_o),game.actors[_b.id]=_b;break;case"3":case"4":_b=game.objPool.newObject(_o),game.actors[_b.id]=_b,_tV2.vFrD(t.dir+PI/2).scl(10),_o.x+=_tV2.x,_o.y+=_tV2.y,_o.vx+=_tV2.x/6,_o.vy+=_tV2.y/6,_b=game.objPool.newObject(_o),game.actors[_b.id]=_b,_o.x-=2*_tV2.x,_o.y-=2*_tV2.y,_o.vx-=_tV2.x/3,_o.vy-=_tV2.y/3,_b=game.objPool.newObject(_o),game.actors[_b.id]=_b;break;default:_o.w=12,_b=game.objPool.newObject(_o),game.actors[_b.id]=_b}}else _b=game.objPool.newObject({type:"pB"===e[6]?"pBullet":"eBullet",x:e[0],y:e[1],id:s,pID:e[5],w:bWs[game.actors[e[5]].sprite[0]]}),game.actors[_b.id]=_b;return _b}findSpawnLocation(t,e){for(_pI in _tV.vFrD(Math.random()*PI*2).scl(360).add(t.pos),game.players)if(_p=game.players[_pI],_tV.dist(_p.pos)<250)return!1;return[_tV.x,_tV.y,_tV.dir()]}addEnemy(t,e,s){s&&(t=game.findSpawnLocation(s),randomShip(Math.random()<.8?1:2)),t&&(server||(_ship=t[9]),_p=game.objPool.newObject({type:"4"==_ship[0]?"cargo":"enemy",x:t[0],y:t[1],id:e,w:"4"==_ship[0]?28:16,sprite:_ship}),s&&_p.vel.copy(s.vel),"cargo"==_p.type&&_p.vel.scl(.5),game.actors[_p.id]=_p)}begin(t,e,s){if(game)if(server){if(game.sendState(),s-game._pTime>500){for(_pI in game._pTime=s,game._points=[],game.players)_p=game.players[_pI],game._points.push([_p.points,_p.sprite[4],_p.id]),game._points.sort((t,e)=>e[0]-t[0]);for(_pI in game.players)game.players[_pI].socket.emit("score",game._points)}}else game.sendInput()}update(t,e){if(game)if(server){for(_pI in game._eTime-=t,game._eTime<=0&&(game._eTime=3e3,_actors=Object.keys(game.players),game.addEnemy(null,null,game.players[_actors[Math.random()*_actors.length|0]])),game.actors){if(_p=game.actors[_pI],input[_p.id]&&input[_p.id].length>0)for(;input[_p.id].length>0;)_i=input[_p.id].shift(),_p.processInput(_i,t);_p.update(t)}game.bp.clearGrid(),_actors=[],Object.keys(game.actors).forEach(t=>{_actors.push(game.actors[t])}),game.bp.populateGrid(_actors);Date.now();for(_pI in game.actors)for(_p=game.actors[_pI],cList=game.bp.findMatches(_p),_oI=0;_oI<cList.length;_oI++)_o=cList[_oI],!_p||!_o||_p.hurt||_o.hurt||_p.pID===_o.id||_o.pID===_p.id||_o.collidedWith[_p.id]||_p.collidedWith[_o.id]||game.checkCollision(_p,_o)&&collision(_p,_o)}else{for(_pI in Date.now()>_beatTime&&game.player&&(_hw=1-game.player.life/game.player.mLife,_beatTime=Date.now()+350-200*_hw,_beat%2==0&&playBuffer("lead",.05,35+_song[(_beat/2|0)%2]+_seq[(_beat/16|0)%4]),_hw>.67&&_beat%4==0&&playBuffer("beat",1),_hw>.5&&_beat%4!=3&&playBuffer("hat",_beat%4==0?1:.7),_beat++),particlePool.active.forEach(e=>updateParticle(t,e)),game.actors)(_p=game.actors[_pI]).update(t),_p.id===game.id||"player"!==_p.type&&"enemy"!==_p.type&&"cargo"!==_p.type||(_tV.copy(_p.pos).sub(game.player.pos),_H=_tV.x/_tV.y,_W=_tV.y/_tV.x,_p.pos.x>game.player.pos.x?(_X=cam.pos.x+cam.w/scale-game.player.pos.x,_p.pos.y>game.player.pos.y?(_Y=cam.pos.y+cam.h/scale-game.player.pos.y,_X/_H<_Y?_p.arrow.copy({x:_X,y:_X/_H}):_p.arrow.copy({x:_Y/_W,y:_Y})):(_Y=game.player.pos.y-cam.pos.y,Math.abs(_X/_H)<_Y?_p.arrow.copy({x:_X,y:_X/_H}):_p.arrow.copy({x:-_Y/_W,y:-_Y}))):(_X=game.player.pos.x-cam.pos.x,_p.pos.y>game.player.pos.y?(_Y=cam.pos.y+cam.h/scale-game.player.pos.y,Math.abs(_X/_H)<_Y?_p.arrow.copy({x:-_X,y:-_X/_H}):_p.arrow.copy({x:_Y/_W,y:_Y})):(_Y=game.player.pos.y-cam.pos.y,Math.abs(_X/_H)<_Y?_p.arrow.copy({x:-_X,y:-_X/_H}):_p.arrow.copy({x:-_Y/_W,y:-_Y}))),_p.arrow.scl(.9).add(game.player.pos),_p.arrow.s=1.7*(1.2-_p.pos.dist(game.player.pos)/1500),"player"==_p.type&&_p.arrow.s<.4&&(_p.arrow.s=.4),_p.arrow.d=_tV.dir());for(_sI=0;_sI<game.states.length;_sI++)_s=game.states[_sI],Date.now()>_s.rT+100&&(game.applyState(_s),game.states.shift(),_sI--);game.player&&cam.follow(t)}}render(){if(game){for(_pI in ctx.fillStyle=colours[16],ctx.fillRect(0,0,cam.w,cam.h),ctx.save(),ctx.scale(scale,scale),ctx.translate(-cam.pos.x+cam.shk.x,-cam.pos.y+cam.shk.y),cam.bg.forEach((t,e)=>{ctx.drawImage(images.stars,t[0],t[1],t[2],t[3],0===e||2===e?cam.pos.x:cam.pos.x+t[4],0===e||1===e?cam.pos.y:cam.pos.y+t[5],t[2],t[3])}),game.actors)_p=game.actors[_pI],cam.offScreen(_p)?"player"!==_p.type&&"enemy"!==_p.type&&"cargo"!==_p.type||_p.id===game.id||_p.arrow.d&&(ctx.save(),ctx.translate(_p.arrow.x,_p.arrow.y),ctx.rotate(_p.arrow.d-PI/2),ctx.scale(_p.arrow.s,_p.arrow.s),ctx.drawImage(images.sprites,8*_p.sprite[4]||0,80,8,8,-8,-8,16,16),ctx.restore()):displayObj(_p);if(particlePool.active.forEach(t=>displayObj(t)),ctx.restore(),_p=game.player){if(_p.dead)ctx.fillStyle="white",ctx.fillText("YourScore: "+_p.points,cnv.width/scale/4,cnv.height/scale/2),ctx.fillText("High Score: "+(localStorage.highScore||0),cnv.width/scale/4,cnv.height/scale/4);else{for(_oI=0;_oI<game._points.length;_oI++)_o=game._points[_oI],ctx.fillStyle=colours[palettes[_o[1]][1]],ctx.font=Math.floor(10*scale)+"px futura",ctx.fillText(_o[0],10,30+_oI*Math.floor(10*scale));ctx.fillStyle=colours[0],ctx.fillText("❤️"+Math.max(0,_p.life),128,30)}for(_oI=0;_oI<2;_oI++)(_o=touchStart[_oI])&&(ctx.strokeStyle="red",ctx.beginPath(),ctx.moveTo(_o.clientX,_o.clientY),_o=touches[touchIDs[_oI]],ctx.lineTo(_o.clientX,_o.clientY),ctx.stroke())}}}end(){if(game){for(_pI in game.actors)(_p=game.actors[_pI]).collidedWith={};server||(mouse.moved=!1)}}}let rowResult,areaResult,_top,_bottom,_right,_row,_cells,_cell,matchResults,results,knownIDs,vec=(t,e)=>new Vec(t,e);class Vec{constructor(t=0,e=0){return this.x=t,this.y=e,this.m=0,this}copy(t){return this.x=t.x,this.y=t.y,this}vFrD(t){return this.x=Math.cos(t),this.y=Math.sin(t),this}clr(){return this.x=0,this.y=0,this}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}scl(t){return this.x*=t,this.y*=t,this}dir(){return Math.atan2(this.y,this.x)}dist(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y))}mag(){return this.m=Math.sqrt(this.x*this.x+this.y*this.y),this.m}unit(){return this.mag(),this.x/=this.m,this.y/=this.m,this.mag(),this}}class Obj{constructor(t,e,s,i,a,o,_){this.socket=e,this.id=t||objID++,this.type=_||"player",this.points=0,this.life=1,this.mLife=1,this.hurt=!1,this.heal=750,this.fS="hsl("+Math.floor(256*Math.random())+",100%,50%)",this.pos=vec(s,i),this.vel=vec(),this.axis=vec(),this.dir=0,this.acc=.3,this.boost=1,this.tDir=vec(),this._d,this.target=vec(),this._in=[],this.tSpd=1,this.w=a||16,this.h=o||16,this.firing=0,this.fSpeed=200,this.fTime=0,this.fI=0,this.input=!1,this.collidedWith={},this.arrow=vec(),this.debug=!1}init(t){this.type=t.type,this.arrow.clr(),this.name=t.name,this.lastHit=null,this.life=t.life||1e3,this.hurt=!1,this.dead=!1,this.mLife=t.life,this.dir=t.dir||0,this.pos.copy(t),this.vel.x=t.vx||0,this.vel.y=t.vy||0,this.id=t.id||this.id,this.pID=t.pID,this.fSpeed=600,this.acc="enemy"==this.type?.25:.1,this.w=t.w,this.h=t.h||t.w,this.sprite=t.sprite}update(t){if(this.pos.add(this.vel),("player"===(_p=this).type||"enemy"===_p.type||"cargo"===_p.type)&&this.vel.mag()>2.5&&this.vel.unit().scl(2.5),server)switch(this.type){case"pBullet":case"eBullet":this.life-=Math.floor(t),this.life<=0&&game.removeObj(this.id);break;case"player":this.heal-=t,this.heal<0&&(this.heal=750,this.life=Math.min(this.mLife,this.life+10)),this.life<=0&&game.removeObj(this.id);break;case"enemy":case"cargo":nearestPlayer(this)>1500&&game.removeObj(this.id),this.life<=0?(game.removeObj(this.id),this.dead=!0):this.ai(t)}else switch(this.type){case"player":case"enemy":case"cargo":this.input&&!this.dead&&emitParticle(_tV.vFrD(this.dir).unit().scl("cargo"===this.type?-28:-8).add(this.pos),this.axis.dir(),"thruster",-1*this.vel.mag());break;case"eBullet":case"pBullet":emitParticle(this.pos,0,"bullet")}this.hurt&&Date.now()-this.hurt>100&&(this.hurt=!1),this.firing&&Date.now()>this.fTime+this.fSpeed+50*Math.random()&&(this.firing=!1)}processInput(t,e){this.input=!1,this.axis.x=t[2],this.axis.y=t[3],((_dir=Math.abs(this.axis.dir()+PI-(t[4]+PI)))<.5||_dir>2*PI-.5)&&(this.boost=2),this.vel.x+=t[2]*this.acc*this.boost*e/1e3,this.vel.y+=t[3]*this.acc*this.boost*e/1e3,this.tDir=t[4]||0,this.boost=1,t[1]&&game.fireBullet(this),(t[2]||t[3])&&(this.input=!0),this._d=this.turnDir(this.dir+PI,this.tDir+PI),this._d&&(this.input||2!==t[1])&&(this._d=this.turn(this._d,this.tSpd*e/1e3),this.dir=(this.dir+this._d)%(2*PI))}ai(t){if(this.target){switch(this._in=[],_dist=this.pos.dist(this.target.pos),_tV.copy(this.pos).sub(this.target.pos).unit(),this.type){case"enemy":_dist>75&&_dist<125?_tV.vFrD(_tV.dir()+1.5*PI):_dist<2e3&&_tV.scl(-1),_dist<280&&_dist>125&&(this._in[1]=1);break;case"cargo":_dist<260&&(this._in[1]=1)}this._in[2]=_tV.x,this._in[3]=_tV.y,this._in[4]=_tV.dir(),this.processInput(this._in,t)}}collided(t){switch(_o=game.players[t.pID||t.id],this.type){case"player":this.life-=50,_o&&(_o.points+=this.life<=0?1e3:50);break;case"enemy":"eBullet"!==t.type&&(this.life-=256),_o&&(_o.points+=this.life<=0?100:10);break;case"cargo":"eBullet"!==t.type&&(this.life-=64),_o&&(_o.points+=this.life<=0?500:25);break;case"pBullet":case"eBullet":this.dead||(game.removeObj(this.id),this.dead=!0)}this.hurt=Date.now()}turnDir(t,e){return t>e?-this.turnDir(e,t):e-t<2*PI-e+t?e-t:-(2*PI-e+t)}turn(t,e){return Math.abs(t)>e?t>0?e:-e:t}}function ObjectPool(t){let e={active:[],inactive:[]};return e.newObject=function(s){let i;return e.inactive.length<1?((i=new t).init(s),i.release=(()=>{e.active.splice(e.active.indexOf(i),1),e.inactive.push(i)})):(i=e.inactive.shift()).init(s),e.active.push(i),i},e}let count=10;function BroadPhase(t){let e={grid:[]};return e.w=t.w,e.h=t.h,e.size=t.size,e.findCell=function(t){if(t)return vec(Math.floor(t.x/e.size),Math.floor(t.y/e.size))},e.findCellsRow=function(t,e){rowResult=[];for(let s=0,i=e.x-t.x+1;s<i;s++)rowResult.push(vec(t.x+s,t.y));return rowResult},e.findCellsArea=function(t){areaResult=[],_top=e.findCell({x:t.pos.x-t.w/2,y:t.pos.y-t.h/2}),_right=e.findCell({x:t.pos.x+t.w/2,y:t.pos.y});for(let s=0,i=(_bottom=e.findCell({x:t.pos.x,y:t.pos.y+t.h/2})).y-_top.y+1;s<i;s++)_row=e.findCellsRow(vec(_top.x,_top.y+s),vec(_right.x,_top.y+s)),areaResult=areaResult.concat(_row);return areaResult},e.addToGrid=function(t){for(let s=0,i=(_cells=e.findCellsArea(t)).length;s<i;s++)_cell=_cells[s],e.grid[_cell.y]||(e.grid[_cell.y]=[]),e.grid[_cell.y][_cell.x]||(e.grid[_cell.y][_cell.x]=[]),e.grid[_cell.y][_cell.x].push(t)},e.clearGrid=function(){e.grid=[]},e.populateGrid=function(t){t.forEach(t=>{e.addToGrid(t)})},e.findMatches=function(t){return matchResults=[],knownIDs=[],results=[],(_cells=e.findCellsArea(t)).forEach(t=>{void 0!==e.grid[t.y]&&void 0!==e.grid[t.y][t.x]&&(matchResults=matchResults.concat(e.grid[t.y][t.x]))}),count--,matchResults.forEach((e,s)=>{e.id!==t.id&&-1===results.indexOf(e)&&results.push(e)}),results},e}function createGameLoop(){var t,e,s,i,a=1e3/60,o=0,_=0,r=0,p=60,h=0,l=0,c=0,n=0,d=!1,m=!1,y=server?(i=Date.now(),function(t){return e=Date.now(),s=Math.max(0,a-(e-i)),i=e+s,setTimeout(function(){t(e+s)},s)}):window.requestAnimationFrame,u=server?clearTimeout:window.cancelAnimationFrame,f=()=>{},g=f,I=f,x=f,b=f;function w(e){if(t=y(w),!(e<r+n)){for(_+=e-r,r=e,g(e,_,o),e>h+1e3&&(p=.25*l+.75*p,h=e,l=0),l++,c=0;_>=a;)if(I(a,o+=a),_-=a,++c>=240){m=!0;break}x(_/a),b(p,m),m=!1}}return{setBegin:function(t){return g=t||g,this},setUpdate:function(t){return I=t||I,this},setDraw:function(t){return x=t||x,this},setEnd:function(t){return b=t||b,this},start:function(){return d||(d=!0,t=y(function(e){x(1),!0,r=e,h=e,l=0,t=y(w)})),this},stop:function(){return!1,d=!1,u(t),this}}}