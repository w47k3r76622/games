var g={interval:1e3/30,lastTime:0,highscore:{0:0,1:0,2:0},title:!0,music:!1,images:{},story:["It's dark. Warnings are flashing everywhere.","I'm on some kind of... damaged space station?","The reactor's working, but everything's offline.","I need to connect the oxygen, my suit won't last long.","Then let's see if the escape systems are working..."],tooltips:{main:"Main Power. Connect to systems to power them.",aux:"Aux Power. Just needs a little kick to get started.",o2:"Oxygen. Connect hexes to this to make them breathable.",fuel:"Fuel. Connect to the Escape system to fuel it.",escape:"Escape Pod. Add fuel then power to operate.",fabber:"Fabrication Systems. Pick up new conduits from here.",spare:"Connects empty faces of this hex with a conduit.",spareNo:"Cannot place conduit in this hex."},options:{invertControls:!1,difficulty:0,colorblind:!1},menuButtons:{invertControls:new MenuButton(235,125,330,30,function(){return!0},function(){g.options.invertControls=!g.options.invertControls}),diffNormal:new MenuButton(235,345,330,30,function(){return g.title||g.showStory},function(){(g.title||g.showStory)&&(g.options.difficulty=0)}),diffHard:new MenuButton(235,385,330,30,function(){return g.title||g.showStory},function(){(g.title||g.showStory)&&(g.options.difficulty=1)}),diffIronman:new MenuButton(235,425,330,30,function(){return g.title||g.showStory},function(){(g.title||g.showStory)&&(g.options.difficulty=2)}),colorblind:new MenuButton(220,495,345,30,function(){return!0},function(){g.options.colorblind=!g.options.colorblind})}};function MenuButton(e,t,o,n,a,i){this.x=e,this.y=t,this.width=o,this.height=n,this.selectableWhile=a,this.calls=i}function setup(){document.getElementById("canvasContainer").innerHTML="",g.canvas=document.createElement("canvas"),g.canvas.id="canvas",g.canvas.width=800,g.canvas.height=600,g.canvas.font="24px monospace",document.getElementById("canvasContainer").appendChild(g.canvas),g.ctx=g.canvas.getContext("2d"),document.getElementById("canvas").onmousemove=function(e){handleMouseMove(e)},document.getElementById("canvas").onmousedown=function(e){handleMousedown(e)},document.getElementById("canvas").oncontextmenu=function(e){return!1},g.ctx.strokeStyle="white",load(),initialiseData(),gameLoop()}function load(){try{var e=localStorage.getItem("offline");if(e)if(isNaN(parseInt(e))){var t=JSON.parse(e);isNaN(t.highscore)?t.highscore&&(g.highscore=t.highscore):(g.highscore[0]=t.highscore,g.highscore[1]=0,g.highscore[2]=0),t.options.invertControls&&(g.options.invertControls=!0),t.options.difficulty&&(g.options.invertControls=t.options.difficulty),t.options.colorblind&&(g.options.colorblind=!0)}else g.highscore[0]=parseInt(e),g.highscore[1]=0,g.highscore[2]=0}catch(e){}}function initialiseData(){g.showStory=!1,g.storyClicks=0,g.stars=[];for(var e=0;e<120;e++)g.stars.push(new Star(Math.floor(g.canvas.width*Math.random()),Math.floor(g.canvas.height*Math.random())));g.tooltip=!1,g.score=0;var t=new Image;t.src="astronaut.gif",g.images.astronaut=t}function initialiseMap(){g.spareConduit=!1,g.status={"Main Power":!1,Oxygen:!1,"Aux Power":!1,Fuel:!1,Fabber:!1,Escape:!1},g.loc={x:0,y:0},g.o2=10,g.escapeSequence=0,generateHexes(),g.status={"Main Power":!1,Oxygen:!1,"Aux Power":!1,Fuel:!1,Fabber:!1,Escape:!1},checkConnections()}function generateHexes(){g.hexes=[];for(var e=-4;e<=4;e++)for(var t=-4;t<=4;t++)g.hexes.push(new Hex(e,t));var o=getHex(-1,-1);o.cons=[new Conduit(0,0),new Conduit(1,1),new Conduit(2,2),new Conduit(3,3),new Conduit(4,4),new Conduit(5,5)],o.isPowerSource=!0;var n=getHex(1,1);n.cons=[new Conduit(0,0),new Conduit(1,1),new Conduit(2,2),new Conduit(3,3),new Conduit(4,4),new Conduit(5,5)],n.isO2Source=!0;var a=getHex(4,-4);a.isAuxPower=!0,a.rot=0,a.dispRot=0,a.cons=[new Conduit(0,0),new Conduit(1,1),new Conduit(2,2)];var i=getHex(-4,4);i.isFuelSource=!0,i.rot=0,i.dispRot=0,i.cons=[new Conduit(3,3),new Conduit(4,4),new Conduit(5,5)];var r=getHex(4,4);r.isEscape=!0,r.rot=0,r.dispRot=0,r.cons=[new Conduit(2,2),new Conduit(3,3)];var s=getHex(-4,-4);if(s.isFabber=!0,s.rot=0,s.dispRot=0,s.cons=[new Conduit(5,5),new Conduit(0,0)],generateValidCornerHexes([[-3,-4],[-4,-3],[3,4],[4,3]]),checkConnections(),0==g.options.difficulty)if(getHex(1,1).isPowered){var c=[[0,1],[0,2],[1,0],[1,2],[2,0],[2,1]];for(var l in c)rotateHex(getHex(c[l][0],c[l][1]),Math.random()>.5?1:-1,!0);if(checkConnections(),!getHex(1,1).isPowered)return!0;generateHexes()}else generateHexes();else getHex(1,1).isPowered&&generateHexes();2==g.options.difficulty&&(getHex(3,4).cons=[],getHex(4,3).cons=[])}function Star(e,t){this.x=e,this.y=t,this.d=Math.random()/2+.75}function Hex(e,t,o,n){this.x=e,this.y=t,this.rot=o||Math.floor(5*Math.random()),this.dispRot=Math.floor(this.rot),this.cons=n||randomHexCons(),this.isPowered=!1,this.isPowerSource=!1,this.isAuxPower=!1,this.isOxygenated=!1,this.isO2Source=!1,this.isFuelSource=!1,this.isFueled=!1}function Conduit(e,t){this.face1=e,this.face2=t,this.hasPower=!1,this.hasO2=!1}function randomHexCons(){var e=randomCon();return[e,randomCon(e)]}function randomCon(e){var t=chooseRandom([0,1,2,3,4,5]),o=chooseDiffRandom([0,1,2,3,4,5],t),n=!!e&&[e.face1,e.face2];return void 0===e||-1===n.indexOf(t)&&-1===n.indexOf(o)?new Conduit(t,o):randomCon(e)}function generateValidCornerHexes(e){for(var t in e){var o=getHex(e[t][0],e[t][1]),n=new Conduit(0,3),a=randomCon(n);o.cons=[n,a]}}function toggleMusic(){g.music?(sequence1.stop(),sequence2.stop(),sequence3.stop(),g.music=!1):(when=ac.currentTime,sequence1.play(when+60/tempo*48),sequence2.play(when+60/tempo*16),sequence3.play(when),g.music=!0)}function toggleMenu(){g.menu=!g.menu}function moveStars(e){for(var t in g.stars)g.stars[t].x-=e*g.stars[t].d,g.stars[t].x<0&&(g.stars[t].x+=g.canvas.width)}function checkConnections(){var e=[],t=[],o=[];g.status["Main Power"]=!1,g.status.Oxygen=!1,g.status.Fuel=!1,g.status.Fabber=!1,g.status.Escape=!1;for(var n in g.hexes){(i=g.hexes[n]).isPowered=!1,i.isOxygenated=!1;for(var a in i.cons)i.cons[a].hasPower=!1,i.cons[a].hasO2=!1,i.cons[a].hasFuel=!1;if(i.isPowerSource){g.status["Main Power"]=!0;for(var a in i.cons)i.cons[a].hasPower=!0,e.push([i,i.cons[a]])}}spreadPower(e);for(var n in g.hexes){if((i=g.hexes[n]).isO2Source&&i.isPowered){g.status.Oxygen=!0,i.isOxygenated=!0;for(var a in i.cons)i.cons[a].hasO2=!0,t.push([i,i.cons[a]])}}spreadO2(t);for(var n in g.hexes){var i;if((i=g.hexes[n]).isFuelSource&&i.isPowered){g.status.Fuel=!0;for(var a in i.cons)i.cons[a].hasFuel=!0,o.push([i,i.cons[a]])}}spreadFuel(o)}function spreadPower(e){var t=[];for(var o in g.hexes){var n=g.hexes[o];for(var a in n.cons){var i=n.cons[a];if(!i.hasPower)for(var r in e){var s=e[r];testForConnection(n,s[0],i,s[1])&&(n.isPowered=!0,i.hasPower=!0,t.push([n,i]))}}if(n.isAuxPower&&n.isPowered){n.isPowerSource=!0,g.status["Aux Power"]=!0;for(var a in n.cons)n.cons[a].hasPower||(n.cons[a].hasPower=!0,t.push([n,n.cons[a]]))}n.isFabber&&n.isPowered&&(g.status.Fabber=!0),n.isEscape&&n.isPowered&&n.isFueled&&(g.status.Escape=!0)}e.length>0&&spreadPower(t)}function spreadO2(e){var t=[];for(var o in g.hexes){var n=g.hexes[o];for(var a in n.cons){var i=n.cons[a];if(!i.hasPower&&!i.hasO2)for(var r in e){var s=e[r];testForConnection(n,s[0],i,s[1])&&(n.isOxygenated=!0,i.hasO2=!0,t.push([n,i]))}}n.isEscape&&n.isPowered&&(n.isOxygenated=!0)}e.length>0&&spreadO2(t)}function spreadFuel(e){var t=[];for(var o in g.hexes){var n=g.hexes[o];for(var a in n.cons){var i=n.cons[a];if(!i.hasPower&&!i.hasO2&&!i.hasFuel)for(var r in e){var s=e[r];testForConnection(n,s[0],i,s[1])&&(n.isEscape&&(n.isFueled=!0,n.isPowered&&(g.status.Escape=!0)),i.hasFuel=!0,t.push([n,i]))}}}e.length>0&&spreadFuel(t)}function testForConnection(e,t,o,n){if(e.x===t.x&&e.y===t.y)return!1;if(testAdjacency(e,t)){var a=returnFaceIndex(e,t),i=returnFaceIndex(t,e);return!(getWrapped(o.face1+e.rot)!==a&&getWrapped(o.face2+e.rot)!==a||getWrapped(n.face1+t.rot)!==i&&getWrapped(n.face2+t.rot)!==i)}return!1}function testAdjacency(e,t){var o=e.x-t.x,n=e.y-t.y;return!(o>1||o<-1)&&(!(n>1||n<-1)&&!(Math.abs(o+n)>1))}function returnFaceIndex(e,t){var o=e.x-t.x,n=e.y-t.y;if(0==o&&-1==n)return 0;if(1==o&&-1==n)return 1;if(1==o&&0==n)return 2;if(0==o&&1==n)return 3;if(-1==o&&1==n)return 4;if(-1==o&&0==n)return 5;throw new Error("can't find face of hex "+e.x+","+e.y+" to hex "+t.x+","+t.y)}function canPlaceConduit(){var e=getHex(g.loc.x,g.loc.y);return e.cons.length<=2&&!e.isFabber&&!e.isEscape}function addConduit(){if(canPlaceConduit()){for(var e=getHex(g.loc.x,g.loc.y),t=[],o=0;o<6;o++){var n=!0;for(var a in e.cons)e.cons[a].face1==o&&(n=!1),e.cons[a].face2==o&&(n=!1);n&&t.push(o)}var i=chooseRandom(t),r=chooseDiffRandom(t,i);e.cons.push(new Conduit(i,r)),checkConnections(),g.spareConduit=!1,takeTurn()}}function takeTurn(){getHex(g.loc.x,g.loc.y).isOxygenated?g.o2=10:(g.o2--,g.o2<0&&(g.gameover=1)),g.score++}function checkFabber(){var e=getHex(g.loc.x,g.loc.y);e.isFabber&&e.isPowered&&(g.spareConduit=!0)}function checkEscape(){var e=getHex(g.loc.x,g.loc.y);if(e.isEscape&&e.isFueled&&e.isPowered)return escaped(),!0}function escaped(){g.escapeSequence=1,(0==g.highscore[g.options.difficulty]||void 0===g.highscore[g.options.difficulty]||g.score<g.highscore[g.options.difficulty])&&(g.highscore[g.options.difficulty]=g.score),save()}function save(){var e={highscore:g.highscore,options:g.options};localStorage.setItem("offline",JSON.stringify(e))}function gameLoop(){window.requestAnimationFrame(gameLoop);var e=(new Date).getTime(),t=e-g.lastTime;t>g.interval&&(clear(),drawStars(),g.menu?drawMenu():g.gameover?(drawHexMap(),drawPlayer(),drawGameOver()):g.title?drawTitle():g.showStory?drawStory(g.storyClicks):g.escapeSequence?(moveStars(.01*g.escapeSequence/10),drawHexMap(),drawEscape(g.escapeSequence),drawPlayer(),g.loc.x+=.01*g.escapeSequence/20,g.loc.y+=.01*g.escapeSequence/20,g.escapeSequence++,g.escapeSequence>100&&drawEndTitle(g.escapeSequence)):(drawHexMap(),drawPlayer(),drawInterface()),drawMenuIcon(),drawMusic(),g.lastTime=e-t%g.interval)}function clear(){g.ctx.fillStyle="black",g.ctx.fillRect(0,0,g.canvas.width,g.canvas.height)}function drawMenu(){g.ctx.fillStyle="white",drawFontCenter(g.ctx,"Menu",50,5),drawFontCenter(g.ctx,(g.options.invertControls?"☑":"☐")+" Invert Controls",130,3),drawFontCenter(g.ctx,"Click adjacent hex to move",180,2),drawFontCenter(g.ctx,"Click current hex to rotate",210,2),g.options.invertControls?drawFontCenter(g.ctx,"(RMB ↶ / LMB ↷)",240,2):drawFontCenter(g.ctx,"(LMB ↶ / RMB ↷)",240,2),drawFontCenter(g.ctx,"Difficulty",300,4),g.title||g.showStory||(g.ctx.fillStyle="#444"),drawFontCenter(g.ctx,(0===g.options.difficulty?"☑":"☐")+" Normal",350,3),drawFontCenter(g.ctx,(1===g.options.difficulty?"☑":"☐")+" Hard",390,3),drawFontCenter(g.ctx,(2===g.options.difficulty?"☑":"☐")+" Ironman",430,3),g.ctx.fillStyle="white",drawFontCenter(g.ctx,(g.options.colorblind?"☑":"☐")+" Colourblind Mode",500,3)}function drawTitle(){g.ctx.fillStyle="white",drawFont(g.ctx,"Systems Offline",130,236,6),drawFont(g.ctx,"@dhmstark js13k 2018",220,332,3),drawFont(g.ctx,"toggle music →",600,568,1.7),drawFont(g.ctx,"← menu",70,568,1.7)}function drawStory(e){if(g.ctx.beginPath(),g.storyClicks>=g.story.length)return g.showStory=!1,g.storyClicks=0,initialiseMap(),!1;g.ctx.fillStyle="white";for(var t=0;t<=e;t++)drawFont(g.ctx,g.story[t],g.canvas.width/2-g.story[t].length/2*6*2,120+80*t,2)}function drawGameOver(){g.ctx.fillStyle="rgba(0,0,0,0.8)",g.ctx.fillRect(121,240,558,42),g.ctx.fillRect(238,340,324,42),g.ctx.fillStyle="white",drawFontCenter(g.ctx,"You ran out of O₂. Game Over.",250,3),drawFontCenter(g.ctx,"Click to restart",350,3),g.gameover>1&&(initialiseData(),g.title=!0,g.gameover=0)}function drawStars(){g.ctx.fillStyle="white";for(var e in g.stars){var t=g.stars[e];g.ctx.fillRect(t.x,t.y,1,1)}}function drawHexMap(){for(var e in g.hexes){drawHex(g.hexes[e],50)}}function drawHex(e,t){var o=e.dispRot,n=hexToCanvas(e.x-g.loc.x,e.y-g.loc.y).x,a=hexToCanvas(e.x-g.loc.x,e.y-g.loc.y).y;g.ctx.beginPath(),g.ctx.moveTo(n+Math.cos(o*Math.PI/3)*t,a+Math.sin(o*Math.PI/3)*t);for(var i=1;i<=6;i++)g.ctx.lineTo(n+Math.cos((o+i)*Math.PI/3)*t,a+Math.sin((o+i)*Math.PI/3)*t);g.ctx.closePath(),g.ctx.strokeStyle="white",g.ctx.stroke();var r=1;e.selected&&r++;var s="#"+r+r+r+r;e.isOxygenated&&(r+=2),s+=""+r+r,g.ctx.fillStyle=s,g.ctx.fill();for(var c in e.cons){drawConnection(e,t,e.cons[c])}g.ctx.textAlign="center";var l=g.options.colorblind?"yellow":"red",u=g.options.colorblind?"red":"yellow";if(e.isPowerSource?(drawCircle(n,a,20,l,l),g.ctx.fillStyle="white",g.ctx.fillText("⚡",n+2,a+8)):e.isO2Source?(drawCircle(n,a,20,"royalblue",!!e.isPowered&&"royalblue"),g.ctx.fillStyle="white",drawFont(g.ctx,"O₂",n-12,a-10,2.5)):e.isAuxPower?(drawCircle(n,a,20,l,!!e.isPowered&&l),g.ctx.fillStyle=e.isPowered?"white":l,g.ctx.fillText("⚡",n+2,a+8)):e.isFuelSource?(drawCircle(n,a,20,"green",!!e.isPowered&&"green"),g.ctx.fillStyle=e.isPowered?"white":"green",g.ctx.fillText("🛢",n+2,a+6)):e.isEscape?(g.ctx.lineWidth=e.isFueled?2:1,drawCircle(n,a,20,u,e.isPowered&&e.isFueled?u:!!e.isFueled&&"#030"),g.ctx.lineWidth=1,g.ctx.fillStyle="white",g.escapeSequence||g.ctx.fillText("🚀",n+3,a+8)):e.isFabber&&(drawCircle(n,a,20,"white",!!e.isPowered&&"white"),g.ctx.fillStyle="grey",g.ctx.fillText("🏭",n+2,a+6)),e.rot!=e.dispRot){var h=(e.rot-e.dispRot)/Math.abs(e.rot-e.dispRot);e.dispRot+=.1*h,Math.abs(e.rot-e.dispRot)<.01&&(e.dispRot=e.rot)}}function drawConnection(e,t,o){var n=e.dispRot,a=hexToCanvas(e.x-g.loc.x,e.y-g.loc.y).x,i=hexToCanvas(e.x-g.loc.x,e.y-g.loc.y).y,r=Math.cos(-1/6*Math.PI);g.ctx.beginPath(),g.ctx.moveTo(a+Math.cos((n+o.face1)*Math.PI/3+Math.PI/6)*t*r,i+Math.sin((n+o.face1)*Math.PI/3+Math.PI/6)*t*r),g.ctx.quadraticCurveTo(a,i,a+Math.cos((n+o.face2)*Math.PI/3+Math.PI/6)*t*r,i+Math.sin((n+o.face2)*Math.PI/3+Math.PI/6)*t*r),o.hasPower?(g.ctx.strokeStyle=g.options.colorblind?"yellow":"red",g.ctx.shadowColor=g.options.colorblind?"#cc0":"#c00",g.ctx.shadowBlur=10):o.hasO2?g.ctx.strokeStyle="royalblue":o.hasFuel?g.ctx.strokeStyle="green":g.ctx.strokeStyle="grey",g.ctx.lineWidth=4,g.ctx.stroke(),g.ctx.shadowBlur=0,g.ctx.lineWidth=1}function drawPlayer(){var e=g.canvas.width/2,t=g.canvas.height/2;g.ctx.font="32px monospace",g.ctx.textAlign="center",g.ctx.shadowColor=getO2Color(),g.ctx.shadowBlur=30,g.ctx.drawImage(g.images.astronaut,e-15,t-17),g.ctx.shadowBlur=0}function drawInterface(){var e=0;g.ctx.strokeStyle="white",g.ctx.textAlign="right",g.ctx.font="10px monospace",g.ctx.fillStyle="black";for(var t=1;t<=10;t++)drawCircle(8+24*t,29,9,"white",g.o2>=t?"royalblue":"black"),g.ctx.beginPath(),g.ctx.arc(8+24*t,29,6,0,Math.PI/3),g.ctx.stroke();for(var o in g.status)g.ctx.fillStyle="white",drawFont(g.ctx,o,g.canvas.width-48-6*o.length*1.5,24+32*e,1.5),drawCircle(g.canvas.width-32,29+32*e,9,"white",g.status[o]&&g.status["Main Power"]?"limegreen":"black"),g.ctx.beginPath(),g.ctx.arc(g.canvas.width-32,29+32*e,6,0,Math.PI/3),g.ctx.stroke(),e++;g.spareConduit&&(g.ctx.strokeStyle="white",g.ctx.fillStyle=canPlaceConduit()?"#333":"black",g.ctx.fillRect(24,52,130,26),g.ctx.strokeRect(24,52,130,26),g.ctx.fillStyle=canPlaceConduit()?"white":"grey",drawFont(g.ctx,"Spare Conduit",32,60,1.5)),g.tooltip&&drawTooltip(g.tooltips[g.tooltip])}function getO2Color(){return"rgb("+Math.floor(65*g.o2/10)+", "+Math.floor(105*g.o2/10)+", "+Math.floor(225*g.o2/10)+")"}function drawTooltip(e){g.ctx.fillStyle="black",g.ctx.fillRect(50,g.canvas.height-52,g.canvas.width-100,32),g.ctx.fillStyle="white";drawFont(g.ctx,e,g.canvas.width/2-e.length/2*6*1.5,g.canvas.height-42,1.5)}function drawMenuIcon(){g.ctx.textAlign="left",g.ctx.font="24px sans-serif",g.ctx.fillText("⚙️",12,g.canvas.height-16)}function drawMusic(){g.ctx.textAlign="right",g.ctx.font="24px sans-serif",g.ctx.fillText(g.music?"🔊":"🔈 ",g.canvas.width-8,g.canvas.height-16)}function drawCircle(e,t,o,n,a){g.ctx.lineWidth++,g.ctx.beginPath(),g.ctx.arc(e,t,o,0,2*Math.PI),n&&(g.ctx.strokeStyle=n,g.ctx.stroke()),g.ctx.lineWidth--,g.ctx.beginPath(),g.ctx.arc(e,t,o-1,0,2*Math.PI),a&&(g.ctx.fillStyle=a,g.ctx.fill())}function drawEscape(e){var t=g.canvas.width/2,o=g.canvas.height/2;drawCircle(t,o,25,"yellow","#111111"),g.ctx.strokeStyle="#555";for(var n=0;n<3;n++){g.ctx.beginPath();var a=5*n+e%5;g.ctx.arc(t-a,o,30,(12+a/4)*Math.PI/16,(20-a/4)*Math.PI/16),g.ctx.stroke()}}function drawEndTitle(e){g.ctx.fillStyle="white";g.canvas.width;var t=4,o="Thank you for playing!";drawFont(g.ctx,o,g.canvas.width/2-o.length/2*6*t,g.canvas.height/2-120,t),t=3;var n=g.highscore[g.options.difficulty];if(e>150)if(g.score==n){var a=255*Math.cos(6*e%255/255*2*Math.PI),i=255*Math.cos((6*e+85)%255/255*2*Math.PI),r=255*Math.cos((6*e+170)%255/255*2*Math.PI);g.ctx.fillStyle="rgb("+a+","+i+","+r+")",o="New high score!",drawFont(g.ctx,o,g.canvas.width/2-o.length/2*6*t,g.canvas.height/2+60,t),g.ctx.fillStyle="white",o="You beat ",0==g.options.difficulty&&(o+="the game"),1==g.options.difficulty&&(o+="hard mode"),2==g.options.difficulty&&(o+="ironman mode"),o+=" in "+g.score+" moves!",drawFont(g.ctx,o,g.canvas.width/2-o.length/2*6*t,g.canvas.height/2+100,t)}else o="You beat ",0==g.options.difficulty&&(o+="the game"),1==g.options.difficulty&&(o+="hard mode"),2==g.options.difficulty&&(o+="ironman mode"),o+=" in "+g.score+" moves!",drawFont(g.ctx,o,g.canvas.width/2-o.length/2*6*t,g.canvas.height/2+60,t),o="Your best was "+n+" moves.",drawFont(g.ctx,o,g.canvas.width/2-o.length/2*6*t,g.canvas.height/2+100,t);e>200&&(o="Click to restart",drawFont(g.ctx,o,g.canvas.width/2-o.length/2*6*t,g.canvas.height/2+180,t))}function hexToCanvas(e,t){var o=g.canvas.height/2,n=g.canvas.width/2,a=Math.cos(-1/6*Math.PI);return o+=100*Math.sin(-1/6*Math.PI)*a*e,n+=100*Math.cos(-1/6*Math.PI)*a*e,o+=100*Math.sin(1/6*Math.PI)*a*t,{x:n+=100*Math.cos(1/6*Math.PI)*a*t,y:o}}function canvasToHex(e,t){var o=[[0,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1],[1,0]],n=50*Math.cos(-1/6*Math.PI);for(var a in g.hexes){var i=g.hexes[a],r=e-hexToCanvas(i.x,i.y).x,s=t-hexToCanvas(i.x,i.y).y;if(Math.sqrt(r*r+s*s)<n){for(var c=!1,l=0;l<o.length;l++)i.x===o[l][0]&&i.y===o[l][1]&&(c=!0);return{hex:getHex(i.x+g.loc.x,i.y+g.loc.y),selectable:c}}}return!1}function getHex(e,t){for(var o in g.hexes)if(g.hexes[o].x===e&&g.hexes[o].y===t)return g.hexes[o];return!1}function getWrapped(e){return e%6}function chooseDiffRandom(e,t){var o=chooseRandom(e);return o===t?chooseDiffRandom(e,t):o}function chooseRandom(e){var t=Math.random()*e.length;return e[Math.floor(t)]}function handleMouseMove(e){var t=e.offsetX,o=e.offsetY,n=!1;if(g.menu)for(var a in g.menuButtons){var i=g.menuButtons[a];i.selectableWhile()&&t>i.x&&t<i.x+i.width&&o>i.y&&o<i.y+i.height&&(n=!0)}else if(!g.gameover){for(var r in g.hexes)g.hexes[r].selected=!1;var s=canvasToHex(t,o);if(s&&s.hex){r=s.hex;s.selectable&&(r.selected=!0,n=!0),r.isPowerSource?r.isAuxPower||(g.tooltip="main"):r.isAuxPower?g.tooltip="aux":r.isO2Source?g.tooltip="o2":r.isFuelSource?g.tooltip="fuel":r.isEscape?g.tooltip="escape":r.isFabber?g.tooltip="fabber":g.tooltip=!1}g.spareConduit&&t>=24&&t<=154&&o>=52&&o<=78&&(g.tooltip=canPlaceConduit()?"spare":"spareNo",n=!0)}(t<48&&o+48>g.canvas.height||t+48>g.canvas.width&&o+48>g.canvas.height)&&(n=!0),g.canvas.style.cursor=n?"pointer":"default"}function handleMousedown(e){var t=e.offsetX,o=e.offsetY,n=canvasToHex(t,o).hex;if(t+48>g.canvas.width&&o+48>g.canvas.height)return toggleMusic(),!1;if(t<48&&o+48>g.canvas.height)return toggleMenu(),!1;if(g.menu)for(var a in g.menuButtons){var i=g.menuButtons[a];t>i.x&&t<i.x+i.width&&o>i.y&&o<i.y+i.height&&(i.calls(),save())}else{if(g.gameover)return g.gameover++,!1;if(g.title)return g.title=!1,g.showStory=!0,!1;if(g.showStory)return g.storyClicks++,!1;if(g.escapeSequence)return g.escapeSequence>200&&(g.title=!0,initialiseData()),!1;g.spareConduit&&t>=24&&t<=154&&o>=52&&o<=78&&addConduit(),n&&n.selected&&(n.x===g.loc.x&&n.y===g.loc.y?n.isPowerSource||n.isO2Source||n.isAuxPower||n.isEscape||n.isFuelSource||n.isFabber||(0===e.button?g.options.invertControls?rotateHex(n,1):rotateHex(n,-1):g.options.invertControls?rotateHex(n,-1):rotateHex(n,1),takeTurn()):(g.loc.x=n.x,g.loc.y=n.y,handleMouseMove(e),checkFabber(),takeTurn(),checkEscape()))}return!1}function rotateHex(e,t,o){e.rot+=t,e.rot>5&&(e.rot-=6),e.rot<0&&(e.rot+=6),e.dispRot=o?e.rot:e.rot-t,checkConnections()}for(var sequence1,sequence2,sequence3,ac="undefined"!=typeof AudioContext?new AudioContext:new webkitAudioContext,when=ac.currentTime,tempo=132,lead=["D4 w","F#4 w","G4 w","D4 w"],harmony=["D4 e","A3 e","G3 e","A3 e"],bass=["D3 w","A2 w","B2 w","G2 w"],dMajor=["D4","D4","E4","F#4","G4","A4","B4","-"],i=0;i<32;i++)Math.random()>.25?lead.push(chooseDiffRandom(dMajor,lead[lead.length-1].split(" ")[0])+" w"):(lead.push(chooseDiffRandom(dMajor,lead[lead.length-1].split(" ")[0])+" h"),lead.push(chooseDiffRandom(dMajor,lead[lead.length-1].split(" ")[0])+" h"));(sequence1=new TinyMusic.Sequence(ac,tempo,lead)).gain.gain.value=.15,sequence1.mid.frequency.value=800,sequence1.mid.gain.value=3,(sequence2=new TinyMusic.Sequence(ac,tempo,harmony)).gain.gain.value=.2,sequence2.mid.frequency.value=1200,(sequence3=new TinyMusic.Sequence(ac,tempo,bass)).gain.gain.value=.15,sequence3.mid.gain.value=3,sequence3.bass.gain.value=6,sequence3.bass.frequency.value=80,sequence3.mid.gain.value=-6,sequence3.mid.frequency.value=500,sequence3.treble.gain.value=-2,sequence3.treble.frequency.value=1400,setup();