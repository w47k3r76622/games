class t{step(t){this.speed+=this.acceleration*t,this.value+=this.speed*t}constructor(t=0,e=0,a=0){this.value=t,this.speed=e,this.acceleration=a}}const e=t=>Math.PI/180*t,a=(t,e)=>Math.atan2(e.y.value-t.y.value,e.x.value-t.x.value)/Math.PI*180+90,o=(t,e)=>((t,e,a,o)=>{const s=t-a,n=e-o;return Math.sqrt(s*s+n*n)})(t.x.value,t.y.value,e.x.value,e.y.value),s=(t,e,a)=>Math.max(e,Math.min(a,t)),n=(t,e)=>Math.floor(Math.random()*(e-t+1))+t,r=(t,e,a=0)=>t<=e+a&&t>=e-a,i=(t,e)=>{t.x.step(e),t.y.step(e),t.rotation.step(e)},l=(e,a=0,o=0,s=1024,r=1024,i=14)=>{const l=[];for(let d=0;d<e;d++){const e={color:"#fff",x:new t(n(a,a+s),n(-7,7)),y:new t(n(o,o+r),n(-7,7)),rotation:new t(n(0,359)),seed:1e3*Math.random(),size:i};l.push({state:e})}return l},d=(t,n,r)=>{const i=a(r,n),l=o(r,n),d=s(3-Math.log(l/1e3),0,3);t.save(),t.translate(r.x.value,r.y.value),t.translate(50*Math.sin(e(i)),50*-Math.cos(e(i))),t.fillStyle=n.color,t.moveTo(0,0),t.arc(0,0,d,0,2*Math.PI),t.fill(),t.restore()},h=(t,a)=>{t.save(),t.strokeStyle=a.color;const o=30;t.translate(a.x.value,a.y.value),t.rotate(e(a.rotation.value)),t.beginPath();for(let n=0;n<360;n+=.5){let r=s(o*Math.sin((a.seed+n)/(2*Math.PI)),-27,27);r+=10*Math.sin(2*a.seed+n+34),r+=7.5*Math.sin(2*a.seed+n),r+=6*Math.sin(1.6*(3*a.seed+n+128)),r+=o/7*Math.sin(3.2*(3*a.seed+n+56));const i=Math.sin(e(n))*a.size+Math.sin(e(n))*r,l=Math.cos(e(n))*a.size+Math.cos(e(n))*r;t.lineTo(i,l)}t.closePath(),t.stroke(),t.clip(),t.beginPath();for(let e=(-a.size-o)/10;e<(a.size+o)/10;e++)t.moveTo(10*e,-a.size-o),t.lineTo(10*e,a.size+o);t.stroke(),t.restore()},u=(t,e)=>{t.x.step(e),t.y.step(e),t.rotation.step(e)},v=(e=0,a=0,o="#faa")=>({state:{color:o,x:new t(e),y:new t(a),rotation:new t(n(0,359)),seed:1e3*Math.random(),size:1e3,mass:1e10}}),c=(t,a)=>{t.save(),t.strokeStyle="white",t.translate(a.x.value,a.y.value),t.rotate(e(a.rotation.value)),t.beginPath(),t.moveTo(0,0),t.lineTo(6,0),t.stroke(),t.restore()},w=(t,e)=>{t.x.step(e),t.y.step(e),t.rotation.step(e)},f=(t,a)=>{const o={forward:0,shooting:!1,turnRight:0};r(t.x.value,a.x.value,3)&&r(t.y.value,a.y.value,3)||(t.x.value<a.x.value?o.forward=Math.sin(e(90+t.rotation.value%360)):t.x.value>a.x.value&&(o.forward=-Math.sin(e(90+t.rotation.value%360))),t.y.value<a.y.value?o.forward+=-Math.cos(e(90+t.rotation.value%360)):t.y.value>a.y.value&&(o.forward+=Math.cos(e(90+t.rotation.value%360)))),o.forward=s(o.forward,-1,1);const n=((t.rotation.value-a.rotation.value)%360+360)%360;return n>180?o.turnRight=1:n<180&&(o.turnRight=-1),r(t.x.value,a.x.value,25)&&!r(t.y.value,a.y.value,25)?o.turnRight=1:r(t.y.value,a.y.value,25)&&!r(t.x.value,a.x.value,25)&&(o.turnRight=-1),!r(o.forward,0,.01)||r(t.x.value,a.x.value,25)||r(t.y.value,a.y.value,25)||(o.turnRight=1),o},p=(t,a)=>{t.save(),t.strokeStyle=a.color,t.translate(a.x.value,a.y.value),t.rotate(e(a.rotation.value+90)),t.beginPath(),t.moveTo(0,-6),t.lineTo(3,3),t.lineTo(0,1),t.lineTo(-3,3),t.lineTo(0,-6),t.stroke(),t.restore()},y=(s,n,r={},i)=>{s.x.acceleration=Math.cos(e(s.rotation.value))*i.forward*300,s.y.acceleration=Math.sin(e(s.rotation.value))*i.forward*300,s.rotation.acceleration=1400*i.turnRight,n>0&&(s.x.speed*=1-.6*n,s.y.speed*=1-.6*n,s.rotation.speed*=1-8*n);for(const t of r.planets??[]){const r=o(s,t.state);if(r<3e3){const o=-t.state.mass/Math.pow(r,2),i=a(s,t.state);s.x.acceleration-=Math.sin(e(i))*o*n,s.y.acceleration+=Math.cos(e(i))*o*n}}s.x.step(n),s.y.step(n),s.rotation.step(n),s.lastShot+=n,i.shooting&&s.lastShot>.5&&(r.shots.push((a=>{const o={active:!0,state:{x:new t(a.x.value,a.x.speed+300*Math.sin(e(90+a.rotation.value))),y:new t(a.y.value,a.y.speed-300*Math.cos(e(90+a.rotation.value))),rotation:new t(a.rotation.value)}};return setTimeout((()=>o.active=!1),1e4),o})(s)),s.lastShot=0)},g=document.getElementById("screen"),M=g.getContext("2d",{alpha:!1});let x,m;M.lineWidth=.5,g.width=g.clientWidth,g.height=g.clientHeight,window.addEventListener("resize",(()=>{g.width==g.clientWidth&&g.height==g.clientHeight||(g.width=g.clientWidth,g.height=g.clientHeight)}));const k={color:"#fff",x:new t(0),y:new t(0),rotation:new t(0),lastShot:1e3},R={forward:0,turnRight:0,shooting:!1},L={ships:[],asteroids:[...l(400,-2e3,-2e3,4e3,4e3)],planets:[v(4e3,0,"#faa"),v(-8e3,-1500,"#aaf"),v(1e3,6600,"#afa"),v(-2e3,-4e3,"#ff8")],shots:[]};setInterval((()=>{L.shots=L.shots.filter((t=>t.active))}),2e4),window.addEventListener("keydown",(t=>{"ArrowUp"===t.key&&(R.forward=1),"ArrowDown"===t.key&&(R.forward=-1),"ArrowRight"===t.key&&(R.turnRight=1),"ArrowLeft"===t.key&&(R.turnRight=-1),"Space"!==t.key&&" "!==t.key||(R.shooting=!0)})),window.addEventListener("keyup",(e=>{"ArrowUp"===e.key&&R.forward>0||"ArrowDown"===e.key&&R.forward<0?R.forward=0:"ArrowRight"===e.key&&R.turnRight>0||"ArrowLeft"===e.key&&R.turnRight<0?R.turnRight=0:"Space"===e.key||" "===e.key?R.shooting=!1:"r"===e.key.toLowerCase()&&(k.x=new t(0),k.y=new t(0),k.rotation=new t(0))}));const z={};document.getElementById("l").addEventListener("pointerdown",(t=>{t.preventDefault(),t.stopPropagation(),R.turnRight=-1,t.target.classList.add("pressed"),z[t.pointerId]="l"})),document.getElementById("r").addEventListener("pointerdown",(t=>{t.preventDefault(),t.stopPropagation(),R.turnRight=1,t.target.classList.add("pressed"),z[t.pointerId]="r"})),document.getElementById("f").addEventListener("pointerdown",(t=>{t.preventDefault(),t.stopPropagation(),R.forward=1,t.target.classList.add("pressed"),z[t.pointerId]="f"})),document.getElementById("w").addEventListener("pointerdown",(t=>{t.preventDefault(),t.stopPropagation(),R.shooting=!0,t.target.classList.add("pressed"),z[t.pointerId]="w"}));const E=t=>{const e=z[t.pointerId];e&&("r"===e&&R.turnRight>0||"l"===e&&R.turnRight<0?R.turnRight=0:"f"===e?R.forward=0:"w"===e&&(R.shooting=!1),document.getElementById(e).classList.remove("pressed"))};window.addEventListener("pointerup",E),window.addEventListener("pointercancel",E),document.addEventListener("wheel",(t=>{t.ctrlKey&&t.preventDefault()}),{passive:!1});window.addEventListener("pointerover",(t=>{document.getElementById("controls").classList.remove("hide")})),window.requestAnimationFrame((function t(a){void 0===x&&(x=a,m=x);const n=s((a-m)/1e3,0,.05);m=a;for(const t of L.asteroids)i(t.state,n);for(const t of L.planets)u(t.state,n);for(const t of L.ships){const e=f(t.state,t.desiredState);y(t.state,n,L,e)}for(const t of L.shots)t.active&&(w(t.state,n),c(M,t.state));y(k,n,L,R);for(const t of L.shots)if(t.active)for(const e of L.asteroids)t.active&&o(t.state,e.state)<e.state.size&&(14===e.state.size?L.asteroids.push(...l(3,e.state.x.value,e.state.y.value,0,0,9)):9===e.state.size&&L.asteroids.push(...l(3,e.state.x.value,e.state.y.value,0,0,5)),L.asteroids=L.asteroids.filter((t=>t!==e)),t.active=!1);M.fillStyle="#black",M.fillRect(0,0,g.width,g.height),M.save(),M.translate(g.width/2,g.height/2),M.scale(2,2),M.translate(-k.x.value,-k.y.value);for(const t of L.ships)p(M,t.state);((t,a)=>{t.strokeStyle="white",t.beginPath();for(const o of a){const{state:a}=o;t.save(),t.translate(a.x.value,a.y.value),t.rotate(e(a.rotation.value)),t.moveTo(Math.sin(0)*a.size+s(4*Math.sin(a.seed),-3,3),Math.cos(0)*a.size);for(let o=40;o<360;o+=40)t.lineTo(Math.sin(e(o))*a.size+s(4*Math.sin(a.seed+o*a.seed*1.2321),-3,3),Math.cos(e(o))*a.size),s(4*Math.sin(a.seed+o*a.seed*1.523),-3,3);t.lineTo(Math.sin(0)*a.size+s(4*Math.sin(a.seed),-3,3),Math.cos(0)*a.size),t.restore()}t.stroke()})(M,L.asteroids);for(const t of L.planets)h(M,t.state),d(M,t.state,k);for(const t of L.shots)t.active&&c(M,t.state);p(M,k),M.restore(),window.requestAnimationFrame(t)}));