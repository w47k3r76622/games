const t={data:{beat:{songData:[{i:[0,255,116,1,0,255,116,0,1,14,4,6,45,0,0,0,0,0,0,2,136,15,0,32,0,0,66,6],p:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c:[{n:[123,,123,,123,,123,,123,,123,,123,,123],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,60,4,10,34,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],p:[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],c:[{n:[],f:[]},{n:[126,,,,126,,,,130,,,,130],f:[]}]}],rowLen:11025,patternLen:16,endPattern:8,numChannels:2},hit:{songData:[{i:[3,255,152,0,0,255,152,12,0,0,2,0,60,0,0,0,0,0,0,2,255,0,0,32,47,3,0,4],p:[1],c:[{n:[144],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1}},objectURLs:{},init(t){let i=Object.keys(this.data),e=s=>{if(s>=i.length)return void t();let h=i[s],r=new g;r.init(this.data[h]);let l=setInterval(()=>{if(l&&r.generate()>=1){clearInterval(l),l=0;let t=r.createWave(),i=new Blob([t],{type:"audio/wav"}),n=URL.createObjectURL(i);this.objectURLs[h]=n,e(s+1)}},10)};e(0)},play(i,e,s){let h=new Audio(this.objectURLs[i]);return h.loop=!!e,h.volume=s||t.VOLUME,h.play(),h},VOLUME:.2},i={ACTION:{ESC:1,INTERACT:2,LEFT:10,UP:11,RIGHT:12,DOWN:13,FIGHT_1:20,FIGHT_2:21,FIGHT_3:22,FIGHT_4:23},PROMPTS:1,_gpButtons:{},_ignoreUntilReleased:{},_on:{esc:[],gp_connect:[],gp_disconnect:[],interact:[]},_onKeyDown:{},gamepads:{},isLinuxFirefox:!1,keystate:{},numGamepads:0,getDirections(){let t=0,i=0;return this.isPressed(this.ACTION.LEFT)?t=-1:this.isPressed(this.ACTION.RIGHT)&&(t=1),this.isPressed(this.ACTION.UP)?i=-1:this.isPressed(this.ACTION.DOWN)&&(i=1),{x:t,y:i}},getKeysForAction(t){let i=[],e=[];switch(t){case this.ACTION.ESC:i.push(27),e.push(9);break;case this.ACTION.INTERACT:i.push(13,69),e.push(0);break;case this.ACTION.LEFT:i.push(37),e.push(14);break;case this.ACTION.FIGHT_4:i.push(37,65),e.push(this.isLinuxFirefox?3:2,14);break;case this.ACTION.UP:i.push(38),e.push(12);break;case this.ACTION.FIGHT_3:i.push(38,87),e.push(this.isLinuxFirefox?2:3,12);break;case this.ACTION.RIGHT:i.push(39),e.push(15);break;case this.ACTION.FIGHT_2:i.push(39,68),e.push(1,15);break;case this.ACTION.DOWN:i.push(40),e.push(13);break;case this.ACTION.FIGHT_1:i.push(40,83),e.push(0,13)}return{keyboard:i,gamepad:e}},init(){let t=String(navigator.userAgent).toLowerCase();this.isLinuxFirefox=t.indexOf("linux")>=0&&t.indexOf("firefox")>=0,document.body.onkeydown=t=>{let e=this.keystate[t.which];e&&e.waitForReset||(this.keystate[t.which]={time:Date.now()},this._onKeyDown[t.which]&&this._onKeyDown[t.which]()),49===t.which?i.PROMPTS=1:50===t.which?i.PROMPTS=2:51===t.which&&(i.PROMPTS=3)},document.body.onkeyup=t=>{this.keystate[t.which]={time:0}},window.addEventListener("gamepadconnected",t=>{let e=String(t.gamepad.id).toLowerCase();e.indexOf("sony")>=0||e.indexOf("dualshock")>=0||e.indexOf("playstation")>=0||e.indexOf("ps3")>=0?i.PROMPTS=2:(e.indexOf("xbox")>=0||e.indexOf("microsoft")>=0)&&(i.PROMPTS=3),this.numGamepads++,this.gamepads[t.gamepad.index]=t.gamepad,this._on.gp_connect.forEach(t=>t())}),window.addEventListener("gamepaddisconnected",t=>{i.PROMPTS=1,this.numGamepads--,delete this.gamepads[t.gamepad.index],this._on.gp_disconnect.forEach(t=>t())})},isPressed(t,i){let e=this.getKeysForAction(t);for(let t of e.keyboard)if(this.isPressedKey(t,i))return!0;for(let t of e.gamepad)if(this.isPressedGamepad(t,i))return!0;if(t===this.ACTION.LEFT||t===this.ACTION.FIGHT_4)for(let t in this.gamepads){let e=this.gamepads[t];if(e.axes[6]&&e.axes[6]<=-.2)return!this._ignoreUntilReleased["axis6-"]&&(i&&(this._ignoreUntilReleased["axis6-"]=!0),!0)}else if(t===this.ACTION.RIGHT||t===this.ACTION.FIGHT_2)for(let t in this.gamepads){let e=this.gamepads[t];if(e.axes[6]&&e.axes[6]>=.2)return!this._ignoreUntilReleased["axis6+"]&&(i&&(this._ignoreUntilReleased["axis6+"]=!0),!0)}else if(t===this.ACTION.UP||t===this.ACTION.FIGHT_3)for(let t in this.gamepads){let e=this.gamepads[t];if(e.axes[7]&&e.axes[7]<=-.2)return!this._ignoreUntilReleased["axis7-"]&&(i&&(this._ignoreUntilReleased["axis7-"]=!0),!0)}else if(t===this.ACTION.DOWN||t===this.ACTION.FIGHT_1)for(let t in this.gamepads){let e=this.gamepads[t];if(e.axes[7]&&e.axes[7]>=.2)return!this._ignoreUntilReleased["axis7+"]&&(i&&(this._ignoreUntilReleased["axis7+"]=!0),!0)}return!1},isPressedGamepad(t,i){for(let e in this.gamepads){let s=this.gamepads[e].buttons[t];if(s&&s.pressed)return!this._ignoreUntilReleased[t]&&(i&&(this._ignoreUntilReleased[t]=!0),!0)}return!1},isPressedKey(t,i){let e=this.keystate[t];return!(!e||!e.time)&&(i&&(e.time=0,e.waitForReset=!0),!0)},off(t,i){if("function"!=typeof i)return void(this._on[t]=[]);let e=this._on[t].indexOf(i);e>=0&&this._on[t].splice(e,1)},on(t,i){this._on[t].push(i)},onKeyDown(t,i){this._onKeyDown[t]=i},update(){let t=navigator.getGamepads();for(let i of t)if(i){this.gamepads[i.index]=i;for(let t in this._ignoreUntilReleased)"axis6-"===t||"axis6+"===t?i.axes[6]||delete this._ignoreUntilReleased[t]:"axis7-"===t||"axis7+"===t?i.axes[7]||delete this._ignoreUntilReleased[t]:i.buttons[t]&&!i.buttons[t].pressed&&delete this._ignoreUntilReleased[t]}}};class e{constructor(t,i,e,s,h,r,l){this.name=t,this.desc=i.split("\n"),this.effect=e,this.collected=!1,this.centerX=s,this.x=s,this.y=h,this.size=r,this.draw=l}}e.drawSaltShaker=function(t){t.fillStyle="rgba(210,216,216,0.5)",t.fillRect(this.x,this.y,8*this.size,4*this.size),t.fillStyle="#888",t.fillRect(this.x,this.y,2*this.size,4*this.size),t.fillStyle="#FFF",t.fillRect(this.x+2*this.size,this.y+3*this.size,6*this.size,this.size),t.fillRect(this.x+3*this.size,this.y+2*this.size,5*this.size,this.size),t.fillRect(this.x+4*this.size,this.y,4*this.size,2*this.size),this.centerX=this.x+4*this.size},e.drawPan=function(t){t.save(),t.translate(this.x,this.y),t.rotate(62*Math.PI/180),t.translate(-this.x,-this.y);let i=2*this.size,e=4*this.size,s=6*this.size;t.fillStyle="#000",t.fillRect(this.x+i,this.y,s,10*this.size),t.fillRect(this.x,this.y+i,10*this.size,s),t.fillRect(this.x+this.size,this.y+this.size,8*this.size,8*this.size),t.fillRect(this.x+e,this.y+10*this.size,i,5*this.size),t.fillStyle="#333",t.fillRect(this.x+i,this.y+this.size,s,8*this.size),t.fillRect(this.x+this.size,this.y+i,8*this.size,s),t.fillRect(this.x+e,this.y+10*this.size,i,this.size),t.fillStyle="#555",t.fillRect(this.x+3*this.size,this.y+i,e,s),t.fillRect(this.x+i,this.y+3*this.size,s,e),t.restore(),this.centerX=this.x+10*this.size-70};class s{constructor(){this.progress=0}update(t){this.progress+=t/c.TARGET_FPS}}class h extends s{constructor(){super(),this.player=new d(20),this.ui_text=new p("Thanks for playing!","italic 56px serif",[255,255,255],0,0,!0)}draw(t){let i=Math.min(1,this.progress/10),e=194*(1-i)+i,s=111*(1-i)+i,h=56*(1-i)+i;t.fillStyle=`rgb(${~~e},${~~s},${~~h})`,t.fillRect(0,0,window.innerWidth,window.innerHeight),this.player.draw(t),this.ui_text.draw(t)}update(t){super.update(t);let e=.5;if(this.progress<10){let e=i.getDirections();this.player.update(t,{x:0,y:e.y}),this.player.x=c.centerX-Math.round(this.player.width/2),this.player.y=window.innerHeight-this.player.height}else this.player.x<window.innerWidth+100&&this.player.update(t,{x:1}),this.progress>=13&&(e+=Math.min(.5,(this.progress-13)/4));this.ui_text.x=c.centerX,this.ui_text.y=Math.round(c.centerY*e)}}class r extends s{constructor(){super(),this.ui_title=new p("How to send back...","italic 72px serif",[255,255,255],0,0,!0),this.ui_gp=new p("TO ACTIVATE A GAMEPAD, PRESS A BUTTON ON IT.","21px sans-serif",[255,255,255],0,0,!0),this.ui_start=new p("TO START PRESS","21px sans-serif",[255,255,255],0,0,!0),this.ui_gp.blink(),i.on("gp_connect",()=>{this.ui_gp.visible=!1}),i.on("gp_disconnect",()=>{this.ui_gp.visible=!0}),this.offsetX=window.innerWidth,this.player=new d(10),this.walk=!1}draw(t){t.fillStyle="#C26F38",t.fillRect(0,0,window.innerWidth,window.innerHeight),this.player.draw(t),this.ui_title.draw(t),this.walk||(this.ui_gp.draw(t),this.ui_start.draw(t),I.draw(t,i.ACTION.INTERACT,[c.centerX+86+this.offsetX,this.player.y-70,20])),c.drawBorder()}update(t){if(this.progress<=4){let t=1-this.progress/4;this.offsetX=Math.round(t*window.innerWidth)}if(super.update(t),this.ui_title.y=Math.round(window.innerHeight/3),this.ui_title.centerX(),this.ui_title.x+=this.offsetX,this.player.y=window.innerHeight-this.player.height-50,this.ui_gp.centerX(),this.ui_gp.update(t),this.ui_gp.x+=this.offsetX,this.ui_gp.y=this.player.y-160,this.ui_start.centerX(),this.ui_start.x-=20-this.offsetX,this.ui_start.y=this.player.y-50,this.walk&&this.player.x>1.2*window.innerWidth)c.changeLevel(new n);else if(this.walk)this.player.update(t,{x:1,y:0});else if(i.isPressed(i.ACTION.INTERACT,!0))this.walk=!0;else{let e=i.getDirections();this.player.x=(window.innerWidth-this.player.width)/2+this.offsetX,this.player.update(t,{x:0,y:e.y})}}}class l extends s{constructor(){super(),this.mod=new o(o.SCRIPT.INTRO),this.changeLevel=0,this.offsetX=0,this.mod1=new d(10),this.mod1.color=c.COLOR.MOD_1,this.mod1.face=4,this.mod1.orientationX=1,this.mod2=new d(10),this.mod2.color=c.COLOR.MOD_2,this.mod2.face=4,this.mod2.progress=10,this.mod.onDone=()=>{this.changeLevel=this.progress}}draw(t){if(t.fillStyle=c.COLOR.ORANGE,t.fillRect(0,0,window.innerWidth,window.innerHeight),this.changeLevel&&this.progress-this.changeLevel>=2)return c.drawBorder(),void c.changeLevel(new r);if(this.progress<=1.5){if(t.fillStyle=c.COLOR.BLACK,t.fillRect(0,0,window.innerWidth,window.innerHeight),this.progress>=1){let i=this.progress-1,e=window.innerWidth,s=window.innerHeight;if(i<.25)e*=4*i,s=2;else{let t=4*(i-.25);s*=t*t}let h=Math.round(c.centerX-e/2),r=Math.round(c.centerY-s/2);t.fillStyle=c.COLOR.ORANGE,t.fillRect(h,r,e,s)}}else{this.mod1.draw(t),this.mod2.draw(t);let[e,s,h]=this.mod.getText();if(h.length){let i=620,r=24,l=2*r+21*h.length;h.length>1&&(l+=11*(h.length-1));let n=0,a=this.mod1.y-l-16;t.fillStyle="rgba(0,0,0,0.5)",t.font="21px sans-serif",t.textAlign="left",t.textBaseline="top",e?(this.mod2.face=s,n=this.mod2.x-r-i,t.beginPath(),t.moveTo(n+i,a+l),t.lineTo(n+i-20,a+l),t.lineTo(n+i,a+l+20),t.closePath()):(this.mod1.face=s,n=this.mod1.x+this.mod1.width+r,t.beginPath(),t.moveTo(n,a+l),t.lineTo(n+20,a+l),t.lineTo(n,a+l+20),t.closePath()),t.fillRect(n,a,i,l),t.fill(),t.fillStyle=c.COLOR.WHITE,h.forEach((i,e)=>{t.fillText(i,n+r,a+r+32*e)})}else e?this.mod2.face=s:this.mod1.face=s;if(this.progress>=5&&!this.changeLevel){let e=Math.round(this.mod1.y+this.mod1.height/2)-40;I.draw(t,i.ACTION.INTERACT,[c.centerX-100,e-2,20]),t.font="21px sans-serif",t.fillStyle=c.COLOR.WHITE,t.textAlign="center",t.textBaseline="top",t.fillText("TO SKIP INTRO",c.centerX+20,e)}}c.drawBorder()}update(t){if(!this.changeLevel&&this.progress>1.5&&i.isPressed(i.ACTION.INTERACT,!0))return this.progress+=t/c.TARGET_FPS,void(this.changeLevel=this.progress);if(this.changeLevel){let t=this.progress-this.changeLevel;this.offsetX=Math.round(t/2*window.innerWidth)}this.mod1.x=130-this.offsetX,this.mod1.y=window.innerHeight-this.mod1.height-50,this.mod2.x=window.innerWidth-280-this.offsetX,this.mod2.y=window.innerHeight-this.mod1.height-50,this.mod1.update(t,{x:0}),this.mod2.update(t,{x:0}),this.progress>1.5&&this.mod.update(t),this.progress+=t/c.TARGET_FPS}}class n extends s{constructor(t){super(),document.head.querySelector("title").textContent="S2E1: How to send back a ghost",this.flags=t||{},this.items=[new e("SALT SHAKER","Bolster your ghost defense!\nMore time for button prompts.",{time:1.5},450,0,3,e.drawSaltShaker),new e("IRON PAN","Become more convincing.\nMore mistakes allowed.",{goal:.7},0,0,5,e.drawPan)],this.ui_challenge=new p("CHALLENGE","bold 21px sans-serif",[255,255,255],0,0,!0),this.ui_challenge.visible=!1,this.ui_collect=new p("","bold 18px sans-serif",[255,255,255],0,0,!0),this.player=new d(5),this.player.x=this.flags.success?c.centerX+100:100,this.player.orientationX=this.flags.success?-1:1,this.player.orientationY=0,Array.isArray(this.flags.items)&&this.flags.items.forEach(t=>{this.items.forEach(i=>{i.name===t.name&&(this.player.items.push(i),i.collected=!0)})}),this.playerMirror=new d(5),this.ghostDir=1,this.ghostY=0,this.flags.success||(this.mod=new o(o.SCRIPT.LEVEL_1_1),this.mod1=new d(3),this.mod1.color=c.COLOR.MOD_1,this.mod1.face=4,this.mod1.orientationX=1,this.mod1.progress=10,this.mod1.x=40,this.mod1.y=80,this.mod2=new d(3),this.mod2.color=c.COLOR.MOD_2,this.mod2.face=4,this.mod2.orientationX=-1,this.mod2.progress=35,this.mod2.x=this.mod1.x+this.mod1.width+40,this.mod2.y=80),this.bottomHeight=200}_drawDesc(t,i,e){let s=c.centerX-200;t.fillStyle=c.COLOR.WHITE,t.font="bold italic 21px sans-serif",t.textAlign="left",t.fillText(e.name,s,i+76),e.desc.forEach((e,h)=>{t.font=h?"21px sans-serif":"italic 21px sans-serif",t.fillText(e,s,i+112+36*h)}),t.fillStyle=c.COLOR.BLUE_1,t.fillRect(s-20,i+30,440,10),t.fillRect(s-20,i+170,440,10),t.fillRect(s-30,i+40,10,130),t.fillRect(s+420,i+40,10,130)}_drawMirror(t,i){t.strokeStyle=c.COLOR.BLACK,t.lineWidth=4,t.strokeRect(window.innerWidth-240,i-160,120,120),t.save(),t.beginPath(),t.rect(window.innerWidth-238,i-158,116,116),t.clip(),this.playerMirror.draw(t),t.fillStyle="rgba(210,250,250,0.3)",t.fillRect(window.innerWidth-238,i-158,116,116),t.strokeStyle="rgba(255,255,255,0.1)",t.lineWidth=20,t.beginPath(),t.moveTo(window.innerWidth-150,i-170),t.lineTo(window.innerWidth-210,i),t.stroke(),t.restore()}_drawMod(t){if(this.flags.success)return;let[i,e,s]=this.mod.getText(),h=this.mod1.width+this.mod2.width+80,r=this.mod1.height+80,l=Math.min(420,window.innerWidth-40-h);if(t.fillStyle=c.COLOR.BLACK,t.fillRect(20,20,h,r),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(20+h,20,l,r),s.length){let i=50,e=65;t.fillStyle=c.COLOR.WHITE,t.font="21px sans-serif",t.textAlign="left",this.mod.step===this.mod.script.length-1&&(e=Math.round(r/2)+30,t.font="bold italic 24px sans-serif"),s.forEach((s,r)=>{t.fillText(s,i+h,e+42*r)})}i?this.mod2.face=e:this.mod1.face=e,this.mod1.draw(t),this.mod2.draw(t)}checkItems(t,e){if(this.ui_collect.visible=!1,this.flags.success)return;this.items.forEach((s,h)=>{if(s.collected)return;Math.abs(s.centerX-this.player.x)<100&&(this.ui_collect.x=s.centerX,this.ui_collect.y=s.y-20,this.ui_collect.text="COLLECT",this.ui_collect.visible=!0,I.draw(t,i.ACTION.INTERACT,[s.centerX-10,s.y-80,20]),this._drawDesc(t,e,s),i.isPressed(i.ACTION.INTERACT,!0)&&(this.player.items.push(s),s.collected=!0))});let s=window.innerWidth-180;Math.abs(s-50-this.player.x)<100?(this.player.face=-1,this.ui_collect.x=s,this.ui_collect.y=e-180,this.ui_collect.text="DROP ALL ITEMS",this.ui_collect.visible=!0,I.draw(t,i.ACTION.INTERACT,[s-10,e-240,20]),this._drawDesc(t,e,{name:"Mirror",desc:"You got this!\nDrop all collected items.".split("\n")}),i.isPressed(i.ACTION.INTERACT,!0)&&(this.player.items.forEach(t=>t.collected=!1),this.player.items=[])):this.player.face=0}draw(t){let e=window.innerHeight-this.bottomHeight;t.strokeStyle="#000",t.fillStyle="#1A1F26",t.fillRect(0,0,window.innerWidth,e),t.fillStyle="#0A0A0A",t.fillRect(420,e-100,120,90),t.fillRect(420,e-10,10,10),t.fillRect(530,e-10,10,10),t.fillStyle="#202014",t.fillRect(430,e-90,100,70),t.fillStyle="#0A0A0A",t.fillRect(420,e-100,120,10),t.fillRect(420,e-60,120,10),t.fillRect(460,e-80,40,10),t.fillRect(460,e-40,40,10),t.fillStyle="rgba(194,111,56,0.8)",t.beginPath(),t.moveTo(0,e-340),t.lineTo(400,e),t.lineTo(0,e),t.closePath(),t.fill(),t.fillStyle=c.COLOR.BLACK,t.fillRect(0,e-340,5,340),t.lineWidth=6,t.beginPath(),t.moveTo(c.centerX,0),t.lineTo(c.centerX,e-500),t.closePath(),t.stroke(),t.fillStyle=c.COLOR.BLACK,t.fillRect(c.centerX-50,e-500,100,50);let s=c.centerX-80,h=Math.round(e-320+20*Math.sin(this.ghostY));this.flags.success&&(h=e-320,this.progress>=2&&(s+=Math.round(10*Math.random()),h=Math.round(h+420*(this.progress-2)/5))),this.ghostDir<0&&t.setTransform(this.ghostDir,0,0,1,2*s+160,0),t.drawImage(c.sprites.gh,0,0,16,32,s,h,160,320),t.setTransform(1,0,0,1,0,0);let r=Math.random()>.98?.2:0;if(this.flags.success&&this.progress>=7&&(r=.2),t.fillStyle=`rgba(221,238,255,${r})`,t.beginPath(),t.moveTo(c.centerX-50,e-450),t.lineTo(c.centerX-200,e),t.lineTo(c.centerX+200,e),t.lineTo(c.centerX+50,e-450),t.closePath(),t.fill(),this._drawMirror(t,e),this.player.y=e-this.player.height,this.player.draw(t),t.fillStyle=c.COLOR.BLUE_2,t.fillRect(0,e,window.innerWidth,window.innerHeight-e),t.lineWidth=10,t.beginPath(),t.moveTo(0,e+5),t.lineTo(window.innerWidth,e+5),t.closePath(),t.stroke(),this.flags.success){let i=200;this.progress<=.5?i=Math.round(i*this.progress*2):this.progress>=6&&this.progress<=8?i=Math.round(i*(1-(this.progress-6)/2)):this.progress>8&&(i=0),t.fillStyle=c.COLOR.ORANGE,t.fillRect(c.centerX-Math.round(i/2),e,i,10)}this._drawMod(t),this.items[0].y=e-112,this.items[1].y=e-60,this.checkItems(t,e),this.items.forEach(i=>{i.collected||i.draw(t)}),this.ui_collect.draw(t),this.ui_challenge.y=e-160,this.ui_challenge.centerX(),this.ui_challenge.draw(t),this.ui_challenge.visible&&I.draw(t,i.ACTION.INTERACT,[c.centerX-10,e-230,20])}update(t){if(super.update(t),this.flags.success){let i=-1;this.progress>5?i=1:this.progress>3.5&&(i=0),this.player.update(t,{x:0,y:i}),this.progress>=13&&c.changeLevel(new h)}else{this.mod.update(t),this.mod1.update(t,{x:0}),this.mod2.update(t,{x:0});let e=i.getDirections();this.player.update(t,e),this.playerMirror.update(t,e),this.player.x<20?(this.player.x=20,this.player.lastDir=0):this.player.x>window.innerWidth-40&&(this.player.x=window.innerWidth-40,this.player.lastDir=0),this.playerMirror.x=this.player.x+40,this.playerMirror.y=this.player.y,this.playerMirror.orientationX=this.player.orientationX,this.playerMirror.orientationY=this.player.orientationY,this.player.face>=0&&(this.playerMirror.face=this.player.face)}this.ghostY=this.ghostY+.025*t,this.ghostY>2*Math.PI&&(this.ghostY-=2*Math.PI);let e=this.player.x+this.player.width/2-c.centerX;this.ghostDir=e<0?-1:1,!this.flags.success&&Math.abs(e)<=100?(this.ui_challenge.visible=!0,i.isPressed(i.ACTION.INTERACT)&&c.changeLevel(new a(this.player))):this.ui_challenge.visible=!1,this.items[1].x=Math.min(c.centerX+300,window.innerWidth-100)}}class a extends s{constructor(e,s){super();let h=[[[.35,.5],i.ACTION.FIGHT_1,2],[[.45,.5],i.ACTION.FIGHT_2,2],[[.55,.5],i.ACTION.FIGHT_3,2],[[.65,.5],i.ACTION.FIGHT_4,2],[[.7,.2],i.ACTION.FIGHT_2,4.5],[[.65,.2],i.ACTION.FIGHT_2,.5],[[.6,.2],i.ACTION.FIGHT_4,.5],[[.55,.2],i.ACTION.FIGHT_4,.5],[[.45,.2],i.ACTION.FIGHT_2,1],[[.4,.2],i.ACTION.FIGHT_4,.5],[[.35,.2],i.ACTION.FIGHT_2,.5],[[.3,.2],i.ACTION.FIGHT_4,.5],[[.7,.7],i.ACTION.FIGHT_1,1.5],[[.65,.7],i.ACTION.FIGHT_1,.5],[[.6,.7],i.ACTION.FIGHT_3,.5],[[.55,.7],i.ACTION.FIGHT_3,.5],[[.45,.7],i.ACTION.FIGHT_1,1],[[.4,.7],i.ACTION.FIGHT_3,.5],[[.35,.7],i.ACTION.FIGHT_1,.5],[[.3,.7],i.ACTION.FIGHT_3,.5],[[.7,.25],i.ACTION.FIGHT_1,7],[[.65,.25],i.ACTION.FIGHT_1,.5],[[.6,.2],i.ACTION.FIGHT_2,.5],[[.55,.15],i.ACTION.FIGHT_3,.5],[[.5,.15],i.ACTION.FIGHT_3,.5],[[.45,.2],i.ACTION.FIGHT_4,.5],[[.4,.2],i.ACTION.FIGHT_4,.5],[[.35,.15],i.ACTION.FIGHT_3,.5],[[.3,.25],i.ACTION.FIGHT_1,.5],[[.3,.8],i.ACTION.FIGHT_2,1.5],[[.35,.75],i.ACTION.FIGHT_3,.5],[[.4,.85],i.ACTION.FIGHT_1,.5],[[.45,.75],i.ACTION.FIGHT_3,.5],[[.5,.85],i.ACTION.FIGHT_1,.5],[[.55,.8],i.ACTION.FIGHT_4,.5],[[.6,.8],i.ACTION.FIGHT_4,.5],[[.65,.8],i.ACTION.FIGHT_4,.5],[[.7,.8],i.ACTION.FIGHT_4,.5],[[.7,.2],i.ACTION.FIGHT_3,1.5],[[.65,.2],i.ACTION.FIGHT_3,.5],[[.6,.2],i.ACTION.FIGHT_3,.5],[[.55,.2],i.ACTION.FIGHT_3,.5],[[.5,.2],i.ACTION.FIGHT_3,.5],[[.45,.25],i.ACTION.FIGHT_4,.5],[[.5,.3],i.ACTION.FIGHT_1,.5],[[.55,.35],i.ACTION.FIGHT_2,.5],[[.5,.45],i.ACTION.FIGHT_1,.5],[[.45,.5],i.ACTION.FIGHT_4,.5],[[.5,.55],i.ACTION.FIGHT_1,.5],[[.55,.6],i.ACTION.FIGHT_2,.5],[[.6,.6],i.ACTION.FIGHT_2,.5],[[.65,.6],i.ACTION.FIGHT_2,.5],[[.8,.4],i.ACTION.FIGHT_4,1.5],[[.75,.4],i.ACTION.FIGHT_4,.5],[[.65,.4],i.ACTION.FIGHT_1,1],[[.65,.3],i.ACTION.FIGHT_1,.5],[[.55,.3],i.ACTION.FIGHT_2,1],[[.5,.3],i.ACTION.FIGHT_2,.5],[[.4,.3],i.ACTION.FIGHT_3,1],[[.4,.4],i.ACTION.FIGHT_3,.5],[[.8,.7],i.ACTION.FIGHT_2,1.5],[[.7,.7],i.ACTION.FIGHT_1,.5],[[.65,.65],i.ACTION.FIGHT_1,.5],[[.6,.6],i.ACTION.FIGHT_4,.5],[[.55,.55],i.ACTION.FIGHT_2,.5],[[.5,.5],i.ACTION.FIGHT_3,.5],[[.45,.45],i.ACTION.FIGHT_4,.5],[[.4,.4],i.ACTION.FIGHT_4,.5],[[.35,.35],i.ACTION.FIGHT_1,.5],[[.3,.3],i.ACTION.FIGHT_3,.5],[[.25,.25],i.ACTION.FIGHT_1,.5],[[.15,.2],i.ACTION.FIGHT_1,1.5],[[.15,.3],i.ACTION.FIGHT_1,.5],[[.15,.4],i.ACTION.FIGHT_1,.5],[[.15,.5],i.ACTION.FIGHT_1,.5],[[.15,.6],i.ACTION.FIGHT_1,.5],[[.15,.7],i.ACTION.FIGHT_1,.5],[[.15,.7],i.ACTION.FIGHT_3,2],[[.15,.7],i.ACTION.FIGHT_1,2]],r=2;h.forEach(t=>{t[0][0]=Math.round(t[0][0]*window.innerWidth),t[0][1]=Math.round(t[0][1]*window.innerHeight),t[2]+=r,r=t[2]});let l=.8;e.items.forEach(t=>{t.effect&&(t.effect.goal&&(l=Math.min(l,t.effect.goal)),t.effect.time&&(f.TIME_DIFF_MAX=Math.max(f.TIME_DIFF_MAX,t.effect.time)))}),this.goal=Math.round(h.length*l),s&&(h=h.slice(12)),e.orientationX=-1,e.orientationY=0,e.lastDir=0,e.size=10,this.player=e,this.ghostY=0,this.rhythm=new T(h),this.isDone=0,s&&(this.rhythm.time=21),this.rhythm.onNext=t=>{this.rhythm.time>21&&(this.player.face=1,t<1?this.player.face=2:t<2&&(this.player.face=3))},this.rhythm.onDone=()=>{this.isDone=this.rhythm.time;let t=setInterval(()=>{this.beat.volume<.1||this.beat.paused?(this.beat.pause(),clearInterval(t)):this.beat.volume-=.1},250)},this.beat=t.play("beat",!0,.9)}draw(t){if(this.isDone)this.rhythm.drawResult(t,this.goal);else{if(t.fillStyle="rgb(41,51,64)",t.fillRect(0,0,window.innerWidth,window.innerHeight),this.rhythm.time>=27){let i=Math.min(1,this.rhythm.time-27),e=Math.round(50*Math.sin(this.ghostY));t.globalAlpha=i,t.translate(160,320),t.rotate(15*Math.PI/180),t.translate(-160,-320-e),t.drawImage(c.sprites.gh,0,0,16,32,0,0,320,640),t.setTransform(1,0,0,1,0,0);let s=this.rhythm.stats,h=s.correct-s.wrong-s.missed,r=Math.min(this.goal,h)/this.goal;r=Math.min(1,Math.max(0,r));let l=Math.round(window.innerWidth/3),n=c.centerX-Math.round(l/2),a=window.innerHeight-80,o=Math.round((1-this.goal/s.total)*l);t.fillStyle="#000",t.fillRect(n-5,a+5,5,15),t.fillRect(n,a,l,5),t.fillRect(n,a+20,l,5),t.fillRect(n+l,a+5,5,15);let d=Math.round(r*l);t.fillStyle="#4B5E77",t.fillRect(n,a+5,l-d,15),t.fillStyle="#C26F38",t.fillRect(n+l-d,a+5,d,15),t.fillStyle="#000",t.fillRect(n+o,a+5,2,15),t.globalAlpha=1}this.player.x=window.innerWidth-this.player.width-80,this.player.y=window.innerHeight-this.player.height,this.player.draw(t),t.font="bold 21px sans-serif",t.textAlign="center",this.rhythm.time<11?t.fillText("HIT THE BUTTON SHORTLY BEFORE ITS TIMER RUNS OUT:",c.centerX,.3*window.innerHeight):this.rhythm.time<13?t.fillText("NOW FASTER.",c.centerX,.4*window.innerHeight):this.rhythm.time>25&&this.rhythm.time<29&&t.fillText("TIME FOR THE REAL DEAL.",c.centerX,.4*window.innerHeight),this.rhythm.draw(t)}}update(t){if(this.isDone){if(i.isPressed(i.ACTION.INTERACT)){let t=new n({items:this.player.items,success:this.rhythm.stats.correct>=this.goal});c.changeLevel(t)}}else this.player.update(t,{x:0}),this.ghostY=this.ghostY+.05*t,this.ghostY>2*Math.PI&&(this.ghostY-=2*Math.PI),this.rhythm.update(t)}}class o{constructor(t){this.script=t,this.step=0,this.progress=0,this.waited=0}getText(){return this.script[this.step]}update(t){let i=this.script[this.step][3]||3;this.progress>=this.waited+i&&(this.waited+=i,this.step++),this.step>=this.script.length&&(this.step=this.script.length-1,this.onDone&&this.onDone(),this.onDone=null),this.progress+=t/c.TARGET_FPS}}o.SCRIPT={INTRO:[[1,0,[],1],[0,4,["Welcome to a new season of HOW TO SEND BACK...!"]],[0,4,["Previously we informed our dear viewers on","how to return packets and the like."],4],[0,4,["Honestly, the show did not very well.","But this time we made sure to spice things up!"],4],[0,0,["And we are joined by a real celebrity today!"]],[1,4,["Hi, I'm John from the finances section."]],[0,0,[],1],[1,0,["There was no more room in the budget."]],[1,0,[],1],[1,0,["Also, why is there an",String.fromCharCode(8220)+"emergency priest"+String.fromCharCode(8221)+" on standby?"],4],[0,0,[],1]],LEVEL_1_1:[[0,4,["Here we are! This first episode!","How to send back… a ghost!"],5],[1,0,[],1],[1,0,["What?"],2],[1,0,[],1],[0,4,["How to send back a ghost!"]]]};class d{constructor(t){this.color=c.COLOR.BLACK,this.face=0,this.frameX=0,this.items=[],this.lastDir=0,this.orientationX=0,this.orientationY=0,this.progress=0,this.size=t,this.speed=8,this.x=0,this.y=0}get height(){return 20*this.size}get width(){return 16*this.size}draw(t){let i=this.x;this.orientationX>0&&(t.setTransform(-1,0,0,1,i+this.width,0),i=0);let e=this.y+Math.round((Math.sin(.05*this.progress)+1)*this.size*.1);this.drawBody(t,i,e),this.drawFace(t,i,e),t.setTransform(1,0,0,1,0,0)}drawBody(t,i,e){let s=2*this.size,h=4*this.size,r=16*this.size;t.fillStyle=this.color,t.fillRect(i,e+this.size,r,14*this.size),t.fillRect(i+this.size,e,14*this.size,r),0!==this.lastDir?(t.fillRect(i+3*this.size,this.y+r,s,s),t.fillRect(i+9*this.size,this.y+r,s,s),~~this.frameX%2?(t.fillRect(i+h,this.y+18*this.size,s,this.size),t.fillRect(i+9*this.size,this.y+r,s,h)):(t.fillRect(i+3*this.size,this.y+r,s,h),t.fillRect(i+10*this.size,this.y+18*this.size,s,this.size))):4===this.face?(t.fillRect(i+h,this.y+r,s,h),t.fillRect(i+10*this.size,this.y+r,s,h)):(t.fillRect(i+3*this.size,this.y+r,s,h),t.fillRect(i+9*this.size,this.y+r,s,h))}drawFace(t,i,e){let s=2*this.size,h=3*this.size,r=4*this.size,l=5*this.size,n=9*this.size;t.fillStyle="#FFF";let a=this.progress/c.TARGET_FPS,o=!1;if(Math.round(a)%6==0&&a-Math.floor(a)<=.1&&(o=!0),0===this.face){if(!o){let r=this.orientationY*this.size;t.fillRect(i+h,e+l+r,this.size,s),t.fillRect(i+n,e+l+r,this.size,s)}}else if(4===this.face)o||(t.fillRect(i+r,e+l,this.size,s),t.fillRect(i+11*this.size,e+l,this.size,s));else if(1===this.face)t.fillRect(i+s,e+s,s,this.size),t.fillRect(i+r,e+h,this.size,this.size),t.fillRect(i+n,e+s,s,this.size),t.fillRect(i+8*this.size,e+h,this.size,this.size),o||(t.fillRect(i+h,e+r,this.size,s),t.fillRect(i+n,e+r,this.size,s)),t.fillRect(i+l,e+n,h,this.size);else if(2===this.face)t.fillRect(i+s,e+r,this.size,this.size),t.fillRect(i+h,e+l,this.size,this.size),t.fillRect(i+s,e+6*this.size,this.size,this.size),t.fillRect(i+10*this.size,e+r,this.size,this.size),t.fillRect(i+n,e+l,this.size,this.size),t.fillRect(i+10*this.size,e+6*this.size,this.size,this.size),t.fillRect(i+l,e+n,h,s);else if(3===this.face){if(!o){let s=this.orientationY*this.size;t.fillRect(i+h,e+r+s,this.size,h),t.fillRect(i+n,e+r+s,this.size,h)}t.fillRect(i+r,e+10*this.size,r,this.size),t.fillRect(i+r,e+11*this.size,l,this.size)}}update(t,i){this.progress+=t,this.orientationY=0,"number"==typeof i.y&&0!==i.y&&(this.orientationY=i.y<0?-1:1),0!==i.x?(this.orientationX=i.x<0?-1:1,this.frameX=this.frameX+.2*t):this.frameX=0,this.lastDir=i.x,this.x+=Math.round(i.x*this.speed)}}const c={COLOR:{BLACK:"#000",BLUE_1:"#4B5E77",BLUE_2:"#293340",BLUE_3:"#1A1F26",MOD_1:"#7D3A19",MOD_2:"#37536E",ORANGE:"#C26F38",WHITE:"#FFF"},TARGET_FPS:60,last:0,sprites:{gh:null,sy:null},changeLevel(t){i.off("gp_connect"),i.off("gp_disconnect"),this.level=t},clear(){this.ctx.clearRect(0,0,this.cnv.width,this.cnv.height)},draw(){this.clear(),this.level&&this.level.draw(this.ctx)},drawBorder(){this.ctx.lineWidth=100,this.ctx.strokeStyle=c.COLOR.BLUE_3,this.ctx.strokeRect(0,0,window.innerWidth,window.innerHeight)},drawPause(){this.clear(),this.ctx.fillStyle=c.COLOR.ORANGE,this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight),this.ui_pause.centerX(),this.ui_pause.y=c.centerY-80,this.ui_pause.draw(this.ctx),I.draw(this.ctx,i.ACTION.INTERACT,[c.centerX-15,c.centerY-15,30])},init(t){this.cnv=document.getElementById("c"),this.ctx=this.cnv.getContext("2d"),this.ui_pause=new p("PAUSED","bold 42px sans-serif",[255,255,255],0,0,!0),this.loadImages(()=>{window.addEventListener("resize",()=>this.resize()),this.resize(),t()})},loadImages(t){let i=["gh","sy"],e=s=>{if(s>=i.length)return void t();let h=i[s],r=new Image;r.src=c.ASSETS+`${h}.gif`,r.onload=()=>{this.sprites[h]=r,e(s+1)}};e(0)},mainLoop(t=0){if(i.update(),t>0){let e=(t-this.last)/1e3*this.TARGET_FPS;this.ctx.imageSmoothingEnabled=!1,this.ctx.lineWidth=1,this.ctx.textBaseline="alphabetic",this.isPaused?(this.drawPause(e),(i.isPressed(i.ACTION.INTERACT,!0)||i.isPressed(i.ACTION.ESC,!0))&&(this.isPaused=!1)):i.isPressed(i.ACTION.ESC,!0)?this.isPaused=!0:(this.level&&this.level.update(e),this.draw(e))}this.last=t,requestAnimationFrame(t=>this.mainLoop(t))},resize(){this.cnv.height=window.innerHeight,this.cnv.width=window.innerWidth,this.centerX=Math.round(window.innerWidth/2),this.centerY=Math.round(window.innerHeight/2)}};class T{constructor(t){this.time=0,this.stats={correct:0,hit:0,missed:0,total:t.length,wrong:0},this.buttons=[],this.ignoreUntil=-1,t.forEach(t=>{this.buttons.push(new f(...t))})}draw(t){if(0!==this.time)for(let i=this.buttons.length-1;i>=0;i--)this.buttons[i].draw(t)}drawResult(t,e){this.stats.correct>=e?(t.fillStyle=c.COLOR.ORANGE,t.fillRect(0,0,window.innerWidth,window.innerHeight),t.fillStyle="#000",t.font="bold italic 56px serif",t.textAlign="center",t.fillText("WELL DONE!",c.centerX,Math.max(40,c.centerY-220))):(t.fillStyle=c.COLOR.BLUE_1,t.fillRect(0,0,window.innerWidth,window.innerHeight),t.fillStyle=c.COLOR.WHITE);let s=c.centerY-80;t.font="bold 56px sans-serif",t.textAlign="center",t.fillText(`${this.stats.correct}/${this.stats.total}`,c.centerX,s),t.font="bold 21px sans-serif",t.fillText(`REQUIRED: ${e}`,c.centerX,s+=57),I.draw(t,i.ACTION.INTERACT,[c.centerX-10,s+=87,20]),t.fillText("CONTINUE",c.centerX,s+=87)}update(t){this.time+=t/c.TARGET_FPS;let e=[i.isPressed(i.ACTION.FIGHT_1,!0),i.isPressed(i.ACTION.FIGHT_2,!0),i.isPressed(i.ACTION.FIGHT_3,!0),i.isPressed(i.ACTION.FIGHT_4,!0)],s=!0;this.buttons.forEach((t,i)=>{this.time<=this.ignoreUntil&&(s=!1),s=t.update(this.time,e,s,t=>{-1===t&&(this.ignoreUntil=this.time+.05),this.onNext(t)}),t.canBeRemoved&&(this.updateStats(t),this.buttons.splice(i,1))})}updateStats(t){t.isHit?(this.stats.hit++,t.wasWrong?this.stats.wrong++:this.stats.correct++):this.stats.missed++,this.stats.hit+this.stats.missed===this.stats.total&&(this.onDone(),this.onDone=null)}}class f{constructor(t,i,e){this.pos=t,this.symbol=i,this.time=e,this.speed=2,this.canBeRemoved=!1,this.isHit=0,this.wasWrong=!1,this.progress=0,this.diff=-1,this.ui_rating=new p("","bold 18px sans-serif",[255,255,255],0,0,!0)}_checkPressed(t,i,e){if(i[e])this.isHit=t;else{let s=[0,1,2,3];s[e]=-1,(i[s[0]]||i[s[1]]||i[s[2]]||i[s[3]])&&(this.isHit=t,this.wasWrong=!0)}}draw(t){let i=this.pos[0],e=this.pos[1];if(this.isHit&&this.progress-this.isHit>1&&(this.canBeRemoved=!0),this.isHit||this.wasWrong){let s=this.getRating();this.ui_rating.x=i,this.ui_rating.y=e-45,this.ui_rating.text=s[1],this.ui_rating.color[3]=Math.min(1,1-this.progress+this.isHit),this.ui_rating.draw(t)}else if(this.diff>=0&&this.diff<=this.speed){let s=this.diff/this.speed,h=-Math.PI/2,r=Math.PI*(2*s-.5);t.beginPath(),t.fillStyle=this.getColorTimer(s),t.arc(i,e,48,h,r),t.lineTo(i,e),t.closePath(),t.fill(),I.draw(t,this.symbol,[i-15,e-15,30])}}getColorTimer(t){let e=250,s=160,h=90;return this.symbol===i.ACTION.FIGHT_1?3===i.PROMPTS?(e=50,s=210):(e=90,h=230):this.symbol===i.ACTION.FIGHT_2?3===i.PROMPTS?(s=60,h=60):(s=150,h=50):this.symbol===i.ACTION.FIGHT_3?3===i.PROMPTS?(e=240,s=230,h=70):(e=50,s=210):3===i.PROMPTS?(e=90,h=230):(e=220,s=140,h=210),`rgba(${e},${s},${h},${1-t})`}getRating(){return this.isHit&&!this.wasWrong?Math.abs(this.diff)<=Math.abs(f.TIME_DIFF_MIN)?[4,"PERFECT"]:this.diff<f.TIME_DIFF_MAX/3?[3,"GREAT"]:this.diff<f.TIME_DIFF_MAX/1.5?[2,"GOOD"]:[1,"BAD"]:this.isHit&&this.wasWrong?[0,"WRONG"]:[-1,"MISSED"]}update(e,s,h,r){let l=h,n=this.time-e;return this.isHit?this.progress=e:(this.diff=n,h&&n>=f.TIME_DIFF_MIN&&n<=f.TIME_DIFF_MAX&&(l=!1,this.symbol===i.ACTION.FIGHT_1?this._checkPressed(e,s,0):this.symbol===i.ACTION.FIGHT_2?this._checkPressed(e,s,1):this.symbol===i.ACTION.FIGHT_3?this._checkPressed(e,s,2):this.symbol===i.ACTION.FIGHT_4&&this._checkPressed(e,s,3),this.isHit&&(this.progress=e,this.wasWrong||t.play("hit"),r(this.getRating()[0]))),n<f.TIME_DIFF_MIN-1?this.canBeRemoved=!0:!this.wasWrong&&n<f.TIME_DIFF_MIN&&(this.wasWrong=!0,r(-1))),l}}f.TIME_DIFF_MIN=-.05,f.TIME_DIFF_MAX=1.15;const I={draw(t,e,s){let h=s[0],r=s[1],l=s[2]/2,n=[h,r,s[2],s[2]],a=c.sprites.sy,o=10;switch(1===i.PROMPTS?e===i.ACTION.FIGHT_1?e=i.ACTION.DOWN:e===i.ACTION.FIGHT_2&&(e=i.ACTION.RIGHT):2===i.PROMPTS?o=5:3===i.PROMPTS&&(o=0),1!==i.PROMPTS&&(e===i.ACTION.INTERACT?e=i.ACTION.FIGHT_1:e===i.ACTION.FIGHT_3?e=i.ACTION.UP:e===i.ACTION.FIGHT_4&&(e=i.ACTION.LEFT)),t.beginPath(),t.fillStyle=c.COLOR.BLACK,t.arc(h+l,r+l,Math.ceil(.9*s[2]),0,2*Math.PI),t.closePath(),t.fill(),e){case i.ACTION.DOWN:t.drawImage(a,20,10,5,5,...n);break;case i.ACTION.LEFT:t.drawImage(a,0,10,5,5,...n);break;case i.ACTION.RIGHT:t.drawImage(a,20,5,5,5,...n);break;case i.ACTION.UP:t.drawImage(a,20,0,5,5,...n);break;case i.ACTION.FIGHT_1:t.drawImage(a,0,o,5,5,...n);break;case i.ACTION.FIGHT_2:t.drawImage(a,5,o,5,5,...n);break;case i.ACTION.FIGHT_3:t.drawImage(a,15,o,5,5,...n);break;case i.ACTION.FIGHT_4:t.drawImage(a,10,o,5,5,...n);break;case i.ACTION.INTERACT:t.drawImage(a,5,10,5,5,...n)}t.setTransform(1,0,0,1,0,0)}};class p{constructor(t,i,e,s,h,r){this.text=t,this.font=i,this.color=[...e,1],this.visible=!0,this.x=s,this.y=h,this.center=r}blink(t=!0){this._blinkStep=.01,this._blink=t}centerX(){this.x=c.centerX}draw(t){this.visible&&(t.fillStyle=`rgba(${this.color.join(",")})`,t.font=this.font,t.textAlign=this.center?"center":"left",t.fillText(this.text,this.x,this.y))}update(t){this._blink&&(this.color[3]>=1?this._blinkStep=-.01:this.color[3]<=0&&(this._blinkStep=.01),this.color[3]+=this._blinkStep)}}var g=function(){var t,i,e,s,h,r=function(t){return Math.sin(6.283184*t)},l=function(t){return.003959503758*Math.pow(2,(t-128)/12)},n=function(t,i,e){var s,h,r,n,o,d,c,T=a[t.i[0]],f=t.i[1],I=t.i[3],p=a[t.i[4]],g=t.i[5],w=t.i[8],u=t.i[9],y=t.i[10]*t.i[10]*4,O=t.i[11]*t.i[11]*4,m=t.i[12]*t.i[12]*4,_=1/m,A=t.i[13],C=e*Math.pow(2,2-t.i[14]),R=new Int32Array(y+O+m),N=0,x=0;for(s=0,h=0;s<y+O+m;s++,h++)h>=0&&(h-=C,d=l(i+(15&(A=A>>8|(255&A)<<4))+t.i[2]-128),c=l(i+(15&A)+t.i[6]-128)*(1+8e-4*t.i[7])),r=1,s<y?r=s/y:s>=y+O&&(r-=(s-y-O)*_),n=d,I&&(n*=r*r),o=T(N+=n)*f,n=c,w&&(n*=r*r),o+=p(x+=n)*g,u&&(o+=(2*Math.random()-1)*u),R[s]=80*o*r|0;return R},a=[r,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var i=t%1*4;return i<2?i-1:3-i}];this.init=function(r){t=r,i=r.endPattern,e=0,s=r.rowLen*r.patternLen*(i+1)*2,h=new Int32Array(s)},this.generate=function(){var l,o,d,c,T,f,I,p,g,w,u,y,O,m,_=new Int32Array(s),A=t.songData[e],C=t.rowLen,R=t.patternLen,N=0,x=0,F=!1,H=[];for(d=0;d<=i;++d)for(I=A.p[d],c=0;c<R;++c){var G=I?A.c[I-1].f[c]:0;G&&(A.i[G-1]=A.c[I-1].f[c+R]||0,G<16&&(H=[]));var M=a[A.i[15]],E=A.i[16]/512,b=Math.pow(2,A.i[17]-9)/C,P=A.i[18],S=A.i[19],z=43.23529*A.i[20]*3.141592/44100,L=1-A.i[21]/255,v=1e-5*A.i[22],X=A.i[23]/32,D=A.i[24]/512,W=6.283184*Math.pow(2,A.i[25]-9)/C,k=A.i[26]/255,U=A.i[27]*C&-2;for(u=(d*R+c)*C,T=0;T<4;++T)if(f=I?A.c[I-1].n[c+T*R]:0){H[f]||(H[f]=n(A,f,C));var B=H[f];for(o=0,l=2*u;o<B.length;o++,l+=2)_[l]+=B[o]}for(o=0;o<C;o++)(w=_[p=2*(u+o)])||F?(y=z,P&&(y*=M(b*p)*E+.5),x+=(y=1.5*Math.sin(y))*(O=L*(w-x)-(N+=y*x)),w=3==S?x:1==S?O:N,v&&(w=(w*=v)<1?w>-1?r(.25*w):-1:1,w/=v),F=(w*=X)*w>1e-5,m=w*(1-(g=Math.sin(W*p)*D+.5)),w*=g):m=0,p>=U&&(m+=_[p-U+1]*k,w+=_[p-U]*k),_[p]=0|m,_[p+1]=0|w,h[p]+=0|m,h[p+1]+=0|w}return++e/t.numChannels},this.createWave=function(){var t=44+2*s-8,i=t-36,e=new Uint8Array(44+2*s);e.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&i,i>>8&255,i>>16&255,i>>24&255]);for(var r=0,l=44;r<s;++r){var n=h[r];n=n<-32767?-32767:n>32767?32767:n,e[l++]=255&n,e[l++]=n>>8&255}return e}};c.ASSETS="",c.init(()=>{t.init(()=>{i.init(),c.changeLevel(new l),c.mainLoop()})});