"use strict";function _toConsumableArray$1(e){if(Array.isArray(e)){for(var r=0,a=Array(e.length);e.length>r;r++)a[r]=e[r];return a}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,a=Array(e.length);e.length>r;r++)a[r]=e[r];return a}return Array.from(e)}var loop=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15,a=Date.now(),t=setInterval(function(){var r=Date.now();e(r-a),a=r},r);return function(){return clearInterval(t)}},range=function(e){return Array(e).fill()},createPlayer=function(){return{x:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,vx:0,vy:0,ax:0,ay:0,r:18,kills:0,points:0,deaths:0,position:1,health:5,projectiles:0,maxProjectiles:2}},projectileId=0,createProjectile=function(e,r,a,t,n){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1500;return{id:projectileId++,player:e,x:r,y:a,vx:t,vy:n,r:5,created:Date.now(),TTL:o}},createTree=function(e,r,a){return{x:e,y:r,r:a}},createHole=function(e,r,a){return{x:e,y:r,r:a}},createWorld=function(e,r){var a={width:e,height:r,trees:new Set,holes:new Set};return range(Math.floor(e/400)).forEach(function(e,t){range(Math.floor(r/400)).forEach(function(e,r){var n=Math.random();if(.3<n){if(.9>n){var o=Math.random()*(400/3-50)+50,i=400-2*o,s=Math.random()*i,l=Math.random()*i;a.holes.add(createHole(s+400*t+o,l+400*r+o,o))}}else{var c=Math.random()*(400/3-50)+50,y=400-2*c,u=Math.random()*y,h=Math.random()*y;a.trees.add(createTree(u+400*t+c,h+400*r+c,c))}})}),a},createGame=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.maxUsersCount,a=void 0===r?6:r,t=new Set,n=createWorld(2e3,2e3),o=new Set,i=function(e){e.player.projectiles--,o.delete(e)},s=function(e){e.deaths++,e.health=5,e.points=0,e.maxProjectiles=1,c(e)},l=function(e){e.kills++,e.points++,Math.random()>.5?e.health++:e.maxProjectiles++},c=function(e){for(var r=!1;!r;)e.x=Math.random()*n.width,e.y=Math.random()*n.height,r=![].concat(_toConsumableArray$1(n.trees),_toConsumableArray$1(n.holes)).some(function(r){var a=r.x,t=r.y,n=r.r,o=e.x-a,i=e.y-t,s=Math.sqrt(o*o+i*i);return n+e.r>s})},y=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now();t.forEach(function(r){var a=r.player,t=r.pointer;a.ax=t.x,a.ay=t.y;20>Math.abs(a.ax)?a.ax=0:(a.ax>0&&(a.ax-=20),0>a.ax&&(a.ax+=20)),20>Math.abs(a.ay)?a.ay=0:(a.ay>0&&(a.ay-=20),0>a.ay&&(a.ay+=20)),a.vx+=a.ax*e/1e3,a.vy+=a.ay*e/1e3;var n=Math.sqrt(a.vx*a.vx+a.vy*a.vy);if(n>25){var o=n/25;a.vx/=o,a.vy/=o}a.vx*=.98,a.vy*=.98,a.x+=a.vx*e/100,a.y+=a.vy*e/100}),new Set([].concat(_toConsumableArray$1(o)).filter(function(e){return r-e.created>=e.TTL})).forEach(i),o.forEach(function(r){r.x+=r.vx*e/100,r.y+=r.vy*e/100}),o.forEach(function(e){t.forEach(function(r){var a=r.player;if(e.player!==a){var t=e.x-a.x,n=e.y-a.y,o=Math.sqrt(t*t+n*n);e.r+a.r>o&&(a.health--,i(e),0===a.health&&(s(a),l(e.player)))}})}),o.forEach(function(e){n.trees.forEach(function(r){var a=e.x-r.x,t=e.y-r.y,n=Math.sqrt(a*a+t*t);e.r+r.r>n&&i(e)})}),t.forEach(function(r){var a=r.player;n.trees.forEach(function(r){var t=a.x-r.x,n=a.y-r.y,o=Math.sqrt(t*t+n*n);a.r+r.r>o&&(a.x-=a.vx*e/100,a.y-=a.vy*e/100,a.vx*=-1,a.vy*=-1,a.ax*=-1,a.ay*=-1)})}),t.forEach(function(e){var r=e.player;n.holes.forEach(function(e){var a=r.x-e.x,t=r.y-e.y,n=Math.sqrt(a*a+t*t);e.r>n&&s(r)})}),t.forEach(function(e){var r=e.player;0>r.x?(r.x=0,r.ax*=-1,r.vx*=-1):r.x>n.width&&(r.x=n.width,r.ax*=-1,r.vx*=-1),0>r.y?(r.y=0,r.ay*=-1,r.vy*=-1):r.y>n.height&&(r.y=n.height,r.ay*=-1,r.vy*=-1)}),[].concat(_toConsumableArray$1(t)).sort(function(e,r){return r.player.points-e.player.points}).forEach(function(e,r){e.player.position=r+1})},u=function(){t.forEach(function(e){var r=[].concat(_toConsumableArray$1(t)).filter(function(r){return r!==e}).map(function(e){return{x:e.player.x,y:e.player.y,id:e.socket.id,username:e.username,kills:e.player.kills,deaths:e.player.deaths,points:e.player.points,position:e.player.position,health:e.player.health,projectiles:e.player.maxProjectiles-e.player.projectiles}}),a={x:e.player.x,y:e.player.y,id:e.socket.id,kills:e.player.kills,deaths:e.player.deaths,points:e.player.points,position:e.player.position,health:e.player.health,projectiles:e.player.maxProjectiles-e.player.projectiles,me:!0};e.socket.emit("s:players:update",{me:a,others:r});var n=[].concat(_toConsumableArray$1(o)).map(function(e){return{id:e.id,x:e.x,y:e.y}});e.socket.emit("s:projectiles:update",n)})};return{maxUsersCount:a,destroy:loop(function(e){y(e),u()}),addUser:function(e){t.add(e),e.player=createPlayer(),c(e.player),e.socket.emit("s:world:create",{width:n.width,height:n.height,holes:[].concat(_toConsumableArray$1(n.holes)),trees:[].concat(_toConsumableArray$1(n.trees))}),e.socket.on("c:pointer:update",function(r){e.pointer=r}),e.socket.on("c:fire:pressed",function(){if(e.player.projectiles!==e.player.maxProjectiles){var r=e.player.x,a=e.player.y,t=e.pointer.x,n=e.pointer.y,i=Math.sqrt(t*t+n*n);t/=i,n/=i;t*=60,n*=60,o.add(createProjectile(e.player,r,a,t,n)),e.player.projectiles++}})},removeUser:function(e){t.delete(e)},get usersCount(){return t.size}}},createUser=function(e,r){return{socket:e,username:r,game:null,player:null,pointer:{x:0,y:0}}},users=new Set,games=new Set,userId=0,gameId=0,findOrCreateGame=function(){var e=[].concat(_toConsumableArray(games)).find(function(e){return e.maxUsersCount>e.usersCount});return e||(e=createGame({name:"Game "+gameId++}),games.add(e)),e},index=function(e){var r=e.handshake.query.username,a=void 0===r?"Guest "+userId++:r;console.log("connect: "+e.id+" "+a);var t=createUser(e,a);users.add(t);var n=findOrCreateGame();t.game=n,n.addUser(t),e.on("disconnect",function(){console.log("disconnect: "+e.id),users.delete(t);var r=t.game;r.removeUser(t),0===r.usersCount&&(r.destroy(),games.delete(r))})};module.exports=index;
