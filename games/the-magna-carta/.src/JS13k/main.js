const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");canvas.width=640,canvas.height=295;let currDo,curr2Do,drawableObjects=[],gameStarted=!1,gameEnded=!1,score=0;const text=document.getElementById("text"),newGameBtn=document.getElementById("newGameBtn"),playAgainBtn=document.getElementById("playAgainBtn"),leftBtn=document.getElementById("leftBtn"),rightBtn=document.getElementById("rightBtn"),upBtn=document.getElementById("upBtn"),downBtn=document.getElementById("downBtn"),body=document.querySelector("body"),magnaCarta=document.getElementById("magnaCarta");let keyRight=!1,keyLeft=!1,keyDown=!1,keyUp=!1;function SetGameLogic(){setInterval(gameLoop,1e3/30),setInterval(()=>{SpawnEnemy()},17e3)}function gameLoop(){gameStarted&&player.move()}const player=new Player(canvas.width/2,canvas.height/2);function Player(a,b){this.x=a,this.y=b,this.width=64,this.height=64,this.facing="front",this.friction=.9,this.velocity={x:0,y:0,max:3},this.img=new Image,this.move=function(){!gameEnded&&gameStarted&&score++;for(let a=0;a<enemies.length;a++)checkIntersection(player,enemies[a])&&(playEndScene(),enemies.splice(a,1),enemies.splice(0,enemies.length),drawableObjects=[]);let a={x:this.x+this.velocity.x,y:this.y,width:this.width,height:this.height},b={x:this.x+this.velocity.x,y:this.y,width:this.width,height:this.height};(checkIntersection(a,box)||checkIntersection(b,box))&&(score+=200,box.x=Math.floor(Math.random()*(canvas.width-100+1)),box.y=Math.floor(Math.random()*(canvas.height-100+1))),Draw();for(let a=0;a<enemies.length;a++)enemies[a].move();keyRight&&(this.velocity.x+=.5),keyLeft&&(this.velocity.x-=.5),keyUp&&(this.velocity.y-=.5),keyDown&&(this.velocity.y+=.5),(!keyRight&&!keyLeft||keyRight&&keyLeft)&&(this.velocity.x*=this.friction),(!keyUp&&!keyDown||keyUp&&keyDown)&&(this.velocity.y*=this.friction),this.x+this.velocity.x>=canvas.width-this.width&&(this.velocity.x=0),0>=this.x+this.velocity.x&&(this.velocity.x=0),0>=this.y+this.velocity.y&&(this.velocity.y=0),this.y+this.velocity.y>=canvas.height-this.height&&(this.velocity.y=0),this.x+=this.velocity.x,this.y+=this.velocity.y},this.draw=function(){"front"==this.facing?this.img.src="playerImg.png":"right"==this.facing?this.img.src="playerImg4.png":"left"==this.facing?this.img.src="playerImg3.png":"back"==this.facing&&(this.img.src="playerImg2.png"),ctx.drawImage(this.img,this.x,this.y,this.width,this.height)}}function Draw(){if(ctx.ImageSmoothingEnabled=!1,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,ctx.clearRect(0,0,canvas.width,canvas.height),gameEnded)player.draw(),ctx.fillStyle="lightgoldenrodyellow",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="black",ctx.font="40px Arial",ctx.fillText(`Score: ${score}`,canvas.width/2-70,40,200),ctx.font="60px Arial",ctx.fillText("Oh No! You Were FORCED to Sign",0,canvas.height/2+10,canvas.width),ctx.fillStyle="orange",ctx.fillText("The Magna Carta!",100,canvas.height/2+100,canvas.width),ctx.fillStyle="black",ctx.stroke(),playAgainBtn.style.display="block",leftBtn.style.display="none",rightBtn.style.display="none",upBtn.style.display="none",downBtn.style.display="none";else{ctx.fillStyle="#2F6542",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="aquamarine",ctx.font="40px Arial",ctx.fillText(`Score: ${score}`,canvas.width-200,60,200);for(let a=0;a<drawableObjects.length;a++)if(Array.isArray(currDo=drawableObjects[a]))for(let a=0;a<currDo.length;a++)(curr2Do=currDo[a]).draw();else currDo.draw()}}function SpawnEnemy(){!gameEnded&&gameStarted&&(enemies.push(new Enemy(60,0,64,64)),enemies.push(new Enemy(canvas.width-67,0,64,64)),enemies.push(new Enemy(0,canvas.height-69,64,64)),enemies.push(new Enemy(canvas.width-64,canvas.height-64,64,64)))}drawableObjects.push(player),window.addEventListener("keydown",a=>{("w"==a.key||"ArrowUp"==a.key||" "==a.key)&&(keyUp=!0,player.facing="back"),("s"==a.key||"ArrowDown"==a.key)&&(keyDown=!0,player.facing="front"),("d"==a.key||"ArrowRight"==a.key)&&(keyRight=!0,player.facing="right"),("a"==a.key||"ArrowLeft"==a.key)&&(keyLeft=!0,player.facing="left")}),window.addEventListener("keyup",a=>{("w"==a.key||"ArrowUp"==a.key||" "==a.key)&&(keyUp=!1),("s"==a.key||"ArrowDown"==a.key)&&(keyDown=!1),("d"==a.key||"ArrowRight"==a.key)&&(keyRight=!1),("a"==a.key||"ArrowLeft"==a.key)&&(keyLeft=!1)}),leftBtn.addEventListener("touchstart",()=>{keyLeft=!0}),rightBtn.addEventListener("touchstart",()=>{keyRight=!0}),upBtn.addEventListener("touchstart",()=>{keyUp=!0}),downBtn.addEventListener("touchstart",()=>{keyDown=!0}),newGameBtn.addEventListener("touchstart",()=>{newGameBtn.style.display="none",body.style.backgroundColor="darkslategray",text.style.display="none",canvas.style.display="block",leftBtn.style.display="block",rightBtn.style.display="block",upBtn.style.display="block",downBtn.style.display="block",blurt("You Are King John and your Barons Have Revolted!"),setTimeout(()=>{blurt("Collect the boxes and avoid being Forced to sign the Magna Carta!")},3e3),setTimeout(()=>{gameStarted=!0,SetGameLogic(),SpawnEnemy(),box.x=Math.floor(Math.random()*(canvas.width-100+1)),box.y=Math.floor(Math.random()*(canvas.height-100+1)),console.log(box),PlaySong()},8e3)}),playAgainBtn.onclick=function(){window.location=window.location},playAgainBtn.addEventListener("touchstart",()=>{window.location=widnow.location}),leftBtn.addEventListener("touchend",()=>{keyLeft=!1}),rightBtn.addEventListener("touchend",()=>{keyRight=!1}),upBtn.addEventListener("touchend",()=>{keyUp=!1}),downBtn.addEventListener("touchend",()=>{keyDown=!1}),leftBtn.addEventListener("touchcancel",()=>{keyLeft=!1}),rightBtn.addEventListener("touchcancel",()=>{keyRight=!1}),upBtn.addEventListener("touchcancel",()=>{keyUp=!1}),downBtn.addEventListener("touchcancel",()=>{keyDown=!1});let enemies=[];function Enemy(b,c,d,e){this.x=b,this.y=c,this.width=d,this.height=e,this.img=new Image,this.facing="right",this.target={x:void 0,y:void 0},this.move=function(){this.target.x=Math.round(player.x+player.width/2),this.target.y=Math.round(player.y+player.height/2),this.y<this.target.y&&(this.facing="back",this.y++),this.y>this.target.y&&(this.facing="front",this.y--),this.x<this.target.x&&(this.facing="right",this.x++),this.x>this.target.x&&(this.facing="left",this.x--)},this.draw=function(){"front"==this.facing?this.img.src="enemyImg.png":"right"==this.facing?this.img.src="enemyImg4.png":"left"==this.facing?this.img.src="enemyImg3.png":"back"==this.facing&&(this.img.src="enemyImg2.png"),ctx.drawImage(this.img,this.x,this.y,this.width,this.height)}}function checkIntersection(a,b){return!(a.x>=b.x+b.width||a.x+a.width<=b.x||a.y>=b.y+b.height||a.y+a.height<=b.y)}drawableObjects.push(enemies),newGameBtn.onclick=function(){newGameBtn.style.display="none",body.style.backgroundColor="darkslategray",text.style.display="none",canvas.style.display="block",leftBtn.style.display="block",rightBtn.style.display="block",upBtn.style.display="block",downBtn.style.display="block",blurt("You Are King John and your Barons Have Revolted!"),setTimeout(()=>{blurt("Collect the boxes and avoid being Forced to sign the Magna Carta!")},3e3),setTimeout(()=>{gameStarted=!0,SetGameLogic(),SpawnEnemy(),box.x=Math.floor(Math.random()*(canvas.width-100+1)),box.y=Math.floor(Math.random()*(canvas.height-100+1)),console.log(box,drawableObjects[2]),PlaySong()},8e3)};var CPlayer=function(){var z,K,N,Q,d,g=function(a){return Math.sin(6.283184*a)},j=function(a){return .003959503758*2**((a-128)/12)},f=function(h,k,e){var n,q,r,t,z,A,D=V[h.i[0]],y=h.i[1]+200,d=h.i[3]/32,g=V[h.i[4]],m=h.i[5]+200,u=h.i[8]/32,w=h.i[9],f=4*(h.i[10]*h.i[10]),x=4*(h.i[11]*h.i[11]),p=4*(h.i[12]*h.i[12]),v=-h.i[13]/16,b=h.i[14],F=e*2**(2-h.i[15]),E=new Int32Array(f+x+p),G=0,H=0;for(n=0,q=0;n<f+x+p;n++,q++)0<=q&&(q-=F,z=j(k+(15&(b=b>>8|(255&b)<<4))+h.i[2]-128),A=j(k+(15&b)+h.i[6]-128)*(1+8e-4*h.i[7])),r=1,n<f?r=n/f:n>=f+x&&(r=(1-(r=(n-f-x)*(1/p)))*3**(v*r)),t=D(G+=z*r**d)*y,t+=g(H+=A*r**u)*m,w&&(t+=(2*Math.random()-1)*w),E[n]=0|80*t*r;return E},V=[g,function(a){return .5>a%1?1:-1},function(a){return 2*(a%1)-1},function(a){var b=4*(a%1);return 2>b?b-1:3-b}];this.init=function(a){z=a,K=a.endPattern,N=0,Q=2*(a.rowLen*a.patternLen*(K+1)),d=new Int32Array(Q)},this.generate=function(){var a,e,h,i,n,o,s,t,X,Z,$,_,aa,ba,ca=new Int32Array(Q),b=z.songData[N],B=z.rowLen,E=z.patternLen,L=0,da=0,ea=!1,fa=[];for(h=0;h<=K;++h)for(i=0,s=b.p[h];i<E;++i){var ga=s?b.c[s-1].f[i]:0;ga&&(b.i[ga-1]=b.c[s-1].f[i+E]||0,17>ga&&(fa=[]));var A=V[b.i[16]],R=b.i[17]/512,D=2**(b.i[18]-9)/B,T=b.i[19],U=b.i[20],O=135.82764118168*b.i[21]/44100,P=1-b.i[22]/255,j=1e-5*b.i[23],G=b.i[24]/32,F=b.i[25]/512,W=6.283184*2**(b.i[26]-9)/B,Y=b.i[27]/255,q=-2&b.i[28]*B;for(n=0,$=(h*E+i)*B;4>n;++n)if(o=s?b.c[s-1].n[i+n*E]:0){fa[o]||(fa[o]=f(b,o,B));var H=fa[o];for(e=0,a=2*$;e<H.length;e++,a+=2)ca[a]+=H[e]}for(e=0;e<B;e++)(Z=ca[t=2*($+e)])||ea?(_=O,T&&(_*=A(D*t)*R+.5),L+=(_=1.5*Math.sin(_))*da,da+=_*(aa=P*(Z-da)-L),Z=3==U?da:1==U?aa:L,j&&(Z=1>(Z*=j)?-1<Z?g(.25*Z):-1:1,Z/=j),ea=1e-5<(Z*=G)*Z,ba=Z*(1-(X=Math.sin(W*t)*F+.5)),Z*=X):ba=0,t>=q&&(ba+=ca[t-q+1]*Y,Z+=ca[t-q]*Y),ca[t]=0|ba,ca[t+1]=0|Z,d[t]+=0|ba,d[t+1]+=0|Z}return++N/z.numChannels},this.createAudioBuffer=function(a){for(var b=a.createBuffer(2,Q/2,44100),c=0;2>c;c++)for(var e=b.getChannelData(c),f=c;f<Q;f+=2)e[f>>1]=d[f]/65536;return b},this.createWave=function(){var a=44+2*Q-8,b=a-36,c=new Uint8Array(44+2*Q);c.set([82,73,70,70,255&a,255&a>>8,255&a>>16,255&a>>24,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&b,255&b>>8,255&b>>16,255&b>>24]);for(var e,f=0,g=44;f<Q;++f)e=d[f],e=-32767>e?-32767:32767<e?32767:e,c[g++]=255&e,c[g++]=255&e>>8;return c},this.getData=function(b,c){for(var e,f=2*Math.floor(44100*b),g=Array(c),a=0;a<2*c;a+=1)e=f+a,g[a]=0<b&&e<d.length?d[e]/32768:0;return g}};function PlaySong(){songLoopStarted=!0;var a=new CPlayer;a.init({songData:[{i:[2,255,128,0,3,255,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[1],c:[{n:[114,114,114,114,114,114,114,114,114,112,112,114,112,114,112,115,127,127,127,127,127,127,112,127,127,117,117,117,117,127,127,127],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1});var b=!1;setInterval(function(){if(!b){b=1<=a.generate();var c=a.createWave();audio.src=URL.createObjectURL(new Blob([c],{type:"audio/wav"})),audio.play()}})}var audio=document.createElement("audio");function playEndScene(){gameEnded=!0,audio.pause()}audio.addEventListener("ended",()=>{!gameEnded&&gameStarted&&PlaySong()});let box=new Box(10*canvas.width,100,50,50);function Box(b,c,d,e){this.x=b,this.y=c,this.width=d,this.height=e,this.img=new Image,this.draw=function(){this.img.src="boxImg.png",ctx.drawImage(this.img,this.x,this.y,this.width,this.height)}}function SpawnMagnaCarta(a){magnaCarta.style.top=a.y-40+"px",magnaCarta.style.left=a.x-40+"px",magnaCarta.style.display="block",magnaCarta.style.width="20px",magnaCarta.style.height="20px",setTimeout(()=>{magnaCarta.style.width="40px",magnaCarta.style.height="40px"},100),setTimeout(()=>{magnaCarta.style.width="60px",magnaCarta.style.height="60px"},200),setTimeout(()=>{magnaCarta.style.width="80px",magnaCarta.style.height="80px"},300),setTimeout(()=>{magnaCarta.style.width="90px",magnaCarta.style.height="90px"},400),setTimeout(()=>{magnaCarta.style.width="100px",magnaCarta.style.height="100px"},500),setTimeout(()=>{magnaCarta.style.display="none"},1e3)}function RegisterClick(a,b,c){return!!(Math.round(a)>Math.round(c.x)&&Math.round(a)<Math.round(c.x)+c.width)&&(!!(Math.round(b)>Math.round(c.y)&&Math.round(b)<Math.round(c.y)+c.height)||void 0)}drawableObjects.push(box),window.addEventListener("click",a=>{let b=a.x-canvas.getBoundingClientRect().x,c=a.y-canvas.getBoundingClientRect().y;!gameStarted||gameEnded?SpawnMagnaCarta(a):RegisterClick(b,c,box)&&(score+=200,box.x=Math.floor(Math.random()*(canvas.width-100+1)),box.y=Math.floor(Math.random()*(canvas.height-100+1)))}),window.addEventListener("touchstart",a=>{let b=a.x-canvas.getBoundingClientRect().x,c=a.y-canvas.getBoundingClientRect().y;!gameStarted||gameEnded?SpawnMagnaCarta(a):RegisterClick(b,c,box)&&(score+=200,box.x=Math.floor(Math.random()*(canvas.width-100+1)),box.y=Math.floor(Math.random()*(canvas.height-100+1)))});