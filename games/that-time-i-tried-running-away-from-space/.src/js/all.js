class Background{constructor(s){this.context=s,this.spawnTime=30,this.starList=[]}render(){if(this.starList.map(s=>s.render()),this.spawnTime-=1,0==this.spawnTime){let s=new Star(this.context);this.starList.push(s),this.spawnTime=30}}}
class Fireball{constructor(t){let e=new Image;e.src="assets/images/spritesheet.png",this.current_animation_frame=1,this.context=t,this.image=e,this.max_animation_frame=2,this.current_frame_rate=20,this.max_frame_rate=10,this.x=800,this.y=64*Math.floor(8*Math.random()),this.moveSpeed=4}render(){let t=this.getAnimationFrame(this.current_animation_frame);this.context.drawImage(this.image,t[0],t[1],64,64,this.x,this.y,64,64),this.moveBack()}moveBack(){this.x-=this.moveSpeed}getAnimationFrame(t){return 0==t?[0,64]:1==t?[64,64]:[0,64]}}
class FloatingText{constructor(t,i,s,o){this.ctx=t,this.position=i,this.text=s,this.textColor=o,this.time=30}render(){this.ctx.font="10px Arial",this.ctx.fillStyle=this.textColor,this.ctx.fillText(this.text,...this.position),this.position[1]--,this.time--}}
class Game{constructor(){this.score=0,this.state="start_menu",this.mineral=250,this.currentLevel=0,this.currentDistance=0,this.maxDistance=60,this.currentOxygen=60,this.maxOxygen=60,this.currentHealth=50,this.maxHealth=50,this.difficultySetting=0}addScore(t){this.score+=t}addOxygen(t){this.currentOxygen+=t,this.currentOxygen>this.maxOxygen&&(this.currentOxygen=this.maxOxygen)}addHealth(t){this.currentHealth+=t,this.currentHealth>this.maxHealth&&(this.currentHealth=this.maxHealth)}addMaxOxygen(t){this.maxOxygen+=t,this.currentOxygen+=t}addMaxHealth(t){this.maxHealth+=t,this.currentHealth+=t}getObstacleReward(t){"oxygen"==t.lootType&&(this.currentOxygen+=t.lootAmount,this.currentOxygen>this.maxOxygen&&(this.currentOxygen=this.maxOxygen)),"mineral"==t.lootType&&(this.mineral+=t.lootAmount)}getMineral(){return this.mineral}getHealthArray(){return[this.currentHealth,this.maxHealth]}addDistance(t){this.currentDistance+=t}completeLevel(){return this.currentDistance>this.maxDistance}getOxygenArray(){return[this.currentOxygen,this.maxOxygen]}getDistanceArray(){return[this.currentDistance,this.maxDistance]}over(){return this.currentOxygen<=0||this.currentHealth<=0}removeOxygen(t){this.currentOxygen-=t}resetGame(){this.score=0,this.maxOxygen=60,this.currentOxygen=60,this.mineral=250,this.currentLevel=0,this.currentDistance=0,this.maxDistance=60,this.currentHealth=50,this.maxHealth=50}setLevel(t){this.currentLevel+=1,this.currentDistance=0,this.difficultySetting=t}getDifficulty(){return 1==this.difficultySetting?4:2==this.difficultySetting?6:2}update(){Background.renderGamePanels(),Background.render(),requests.map(t=>t.render()),goals.map(t=>t.render()),textInterface.renderInfoPanel()}checkShipAndSolarFlare(t,e){e.spawnLeft&&t.position_x<64&&(this.currentHealth-=5)}}
class Instrument{constructor(t,e,s,i,h,o,a,n,r=0){this.wave=t,this.attackTime=e,this.releaseTime=s,this.noteLength=i,this.vibratoAmount=h,this.vibratoSpeed=o,this.octave=a,this.volume=n,this.note=r}}
class Map{constructor(t){this.context=t,this.cursorLocation=0,this.destinationList=[{location:0,x:0,y:0,size:10,name:"Easy galaxy"},{location:1,x:0,y:40,size:10,name:"Medium galaxy"},{location:2,x:0,y:80,size:10,name:"Hard galaxy"}],this.finalMission={location:0,x:0,y:0,size:10,name:"Final galaxy"}}render(t){this.renderText(t),state.pressedKeys.up&&(this.cursorLocation-=1,this.cursorLocation<0&&(this.cursorLocation=0),state.pressedKeys.up=!1),state.pressedKeys.down&&(this.cursorLocation+=1,this.cursorLocation>2&&(this.cursorLocation=2),state.pressedKeys.down=!1),t.currentLevel<4?this.destinationList.map(t=>{this.context.fill(),this.context.beginPath(),this.context.fillStyle="#FF0000",this.context.shadowBlur=0,t.location==this.cursorLocation&&(this.context.shadowBlur=5),this.context.shadowColor="#FFF",this.context.arc(t.x+30,t.y+300,t.size,0,100,!1),this.context.font="15px Arial",this.context.fillText(t.name,t.x+50,t.y+305),this.context.fill(),this.context.closePath(),this.context.shadowBlur=0}):4==t.currentLevel&&(this.context.fill(),this.context.beginPath(),this.context.fillStyle="#FF0000",this.context.shadowBlur=5,this.context.shadowColor="#FFF",this.context.arc(this.finalMission.x+30,this.finalMission.y+300,this.finalMission.size,0,100,!1),this.context.font="15px Arial",this.context.fillText(this.finalMission.name,this.finalMission.x+50,this.finalMission.y+305),this.context.fill(),this.context.closePath(),this.context.shadowBlur=0)}renderText(t){let i="Select destination",s=t.currentLevel+1+" / 4 destinations until you reach the end";4==t.currentLevel&&(i="Final destination",s="This will be your hardest destination yet.");this.context.font="30px Arial",this.context.fillStyle="#FFF",this.context.fillText(i,20,200),this.context.fillText(s,20,250),this.context.fillText("Press <Space> to play the final destination",20,450)}}
class Music{constructor(t){this.ctx=t,this.notes={a:440,bs:440*Math.pow(2,1/12),b:440*Math.pow(2,2/12),c:440*Math.pow(2,.25),cs:440*Math.pow(2,4/12),d:440*Math.pow(2,5/12),ds:440*Math.pow(2,.5),e:440*Math.pow(2,7/12),f:440*Math.pow(2,8/12),fs:440*Math.pow(2,.75),g:440*Math.pow(2,10/12),gs:440*Math.pow(2,11/12)},this.isPlaying=!1,this.tempo=220,this.fourth=60/this.tempo,this.half=2*this.fourth,this.whole=2*this.half,this.eigth=this.fourth/2,this.sixteenth=this.eigth/2,this.lookahead=25,this.scheduleAheadTime=.1,this.currentNote=0,this.nextNoteTime=0,this.instruments=[new Instrument("sine",.2,.2,.2,0,10,-1,.6),new Instrument("triangle",.2,.2,.2,0,10,2,.6),new Instrument("square",.04,.04,.2,3.5,10,1,.2)],this.masterVolume=t.createGain(),this.masterVolume.connect(t.destination),this.masterVolume.gain.value=.05,this.snareBuffer=this.snareDrumNoiceBuffer(),this.hitBuffer=this.hitNoiceBuffer(),this.songSection=0,this.songSections=["intro","intro2","verse","verse","verse","verse","bridge","chorus","verse","verse"],this.notesBassVerse=["f","g","d","c"],this.notesBassBridge="bs",this.notesBassChorus=["f","g","bs","c"],this.notesHigh=[["g","a","c","e"],["f","a","c","e"],["d","f","a","e"],["f","a","c","e"]],this.drumControl=0,this.drumNotes=["b","","s","","b","b","s",""],this.notesLeadVerse=[new Note("f",this.half),"","","",new Note("d",this.fourth),"",new Note("c",this.half+this.fourth),"","","","","",new Note("d",this.fourth),"",new Note("g",this.half+this.fourth),"","","","","",new Note("d",this.fourth),"",new Note("c",this.half+this.fourth),"","","","","",new Note("d",this.fourth),"",new Note("a",this.half+this.whole,2),"","","","","","","","","","","",new Note("c",this.fourth,2),"",new Note("a",this.fourth,2),"",new Note("g",this.whole),"","","","","","","",new Note("f",this.half+this.fourth),"","","","","",new Note("e",this.half),"","",""],this.notesLeadBridge=[new Note("d",this.fourth+this.eigth),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),"",new Note("d",this.fourth+this.eigth),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),"",new Note("d",this.fourth+this.eigth),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),"",new Note("d",this.fourth+this.eigth),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),""],this.notesLeadChorus=[new Note("d",this.fourth+this.eigth),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),"",new Note("d",this.fourth+this.eigth),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),"",new Note("f",this.fourth+this.eigth),"","",new Note("c",this.fourth+this.eigth,2),"","",new Note("a",this.fourth,2),"",new Note("f",this.fourth+this.eigth),"","",new Note("c",this.fourth+this.eigth,2),"","",new Note("a",this.fourth,2),"",new Note("f",this.fourth+this.eigth),"","",new Note("c",this.fourth+this.eigth,2),"","",new Note("a",this.fourth,2),"",new Note("f",this.fourth+this.eigth),"","",new Note("c",this.fourth+this.eigth,2),"","",new Note("a",this.fourth,2),"",new Note("bs",this.fourth+this.eigth,2),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),"",new Note("bs",this.fourth+this.eigth,2),"","",new Note("a",this.fourth+this.eigth,2),"","",new Note("f",this.fourth),""]}play(){this.isPlaying=!0,"suspended"===this.ctx.state&&this.ctx.resume(),console.log("play"),this.scheduler()}nextNote(){this.currentNote%2==0&&this.drumControl++,this.drumControl>=this.drumNotes.length&&(this.drumControl=0),this.currentNote===this.notesLeadVerse.length-1||31===this.currentNote&&"bridge"==this.songSections[this.songSection]?(this.currentNote=0,this.songSection++,this.songSection>this.songSections.length-1&&(this.songSection=0)):this.currentNote++,this.nextNoteTime+=this.eigth}stop(){this.isPlaying=!1,this.currentNote=0,this.ctx.suspend(),this.nextNoteTime=0,this.songSection=0,this.drumControl=0}scheduler(){for(;this.nextNoteTime<this.ctx.currentTime+this.scheduleAheadTime&&this.isPlaying;)this.checkBassToPlay(),this.checkHighToPlay(),this.checkLeadToPlay(),this.checkDrumToPlay(),this.nextNote();if(this.isPlaying){window.setTimeout(this.scheduler.bind(this),this.lookahead)}}checkBassToPlay(){this.currentNote%2==0&&("verse"==this.songSections[this.songSection]||"intro"==this.songSections[this.songSection]||"intro2"==this.songSections[this.songSection]?this.instruments[0].note=this.notesBassVerse[Math.floor(this.currentNote/16)]:"chorus"==this.songSections[this.songSection]?this.instruments[0].note=this.notesBassChorus[Math.floor(this.currentNote/16)]:this.instruments[0].note=this.notesBassBridge,this.playNote(this.instruments[0],this.nextNoteTime))}checkHighToPlay(){this.instruments[1].note=this.notesHigh[Math.floor(this.currentNote/16)][this.currentNote%4],this.playNote(this.instruments[1],this.nextNoteTime)}checkLeadToPlay(){"verse"==this.songSections[this.songSection]&&""!=this.notesLeadVerse[this.currentNote]?(this.instruments[2].note=this.notesLeadVerse[this.currentNote].note,this.instruments[2].noteLength=this.notesLeadVerse[this.currentNote].length,this.instruments[2].octave=this.notesLeadVerse[this.currentNote].octave,this.playNote(this.instruments[2],this.nextNoteTime)):"bridge"==this.songSections[this.songSection]&&""!=this.notesLeadBridge[this.currentNote]?(this.instruments[2].note=this.notesLeadBridge[this.currentNote].note,this.instruments[2].noteLength=this.notesLeadBridge[this.currentNote].length,this.instruments[2].octave=this.notesLeadBridge[this.currentNote].octave,this.playNote(this.instruments[2],this.nextNoteTime)):"chorus"==this.songSections[this.songSection]&&""!=this.notesLeadChorus[this.currentNote]&&(this.instruments[2].note=this.notesLeadChorus[this.currentNote].note,this.instruments[2].noteLength=this.notesLeadChorus[this.currentNote].length,this.instruments[2].octave=this.notesLeadChorus[this.currentNote].octave,this.playNote(this.instruments[2],this.nextNoteTime))}checkDrumToPlay(){"intro"!=this.songSections[this.songSection]&&this.currentNote%2==0&&""!=this.drumNotes[this.drumControl]&&("b"==this.drumNotes[this.drumControl]?this.baseDrum(this.nextNoteTime):this.snareDrum(this.nextNoteTime))}playNote(t,e){if(""!=t.note){const s=this.ctx.createGain();s.gain.value=1,s.connect(this.masterVolume);const i=t.volume,h=this.ctx.createOscillator(),o=this.ctx.createGain();o.gain.setValueAtTime(0,0),o.gain.linearRampToValueAtTime(i,this.ctx.currentTime+t.noteLength*t.attackTime);let n=this.ctx.currentTime+t.noteLength-t.noteLength*t.releaseTime;n>0?o.gain.setValueAtTime(i,n):o.gain.setValueAtTime(i,0),o.gain.linearRampToValueAtTime(0,this.ctx.currentTime+t.noteLength);const r=this.ctx.createGain();r.gain.setValueAtTime(t.vibratoAmount,0),r.connect(h.frequency);const a=this.ctx.createOscillator();a.frequency.setValueAtTime(t.vibratoSpeed,0),a.start(0),a.stop(this.ctx.currentTime+t.noteLength),a.connect(r),h.type=t.wave,h.frequency.setValueAtTime(1*this.notes[t.note]/Math.pow(2,1-t.octave),0),h.start(e),h.stop(e+t.noteLength),h.connect(o),o.connect(s)}}baseDrum(t){const e=this.ctx.createOscillator();e.frequency.setValueAtTime(100,t);const s=this.ctx.createGain();e.connect(s),s.connect(this.masterVolume),s.gain.setValueAtTime(1.6,t),s.gain.exponentialRampToValueAtTime(.001,t+.15),e.start(t),e.stop(t+.15)}snareDrumNoiceBuffer(){const t=.1*this.ctx.sampleRate,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate);let s=e.getChannelData(0);for(let e=0;e<t;e++)s[e]=2*Math.random()-1;return e}snareDrum(t){let e=this.ctx.createBufferSource();e.buffer=this.snareBuffer;let s=this.ctx.createBiquadFilter();s.type="bandpass",s.frequency.value=1e3;const i=this.ctx.createGain();i.gain.setValueAtTime(1.6,t),e.connect(s).connect(i).connect(this.masterVolume),e.start(t)}hitNoiceBuffer(){const t=.05*this.ctx.sampleRate,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate);let s=e.getChannelData(0);for(let e=0;e<t;e++)s[e]=2*Math.random()-1;return e}hit(){let t=this.ctx.createBufferSource();t.buffer=this.hitBuffer;let e=this.ctx.createBiquadFilter();e.type="bandpass",e.frequency.value=200;const s=this.ctx.createGain();s.gain.setValueAtTime(5,0),t.connect(e).connect(s).connect(this.masterVolume),t.start()}pickup(){const t=this.ctx.createOscillator(),e=this.ctx.createGain();e.connect(this.masterVolume),t.connect(e),t.type="triangle",t.frequency.setValueAtTime(1*this.notes.a/Math.pow(2,-1),this.ctx.currentTime),t.frequency.setValueAtTime(1*this.notes.a/Math.pow(2,-2),this.ctx.currentTime+.1),e.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.5),t.start(this.ctx.currentTime),t.stop(this.ctx.currentTime+.5)}}
class Note{constructor(t,s,o=1){this.note=t,this.length=s,this.octave=o}}
class Obstacle{constructor(t){let e=new Image;e.src="assets/images/spritesheet.png",this.current_animation_frame=1,this.context=t,this.image=e,this.max_animation_frame=2,this.current_frame_rate=20,this.max_frame_rate=10,this.x=128,this.y=128,this.start=[0,0],this.xFrame=64,this.yFrame=192,this.name="",this.currentHealth=20,this.maxHealth=20,this.dead=!1,this.showDamageAnimation=!1,this.lootType="nothing",this.lootAmount=0,this.randomNumber=100*Math.random(),this.randomNumber>85?(this.lootType="oxygen",this.lootAmount=10,this.lootColor="#AAAAFF"):this.randomNumber>55&&this.randomNumber<85&&(this.lootType="mineral",this.lootAmount=10,this.lootColor="#FFFF00")}render(){this.currentHealth<this.maxHealth/2?this.context.drawImage(this.image,64,192,64,64,this.x,this.y,64,64):this.context.drawImage(this.image,0,192,64,64,this.x,this.y,64,64),this.movable||(this.current_movable_speed-=1,this.current_movable_speed<0&&(this.movable=!0,this.current_movable_speed=this.max_movable_speed)),1==this.showDamageAnimation&&(this.context.fillStyle="#FFFF00",this.context.shadowColor="#FF0000",this.context.beginPath(),this.context.shadowBlur=5,this.context.fillStyle="#FFFF00",this.context.shadowColor="#FF0000",this.context.arc(this.x+32,this.y+32,20,50,100,!1),this.context.fill(),this.context.closePath(),this.context.shadowBlur=0,this.showDamageAnimation=!1)}getAnimationFrame(t){return 0==t?[0,64]:1==t?[64,64]:[0,64]}moveBack(){this.x-=64}getLocation(){return[this.x,this.y]}takeDamage(t){this.showDamageAnimation=!0,this.currentHealth-=t,music.hit(),this.currentHealth<=0&&this.destroy()}destroy(){this.dead=!0}}
class Ship{constructor(t){let i=new Image;i.src="assets/images/spritesheet.png",this.context=t,this.image=i,this.position_x=64,this.position_y=64,this.current_animation_frame=1,this.max_animation_frame=2,this.current_frame_rate=20,this.max_frame_rate=10,this.movable=!0,this.current_movable_speed=5,this.max_movable_speed=5,this.dead=!1,this.damage=2}addAttackPower(t){this.damage+=t}resetGame(){this.position_x=64,this.position_y=64,this.dead=!1}restartGame(){this.damage=2}isDead(){return this.dead}moveUp(){this.movable&&(this.position_y=this.position_y-64,this.movable=!1)}moveDown(){this.movable&&(this.position_y=this.position_y+64,this.movable=!1)}moveLeft(){this.movable&&(this.position_x=this.position_x-64,this.movable=!1)}moveRight(){this.movable&&(this.position_x=this.position_x+64,this.movable=!1)}render(){let t=this.getAnimationFrame(this.current_animation_frame);this.context.drawImage(this.image,t[0],t[1],64,64,this.position_x,this.position_y,64,64),this.current_frame_rate-=1,0==this.current_frame_rate&&(this.current_animation_frame+=1,this.current_animation_frame==this.max_animation_frame&&(this.current_animation_frame=0),this.current_frame_rate=this.max_frame_rate),this.movable||(this.current_movable_speed-=1,this.current_movable_speed<0&&(this.movable=!0,this.current_movable_speed=this.max_movable_speed))}getAnimationFrame(t){return 0==t?[0,0]:1==t?[64,0]:[0,0]}getPosition(){return[this.position_x,this.position_y]}moveBack(t){t.map(t=>{let i=t.getLocation();64==i[0]&&i[1]==this.position_y&&this.position_x<=0?this.dead=!0:i[1]==this.position_y&&this.position_x+64==i[0]&&(this.position_x=this.position_x-64)})}attack(t){this.movable&&(t.takeDamage(this.damage),this.movable=!1)}}
class Shop{constructor(t){this.context=t,this.cursorLocation=0,this.starList=[]}render(t,s){this.renderText(t,s)}renderText(t,s){state.pressedKeys.up&&(0==this.cursorLocation?this.cursorLocation=0:this.cursorLocation-=1,state.pressedKeys.up=!1),state.pressedKeys.down&&(5==this.cursorLocation?this.cursorLocation=5:this.cursorLocation+=1,state.pressedKeys.down=!1);let e=t.getHealthArray(),o=t.getOxygenArray(),i=t.getMineral(),l=s.damage,n="Health: "+e[0]+"/"+e[1],h="Oxygen: "+o[0]+"/"+o[1],c="Minerals: "+i,r="Attack: "+l;this.context.font="20px Arial",this.context.fillStyle="#AAFFAA",e[0]<=20&&(this.context.fillStyle="#FF0000"),this.context.fillText(n,8,40),this.context.fillStyle="#AAAAFF",o[0]<=15&&(this.context.fillStyle="#FF0000"),this.context.fillText(h,8,62),this.context.fillStyle="#FFFF00",this.context.fillText(c,8,84),this.context.fillStyle="#FF0000",this.context.fillText(r,8,104),this.context.font="30px Arial",this.context.fillStyle="#FFF",this.context.fillText("Welcome to the shop",20,170),this.context.shadowBlur=0,0==this.cursorLocation&&(this.context.shadowBlur=5),this.context.fillText("Extend max Health - Cost 100 minerals",20,250),this.context.shadowBlur=0,1==this.cursorLocation&&(this.context.shadowBlur=5),this.context.fillText("Extend max Oxygen - Cost 100 minerals",20,300),this.context.shadowBlur=0,2==this.cursorLocation&&(this.context.shadowBlur=5),this.context.fillText("Buy 10 Health - Cost 20 minerals",20,350),this.context.shadowBlur=0,3==this.cursorLocation&&(this.context.shadowBlur=5),this.context.fillText("Buy 10 Oxygen - Cost 20 minerals",20,400),this.context.shadowBlur=0,4==this.cursorLocation&&(this.context.shadowBlur=5),this.context.fillText("Buy attack power - Cost 100 minerals",20,450),this.context.shadowBlur=0,5==this.cursorLocation&&(this.context.shadowBlur=5),this.context.fillText("Continue",20,500)}}
class Star{constructor(t){this.uniqueNumber=Math.random(),this.context=t,this.x=800,this.y=500*Math.random(),this.radius=9*this.uniqueNumber+1,this.startAngle=0,this.endAngle=2*Math.PI,this.moveSpeed=this.uniqueNumber}render(){this.context.fill(),this.context.beginPath(),this.context.fillStyle="#ccc",this.context.shadowBlur=5,this.context.shadowColor="#ddd",this.context.arc(this.x,this.y,this.radius,this.startAngle,this.endAngle,!1),this.context.fill(),this.context.closePath(),this.context.shadowBlur=0,this.moveBack()}moveBack(){this.x-=this.moveSpeed}}
class Story{constructor(t){this.context=t}render(t){let e=this.getTitleByLevel(t),i=this.getStoryByLevel(t);this.context.font="20px Arial",this.context.fillStyle="#FFF",this.context.fillText(e,20,270),this.context.fillText(i,20,450)}getTitleByLevel(t){return 0==t?"Level 1":1==t?"First mission":2==t?"Second mission":3==t?"Third mission":4==t?"Forth mission":5==t?"Final mission":"You completed the game!"}getStoryByLevel(t){return 0==t?"Just make it back alive!":1==t?"I should try and tackle some asteroids to get some minerals!":2==t?"Im getting the hang of this. I just need to keep doing what Im doing.":3==t?"Everything is looking good. Space is easy!":4==t?"Its getting tougher and tougher.":5==t?"This is the final showdown, Its all or nothing now.":"Thanks for playing! We had a blast creating it!"}}
class TextInterface{constructor(t){this.context=t}renderStart(){cx.font="30px Arial",cx.fillStyle="#FFF",cx.fillText("That time I tried running away from space",20,270),cx.font="20px Arial",cx.fillText("",20,320),cx.fillText("",20,340),cx.fillText("",20,365),cx.fillText("Try go run as far as you can!",20,390),cx.fillText("Press <Space> to play",20,450),cx.font="12px Arial",cx.fillText("Created by: Daivan Trinh & Hakan Einarsson for js13kGames.com 2021",20,500)}renderEnd(){cx.font="50px Arial",cx.fillStyle="#FFF",cx.fillText("The End",20,270),cx.font="20px Arial",cx.fillText("Thank you for playing our game!",20,340),cx.fillText("We love what you are doing at js13kGames.",20,365),cx.fillText("Keep up the great work!",20,390),cx.font="12px Arial",cx.fillText("Created by: Daivan Trinh & Hakan Einarsson for js13kGames.com 2021",20,500)}renderDead(t){cx.fillStyle="rgba(225,225,225,0.8)",cx.fillRect(0,0,768,512);let l=t;cx.font="30px Arial",cx.fillStyle="#FF0000",cx.fillText("You died!",40,105),cx.font="18px Arial",cx.fillStyle="#000",cx.fillText("You came to the level:",40,145),cx.fillText(l,40,180),cx.fillText("Press <space> to play again",40,230)}renderInfoPanel(t,l,e,x,i){let c="Health: "+t[0]+"/"+t[1],a="Oxygen: "+l[0]+"/"+l[1],n="Destination: "+e[0]+"/"+e[1],f="Minerals: "+x,o="Attack: "+i;this.context.font="12px Arial",this.context.fillStyle="#FFF",this.context.fillText(n,8,18),this.context.fillStyle="#AAFFAA",t[0]<=20&&(this.context.fillStyle="#FF0000"),this.context.fillText(c,8,40),this.context.fillStyle="#AAAAFF",l[0]<=15&&(this.context.fillStyle="#FF0000"),this.context.fillText(a,8,62),this.context.fillStyle="#FFFF00",this.context.fillText(f,8,84),this.context.fillStyle="#FF0000",this.context.fillText(o,8,104)}}
let vendors=["webkit","moz"];for(let e=0;e<vendors.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[vendors[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[e]+"CancelAnimationFrame"]||window[vendors[e]+"CancelRequestAnimationFrame"];const AudioContext=window.AudioContext||window.webkitAudioContext,audioCtx=new AudioContext({latencyHint:"playback",sampleRate:44100});let music=new Music(audioCtx),canvas=document.getElementById("canvas"),cw=canvas.width,ch=canvas.height,fps=30,interval=1e3/fps,lastTime=(new Date).getTime(),currentTime=0,delta=0;cx=canvas.getContext("2d");let map=new Map(cx),shop=new Shop(cx),game=new Game,story=new Story(cx),textInterface=new TextInterface(cx),background=new Background(cx),obstacleList=[],fireballList=[],visualsList=[],spawnFireball=!1,ship=new Ship(cx),currentLevelTicker=40,levelTicker=40,state={pressedKeys:{enter:!1,space:!1,left:!1,right:!1,up:!1,down:!1}},keyMap={Enter:"enter",ArrowRight:"right",ArrowLeft:"left",ArrowUp:"up",ArrowDown:"down",Space:"space"};function keydown(e){let t=keyMap[e.code];state.pressedKeys[t]=!0}function keyup(e){let t=keyMap[e.code];state.pressedKeys[t]=!1}function gameLoop(){if(window.requestAnimationFrame(gameLoop),visualsList.length>0&&visualsList.forEach(e=>{e.time>0?e.render():arrayRemove(visualsList,e)}),state.pressedKeys.space&&"start_menu"===game.state&&(music.play(),game.state="shop",state.pressedKeys.space=!1),state.pressedKeys.space&&"story"===game.state&&6!=game.currentLevel&&(game.state="playing",state.pressedKeys.space=!1),state.pressedKeys.space&&5==shop.cursorLocation&&"shop"===game.state&&(game.state="map",state.pressedKeys.space=!1),state.pressedKeys.space&&0==shop.cursorLocation&&"shop"===game.state&&(game.getMineral()>=100&&(game.addMaxHealth(25),game.mineral-=100),state.pressedKeys.space=!1),state.pressedKeys.space&&1==shop.cursorLocation&&"shop"===game.state&&(game.getMineral()>=100&&(game.addMaxOxygen(25),game.mineral-=100),state.pressedKeys.space=!1),state.pressedKeys.space&&2==shop.cursorLocation&&"shop"===game.state&&(game.getMineral()>=20&&(game.addHealth(10),game.mineral-=20),state.pressedKeys.space=!1),state.pressedKeys.space&&3==shop.cursorLocation&&"shop"===game.state&&(game.getMineral()>=20&&(game.addOxygen(10),game.mineral-=20),state.pressedKeys.space=!1),state.pressedKeys.space&&4==shop.cursorLocation&&"shop"===game.state&&(game.getMineral()>=100&&(ship.addAttackPower(2),game.mineral-=100),state.pressedKeys.space=!1),state.pressedKeys.space&&"map"===game.state&&(game.setLevel(map.cursorLocation),ship.resetGame(),obstacleList=[],fireballList=[],game.state="story",state.pressedKeys.space=!1),state.pressedKeys.space&&"dead"===game.state&&(ship.restartGame(),game.resetGame(),ship.resetGame(),obstacleList=[],fireballList=[],game.state="start_menu",state.pressedKeys.space=!1),state.pressedKeys.up)if(shipLocation=ship.getPosition(),0==shipLocation[1])isUpEmpty=!1;else if(shipLocation[1]-=64,isUpEmpty=!0,currentObstacle=[],obstacleList.map(e=>{obstacleLocation=e.getLocation(),obstacleLocation[0]==shipLocation[0]&&obstacleLocation[1]==shipLocation[1]&&(isUpEmpty=!1,currentObstacle=e)}),isUpEmpty)ship.moveUp();else if(ship.attack(currentObstacle),!0===currentObstacle.dead){if(game.getObstacleReward(currentObstacle),"nothing"!=currentObstacle.lootType){let e=`+${currentObstacle.lootAmount} ${currentObstacle.lootType}`;visualsList.push(new FloatingText(cx,ship.getPosition(),e,currentObstacle.lootColor)),music.pickup()}obstacleList=arrayRemove(obstacleList,currentObstacle)}if(state.pressedKeys.down)if(shipLocation=ship.getPosition(),448==shipLocation[1])isUpEmpty=!1;else if(shipLocation[1]+=64,isUpEmpty=!0,obstacleList.map(e=>{obstacleLocation=e.getLocation(),obstacleLocation[0]==shipLocation[0]&&obstacleLocation[1]==shipLocation[1]&&(isUpEmpty=!1,currentObstacle=e)}),isUpEmpty)ship.moveDown();else if(ship.attack(currentObstacle),!0===currentObstacle.dead){if(game.getObstacleReward(currentObstacle),"nothing"!=currentObstacle.lootType){let e=`+${currentObstacle.lootAmount} ${currentObstacle.lootType}`;visualsList.push(new FloatingText(cx,ship.getPosition(),e,currentObstacle.lootColor)),music.pickup()}obstacleList=arrayRemove(obstacleList,currentObstacle)}if(state.pressedKeys.left)if(shipLocation=ship.getPosition(),0==shipLocation[0])isUpEmpty=!1;else if(shipLocation[0]-=64,isUpEmpty=!0,obstacleList.map(e=>{obstacleLocation=e.getLocation(),obstacleLocation[0]==shipLocation[0]&&obstacleLocation[1]==shipLocation[1]&&(isUpEmpty=!1,currentObstacle=e)}),isUpEmpty)ship.moveLeft();else if(ship.attack(currentObstacle),!0===currentObstacle.dead){if(game.getObstacleReward(currentObstacle),"nothing"!=currentObstacle.lootType){let e=`+${currentObstacle.lootAmount} ${currentObstacle.lootType}`;visualsList.push(new FloatingText(cx,ship.getPosition(),e,currentObstacle.lootColor)),music.pickup()}obstacleList=arrayRemove(obstacleList,currentObstacle)}if(state.pressedKeys.right)if(shipLocation=ship.getPosition(),704==shipLocation[0])isUpEmpty=!1;else if(shipLocation[0]+=64,isUpEmpty=!0,obstacleList.map(e=>{obstacleLocation=e.getLocation(),obstacleLocation[0]==shipLocation[0]&&obstacleLocation[1]==shipLocation[1]&&(isUpEmpty=!1,currentObstacle=e)}),isUpEmpty)ship.moveRight();else if(ship.attack(currentObstacle),!0===currentObstacle.dead){if(game.getObstacleReward(currentObstacle),"nothing"!=currentObstacle.lootType){let e=`+${currentObstacle.lootAmount} ${currentObstacle.lootType}`;visualsList.push(new FloatingText(cx,ship.getPosition(),e,currentObstacle.lootColor)),music.pickup()}obstacleList=arrayRemove(obstacleList,currentObstacle)}if(currentTime=(new Date).getTime(),(delta=currentTime-lastTime)>interval)if(cx.clearRect(0,0,cw,ch),background.render(),"start_menu"===game.state)textInterface.renderStart();else if("story"===game.state)story.render(game.currentLevel);else if("shop"===game.state)shop.render(game,ship);else if("map"===game.state)map.render(game);else if("end"===game.state)textInterface.renderEnd();else if("dead"===game.state)score=0,oxygenArray=game.getOxygenArray(),textInterface.renderDead(game.currentLevel),music.stop();else if("playing"===game.state){if(ship.render(),obstacleList.map(e=>e.render()),fireballList.map(e=>{if(e.render(),checkCollision(e,ship)){fireballList=arrayRemove(fireballList,e);let t="-15 Health";visualsList.push(new FloatingText(cx,ship.getPosition(),t,"#FF0000")),game.addHealth(-15)}}),(currentLevelTicker-=1)<0){ship.moveBack(obstacleList),obstacleList.map(e=>e.moveBack()),currentLevelTicker=levelTicker,game.addScore(10),game.removeOxygen(1),1==game.over()&&(game.state="dead"),ship.isDead()&&(game.state="dead"),game.addDistance(1),game.completeLevel()&&(5==game.currentLevel?(game.currentLevel+=1,game.state="story"):game.state="shop");var e=[0,1,2,3,4,5,6,7],t=[0,1,2,3,4,5,6,7],a=[],s=[];difficulty=game.getDifficulty();for(let t=0;t<difficulty;t++){let t=getObstaclePosition(e,a),s=new Obstacle(cx);s.x=704,s.y=64*t,obstacleList.push(s)}if(spawnFireball){for(let e=0;e<difficulty;e++){let e=getObstaclePosition(t,s),a=new Fireball(cx);a.x=704,a.y=64*e,fireballList.push(a)}spawnFireball=!1}else spawnFireball=!0}healthArray=game.getHealthArray(),oxygenArray=game.getOxygenArray(),distanceArray=game.getDistanceArray(),minerals=game.getMineral(),textInterface.renderInfoPanel(healthArray,oxygenArray,distanceArray,minerals,ship.damage),lastTime=currentTime-delta%interval}}function loadImage(e){return new Promise(t=>{let a=new Image;a.onload=(()=>t(a)),a.src=e})}function arrayRemove(e,t){return e.filter(function(e){return e!=t})}function in_array(e,t){for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1}function getObstaclePosition(e,t){var a=e[Math.floor(Math.random()*e.length)];return in_array(t,a)?getObstaclePosition(e,t):(t.push(a),a)}function checkCollision(e,t){if(e.width=34,e.height=64,t.width=64,t.height=64,e.x<t.position_x+t.width&&e.x+e.width>t.position_x&&e.y<t.position_y+t.height&&e.y+e.height>t.position_y)return!0}window.addEventListener("keydown",keydown,!1),window.addEventListener("keyup",keyup,!1),Promise.all([loadImage("assets/images/spritesheet.png")]).then(()=>{gameLoop()});