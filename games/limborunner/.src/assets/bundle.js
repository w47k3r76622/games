(()=>{"use strict";class t{constructor(t=1/60,e,s=!1){this.accumulatedTime=0,this.lastTime=null,this.deltaTime=t,this.ctrl=e,s&&this.start(),this.isPaused=this.isStoped=!1}fireOnce(){this.queue(),this.isStoped=!0}updateProxy(t){if(this.lastTime)for(this.accumulatedTime+=(t-this.lastTime)/1e3,this.accumulatedTime>1&&(this.accumulatedTime=1);this.accumulatedTime>this.deltaTime;){this.ctrl.update(Math.floor(t/1e3)),this.accumulatedTime-=this.deltaTime;break}this.lastTime=t,this.isStoped||this.queue()}togglePause(){this.isPaused=!this.isPaused}queue(){requestAnimationFrame((t=>{this.updateProxy(t)}))}start(){this.isStoped=!1,this.queue()}stop(){this.isStoped=!0}}class e{constructor(t){this.main=t,this.subscribers={}}removeAllSubscribers(){this.subscribers={}}addSubscriber(t,e){for(var s in e)this.subscribers[e[s]]||(this.subscribers[e[s]]=[]),this.subscribers[e[s]].push(t)}removeSubscriber(t){for(var e in this.subscribers)for(var s in this.subscribers[e])this.subscribers[e][s]===t&&this.subscribers[e].splice(s,1)}fireEvent(t){var e=this.subscribers[t.name];for(var s in e)e[s].notify&&e[s].notify(t)}}class s{constructor(t,e,i,h=!1){s[t]=this,this.eventListeners=i,this.target=t,this.eventManager=e,this.events=[],this.keys={},this.listen(),this.eventOnLunch=h}listen(){[...this.eventListeners].forEach((t=>{this.target.addEventListener(t,(e=>{this.eventOnLunch?this.eventManager.fireEvent({name:t,event:e}):s.Event.KEY.includes(t)?this.events.push({name:t,event:e.which}):t===s.Event.CONTEXT||t===s.Event.MOUSEMOVE||this.events.push({name:t,event:e})}))}))}fireEvents(){this.events.forEach((function(t){this.eventManager.fireEvent(t)}),this),this.events=[]}}s.Event={KEYDOWN:"keydown",KEYUP:"keyup",KEYPRESS:"keypress",MOUSEDOWN:"mousedown",MOUSEMOVE:"mousemove",CONTEXT:"contextmenu",WHEEL:"wheel",TOUCHSTART:"touchstart",TOUCHEND:"touchend",TOUCHCANCEL:"touchcancel",TOUCHMOVE:"touchmove",CLICK:"click",TOUCHORCLICK:["click","touchstart"],TOUCH:["click","touchstart","touchend","touchcancel","touchmove"],KEY:["keydown","keyup","keypress"],MOUSE:["mousedown","mousemove","wheel","contextmenu"],ALL:["keydown","keyup","keypress","mousedown","mousemove","wheel","contextmenu","touchstart","touchend","touchcancel","touchmove"]},s.key={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSEBREAK:19,CAPSLOCK:20,ESCAPE:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LEFTWINDOW:91,RIGHTWINDOW:92,SELECT:93,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145,SEMICOLON:186,EQUALSIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARDSLASH:191,GRAVEACCENT:192,OPENBRACKET:219,BACKSLASH:220,CLOSEBRAKET:221,SINGLEQUOTE:222};class i{constructor(){}static getcolor(t,e,s,i){return t+e+s+i==0?null:t+e+s==0||t>255||e>255||s>255?"#000":"#"+(t<<16|e<<8|s).toString(16).slice(-6)}static imageToCanvas(t,e,s){const i=document.createElement("canvas");return i.width=e||t.width,i.height=s||t.height,i.getContext("2d").drawImage(t,0,0,i.width,i.height,0,0,i.width,i.height),i}static transformCanvasColors(t,e){let s=t.getContext("2d");const h=document.createElement("canvas");h.width=1*t.width,h.height=1*t.height;let a=h.getContext("2d"),n=0,r=-1;for(let h=0;h<t.height;h++){n=-1,r+=1;for(let o=0;o<t.width;o++){n+=1;let t=s.getImageData(o,h,1,1).data;t=i.getcolor(t[0],t[1],t[2],t[3]),null!=t&&"_"!=e[t]&&(e[t]?a.fillStyle=e[t]:a.fillStyle=t,a.fillRect(n,r,1,1))}}return h}static magnify(t,e=2){if(1==e)return t;let s=t.getContext("2d"),h=document.createElement("canvas");h.width=t.width*e,h.height=t.height*e;let a=h.getContext("2d"),n=0,r=-e;for(let h=0;h<t.height;h++){n=-e,r+=e;for(let o=0;o<t.width;o++){n+=e;let t=s.getImageData(o,h,1,1).data;t=i.getcolor(t[0],t[1],t[2],t[3]),null!=t&&(a.fillStyle=t,a.fillRect(n,r,e,e))}}return h}static to64(t){return t.toDataURL()}static screenshot(t){var e=t.toDataURL("image/jpeg"),s=document.createElement("a");s.download="screenshot.jpeg",s.href=e,document.body.appendChild(s),s.click(),document.body.removeChild(s)}static crop(t,e,s,i,h){const a=document.createElement("canvas");return a.width=i,a.height=h,a.getContext("2d").drawImage(t,e,s,i,h,0,0,i,h),a}static pxielToCanvas(t,e,s,h){let a=t.getContext("2d"),n=document.createElement("canvas");n.width=t.width*s,n.height=t.height*h;let r=n.getContext("2d"),o=0,l=Math.min(-h,t.height);for(let n=0;n<t.height;n++){o=-s,l+=h;for(let c=0;c<t.width;c++){o+=s;let t=a.getImageData(c,n,1,1).data;if(t=i.getcolor(t[0],t[1],t[2],t[3]),null==t)continue;let d=e[t];d&&d.length>1&&(d=d[randInt(0,d.length)]),d&&"_"!=d&&r.drawImage(d,o,l,s,h)}}return n}}class h{static async loadImage(t){return new Promise(((e,s)=>{const i=new Image;i.addEventListener("load",(()=>{e(i)})),i.addEventListener("error",(()=>{s()})),i.src=t}))}static async loadJSON(t){const e=await fetch(t);return await e.json()}static async loadAssets(){h.LOADED||h.ISLOADING||(h.ISLOADING=!0,[...GLOBAL.Assets.images_url].forEach((t=>{const e=new Image;e.addEventListener("load",(()=>{GLOBAL.Assets.images[t]=e,GLOBAL.Assets.loaded++})),e.addEventListener("error",(()=>{GLOBAL.Assets.images[t]=null,GLOBAL.Assets.loaded++})),e.src=GLOBAL.PROJECT_IMAGES+t})),[...GLOBAL.Assets.json_url].forEach((t=>{fetch(t).then((t=>t.json())).then((e=>{GLOBAL.Assets.json[t]=e,GLOBAL.Assets.loaded++}))})),[...GLOBAL.Assets.sounds_url].forEach((t=>{var e=new Audio(t);GLOBAL.Assets.sounds[t]=e,GLOBAL.Assets.loaded++})),h.ISLOADING=!1,h.LOADED=!0)}static getLoadStatus(){return 0==GLOBAL.Assets.count?100:Math.floor(GLOBAL.Assets.loaded/GLOBAL.Assets.count*100)}}window.SpriteMaker=i;class a{constructor(t){this._sceneManager=t,this._loadingProgress=0}update(){this._loadingProgress=h.getLoadStatus(),this._loadingProgress>99&&this._sceneManager.toMainMenuScene(!1)}draw(t){t.fillStyle="#000000",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="#ffffff",t.fillText("LOADING "+(""+this._loadingProgress).padStart(3," ")+"%",t.canvas.width/2,t.canvas.height/2)}}class n{constructor(t,e,s,i,h,a=null,n=null){this.scene=t,this.title=e,this.x=s,this.y=i,this.center=!1,this.selected=!1,this.activate=h,this.width=a||GLOBAL.CANVAS_WIDTH,this.height=n||this.scene.FontHandler.size}draw(t){this.selected&&(t.fillStyle="#20ff0066",t.fillRect(this.x-4,this.y-4,this.width+4,this.height+8)),t.fillStyle="blue",t.font="16px ",this.scene.FontHandler.print(this.title,t,this.x,this.y,this.center)}update(){}inersect(t,e){let s=!1,i=!1;return t>=this.x&&t<=this.x+this.width&&(s=!0),e>=this.y&&e<=this.y+this.height&&(i=!0),s&&i}}class r{constructor(t=8,e="#fff"){this.size=t;var s=i.imageToCanvas(GLOBAL.Assets.images["black-font-8.gif"]),h=i.magnify(s,t/8),a=i.transformCanvasColors(h,{"#ffffff":"_","#000":e});this.chars={};for(let[e,s]of[...GLOBAL.CHARS].entries()){let h=i.crop(a,e*t,0,t,t);this.chars[s]=h}}print(t,e,s,i,h=!1){let a=this.size,n=e.canvas.width,r=Math.floor(n/a),o=s;if(h){let e=r-t.length,i=Math.floor(e/2);o=s+i*a}[...t.toUpperCase()].forEach(((t,s)=>{let h=this.chars[t];e.drawImage(h,o+s*a,i,a,a)}))}printLines(t,e,s,i,h=!1){let a=e.canvas.width,n=this.size,r=Math.floor(a/n),o=i;[...t].forEach((t=>{let i=s;if(h){let e=r-t.length,h=Math.floor(e/2);i=s+h*n}this.print(t,e,i,o),o+=5*this.size/4}))}createTextLayer(t,e){let s=document.createElement("canvas");s.width=e.canvas.width,s.height=e.canvas.height;let i=s.getContext("2d");const h=this.size,a=t.length,n=Math.floor(e.canvas.width/h)/2-a/2,r=Math.floor(e.canvas.height/h)/2;return this.print(t,i,n*h,r*h),console.log(s),s}}class o{constructor(t){window.scene=this,this.sceneManager=t,this.sceneManager.eventManager.addSubscriber(this,[s.Event.TOUCH,s.Event.CLICK,s.Event.MOUSEDOWN,s.Event.KEYDOWN]),this.y=Math.floor(this.sceneManager._main.canvas.height),this._speed=5,this.arrived=!1,this.FontHandler=new r(16,"#ffffff"),this.FontHandlerGreen=new r(32,"green"),this.FontHandlerRed=new r(32,"red"),this.FontHandlerBlue=new r(32,"#0000ff"),this.FontHandlerWhite=new r(32,"#ffffff");let e={x:80,y:240,h:this.FontHandler.size+16,r:0},i=this;this.menuItems=[new n(this,"New Game",e.x,e.y+e.h*e.r++,(function(){i.sceneManager.toGame()})),new n(this,"INSTRUCTIONS",e.x,e.y+e.h*e.r++,(function(){i.sceneManager.toInstructions()})),new n(this,"LEADERBOARD",e.x,e.y+e.h*e.r++,(function(){i.sceneManager.toLeaderboard()}))],this.menuItemSelected=0,this.menuItemSelected=this.menuItemSelected%this.menuItems.length,this.copyright=this.getCopyright(),this.buffer=this.getBuffer(),this.Objects=[],this.started=!1,this.board={w:GLOBAL.CANVAS_WIDTH,h:GLOBAL.CANVAS_HEIGHT},this.y=0}async start(){1!=this.started&&(this.started=!0)}update(t){this.arrived||(this.y>0?this.y-=this._speed:(this.arrived=!0,this.y=0)),this.arrived&&this.start(),[...this.Objects].forEach((e=>{e.update&&e.update(t)}))}notify(t){let e,i;e=i=1/0,t.event,t.name!=s.Event.KEYDOWN&&t.name!=s.Event.KEYPRESS||this.keydown(t.event),this.y=0,this.buffer=this.getBuffer()}keydown(t){t.which&&(t=t.which),t==s.key.UP?(this.menuItemSelected--,this.menuItemSelected<0&&(this.menuItemSelected=this.menuItems.length-1)):t==s.key.DOWN?this.menuItemSelected++:t!=s.key.X&&t!=s.key.ENTER||setTimeout(this.menuItems[this.menuItemSelected].activate,500),this.menuItemSelected=this.menuItemSelected%this.menuItems.length}getBuffer(){let t=document.createElement("canvas");t.width=GLOBAL.CANVAS_WIDTH,t.height=GLOBAL.CANVAS_HEIGHT;let e=t.getContext("2d");return[...this.menuItems].forEach((t=>{t==this.menuItems[this.menuItemSelected]?t.selected=!0:t.selected=!1,t.draw(e)})),this.drawIntroImage(e),this.drawIntroGameLogo(e),this.drawCopyRights(e),this.drawLogo(e),t}drawCopyRights(t){let e={c:this.copyright,w:this.copyright.width,h:this.copyright.height};e.x=t.canvas.width/2-e.w/2,e.y=t.canvas.height-2*e.h,t.drawImage(e.c,e.x,e.y,e.w,e.h)}drawLogo(t){let e=GLOBAL.Assets.images[GLOBAL.IMAGES.LOGO];if(e){let s=GLOBAL.CANVAS_WIDTH-e.width;t.drawImage(e,s,GLOBAL.CANVAS_HEIGHT-e.height-96,e.width,e.height)}}draw(t){t.clearRect(0,0,GLOBAL.CANVAS_WIDTH,GLOBAL.CANVAS_HEIGHT),t.fillStyle="#000",t.fillRect(0,0,GLOBAL.CANVAS_WIDTH,GLOBAL.CANVAS_HEIGHT);let e=this.buffer;t.drawImage(e,0,this.y,e.width,e.height),this.drawGridAndBoard(t),[...this.Objects].forEach((e=>{e.draw&&e.draw(t)}))}drawIntroImage(t){this.FontHandlerRed.printLines(["LIMBO RUNNER","GAME"],t,2,86,!0),this.FontHandlerWhite.printLines(["LIMBO RUNNER","GAME"],t,3,88,!0)}drawIntroGameLogo(t){this.FontHandler.chars.L;let e,s=i.imageToCanvas(GLOBAL.Assets.images["grass.gif"]),h=i.imageToCanvas(GLOBAL.Assets.images["dirt.gif"]);e=i.pxielToCanvas(this.FontHandler.chars.L,{"#ffffff":[s,h]},8,8),t.drawImage(e,16,GLOBAL.CANVAS_HEIGHT-e.height-96,e.width,e.height),e=i.pxielToCanvas(this.FontHandler.chars.I,{"#ffffff":[s,h]},8,8),t.drawImage(e,e.width,GLOBAL.CANVAS_HEIGHT-e.height-96,e.width,e.height),e=i.pxielToCanvas(this.FontHandler.chars.M,{"#ffffff":[s,h]},8,8),t.drawImage(e,2*e.width,GLOBAL.CANVAS_HEIGHT-e.height-96,e.width,e.height),e=i.pxielToCanvas(this.FontHandler.chars.B,{"#ffffff":[s,h]},8,8),t.drawImage(e,3*e.width,GLOBAL.CANVAS_HEIGHT-e.height-96,e.width,e.height),e=i.pxielToCanvas(this.FontHandler.chars.O,{"#ffffff":[s,h]},8,8),t.drawImage(e,4*e.width,GLOBAL.CANVAS_HEIGHT-e.height-96,e.width,e.height)}getCopyright(){let t="BY: MJZ",e=document.createElement("canvas");e.width=t.length*this.FontHandler.size,e.height=this.FontHandler.size;let s=e.getContext("2d");return this.FontHandler.print(t,s,0,0,!1),e}drawGridAndBoard(t){let e=i.imageToCanvas(GLOBAL.Assets.images["dirt.gif"]),s=i.imageToCanvas(GLOBAL.Assets.images["grass.gif"]);e=i.magnify(e,4),s=i.magnify(s,4);let h=e;t.globalAlpha=.3;for(let i=0;i<20;i++)for(let a=0;a<20;a++)h=i%2!=0&&a%2!=0||i%2==0&&a%2==0?s:e,t.drawImage(h,i*h.width,a*h.height);t.globalAlpha=1}}class l{constructor(t,e){this.x=t,this.y=e}is(t){let e=this.x,s=this.y,i=t.x,h=t.y;return e==i&&s==h}distanceTo(t){let e=this.x,s=this.y,i=t.x,h=t.y;if(e==i&&s==h)return 0;if(e==i)return Math.abs(s-h);if(s==h)return Math.abs(e-i);{let t=0;return t+=Math.pow(e-i,2),t+=Math.pow(s-h,2),t=Math.sqrt(t),t}}getAngleTo(t){let e=this.x,s=this.y,i=t.x,h=t.y;return e==i&&s==h||e==i&&s>h?0:s==h&&e<i?2:e==i&&s<h?4:s==h&&e>i?6:e<i&&s>h?1:e<i&&s<h?3:e>i&&s<h?5:e>i&&s>h?7:0}getDirectionTo(t){return getDirection(this.getAngleTo(t))}move(t,e){t==DIRECTION.UP?this.y-=e:t==DIRECTION.DOWN?this.y+=e:t==DIRECTION.LEFT?this.x-=e:t==DIRECTION.RIGHT?this.x+=e:t==DIRECTION.UPLEFT?(this.y-=e,this.x-=e):t==DIRECTION.UPRIGHT?(this.y-=e,this.x+=e):t==DIRECTION.DOWNRIGHT?(this.y+=e,this.x+=e):t==DIRECTION.DOWNLEFT&&(this.y+=e,this.x-=e)}clone(){return new l(this.x,this.y)}draw(t,e){t.fillStyle=e,t.fillRect(this.x-1,this.y-1,2,2)}drawCircle(t,e=4,s="green"){t.fillStyle=s,t.strokeStyle=s,t.beginPath(),t.arc(this.x,this.y,e,0,2*Math.PI),t.fill()}}class c{constructor(t){this.game=t,this.location=new l(0,0),this.sprite=this.getSprite(),this.objects=[]}getSprite(){let t=document.createElement("canvas");t.width=32,t.height=32;let e=t.getContext("2d");return e.fillStyle="red",e.fillRect(0,0,32,32),t}update(t){this.game.isPaused()||this.destination.length>0&&(this.location=this.destination[0],delete this.destination[0])}draw(t){t.drawImage(this.sprite,this.location.x-this.sprite.width/2,this.location.y-this.sprite.height/2,this.sprite.width,this.sprite.height),[...this.objects].forEach((e=>{e.draw&&e.draw(t)}))}moveTo(t){this.game.haveEntityAt(t)||this.destination.push(t)}move(t){let e=this.center.clone();e.move(t,this.width),this.location.push(e)}move(t){if(this.dir==t){let e=this.destination.clone();if(e.move(t,this.width),this.game.Objects.find((t=>t.x==e.x&&t.y==e.y)))return;this.destination.move(t,this.width),this.collisionNormalizer()}this.dir=t}canmove(t){let e=this.destination.clone();return e.move(t,this.width),!(e.x<=0||e.y<=0||e.x>this.game.mapoverlay.width||e.y>this.game.mapoverlay.height||null!=this.game.Objects.find((t=>t.x==e.x&&t.y==e.y)))}getPossibleMoves(){let t=[];for(let e in DIRECTION)this.canmove(DIRECTION[e])&&t.push(DIRECTION[e]);return t}collisionNormalizer(){}moveleft(){this.move(DIRECTION.LEFT)}moveright(){this.move(DIRECTION.RIGHT)}moveup(){this.move(DIRECTION.UP)}movedown(){this.move(DIRECTION.DOWN)}}class d extends l{constructor(t){super(t.center.x,t.center.y),this.that=t,this.that.shots.push(this),this.life=t.level,this.speed=t.level,this.dir=this.that.dir}draw(t){super.drawCircle(t,4,"red")}update(t){super.move(this.dir,this.speed+10)}}class m{constructor(t,e=null){if(this.game=t,this.sprite=m.getSprite(4),this.life=6+2*t.stage,null==e){let t=this.game.mapoverlay.width/this.sprite.width,e=this.game.mapoverlay.height/this.sprite.height;this.x=randInt(0,t)*this.sprite.width-this.sprite.width/2,this.y=randInt(0,e)*this.sprite.height-this.sprite.width/2}else this.x=e.x,this.y=e.y;this.center=new l(this.x,this.y)}draw(t){t.drawImage(this.sprite,this.x-this.sprite.width/2,this.y-this.sprite.width/2)}static getSprite(t=1){const e=SpriteMaker.imageToCanvas(GLOBAL.Assets.images["bricks.gif"]);let s=document.createElement("canvas");s.width=e.width*t,s.height=e.height*t;let i=s.getContext("2d");for(let s=0;s<t;s++)for(let h=0;h<t;h++)i.drawImage(e,s*e.width,h*e.height);return s}}class g extends c{constructor(t){super(t),this.life=100,this.level=1,this.ammo=100,this.center=this.destination=this.latestDestination=new l(0,0),this.shots=[],this.playersprite=this.getSprite(),this.width=this.playersprite.width,this.height=this.playersprite.height,this.dir=DIRECTION.UP}getSprite(){let t=SpriteMaker.imageToCanvas(GLOBAL.Assets.images["hero1.gif"]);return t=SpriteMaker.magnify(t,2),t=SpriteMaker.transformCanvasColors(t,{"#ffffff":"_"}),t}setPosition(t){this.center=this.destination=this.latestDestination=t}draw(t){t.drawImage(this.playersprite,this.center.x-this.width/2,this.center.y-this.height/2),[...this.shots].forEach((e=>{e.draw&&e.draw(t)}));let e=this.center.clone();e.move(this.dir,this.width),t.fillStyle="#4b58b57a",t.fillRect(e.x-this.width/2,e.y-this.height/2,this.width,this.height)}update(t){this.shots=this.shots.filter((t=>t.y>=0&&t.y<=this.game.mapoverlay.height&&t.x>=0&&t.x<=this.game.mapoverlay.width&&t.life>0)),[...this.shots].forEach((e=>{e.update&&e.update(t)}))}fire(){if(this.ammo<=0){if(this.game.score<=0)return;this.ammo=50,this.game.score--}new d(this),this.ammo--}buyammo(){this.game.score<=0||(this.ammo+=50,this.game.score--)}placewall(){if(this.game.score<=0)return;let t=this.center.clone();t.move(this.dir,this.width),this.game.Objects.push(new m(this.game,t)),this.game.score--}possibleMoves(){this.center}}class f extends c{constructor(t,e=!1){super(t),this.life=3,this.level=1,this.center=this.destination=this.latestDestination=new l(0,0),this.shots=[],this.canAttack=!e,this.sprite=this.getSprite(),this.width=this.sprite.width,this.height=this.sprite.height,this.dir=DIRECTION.UP,this.speed=50,e&&(this.speed=10),this.speed-=this.game.stage,this.speed<10&&(this.speed=10),this.cooldownact=this.speed}getSprite(){let t=SpriteMaker.imageToCanvas(GLOBAL.Assets.images["zombie.gif"]);return t=SpriteMaker.magnify(t,2),t=SpriteMaker.transformCanvasColors(t,{"#ffffff":"_"}),0==this.canAttack&&(t=SpriteMaker.transformCanvasColors(t,{"#6abe30":"#6a6230"})),t}setPosition(t){this.center=this.destination=this.latestDestination=t}draw(t){t.drawImage(this.sprite,this.center.x-this.width/2,this.center.y-this.height/2),[...this.shots].forEach((e=>{e.draw&&e.draw(t)}))}update(t){if(this.shots=this.shots.filter((t=>t.y>=0&&t.y<=this.game.mapoverlay.height&&t.x>=0&&t.x<=this.game.mapoverlay.width&&t.life>0)),[...this.shots].forEach((e=>{e.update&&e.update(t)})),this.cooldownact--,this.cooldownact<=0){this.cooldownact=this.speed,rand()>.85&&this.fire(),(rand()>.95||!this.canAttack&&rand()>.3)&&this.placewall();let t=this.getPossibleMoves();t.length>0&&(this.dir=t[randInt(0,t.length)],this.move(this.dir))}}fire(){this.canAttack&&new d(this)}placewall(){let t=this.center.clone();t.move(this.dir,this.width),this.game.Objects.push(new m(this.game,t))}}class u{constructor(t){window.scene=this,this.sceneManager=t,this.main=scene.sceneManager._main,this.sceneManager.eventManager.addSubscriber(this,[s.Event.TOUCH,s.Event.CLICK,s.Event.MOUSEDOWN,s.Event.KEYDOWN]),this.FontHandler=new r(16,"#ffffff"),this.FontHandlerHeader=new r(64,"green"),this.player=new g(this),this.stage=1,this.score=0,this.initGame()}initGame(){this.gamestate=0,this.mobs=[],this.Objects=[],this.level=new w(this),this.mapoverlay=this.level.getMap(),this.player.setPosition(new l(16,this.mapoverlay.height-16));for(let t=0;t<this.stage*randInt(20,50);t++)this.Objects.push(new m(this));for(let t=0;t<this.stage*randInt(20,50);t++)this.addMob();for(let t=0;t<this.stage*randInt(5,10);t++)this.addBuilderMob()}update(t){if(1==this.gamestate)return;this.player.update(t),[...this.mobs].forEach((e=>{e.update&&e.update(t),e.shots&&e.shots.forEach((t=>{[...this.mobs].forEach((e=>{t.distanceTo(this.player.center)<=32&&(this.player.life-=t.life,t.life=0)})),[...this.Objects].forEach((e=>{t.distanceTo(e.center)<=32&&(e.life-=t.life,t.life=0)}))}))})),this.player.shots.forEach((t=>{[...this.mobs].forEach((e=>{t.distanceTo(e.center)<=32&&(e.life-=t.life,t.life=0)})),[...this.Objects].forEach((e=>{t.distanceTo(e.center)<=32&&(e.life-=t.life,t.life=0)}))}));let e=this.mobs.filter((t=>t.life>0));if(this.score+=this.mobs.length-e.length,this.mobs=e,this.Objects=this.Objects.filter((t=>t.life>0)),this.player.life<=0){alert("game over final score is "+this.score);let t=prompt("enter name for score board","player");GLOBAL.Leaderboard.push({name:t,score:this.score}),this.sceneManager.toMainMenuScene()}this.player.center.y<=16&&(this.gamestate=1),this.mobs.length<10*this.stage&&rand()>.4&&this.addMob()}notify(t){t.name!=s.Event.KEYDOWN&&t.name!=s.Event.KEYPRESS||(this.keydown(t.event),t.event.ctrlKey||(t.event.preventDefault(),t.event.stopPropagation()))}getBuffer(){let t=document.createElement("canvas");t.width=this.mapoverlay.width,t.height=this.mapoverlay.height;let e=t.getContext("2d");return this.gameplayField(e),[...this.Objects].forEach((t=>{t.draw&&t.draw(e)})),[...this.mobs].forEach((t=>{t.draw&&t.draw(e)})),this.player.draw(e),t}gameplayField(t){t.drawImage(this.mapoverlay,0,0,this.mapoverlay.width,this.mapoverlay.height)}draw(t){if(1==this.gamestate)return t.fillStyle="#000",t.fillRect(0,0,this.main.canvas.width,this.main.canvas.height),void this.drawStageCompleted(t);t.clearRect(0,0,this.main.canvas.width,this.main.canvas.height),t.fillStyle="#000",t.fillRect(0,0,this.main.canvas.width,this.main.canvas.height);let e,s,i,h,a,n,r,o,l=this.main.canvas.width/2,c=this.main.canvas.height/2,d=this.player.center,m=d.x,g=d.y;m=Math.max(m-l,0),m=Math.min(m,this.main.canvas.width-l),m=0,g-=l,e=m,s=g,a=0,n=0,i=2*l,h=2*c,r=2*l,o=2*c;let f=scene.mapoverlay.height-game.canvas.height;s>f&&(s=f),s<0&&(s=0),window.sy=s,t.drawImage(this.getBuffer(),e,s,i,h,0,0,r,o),this.FontHandler.printLines(["LIFE "+this.player.life,"AMMO "+this.player.ammo,"SCORE "+this.score,"STAGE "+this.stage],t,5,80,!1)}addMob(){let t=new f(this),e=16+32*randInt(0,this.mapoverlay.width/32),s=16+32*randInt(0,this.mapoverlay.height/32);t.setPosition(new l(e,s)),this.mobs.push(t)}addBuilderMob(){let t=new f(this,!0),e=16+32*randInt(0,this.mapoverlay.width/32),s=16+32*randInt(0,this.mapoverlay.height/32);t.setPosition(new l(e,s)),this.mobs.push(t)}keydown(t){if(t.which&&(t=t.which),1==this.gamestate)return this.gamestate=0,this.stage+=1,void this.initGame();if(t==s.key.LEFT){if(this.player.center.x<=16)return;this.player.move(DIRECTION.LEFT)}else if(t==s.key.RIGHT){if(this.player.center.x>=this.mapoverlay.width-16)return;this.player.move(DIRECTION.RIGHT)}else if(t==s.key.UP){if(this.player.center.y<=16)return;this.player.move(DIRECTION.UP)}else if(t==s.key.DOWN){if(this.player.center.y>=this.mapoverlay.height-16)return;this.player.move(DIRECTION.DOWN)}else t==s.key.SPACE?this.player.fire():t==s.key.O?this.addMob():t==s.key.B?this.player.placewall():t==s.key.ESCAPE||t==s.key.BACKSPACE?this.sceneManager.toMainMenuScene():t!=s.key.X&&t!=s.key.ENTER||(0==this.sceneManager._main.Timer.isPaused?this.sceneManager._main.Timer.isPaused=!0:this.sceneManager._main.Timer.isPaused=!1)}drawStageCompleted(t){this.FontHandlerHeader.printLines(["STAGE "+this.stage,"COMPLETED ","SCORE "+this.score],t,5,80,!0)}}class w{constructor(t){this.game=t,this.levelProgress=0,this.levelMap=this.getMap(),this.playerLocation=new l(0,0)}initLevel(){this.player=new g(this.game),this.Objects=[],this.Mobs=[],this.Drops=[]}update(t){}draw(t){}getMap(){let t=i.imageToCanvas(GLOBAL.Assets.images["grass.gif"]),e=i.imageToCanvas(GLOBAL.Assets.images["dirt.gif"]);t=i.magnify(t,4),e=i.magnify(e,4);let s=t.width,h=t.height,a=document.createElement("canvas");a.width=20*s,a.height=80*h;let n=a.getContext("2d");n.clearRect(0,0,a.width,a.height),n.fillStyle="#000",n.fillRect(0,0,a.width,a.height),n.globalAlpha=.3;let r=0,o=0,l=Math.max(20,80),c=Math.min(20,80),d=null;for(let i=0;i<l;i++){r=0;for(let h=0;h<c;h++)d=i%2!=0&&h%2!=0||i%2==0&&h%2==0?e:t,n.drawImage(d,r,o),r+=s;o+=h}return a}}class E{constructor(t){this.sceneManager=t,this.FontHandler=new r(16,"#ffffff"),this.sceneManager.eventManager.addSubscriber(this,[s.Event.TOUCH,s.Event.CLICK,s.Event.MOUSEDOWN,s.Event.KEYDOWN])}update(t){}notify(t){this.sceneManager.toMainMenuScene()}draw(t){t.clearRect(0,0,GLOBAL.CANVAS_WIDTH,GLOBAL.CANVAS_HEIGHT),t.fillStyle="#000",t.fillRect(0,0,GLOBAL.CANVAS_WIDTH,GLOBAL.CANVAS_HEIGHT),this.FontHandler.printLines(["LEADERBOARD"],t,150,80,!1);let e=this.getLeaderBoardList(),s=150;for(let i in e)this.FontHandler.printLines([e[i].name.substring(0,3).toUpperCase()+"  "+e[i].score],t,150,s,!1),s+=22}getLeaderBoardList(){if(GLOBAL.Leaderboard)return GLOBAL.Leaderboard;let t=[{name:"PL1",score:"1000"},{name:"PL2",score:"900"}];return GLOBAL.Leaderboard=t,t}}class p{constructor(t){this.sceneManager=t,this.FontHandler=new r(16,"#ffffff"),this.sceneManager.eventManager.addSubscriber(this,[s.Event.TOUCH,s.Event.CLICK,s.Event.MOUSEDOWN,s.Event.KEYDOWN])}update(t){}notify(t){this.sceneManager.toMainMenuScene()}draw(t){t.clearRect(0,0,GLOBAL.CANVAS_WIDTH,GLOBAL.CANVAS_HEIGHT),t.fillStyle="#000",t.fillRect(0,0,GLOBAL.CANVAS_WIDTH,GLOBAL.CANVAS_HEIGHT),this.FontHandler.printLines(["Instructions"],t,150,80,!1);let e=this.getLeaderBoardList(),s=150;for(let i in e)this.FontHandler.printLines([e[i].name.toUpperCase()+"  "+e[i].def],t,150,s,!1),s+=22;this.FontHandler.printLines(["SPRINT THROUGH LIMBO","THE RELAM OF THE DEAD","SURVIVE TO REACH OTHER SIDE","TILL YOU REACH HOME","","","GOOD LUCK"],t,0,s+50,!0)}getLeaderBoardList(){return[{name:"ARROWS",def:"MOVEMENT"},{name:"SPACE ",def:"FIRE WEAPON"},{name:"B     ",def:"BUILD WALL"},{name:"ESC   ",def:"MAIN SCREEN"},{name:"ENTER ",def:"PAUSE GAME"}]}}class A{constructor(t,e){this._main=e,this.eventManager=t,this.scene=null}update(t){null!=this.scene?this.scene.update(t):this._main.Timer.stop()}draw(t){null!=this.scene?this.scene.draw(t):this._main.Timer.stop()}toLoadingScene(){this.eventManager.removeAllSubscribers(),this.scene=new a(this)}toMainMenuScene(){this.eventManager.removeAllSubscribers(),this.scene=new o(this)}toGame(){this.eventManager.removeAllSubscribers(),this.scene=new u(this)}toLeaderboard(){this.eventManager.removeAllSubscribers(),this.scene=new E(this)}toInstructions(){this.eventManager.removeAllSubscribers(),this.scene=new p(this)}}class v extends class{constructor(){const i=document.querySelector(GLOBAL.CANVAS_CONTAINER);i.innerHTML="",this.canvas=document.createElement("canvas"),i.appendChild(this.canvas),this.canvas.width=GLOBAL.CANVAS_WIDTH,this.canvas.height=GLOBAL.CANVAS_HEIGHT,this.ctx=this.canvas.getContext("2d"),this.Timer=new t(GLOBAL.FRAMERATE,this,!1),this.framesPassedTillNow=0,this.time=0,this.EventManager=new e(this),this.KeyboardAndMouse=new s(this.canvas,this.EventManager,[s.Event.CLICK],!1),new s(window,this.EventManager,[s.Event.KEYDOWN],!0),window.ctx=this.ctx}update(t){this.KeyboardAndMouse.fireEvents(),0==this.Timer.isPaused&&(this.time=t,this.framesPassedTillNow++,this.timeHMS=this.timeInHourFormat(t))}timeInHourFormat(t){let e=Math.floor(t/60),s=Math.floor(e/60);return e=Math.floor(e%60),`${s<10?"0":""}${s}:${e<10?"0":""}${e}:${(t=Math.floor(t%60))<10?"0":""}${t}`}resetCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}async start(){h.loadAssets()}stop(){this.Timer.stop()}}{constructor(){super(GLOBAL.CANVAS),this.SceneManager=new A(this.EventManager,this)}async start(){super.start(),this.SceneManager.toLoadingScene(),this.Timer.start()}update(t){super.update(t),0==this.Timer.isPaused&&(this.SceneManager?(this.SceneManager.update(t),this.SceneManager.draw(this.ctx)):this.Timer.stop())}drawTime(t){let e=this.framesPassedTillNow.toString().padStart(8,"0"),s=this.canvas.width-8*this.timeHMS.length-4,i=this.canvas.width-8*e.length-4;this.ctx.fillText(this.timeHMS,s,4),this.ctx.fillText(e,i,20)}}document.addEventListener("DOMContentLoaded",(function(){window.game||(window.game=new v,setTimeout((()=>{window.game.start()}),500))}),!1)})();