class Vec{constructor(t=0,e=0){return this.x=t,this.y=e,this.m,this}copy(t){return this.x=t.x,this.y=t.y,this}vFrD(t){return this.x=Math.cos(t),this.y=Math.sin(t),this}clear(){return this.x=0,this.y=0,this}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return this.x*=t,this.y*=t,this}dir(t){return Math.atan2(this.y,this.x)}dist(t){return Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))}mag(){return this.m=Math.sqrt(this.x*this.x+this.y*this.y),this.m}unit(){return this.mag(),this.x/=this.m,this.y/=this.m,this.m=1,this}dotPrd(t){return t.unit(),this.x*t.x+this.y*t.y}project(t,e){return this.m=this.dotPrd(t),e.x=this.m*t.x,e.y=this.m*t.y,e}perp(){return this.m=this.x,this.x=this.y,this.y=-this.m,this}limit(t){return this.mag(),this.m>t&&(this.unit(),this.scale(t)),this}}class Button{constructor(t,e,s,i,r,h){this.pos=new Vec(t,e),this.w=s,this.h=i,this.text=r,this.colour=h||"grey"}render(){C.ctx.save(),C.ctx.translate(-this.w/2,-this.h/2),C.ctx.fillStyle=this.colour,C.ctx.fillRect(this.pos.x,this.pos.y,this.w,this.h),C.ctx.restore(),C.ctx.fillStyle="black",C.ctx.font="20px futura",C.ctx.textAlign="center",C.ctx.textBaseLine="top",C.ctx.fillText(this.text,this.pos.x,this.pos.y+this.h/12)}}class Sprite{constructor(t){t.length&&this.init(t)}init(t){this.pos=new Vec(t[0],t[1]),this.ox=t[0],this.oy=t[1],this.w=t[2],this.h=t[3],this.sx=t[4],this.sy=t[5],this.sxo=t[10]||0,this.dx=t[6],this.dy=t[7],this.start=t[8],this.timer=t[8],this.r=t[9],this.aTime=0}update(t){this.dx&&(this.timer-=t,this.timer<=0&&this.release(),Math.abs(this.dx-this.ox)>HEX_RADIUS/2?(_i=this.dx<this.ox?-1:1,Math.abs(this.dx-this.ox)<2*HEX_RADIUS&&Math.abs(this.dy-this.oy)<2*HEX_RADIUS&&(this.r+=.025*_i),this.r+=.025*_i):this.dy<this.oy?this.r=-Math.PI/2:this.r=Math.PI/2,this.pos.x=(this.dx-this.ox)*(this.start-this.timer)/this.start+this.ox,this.pos.y=(this.dy-this.oy)*(this.start-this.timer)/this.start+this.oy-Math.sin((this.start-this.timer)/this.start*Math.PI)*HEX_RADIUS),this.aTime&&gameTime-this.aTime>500&&(this.aTime=0)}render(t,e){C.ctx.save(),C.ctx.translate(this.pos.x,this.pos.y),this.r&&C.ctx.rotate(this.r),C.ctx.drawImage(spriteSheet,this.sx+this.sxo,this.sy+(this.aTime>0?this.h:0),this.w,this.h,t,e,this.w,this.h),C.ctx.restore()}}let ID=0;class Obj{constructor(t,e,s,i,r=1){switch(this.id=ID++,this.pos=new Vec(t.x,t.y),this.mTarget=(new Vec).copy(PointToHex(t)),this.gridPos=new Vec,this.oPos=(new Vec).copy(this.mTarget),this.centre=new Vec,this.w=e,this.h=s,this.fDir=0,this.mDir=new Vec,this.rePath=100,this.path=[],this.colour="grey",this.hex=void 0,this.team=0,this.aTarget=void 0,this.type=i,this.speed=HEX_RADIUS/4,this.aDist=2.1*HEX_RADIUS,this.aSpeed=2e3,this.aDamage=5,this.attacks=4,this.units=12,this.facing=r,this.willFace,this.runMax=5e3,this.running=!1,this.charged=!1,this.dead=!1,this.sprites=[],this.shield=0,i){case"knight":for(this.speed=HEX_RADIUS/2,this.aSpeed=1500,this.aDamage=7,this.shield=2,this.attacks=3,this.units=6,_i=0;_i<6;_i++)_x=spriteLocations[1][0][2*_i]-this.w,_y=spriteLocations[1][0][2*_i+1]-this.h,_z=new Sprite([_x,_y,16,16,0,90,,,,,96*Math.floor(3*Math.random())]),this.sprites.push(_z);break;case"archer":for(this.aDist=4.1*HEX_RADIUS,this.aDamage=3,_i=0;_i<12;_i++)_x=spriteLocations[0][0][2*_i]-this.w,_y=spriteLocations[0][0][2*_i+1]-this.h,_z=new Sprite([_x,_y,14,14,0,60]),this.sprites.push(_z);break;case"spearmen":for(this.aSpeed=1400,this.shield=1,this.aDamage=4,_i=0;_i<12;_i++)_x=spriteLocations[0][0][2*_i]-this.w,_y=spriteLocations[0][0][2*_i+1]-this.h,_z=new Sprite([_x,_y,14,14,_i<8?14:28,32]),this.sprites.push(_z);break;case"horseArcher":for(this.speed=.3*HEX_RADIUS,this.aDist=3.7*HEX_RADIUS,this.aSpeed=1800,this.aDamage=4,this.attacks=3,this.shield=1,this.units=6,_i=0;_i<6;_i++)_x=spriteLocations[1][0][2*_i]-this.w,_y=spriteLocations[1][0][2*_i+1]-this.h,_z=new Sprite([_x,_y,16,16,0,0,,,,,48*Math.floor(3*Math.random())]),this.sprites.push(_z)}this.aTimer=0,this.run=this.runMax,this.health=10*this.units}begin(t){}update(t){if(this.dead)selected==this&&(selected=void 0,litHexes.length=0),gameObjects.splice(gameObjects.indexOf(this),1);else{if(this.health<=0&&(this.dead=!0,this.hex.unit=void 0,this.team?enemies.splice(enemies.indexOf(this),1):army.splice(army.indexOf(this),1)),this.centre.copy(this.pos),this.centre.x+=this.w/2-7,this.centre.y+=this.h/2-7,selected==this&&("archer"==this.type?runButton.type="RUN":this.aTarget?runButton.type="CHARGE!":runButton.type="RUN"),(this.mTarget.x!=this.gridPos.x||this.mTarget.y!=this.gridPos.y||this.hex&&this.pos.dist(this.hex.pos)>HEX_RADIUS/10)&&(this.rePath-=t,this.path.length&&this.path[0].unit&&this.path[0].unit!=this&&(this.rePath=0),this.rePath<=0&&(this.rePath=250,FindPath(this.gridPos,this.mTarget,this.path,this),this.aTarget)))for(_i=0,_iL=this.path.length;_i<_iL;_i++)if(this.aTarget.pos.dist(this.path[_i].pos)<this.aDist){this.path.splice(_i+1);break}if(this.mDir.clear(),this.running||(this.run=Math.min(this.run+t/4,this.runMax)),this.path.length){if(this.path.length>1&&this.centre.dist(this.path[1].pos)<this.centre.dist(this.path[0].pos)&&this.path.splice(0,1),this.path.length>1&&this.centre.dist(this.path[1].pos)<this.path[0].pos.dist(this.path[1].pos)&&this.path.splice(0,1),null!=this.path[0].unit&&this.path[0].unit!=this&&1==this.path.length&&(this.path.splice(0,1),this.mTarget.copy(this.gridPos),this.path.push(hexGrid[this.gridPos.x][this.gridPos.y])),this.path[this.path.length-1].unit&&this.path[this.path.length-1].unit!=this&&this.path.pop(),!this.path.length)return;if(this.centre.dist(this.path[0].pos)<HEX_RADIUS/100&&this.path.splice(0,1),!this.path.length)return;this.mDir.copy(this.path[0].pos).sub(this.pos).unit(),this.running&&(this.run-=t,this.run<0?(this.run=0,this.running=!1,this.mTarget.copy(this.gridPos),this.path.length>1&&this.path.splice(1),this.rePath=0,this.aTimer=this.aSpeed):this.mDir.scale(1.5)),this.pos.add(this.mDir.scale(this.speed).scale(t/1e3)),this.facing=Math.round(this.mDir.dir()/Math.PI*3)+3}else this.running=!1,this.willFace&&(_point.copy(this.willFace.pos).sub(this.pos),this.facing=Math.round(_point.dir()/Math.PI*3)+3,this.willFace=void 0);switch(this.gridPos.copy(PointToHex(this.pos)),this.hex||(this.hex=hexGrid[this.gridPos.x][this.gridPos.y],this.hex.unit=this),this.gridPos.x==this.hex.gridPos.x&&this.gridPos.y==this.hex.gridPos.y||(this.hex.unit=void 0,this.hex=hexGrid[this.gridPos.x][this.gridPos.y],this.hex.unit=this),this.facing){case 0:case 6:case 3:for(_i=0,_iL=this.sprites.length;_i<_iL;_i++)switch(this.type){case"spearmen":this.sprites[_i].pos.x=spriteLocations[0][0][2*_i]-this.w-5,this.sprites[_i].pos.y=spriteLocations[0][0][2*_i+1]-this.h-3,this.isMoving()?this.sprites[_i].sx=42:this.sprites[_i].sx=_i<4?70:56;break;case"archer":this.sprites[_i].pos.x=spriteLocations[0][0][2*_i]-this.w-5,this.sprites[_i].pos.y=spriteLocations[0][0][2*_i+1]-this.h-3,this.sprites[_i].sx=14,this.sprites[_i].sy=60;break;case"knight":this.sprites[_i].pos.x=spriteLocations[1][1][2*_i]-this.w,this.sprites[_i].pos.y=spriteLocations[1][1][2*_i+1]-this.h-5,this.sprites[_i].sx=32+(_i<3?0:16),this.sprites[_i].sy=88;break;case"horseArcher":this.sprites[_i].pos.x=spriteLocations[1][1][2*_i]-this.w,this.sprites[_i].pos.y=spriteLocations[1][1][2*_i+1]-this.h-5,this.sprites[_i].sx=16,this.sprites[_i].sy=122}break;case 4:case 5:for(_i=0,_iL=this.sprites.length;_i<_iL;_i++)switch(this.type){case"spearmen":this.sprites[_i].pos.x=spriteLocations[0][1][2*_i]-this.w-4,this.sprites[_i].pos.y=spriteLocations[0][1][2*_i+1]-this.h-4,this.isMoving()?this.sprites[_i].sx=0:this.sprites[_i].sx=_i<4?14:28;break;case"archer":this.sprites[_i].pos.x=spriteLocations[0][1][2*_i]-this.w-4,this.sprites[_i].pos.y=spriteLocations[0][1][2*_i+1]-this.h-4,this.sprites[_i].sx=0,this.sprites[_i].sy=60;break;case"knight":this.sprites[_i].pos.x=spriteLocations[1][0][2*_i]-this.w,this.sprites[_i].pos.y=spriteLocations[1][0][2*_i+1]-this.h-5,this.sprites[_i].sx=0+(_i<3?0:16),this.sprites[_i].sy=88;break;case"horseArcher":this.sprites[_i].pos.x=spriteLocations[1][0][2*_i]-this.w,this.sprites[_i].pos.y=spriteLocations[1][0][2*_i+1]-this.h-5,this.sprites[_i].sx=0,this.sprites[_i].sy=122}break;case 2:case 1:for(_i=0,_iL=this.sprites.length;_i<_iL;_i++)switch(this.type){case"spearmen":this.sprites[_i].pos.x=spriteLocations[0][2][2*_i]-this.w-5,this.sprites[_i].pos.y=spriteLocations[0][2][2*_i+1]-this.h-4,this.isMoving()?this.sprites[_i].sx=84:this.sprites[_i].sx=_i<4?112:98;break;case"archer":this.sprites[_i].pos.x=spriteLocations[0][2][2*_i]-this.w-5,this.sprites[_i].pos.y=spriteLocations[0][2][2*_i+1]-this.h-4,this.sprites[_i].sx=28,this.sprites[_i].sy=60;break;case"knight":this.sprites[_i].pos.x=spriteLocations[1][2][2*_i]-this.w,this.sprites[_i].pos.y=spriteLocations[1][2][2*_i+1]-this.h-5,this.sprites[_i].sx=64+(_i<3?0:16),this.sprites[_i].sy=88;break;case"horseArcher":this.sprites[_i].pos.x=spriteLocations[1][2][2*_i]-this.w,this.sprites[_i].pos.y=spriteLocations[1][2][2*_i+1]-this.h-5,this.sprites[_i].sx=32,this.sprites[_i].sy=122}}this.aTarget?this.aTarget.dead?(this.aTarget=void 0,this.mTarget.copy(this.gridPos)):this.pos.dist(this.aTarget.pos)<this.aDist?(this.running&&"archer"!=this.type&&(this.charged=!0,this.path.length>1&&this.path.splice(1),this.rePath=0),this.aTimer-=t,this.aTimer<=0&&(0==this.mDir.x&&0==this.mDir.y||"horseArcher"==this.type)&&(_i=0,this.charged&&(_i+=this.aDamage),_point.copy(this.aTarget.pos).sub(this.pos),this.facing=Math.round(_point.dir()/Math.PI*3)+3,_j=Math.abs(_point.dir()/Math.PI*3+3-this.aTarget.facing),_j<1.6||_j>4.6?(_i+=this.aDamage,this.aTarget.shield<2&&(_i+=this.aDamage)):(this.charged&&"spearmen"==this.aTarget.type&&0==this.aTarget.mDir.x&&0==this.aTarget.mDir.y&&(this.health-=this.aTarget.aDamage),("archer"==this.type||"horseArcher"==this.type)&&this.aTarget.shield>0?_i+=this.aDamage/Math.pow(2,this.aTarget.shield):_i+=this.aDamage),this.charged=!1,this.aTarget.takeDamage(_i,this.attacks,this),this.aTimer=this.aSpeed,_point.copy(this.aTarget.pos).sub(this.pos),_j=_point.dir()-Math.PI/4*(_point.x>0?1:-1),this.sprites.forEach(((t,e)=>{switch(this.type){case"archer":case"horseArcher":CreateArrow(this.pos.x+t.pos.x,this.pos.y+t.pos.y,this.aTarget.pos.x+t.pos.x/2,this.aTarget.pos.y+t.pos.y/2,this.pos.dist(this.aTarget.pos)*HEX_RADIUS+200*Math.random(),_j),t.aTime=gameTime;break;case"spearmen":e<4&&(t.aTime=gameTime);break;case"knight":e<3&&(t.aTime=gameTime)}})),"archer"==this.type||"horseArcher"==this.type?zzfx(...fxArrow):zzfx(...fxStab)),"archer"==!this.type&&(this.running=!1)):HexPos(this.mTarget.x,this.mTarget.y).dist(this.aTarget.pos)>this.aDist&&(this.mTarget.copy(this.aTarget.gridPos),this.rePath=0):this.isMoving()||gameObjects.forEach((t=>{this.team!=t.team&&this.pos.dist(t.pos)<this.aDist&&(this.aTarget=t)})),this.sprites.forEach((e=>e.update(t)))}}render(){C.ctx.save(),selected==this?(C.ctx.fillStyle="rgba(128,128,256,0.5)",0==GAME_STATE?DrawHex(C.ctx,this.pos.x+5,this.pos.y+5,HEX_RADIUS,!0):DrawHex(C.ctx,this.pos.x,this.pos.y,HEX_RADIUS,!0),this.aTarget&&(C.ctx.fillStyle="rgba(128,128,0,0.5)",DrawHex(C.ctx,this.aTarget.pos.x,this.aTarget.pos.y,HEX_RADIUS,!0)),C.ctx.fillStyle="rgba(0,0,128,1)",C.ctx.strokeStyle="rgba(0,0,128,0.5)",this.path.forEach((t=>DrawHex(C.ctx,t.pos.x,t.pos.y,4,!0))),C.ctx.save(),C.ctx.lineWidth=HEX_RADIUS/4,C.ctx.beginPath(),C.ctx.moveTo(this.pos.x,this.pos.y),this.path.forEach((t=>C.ctx.lineTo(t.pos.x,t.pos.y))),C.ctx.stroke(),C.ctx.restore()):"horseArcher"!=this.type&&(C.ctx.fillStyle="rgba(0,0,64,1)",C.ctx.strokeStyle="rgba(0,0,64,0.5)",this.path.forEach((t=>DrawHex(C.ctx,t.pos.x,t.pos.y,3,!0))),C.ctx.save(),C.ctx.lineWidth=HEX_RADIUS/8,C.ctx.beginPath(),C.ctx.moveTo(this.pos.x,this.pos.y),this.path.forEach((t=>C.ctx.lineTo(t.pos.x,t.pos.y))),C.ctx.stroke(),C.ctx.restore()),C.ctx.translate(this.pos.x-this.w/2,this.pos.y-this.h/2),0!=GAME_STATE&&(C.ctx.fillStyle="red",C.ctx.fillRect(-this.w/4,2-this.h,1.5*this.w,4),C.ctx.fillStyle="green",C.ctx.fillRect(-this.w/4,2-this.h,this.health/(10*this.units)*this.w*1.5,2),selected==this&&this.run/this.runMax<.35&&Math.floor(this.run/100)%2==0?C.ctx.fillStyle="white":C.ctx.fillStyle="blue",C.ctx.fillRect(-this.w/4,4-this.h,this.run/this.runMax*this.w*1.5,2),"horseArcher"==this.type?C.ctx.fillStyle="rgba(255,255,0,0.5)":C.ctx.fillStyle="rgba(0,255,0,0.5)",DrawHex(C.ctx,this.w/2,this.h/2,HEX_RADIUS/3*2,!0)),_spritesToRender.length=0,this.sprites.forEach((t=>_spritesToRender.push(t))),_spritesToRender.sort(((t,e)=>t.pos.y-e.pos.y)),_spritesToRender.forEach((t=>{C.ctx.save(),0==GAME_STATE&&CAN_PLAY>1&&C.ctx.translate(5,5),(this.facing<2||this.facing>4)&&(C.ctx.translate(this.w,0),C.ctx.scale(-1,1)),this.isMoving()?t.render(0,Math.round(Math.random())):t.render(0,0),C.ctx.restore()})),C.ctx.restore()}touched(){}isMoving(){return 0!=this.mDir.x||0!=this.mDir.y}takeDamage(t,e,s){for(_i=0;_i<e;_i++)this.aTarget||(this.aTarget=s),_j=this.health%10,0==_j||_j>t?this.health-=t:(this.health-=_j,_hex=this.sprites.splice(this.sprites.length-1,1)[0],_hex&&(deadAndBlood.ctx.save(),deadAndBlood.ctx.translate(this.pos.x+_hex.pos.x,this.pos.y+_hex.pos.y),deadAndBlood.ctx.rotate(Math.random()*Math.PI*2),deadAndBlood.ctx.globalAlpha=.8,deadAndBlood.ctx.drawImage(spriteSheet,_hex.sx,_hex.sy,_hex.w,_hex.h,0,0,_hex.w,_hex.h),deadAndBlood.ctx.fillStyle="rgba("+(64*Math.random()+196)+","+20*Math.random()+","+10*Math.random()+",0.6)",deadAndBlood.ctx.beginPath(),deadAndBlood.ctx.arc(this.w/2+(4*Math.random()+2),this.h/2+(4*Math.random()+2),4*Math.random()+2,0,2*Math.PI),deadAndBlood.ctx.arc(this.w/2+(4*Math.random()+2),this.h/2+(4*Math.random()+2),4*Math.random()+2,0,2*Math.PI),deadAndBlood.ctx.arc(this.w/2+(4*Math.random()+2),this.h/2+(4*Math.random()+2),4*Math.random()+2,0,2*Math.PI),deadAndBlood.ctx.fill(),deadAndBlood.ctx.restore()))}}let _i,_iL,_j,_jL,_x,_y,_z,_hex,_cell,_string,scale,_lowest,_current,_g,paused=!1,timePaused=0,lastT=0,deltaT=0,simT=1e3/60,gameTime=0,endTime=0,Simulate=t=>{if(paused)for(deltaT+=t-lastT,lastT=t;deltaT>simT;)deltaT-=simT,timePaused+=simT;else{for(deltaT+=t-lastT,lastT=t;deltaT>simT;)deltaT-=simT,Update(simT),gameTime+=simT;Render()}requestAnimationFrame(Simulate)},GAME_STATE=0,LEVEL=null,CAN_PLAY=1,Update=t=>{switch(GAME_STATE){case 0:break;case 1:AI(),gameObjects.forEach((e=>e.update(t))),arrows.active.forEach((e=>e.update(t))),endTime||0!=enemies.length||(endTime=gameTime+2e3,endMusicPlayed||(endMusicPlayed=!0,zzfxP(...Victory)),CAN_PLAY+=1,2==CAN_PLAY&&(startButton2.colour="blue"),3==CAN_PLAY&&(startButton3.colour="blue")),endTime&&gameTime>endTime&&(GAME_STATE=2),0==army.length&&(zzfxP(...Defeat),endTime=gameTime+2e3,GAME_STATE=3);break;case 2:case 3:gameTime-endTime>3e3&&(endTime=0,GAME_STATE=0,selected=void 0,army.forEach((t=>{t.pos.copy(HexPos(t.oPos.x,t.oPos.y)),t.aTarget=void 0,t.mDir.clear(),t.mTarget.copy(t.oPos),t.gridPos.copy(t.oPos),t.path.length=0,t.run=t.runMax,SpritesFaceDown()})))}},SpritesFaceDown=()=>{army.forEach((t=>{for(_i=0,_iL=t.sprites.length;_i<_iL;_i++)switch(t.type){case"spearmen":t.sprites[_i].pos.x=spriteLocations[0][1][2*_i]-t.w-4,t.sprites[_i].pos.y=spriteLocations[0][1][2*_i+1]-t.h-4,t.sprites[_i].sx=_i<4?14:28;break;case"archer":t.sprites[_i].pos.x=spriteLocations[0][1][2*_i]-t.w-4,t.sprites[_i].pos.y=spriteLocations[0][1][2*_i+1]-t.h-4,t.sprites[_i].sx=0,t.sprites[_i].sy=60;break;case"knight":t.sprites[_i].pos.x=spriteLocations[1][0][2*_i]-t.w,t.sprites[_i].pos.y=spriteLocations[1][0][2*_i+1]-t.h-5,t.sprites[_i].sx=0+(_i<3?0:16),t.sprites[_i].sy=88;break;case"horseArcher":t.sprites[_i].pos.x=spriteLocations[1][0][2*_i]-t.w,t.sprites[_i].pos.y=spriteLocations[1][0][2*_i+1]-t.h-5,t.sprites[_i].sx=0,t.sprites[_i].sy=122}}))},Render=()=>{switch(C.ctx.clearRect(0,0,C.width,C.height),GAME_STATE){case 0:C.ctx.fillStyle="black",C.ctx.fillRect(0,0,C.width,C.height),C.ctx.fillStyle="slategrey",menuObjects.forEach((t=>{t.render()})),C.ctx.fillStyle="red",C.ctx.font=innerWidth/10+"px Times New Roman",C.ctx.fillText("HEX CRUSADERS",innerWidth/2,innerHeight/4),C.ctx.save(),C.ctx.scale(scale,scale),hexPoints.forEach((t=>{t._x>6&&(C.ctx.strokeStyle="rgba(51, 176, 37,0.2)",DrawHex(C.ctx,t.x,t.y))})),C.ctx.translate(-5,-5),army.forEach((t=>t.render())),C.ctx.restore(),C.ctx.font="16px futura",C.ctx.fillStyle="red",C.ctx.fillText("Click to reposition your army",innerWidth/2,innerHeight/8*5),C.ctx.restore();break;case 1:case 2:case 3:C.ctx.fillStyle=levelData[LEVEL].bg,C.ctx.fillRect(0,0,C.width,C.height),C.ctx.save(),C.ctx.strokeStyle="black",C.ctx.scale(scale,scale),DrawHexGrid(),C.ctx.drawImage(deadAndBlood,0,0,innerWidth,innerHeight),litHexes.length>0&&litHexes.forEach((t=>{C.ctx.fillStyle="rgba(0,255,0,0.5)",DrawHex(C.ctx,t.pos.x,t.pos.y,HEX_RADIUS,!0)})),gameObjects.forEach((t=>t.render())),arrows.active.forEach((t=>t.render(0,0))),C.ctx.restore(),uiObjects.forEach((t=>{C.ctx.fillStyle="grey",t.render()})),2==GAME_STATE?(C.ctx.fillStyle="rgba(0,0,0,0.5)",C.ctx.fillRect(0,innerHeight/3,innerWidth,innerHeight/3),C.ctx.font=innerHeight/4+"px Times New Roman",C.ctx.fillStyle="red",C.ctx.fillText("VICTORY!",innerWidth/2,innerHeight/2+.08*innerHeight)):3==GAME_STATE&&(C.ctx.fillStyle="rgba(0,0,0,0.5)",C.ctx.fillRect(0,innerHeight/3,innerWidth,innerHeight/3),C.ctx.font=innerHeight/4+"px Times New Roman",C.ctx.fillStyle="red",C.ctx.fillText("DEFEAT!",innerWidth/2,innerHeight/2+.08*innerHeight))}},StartGame=t=>{gameObjects.length=0,litHexes.length=0,selected=void 0,endMusicPlayed=!1,LEVEL=t,GAME_STATE=1,deadAndBlood.ctx.clearRect(0,0,innerWidth,innerHeight),army.forEach((t=>{t.pos.copy(HexPos(t.oPos.x,t.oPos.y)),t.aTarget=void 0,t.mDir.clear(),t.mTarget.copy(t.oPos),t.gridPos.copy(t.oPos),t.path.length=0,t.facing=2,gameObjects.push(t)})),enemies.length=0,levelData[LEVEL].enemies.forEach((t=>{let e=new Obj(HexPos(t[0],t[1]),14,14,t[2],t[3]);e.team=1,gameObjects.push(e),enemies.push(e)})),hexGrid.forEach((t=>{t.forEach((t=>{t.unit=void 0}))}))},enemies=[],levelData=[{bg:"lightgreen",army:[[8,2,"knight",2],[8,1,"knight",2],[8,3,"archer",2],[9,2,"archer",2],[8,4,"spearmen",2],[8,5,"spearmen",2],[9,3,"spearmen",2],[9,5,"spearmen",2],[9,4,"spearmen",2],[8,6,"archer",2],[9,6,"archer",2],[8,7,"knight",2],[8,8,"knight",2]],enemies:[[1,1,"horseArcher",5],[1,2,"horseArcher",5],[1,4,"horseArcher",5],[1,5,"horseArcher",5],[1,7,"horseArcher",5],[1,8,"horseArcher",5]]},{bg:"lightblue",enemies:[[1,1,"horseArcher",5],[1,2,"horseArcher",5],[1,3,"horseArcher",5],[1,4,"horseArcher",5],[1,5,"horseArcher",5],[1,6,"horseArcher",5],[1,7,"horseArcher",5],[1,8,"horseArcher",5]]},{bg:"orange",enemies:[[1,0,"horseArcher",5],[1,1,"horseArcher",5],[1,2,"horseArcher",5],[1,3,"horseArcher",5],[1,4,"horseArcher",5],[1,5,"horseArcher",5],[1,6,"horseArcher",5],[1,7,"horseArcher",5],[1,8,"horseArcher",5],[1,9,"horseArcher",5]]}],AI=()=>{enemies.forEach((t=>{if(t.aTarget&&(0==t.mDir.x&&0==t.mDir.y&&t.mTarget.copy(t.aTarget.gridPos),t.aTarget.dead&&(t.aTarget=void 0,t.mTarget.clear(),t.rePath=0)),_current=army[0],t&&_current){if(_lowest=t.pos.dist(_current.pos),army.length>1)for(_i=1;_i<army.length;_i++)t.pos.dist(army[_i].pos)<_lowest&&(_lowest=t.pos.dist(army[_i].pos),_current=army[_i]);t.aTarget=_current}}))},_touched=!1,_point=new Vec,DebugHex=new Vec,_spritesToRender=[],HEX_RADIUS=16,DEBUG=!0,GRID_OFFSET=new Vec(24,24),HEX_BUCKET_RATIO=2.5,selected=null,mouse=new Vec,click1=0,click2=0,InitControls=()=>{addEventListener("mousemove",MouseHandler,!1),addEventListener("mousedown",MouseHandler,!1),addEventListener("mouseup",MouseHandler,!1),addEventListener("touchstart",MouseHandler,!1),addEventListener("touchend",MouseHandler,!1),addEventListener("touchmove",MouseHandler,!1)},SetMouse=(t,e)=>{mouse.x=t,mouse.y=e},MouseHandler=t=>{switch(t.type){case"mousedown":case"touchstart":switch(GAME_STATE){case 0:t.touches&&t.touches[0]?SetMouse(t.touches[0].clientX,t.touches[0].clientY):SetMouse(t.clientX,t.clientY);break;case 1:t.touches&&t.touches[0]?SetMouse(t.touches[0].clientX/scale,t.touches[0].clientY/scale):SetMouse(t.clientX/scale,t.clientY/scale)}gameTime-click1<300?TouchObjects(mouse,!0):TouchObjects(mouse),click1=gameTime;break;case"mousemove":case"touchmove":switch(GAME_STATE){case 0:t.touches&&t.touches[0]?SetMouse(t.touches[0].clientX,t.touches[0].clientY):SetMouse(t.clientX,t.clientY);break;case 1:t.touches&&t.touches[0]?SetMouse(t.touches[0].clientX/scale,t.touches[0].clientY/scale):SetMouse(t.clientX/scale,t.clientY/scale)}}},HexToBucket=(t,e)=>{hexBuckets[Math.floor(e.x/(HEX_RADIUS*HEX_BUCKET_RATIO))][Math.floor(e.y/(HEX_RADIUS*HEX_BUCKET_RATIO))].push(t)},_rHex=new Vec,PointToHex=t=>(_point.copy({x:1e4,y:1e4}),hexBuckets[Math.floor(t.x/(HEX_RADIUS*HEX_BUCKET_RATIO))][Math.floor(t.y/(HEX_RADIUS*HEX_BUCKET_RATIO))].forEach((e=>{t.dist(e)<t.dist(_point)&&(_point.copy(e),_rHex.x=e._x,_rHex.y=e._y)})),_rHex),PointCollide=(t,e)=>t.x>e.pos.x-e.w/2&&t.x<e.pos.x+e.w/2&&t.y>e.pos.y-e.h/2&&t.y<e.pos.y+e.h/2,menuObjects=[],uiObjects=[],gameObjects=[],litHexes=[],TouchObjects=(t,e)=>{switch(_touched=!1,GAME_STATE){case 0:_touched=!1,menuObjects.forEach((e=>{PointCollide(t,e)&&(e.touched(),_touched=!0)})),_touched||(_point.copy(t).scale(1/scale),_current=hexPoints[0],_lowest=_lowest=_point.dist(hexPoints[0]),_lowest=1e4,hexPoints.forEach(((t,e)=>{t._x>6&&_point.dist(t)<_lowest&&(_current=t,_lowest=_point.dist(t))})),_hex=_current,army.forEach(((t,e)=>{e?t.pos.dist(_hex)<_lowest&&(_current=t,_lowest=t.pos.dist(_hex)):(_current=t,_lowest=t.pos.dist(_hex))})),_lowest<=HEX_RADIUS?selected==_current?selected=void 0:selected?selected&&(_point.copy(selected.pos),selected.pos.copy(_current.pos),_current.pos.copy(_point),_point.copy(selected.oPos),selected.oPos.copy(_current.oPos),_current.oPos.copy(_point),selected=void 0):selected=_current:selected&&(selected.pos.x=_hex.x,selected.pos.y=_hex.y,selected.oPos.x=_hex._x,selected.oPos.y=_hex._y,selected=void 0));break;case 1:_hex=PointToHex(t),litHexes.length>0&&litHexes.forEach((t=>{_hex.x==t.gridPos.x&&_hex.y==t.gridPos.y&&(t.unit&&t.unit.team!=selected.team?selected.aTarget=t.unit:(_touched=!0,selected.willFace=t,litHexes.length=0))})),_touched||uiObjects.forEach((e=>{e==toggleIntro?PointCollide(t,{pos:{x:e.pos.x/scale,y:e.pos.y/scale},w:e.w/scale,h:e.h/scale})&&(e.touched(),_touched=!0):PointCollide(t,{pos:{x:e.pos.x/scale+e.w/2/scale,y:e.pos.y/scale+e.h/2/scale},w:e.w/scale,h:e.h/scale})&&(e.touched(),_touched=!0)})),_touched||gameObjects.forEach((s=>{PointCollide(t,s)&&(e&&!s.team&&(selected=s),selected?selected==s?e?(selected.mTarget.copy(selected.gridPos),selected.rePath=0,litHexes.length=0,s.hex.neighbours.forEach((t=>{litHexes.push(t)}))):selected=null:(s.team==selected.team?selected=s:selected.aTarget=s,litHexes.length=0):s.team||(selected=s),_touched=!0)})),_touched||(_cell=hexGrid[_hex.x][_hex.y],selected?(null!=_cell.unit&&(_cell.unit.team?selected.aTarget=_cell.unit:selected=_cell.unit),selected.aTarget=void 0,_touched||(selected.mTarget.copy(_hex),selected.rePath=0,litHexes.length=0,hexGrid[_hex.x][_hex.y].neighbours.forEach((t=>{litHexes.push(t)})))):null==_cell.unit||_cell.unit.team||(selected=_cell.unit))}},openSet=[],closedSet=[],manhatten=(t,e)=>Math.abs(e.pos.x-t.pos.x)+Math.abs(e.pos.y-t.pos.y),FindPath=(t,e,s,i)=>{for(s.length=0,hexGrid.forEach((t=>{t.forEach((t=>{t.parent=null,t.g=0,t.unit&&t.unit!=selected&&(t.g=100)}))})),openSet.length=0,closedSet.length=0,openSet.push(hexGrid[t.x][t.y]);openSet.length>0;){for(_lowest=0,_i=0,_iL=openSet.length;_i<_iL;_i++)openSet[_i].f<openSet[_lowest].f&&(_lowest=_i);if(_current=openSet[_lowest],_current.gridPos.x==e.x&&_current.gridPos.y==e.y){for(_cell=_current,s.push(_cell);_cell.parent;)s.push(_cell.parent),_cell=_cell.parent;return s.reverse()}for(openSet.splice(_lowest,1),closedSet.push(_current),_i=0,_iL=_current.neighbours.length;_i<_iL;_i++)if(_cell=_current.neighbours[_i],!closedSet.includes(_cell)){if(_cell.unit&&i.aTarget&&_cell.unit!=i.aTarget)continue;if(_g=_current.g+1,openSet.includes(_cell)){if(_g>=_cell.g)continue}else openSet.push(_cell);_cell.g+=_g,_cell.h=manhatten(_cell,hexGrid[e.x][e.y]),_cell.f=_cell.g+_cell.h,_cell.parent=_current}}return[]},Canvas=(t,e)=>{let s=document.createElement("canvas");return s.ctx=s.getContext("2d"),s.width=t,s.height=e,s.ctx.imageSmoothingEnabled=!1,s},a=Math.PI/3,DrawHex=(t,e,s,i=HEX_RADIUS,r=!1)=>{t.beginPath();for(var h=0;h<6;h++)t.lineTo(e+i*Math.cos(a*h+a/2),s+i*Math.sin(a*h+a/2));t.closePath(),t.stroke(),r&&t.fill()},DrawHexPoints=()=>{hexPoints.forEach((t=>{DrawCircle(C.ctx,t.x,t.y,1),C.ctx.fillStyle="black",C.ctx.font="8px futura";let e=new Vec;e.copy(PointToHex(t));let s=hexGrid[e.x][e.y];C.ctx.fillText("g:"+s.g,t.x,t.y+HEX_RADIUS/2)}))},hexPoints=[],hexBuckets=[],hexGrid=[],hexNeighbours=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}],hexNeighbours2=[{x:-1,y:1},{x:1,y:1}],PrepareGrid=(t,e,s)=>{for(_x=innerWidth/(e*HEX_RADIUS*2),_y=innerHeight/(s*HEX_RADIUS*2)*1.2,scale=Math.min(_x,_y),_x>_y?GRID_OFFSET.y=Math.max((innerWidth-e*HEX_RADIUS*2*scale)/4,24):GRID_OFFSET.x=Math.max((innerHeight-s*HEX_RADIUS*2*scale)/2,24),_x=0;_x<innerWidth/(HEX_RADIUS*HEX_BUCKET_RATIO);_x++)for(hexBuckets.push([]),_y=0;_y<innerHeight/(HEX_RADIUS*HEX_BUCKET_RATIO);_y++)hexBuckets[_x].push([]);for(_x=0;_x<e;_x++)for(hexGrid.push([]),_y=0;_y<s;_y++){let t=new Vec;t.y=GRID_OFFSET.x+_x*HEX_RADIUS+Math.cos(a)*_x*HEX_RADIUS,t.x=GRID_OFFSET.y+_y*HEX_RADIUS+(Math.sin(a)-.1)*_y*HEX_RADIUS+_x%2*Math.sin(a)*HEX_RADIUS,hexPoints.push(t);let e=new Obj(t,0,0);e.gridPos.x=_x,e.gridPos.y=_y,e.f=0,e.g=0,e.h=0,e.neighbours=[],e.parent=void 0,e.unit=void 0,hexGrid[_x][_y]=e,t._x=_x,t._y=_y,HexToBucket(t,{x:t.x+HEX_RADIUS*Math.cos(0*a+a/2),y:t.y+HEX_RADIUS}),HexToBucket(t,{x:t.x+HEX_RADIUS*Math.cos(2*a+a/2),y:t.y+HEX_RADIUS}),HexToBucket(t,{x:t.x+HEX_RADIUS*Math.cos(0*a+a/2),y:t.y-HEX_RADIUS}),HexToBucket(t,{x:t.x+HEX_RADIUS*Math.cos(2*a+a/2),y:t.y-HEX_RADIUS})}for(_x=0;_x<hexGrid.length;_x++)for(_y=0;_y<hexGrid[_x].length;_y++)_hex=hexGrid[_x][_y],hexNeighbours.forEach((t=>{hexGrid[t.x+_x]&&hexGrid[t.x+_x][t.y+_y]&&_hex.neighbours.push(hexGrid[t.x+_x][t.y+_y])})),hexNeighbours2.forEach((t=>{_z=_x%2==0?-1:1,hexGrid[_z*t.x+_x]&&hexGrid[_z*t.x+_x][_z*t.y+_y]&&_hex.neighbours.push(hexGrid[_z*t.x+_x][_z*t.y+_y])}))},HexPos=(t,e)=>hexGrid[t][e].pos,graphs=[[[0,0,1],[1,1,1],[2,2,2],[0,1,1],[2,2,2],[2,3,3],[4,6,5],[4,6,5]],[[,,,,,,,,0],[2,2,2,2,2,2,2,2,1,1]],[[,,,,,,,0,1],[,,,,,,,1],[,,,,,,2,,],[,,,,,2,,,],[,,,,2,,,,],[,,,2,,,,,],[,,2,,,,,,],[,2,,,,,,,],[2,,,,,,,,]],[[2,,,,,,,,],[,2,2,,,,,,],[,,,2,,,,,],[,,,,2,2,,,],[,,,,,,2,,],[,,,,,,,1,0],[,,,,,,,,1]],[[,,,,,,,,,0,0],[,,,,,,,,,1],[,,,,,,,2,2,,],[,,,,,,2,,,,],[,,,,2,2,,,,,],[,,,2,,,,,,,],[,2,2,,,,,,,,],[2,,,,,,,,,,]],[[,,,0],[,,1,1],[,,,2],[,,2],[,,2],[,2,,],[,2,,],[2,,,],[2,,,]],[[0,1,0],[1,1,1],[2,1,2],[,3]],[[0,1,2],[,1]],[[0,0,0,1]],[[1,,,0],[,1,,0],[,,3],[0,0,,2]],[[,0,,],[,,0],[1,1,3,2],[,,0],[,0,,]],[[0,0,0],[1,1,1]],[[,,,,,],[,,,,,],[,,0,0,0,0],[,0,1,1,1,1],[,1,1,1,1,1],[1,,1,2,1,1],[,,1,,2,2],[,,1,,4],[,,4,,,],[,,,,,]],[[,1,0,1],[0,1,3,1,3],[1,1,1,0,0],[1,1,1,1,1],[1,2,2,,],[1,1,1,,],[1,2,2,,],[1,,1,,],[1,,4,,],[4,,,,]],[[,,,,,,,,0,,],[,,,,,,,0,1,3,0],[,,,,,,0,1,2,2,1],[,,0,0,0,0,1,1,2,,],[,0,1,1,1,1,1,1,1,,],[0,,1,2,1,1,1,2,1,,],[1,,1,,2,2,2,2,1,,],[1,,1,,,,,,1,,],[,,4,,,,,,4,,]],[[,,,,,1,0,1,,],[,,,,,0,1,1,3],[,,0,0,0,1,1,1,1,0],[,0,1,1,1,1,1,2,1,1],[,0,1,1,1,1,1,1,,],[0,1,2,1,2,1,2,1,,],[,1,2,1,,2,2,1,,],[,1,,1,,4,,1,,],[,4,,1,,,,4,,],[,,,4,,,,,,]]],colours=["9badb7","847e87","696a6a","595652","323c39","222034","fff","ac3232","d95763","8f563b","663931","45283c","d9a066","eec39a","black","cbdbfc","8a6f30"],palettes=[[0,1,2,3,4,4],[6,8,0,7],[1,2,10],[5,5,5],[4,2],[9,10,11,5,14,14],[5,4,2,4],[12,13],[5,5],[5],[5,,5],[9,10,11,5,2],[0,1,2,3,,4],[0,1,2,3,,,4],[12,9,10,5,2],[12,16,10,5,2],[5,,,5],[6,15,0,1,2],[10,12],[6,15,0,1,,2],[6,15,0,1,,,2],[1,4,2,4],[1,,,1]],DrawGraph=(t,e,s,i,r,h=1,a=0,o=!1)=>{for(e=graphs[e],_z=0;_z<h;_z++)for(_y=0,_yL=e.length;_y<_yL;_y++)for(_x=0,_xL=e[_y].length;_x<_xL;_x++)_string=colours[palettes[s][e[_y][_x]]],_string&&(t.ctx.fillStyle="#"+_string,o?t.ctx.fillRect(i+_y+_z*a,r-_x,1,1):t.ctx.fillRect(i+_x+_z*a,r+_y,1,1))},DrawGraphs=()=>{for(CreateHexSprite(spriteSheet,0,0,0),CreateHexSprite(spriteSheet,32,0,1),CreateHexSprite(spriteSheet,64,0,2),CreateHexSprite(spriteSheet,96,0,3),DrawGraph(spriteSheet,1,2,4,42,3,41,!0),DrawGraph(spriteSheet,1,2,71,39),DrawGraph(spriteSheet,2,2,58,34),DrawGraph(spriteSheet,3,2,16,38),DrawGraph(spriteSheet,4,2,30,35),DrawGraph(spriteSheet,5,2,100,33),DrawGraph(spriteSheet,3,2,114,42,1,0,!0),DrawGraph(spriteSheet,3,2,18,53),DrawGraph(spriteSheet,1,2,73,53),DrawGraph(spriteSheet,3,2,116,55,1,0,!0),_j=0;_j<2;_j++)spriteSheet.ctx.save(),spriteSheet.ctx.translate(0,14*_j),DrawGraph(spriteSheet,0,0,3,36,9,14),DrawGraph(spriteSheet,7,8,46,37,3,14),DrawGraph(spriteSheet,7,3,3,37,3,14),DrawGraph(spriteSheet,7,9,89,37,3,14),DrawGraph(spriteSheet,6,1,1,39,3,14),DrawGraph(spriteSheet,6,1,44,39,3,14),DrawGraph(spriteSheet,6,1,88,39,3,14),DrawGraph(spriteSheet,8,4,130,34),DrawGraph(spriteSheet,0,5,4,64,3,14),DrawGraph(spriteSheet,11,7,4,65,3,14),DrawGraph(spriteSheet,7,10,4,65),DrawGraph(spriteSheet,7,9,19,65),DrawGraph(spriteSheet,7,9,34,65),spriteSheet.ctx.restore();for(DrawGraph(spriteSheet,9,6,6,66),DrawGraph(spriteSheet,10,6,21,64),DrawGraph(spriteSheet,9,6,34,65,1,0,!0),DrawGraph(spriteSheet,9,16,6,80),DrawGraph(spriteSheet,10,16,21,78),DrawGraph(spriteSheet,9,16,34,79,1,0,!0),DrawGraph(spriteSheet,3,2,4,94,3,96),DrawGraph(spriteSheet,1,2,36,94,3,96),DrawGraph(spriteSheet,4,2,66,90,3,96),DrawGraph(spriteSheet,4,2,19,88,3,96),DrawGraph(spriteSheet,2,2,51,88,3,96),DrawGraph(spriteSheet,5,2,83,87,3,96),DrawGraph(spriteSheet,3,2,6,111,3,96),DrawGraph(spriteSheet,1,2,38,110,3,96),DrawGraph(spriteSheet,4,2,68,105,3,96),_j=0;_j<2;_j++){for(spriteSheet.ctx.save(),spriteSheet.ctx.translate(0,16*_j),DrawGraph(spriteSheet,12,11,1,93,2,16),DrawGraph(spriteSheet,12,14,97,93,2,16),DrawGraph(spriteSheet,12,15,193,93,2,16),_i=0;_i<2;_i++)DrawGraph(spriteSheet,0,0,5+16*_i,90,3,96),DrawGraph(spriteSheet,7,3,5+16*_i,91,3,96);for(DrawGraph(spriteSheet,13,11,7,93,2,16),DrawGraph(spriteSheet,13,14,103,93,2,16),DrawGraph(spriteSheet,13,15,199,93,2,16),DrawGraph(spriteSheet,14,11,33,93,2,16),DrawGraph(spriteSheet,14,14,129,93,2,16),DrawGraph(spriteSheet,14,15,225,93,2,16),_i=0;_i<2;_i++)DrawGraph(spriteSheet,0,13,37+16*_i,90,3,96),DrawGraph(spriteSheet,7,8,38+16*_i,91,3,96);for(DrawGraph(spriteSheet,15,11,65,93,2,16),DrawGraph(spriteSheet,15,14,161,93,2,16),DrawGraph(spriteSheet,15,15,257,93,2,16),_i=0;_i<2;_i++)DrawGraph(spriteSheet,0,12,68+16*_i,90,3,96),DrawGraph(spriteSheet,7,9,70+16*_i,91,3,96);spriteSheet.ctx.restore()}for(_j=2;_j<4;_j++)spriteSheet.ctx.save(),spriteSheet.ctx.translate(0,16*_j),DrawGraph(spriteSheet,12,11,1,93),DrawGraph(spriteSheet,12,14,49,93),DrawGraph(spriteSheet,12,15,97,93),DrawGraph(spriteSheet,0,17,5,90,3,48),DrawGraph(spriteSheet,13,11,7,93),DrawGraph(spriteSheet,13,14,55,93),DrawGraph(spriteSheet,13,15,103,93),DrawGraph(spriteSheet,14,11,17,93),DrawGraph(spriteSheet,14,14,65,93),DrawGraph(spriteSheet,14,15,113,93),DrawGraph(spriteSheet,0,20,21,90,3,48),DrawGraph(spriteSheet,15,11,34,93),DrawGraph(spriteSheet,15,14,82,93),DrawGraph(spriteSheet,15,15,130,93),DrawGraph(spriteSheet,0,19,37,90,3,48),DrawGraph(spriteSheet,11,18,5,91,9,16),DrawGraph(spriteSheet,7,10,5,91,3,48),DrawGraph(spriteSheet,7,9,22,91,3,48),DrawGraph(spriteSheet,7,9,39,91,3,48),spriteSheet.ctx.restore();for(DrawGraph(spriteSheet,9,21,7,126,3,48),DrawGraph(spriteSheet,10,21,25,123,3,48),DrawGraph(spriteSheet,9,21,40,125,3,48,!0),DrawGraph(spriteSheet,9,22,7,142,3,48),DrawGraph(spriteSheet,10,22,25,139,3,48),DrawGraph(spriteSheet,9,22,40,141,3,48,!0),_i=0;_i<2;_i++)spriteSheet.ctx.save(),spriteSheet.ctx.translate(0,16*_i),DrawGraph(spriteSheet,6,1,3,93,3,96),DrawGraph(spriteSheet,6,1,19,93,3,96),DrawGraph(spriteSheet,6,1,36,93,3,96),DrawGraph(spriteSheet,6,1,52,93,3,96),DrawGraph(spriteSheet,6,1,69,93,3,96),DrawGraph(spriteSheet,6,1,85,93,3,96),spriteSheet.ctx.restore()},hexSpriteData=[3,4,6,7,9,10,12,13,15,16,16,16,16,16,16,16],RandomGreen=t=>"rgb("+50*Math.random()+","+(48*Math.random()+160-12*t)+","+15*Math.random()+")",CreateHexSprite=(t,e,s,i)=>{for(_y=0,_yL=hexSpriteData.length;_y<_yL;_y++)for(_x=0,_xL=hexSpriteData[_y];_x<_xL;_x++)_string=i,t.ctx.fillStyle=RandomGreen(_string),t.ctx.fillRect(_x+e+HEX_RADIUS,_y+s,1,1),t.ctx.fillStyle=RandomGreen(_string),t.ctx.fillRect(HEX_RADIUS-_x+e-1,_y+s,1,1),t.ctx.fillStyle=RandomGreen(_string),t.ctx.fillRect(_x+e+HEX_RADIUS,2*HEX_RADIUS-1-_y+s,1,1),t.ctx.fillStyle=RandomGreen(_string),t.ctx.fillRect(HEX_RADIUS-_x+e-1,2*HEX_RADIUS-1-_y+s,1,1)},DrawHexSprite=(t,e,s)=>{C.ctx.drawImage(spriteSheet,s,0,32,32,t,e,32,32)},DrawHexGrid=()=>{for(_i=0,_x=0;_x<10;_x++)for(_i+=4,_y=0;_y<10;_y++)_point.y=Math.round(GRID_OFFSET.x+_x*HEX_RADIUS+Math.cos(a)*_x*HEX_RADIUS),_point.x=Math.round(GRID_OFFSET.y+_y*HEX_RADIUS+(Math.sin(a)-.1)*_y*HEX_RADIUS+_x%2*Math.sin(a)*HEX_RADIUS),DrawHexSprite(_point.x-HEX_RADIUS,_point.y-HEX_RADIUS,_i++%4*32)},spriteLocations=[[[26,22,26,17,26,12,26,7,20,22,20,17,20,12,20,7,14,22,14,17,14,12,14,7],[18,24,22,21,26,18,30,15,14,20,18,17,22,14,26,11,10,16,14,13,18,10,22,7],[30,15,26,12,22,9,18,8,26,19,22,16,18,13,14,10,22,23,18,20,14,17,10,14]],[[23,15,18,19,13,23,18,9,13,13,8,17],[20,9,20,15,20,21,12,9,12,15,12,21],[14,8,19,12,24,16,8,14,13,18,18,22]]],ObjectPool=t=>{let e={active:[],inactive:[],newObject:function(s){let i;return e.inactive.length<1?(i=new t([]),i.init(s),i.release=()=>{e.active.splice(e.active.indexOf(i),1),e.inactive.push(i)}):(i=e.inactive.shift(),i.init(s)),e.active.push(i),i}};return e},arrows=ObjectPool(Sprite);CreateArrow=(t,e,s,i,r,h)=>{_i=arrows.newObject([t,e,6,3,129,33,s,i,r,h])};let C=Canvas(innerWidth,innerHeight);C.style.position="fixed",document.body.appendChild(C),PrepareGrid(C.ctx,10,10);let army=[];levelData[0].army.forEach((t=>{let e=new Obj(HexPos(t[0],t[1]),14,14,t[2],t[3]);gameObjects.push(e),army.push(e)}));let spriteSheet=Canvas(512,512);spriteSheet.style.position="fixed",DrawGraphs();let clickToStart=new Button(innerWidth/2,innerHeight/2,400,100,"ClickToStart");clickToStart.touched=()=>{AddButtons(),StartAudio()},menuObjects.push(clickToStart);let AddButtons=()=>{menuObjects.splice(0,1),menuObjects.push(startButton),menuObjects.push(startButton2),menuObjects.push(startButton3),menuObjects.push(toggleIntro),uiObjects.push(toggleIntro)},StartAudio=()=>{zzfxX=new(window.AudioContext||webkitAudioContext),setTimeout((()=>{introNode=zzfxP(...Intro),introPlaying=!0}),1e3)},startButton=new Button(innerWidth/4,innerHeight/2,100,100,"Level 1","blue");startButton.touched=()=>{StartGame(0)};let startButton2=new Button(innerWidth/2,innerHeight/2,100,100,"Level 2");startButton2.touched=()=>{CAN_PLAY>1&&StartGame(1)};let startButton3=new Button(innerWidth/4*3,innerHeight/2,100,100,"Level 3");startButton3.touched=()=>{CAN_PLAY>2&&StartGame(2)};let toggleIntro=new Button(innerWidth/16,innerHeight/16*3,150,40,"Stop Music");toggleIntro.touched=()=>{introPlaying?(introNode.stop(),introPlaying=!1,toggleIntro.text="Play Music"):(introPlaying=!0,introNode=zzfxP(...Intro),toggleIntro.text="Stop Music")};let exitButton=new Button(25,25,25,25,"X");exitButton.touched=()=>{endTime=0,GAME_STATE=0,selected=void 0,army.forEach((t=>{t.pos.copy(HexPos(t.oPos.x,t.oPos.y)),t.aTarget=void 0,t.mDir.clear(),t.mTarget.copy(t.oPos),t.gridPos.copy(t.oPos),t.path.length=0,t.run=t.runMax,SpritesFaceDown()}))},exitButton.render=()=>{C.ctx.fillStyle="grey",C.ctx.fillRect(exitButton.pos.x,exitButton.pos.y,exitButton.w,exitButton.h),C.ctx.fillStyle="black",C.ctx.font=1.5*HEX_RADIUS+"px Times New Roman",C.ctx.textAlign="center",C.ctx.fillText("X",exitButton.pos.x+exitButton.w/2,exitButton.pos.y+.8*exitButton.h)},uiObjects.push(exitButton);let runButton=new Button(innerWidth-200,innerHeight-150,150,50,"RUN");runButton.touched=()=>{selected&&(!selected.aTarget||"archer"==selected.type||selected.pos.dist(selected.aTarget.pos)>selected.aDist)&&(selected.running=!selected.running)},runButton.render=()=>{selected&&(selected.aTarget&&selected.pos.dist(selected.aTarget.pos)>selected.aDist||!selected.aTarget)&&(C.ctx.fillStyle="grey",C.ctx.fillRect(runButton.pos.x,runButton.pos.y,runButton.w,runButton.h),C.ctx.fillStyle="red",C.ctx.font=2*HEX_RADIUS+"px futura",C.ctx.textAlign="center",C.ctx.fillText(runButton.type,runButton.pos.x+runButton.w/2,runButton.pos.y+runButton.h/1.35))},uiObjects.push(runButton);let deadAndBlood=Canvas(innerWidth,innerHeight);zzfx=(...t)=>zzfxP(zzfxG(...t)),zzfxP=(...t)=>{let e=zzfxX.createBufferSource(),s=zzfxX.createBuffer(t.length,t[0].length,zzfxR);return t.map(((t,e)=>s.getChannelData(e).set(t))),e.buffer=s,e.connect(zzfxX.destination),e.start(),e},zzfxG=(t=1,e=.05,s=220,i=0,r=0,h=.1,a=0,o=1,n=0,c=0,p=0,l=0,_=0,x=0,d=0,u=0,g=0,y=1,S=0,m=0)=>{let w,f,D=2*Math.PI,T=n*=500*D/zzfxR**2,A=(0<d?1:-1)*D/4,E=s*=(1+2*e*Math.random()-e)*D/zzfxR,C=[],H=0,G=0,M=0,P=1,b=0,R=0,I=0;for(i=99+zzfxR*i,S*=zzfxR,r*=zzfxR,h*=zzfxR,g*=zzfxR,c*=500*D/zzfxR**3,d*=D/zzfxR,p*=D/zzfxR,l*=zzfxR,_=zzfxR*_|0,f=i+S+r+h+g|0;M<f;C[M++]=I)++R%(100*u|0)||(I=a?1<a?2<a?3<a?Math.sin((H%D)**3):Math.max(Math.min(Math.tan(H),1),-1):1-(2*H/D%2+2)%2:1-4*Math.abs(Math.round(H/D)-H/D):Math.sin(H),I=(_?1-m+m*Math.sin(2*Math.PI*M/_):1)*(0<I?1:-1)*Math.abs(I)**o*t*zzfxV*(M<i?M/i:M<i+S?1-(M-i)/S*(1-y):M<i+S+r?y:M<f-g?(f-M-g)/h*y:0),I=g?I/2+(g>M?0:(M<f-g?1:(f-M)/g)*C[M-g|0]/2):I),w=(s+=n+=c)*Math.sin(G*d-A),H+=w-w*x*(1-1e9*(Math.sin(M)+1)%2),G+=w-w*x*(1-1e9*(Math.sin(M)**2+1)%2),P&&++P>l&&(s+=p,E+=p,P=0),!_||++b%_||(s=E,n=T,P=P||1);return C},zzfxV=.3,zzfxR=44100,
//! ZzFXM (v2.0.3) | (C) Keith Clark | MIT | https://github.com/keithclark/ZzFXM
zzfxM=(t,e,s,i=125)=>{let r,h,a,o,n,c,p,l,_,x,d,u,g,y,S,m=0,w=[],f=[],D=[],T=0,A=0,E=1,C={},H=zzfxR/i*60>>2;for(;E;T++)w=[E=l=d=g=0],s.map(((i,d)=>{for(p=e[i][T]||[0,0,0],E|=!!e[i][T],S=g+(e[i][0].length-2-!l)*H,y=d==s.length-1,h=2,o=g;h<p.length+y;l=++h){for(n=p[h],_=h==p.length+y-1&&y||x!=(p[0]||0)|n|0,a=0;a<H&&l;a++>H-99&&_?u+=(u<1)/99:0)c=(1-u)*w[m++]/2||0,f[o]=(f[o]||0)-c*A+c,D[o]=(D[o++]||0)+c*A+c;n&&(u=n%1,A=p[1]||0,(n|=0)&&(w=C[[x=p[m=0]||0,n]]=C[[x,n]]||(r=[...t[x]],r[2]*=2**((n-12)/12),n>0?zzfxG(...r):[])))}g=S}));return[f,D]};let introNode,gameOverSound=[,,925,.04,.3,.6,1,.3,,6.27,-184,.09,.17],fxArrow=[.7,.7,327,.05,,.02,3,1.3,,,800,.01,.03,4,1,,.06,.3,,.11],fxStab=[1.06,,176,.01,.01,.04,1,1.51,30,1,,,,4,,.1,,.4,.04,.15],introPlaying=!1,endMusicPlayed=!1,Intro=zzfxM([[.4,0,4e3,,,.03,1,1.25,,,,,.02,6.8,-.3,,.5],[,0,25,.002,.02,.08,3,,,,,,,,,.3,.01],[.4,0,440,,.5,.48,2,,,,,,,,,.02,.01,.75]],[[[,-1,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,],[1,1,13,13.5,13.5,13.5,13,13.5,13.5,13.5,13,13.5,13.5,13.5,13,13.5,13.5,13.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5]],[[,-1,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,],[1,1,13,13.5,13.5,13.5,13,13.5,13.5,13.5,13,13.5,13.5,13.5,13,13.5,13.5,13.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5],[2,,17,,17,15,17,,17,15,17,,17,15,17,20,17,15,13,,13,15,13,,13,15,13,,13,15,13,17,13,15]],[[,-1,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,],[1,1,13,13.5,13.5,13.5,13,13.5,13.5,13.5,13,13.5,13.5,13.5,13,13.5,13.5,13.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5],[2,,5,,3,5,5,,3,5,5,,3,5,17,15,13,10,3,,5,3,3,,5,3,3,,5,3,17,15,13,10]],[[,-1,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,5,,5.5,5.5,5,,5.5,5.5,5,,5.5,5.5,5,,5,,],[1,1,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,10,10.5,10.5,10.5,8,8.5,8.5,8.5,8,8.5,8.5,8.5,8,8.5,8.5,8.5,8,8.5,8.5,8.5],[2,,,,,,,,,,,,3,5,17,15,13,10,3,,,,,,,,,,5,3,17,15,13,10]]],[0,1,1,2,3,1,3,2,3,0],100,{title:"Intro",instruments:["Hihat","Poly Synth","Korg Filter"],patterns:["Pattern 0","Pattern 1","Pattern 2","Pattern 3"]}),Victory=zzfxM(...[[[.4,0,196,,.08,.18,3]],[[[,-1,20,,24,,27,,31,,,,,,],[,1,,24,,27,,31,,32,32,,,,],[,-1,,,,,,,,,,,,,],[,1,,,,,,,,,,,,,]]],[0],,{}]),Defeat=zzfxM([[.5,0,196,,.08,.18,3]],[[[,-1,20,,16,,11,,,,,,],[,1,,19,,15,,10,10,,,,],[,-1,,,,,,,,,,,],[,1,,,,,,,,,,,]]],[0],110,{}),playSong=()=>{zzfxP(...Depp)};setTimeout((()=>{InitControls(),requestAnimationFrame(Simulate)}),10);