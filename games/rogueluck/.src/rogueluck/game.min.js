var tilesetSwamp=new Image;tilesetSwamp.src="img/tilesetSwamp.png";var tilesetChaos=new Image;tilesetChaos.src="img/tilesetChaos.png";var imagePlayer=new Image;imagePlayer.src="img/player.png";var enemySmallMonster=new Image;enemySmallMonster.src="img/smallMonster.png";var enemyBigMonster=new Image;enemyBigMonster.src="img/bigMonster.png";var enemyFootman=new Image;enemyFootman.src="img/enemyFootman.png";var enemyScout=new Image;enemyScout.src="img/enemyScout.png";var sound_fire=new Audio;sound_fire.src="snd/fire.wav";sound_fire.volume=.15;var sound_hit=new Audio;sound_hit.src="snd/hit.wav";sound_hit.volume=.25;window.onload=function(){function h(){this.score=0;this.stage=1;this.time_max=40;this.intro=0;this.clear=function(){s=Math.floor(Math.random()*2);this.background=[];for(var e=0;e<=n;e+=1){this.background.push(Math.floor(Math.random()*4))}this.player=new d;this.arrows=[];this.particles=[];this.enemies=[];this.texts=[];this.luck=50;this.spawn_time=100;this.time_left=this.time_max};this.createParticle=function(){var e=new g;this.particles.push(e);return e};this.createEnemy=function(){enemiesArray=u[s];var e=new v(enemiesArray[Math.floor(Math.random()*enemiesArray.length)]);this.enemies.push(e);return e};this.createText=function(e,t,n,r,i,s){var o=new b;o.x=e;o.y=t;o.ttl=n;o.text=r;o.font=i;o.color=s;this.texts.push(o);return o};this.click=function(){if(f.stage==0){sound_fire.play();this.intro+=1;if(this.intro>2){f.stage=2;c.time_left=2}}else if(f.stage==1){sound_fire.pause();sound_fire.currentTime=0;sound_fire.play();var e=new m;this.arrows.push(e);this.luck-=10;if(this.luck<-100)this.luck=-100;this.player.frame=1;this.player.frame_ttl=5}else if(f.stage==2){}else if(f.stage==3){w();f.stage=2;c.time_left=2}};this.tick=function(){if(f.stage==0){}else if(f.stage==1){this.time_left-=1/60;if(this.time_left<=0){this.time_max+=2;this.clear();this.stage+=1;this.time_left=2;f.stage=2}if(this.luck<100)this.luck+=.04;else if(this.luck>100)this.luck=100;this.spawn_time-=1;if(this.spawn_time<=0){var e=this.createEnemy();e.x=n;this.spawn_time=e.delay-e.delay*this.stage*4/100}}else if(f.stage==2){this.time_left-=1/60;if(this.time_left<=0){this.clear();f.stage=1}}}}function p(){this.stage=0;this.tick=function(){if(this.stage==0){t.fillStyle="#000";t.fillRect(0,0,n,r);if(c.intro==0){t.fillStyle="#61210B";t.fillRect(220,200,200,100);t.fillStyle="#61210B";t.beginPath();t.moveTo(220,198);t.lineTo(420,198);t.lineTo(410,180);t.lineTo(230,180);t.closePath();t.fill();t.fillStyle="#ddd";t.fillRect(310,190,20,30);t.font="30px Consolas";t.fillStyle="#ff0";t.textAlign="center";t.fillText("You found a chest!",320,150)}else if(c.intro==1){t.fillStyle="#61210B";t.fillRect(220,99,200,100);t.fillStyle="#50100A";t.fillRect(225,104,190,90);t.fillStyle="#ddd";t.fillRect(310,89,20,10);t.fillStyle="#61210B";t.fillRect(220,200,200,100);t.strokeStyle="#fff";t.lineWidth=2;t.beginPath();t.arc(300,155,40,1.5*Math.PI,.3*Math.PI,false);t.stroke();t.beginPath();t.moveTo(300,115);t.lineTo(324,188);t.moveTo(290,160);t.lineTo(350,140);t.moveTo(350,140);t.lineTo(345,139);t.moveTo(350,140);t.lineTo(347,144);t.stroke()}else if(c.intro==2){t.font="24px Consolas";t.fillStyle="#ff0";t.textAlign="left";t.fillText("Lucky Bow of Luckiness",175,100);t.fillStyle="#fff";t.fillText("DMG: 25",175,160);t.font="12px Consolas";t.fillStyle="#ff0";t.fillText("o generates positive chance percent over time",175,210);t.fillText("o each shot drains 10 positive chance percent",175,230);t.fillStyle="#0f0";t.fillText("+ positive chance percent to deal a double damage",175,250);t.fillStyle="#f00";t.fillText("- negative chance percent to miss a shot",175,270);t.strokeStyle="#fff";t.lineWidth=2;t.beginPath();t.arc(300,155,40,1.5*Math.PI,.3*Math.PI,false);t.stroke();t.beginPath();t.moveTo(300,115);t.lineTo(324,188);t.moveTo(290,160);t.lineTo(350,140);t.moveTo(350,140);t.lineTo(345,139);t.moveTo(350,140);t.lineTo(347,144);t.stroke()}}else if(this.stage==1){t.fillStyle="#616";t.fillRect(0,0,640,128);t.drawImage(o[s],0,16,16,16,0,0,640,128);for(var e=0;e<n+32;e+=32){t.drawImage(o[s],0,0,16,16,e,128,32,32)}for(var e=0;e<n+64;e+=64){if(c.background[e]>0)t.drawImage(o[s],16+32*(c.background[e]-1),0,32,32,e,64,64,64)}t.fillStyle=a[Math.floor(c.luck/10)+10];t.fillRect(0,176,640,144);t.font="120px Consolas";t.fillStyle="#fff";t.textAlign="center";t.fillText(Math.floor(c.luck)+"%",320,284);t.font="24px Consolas";t.fillStyle="#fff";t.textAlign="left";t.fillText("Score: "+c.score,5,20);t.fillStyle="#111";t.fillRect(0,160,640,16);t.fillStyle="#fff";t.fillRect(1,161,Math.ceil(638*(c.time_left/c.time_max)),14)}else if(this.stage==2){t.fillStyle="#000";t.fillRect(0,0,640,320);t.font="30px Consolas";t.fillStyle="#fff";t.textAlign="center";t.fillText("Wave "+c.stage,320,150)}else if(this.stage==3){t.fillStyle="#000";t.fillRect(0,0,640,320);t.font="30px Consolas";t.fillStyle="#fff";t.textAlign="right";t.fillText("Score:",257,160);t.fillStyle="#ff0";t.textAlign="left";t.fillText(c.score,267,160);t.fillStyle="#fff";t.textAlign="center";t.fillText("Click to play again!",320,240)}}}function d(){this.x=10;this.y=64;this.frame=0;this.frames=[5,5];this.frame_ttl=this.frames[this.frame];this.draw=function(){t.drawImage(imagePlayer,32*this.frame,0,32,32,this.x,this.y,64,64)};this.tick=function(){if(this.frame_ttl<=0){this.frame=0}else{this.frame_ttl-=1}this.draw()}}function v(e){this.init=function(e,t,n,r,i,s,o,u,a){this.name=e;this.x=t;this.y=n;this.speed=r;this.max_hp=i;this.delay=s;this.hp=i;this.frame=0;this.sprite=o;this.frames=u;this.frame_ttl=this.frames[this.frame];this.bar_offset=a};if(e==0)this.init("Zaptor",640,64,1,50,300,enemySmallMonster,[5,10,5,10],17);else if(e==1)this.init("Abominion",640,64,.3,200,900,enemyBigMonster,[30,30,30,30],0);else if(e==2)this.init("Soldier",640,64,.5,100,450,enemyFootman,[10,20,10,20],0);else if(e==3)this.init("Assassin",640,64,1,25,150,enemyScout,[10,10,10,10],0);this.hit=function(e){var t=0;var n=Math.floor(Math.random()*101);if(e.luck>=0){if(n<=e.luck){e.dmg*=2;c.createText(this.x+10,this.y+this.bar_offset-14,25,e.dmg+"!","18px Consolas","#f00")}else{c.createText(this.x+10,this.y+this.bar_offset-12,25,e.dmg,"14px Consolas","#f00")}}else{if(n<=e.luck*-1){e.dmg=0;c.createText(this.x+10,this.y+this.bar_offset-12,25,"Miss!","14px Consolas","#fff")}else{c.createText(this.x+10,this.y+this.bar_offset-12,25,e.dmg,"14px Consolas","#f00")}}this.hp-=e.dmg;if(e.dmg>0){sound_hit.play();t=Math.floor(e.dmg/2)}if(this.hp<=0){c.score+=Math.floor(this.max_hp+this.max_hp*((c.stage-1)*2/100))*10;this.hp=0;t=Math.floor(this.max_hp/2)}for(var r=0;r<t;r++){c.createParticle().x=e.x}return this.hp};this.draw=function(){x=this.x;y=this.y;t.drawImage(this.sprite,32*this.frame,0,32,32,x,y,64,64);t.fillStyle="#000";t.fillRect(x+2,y-5+this.bar_offset,60,5);t.fillStyle="#f00";t.fillRect(x+3,y-4+this.bar_offset,58*(this.hp/this.max_hp),3);t.font="11px Consolas";t.textAlign="center";t.fillStyle="#fff";t.fillText(this.name,x+32,y-3+this.bar_offset)};this.tick=function(){this.frame_ttl-=1;if(this.frame_ttl<=0){this.frame+=1;if(this.frame>this.frames.length-1)this.frame=0;this.frame_ttl=this.frames[this.frame]}this.draw()}}function m(){this.x=40;this.y=100;this.luck=c.luck;this.dmg=25;this.draw=function(e,n){t.beginPath();t.strokeStyle="#000";t.lineWidth=2;t.moveTo(this.x+0,this.y+0);t.lineTo(this.x+15,this.y+0);t.moveTo(this.x+10,this.y-2);t.lineTo(this.x+15,this.y+0);t.moveTo(this.x+10,this.y+2);t.lineTo(this.x+15,this.y+0);t.stroke()};this.tick=function(e,t){this.x+=8;this.draw()}}function g(){this.x=30;this.y=100+Math.floor(Math.random()*2-1);this.x_speed=3+Math.random()*2-1;this.y_speed=-1.5+Math.random()*2-1;this.luck=c.luck;this.dmg=25;this.draw=function(e,n){t.fillStyle="#f00";t.fillRect(this.x,this.y,4,4)};this.tick=function(){this.x_speed-=.05;if(this.x_speed<0)this.x_speed=0;this.y_speed+=.08;this.x+=this.x_speed;this.y+=this.y_speed;this.draw()}}function b(e,n,r,i,s,o){this.x=e;this.y=n;this.ttl=r;this.text=i;this.font=s;this.color=o;this.draw=function(){t.font=this.font;t.fillStyle=this.color;t.fillText(this.text,this.x,this.y)};this.tick=function(){this.y-=.3;this.ttl-=1;if(this.ttl<=0)return 1;this.draw()}}function w(){function t(e){var t="which"in e?e.which:e.keyCode;if(t==32)c.click()}c=new h;e.onclick=function(){c.click()};document.onkeyup=t;f=new p;c.clear();clearInterval(l);l=setInterval(E,1e3/i)}function E(){e.width=e.width;t.webkitImageSmoothingEnabled=false;t.mozImageSmoothingEnabled=false;t.imageSmoothingEnabled=false;c.tick();f.tick();if(f.stage==1){c.player.tick();for(var r=0;r<c.enemies.length;r++){c.enemies[r].x-=c.enemies[r].speed;c.enemies[r].tick();if(c.enemies[r].x<40){c.clear();f.stage=3}}e:for(var r=0;r<c.arrows.length;r++){c.arrows[r].tick();if(c.arrows[r].x>n){c.arrows.splice(r,1);r--;break}for(var i=0;i<c.enemies.length;i++){if(c.arrows[r].x>c.enemies[i].x+10){if(c.enemies[i].hit(c.arrows[r])==0)c.enemies.splice(i,1);i--;c.arrows.splice(r,1);r--;break e}}}for(var r=0;r<c.particles.length;r++){c.particles[r].tick();if(c.particles[r].x>n||c.particles[r].y>128){c.particles.splice(r,1);r--}}for(var r=0;r<c.texts.length;r++){if(c.texts[r].tick()==1){c.texts.splice(r,1);r--}}}}var e=document.getElementById("game");var t=e.getContext("2d");var n=640;var r=320;var i=60;var s;var o=[tilesetChaos,tilesetSwamp];var u=[[0,1],[2,3]];var a=["#ee1111","#e31c11","#d92711","#cd3211","#c23e11","#b74811","#ac5311","#a15f11","#956a11","#8b7511","#808011","#758b11","#699511","#5ea111","#53ac11","#49b711","#3dc211","#32cd11","#27d811","#1be411","#1be411"];var f;var l;var c;w()}