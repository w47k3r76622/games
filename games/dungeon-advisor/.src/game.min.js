function getMousePos(t,e){var n=t.getBoundingClientRect();return void 0!=e?{x:e.clientX-n.left,y:e.clientY-n.top}:H.MouseCoords}function update(t){var e=(t-last_stamp)/1e3;last_stamp=t,ACTIVE&&(g_ctx.fillStyle="#25989B",g_ctx.fillRect(0,0,GAME.width,GAME.height),e*=TIME,UI.update(e),UI.draw(),CALLBACKS&&CALLBACKS.forEach(function(t){t.f(e)}),H.MouseClick=!1),window.requestAnimationFrame(update)}Char=function(t,e,n,o){var r=this;r.s=t,r.color=e,r.bg=n,r.r=r.renderer=new Renderer(cw*t.length,ch,o),void 0!==r.bg&&H.R(0,0,cw*t.length,ch,r.r.x,r.bg),H.T(r.s,cw*t.length/2,ch-1,r.r.x,FONT,r.color,"center"),r.stamp=function(t,e,n){r.r.stamp(t,e,n)},r.flip=function(){r.r.flip()},r.kill=function(){r.r.kill(),H.Null(r)}},Enemy=function(t){var e=this;e.type=t,e.effort=3,e.name=N.Random(),e.c=new Char(t.symbol,t.color),e.charge=function(){var t=e.type.rate;return Math.floor(t.b+(t.t-t.b)*(e.effort/5))},e.kill=function(){e.c.kill(),H.Null(this)}},Button=function(t,e,n,o,r,a,i){var c=this;c.width=(t.length+2+(void 0!==r?H.NT(r).length+4:.75))*cw,c.height=2*ch,c.r=new Renderer(c.width,c.height),c.r.whole=!1,c.cost=r,H.R(3,3,c.width-5,c.height-5,c.r.x,i?"FF0000":"0D423D"),H.R(0,0,c.width-5,c.height-5,c.r.x,i?"AA0000":"007A52"),c.data=a,H.T(t,cw,1.2*ch,c.r.x,FONT,"EBE1CE"),void 0!=r&&(c.r.x.fillText(H.NT(r),(t.length+4)*cw,1.2*ch),P.GOLD.renderer.whole=!1,P.GOLD.stamp(c.r.x,t.length+2.5,.2)),c.x=n,c.y=o,c.s=!1,c.cb=e,c.kill=function(){c.r.kill(),H.Null(this)},c.u=function(){c.s=!0,void 0!=c.cost&&c.cost>UI.gold&&(c.s=!1)},c.hit=function(){return{x:c.x*cw,y:c.y*ch,width:c.r.width,height:c.r.height}},c.stamp=function(t,e,n){c.u(),c.s||(t.globalAlpha=.4),c.r.stamp(t,void 0===e?c.x:e,void 0===n?c.y:n),t.globalAlpha=1},c.update=function(t){c.u(),H.MouseClick&&c.s&&H.HT(H.MouseCoords,c.hit())&&(H.MouseClick=!1,c._clicked=!0,c.cb(c.data))}},Avatar=function(t,e){var n=this;n.color="FB6707",n.h=t,n.r=new Renderer(3*cw,3*ch),n.s=!1,n.c=e,n.gen=function(){H.T("◜◝",0,ch,n.r.x,FONT,n.color),H.T("◟◞",0,2*ch,n.r.x,FONT,n.color),n.h.stamp(n.r.x,n.c?.5:.3,.65),n.s=!0},null!=n.h.stamp&&n.gen(),n.stamp=function(t,e,o){n.s||n.gen(),n.r.stamp(t,e,o)},n.kill=function(){n.r.kill(),H.Null(n)}},StarRating=function(t){var e=this;e.i=0,e.r=new Renderer(30*cw,ch),e.setNum=function(t){if(t!=e.num){e.num=t,e.r.x.clearRect(0,0,e.r.c.width,e.r.c.height);for(var n=0;5>n;n++)Math.round(t)>n?P.STAR.stamp(e.r.x,n,0):P.B_STAR.stamp(e.r.x,n,0);H.T(e.num.toFixed(1)+" ("+e.i+" reviews)",5.5*cw,ch-1,e.r.x,FONT,"000000")}},e.increment=function(){e.i++},e.setNum(0),e.stamp=function(t,n,o){e.r.stamp(t,n,o)}},StatusUpdate=function(t,e,n){var o=this;o.h=t,o.a=new Avatar(t),o.tw=new TypeWriter(n,21,4),o.height=o.tw.height+2,o.tw.run(),o.r=new Renderer(23*cw,ch),H.T(e,0,ch-2,o.r.x,STATUS_FONT,"EAEB38"),o.stamp=function(t,e,n){o.a.stamp(t,e,n),o.r.stamp(t,e+3,n),o.tw.stamp(t,e+3,n+1)},o.kill=function(){o.a.kill(),o.tw.kill(),o.r.kill(),H.Null(o)}},TypeWriter=function(t,e,n,o,r){var a=this;a.font=r||STATUS_FONT,a.fixed=o||!1,a.text=t,a.r=new Renderer(e*cw,n*ch),a.interval,a.height=0,a.arr=[];for(var i=0,c=0,s=ch,l=0;l!==t.length;){var h=t.substr(l),d=h.indexOf(" ");d=-1===d?t.length:d,a.r.x.font=a.font;var u=a.r.x.measureText(h.substring(0,d)).width,p=a.r.x.measureText(t.charAt(l)).width;i+u>=a.r.c.width&&(i=0,c+=s,a.height++),a.arr.push({c:t.charAt(l),x:i,y:c+ch}),l++,i+=p,a.r.c.height=(a.height+2)*ch}a.run=function(){var t=0;a.interval=setInterval(function(){H.T(a.arr[t].c,a.arr[t].x,a.arr[t].y,a.r.x,a.font,"F8BC10"),t==a.arr.length-1&&clearInterval(a.interval),t++}.bind(a),20)},a.stamp=function(t,e,n){a.r.stamp(t,e,n)},a.kill=function(){clearInterval(a.interval),a.r.kill(),H.Null(a)}},Body=function(t,e,n,o){var r=this;r.x=t,r.y=e,r.width=n,r.height=o,r.velocity={x:0,y:0},r.update=function(t){r.x+=r.velocity.x*t,r.y+=r.velocity.y*t}};var p_i=1;Physics={createBody:function(t,e,n,o,r,a){var i=new Body(e,n,o,r,a);return i.i=p_i,p_i++,i}};var roomID=1;Particle=function(t,e,n,o){var r=this;t.length>0?r["char"]=H.RE(t):r["char"]=t,r.x=e,r.y=n,r.ux=(H.GR(0,100)-50)/75,r.rate=H.GR(100,150)/100,r.alpha=1,r.k=o,r.destroy=function(){r.k&&r["char"].kill(),H.Null(r)},r.cb=PUSH_CALLBACK(function(t){if(t*=this.rate,this.alpha+=-t/5,this.alpha<0)POP_CALLBACK(this.cb),this.destroy();else{g_ctx.globalAlpha=this.alpha,this.y+=-t,this.x+=this.ux*t,g_ctx.save();var e=H.sp(this.x||0,this.y||0,!1);g_ctx.translate(e.x,e.y),g_ctx.scale(this.alpha,this.alpha),this["char"].stamp(g_ctx,0,0),g_ctx.restore(),g_ctx.globalAlpha=1}}.bind(this))},Room=function(t,e,n,o){var r=this;r.renderer=new Renderer(ROOM_WIDTH*cw,ROOM_HEIGHT*ch,1),r.type=t,void 0!=t.actions&&(r.actions=t.actions.map(function(t){return{val:t.val,n:t.n,c:{t:t.c.t,b:t.c.b}}})),r.flipped=e,r.id=roomID,r.x=n,r.y=o,r.type.slots&&(r.slots=r.type.slots.map(function(t){return{x:t,npc:void 0,hero:void 0}})),roomID++,e?t.stamp.reverse.stamp(r.renderer.context):t.stamp.stamp.stamp(r.renderer.context),r.tick=function(t){t.last_tick=0,new Particle(r.type.p,t.body.x,t.body.y-1)},r.kill=function(){r.slots.forEach(function(t){void 0!==t.hero&&t.hero.room_action(r),void 0!==t.npc&&t.npc.kill()}),r.renderer.kill(),H.Null(this)},r.update=function(t,e){1!=e.busy&&r.slots?r.slots.forEach(function(t){t.x+this.x*ROOM_WIDTH===Math.floor(e.body.x)&&Math.floor(e.body.y)===13+this.y*ROOM_HEIGHT&&void 0==t.hero&&(t.hero=e,e.slot=t,e.busy=!0,e.room_time=e.last_tick=0,e.total_room_time=H.GR(e.type.turn.b,e.type.turn.t),e.return_velocity=e.body.velocity.x,e.body.velocity.x=0,e.had_a_go=!0)}.bind(this)):(e.room_time+=t,e.last_tick+=t,e.last_tick>e.type.i&&r.tick(e),e.room_time>e.total_room_time&&(r.slots&&r.slots.forEach(function(t){t.hero==e&&(t.hero=void 0)}),e.room_action(r)))}},Renderer=function(t,e,n){var o=this;o.canvas=o.c=document.createElement("canvas"),o.c.width=o.width=t,o.c.height=o.height=e,o.context=o.x=o.c.getContext("2d"),o.x.globalAlpha=o.alpha=n||1,o.x.imageSmoothingEnabled=!1,o.x.fontStyle=FONT,o.whole=!1,this.stamp=function(t,e,n){var r=H.sp(e||0,n||0,o.whole);t.drawImage(o.c,r.x,r.y)},this.flip=function(){H.FlipCanvas(o.c)},this.kill=function(){o.c=null,H.Null(o)}},Sprite=function(t,e,n){var o=this;o.renderer=n,o.x=t,o.y=e,o.body=Physics.createBody(o,t,e,cw,ch),o.stamp=function(t,e,n){o.renderer.stamp(t,e||o.body.x,n||o.body.y)},o.update=function(t){o.body.update(t)},o.kill=function(){o.renderer.kill(),H.Null(o)}},Counter=function(t,e,n){var o=this;o.r=new Renderer(10*cw,ch),o.s=t,o.o=e,o.v=n,o.draw=function(){o.p=o.o[o.v];var t=H.NT(o.p);o.r.x.clearRect(0,0,10*cw,ch),H.T(t,cw+4,ch-1,o.r.x,FONT,"000000"),o.s.stamp(o.r.x)},o.draw(),this.stamp=function(t,e,n){o.o[o.v]!=o.p&&o.draw(),o.r.stamp(t,e,n)}};var heroId=1;Hero=function(t,e,n){var o=this;o.type=n,o.current_floor=1,o.s=new Char(n.x,n.c),o.body=Physics.createBody(o.s,t,e,cw,ch),o.w={type:E.GRWeapon(n.w),d:!0},o.name=N.Random(),o.w.x=t+o.w.type.ox,o.w.y=e+o.w.type.t,o.w.spr=new Char(o.w.type.x,o.w.type.c),o.active=!0,o.experience=[],o.id=heroId,heroId++,o.facing=RIGHT,o.speed=H.GR(100*n.s.b,100*n.s.t)/100,o.body.velocity.x=o.speed,o.lvl=H.WeightedRandom([1==UI.lvl?1:UI.lvl-1,UI.lvl,UI.lvl+1],[.4,1,.5]),o.getXP=function(t){return H.Moultonize(t||o.lvl,1,1e5)},o.exp=function(t){if(t.t>=0)o.experience.push(t),void 0!=t.d&&(o.experience=o.experience.filter(function(e){return void 0===e.d?e:e.t<0&&e.d.name===t.d.name?null:e}));else{var e=o.experience.filter(function(e){return void 0==e.d?null:e.d.name===t.d.name?!0:null});0==e.length&&o.experience.push(t)}},o.getHealth=function(t){return H.Moultonize(t||o.lvl,o.type.health.b,o.type.health.t)},o.levelUp=function(){o.lvl+=1,o.exp({n:1,r:"I levelled up to "+o.lvl,t:4})},o.gc=function(){return o.sum||(o.sum=H.Summarise(o)),o.sum},o.died=function(t){o.exp({n:-5,r:"dead",t:100});for(var e=0;5>e;e++)new Particle(P.BLOOD,o.body.x,o.body.y-1);L.inc(-5*UI.lvl),UI.removeHero(o,"I was killed by "+t+" which I just don't expect in a dungeon experience.")},o.room_action=function(t){if(o.body.velocity.x=o.return_velocity,L.inc(.5),t.type.battle){if(o.slot){if(o.slot.npc){var e=H.G({t:5,b:1},o.slot.npc.effort,o),n=-o.slot.npc.charge();UI.setGold(n);var r=new Char(n.toString(),"FFF566","000000");new Particle(r,o.body.x,o.body.y-1,!0),-1===e&&o.exp({n:1,r:"I had a great fight against "+o.slot.npc.name,t:26}),1===e?o.exp({n:-1,r:"I had a terrible fight against "+o.slot.npc.name,t:22}):o.exp({n:.6,r:"I had an alright fight against "+o.slot.npc.name,t:23}),Math.random()>.85&&o.levelUp(),Math.random()>.99&&o.died(o.slot.npc.name)}else o.exp({n:.5,r:"There was no one to fight in the "+t.type.name.toLowerCase(),t:7});o.slot=void 0}}else{var a=H.RE(t.actions),e=H.G(a.c,a.val,o);UI.setGold(a.val);var n=new Char(a.val.toString(),"FFF566","000000");new Particle(n,o.body.x,o.body.y-1,!0),0===e&&o.exp({n:.6,r:"the prices for "+a.n.toLowerCase()+" were fair",t:51,d:t.type}),1===e&&o.exp({n:1,r:"the "+a.n.toLowerCase()+" were cheap!",t:53,d:t.type}),-1===e&&o.exp({n:-.8,r:"the cost of "+a.n.toLowerCase()+" was expensive.",t:52,d:t.type})}o.busy=o.entertaining=!1,o.had_a_go=!0,o.sum=void 0},o.update=function(t){o.body.update(t),o.s.x=o.body.x,o.s.y=o.body.y,o.uw(t);var e=o.gCR();o.entertaining&&o.cr.update(t,o),e!=o.cr&&o.roomChanged(e)},o.uw=function(t){var e=o.w.type.ox;o.facing==LEFT&&(e=-e),o.w.x=o.body.x+e;var n=o.speed/3*t;o.w.d?o.w.y+=n:o.w.y+=-n,o.w.y>o.body.y+o.w.type.b?(o.w.y=o.body.y+o.w.type.b,o.w.d=!1):o.w.y<o.body.y+o.w.type.t&&(o.w.y=o.body.y+o.w.type.t,o.w.d=!0)},o.roomChanged=function(t){void 0!==o.entertaining&&(o.had_a_go===!0?H.Contains(o.type.faves,o.cr.type.code)&&o.exp({n:1,r:"of the "+o.cr.type.name.toLowerCase(),t:1,d:o.cr.type}):o.exp({n:.4,r:"I didn't get in the "+o.cr.type.name.toLowerCase(),t:-3,d:o.cr.type})),o.had_a_go=!1,o.entertaining=void 0,o.cr=t,void 0!==t&&(H.Contains(o.type.faves,t.type.code)?Math.random()<.98&&(o.entertaining=!0):Math.random()<.7&&(o.entertaining=!0))},o.gCR=function(){var t=o.body.x-UI.sp.x,e=o.body.y-UI.sp.y,n=UI.floors[Math.floor(e/ROOM_HEIGHT)];return void 0!==n?n[Math.floor(t/ROOM_WIDTH)]:void 0},o.turnAround=function(){o.s.renderer.flip(),o.w.spr.renderer.flip(),o.facing==RIGHT?(o.facing=LEFT,o.body.velocity.x=-o.speed):(o.facing=RIGHT,o.body.velocity.x=o.speed)},o.stamp=function(t,e,n){var r,a;void 0!=e&&(r=e+o.w.type.ox),void 0!=n&&(a=n+o.w.type.t),o.s&&o.active&&(o.s.stamp(t,e||o.body.x,n||o.body.y),o.w.spr.stamp(t,r||o.w.x,a||o.w.y))},this.end=function(){o.active=!1,o.s.kill(),o.w.spr.kill(),H.Null(o)}},FONT="16px Courier",STATUS_FONT="13px Courier New",HEADING_FONT="30px Courier New",cw=9,ch=14,ROOM_WIDTH=20,ROOM_HEIGHT=9,WALL="6D7A80",WALL_B="626E72",BOX="FFE9EB",BOX_B="594B54",RIGHT="r",LEFT="l",H={MouseCoords:null,MouseDown:!1,MouseUp:!1,MouseClick:!1,_clicked:!1,Summarise:function(t,e){var n=0,o=0,r="",a=[];UI.floors.forEach(function(t){t.forEach(function(t){void 0!=t?a.push(t):o++})}),t.lvl/10>UI.floors.length/4&&t.experience.push({n:.2,r:"there were not enough floors",t:12}),o+(4*Math.random()-2)>4&&t.experience.push({n:0,r:"there are lots of empty rooms",t:11}),t.type.faves.split("").forEach(function(e){var n=R.get(e);H.InArray(a,n,"type")||t.experience.push({n:0,r:"they didn't have a "+n.name.toLowerCase(),t:10})});var i={p:[],n:[]};if(t.experience.forEach(function(t,e){n+=t.n,t.n>.5?H.InArray(i.p,t.t,"t")||i.p.push(H.RE(["I liked it","it was good","I enjoyed it"])+" because "+t.r):H.InArray(i.n,t.t,"t")||i.n.push(H.RE(["I hated it","it was terrible","I didn't enjoy it"])+" because "+t.r)}),0===t.experience.length)return{r:0,s:"Terrible"};i.p.length>0&&(r+=H.RE(i.p),i.n.length>0&&(r+=" but ")),i.n.length>0&&(r+=H.RE(i.n));var c={r:n/t.experience.length,s:r};return c.r<0&&(c.r=.1),c},G:function(t,e,n){var o=t.b+(t.t-t.b)/2,r=(e-o)/(t.t-o);return r>=n.type.m.t?-1:r<=n.type.m.b?1:0},InArray:function(t,e,n){for(var o=0;o<t.length;o++){var r=t[o];if(n){if(r[n]===e)return!0;if(r===e)return!0}}return!1},T:function(t,e,n,o,r,a,i,c){o.font=r,o.fillStyle="#"+a,o.textAlign=i||"left",o.fillText(t,e,n)},R:function(t,e,n,o,r,a){r.fillStyle="#"+a,r.fillRect(t,e,n,o)},CharToNum:function(t){var e=t.charCodeAt(0)-48;return e>9&&(e-=7),e},DoMath:function(t,e,n){var e=parseInt(e)/MAX_LVL;return Math.floor(parseInt(n)+parseInt(t)*(e*(2-e))*20)},WeightedRandom:function(t,e){for(var n=e.reduce(function(t,e,n,o){return t+e}),o=this.GR(0,n),r=0,a=0;a<t.length;a++)if(r+=e[a],r=+r.toFixed(2),r>=o)return t[a]},NT:function(t){return t>3e3&&(t=Math.floor(t/1e3)+"k"+(t%1e3!==0?"+":"")),t.toString()},HT:function(t,e){return null===t||null===e?!1:t.x>=e.x&&t.x<=e.x+e.width&&t.y>=e.y&&t.y<e.y+e.height?!0:!1},Null:function(t){t=null},Contains:function(t,e){return void 0===t?!1:t.split(e).length>1},RE:function(t){return t[Math.floor(Math.random()*t.length)]},GR:function(t,e){return~~(Math.random()*(e-t))+t},EK:function(t,e){for(var n in t)t.hasOwnProperty(n)&&e(n)},FlipCanvas:function(t){var e=TMP_BUFFER(t.width,t.height),n=e.getContext("2d");n.scale(-1,1),n.drawImage(t,-t.width,0);var o=t.getContext("2d");o.clearRect(0,0,t.width,t.height),o.drawImage(e,0,0)},sp:function(t,e,n){return n||void 0===n?{x:parseInt(t)*cw,y:parseInt(e)*ch}:{x:t*cw,y:e*ch}},Moultonize:function(t,e,n){var o=Math.pow(10,Math.log10(n/e)/10);return e*Math.pow(o,t)},RemoveFromArray:function(t,e,n){if(void 0===t)return t;var o=t.indexOf(e);if(-1===o&&t.forEach(function(t,r){n&&(t[n]===e[n]?o=r:t===e&&(o=r))}),-1!==o)var r=t.splice(o,1);return r},CoordsToBuffer:function(t,e){return{x:Math.floor(t/cw),y:Math.floor(e/ch)}},GenerateStamp:function(t){var e=new Renderer(t.w*cw,t.h*ch),n=new Renderer(t.w*cw,t.h*ch);return this.StampSprite(e.context,0,0,t),n.context.scale(-1,1),this.StampSprite(n.context,-20,0,t),{original:e,reverse:n}},GenerateStamps:function(){for(var t in S)if(S.hasOwnProperty(t)){var e=this.GenerateStamp(S[t]);S[t].stamp=e.original,S[t].reverse=e.reverse,R.hasOwnProperty(t)&&void 0!==R[t].actions&&R[t].actions.forEach(function(t,e){t.val=t.c.b+(t.c.t-t.c.b)/2})}},StampSprite:function(t,e,n,o){for(var r=o.d.split(""),a=o.p.split(" "),i=0;i<o.w;i++)for(var c=0;c<o.h;c++){var s=c*o.w*3+3*i,l=new Char(r[s],a[this.CharToNum(r[s+1])],a[this.CharToNum(r[s+2])]);l.stamp(t,e+i,n+c)}}};var buffer=document.createElement("canvas");TMP_BUFFER=function(t,e){return buffer.width=t,buffer.height=e,buffer.getContext("2d").clearRect(0,0,buffer.width,buffer.height),buffer.getContext("2d").setTransform(1,0,0,1,0,0),buffer},GAME=document.createElement("canvas"),P={randomSolid:function(){return H.RE(this.SOLID_TILES)},SOLID_TILES:[new Char("∵","84596F","594B54"),new Char("#","84596F","594B54"),new Char("*","84596F","594B54")],BLOOD:new Char("∵","FF0000"),BOX_MD:new Char(" ",BOX,BOX_B),HEALTH:new Char("+","00ff00"),DRINK:new Char("¡","B85456"),X:new Char("X","CF3267"),XX:new Char("x","D98D8D"),XXX:new Char("⧜","D87093"),DRINK2:new Char("#","F1D67D"),HOLY:new Char("†","3CD9BC"),HOLY2:new Char("†","F2A777"),FLOOR:new Char("┈","63545E","302222"),OFF_FLOOR:new Char("┈","3b3539","302222"),GOLD:new Char("●","FFE545"),B_STAR:new Char("☆","490A3D"),STAR:new Char("★","E97F02"),FIGHT:new Char("⤧","FF0066"),FIGHT2:new Char("⩓","73E9CF"),FIGHT3:new Char("⨳","C6FC50"),VOID:new Char(" ","302222","302222"),CHAT_1:new Char("⩹","D7F6FC"),CHAT_2:new Char("⩺","FECE98"),BULLET:new Char("•","FFAAFF"),BULLET2:new Char("⧂","B4B6A8")},A={a:"63545E ",b:"302222 "},S={ARENA:{p:A.a+A.b+"8D7F47 584034 D7B575 A23B3E C57155",d:"═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01╦01░31░31░31◼51░31○61░31©61░31@51░31Ⓢ61░31©51░31Ω51░31░31░31║01░31░31╒23═23═23═23═23═23═23═23═23═23═23═23═23═23╕23░31░31║01░31░31╰23─23─23─23─23─23─23─23─23─23─23─23─23─23╯23░31░31║01░31@61░31░31░31░31░31Ⓢ61░31░31░31░31Ω51░31░31░31@51░31░31░31╒23═23═23╕23░21╒23═23═23╕23░21╒23═23═23╕23░21╒23═23═23╕23░21╰23─23─23╯23░21╰23─23─23╯23░21╰23─23─23╯23░21╰23─23─23╯23░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21░21┉21┄21┈21┉21┄21┉21┉21┈21┉21┅21┈21┉21┉21┉21┉21┉21┅21┉21┄21┉21",w:20,h:9},SHOP:{p:A.a+A.b+"665950 739C8A 0A4F6B FF7867 FFAE75 FEFFE6 B8D6B1",d:"═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01╦01 01✠61 01⧍81 01⨭71 01♪51 01 01 01⫏51 01⫯81 01⥿71 01⏢81 01║01 01┈01┈01┈01┈01┈01┈01┈01 01 01 01┈01┈01┈01┈01┈01┈01┈01 01║01 01⊷81 01≦51 01∑81 01Å61 01 01 01φ71 01ϖ61 01«81 01*61 01║01 01┈01┈01┈01┈01┈01┈01┈01 01 01 01┈01┈01┈01┈01┈01┈01┈01 01 01 01┌23─23┬23─23┬23─23┐23 01○01 01┌23─23┬23─23┬23─23┐23 01 01 01│23▽64│23℗64│23⊞84│23{01⥉01}01│23★64│23◱54│23⌖74│23 01 01┏12┷12━12┷12━12┷12━12┷12━12━12━12┷12━12┷12━12┷12━12┷12┓12 01┸12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12╌12┸12╌01",w:20,h:9},BROTHEL:{p:A.a+A.b+"83AF9B C8C8A9 FE4365 F9CDAD",d:"═01═01╦01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01╤01 01 01║51▓41▓41 01 01◆01 01 01 01 01 01 01 01 01 01 01 01╎01 01 01║51▓41▓41 01 01▢01 01 01 01 01┌01╍01╍01┐01 01▤31▤31╎01 01 01╚51═51═51═51═51═51 01 01╔51═51╧51═51═51╧51═51═51═51╡01 01 01 01 01 01 01 01 01 01╔51╝51 01 01 01 01 01 01 01 01╎01 01 01─01─01─01╮01 01 01╔51╝51 01 01 01 01─01─01─01╮01 01 01 01 21░21░21░21╽01 01╔51╝51 01 01 01 01 31▒31▒31▒31╽01 01 01 01 21░21░21░21┃01 01╝51▗41▄41▄41▟41 01 31▒31▒31▒31┃01 01 01┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41┉41",w:20,h:9},HOSPITAL:{p:A.a+A.b+"998D2D FEF441 493B23 383636 D20000 B4D645 F8F7F1 392929",d:"═01╤04═04═04═04╤04═01╤04═04═04═04╤04═01╤04═04═04═04╤04═01╗01 01╧34═32═32═32╧34 01╧34═32═32═32╧34 01╧34═32═32═32╧34 01║01◼91 01◼04 04◼04 01◼91 01◼04 04◼04 01◼91 01◼04 04◼04 01◼91║01 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01║01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91║01 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01◼91 01 01 01⩴85⟿65 01○01 01⩴85⟿75 01○01 01⩴85⟿75 01○01 01⩴85⟿65 01○01 01▗01▄01▟01|01 01▗01▄01▟01|01 01▗01▄01▟01|01 01▗01▄01▟01|01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01┅01",w:20,h:9},ENTRANCE:{p:A.a+A.b+"C3F83C 493B23 998D2D FEF441",d:"═01╦01═01═01═01╦01═01═01═01╦01═01═01═01╦01═01═01═01═01═01╦01░01╎01░01░01░01╎01░01░01░01╎01░01░01░01╎01░01░01░01░01░01║01░03◌54░03░01░01╎01░01░01░01╎01░01░01░01╎01░01░01░01░01░01║01░01░03░01░01░03◌54░03░01░01╎01░01░01░01╎01░01░01░01░01░01║01░01░01░01░01░01░03░01░01░03◌54░03░01░01╎01░01░01░01░01░01║01░01░01░01░01░01░01░01░01░01░03░01░01░03◌54░03░01░01░01░01║01░01░01░01░01░01░01░01░01░01░01░01░01░01░03░01░01░01░01░01 01░01░01░01◬21░01░01░01◬21░01░01░01◬21░01░01░01◬21░01░01░01 01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01┈01",w:20,h:9},CHURCH:{p:A.a+A.b+"62533E F9DC90 FFF64F FF9999 C79C00",d:"═01═01═01═01═01═01╦01═01═01═01═01═01╦01═01═01═01═01═01═01╦01 01 01 01 01 01 01╹01 01 01 01 01 01╹01 01 01 01 01 01 01║01 01┌32─32─32┐32 01 01 01 01╻41 01 01 01 01┌32─32─32┐32 01║01 01│32#52)52│32 01 01 01━41╋41━41 01 01 01│32(52%52│32 01║01 01└32─32─32┘32 01 01 01 01┃41 01 01 01 01└32─32─32┘32 01║01 01 01 01 01 01 01 01 01 01╹41 01 01 01 01 01 01 01 01 01║01 01◯61 01●61 01◯61 01 01 01●61 01 01 01◯61 01●61 01◯61 01 01 01╹31 01╹31 01╹31 01┏32━32┻32━32┓32 01╹31 01╹31 01╹31 01 01┈31┈31┈31┈31┈31┈31┈31┻31╍31╍31╍31┻31┈31┈31┈31┈31┈31┈31┈31┈31",w:20,h:9},SEWER:{p:A.a+A.b+"9AE2A8 374332 58442C 794425 FEF441",d:"═01═01═01═01═01═01═01═01═01═01═01═01═01┉01═01═01═01═01═01╤01▙01 01 01 01 01 01 01 01◌51 01 01 01 01◜51◝51 01 01 01▜01│01 01 01 01◎16 01 01 01 01▒21 01 01 01 01◟51◞51 01 01◎16 01│01 01 01 01▼51 01 01 01 01▒21 01◉06 01 01▗01 01 01 01▼51 01│01 01 01▞01 01 01 01 01 01░21 01 01 01 01 01▚01 01▞01 01 01┆01 01▞01 01 01 01 01 01 01░21 01 01 01 01 01 01▛01 01 01 01 01 01 01 01 01 01 01 01 01░21 01 01 01 01 01▞01 01 01 01 01 01 01 01 01 01 01 01 01 01◒21 01 01 01 01 01 01 01 01 01 01 01┄01┅01┄01┉01┅01┉01┄01┉01┄01┉01┅01┈01┄01┉01┅01┉01┄01┉01┉01┈01",w:20,h:9},INN:{p:A.a+A.b+"604B38 DCC091 C79C00 493B23 E3DA4B E13B3B 34DBB2 6D2A24 987C57 88553B",d:"═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01╦01 01 01 32T32Ħ32Ę32 32 32Đ32Ů32Ň32Ğ32Ē32ī32Ň32Ŋ32 32 01 01║01 01╔01═01═01═01═01╗01 01 01 05 01 01 01 01 01 01 01 05 01║01 01║01 01 01◎01 01║01 01 05●45 05 01 01 01 01 01 05●45 05║01 01║01 01 01◎01 01║01 01 01╹45 01 01 01 01 01 01 01╹45 01║01 01╚01═01═01═01═01╝01 01 01 01 01 01 01 01○01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01◮61◊71◬81{01⥉01}01 01 01☎71 01 01┬A1─A1─A1┬A1 01┌A1┤A1 01┌A9┴A9┴A9┴A9─A9─A9─A9─A9─A9┐A9 01┈01┴A1┈01┈01┴A1┈01┴A1┴A1┈01┴A9┈A9┈A9┈A9┈A9┈A9┈A9┈A9┈A9┴A9┈01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01",w:20,h:9},LAIR:{p:A.a+A.b+"A88474 BAB15D 859C84",d:"═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01═01╦01 01 01 01●31 01 01 01●31 01 01 01●31 01 01 01●31 01 01 01║01 01●31 01 01 01●31 01 01 01●31 01 01 01●31 01 01 01●31 01║01 01 01 01●31 01 01 01●31 01 01 01●31 01 01 01●31 01 01 01║01 01●31 01 01 01●31 01 01 01●31 01▙21 01●31 01 01 01●31 01║01 01 01 01●31 01 01 01●31 01▟21█21█21▙21 01 01●31 01 01 01║01 01░31░31░31▒01▒01▒01▟21█21█21█21█21█21▙21▒01▒01▒01░31 01 01░31░31▒01▒01▒01▒01▟21█21█21█21█21█21█21█21█21▙21▒01▒01░31 01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01┉01",w:20,h:9},OUTDOOR:{p:"2CA9AD 25989B ADDADE D5D0CD 9BC560 BFBBB8 837E7B FFFFFF",d:" 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11╱71╲71 11 11 11 11 11 11 11 11 11 11 11╱31 33 33╲31╱31╲31 11 11 11 11 11 11 11╱51 55 55 55 55 55 55╲51 11 11 11 11 11╱61 66 66 66 66 66 66 66 66 66╲61 11╥41 11",w:14,h:5},ADD_ROOM:{p:A.a+A.b,d:"┌01 01 01 01 01 01┐01 01 01 01│01 01 01 01 01─01─01┼01─01─01 01 01 01 01│01 01 01 01└01 01 01 01 01 01┘01",w:7,h:5}},R={CHURCH:{name:"Church",code:"c",cost:60,stamp:S.CHURCH,p:[P.HOLY,P.HOLY2],slots:[4,8,10,12,16],actions:[{n:"Prayers",c:{t:14,b:2}},{n:"Confessions",c:{t:20,b:4}}],l:1},SEWER:{name:"Sewer",code:"s",slots:[3,7,12,17],battle:!0,enemies:"rs",cost:120,stamp:S.SEWER,p:P.FIGHT,l:1},INN:{name:"Inn",p:[P.DRINK,P.DRINK2],code:"i",slots:[3,9,14,16,18],actions:[{n:"Drinks",c:{t:18,b:12}},{n:"Eats",c:{t:23,b:13}}],cost:220,stamp:S.INN,l:2},ARENA:{name:"Arena",code:"a",slots:[4,9,14,18],enemies:"wc",battle:!0,cost:360,p:[P.FIGHT,P.FIGHT2],stamp:S.ARENA,l:3},HOSPITAL:{name:"Hospital",p:P.HEALTH,code:"h",slots:[4,9,14,19],actions:[{n:"Nurses",c:{t:32,b:24}},{n:"Doctors",c:{t:40,b:28}}],cost:450,stamp:S.HOSPITAL,l:4},SHOP:{name:"Shop",p:[P.BULLET,P.BULLET2],code:"x",slots:[4,8,12,16,20],actions:[{n:"Weapons",c:{t:32,b:18}},{n:"Armour",c:{t:34,b:22}},{n:"Items",c:{t:40,b:20}}],cost:600,stamp:S.SHOP,l:5},BROTHEL:{name:"Brothel",p:[P.X,P.XX,P.XXX],code:"b",slots:[5,11,18],actions:[{n:"Kisses",c:{t:50,b:30}},{n:"Hugs",c:{t:58,b:36}},{n:"Cuddles",c:{t:66,b:28}}],cost:900,stamp:S.BROTHEL,l:7},LAIR:{name:"Lair",code:"l",slots:[4,8,12,16],battle:!0,enemies:"di",cost:999,stamp:S.LAIR,p:[P.FIGHT,P.FIGHT2,P.FIGHT3,P.BULLET],l:7},ENTRANCE:{name:"Entrance",code:"e",actions:[{n:"Nibbles",c:{t:12,b:2}},{n:"Introductions",c:{t:10,b:0}}],slots:[3,6,9,12,15,18],cost:100,p:[P.CHAT_1,P.CHAT_2],stamp:S.ENTRANCE,l:100},random:function(){return R[H.RE(this.all())]},get:function(t){var e;return H.EK(R,function(n){R[n].code==t&&(e=R[n])}),e},all:function(){var t=[];return H.EK(R,function(e){"random"!=e&&"all"!=e&&"get"!=e&&t.push(e)}),t}},L={xp:0,boundaries:[0,3,10,25,40,100,200,450,700,1200],inc:function(t){t?this.xp+=t:this.xp++;var e=this.boundaries.reduce(function(t,e,n){return this.xp>10*e?n:t}.bind(this));UI.lvl<e+1&&UI.setGold(10*Math.pow(e+1,1.5)),UI.lvl=e+1}},N={names:"Tom Brian Bob Tim Lorna Jess Toby Simon Ed Joao Alan Neil Pete Fred Marge Sully Terry Eric Bill Carol Chris Dan Holly Jenny Jonathan Serj Pele Jerry Robin Pip Roz Merry Brad Ross Ralph Ian Henry Lloyd John Tarquin Ann Lily Alex Julia Sarah Nigel Kristie Paul",Random:function(){return H.RE(this.names.split(" "))}},E={weapons:[{x:"}",code:"s",c:"00FF00",ox:.6,t:-.5,b:-.35},{x:"∤",code:"ls",c:"A7FBEB",ox:.7,t:-.45,b:-.2},{x:">",code:"sa",c:"4072DA",ox:.8,t:-.4,b:-.3},{x:"⦔",code:"bw",c:"FA8FC2",ox:.8,t:-.4,b:-.3},{x:"†",code:"cf",c:"86D5FA",ox:.8,t:-.4,b:-.3},{x:"⊸",code:"wd",c:"EEAE23",ox:.8,t:-.4,b:-.3},{x:"∣",code:"st",c:"D1CBDA",ox:.8,t:-.4,b:-.3},{x:"†",code:"kn",c:"D3E373",ox:.8,t:-.4,b:-.3},{x:"∝",code:"lt",c:"0176F4",ox:.8,t:-.4,b:-.3}],heroes:[{name:"Knight",faves:"hxlei",turn:{t:9,b:5},fee:31,i:.5,x:"$",l:{t:10,b:5},w:"ls s",s:{t:2.5,b:1.3},c:"F0DDD2",m:{t:.8,b:-.1}},{name:"Peon",faves:"sce",turn:{t:20,b:10},fee:3,i:.3,x:"K",l:{t:6,b:0},w:"s kn sa",s:{t:2.5,b:1.8},c:"8FAF8E",m:{t:.2,b:-.4}},{name:"Dwarf",faves:"shil",turn:{t:15,b:8},x:"D",l:{t:9,b:5},w:"sa",s:{t:2,b:1.7},fee:32,i:.9,c:"8FAF8E",m:{t:.3,b:-.6}},{name:"Priest",faves:"csi",turn:{t:18,b:8},fee:8,i:.4,x:"δ",l:{t:6,b:2},w:"cf",s:{t:2.1,b:1.6},c:"8BE1BC",m:{t:.2,b:-.7}},{name:"Mage",faves:"isxhl",turn:{t:11,b:4},fee:36,i:.6,x:"Î",l:{t:9,b:5},w:"st wd",s:{t:2.1,b:1.6},c:"3B9FB6",m:{t:.5,b:-.2}},{name:"Rogue",faves:"slihcb",turn:{t:20,b:10},fee:39,i:.8,x:"∱",l:{t:10,b:5},w:"kn s",s:{t:3.1,b:1.9},c:"ADD8C7",m:{t:.9,b:-.6}},{name:"Archer",faves:"halxc",turn:{t:21,b:7},fee:42,i:.9,x:"∔",l:{t:10,b:6},w:"bw",s:{t:3.9,b:1.8},c:"D7B9DC",m:{t:.7,b:0}},{name:"Muse",faves:"ihcxlab",turn:{t:6,b:1},fee:42,i:.6,x:"♭",l:{t:10,b:6},w:"lt",s:{t:1.1,b:.6},c:"BD0628",m:{t:.1,b:-.6}},{name:"Hellbeast",faves:"ecsaixhbl",turn:{t:1,b:1},fee:80,i:1,x:"H",l:{t:10,b:8},w:"s kn lt",s:{t:11,b:8},c:"E491A1",m:{t:1,b:.5}}],enemies:[{name:"Rat",code:"r",symbol:"%",color:"C2B49A",cost:{t:50,b:12},rate:{t:15,b:4}},{name:"Skeleton",code:"s",symbol:"⥉",color:"C6E5D9",cost:{t:60,b:26},rate:{t:10,b:4}},{name:"Warrior",code:"w",symbol:"¥",color:"F5F2E8",cost:{t:99,b:40},rate:{t:120,b:40}},{name:"Champ",code:"c",symbol:"⨳",color:"ACA287",cost:{t:90,b:34},rate:{t:140,b:40}},{name:"Dragon",code:"d",symbol:"&",color:"FF0000",cost:{t:390,b:190},rate:{t:190,b:100}},{name:"Imp",code:"i",symbol:"?",color:"EE1111",cost:{t:290,b:150},rate:{t:210,b:120}}],GetEnemy:function(t){var e;return this.enemies.forEach(function(n){n.code==t&&(e=n)}),e},GW:function(t){var e;return this.weapons.forEach(function(n){n.code==t&&(e=n)}),e},GRWeapon:function(t){return this.GW(H.RE(t.split(" ")))},GRHero:function(t){var e=[];return this.heroes.forEach(function(n){n.l.b<=t&&e.push(n)}),new Hero(UI.sp.x,UI.sp.y,H.RE(e))}},GAME.addEventListener("click",function(t){H.MouseCoords=getMousePos(GAME,t),H.MouseClick=!0});var t=UI={renderer:null,gold:180,lvl:1,w:null,h:null,floors:[[void 0,void 0,void 0,void 0]],max_rooms:4,max_floors:1,change:!1,clouds:[],spawn_counter:0,sw:0,sp:{x:0,y:13.5},heroes:[],num_heroes:0,bg:null,fg:null,ctx:null,afb:new Button("Add Floor",function(){UI.addFloor()},1,1,80),statuses:[],counters:[],bs:[],rb:[],changed:!1,offset:0,r_total:0,r_count:0,init:function(e){t.ctx=e,t.w=Math.floor(GAME.width/cw),t.h=Math.floor(GAME.height/ch),t.renderer=new Renderer(GAME.width,GAME.height,1),t.bg=new Renderer(GAME.width,GAME.height,1),t.fg=new Renderer(GAME.width,GAME.height,1),t.rating=new StarRating,t.p=new Renderer(28*cw,20*ch,1);for(var n=0;n<t.w;n++){if(Math.random()>.9){var o=new Sprite(n,H.GR(1,3),new Char("@","FFFFFF",void 0,.2));o.body.velocity.x=1,t.clouds.push(o)}n%14===0&&Math.random()>.5&&n>20&&S.OUTDOOR.stamp.stamp(t.bg.x,n,0);for(var r=0;r<t.h;r++)r>4&&(n>t.w-31&&n<t.w-2&&r>5&&r<t.h-1?24==r?P.randomSolid().stamp(t.bg.x,n,r):P.BOX_MD.stamp(t.bg.x,n,r):2>n||n>t.w-33||6>r?P.randomSolid().stamp(t.fg.x,n,r):r%ROOM_HEIGHT==5?Math.ceil(r/ROOM_HEIGHT)-1>t.floors.length?P.OFF_FLOOR.stamp(t.bg.x,n,r):P.FLOOR.stamp(t.bg.x,n,r):r==t.h-1?P.randomSolid().stamp(t.bg.x,n,r):P.VOID.stamp(t.bg.x,n,r))}t.bg.x.font=HEADING_FONT,t.bg.x.strokeStyle="white",t.bg.x.lineWidth=5,t.bg.x.strokeText("dungeon",10,34),t.bg.x.fillText("dungeon",10,34),t.bg.x.fillStyle="#579441",t.bg.x.strokeText("advisor",135,34),t.bg.x.fillText("advisor",135,34),t.renderer.stamp(e),t.afb.y=10+t.floors.length*ROOM_HEIGHT,t.afb.x=(t.w-29)/2-8,t.counters.push(new Counter(P.GOLD,t,"gold")),t.counters.push(new Counter(new Char("#","FA6728"),t,"num_heroes")),t.counters.push(new Counter(new Char("✓","C3FF68"),t,"lvl")),t.pb=new Button("◼",function(){TIME=0},0,3.2),t.cb=new Button("▸",function(){TIME=1},0,3.2),t.bb=new Button("Bribe",function(){for(var t=0;t<H.GR(10,60);t++)UI.spawnHero();UI.r_total=UI.r_count=UI.rating.i=0,UI.rating.setNum(0),UI.setGold(-2e4)},100,3.2,2e4),t.addRoom(R.ENTRANCE)},addFloor:function(){if(t.gold>=80){for(t.floors.push([void 0,void 0,void 0,void 0]),t.setGold(-80),x=2;x<t.w-32;x++)P.FLOOR.stamp(t.bg.x,x,(t.floors.length+1)*ROOM_HEIGHT-4);t.afb.y+=ROOM_HEIGHT}},addStatus:function(e,n,o){var r=[];r.push(new StatusUpdate(e,n,o)),t.statuses.forEach(function(t){r.push(t)}),r.length>4&&r.pop().kill(),t.statuses=r},addRoom:function(e,n){return L.inc(),void 0===n?(t.floors[0][0]=new Room(e,!1,0,0),t.floors[0][0]):void 0!==t.floors[n.y]?(t.floors[n.y][n.x]=new Room(e,n.y%2==1,n.x,n.y),t.floors[n.y][n.x]):void 0},spawnHero:function(){var e=E.GRHero(t.lvl);t.heroes.push(e),t.num_heroes=t.heroes.length,t.setGold(e.type.fee)},removeHero:function(e,n){var o=H.Summarise(e);t.r_total+=o.r,t.r_count+=1,t.rating.increment(),t.rating.setNum(t.r_total/t.r_count*5),n&&(o.s=n),t.addStatus(e,(5*o.r).toFixed(1)+" ★'s from "+e.name,o.s),t.sh&&t.sh.id==e.id&&(t.sh=void 0),H.RemoveFromArray(t.heroes,e,"id"),e.end(),H.Null(e),L.inc(5*o.r),t.num_heroes=t.heroes.length},_clicked:!1,update:function(e){if(0==TIME?t.cb.update(e):t.pb.update(e),t.offset+=5*e,t.r_count>0&&t.bb.update(e),t.changed&&(void 0!==t.sh?t.setSelection(t.sh,!0):t.setSelection(t.sr)),t.changed=!1,t.clouds.forEach(function(n,o){n.update(e),n.body.x>t.w+2&&(n.body.x=-1)}.bind(t)),t.spawn_counter+=e,t.spawn_counter>t.sw){t.spawn_counter=0;var n=t.lvl-Math.random();t.sw=H.GR(10-n,10-n+Math.random()*(10-n)),t.spawnHero()}t.heroes.forEach(function(n){n.update(e),n.s.x<t.w-32?n.s.x<t.sp.x-2&&(n.current_floor<t.floors.length?t.flipHero(n):t.removeHero(n)):n.current_floor<t.floors.length?t.flipHero(n):t.removeHero(n)}.bind(t)),void 0!==t.k&&t.k.update(e),H.MouseClick&&(t.floors.forEach(function(e,n){e.forEach(function(e,o){if(H.HT(H.MouseCoords,{x:(2+o*ROOM_WIDTH)*cw,y:(6+n*ROOM_HEIGHT)*ch,width:ROOM_WIDTH*cw,height:ROOM_HEIGHT*ch})){var r=!1;e&&t.sr&&t.sr.id==e.id&&(r=!0),r?t.sr=void 0:t.setSelection(e||{x:o,y:n,found:!1})}}.bind(t))}.bind(t)),t.heroes.forEach(function(e){H.HT(H.MouseCoords,{x:e.body.x*cw,y:e.body.y*ch,width:cw,height:ch})&&t.setSelection(e,!0)}.bind(t))),void 0!==t.sr&&t.sr.found===!1&&t.rb.forEach(function(t){t.update(e)}),t.bs.forEach(function(t){t.update(e)}),UI.SR()&&t.afb.update(e)},SR:function(){var t=UI.lvl,e=UI.floors.length,n=!1;return t>1&&2>e&&(n=!0),t>3&&3>e&&(n=!0),t>6&&4>e&&(n=!0),t>8&&(n=!0),n},cPs:function(){t.p.x.clearRect(0,0,t.p.canvas.width,t.p.canvas.height),t.bs.forEach(function(t){t.kill()}),t.bs=[]},setSelection:function(e,n){if(t.sh=t.sr=t.k=void 0,t.cPs(),n){var o=t.sh=e,r=new Avatar(o);r.stamp(t.p.x,.5,.5),r.kill(),H.Null(r),H.T(o.name+" (lvl "+o.lvl+" "+o.type.name+")",34,12+ch,t.p.x,FONT,"F8BC10");var a=o.gc(),i=new TypeWriter(a.s,22,200,!1,FONT);i.arr.forEach(function(e){H.T(e.c,e.x+34,e.y+35,t.p.x,FONT,"FFFFFF")})}else if(t.sr=e,void 0!==t.sr)if(t.sr.found===!1){H.T("Rooms",10,18,t.p.x,FONT,"F8BC10");var c=1;R.all().forEach(function(e){if("ENTRANCE"!=e){var n=R[e];if(H.T(n.name,10,18+1.8*ch*c,t.p.x,FONT,"FFFFFF"),n.l<=UI.lvl){var o=new Button("Add",function(t){var e=UI.addRoom(R[t],UI.sr);UI.gold+=-e.type.cost,UI.setSelection(e)},t.w-30+16,6+1.8*c,n.cost,e);t.bs.push(o),o.stamp(t.p.x,16,1.8*c)}else H.T("need lvl "+n.l,144,18+1.8*ch*c,t.p.x,FONT,"FF4444");c++}}.bind(t))}else if(e.type){if(H.T(e.type.name,10,18,t.p.x,FONT,"F8BC10"),e.type.battle){e.slots.forEach(function(n,o){if(n.npc){var r=new Avatar(n.npc.c,!0);H.T(n.npc.name+" ("+n.npc.type.name+")",36,40+1.8*ch*(2*o),t.p.x,FONT,"FFFFFF"),r.stamp(t.p.x,0,1.7+2*o*1.8),H.Null(r);for(var a=0;5>a;a++){var i="☆";a<n.npc.effort&&(i="★");var c=new Button(i,function(t){t.n.effort=t.v+1,UI.setSelection(UI.sr)},t.w-30+4+2.8*a,7.5+1.8*(2*o+1.1),void 0,{v:a,n:n.npc});t.bs.push(c),c.stamp(t.p.x,4+2.8*a,1.5+1.8*(2*o+1.1))}var s=new Button("X",function(e){e.s.npc.kill(),e.s.npc=void 0;for(var n=e.i;n<e.r.slots.length;n++){var o=e.r.slots[n];void 0!==o.npc&&(e.r.slots[n-1].npc=o.npc,
e.r.slots[n].npc=void 0)}t.changed=!0},t.w-5.5,7.5+2*o*1.8,void 0,{s:n,i:o,r:e},!0);s.stamp(t.p.x,24.5,1.5+2*o*1.8),t.bs.push(s),P.GOLD.stamp(t.p.x,19.2,2*o*1.8+3.7),H.T(n.npc.charge()+"",187,40+1.8*ch*(2*o+1),t.p.x,FONT,"BFBBB8")}else H.T("empty",36,40+1.8*ch*(2*o),t.p.x,FONT,"EDEDED")});var i=0,o=0;e.type.enemies.split("").forEach(function(n,r){var a=E.GetEnemy(n),c=!1,s=Math.floor(H.Moultonize(UI.lvl,a.cost.b,a.cost.t)),l=new Button(a.name,function(e){e.r.slots.forEach(function(t,n){void 0!=t.npc||c||(c=!0,t.npc=new Enemy(a,t,e.r),UI.setGold(-e.c))}),t.changed=!0},t.w-30+i,6+1.8*(2*e.slots.length+1+o),s,{e:a,r:e,c:s});t.bs.push(l),l.stamp(t.p.x,0+i,1.8*(2*e.slots.length+1+o)),i+=l.r.width/cw,i>17&&(o++,i=0)})}else e.actions&&(P.GOLD.stamp(t.p.x,22,.4),e.actions.forEach(function(n,o){o+=1,H.T(n.n,10,18+1.8*ch*o,t.p.x,FONT,"FFFFFF"),H.T(n.val,202,18+1.8*ch*o,t.p.x,FONT,"FFFFFF","center"),t.createStepper(e,t,n,o)}));"Entrance"!=e.type.name&&(t.k=new Button("Remove",function(t){t.kill(),UI.floors[t.y][t.x]=UI.sr=void 0,UI.changed=!0},7+e.x*ROOM_WIDTH,6.5+e.y*ROOM_HEIGHT,void 0,e,!0))}},createStepper:function(t,e,n,o){var r=new Button("↑",function(t){t.a.val+=1,UI.setSelection(t.r)},e.w-30+17,6+1.8*o,void 0,{r:t,a:n}),a=new Button("↓",function(t){t.a.val+=-1,UI.setSelection(t.r)},e.w-30+24,6+1.8*o,void 0,{r:t,a:n});n.val!==n.c.t&&(e.bs.push(r),r.stamp(e.p.x,17,1.8*o)),n.val!==n.c.b&&(e.bs.push(a),a.stamp(e.p.x,24.5,1.8*o))},setGold:function(e){t.gold+=Math.floor(e),t.changed=!0},flipHero:function(t){return void 0===t.current_floor?t.current_floor=1:t.current_floor+=1,t.body.y+=ROOM_HEIGHT,t.turnAround(),t},drawSelection:function(e,n,o,r,a){e.strokeStyle="#25989B",e.lineWidth=2,e.setLineDash([4,2]),e.lineDashOffset=-t.offset,e.strokeRect(n*cw,o*ch,r*cw,a*ch)},draw:function(){var e=t.renderer.x;e.clearRect(0,0,GAME.width,GAME.height),t.bg.stamp(e),t.clouds.forEach(function(t,n){t.stamp(e)}),t.floors.forEach(function(t,n){t.forEach(function(t,o){void 0!==t?(t.renderer.stamp(e,2+o*ROOM_WIDTH,6+n*ROOM_HEIGHT),t.slots&&t.slots.forEach(function(t){void 0!=t&&t.npc&&t.npc.c.stamp(e,2+o*ROOM_WIDTH+t.x,6+n*ROOM_HEIGHT+7.6)})):S.ADD_ROOM.stamp.stamp(e,o*ROOM_WIDTH+8,n*ROOM_HEIGHT+8)})}),t.heroes.forEach(function(t){t.stamp(e)});var n=0;t.statuses.forEach(function(o){o.stamp(e,t.w-29,25.5+n),n+=o.height}.bind(t)),t.p.stamp(e,t.w-30,6),t.counters.forEach(function(t,n){2==n&&(n=1.8),t.stamp(e,6+8*n,3.6)}.bind(t)),UI.SR()&&t.afb.stamp(e),t.fg.stamp(e),t.rating.stamp(e,26,3.6),0!=TIME?t.pb.stamp(e):t.cb.stamp(e),t.r_count>0&&t.bb.stamp(e),void 0!==t.sr?t.drawSelection(e,2+t.sr.x*ROOM_WIDTH,6+t.sr.y*ROOM_HEIGHT,ROOM_WIDTH,ROOM_HEIGHT):void 0!==t.sh&&(t.sh.facing==RIGHT?t.drawSelection(e,t.sh.body.x-.2,t.sh.body.y-.3,1.8,1.6):t.drawSelection(e,t.sh.body.x-.8,t.sh.body.y-.3,1.8,1.6)),void 0!==t.k&&t.k.stamp(e),t.renderer.stamp(g_ctx)}},map=document.createElement("canvas");GAME.width=map.width=1026,GAME.height=map.height=602,TIME=1,ACTIVE=!0,window.addEventListener("focus",function(){ACTIVE=!0}),window.addEventListener("blur",function(){ACTIVE=!1}),document.body.appendChild(GAME),g_ctx=GAME.getContext("2d"),m_ctx=map.getContext("2d"),g_ctx.imageSmoothingEnabled=m_ctx.imageSmoothingEnabled=!1,H.GenerateStamps(),UI.init(m_ctx),CALLBACKS=new Array;var c_id=0;PUSH_CALLBACK=function(t){return c_id++,CALLBACKS.push({f:t,i:c_id}),{f:t,i:c_id}},POP_CALLBACK=function(t){H.RemoveFromArray(CALLBACKS,t,"i")};var last_stamp=0;window.requestAnimationFrame(update);