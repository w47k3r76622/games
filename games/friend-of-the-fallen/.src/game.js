var player,x=window.innerWidth,y=window.innerHeight,step=x>y?.05*y:.05*x,BIHENASO={maxScore:0};localStorage.getItem("BIHENASO")||localStorage.setItem("BIHENASO",JSON.stringify(BIHENASO));var line,back,replay,scoreText,screenText,maxScoreText,bricks=[],lineOn=!1,maxScoreOn=!1,container={x:0,y:0,width:x,height:y},score=0,screen=1,itemID=0,lsObj=JSON.parse(localStorage.getItem("BIHENASO")),maxScore=lsObj.maxScore,instr=["To play click falling square","and line to blue square.","To see high score click falling square","and line to green square.","Wait for grey squares","to turn 90 degrees.","If you want to stop its turn,","just click the screen.","These will help you","while playing."],instrText=[],xSpace=x-18*step>=0?(x-18*step)/2:0;function slideScreen(){line&&(line.beginY+=y/3,line.endY+=y/3),player.y+=y/3,bricks=bricks.filter(function(t){return!(t.y>.67*y)&&(t.y+=y/3,!0)});for(var t=0;t<3;t++){var e,i=utilGenerateLoc(bricks);e=i?new itemRect(1.5*step,1.5*step,i.x,i.y,"#000000","brick"):new itemRect(1.5*step,1.5*step,randomInt(1.5*step,x-1.5*step),randomInt(step,y-step),"#000000","brick"),bricks.push(e)}}function startGame(t=0){if(gameScreen.start(t),0==t){player=new itemRect(1.5*step,1.5*step,.5*x,.5*y,"#555555"),bricks[0]=new itemRect(1.5*step,1.5*step,.3*x,.4*y,"#555555","enemy",-1),bricks[1]=new itemRect(1.5*step,1.5*step,.7*x,.4*y,"#555555","enemy",1),bricks[0].stat="h",bricks[1].stat="p",screenText=new itemRect(step,"Courier New",.2*x,.3*y,"#555555","text"),scoreText=new itemRect(step,"Courier New",.65*x,.3*y,"#555555","text"),maxScoreText=new itemRect(step,"Courier New",.29*x,.35*y,"#FF0000","text");for(var e=0;e<instr.length;e++)instrText[e]=new itemRect(.8*step,"Courier New",xSpace,.5*y+e*step,"#000000","text")}else if(1==t){(player=new itemRect(1.5*step,1.5*step,.5*x,.5*y,"#555555")).scoreInterval=setInterval(function(){score--},1e3);for(e=0;e<7;e++){var i=utilGenerateLoc(bricks);bricks[e]=i?new itemRect(1.5*step,1.5*step,i.x,i.y,"#000000","brick"):new itemRect(1.5*step,1.5*step,randomInt(1.5*step,x-1.5*step),randomInt(step,y-step),"#000000","brick")}screenText=new itemRect(step,"Courier New",x-6.2*step,step,"#555555","text"),scoreText=new itemRect(step,"Courier New",step/5,step,"#555555","text")}}var gameScreen={canvas:document.createElement("canvas"),start:function(t){this.type=t,this.canvas.width=x,this.canvas.height=y,this.canvas.onpointerdown=dealPointerDown,this.canvas.onpointermove=dealPointerMove,this.canvas.onpointerup=dealPointerUp,this.canvas.pointerupoutside=dealPointerUp,this.context=this.canvas.getContext("2d"),document.body.insertBefore(this.canvas,document.body.childNodes[0]),this.interval=0==t?setInterval(ticker,17):setInterval(ticker1,17)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},stop:function(t=0){clearInterval(this.interval),clearInterval(player.scoreInterval),score>maxScore&&(maxScore=score,lsObj.maxScore=maxScore,localStorage.setItem("BIHENASO",JSON.stringify(lsObj))),player=null,line=null,lineOn=!1,bricks=[],screen=1,score=0;var e=t>0?"404 NOT FOUND":"GAME OVER";this.clear(),this.context.font=2*step+"px Courier New",this.context.strokeStyle="#FF0000",this.context.textAlign="center",this.context.strokeText(e,container.width/2,container.height/2),this.context.strokeStyle="#FF0000",this.context.lineWidth=step/4,(replay=new Path2D).arc(container.width/2-3*step,container.height/2+3*step,step,Math.PI/3,2*Math.PI,!1),replay.moveTo(container.width/2-2*step,container.height/2+3*step),replay.lineTo(container.width/2-2*step,container.height/2+2*step),replay.moveTo(container.width/2-2*step-step/8,container.height/2+3*step-step/8),replay.lineTo(container.width/2-3*step+step/8,container.height/2+3*step-step/8),this.context.stroke(replay),(back=new Path2D).moveTo(container.width/2+4*step,container.height/2+2*step),back.lineTo(container.width/2+4*step,container.height/2+4*step),back.lineTo(container.width/2+2*step,container.height/2+3*step),back.lineTo(container.width/2+4.1*step,container.height/2+1.9*step),this.context.stroke(back),this.canvas.onpointerdown=dealGameOverPointerDown,this.canvas.onpointermove=null,this.canvas.onpointerup=null,this.canvas.pointerupoutside=null}},itemRect=function(t,e,i,n,s,a="player",r=null){this.width=t,this.height=e,this.x=i,this.y=n,this.id=itemID++,this.angle=0,this.color=s,this.gravitySpeed=1,this.rotator=null==r?randomInt(0,10)%2==0?-1:1:r,this.bonusStatus=null==r&&randomInt(0,5)%3==0?1:0,this.update=function(){if(ctx=gameScreen.context,"text"==a)ctx.font=this.width+"px "+this.height,ctx.fillStyle=this.color,ctx.fillText(this.text,this.x,this.y);else{if(ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.lineWidth=step/4,"player"==a)ctx.strokeStyle=this.color,ctx.fillStyle="#FFFF00",ctx.fillRect(this.width/-2,this.height/-2,this.width,this.height);else if(1==this.bonusStatus){ctx.strokeStyle="#FF0000",(t=new Path2D).moveTo(-.25*step,-.4*step),t.lineTo(-.25*step,.4*step),t.moveTo(-.15*step,-.35*step),t.lineTo(-.55*step,-.15*step),t.moveTo(-.35*step,-.35*step),t.lineTo(.05*step,-.15*step),t.moveTo(.25*step,-.4*step),t.lineTo(.25*step,.4*step),t.moveTo(.15*step,-.35*step),t.lineTo(.55*step,-.15*step),t.moveTo(.35*step,-.35*step),t.lineTo(-.05*step,-.15*step),ctx.stroke(t)}else if(this.rotator<0){ctx.strokeStyle="#00FF00",(t=new Path2D).moveTo(-.25*step,.4*step),t.lineTo(-.25*step,-.4*step),t.moveTo(-.15*step,.35*step),t.lineTo(-.55*step,.15*step),t.moveTo(-.35*step,.35*step),t.lineTo(.05*step,.15*step),t.moveTo(.25*step,-.4*step),t.lineTo(.25*step,.4*step),t.moveTo(.15*step,-.35*step),t.lineTo(.55*step,-.15*step),t.moveTo(.35*step,-.35*step),t.lineTo(-.05*step,-.15*step),ctx.stroke(t)}else{var t;ctx.strokeStyle="#0000FF",(t=new Path2D).moveTo(-.25*step,-.4*step),t.lineTo(-.25*step,.4*step),t.moveTo(-.15*step,-.35*step),t.lineTo(-.55*step,-.15*step),t.moveTo(-.35*step,-.35*step),t.lineTo(.05*step,-.15*step),t.moveTo(.25*step,.4*step),t.lineTo(.25*step,-.4*step),t.moveTo(.15*step,.35*step),t.lineTo(.55*step,.15*step),t.moveTo(.35*step,.35*step),t.lineTo(-.05*step,.15*step),ctx.stroke(t)}ctx.strokeRect(this.width/-2+ctx.lineWidth/2,this.height/-2+ctx.lineWidth/2,this.width-ctx.lineWidth,this.height-ctx.lineWidth),ctx.restore()}},this.move=function(){this.checkBricks(),lineOn?this.checkBounds()&&(lineOn=!1):(this.checkBounds(),this.y+=this.gravitySpeed)},this.checkBounds=function(){var t=!1;return this.x-this.width/2<container.x&&(this.x+=this.width/2,t=!0),this.x+this.width/2>container.width&&(this.x-=this.width/2,t=!0),t},this.checkBricks=function(){bricks.forEach(function(t){if(calDist(this,t)<this.width)if(lineOn=!1,this.y<=t.y&&Math.abs(this.x-t.x)<3*this.width/4){if(1==t.bonusStatus)randomInt(0,10)%7==0?this.y-=n:(gameScreen.context.clearRect(t.width/-2,t.height/-2,t.width,t.height),bricks=bricks.filter(function(e){return e.id!=t.id}.bind(t)));else this.y=t.y-this.width,this.gravitySpeed=0}else{var e=Math.atan2(t.y-this.y,t.x-this.x);this.x=this.x+2*Math.cos(Math.PI+e),this.y=this.y+2*Math.sin(Math.PI+e)}}.bind(this))}},itemLine=function(t,e,i,n,s,a){this.beginX=t,this.beginY=e,this.nX=t,this.nY=e,this.endX=i,this.endY=n,this.angle=Math.atan2(e-n,t-i),this.startAngle=this.angle,this.color=s,this.distance=calDist({x:t,y:e},{x:i,y:n}),this.moveFactor=a.rotator,this.update=function(){this.angle+=this.moveFactor*Math.PI/180,ctx=gameScreen.context,ctx.beginPath(),this.nX=this.endX+this.distance*Math.cos(this.angle),this.nY=this.endY+this.distance*Math.sin(this.angle),ctx.moveTo(this.nX,this.nY),ctx.lineTo(this.endX,this.endY),player.x=this.nX+.5*player.width*Math.cos(this.angle),player.y=this.nY+.5*player.height*Math.sin(this.angle),ctx.closePath(),ctx.stroke(),0==gameScreen.type?Math.abs(this.startAngle-this.angle)>Math.PI/2&&"p"==a.stat?(clearInterval(gameScreen.interval),clearInterval(player.scoreInterval),player=null,lineOn=!1,line=null,bricks=[],instrText=[],maxScoreOn=!1,maxScoreText=null,gameScreen.clear(),startGame(1)):Math.abs(this.startAngle-this.angle)>Math.PI/2&&"h"==a.stat&&(maxScoreOn=!0):1==a.bonusStatus&&Math.abs(this.startAngle-this.angle)>Math.PI/3&&(lineOn=!1,gameScreen.context.clearRect(a.width/-2,a.height/-2,a.width,a.height),bricks=bricks.filter(function(t){return t.id!=a.id}.bind(a)))},this.colCheck=function(){var t,e,i=Math.min(this.nX,this.endX),n=Math.min(this.nY,this.endY),s=Math.abs(this.endX-this.nX),a=Math.abs(this.endY-this.nY);bricks.forEach(function(r){if(t=r.x-r.width/2,e=r.y-r.height/2,(this.endX>t+r.width||this.endX<t||this.endY>e+r.height||this.endY<e)&&i<t+r.width&&i+s>t&&n<e+r.height&&n+a>e){var h=Math.atan2(this.endY-this.nY,this.endX-this.nX),o=Math.atan2(this.endY-e,this.endX-t)>h;Math.atan2(this.endY-(e+r.height),this.endX-(t+r.width))>h==o&&Math.atan2(this.endY-e,this.endX-(t+r.width))>h==o&&Math.atan2(this.endY-(e+r.height),this.endX-t)>h==o||(lineOn=!1)}},this)}};function ticker(){player.y+player.height/2>container.height?(player.y=.5*y,player.x=.5*x):(gameScreen.clear(),player.update(),player.move(),maxScoreOn&&(maxScoreText.text=maxScore,maxScoreText.update()),instrText.forEach(function(t,e){t.text=instr[e],t.update()}),screenText.text="HIGH SCORE",screenText.update(),scoreText.text="PLAY",scoreText.update(),bricks.forEach(function(t){t.update()}),lineOn&&line.update())}function ticker1(){player.y<y/3&&(slideScreen(),screen++,score+=100),player.y+player.height/2>container.height?gameScreen.stop():screen>=404?gameScreen.stop(1):(gameScreen.clear(),player.update(),player.move(),screenText.text="SCREEN "+formatScreen(),screenText.update(),scoreText.text="SCORE> "+score,scoreText.update(),bricks.forEach(function(t){t.update()}),lineOn&&(line.update(),line.colCheck()))}function dealPointerDown(t){this.isDown=!0;var e=t.pageX,i=t.pageY;isIn(player,e,i)?(this.beginX=e,this.beginY=i,this.stat="line event"):player.gravitySpeed?lineOn&&(lineOn=!1):(player.y-=2*step,player.gravitySpeed=1)}function dealPointerMove(t){this.isDown&&"line event"===this.stat&&(this.endX=t.pageX,this.endY=t.pageY)}function dealPointerUp(t){this.isDown=!1,"line event"===this.stat&&bricks.forEach(function(t){isIn(t,this.endX,this.endY)&&(lineOn=!0,player.gravitySpeed=1,line=new itemLine(this.beginX,this.beginY,this.endX,this.endY,"#000000",t))}.bind(this)),this.stat=null}function dealGameOverPointerDown(t){this.isDown=!0;var e=t.pageX,i=t.pageY;gameScreen.context.isPointInStroke(replay,e,i)?(gameScreen.clear(),back=null,replay=null,startGame(1)):gameScreen.context.isPointInStroke(back,e,i)&&startGame()}function isIn(t,e,i){var n=!1;return t.x-t.width/2<=e&&t.x+t.width/2>=e&&t.y-t.width/2<=i&&t.y+t.height/2>=i&&(n=!0),n}function randomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function calDist(t,e){return Math.pow(Math.pow(Math.abs(t.x-e.x),2)+Math.pow(Math.abs(t.y-e.y),2),.5)}function formatScreen(){var t;return screen>=100?t=screen.toString():screen<100&&screen>=10?(t="0",t+=screen.toString()):(t="00",t+=screen.toString()),t}function generateLoc(t){var e=randomInt(.75*step,window.x-.75*step),i=randomInt(.75*step,window.y-.75*step),n=!0;return t.length?(t.forEach(function(t){calDist(t,{x:e,y:i})<1.5*step&&(n=!1)}),n?{x:e,y:i}:null):{x:e,y:i}}function utilGenerateLoc(t,e=5){for(var i,n=0;n<e&&!(i=generateLoc(t));n++);return i}startGame();
