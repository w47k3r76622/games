var t,e=function(){let t=arguments,e=t[0],i=1;return e.replace(/%((%)|s|d)/g,function(e){let s=null;if(e[2])s=e[2];else{switch(s=t[i],e){case"%d":s=parseFloat(s),isNaN(s)&&(s=0)}i++}return s})},i=function(t,e,i=1){return e>=0&&e<=t.length-1?t.slice(0,e)+t.slice(e+i):t},s=function(t){return t.Rect=class extends s.Sprite{constructor(t,e,i,s,h,a="transparent"){super(t,e,i,s),this.width=i,this.height=s,this.color=h,this.borderColor=a,this.hasShadow=0,this.borderWidth=1,this.lineJoin="bevel"}drawItself(e){e.save(),this.hasShadow&&(e.shadowColor="rgba(0, 0, 0, 0.6)",e.shadowBlur=5,e.shadowOffsetX=0,e.shadowOffsetY=0),e.lineWidth=this.borderWidth,e.lineJoin=this.lineJoin,e.strokeStyle=this.borderColor,e.strokeRect(0,0,this.width,this.height),e.restore(),e.fillStyle=this.color,e.fillRect(0,0,this.width,this.height),t.Sprite.prototype.drawItself.apply(this,arguments)}setBGColor(t){this.color=t}setBorderWidth(t){this.borderWidth=t}toggleShadow(t){this.hasShadow=t}},t.Circle=class extends s.Sprite{constructor(t,e,i,s,h=0,a="#FFFFFF"){super(t,e),this.setRadius(i),this.color=s,this.borderColor=a,this.borderWidth=h}drawItself(e){t.Sprite.prototype.drawItself.apply(this,arguments),e.beginPath(),e.arc(0,0,this.radius,0,2*Math.PI),this.borderWidth>0&&(e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor,e.stroke()),e.fillStyle=this.color,e.fill()}setRadius(t){this.radius=t}},t.RectRing=class extends s.Sprite{constructor(t,e,i,s,h,a=2){super(t,e),this.width=i,this.height=s,this.color=h,this.borderWidth=a}drawItself(e){t.Sprite.prototype.drawItself.apply(this,arguments),this.borderWidth>0&&(e.lineWidth=this.borderWidth,e.shadowColor="rgba(0, 0, 0, 0.4)",e.shadowOffsetX=1,e.shadowOffsetY=1,e.strokeStyle=this.color,e.strokeRect(0,0,this.width,this.height))}},t}((s=function(){class t{constructor(t,e,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s,this.tag=0,this.rotateAngle=0,this.opacity=1,this.isVisible=1,this.isAnchorCenter=0,this.behaviorList=[],this.subSpriteList=[],this.parentSprite=null,this.behaviorBackup=[],this.autoRestart=0,this.isPauseBehavior=0,this.restartWaitTime=0,this.restartWaitedTime=0,this.blinkOpacity=0,this.blinkBehvaior=null,this.clickListener=null,this.hoverListener=null,this.swipeListener=null,this.isHovered=0,this.isEnabled=1,this.cacheCanvas=document.createElement("canvas"),this.cacheCanvas.width=i,this.cacheCanvas.height=s,this.isDrawFromCache=0,this.drawOnce=0,this.drawn=0,this.hasUpdate=0}draw(t){this.isDrawFromCache?t.drawImage(this.cacheCanvas,0,0):(t.save(),this.drawItself(t),t.restore(),this.drawSubsprite(t))}drawFromCache(){let t=this.cacheCanvas.getContext("2d");this.isDrawFromCache=0,this.draw(t),this.isDrawFromCache=1}drawItself(t){}drawSubsprite(t){this.subSpriteList.length>0&&(t.save(),null===this.parentSprite&&t.translate(this.x,this.y),this.subSpriteList.forEach(function(e){e.isVisible&&(t.save(),t.translate(e.x,e.y),t.rotate(e.rotateAngle*Math.PI/180),1==e.isAnchorCenter&&t.translate(-e.width/2,-e.height/2),t.globalAlpha=t.globalAlpha*e.opacity,e.draw(t),t.restore())},this),t.restore())}update(t){let e=0,i=this.subSpriteList.length;if(i>0)for(let s=0;s<i;s++)this.subSpriteList[s].update(t)&&(e=1);let s=this.behaviorList.length;if(s>0){e=1;for(let e=0;e<s;e++)this.behaviorList[e].execute(t);this.behaviorList=this.behaviorList.filter(function(t){return!t.finished}),this.isBehaviorDone()&&this.autoRestart&&(this.restartWaitedTime<this.restartWaitTime?this.restartWaitedTime+=t:this.restartBehavior())}return this.hasUpdate&&(e=1,this.hasUpdate=0),e}clearBehavior(t=0){this.behaviorList=[],t&&this.subSpriteList.forEach(function(e){e.clearBehavior(t)},this)}addBehavior(t){t instanceof e&&(this.behaviorList.push(t),this.behaviorBackup.push(t))}addBehaviorWithDelay(t,e,i,s,h=0,a){setTimeout((()=>{let h=new t(this,e,i,s,a);this.addBehavior(h)}).bind(this),h)}stopBehavior(t){this.behaviorList.includes(t)&&t.stop(0)}stopAllBehavior(t){this.behaviorList.forEach(function(e){e.stop(t)},this)}isBehaviorDone(){return 0===this.behaviorList.length}addSubSprite(e,i=1){e instanceof t&&(e.parentSprite=this,this.subSpriteList.push(e),i&&(this.width<e.x+e.width&&(this.width=e.x+e.width,this.cacheCanvas.width=this.width),this.height<e.y+e.height&&(this.height=e.y+e.height,this.cacheCanvas.height=this.height)))}removeSubSprite(t){let e=this.subSpriteList.indexOf(t);this.subSpriteList.splice(e,1)}clearSubSprite(t=0){this.subSpriteList=[],t&&this.subSpriteList.forEach(function(e){e.clearSubSprite(t)},this),this.hasUpdate=1}placeSubSpriteTopToBottom(){this.subSpriteList.push(this.subSpriteList.shift())}clear(t=1){this.clearSubSprite(t),this.clearBehavior(t)}setPos(t,e){this.x=t,this.y=e,this.hasUpdate=1}setSize(t,e){this.width=t,this.height=e,this.hasUpdate=1}isPointInside(t){let e=this.getRelativePos(t),i=e.x,s=e.y,h=i>0&&i<this.width,a=s>0&&s<this.height;return h&&a}setVisible(t){this.isVisible=t}isVisible(){return this.isVisible}setTop(){if(null!==this.parentSprite){let t=this.parentSprite.subSpriteList.indexOf(this);t!==this.parentSprite.subSpriteList.length-1&&(this.parentSprite.subSpriteList.splice(t,1),this.parentSprite.subSpriteList.push(this))}}setFadeIn(t,e,s,h=0,a=0){let r=1-t;setTimeout(()=>{this.opacity=t,this.addBehaviorWithDelay(i,"opacity",r,s,0)},e),0!==h&&(this.x-=h,this.addBehaviorWithDelay(i,"x",h,s,e)),0!==a&&(this.y-=a,this.addBehaviorWithDelay(i,"y",a,s,e))}blink(t){let e={};void 0!==t&&(e.repeatInterval=t),this.blinkBehvaior=this.addBehaviorWithDelay(s.BlinkBehavior,"blinkOpacity",.5,-1,0,e)}stopBlink(){null!==this.blinkBehvaior&&(this.stopBehavior(this.blinkBehvaior),this.blinkBehvaior=null,this.blinkOpacity=0)}getRelativePos(t){let e={x:t.x-this.x,y:t.y-this.y};return null!==this.parentSprite&&(e=this.parentSprite.getRelativePos(e)),e}getGlobalPos(){let t={x:this.x,y:this.y},e=this.parentSprite;for(;null!==e;)t.x+=e.x,t.y+=e.y,e=e.parentSprite;return t}}class e{constructor(t,e,i,s){this.sprite=t,this.variableName=e,this.changeFunction=i,this.isChangeFunctionIncremental=0,this.interval=s,this.originalValue=this.sprite[this.variableName],this.passedTime=0,this.started=0,this.finished=0,this.lastChange=0,this.checkUnfinished=this.getCheckUnfinished().bind(this)}execute(t){if(!this.finished)if(this.passedTime+=t,this.checkUnfinished())if(this.isChangeFunctionIncremental)this.sprite[this.variableName]+=this.changeFunction(t);else{let t=this.changeFunction(this.passedTime);this.sprite[this.variableName]+=t-this.lastChange,this.lastChange=t}else this.stop(1)}stop(t){this.finished=1,t&&this.toEndValue()}toEndValue(){this.interval>0&&(this.sprite[this.variableName]=this.originalValue+this.changeFunction(this.interval))}getCheckUnfinished(){return this.interval>=0?function(){return this.passedTime<this.interval}:function(){return 1}}replay(){this.sprite[this.variableName]=this.originalValue,this.passedTime=0,this.finished=0}}class i extends e{constructor(t,e,i,s){super(t,e,function(t){if(t>=s)return i;{let e=t/s;return Math.pow(e,2)*(3-2*e)*i}},s)}}return{Sprite:t,SineBehavior:class extends e{constructor(t,e,i,s,h){let a=1/h.period,r=i;super(t,e,function(t){return t>=s?0:Math.sin(t*a*2*Math.PI)*r},s)}},EaseInOutBehavior:i,BlinkBehavior:class extends e{constructor(t,e,i,s,h){let a=2e3;void 0!==h&&void 0!==h.repeatInterval&&(a=h.repeatInterval);let r=void 0!==s&&s>0?s:a;super(t,e,function(t){let e=t/r;return e%=1,(1-Math.cos(2*Math.PI*e))/2*i},s)}}}}())||{}),h=function(){let t={width:40,height:40,spacingBetweenH:10,spacingBetweenV:10,gridWidth:50,gridHeight:50,transitionTime:500,finalOpacity:1,finalFillColor:"transparent",finalTextColor:"#333333",focusFillColor:"rgba(256, 256, 256, 0.4)",blinkFillColor:"rgba(238, 238, 256, 0.4)",buttonGradientColor:"rgba(102, 102, 102, 0.4)",font:"20px Lucida Console",textBaseLine:"top",textAlign:"start",lineHeight:30,padding:0,lineJoin:"bevel",borderWidth:0,borderColor:"#000000"};class e extends s.Sprite{constructor(e,i,s,h,a=""){super(e,i),this.width=s,this.height=h,this.textX=10,this.textY=0,this.textAlign="start",this.textBaseline="top",this.font=t.font,this.lineHeight=t.lineHeight,this.finalFillColor=t.finalFillColor,this.finalTextColor=t.finalTextColor,this.lineJoin=t.lineJoin,this.borderWidth=t.borderWidth,this.borderColor=t.borderColor,this.textList=[],this.isLookDisabled=0,void 0!==a&&this.textList.push(a)}drawItself(e){if(super.drawItself(e),e.save(),this.borderWidth>0&&(e.lineWidth=this.borderWidth,e.lineJoin=this.lineJoin,e.strokeStyle=this.borderColor,e.strokeRect(0,0,this.width,this.height)),e.fillStyle=this.finalFillColor,e.fillRect(0,0,this.width,this.height),this.isInFocus&&(e.fillStyle=t.focusFillColor,e.fillRect(0,0,this.width,this.height)),this.blinkOpacity>0){e.save(),e.globalAlpha=e.globalAlpha*this.blinkOpacity;let i=e.createLinearGradient(0,0,this.width,0);i.addColorStop(0,t.blinkFillColor),i.addColorStop(.5,"transparent"),i.addColorStop(1,t.blinkFillColor),e.fillStyle=i,e.fillRect(0,0,this.width,this.height),e.fillStyle=t.blinkFillColor,e.fillRect(0,0,this.width,this.height),e.restore()}e.translate(t.padding,t.padding),e.fillStyle=this.finalTextColor,e.font=this.font,e.textAlign=this.textAlign,e.textBaseline=this.textBaseline;for(let t=0;t<this.textList.length;t++){let i=this.textList[t];e.fillText(i,this.textX,this.textY+this.lineHeight*t)}this.isLookDisabled&&(e.fillStyle="rgba(255, 255, 255, 0.5)",e.fillRect(0,0,this.width,this.height)),e.restore()}setTextCenter(){this.textAlign="center",this.textX=this.width/2,this.setTextCenterY()}setTextCenterY(){this.textBaseline="middle",this.textY=this.height/2-(this.textList.length-1)*this.lineHeight/2}setTextAlign(t){if(["left","right","center"].includes(t)){switch(t){case"left":this.textX=0;break;case"right":this.textX=this.width;break;case"center":this.textX=this.width/2}this.textAlign=t}}setTextPos(t,e){this.textX=t,this.textY=e}setColor(t,e){this.finalFillColor=t,this.finalTextColor=e}setTextColor(t){this.finalTextColor=t}setBGColor(t){this.finalFillColor=t}setBorder(t,e){this.borderWidth=t,e&&(this.borderColor=e)}setFont(t){this.font=t}setFontSize(t){this.font=this.font.replace(/\d+/,t.toString()),this.setLineHeight(t)}setLineHeight(t){this.lineHeight=t}setLookDisabled(t){this.isLookDisabled=t,this.hasUpdate=1}focus(t){this.isInFocus=t}appendText(...t){return t?(t.forEach(t=>this.textList.push(t)),1):0}setText(t,e){if(void 0!==e&&"number"==typeof e||(e=0),e<this.textList.length)this.textList[e]=t;else{for(let t=this.textList.length;t<e;t++)this.textList.push("");this.textList.push(t)}return 1}setAllText(...t){return t?(t.forEach((t,e)=>{e<this.textList.length?this.textList[e]=t:this.textList.push(t)}),1):0}}return{setTextBlockConfig:function(e){for(let i in e)t.hasOwnProperty(i)&&(t[i]=e[i])},TextBlock:e,ChoiceBox:class extends e{constructor(t,e){super(t,e,180,20,""),this.setBGColor("#FFFFFF"),this.setTextColor("#000000"),this.setFontSize(30),this.setBorder(10,"#000033"),this.textX=30,this.textY=10,this.choiceList=[],this.choiceValueList=[],this.selectedIndex=0,this.selectIndicator=new s.Rect(10,this.textY+this.lineHeight,10,10),this.addSubSprite(this.selectIndicator,0)}addChoice(t,e=null){let i=this.choiceList.length;this.choiceList.push(t),this.choiceValueList.push(null===e?t:e),this.setText(t,i),this.height+=this.lineHeight,this.setTextCenterY(),this.setIndicatorPosition()}choiceUp(){0!==this.selectedIndex&&this.selectedIndex--,this.setIndicatorPosition()}choiceDown(){this.selectedIndex!==this.choiceList.length-1&&this.selectedIndex++,this.setIndicatorPosition()}setIndicatorPosition(){let t=this.textY-5;this.selectIndicator.setPos(10,t+this.lineHeight*this.selectedIndex)}getIndex(){return this.selectedIndex}getChoice(){return this.choiceList[this.selectedIndex]}getChoiceValue(){return this.choiceValueList[this.selectedIndex]}}}}(),a=function(t){let e={width:40,height:40,gridWidth:42,gridHeight:42,transitionTime:100,borderWidth:5,borderColor:"#333333",lineJoin:"round",character:{marginX:6,marginY:3,headHeight:25,eyeFromY:5,eyeToY:10}};class i extends s.Sprite{constructor(t,i){super(i*e.gridWidth,t*e.gridHeight,e.width,e.height),this.setFillColor("#666600"),this.i=t,this.j=i}drawItself(t){super.drawItself(t),t.fillStyle=this.fillColor,t.beginPath(),t.arc(this.width/2,this.height/2,this.height/2,.75*Math.PI,.25*Math.PI),t.fill()}setFillColor(t){this.fillColor=t}}class h extends s.Sprite{constructor(t){let i=t.i,s=t.j;super(s*e.gridWidth+e.character.marginX,i*e.gridHeight+e.character.marginY,e.width-2*e.character.marginX,e.height-2*e.character.marginY),this.i=i,this.j=s}moveBy(t,i){this.stopAllBehavior(1),0!==i&&(this.j+=i,this.addBehaviorWithDelay(s.EaseInOutBehavior,"x",e.gridWidth*i,e.transitionTime*Math.abs(i),0)),0!==t&&(this.i+=t,this.addBehaviorWithDelay(s.EaseInOutBehavior,"y",e.gridHeight*t,e.transitionTime*Math.abs(t),0))}}return t.MapBushTile=class extends i{constructor(t,e){super(t,e),this.setFillColor("#6A8900")}},t.MapStoneTile=class extends i{constructor(t,e){super(t,e),this.setFillColor("#5A4D41")}},t.MapCloudTile=class extends i{constructor(t,e){super(t,e),this.setFillColor("#EEEEEE")}},t.MapGoalTile=class extends i{constructor(t,e){super(t,e),this.setFillColor("#804080")}drawItself(t){t.strokeStyle=this.fillColor,t.lineWidth=2,t.beginPath(),t.arc(this.width/2,this.height/2,this.width/2,0,2*Math.PI),t.moveTo(this.width/4*3,this.height/2),t.arc(this.width/2,this.height/2,this.width/4,0,2*Math.PI),t.stroke()}},t.MapPlayer=class extends h{constructor(t){super(t)}drawItself(t){super.drawItself(t),t.lineWidth=e.borderWidth,t.lineJoin=e.lineJoin,t.shadowColor="rgba(0, 0, 0, 0.4)",t.shadowBlur=2,t.shadowOffsetX=1,t.shadowOffsetY=1,t.strokeStyle=e.borderColor,t.strokeRect(0,0,this.width,e.character.headHeight),t.fillStyle="#EEEEFF",t.fillRect(0,0,this.width,e.character.headHeight),t.fillStyle="#FFFF00",t.beginPath(),t.moveTo(this.width/4,e.character.headHeight),t.lineTo(0,this.height),t.lineTo(this.width,this.height),t.lineTo(this.width/4*3,e.character.headHeight),t.stroke(),t.fill(),t.lineCap=this.lineJoin,t.beginPath(),t.moveTo(this.width/4,e.character.eyeFromY),t.lineTo(this.width/4,e.character.eyeToY),t.moveTo(this.width/4*3,e.character.eyeFromY),t.lineTo(this.width/4*3,e.character.eyeToY),t.stroke(),super.drawItself(t)}},t.MapEnemy=class extends h{constructor(t){super(t),this.canMove=t.canMove,this.enemyId=t.id}drawItself(t){super.drawItself(t),t.fillStyle="#66666680",t.strokeStyle=e.borderColor,t.lineWidth=e.borderWidth,t.strokeRect(0,0,this.width,this.height),t.fillRect(0,0,this.width,this.height),t.beginPath(),t.moveTo(this.width/4,e.character.eyeFromY),t.lineTo(this.width/4,e.character.eyeToY),t.moveTo(this.width/4*3,e.character.eyeFromY),t.lineTo(this.width/4*3,e.character.eyeToY),t.stroke()}},t.MapItemBox=class extends h{constructor(t){super(t),this.type=t.type,this.spell=t.spell}drawItself(t){super.drawItself(t),t.fillStyle="#FFD700",t.strokeStyle=e.borderColor,t.lineWidth=e.borderWidth,t.fillRect(0,0,this.width,this.height),t.strokeRect(0,0,this.width,this.height/2),t.strokeRect(1,this.height/2,this.width-2,this.height/2)}},t}(a||{}),r=(s=function(t){let e={smallObjWidth:20,smallObjHeight:20,middleObjSize:40,thinObjHeight:5,fireColor:"rgba(255, 0, 0, 0.5)",iceColor:"#D4F0FF",leafColor:"#7BB661",pulseColor:"#808080",rockColor:"#5A4D41",windColor:"rgba(255, 255, 255, 0.5)",sparkColor:"#FFFF33",lightColor:"rgba(255, 255, 255, 0.2)",damageRipple:{radiusInit:10,radiusDiff:10,color:"rgba(127, 127, 127, 0.2)",interval:400},borderColor:"#333333",holdInterval:200,throwInterval:300};class i extends s.Sprite{constructor(t,i){super(t,i),this.from={x:t,y:i},this.to={x:t,y:i},this.isDamage=1,this.damageRippleColor=e.damageRipple.color}setDestinationSprite(t){this.to={x:t.x+t.width/2-this.width/2,y:t.y+t.height/2-this.height/2}}setAmount(t,e){null!==t&&(this.amount=t),this.isDamage=e}startAnimation(t){let i=this.to.x-this.from.x,h=this.to.y-this.from.y;this.addBehaviorWithDelay(s.EaseInOutBehavior,"x",i,e.throwInterval,e.holdInterval),this.addBehaviorWithDelay(s.EaseInOutBehavior,"y",h,e.throwInterval,e.holdInterval),setTimeout(()=>{this.clear(),this.touchTargetAnimation(),void 0!==t&&t()},e.holdInterval+e.throwInterval)}touchTargetAnimation(){let t=new s.Circle(e.smallObjWidth/2,e.smallObjHeight/2,e.damageRipple.radiusInit,this.damageRippleColor);t.addBehaviorWithDelay(s.EaseInOutBehavior,"radius",e.damageRipple.radiusDiff,e.damageRipple.interval,0),t.addBehaviorWithDelay(s.EaseInOutBehavior,"opacity",-1,e.damageRipple.interval,0);let i=new h.TextBlock(0,-50,50,20,this.amount.toString());this.isDamage||i.setTextColor("#CC6666"),i.setFadeIn(0,0,e.damageRipple.interval,0,-30),this.addSubSprite(t),this.addSubSprite(i),setTimeout(()=>{this.clear()},e.damageRipple.interval)}}class a extends i{constructor(t,i,h,a,r=e.borderColor){super(t,i),this.damageRippleColor=a;let o=new s.Rect(0,0,h,h,a,r);o.hasShadow=1;let n=new s.Circle(h/2,h/2,h/2,e.lightColor);o.addSubSprite(n),this.addSubSprite(o)}}class r extends i{constructor(t,i,h,a,r=e.borderColor){super(t,i),this.damageRippleColor=a;let o=new s.Circle(h/2,h/2,h/2,a,r);o.hasShadow=1;let n=new s.Circle(h/2,h/2,h/4,e.lightColor);o.addSubSprite(n),this.addSubSprite(o)}}return t.Fire=class extends a{constructor(t,i){super(t,i,e.smallObjWidth,e.fireColor)}},t.Ice=class extends a{constructor(t,i){super(t,i,e.smallObjWidth,e.iceColor)}},t.Leaf=class extends i{constructor(t,i){super(t,i),this.damageRippleColor=e.leafColor;let h=new s.Rect(0,0,e.smallObjWidth,e.thinObjHeight,e.leafColor,e.borderColor),a=new s.Rect(5,10,e.smallObjWidth,e.thinObjHeight,e.leafColor,e.borderColor);h.hasShadow=1,this.addSubSprite(h),this.addSubSprite(a)}},t.Rock=class extends r{constructor(t,i){super(t,i,e.middleObjSize,e.rockColor)}},t.Snow=class extends r{constructor(t,i){super(t,i,e.middleObjSize,e.iceColor)}},t.Wind=class extends a{constructor(t,i){super(t,i,e.middleObjSize,e.windColor,"#00000000")}},t.Spark=class extends a{constructor(t,i){super(t,i,e.middleObjSize,e.sparkColor)}},t.Pulse=class extends i{constructor(t,i){super(t,i),this.damageRippleColor=e.pulseColor;let h=new s.RectRing(0,0,e.smallObjWidth,e.smallObjHeight,e.pulseColor);h.hasShadow=1,this.addSubSprite(h)}},t}(s||{}),h=function(t){let e={color:"#FFFFFF",textColor:"#000000",fontSize:30,borderWidth:10,borderColor:"#000033",cursorHeight:30,shadowColor:"rgba(0, 0, 0, 0.6)",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,usedSpell:{width:150,time:1e3,marginY:15},randomLetters:["A","C","D","E","F","H","I","K","L","N","O","R","S","X"]};class a extends h.TextBlock{constructor(t,i,s,h=50,a=1){super(t,i,s,h,""),this.setBGColor(e.color),this.setTextColor(e.textColor),this.setFontSize(e.fontSize),this.setBorder(e.borderWidth,e.borderColor),a?this.setTextCenterY():this.textY=10,this.content="",this.maxLength=null}fitText(){this.width=20+.6*e.fontSize*this.content.length,this.setTextCenter()}fitMax(){this.width=20+.6*e.fontSize*this.maxLength}setContent(t){null!==this.maxLength&&(t=t.slice(0,this.maxLength)),this.content=t.toUpperCase(),this.setText(this.content)}appendContent(t){this.setContent(this.content+t)}setAndFitContent(t){this.setContent(t),this.fitText()}}let r=function(t,i){let s=t.slice(),h=e.randomLetters.slice(),a="";for(let r=0;r<i;r++){let i=0;Math.random()<.7?(a+=s[i=Math.floor(Math.random()*s.length)],s.splice(i,1),0===s.length&&(s=t.slice())):(a+=h[i=Math.floor(Math.random()*h.length)],h.splice(i,1),0===h.length&&(h=e.randomLetters.slice()))}return a};return t.SpellBox=class extends a{constructor(t,e,i,s,h=""){super(t,e,i,s),this.frontText="",this.textCursorIndex=0,this.availableSpell="",this.maxLength=20,this.setLookDisabled(1)}drawItself(t){if(super.drawItself(t),this.isLookDisabled)t.fillStyle="rgba(255, 255, 255, 0.5)",t.fillRect(0,0,this.width,this.height);else{t.font=this.font;let i=t.measureText(this.frontText);t.fillRect(this.textX+i.width,this.textY-e.cursorHeight/2,1,e.cursorHeight)}}initText(){let t=this.availableSpell.split("|"),e=t[Math.floor(Math.random()*t.length)],i=this.maxLength/2;this.appendContent(r(e.split(""),i))}indicatorToLeft(){this.textCursorIndex>0&&this.textCursorIndex--,this.adjustFrontText()}indicatorToRight(){this.textCursorIndex<this.content.length&&this.textCursorIndex++,this.adjustFrontText()}backspace(){if(0!==this.textCursorIndex){let t=i(this.content,this.textCursorIndex-1);this.setContent(t),this.textCursorIndex--,this.adjustFrontText()}}setSpell(t){this.availableSpell=t.join("|")}castSpell(){if(""===this.availableSpell)throw new Exception("No available spell!");let t=null,e=new RegExp(this.availableSpell,"i").exec(this.content);if(null!==e){t=e[0];let s=i(this.content,e.index,t.length);this.setContent(s),this.textCursorIndex=0}return this.adjustFrontText(),t}adjustFrontText(){this.textCursorIndex<this.content.length?this.frontText=this.content.slice(0,this.textCursorIndex):this.frontText=this.content,this.addBehaviorWithDelay(s.SineBehavior,"y",5,100,0,{period:200})}},t.ComingLetterBox=class extends a{constructor(t,e,i,s){super(t,e,i,s,""),this.setTextCenter(),this.spellArray=[],this.content=""}drawItself(t){super.drawItself(t)}setSpell(t){this.spellArray=t}shuffle(){let t=Math.floor(Math.random()*this.spellArray.length),e=this.spellArray[t];this.setContent(r(e.split(""),5))}},t.StyleBox=a,t}(h||{}),function(t){const e={UNKNOWN:0,ATTACK:1,HEAL:3},i={NORMAL:0,DEFEATED:1};let a={height:10,emptyColor:"#00B000",filledColor:"#00FF00",borderColor:"#333333",timePerPixel:10};class r extends s.Sprite{constructor(t,e,i,r,o){super(t,e,i,a.height),this.wholeBar=new s.Rect(0,0,this.width,this.height,a.emptyColor,a.borderColor),this.addSubSprite(this.wholeBar),this.remainBar=new s.Rect(0,0,this.width,this.height,a.filledColor),this.wholeBar.addSubSprite(this.remainBar),this.hpText=new h.TextBlock(0,-15,this.width,15),this.hpText.setTextColor("#000000"),this.hpText.setFontSize(12),this.hpText.setTextCenter(),this.addSubSprite(this.hpText),this.setMaxHp(r),this.setHp(o,0)}setHp(t,e=1){this.currentHp=t;let i=this.remainBar.width,h=this.width*t/this.maxHp,r=h-i;e?this.remainBar.addBehaviorWithDelay(s.EaseInOutBehavior,"width",r,Math.abs(r)*a.timePerPixel,0):this.remainBar.width=h,this.updateHpUI()}setMaxHp(t){this.maxHp=t,this.currentHp=t,this.updateHpUI()}updateHpUI(){this.hpText.setText(this.currentHp+" / "+this.maxHp)}}let o={width:50,height:100,headHeight:50,eyeFromY:15,eyeMiddleY:18,eyeToY:20,eyeCrossDx:2,monHeight:50,bossHeight:80,monsterEye:{middleY:18,halfLength:5}};class n extends s.Sprite{constructor(t,e,s,h){super(t,e,s,h),this.status=i.NORMAL,this.borderWidth=5,this.lineJoin="round"}setStatus(t){this.status=t}}class l extends n{constructor(t,e,i="",s="#FF8000",h="#990000"){super(t,e,o.width,o.monHeight,i),this.moveStartPosition={x:-30,y:this.height/3},this.strokeColor=h,this.fillColor=s}drawItself(t){this.borderWidth>0&&(t.lineWidth=this.borderWidth,t.lineJoin=this.lineJoin,t.shadowColor="rgba(0, 0, 0, 0.4)",t.shadowBlur=2,t.shadowOffsetX=1,t.shadowOffsetY=1,t.strokeStyle=this.strokeColor,t.strokeRect(0,0,this.width,this.height),t.fillStyle=this.fillColor,t.fillRect(0,0,this.width,this.height)),t.lineCap=this.lineJoin,t.beginPath(),t.moveTo(this.width/4,o.monsterEye.middleY-o.monsterEye.halfLength),t.lineTo(this.width/4,o.monsterEye.middleY+o.monsterEye.halfLength),t.moveTo(this.width/4*3,o.monsterEye.middleY-o.monsterEye.halfLength),t.lineTo(this.width/4*3,o.monsterEye.middleY+o.monsterEye.halfLength),t.moveTo(this.width/4-o.monsterEye.halfLength,o.monsterEye.middleY),t.lineTo(this.width/4+o.monsterEye.halfLength,o.monsterEye.middleY),t.moveTo(this.width/4*3-o.monsterEye.halfLength,o.monsterEye.middleY),t.lineTo(this.width/4*3+o.monsterEye.halfLength,o.monsterEye.middleY),t.stroke(),super.drawItself(t)}}return t.Move=class{constructor(t){this.name=t,this.moveType=e.UNKNOWN,this.power=0,this.moveSprite=null}},t.BattleActor=class extends s.Sprite{constructor(t,e,s,a=""){super(t,e,0,0),this.name=a,this.hp=0,this.maxhp=0,this.def=0,this.atk=1,this.status=i.NORMAL,this.learntSpell=[],this.addSubSprite(s),this.moveStartPosition=s.moveStartPosition,this.nameLabel=new h.TextBlock(0,this.height,this.width,30,this.name),this.nameLabel.setTextCenter(),this.addSubSprite(this.nameLabel),this.hpBar=new r(0,-20,this.width,this.hp,this.hp),this.addSubSprite(this.hpBar,0),this.hpBar.setVisible(0)}setConfig(t){for(const e in t)if(t.hasOwnProperty(e)){const i=t[e];"hp"===e?(this.hpBar.setMaxHp(i.full),this.hpBar.setHp(i.now,0),this.hp=i.now,this.maxhp=i.full):"name"===e?this.nameLabel.setText(i):this[e]=i}}loadInfo(t){let e={name:t.name,hp:{full:t.maxhp,now:t.hp},atk:t.atk,def:t.def};this.setConfig(e)}showHpBar(t){this.hpBar.setVisible(t)}checkHp(){this.hpBar.currentHp!==this.hp&&this.hpBar.setHp(this.hp),this.hp<=0&&(this.status=i.DEFEATED,this.addBehaviorWithDelay(s.EaseInOutBehavior,"opacity",-1,500,100))}isDefeated(){return this.status===i.DEFEATED}receiveMove(t,i=0){switch(t.moveType){case e.ATTACK:this.hp-=i,this.hp=Math.max(0,this.hp);break;case e.HEAL:this.hp+=i}this.checkHp()}useMove(t,i){let s=null,h=null,a=1;switch(t.moveType){case e.HEAL:s=this,h=Math.min(s.maxhp-s.hp,t.healAmount),a=0;break;case e.ATTACK:s=i,h=function(t,e,i){let s=Math.floor((e*t-i)/10);return Math.max(s,1)}(t.power,this.atk,s.def);break;default:s=i}let r=function(){s.receiveMove(t,h)};if(null!==t.moveSprite&&void 0!==t.moveSprite){let e=new t.moveSprite(this.x+this.moveStartPosition.x,this.y+this.moveStartPosition.y);e.setDestinationSprite(s),null!==h&&e.setAmount(h,a),e.startAnimation(r),this.parentSprite.addSubSprite(e)}}},t.Actor=n,t.MainCharacter=class extends n{constructor(t,e,i=""){super(t,e,o.width,o.height,i),this.moveStartPosition={x:this.width+5,y:this.height/3}}drawItself(t){switch(t.lineWidth=this.borderWidth,t.lineJoin=this.lineJoin,t.shadowColor="rgba(0, 0, 0, 0.4)",t.shadowBlur=2,t.shadowOffsetX=1,t.shadowOffsetY=1,t.strokeStyle="#990000",t.strokeRect(0,0,this.width,o.headHeight),t.fillStyle="#EEEEFF",t.fillRect(0,0,this.width,o.headHeight),t.fillStyle="#FFFF00",t.beginPath(),t.moveTo(this.width/4,o.headHeight),t.lineTo(0,o.height),t.lineTo(this.width,o.height),t.lineTo(this.width/4*3,o.headHeight),t.stroke(),t.fill(),t.lineCap=this.lineJoin,t.beginPath(),this.status){case i.NORMAL:t.moveTo(this.width/4,o.eyeFromY),t.lineTo(this.width/4,o.eyeToY),t.moveTo(this.width/4*3,o.eyeFromY),t.lineTo(this.width/4*3,o.eyeToY);break;case i.DEFEATED:t.moveTo(this.width/4-o.eyeCrossDx,o.eyeFromY),t.lineTo(this.width/4+o.eyeCrossDx,o.eyeToY),t.moveTo(this.width/4-o.eyeCrossDx,o.eyeToY),t.lineTo(this.width/4+o.eyeCrossDx,o.eyeFromY),t.moveTo(this.width/4*3-o.eyeCrossDx,o.eyeFromY),t.lineTo(this.width/4*3+o.eyeCrossDx,o.eyeToY),t.moveTo(this.width/4*3-o.eyeCrossDx,o.eyeToY),t.lineTo(this.width/4*3+o.eyeCrossDx,o.eyeFromY)}t.stroke(),super.drawItself(t)}},t.MonsterA=class extends l{constructor(t,e,i=""){super(t,e,i,"#FF8000")}},t.MonsterB=class extends l{constructor(t,e,i=""){super(t,e,i,"#0080FF")}},t.MonsterBoss=class extends l{constructor(t,e,i=""){super(t,e,i,"#336633")}},t.MOVE_TYPE=e,t.CHARACTER_STATUS=i,t}(r||{})),o=function(t){class e{constructor(){this.name="",this.maxhp=1,this.hp=1,this.def=0,this.atk=1,this.status=r.CHARACTER_STATUS.NORMAL,this.moveList=[]}updateHp(t){this.hp=t.hp}recover(){this.hp=this.maxhp}loadData(t){this.name=t.name,this.maxhp=t.hp,this.hp=t.hp,this.def=t.def,this.atk=t.atk,this.status=r.CHARACTER_STATUS.NORMAL,this.moveList=t.moveList}}return t.ActorInfo=e,t.PlayerInfo=class extends e{constructor(){super()}learnSpell(t){return t=t.toUpperCase(),this.moveList.includes(t)?0:(this.moveList.push(t),1)}statIncrease(){switch(Math.floor(3*Math.random())){case 0:this.maxhp+=2;break;case 1:this.atk+=2;break;case 2:this.def+=2}}},t}((o=function(t){let e={};return e.plain={isEnd:0,map:[[1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,1,0,0,0,0,1,1,1],[1,1,0,1,0,1,0,1,1,0,1,1,1],[1,1,0,0,0,1,0,0,0,0,0,0,1],[1,1,1,0,1,1,1,0,1,0,1,1,1],[1,1,0,0,0,0,0,0,1,0,0,0,2],[1,1,1,1,1,1,1,1,1,1,1,1,1]],playerData:{i:1,j:0},itemData:[{i:5,j:5,type:1,spell:"HEAL"},{i:3,j:11,type:1,spell:"ROCK"}],enemyData:[{i:4,j:3,id:"monA",canMove:0},{i:3,j:9,id:"monA",canMove:1},{i:3,j:8,id:"monA",canMove:0}],bgColor:"#C6DB80",wallTileSprite:a.MapBushTile},e.shore={isEnd:0,map:[[1,1,1,1,1,1,1,1,1,1,2,1],[1,1,1,1,1,1,1,1,0,0,0,1],[1,1,0,0,0,0,1,0,0,0,1,1],[1,1,0,0,0,0,1,0,0,1,1,1],[1,1,0,1,1,0,0,0,1,1,1,1],[1,1,0,0,1,0,1,0,1,0,1,1],[1,1,0,0,0,0,1,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1]],playerData:{i:5,j:3},itemData:[{i:5,j:9,type:1,spell:"WIND"}],enemyData:[{i:3,j:4,id:"monA",canMove:1},{i:5,j:5,id:"monA",canMove:0},{i:2,j:8,id:"monB",canMove:1},{i:6,j:8,id:"monB",canMove:0}],bgColor:"#20B2AA",wallTileSprite:a.MapStoneTile},e.sky={isEnd:1,map:[[1,1,1,1,1,2,1,1,1,1,1],[1,1,0,0,1,0,1,0,0,1,1],[1,1,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,0,1,0,0,1,1],[1,1,0,0,1,0,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,1,1],[1,1,0,1,1,0,1,1,0,1,1],[1,1,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,0,1,1,1,1,1]],playerData:{i:7,j:5},itemData:[{i:4,j:3,type:1,spell:"SNOW"},{i:2,j:7,type:1,spell:"SPARK"}],enemyData:[{i:1,j:5,id:"boss",canMove:0},{i:4,j:5,id:"monB",canMove:0},{i:6,j:5,id:"monA",canMove:0}],bgColor:"#87CEEB",wallTileSprite:a.MapCloudTile},t.mapData=e,t}((o=function(t){let e={};return e.monA={name:"Monster A",hp:15,def:0,atk:10,moveList:["pulse"],sprite:r.MonsterA},e.monB={name:"Monster B",hp:20,def:10,atk:10,moveList:["pulse"],sprite:r.MonsterB},e.boss={name:"Boss",hp:50,def:10,atk:12,moveList:["pulse","ice"],sprite:r.MonsterBoss},t.enemyData=e,t}(o||{}))||{}))||{}),n=((t=o||{}).GameDataManager=class{constructor(){this.playerInfo=null,this.levelPassed=[],this.firstInit()}firstInit(){let t=new o.PlayerInfo;t.name="You",t.maxhp=30,t.hp=30,t.atk=10,t.learnSpell("ice"),t.learnSpell("fire"),t.learnSpell("leaf"),this.loadPlayerInfo(t)}loadPlayerInfo(t){this.playerInfo=t}},o=t,r=function(t){return t.BattleField=class{constructor(t){this.fieldWidth=t,this.mainCharacter=null,this.opponentSide=[],this.opponentSideInfo=[],this.startPlayerTurn=null,this.startOpponentTurn=null}addPlayer(t){t.setPos(this.fieldWidth/4,250-t.height),t.showHpBar(1),this.mainCharacter=t}loadOpponentData(t){}addOpponent(t,e){t.setPos(this.fieldWidth/4*3,250-t.height),t.showHpBar(1),this.opponentSide.push(t),this.opponentSideInfo.push(e)}registerTurnCallback(t,e,i){this.startPlayerTurn=e.bind(t),this.startOpponentTurn=i.bind(t)}playerCastSpell(t){if(null!==t){let e=r.moveLibrary[t.toLowerCase()];if(void 0!==e){let t=this.opponentSide[0];this.mainCharacter.useMove(e,t)}}setTimeout(()=>{this.startOpponentTurn(),this.opponentMove()},1e3)}opponentMove(){let t=this.mainCharacter;for(let e=0;e<this.opponentSide.length;e++){const i=this.opponentSide[e],s=this.opponentSideInfo[e];let h=Math.floor(Math.random()*s.moveList.length),a=r.moveLibrary[s.moveList[h]];i.isDefeated()||setTimeout(()=>{i.useMove(a,t)},1e3*e)}setTimeout(()=>{this.startPlayerTurn()},1e3*this.opponentSide.length)}isOpponentDefeated(){return this.opponentSide.every(t=>t.isDefeated())}isPlayerDefeated(){return this.mainCharacter.isDefeated()}},t}((r=function(t){let e={},i={};e.pulse={name:"pulse",moveType:r.MOVE_TYPE.ATTACK,power:2,moveSprite:s.Pulse},e.ice={name:"ice",moveType:r.MOVE_TYPE.ATTACK,power:5,moveSprite:s.Ice},e.leaf={name:"leaf",moveType:r.MOVE_TYPE.ATTACK,power:8,moveSprite:s.Leaf},e.fire={name:"fire",moveType:r.MOVE_TYPE.ATTACK,power:10,moveSprite:s.Fire},e.rock={name:"rock",moveType:r.MOVE_TYPE.ATTACK,power:15,moveSprite:s.Rock},e.wind={name:"wind",moveType:r.MOVE_TYPE.ATTACK,power:15,moveSprite:s.Wind},e.snow={name:"snow",moveType:r.MOVE_TYPE.ATTACK,power:18,moveSprite:s.Snow},e.spark={name:"spark",moveType:r.MOVE_TYPE.ATTACK,power:25,moveSprite:s.Spark},e.heal={name:"heal",moveType:r.MOVE_TYPE.HEAL,healAmount:10,moveSprite:s.Ice};for(const t in e)if(e.hasOwnProperty(t)){const s=e[t];let h=new r.Move(s.name);h.moveType=s.moveType,h.power=s.power,h.healAmount=s.healAmount,h.moveSprite=s.moveSprite,i[s.name]=h}return t.moveLibrary=i,t}(r||{}))||{}),function(t){let i=10,r={commandPlayerMove:function(t,e){this.pauseInput(),this.mapBoard.startTurn(t,e)},commandEncounter:function(e){setTimeout(()=>{this.pushScene(new t.BattleScene(this.parentGame,e))},200)},commandLeave:function(){setTimeout(()=>{this.mapData.isEnd?this.pushScene(new t.EndScene(this.parentGame)):this.backScene()},500)}},l=function(t){if(t.preventDefault(),this.hasUserInput=1,this.isAllowInput)switch(t.code){case"ArrowLeft":r.commandPlayerMove.call(this,0,-1);break;case"ArrowRight":r.commandPlayerMove.call(this,0,1);break;case"ArrowUp":r.commandPlayerMove.call(this,-1,0);break;case"ArrowDown":r.commandPlayerMove.call(this,1,0)}};class c{constructor(t,e,i){this.mapSprite=new s.Sprite(t,e),this.map=i.map,this.rowCount=this.map.length,this.colCount=this.map[0].length;for(let t=0;t<this.map.length;t++){const e=this.map[t];for(let s=0;s<e.length;s++){let h;switch(e[s]){case 0:break;case 1:h=new i.wallTileSprite(t,s);break;case 2:h=new a.MapGoalTile(t,s)}void 0!==h&&this.mapSprite.addSubSprite(h)}}this.mapItemList=[],this.mapEnemyList=[];for(let t=0;t<i.itemData.length;t++){const e=new a.MapItemBox(i.itemData[t]);this.mapItemList.push(e),this.mapSprite.addSubSprite(e)}for(let t=0;t<i.enemyData.length;t++){const e=new a.MapEnemy(i.enemyData[t]);this.mapEnemyList.push(e),this.mapSprite.addSubSprite(e)}this.mapPlayer=new a.MapPlayer(i.playerData),this.mapSprite.addSubSprite(this.mapPlayer),this.encounterCallback=null,this.completeCallback=null,this.startTurnCallback=null,this.pickUpCallback=null}centerItself(t,e){let i=this.mapSprite.width,s=this.mapSprite.height;this.mapSprite.x=(t-i)/2,this.mapSprite.y=(e-s)/2}startTurn(t,e){let i=0,s=0;if(this.canMapActorMove(this.mapPlayer,t,e)){if(this.mapPlayer.moveBy(t,e),s=this.isAtGoal(this.mapPlayer))return void this.completeCallback();if(i=this.tryEncounter())return;let h=this.tryPickUp();h&&(this.pickUpCallback(h),this.removeItem(h)),this.enemyTurnMove(),this.tryEncounter()}this.startTurnCallback()}isAtGoal(t){return 2===this.map[t.i][t.j]}tryEncounter(){let t=null;for(let e=0;e<this.mapEnemyList.length;e++){const i=this.mapEnemyList[e];if(i.i===this.mapPlayer.i&&i.j===this.mapPlayer.j){t=i;break}}return null!==t&&null!==this.encounterCallback?(this.encounterCallback(t),1):0}tryPickUp(){let t=null;for(let e=0;e<this.mapItemList.length;e++){const i=this.mapItemList[e];if(i.i===this.mapPlayer.i&&i.j===this.mapPlayer.j){t=i;break}}return t}registerCallback(){}removeEnemy(t){t.setVisible(0);let e=this.mapEnemyList.indexOf(t);this.mapEnemyList.splice(e,1)}removeItem(t){t.setVisible(0);let e=this.mapItemList.indexOf(t);this.mapItemList.splice(e,1)}enemyTurnMove(){for(let t=0;t<this.mapEnemyList.length;t++){const e=this.mapEnemyList[t];if(e.canMove){let t,i;switch(Math.floor(4*Math.random())){case 0:[t,i]=[1,0];break;case 1:[t,i]=[-1,0];break;case 2:[t,i]=[0,1];break;case 3:[t,i]=[0,-1]}this.canMapActorMove(e,t,i)&&e.moveBy(t,i)}}}canMapActorMove(t,e,i){let s=t.i+e,h=t.j+i;return s<0||s>=this.rowCount?0:h<0||h>=this.colCount?0:1!==this.map[s][h]}}return t.MapScene=class extends n.Scene{constructor(t,e){super(t);let a=o.mapData[e];this.mapData=a,this.setBg(a.bgColor);let n=i;this.statusBar=new h.StyleBox(n,n,this.width-2*n),this.addSpriteToLayer(this.layerData.layerBackground,this.statusBar);let d=new s.Sprite(0,this.statusBar.height),p=new c(0,0,a);p.centerItself(this.width,this.height-this.statusBar.height),d.addSubSprite(p.mapSprite),this.addSpriteToLayer(this.layerData.layerBackground,d),p.encounterCallback=r.commandEncounter.bind(this),p.completeCallback=r.commandLeave.bind(this),p.startTurnCallback=this.resumeInput.bind(this),p.pickUpCallback=this.pickup.bind(this),this.mapBoard=p,this.setEventListener("keydown",l)}resume(){super.resume(),this.updateInfoBar()}updateInfoBar(){let t=this.gameDataManager.playerInfo;this.statusBar.setText(e("HP: %d/%d | ATK: %d | DEF: %d",t.hp,t.maxhp,t.atk,t.def))}removeEnemy(t){this.mapBoard.removeEnemy(t)}pickup(t){if(1===t.type){let i=this.gameDataManager.playerInfo.learnSpell(t.spell);this.toast(i?e('Found the "%s" scroll.',t.spell):"Learnt already.")}}},t}((n=function(t){let e={canvasBGColor1:"#FFFFAA",creditLabel:{width:300,textColor:"#333333",fontSize:30,scrollTime:3e3,message:["Congratulations!","You have completed all levels.","","Thank you for playing!",""," - End - "]},toastMessage:"Press any key to return."},i={commandBackToTitle:function(){this.backSceneTillOne()}},a=function(t){if(t.preventDefault(),this.hasUserInput=1,this.isAllowInput)switch(t.code){case"Space":case"Enter":i.commandBackToTitle.call(this)}};return t.EndScene=class extends n.Scene{constructor(t){super(t),this.setBg(e.canvasBGColor1);let i=(this.width-e.creditLabel.width)/2,r=new h.TextBlock(i,1.5*this.height,e.creditLabel.width,0);for(let t=0;t<e.creditLabel.message.length;t++)r.setText(e.creditLabel.message[t],t);r.setFontSize(e.creditLabel.fontSize),r.setTextCenter(),this.addSpriteToLayer(this.layerData.layerUI,r),r.addBehaviorWithDelay(s.EaseInOutBehavior,"y",-this.height,e.creditLabel.scrollTime),r.addBehaviorWithDelay(s.EaseInOutBehavior,"y",-this.height,e.creditLabel.scrollTime,1.5*e.creditLabel.scrollTime),setTimeout((()=>{this.toast(e.toastMessage),this.setEventListener("keydown",a)}).bind(this),3*e.creditLabel.scrollTime)}},t}((n=function(t){let e=10,i=10,s=50,a=100,l=10,c=295,d="Spell",p="Shuffle",u="Book",m=1e3,x=-200,f="Your Turn.",y="You are defeated. Press Enter to return.",g={commandTextCursorLeft:function(){this.spellBox.indicatorToLeft()},commandTextCursorRight:function(){this.spellBox.indicatorToRight()},commandBackspace:function(){this.spellBox.backspace()},commandSpell:function(){let t=this.spellBox.castSpell();this.battleField.playerCastSpell(t),null!==t&&(this.usedSpellBox.setAndFitContent(t),this.usedSpellBox.x=this.width-e-this.usedSpellBox.width,this.usedSpellBox.setVisible(1),this.usedSpellBox.opacity=0,this.usedSpellBox.setFadeIn(0,0,m/2,0,x),setTimeout(()=>{this.usedSpellBox.setVisible(0)},m)),this.inactiveWhenPlayerMove()},commandBack:function(){this.gameDataManager.playerInfo.updateHp(this.player),this.gameDataManager.playerInfo.statIncrease(),this.backScene(),this.parentGame.currentScene.removeEnemy(this.mapEnemy)},commandBackToTitle:function(){this.backSceneTillOne()}},S=function(t){if(t.preventDefault(),this.hasUserInput=1,this.isAllowInput)switch(t.code){case"ArrowUp":this.textChoiceBox.choiceUp();break;case"ArrowDown":this.textChoiceBox.choiceDown();break;case"Space":case"Enter":switch(this.textChoiceBox.getChoice()){case d:this.optionSpell();break;case p:this.optionShuffle();break;case u:this.optionBook()}}},w=function(t){if(t.preventDefault(),this.hasUserInput=1,this.isAllowInput)switch(t.code){case"ArrowLeft":g.commandTextCursorLeft.call(this),this.pauseInput(100);break;case"ArrowRight":g.commandTextCursorRight.call(this),this.pauseInput(100);break;case"Backspace":case"KeyZ":g.commandBackspace.call(this),this.pauseInput(100);break;case"Space":case"Enter":g.commandSpell.call(this),this.pauseInput()}},b=function(t){if(t.preventDefault(),this.hasUserInput=1,this.isAllowInput)switch(t.code){case"Space":case"Enter":g.commandBackToTitle.call(this)}};return t.BattleScene=class extends n.Scene{constructor(t,n){super(t),this.setBg("#FFFF99"),this.mapEnemy=n;let m=this.gameDataManager.playerInfo;this.spellBox=new h.SpellBox(e,this.canvas.height-s-i,this.canvas.width-4*e-a,s),this.spellBox.setSpell(m.moveList),this.spellBox.initText(),this.spellBox.fitMax(),this.addSpriteToLayer(this.layerData.layerUI,this.spellBox),this.comingLetterBox=new h.ComingLetterBox(this.canvas.width-a-1*e,this.spellBox.y,a,this.spellBox.height),this.comingLetterBox.setSpell(m.moveList),this.comingLetterBox.shuffle(),this.addSpriteToLayer(this.layerData.layerUI,this.comingLetterBox),this.usedSpellBox=new h.StyleBox(100,this.canvas.height-2*s-3*i,0,this.spellBox.height),this.addSpriteToLayer(this.layerData.layerUI,this.usedSpellBox);let x=new r.MainCharacter(0,0);this.player=new r.BattleActor(0,0,x),this.player.loadInfo(this.gameDataManager.playerInfo);let f=o.enemyData[n.enemyId],y=new f.sprite(0,0),g=new o.ActorInfo;g.loadData(f),this.monster=new r.BattleActor(0,0,y),this.monster.loadInfo(g),this.addSpriteToLayer(this.layerData.layerMain1,this.player),this.addSpriteToLayer(this.layerData.layerMain1,this.monster);let w=new r.BattleField(this.width);w.addPlayer(this.player),w.addOpponent(this.monster,g),w.registerTurnCallback(this,this.startPlayerTurn,this.startEnemyTurn),this.battleField=w,this.textChoiceBox=new h.ChoiceBox(l,c),this.textChoiceBox.addChoice(d),this.textChoiceBox.addChoice(p),this.textChoiceBox.addChoice(u),this.addSpriteToLayer(this.layerData.layerUI,this.textChoiceBox),this.setEventListener("keydown",S)}optionSpell(){this.setEventListener("keydown",w),this.spellBox.appendContent(this.comingLetterBox.content),this.comingLetterBox.setText(""),this.textChoiceBox.setLookDisabled(1),this.spellBox.setLookDisabled(0)}optionShuffle(){this.comingLetterBox.shuffle()}optionBook(){this.toast(this.gameDataManager.playerInfo.moveList.join(", "))}inactiveWhenPlayerMove(){this.textChoiceBox.setLookDisabled(1),this.spellBox.setLookDisabled(1),this.pauseInput()}startEnemyTurn(){}startPlayerTurn(){this.battleField.isOpponentDefeated()?g.commandBack.bind(this)():this.battleField.isPlayerDefeated()?(this.toast(y),this.allowInput(),this.setEventListener("keydown",b)):(this.toast(f),this.textChoiceBox.setLookDisabled(0),this.spellBox.setLookDisabled(1),this.comingLetterBox.shuffle(),this.allowInput(),this.setEventListener("keydown",S))}},t}((n=function(t){let e={canvasBGColor1:"#FF9999",titleLabel:{x:50,y:50,width:600,height:150,textColor:"#000000",fontSize:60,text:["Backspace","Magic"]},choiceBox:{x:230,y:280,choicesMain:["Go!","Status"],choicesGo:["1. Bushy Green","2. Rocky Shore","3. Fluffy Blue"],choicesGoValue:["plain","shore","sky"],backChoice:"Back",transitionTime:800},character:{x:70,y:280},statusBox:{margin:10}},i={commandChoiceUp:function(){this.currentChoiceBox.choiceUp()},commandChoiceDown:function(){this.currentChoiceBox.choiceDown()},commandStart:function(){let i=this.currentChoiceBox.getChoice(),s=this.currentChoiceBox.getChoiceValue();if(this.currentChoiceBox===this.mainChoiceBox)switch(i){case e.choiceBox.choicesMain[0]:this.switchChoiceBox(this.goChoiceBox);break;case e.choiceBox.choicesMain[1]:this.switchChoiceBox(this.statusChoiceBox),this.showStatus(1)}else this.currentChoiceBox===this.goChoiceBox?i===e.choiceBox.backChoice?this.switchChoiceBox(this.mainChoiceBox,1):this.pushScene(new t.MapScene(this.parentGame,s)):this.currentChoiceBox===this.statusChoiceBox&&(this.switchChoiceBox(this.mainChoiceBox,1),this.showStatus(0))}},a=function(t){if(t.preventDefault(),this.hasUserInput=1,this.isAllowInput)switch(t.code){case"ArrowUp":i.commandChoiceUp.call(this),this.pauseInput(100);break;case"ArrowDown":i.commandChoiceDown.call(this),this.pauseInput(100);break;case"Space":case"Enter":i.commandStart.call(this),this.pauseInput(e.choiceBox.transitionTime)}};return t.TitleScene=class extends n.Scene{constructor(t){super(t),this.setBg(e.canvasBGColor1);let i=new s.Rect(50,-20,this.canvas.width,this.canvas.height,"rgba(255, 255, 255, 0.2)");i.rotateAngle=30,this.addSpriteToLayer(this.layerData.layerBackground,i);let o=new h.TextBlock(e.titleLabel.x,e.titleLabel.y,e.titleLabel.width,e.titleLabel.height);o.setAllText(e.titleLabel.text[0],e.titleLabel.text[1]),o.setTextColor(e.titleLabel.textColor),o.setFontSize(e.titleLabel.fontSize),this.addSpriteToLayer(this.layerData.layerUI,o);let n=new h.ChoiceBox(e.choiceBox.x,e.choiceBox.y);e.choiceBox.choicesMain.forEach(t=>{n.addChoice(t)}),this.addSpriteToLayer(this.layerData.layerUI,n),this.mainChoiceBox=n;let l=new h.ChoiceBox(e.choiceBox.x,e.choiceBox.y);l.width=300;for(let t=0;t<e.choiceBox.choicesGo.length;t++)l.addChoice(e.choiceBox.choicesGo[t],e.choiceBox.choicesGoValue[t]);l.addChoice(e.choiceBox.backChoice),this.addSpriteToLayer(this.layerData.layerUI,l),this.goChoiceBox=l;let c=new h.ChoiceBox(e.choiceBox.x,e.choiceBox.y);c.addChoice(e.choiceBox.backChoice),this.addSpriteToLayer(this.layerData.layerUI,c),this.statusChoiceBox=c,this.currentChoiceBox=n,this.choiceBoxList=[],this.choiceBoxList.push(n),this.choiceBoxList.push(l),this.choiceBoxList.push(c);for(let t=1;t<this.choiceBoxList.length;t++)this.choiceBoxList[t].setVisible(0);this.currentChoiceIndex=0,this.statBox=new h.StyleBox(0,40,0,110,0),this.learntSpellBox=new h.StyleBox(0,170,0,290,0),this.updateStatusBox();let d=[];d.push(this.statBox),d.push(this.learntSpellBox);for(let t=0;t<d.length;t++){const i=d[t];i.maxLength=7,i.fitMax(),i.x=this.width-i.width-e.statusBox.margin,i.setVisible(0),this.addSpriteToLayer(this.layerData.layerUI,i)}this.statusBoxList=d;let p=new r.MainCharacter(e.character.x,e.character.y);this.addSpriteToLayer(this.layerData.layerMain1,p),o.opacity=0,o.setFadeIn(0,0,1e3,200,0),p.opacity=0,p.setFadeIn(0,500,1e3,0,-200),this.setEventListener("keydown",a)}resume(){super.resume(),this.gameDataManager.playerInfo.recover(),this.updateStatusBox(),this.switchChoiceBox(this.mainChoiceBox)}updateStatusBox(){let t=this.gameDataManager.playerInfo;this.statBox.setText(" HP: "+t.hp,0),this.statBox.setText("ATK: "+t.atk,1),this.statBox.setText("DEF: "+t.def,2),this.learntSpellBox.setText("Spell:",0);for(let e=0;e<t.moveList.length;e++){const i=t.moveList[e];this.learntSpellBox.setText(i,e+1)}}switchChoiceBox(t){this.currentChoiceBox.setVisible(0),t.setVisible(1),t.opacity=0,t.setFadeIn(0,0,e.choiceBox.transitionTime,-100,0),this.currentChoiceBox=t}showStatus(t){for(let i=0;i<this.statusBoxList.length;i++){const s=this.statusBoxList[i];s.setVisible(t),t&&(s.opacity=0,s.setFadeIn(0,0,e.choiceBox.transitionTime,-100,0))}}},t}((n=function(){let t=400,e=1,i=.2,a=10,r=500,o=100;return{Scene:class{constructor(t){this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d"),this.eventListeners=[],this.layerData={layerBackground:new s.Sprite(0,0),layerMain1:new s.Sprite(0,0),layerMain2:new s.Sprite(0,0),layerUI:new s.Sprite(0,0)},this.layerList=[],this.layerList.push(this.layerData.layerBackground),this.layerList.push(this.layerData.layerMain1),this.layerList.push(this.layerData.layerMain2),this.layerList.push(this.layerData.layerUI),this.layerUpdateList=[];for(let t=0;t<this.layerList.length;t++)this.layerUpdateList.push(0);this.hasUserInput=0,this.onlyDrawIfUpdate=1,this.width=this.canvas.width,this.height=this.canvas.height,this.opacity=e,this.darkCurtainOpacity=0,this.isTransitionIn=0,this.isTransitionOut=0,this.isRunning=0,this.isAllowInput=0,this.parentGame=t,this.gameDataManager=this.parentGame.gameDataManager,this.currentListeners={keydown:{}},this.setEventListener("keydown",null),this.bgm=null}setBg(t){let e=new s.Rect(0,0,this.canvas.width,this.canvas.height,t);this.addSpriteToLayer(this.layerData.layerBackground,e)}changeScene(t){this.parentGame.changeScene(t)}pushScene(t){this.parentGame.pushScene(t)}backScene(){this.parentGame.backScene()}backSceneTillOne(){this.parentGame.backSceneTillOne()}draw(){if(this.onlyDrawIfUpdate){let t=this.hasUserInput;if(this.hasUserInput=0,this.layerUpdateList.every(t=>0==t)&&!t&&this.darkCurtainOpacity<=0)return}this.ctx.save(),this.ctx.globalAlpha=this.opacity;let t=this.layerList.length;for(let e=0;e<t;e++)this.layerList[e].draw(this.ctx);this.darkCurtainOpacity>0&&(this.ctx.fillStyle=`rgba(100, 100, 100, ${this.darkCurtainOpacity})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)),this.ctx.restore()}update(t){let e=this.layerList.length;for(let i=0;i<e;i++){const e=this.layerList[i];this.layerUpdateList[i]=e.update(t)}this.isTransitionIn&&this.fadeIn(t)}startFadeIn(){this.darkCurtainOpacity=i,this.isTransitionIn=1}fadeIn(e){this.elapsedTime||(this.elapsedTime=0),this.elapsedTime<t?(this.elapsedTime+=e,this.darkCurtainOpacity=i*(1-this.elapsedTime/t)):(this.elapsedTime=0,this.darkCurtainOpacity=0,this.isTransitionIn=0)}toast(t="",e=0,i=1500){let s=new h.StyleBox(a,a,this.width-2*a);this.addSpriteToLayer(this.layerData.layerUI,s),s.opacity=0,s.setFontSize(20),s.setText(t),s.setFadeIn(0,e,r,0,o),setTimeout((()=>{s.setVisible(0),this.layerData.layerUI.removeSubSprite(s)}).bind(this),i)}pause(t=0){this.clearEventListeners(),this.pauseInput(),t||(this.isRunning=0)}resume(){this.isRunning=1,this.reAddEventListeners(),this.allowInput()}clearLayer(t){t.clear()}addSpriteToLayer(t,e){return t.addSubSprite(e),1}addSpriteListToLayer(t,e){let i;for(i=0;i<e.length;i++)t.addSubSprite(e[i]);return 1}setLayerOrigin(t,e,i){return t.x=e,t.y=i,1}pauseInput(t){this.isAllowInput=0,void 0!==t&&setTimeout(function(){this.isAllowInput=1}.bind(this),t)}resumeInput(){this.isAllowInput=1}allowInput(t=0){setTimeout(function(){this.isAllowInput=1,this.hasUserInput=1}.bind(this),t)}setEventListener(t,e){this.currentListeners.hasOwnProperty(t)||(this.currentListeners[t]={}),e&&this.currentListeners[t]!==e&&(this.canvas.removeEventListener(t,this.currentListeners[t]),this.currentListeners[t]=e.bind(this),this.canvas.addEventListener(t,this.currentListeners[t]))}reAddEventListeners(){for(let t in this.currentListeners)this.currentListeners.hasOwnProperty(t)&&this.canvas.addEventListener(t,this.currentListeners[t])}clearEventListeners(){for(let t in this.currentListeners)this.currentListeners.hasOwnProperty(t)&&this.canvas.removeEventListener(t,this.currentListeners[t])}}}}())||{}))||{}))||{}))||{})),l=function(t){let e=function(t,e=1){t.resume(),e&&t.startFadeIn()};return t.TheGame=class extends class{constructor(t){this.canvas=t,this.isSceneLoaded=0,this.gameDataManager=new o.GameDataManager}startGameLoop(){this.isSceneLoaded||this.loadScenes();let t=function(t){let e=0;return function i(s){let h=s-e;e=s,null!==t.currentScene&&(t.currentScene.update(h),t.currentScene.draw()),null!==t.modalScene&&(t.modalScene.update(h),t.modalScene.draw()),requestAnimationFrame(i)}}(this);requestAnimationFrame(t)}loadScenes(){this.sceneStack=[],this.currentScene=null,this.modalScene=null,this.isSceneLoaded=1}changeScene(t){this.backScene(),this.pushScene(t)}pushScene(t){this.currentScene&&this.currentScene.pause(),this.currentScene=t,this.sceneStack.push(t),e(this.currentScene)}backScene(){this.currentScene.pause(),this.sceneStack.pop(),0===this.sceneStack.length?this.currentScene=null:(this.currentScene=this.sceneStack[this.sceneStack.length-1],e(this.currentScene))}backSceneTillOne(){for(;this.sceneStack.length>1;)this.backScene()}setCanvasConfig(t){this.canvas&&(t.canvasWidth&&this.canvas.setAttribute("width",t.canvasWidth),t.canvasHeight&&this.canvas.setAttribute("height",t.canvasHeight))}}{constructor(t){super(t)}loadScenes(){super.loadScenes(),this.pushScene(new n.TitleScene(this))}},t}(l||{});let c=document.getElementById("main_game"),d=new l.TheGame(c);d.setCanvasConfig({canvasWidth:600,canvasHeight:480}),d.startGameLoop();