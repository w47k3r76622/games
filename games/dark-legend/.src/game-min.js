function Light(e,t,n,r){this.position=n;this.radius=t;this.brightness=r;this.targetBrightness=r;this.fadeSpeed=0;this.ctx=e;this.rotation=0;this.isFlashLight=true;this.draw=function(){if(this.brightness<this.targetBrightness)this.brightness+=this.fadeSpeed;else if(this.brightness>this.targetBrightness)this.brightness-=this.fadeSpeed;else this.brightness=this.targetBrightness;if(this.isFlashLight){this.ctx.save();this.ctx.globalCompositeOperation="destination-out";this.ctx.globalAlpha=this.brightness;this.ctx.translate(this.position.x+screenOffset.x,this.position.y+screenOffset.y);this.ctx.rotate(this.rotation);this.ctx.drawImage(flashLightImage,0,0,128,128,0,-tileSize*2,tileSize*4,tileSize*4);this.ctx.globalCompositeOperation="source-over";this.ctx.globalAlpha=1;this.ctx.restore()}else{var e=this.ctx.createRadialGradient(this.position.x+screenOffset.x,this.position.y+screenOffset.y,this.radius,this.position.x+screenOffset.x,this.position.y+screenOffset.y,0);darknessCtx.globalCompositeOperation="destination-out";e.addColorStop(1,"#000");e.addColorStop(0,"transparent");this.ctx.fillStyle=e;this.ctx.globalAlpha=this.brightness;this.ctx.fillRect(0,0,640,480);this.ctx.globalAlpha=1;darknessCtx.globalCompositeOperation="source-over"}};this.place=function(e,t){this.position.x=e;this.position.y=t};this.adjustBrightness=function(e,t){this.targetBrightness=e;this.fadeSpeed=t};this.isAdjusting=function(){return this.brightness==this.targetBrightness}}function Player(){that=this;this.isMoving=false;this.position={x:tileSize,y:tileSize};this.frame=0;this.moveSpeed=Math.ceil(tileSize/5);this.keys={left:false,right:false,up:false,down:false};this.flashlight=new Light(darknessCtx,100,{x:0,y:0},.5);this.flashlight.adjustBrightness(1,.01);this.flashlightActive=false;this.flashlightBattery=100;this.eyeAdjustment=0;this.mousePos={x:0,y:0};this.rotation=0;this.torches=new Array;this.update=function(){if(this.keys.up==true)this.move(0,-this.moveSpeed);if(this.keys.left==true)this.move(-this.moveSpeed,0);if(this.keys.down==true)this.move(0,this.moveSpeed);if(this.keys.right==true)this.move(this.moveSpeed,0);if(this.flashlightActive){this.flashlightBattery-=.05;this.eyeAdjustment=0}else if(this.eyeAdjustment<.2)this.eyeAdjustment+=.005;if(this.flashlightBattery<=0){this.flashlightActive=false;gameState="death"}this.flashlight.place(this.position.x+tileSize/2,this.position.y+tileSize/2);this.flashlight.rotation=this.rotation;this.rotation=Math.atan2(this.mousePos.x-screenOffset.x-this.position.x,this.position.y-this.mousePos.y+screenOffset.y)-3.14/2};this.draw=function(){var e=gameCtx;if(this.flashlightActive)e=darknessCtx;e.save();e.translate(this.position.x+screenOffset.x+tileSize/2,this.position.y+screenOffset.y+tileSize/2);e.rotate(this.rotation);e.drawImage(charactersImage,0,0,16,16,-tileSize/2,-tileSize/2,tileSize,tileSize);e.restore();if(this.flashlightActive)this.flashlight.draw();if(this.torches.length!=0){for(var t=0;t<this.torches.length;t++)this.torches[t].draw()}};this.move=function(e,t){this.position.x+=e;this.position.y+=t;var n=Math.floor(this.position.x/tileSize);var r=Math.floor(this.position.y/tileSize);var i=this.position.x%tileSize;var s=this.position.y%tileSize;if(e>0){if(unPassibleTiles.contains(mapArray[r][n+1])&&!unPassibleTiles.contains(mapArray[r][n])||unPassibleTiles.contains(mapArray[r+1][n+1])&&!unPassibleTiles.contains(mapArray[r+1][n])&&s){this.position.x=n*tileSize}}if(e<0){if(!unPassibleTiles.contains(mapArray[r][n+1])&&unPassibleTiles.contains(mapArray[r][n])||!unPassibleTiles.contains(mapArray[r+1][n+1])&&unPassibleTiles.contains(mapArray[r+1][n])&&s){this.position.x=(n+1)*tileSize}}var n=Math.floor(this.position.x/tileSize);var r=Math.floor(this.position.y/tileSize);var i=this.position.x%tileSize;var s=this.position.y%tileSize;if(t>0){if(unPassibleTiles.contains(mapArray[r+1][n])&&!unPassibleTiles.contains(mapArray[r][n])||unPassibleTiles.contains(mapArray[r+1][n+1])&&!unPassibleTiles.contains(mapArray[r][n+1])&&i){this.position.y=r*tileSize}}if(t<0){if(!unPassibleTiles.contains(mapArray[r+1][n])&&unPassibleTiles.contains(mapArray[r][n])||!unPassibleTiles.contains(mapArray[r+1][n+1])&&unPassibleTiles.contains(mapArray[r][n+1])&&i){this.position.y=(r+1)*tileSize}}if(this.position.x+screenOffset.x+tileSize>gameCanvas.width)screenOffset.x-=this.moveSpeed;if(this.position.x+screenOffset.x<0)screenOffset.x+=this.moveSpeed;if(this.position.y+screenOffset.y+tileSize>gameCanvas.height)screenOffset.y-=this.moveSpeed;if(this.position.y+screenOffset.y<0)screenOffset.y+=this.moveSpeed};this.handleKeyPressed=function(e){switch(String.fromCharCode(e.keyCode)){case"W":that.keys.up=true;break;case"A":that.keys.left=true;break;case"S":that.keys.down=true;break;case"D":that.keys.right=true;break}};this.handleKeyReleased=function(e){switch(String.fromCharCode(e.keyCode)){case"W":that.keys.up=false;break;case"A":that.keys.left=false;break;case"S":that.keys.down=false;break;case"D":that.keys.right=false;break;case"F":if(that.flashlightBattery>0)that.flashlightActive=!that.flashlightActive;break;case"T":if(that.torches.length<10){var t={x:0,y:0};t.x=that.position.x;t.y=that.position.y;var n=new Light(darknessCtx,100,t,1);n.isFlashLight=false;n.adjustBrightness(.01,.005);that.torches.push(n)}break}};this.reset=function(){that=this;this.isMoving=false;this.position={x:tileSize,y:tileSize};this.frame=0;this.moveSpeed=Math.ceil(tileSize/5);this.keys={left:false,right:false,up:false,down:false};this.flashlight=new Light(darknessCtx,100,{x:0,y:0},.5);this.flashlight.adjustBrightness(1,.01);this.flashlightActive=false;this.flashlightBattery=100;this.eyeAdjustment=0;this.mousePos={x:0,y:0};this.rotation=0;this.torches.length=0;screenOffset.x=0;screenOffset.y=0};darknessCanvas.addEventListener("mousemove",function(e){var t=getMousePos(darknessCanvas,e);player.mousePos=t},false);document.addEventListener("keydown",this.handleKeyPressed,false);document.addEventListener("keyup",this.handleKeyReleased,false)}function Enemy(e){this.type=e;this.position={x:0,y:0};this.health=50;this.burstTimer=Math.random()*10;this.moveTimer=0;this.update=function(){if(this.position.x+screenOffset.x<gameCanvas.width&&this.position.y+screenOffset.y<gameCanvas.height){var e=darknessCtx.getImageData(this.position.x+screenOffset.x,this.position.y+screenOffset.y,tileSize,tileSize);for(var t=0;t<e.data.length;t+=4){if(e.data[t+3]<200&&e.data[t+3]>0)this.health-=.001}}if(this.health<0){this.position.x=Math.random()*mapArray[0].length*tileSize;this.position.y=Math.random()*mapArray.length*tileSize;this.health=50;score+=10}this.burstTimer-=.1;if(this.burstTimer<0){this.burstTimer=Math.random()*10;this.moveTimer=10}if(this.moveTimer>0){var n={x:0,y:0};n.x=this.position.x;n.y=this.position.y;if(this.position.x<player.position.x)this.position.x+=2;if(this.position.x>player.position.x)this.position.x-=2;if(this.position.y<player.position.y)this.position.y+=2;if(this.position.y>player.position.y)this.position.y-=2;this.rotation=Math.atan2(this.position.x-n.x,n.y-this.position.y)-3.14/2;this.moveTimer-=1}if(Math.abs(this.position.x-player.position.x)*2<tileSize*2&&Math.abs(this.position.y-player.position.y)*2<tileSize*2){this.position.x=Math.random()*mapArray[0].length*tileSize;this.position.y=Math.random()*mapArray.length*tileSize;this.health=50;score-=10}};this.draw=function(){gameCtx.globalAlpha=this.health/50;gameCtx.save();gameCtx.translate(this.position.x+screenOffset.x+tileSize/2,this.position.y+screenOffset.y+tileSize/2);gameCtx.rotate(this.rotation);gameCtx.drawImage(monstersImage,0,0,16,16,-tileSize/2,-tileSize/2,tileSize,tileSize);gameCtx.restore();gameCtx.globalAlpha=1}}function start(){player.reset();score=0;gameState="play";enemies.length=0;for(var e=0;e<10;e++){var t=new Enemy;t.position.x=Math.random()*mapArray[0].length*tileSize;t.position.y=Math.random()*mapArray.length*tileSize;enemies.push(t)}}function update(){if(gameState=="play"){player.update();for(var e=0;e<enemies.length;e++)if(enemies[e]!=null)enemies[e].update()}}function draw(){if(gameState=="menu"){darknessCanvas.width=darknessCanvas.width;darknessCtx.fillStyle="black";darknessCtx.fillRect(0,0,darknessCanvas.width,darknessCanvas.height);darknessCtx.fillStyle="white";darknessCtx.font="20px Courier New";darknessCtx.fillText("Hit Enter To Start",240,240)}if(gameState=="death"){darknessCanvas.width=darknessCanvas.width;darknessCtx.fillStyle="black";darknessCtx.fillRect(0,0,darknessCanvas.width,darknessCanvas.height);darknessCtx.fillStyle="white";darknessCtx.font="20px Courier New";darknessCtx.fillText("Score: "+score,150,280);darknessCtx.fillText("Game Over... Hit Enter To Start",150,240)}if(gameState=="play"){darknessCanvas.width=darknessCanvas.width;darknessCtx.fillStyle="rgba(0, 0, 0, "+(1-player.eyeAdjustment)+")";darknessCtx.fillRect(0,0,darknessCanvas.width,darknessCanvas.height);darknessCtx.fillStyle="white";darknessCtx.font="20px Courier New";darknessCtx.fillText("Score: "+score+"  Flashlight Battery: "+Math.floor(player.flashlightBattery)+" Torches Left: "+(10-player.torches.length),10,20);for(var e=0;e<mapArray.length;e++){for(var t=0;t<mapArray[e].length;t++){var n,r;if(mapArray[e][t]==0){n=0;r=0}if(mapArray[e][t]==1){n=1;r=0}if(mapArray[e][t]==3){n=2;r=0}gameCtx.drawImage(tilesImage,16*n,16*r,16,16,t*tileSize+screenOffset.x,e*tileSize+screenOffset.y,tileSize,tileSize)}}player.draw();for(e=0;e<enemies.length;e++)if(enemies[e]!=null)enemies[e].draw()}}function getMousePos(e,t){var n=e.getBoundingClientRect();return{x:t.clientX-n.left,y:t.clientY-n.top}}var gameCanvas=document.getElementById("game");var gameCtx=gameCanvas.getContext("2d");var darknessCanvas=document.getElementById("darkness");var darknessCtx=darknessCanvas.getContext("2d");var tilesImage=new Image;tilesImage.src="img/tiles.png";var charactersImage=new Image;charactersImage.src="img/player.png";var monstersImage=new Image;monstersImage.src="img/monsters.png";var flashLightImage=new Image;flashLightImage.src="img/flashlight.png";tileSize=32;var mapArray=[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,3,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,3,0,0,0,0,3],[3,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,3,0,0,0,0,3],[3,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3,3,3,0,0,3],[3,0,0,0,1,0,3,3,3,0,0,0,0,0,0,1,3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,3,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,1,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,0,0,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,1,0,0,0,0,0,0,0,0,0,0,3,3,0,0,3],[3,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3,0,0,0,3],[3,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,3],[3,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,1,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]];gameCanvas.width=640;gameCanvas.height=480;darknessCanvas.width=gameCanvas.width;darknessCanvas.height=gameCanvas.height;var unPassibleTiles=[-1,3];var screenOffset={x:0,y:0};Array.prototype.contains=function(e){var t=this.length;while(t--){if(this[t]===e){return true}}return false};var score=0;var player=new Player;var enemies=new Array;var gameState="menu";document.addEventListener("keydown",function(e){if(e.keyCode==13&&gameState!="play"){start()}},false);var mainloop=function(){update();draw()};var animFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;var recursiveAnim=function(){mainloop();animFrame(recursiveAnim)};animFrame(recursiveAnim)