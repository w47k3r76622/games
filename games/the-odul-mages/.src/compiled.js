function game(){function e(){if(t(),i(),d.now=(new Date).getTime(),h.fillStyle="black","menu"===m.state)r(n.toUpperCase(),c.x,c.y-50,"center","52px"),r("press [space]",c.x,c.y+20,"center");else if("intro"===m.state)C.g.reduceOffset(k.fast),C.mod.reduceOffset(k.fast),C.w.reduceOffset(k.fast),C.ps1.reduceOffset(k.fast),C.ps2.reduceOffset(k.fast),C.m.reduceOffset(k.med),C.stars.forEach(function(e){e.reduceOffset()}),C.ps1.scrollComplete&&(m.start=!0),m.start&&(m.state="preToss");else if("preToss"===m.state){d.started||(d.elapsed=0,d.start=(new Date).getTime(),d.started=!0),d.elapsed=d.now-d.start;var a="";O.set?a=m.playerOneHealth<100||m.playerTwoHealth<100?O.says[O.index]:"ok. ":(O.index=rnd(0,O.says.length-1),a=m.playerOneHealth<100||m.playerTwoHealth<100?O.says[O.index]:"ok. ",O.set=!0),d.elapsed<1500?r(a+"mage powers are available in...",c.x,c.y,"center"):d.elapsed>=1500&&d.elapsed<2500?(O.set=!1,r("three",c.x,c.y,"center")):d.elapsed>=2500&&d.elapsed<3500?r("two",c.x,c.y,"center"):d.elapsed>=3500&&d.elapsed<4500?r("one",c.x,c.y,"center"):d.elapsed>=4500&&d.elapsed<5500?r("duel!",c.x,c.y,"center"):d.elapsed>=5500&&(m.state="toss",d.started=!1)}else if("toss"===m.state)if(w.getScore()<T&&g.getScore()<T)w.draw(h),g.draw(h),d.start=(new Date).getTime();else{d.started||(d.elapsed=0,d.start=(new Date).getTime(),d.started=!0),d.elapsed=d.now-d.start;var s="";d.elapsed<1500?(s=w.getScore()>=T?"mage one":"mage two",m.tossWinner=w.getScore()>=T?1:2,m.defender=1===m.tossWinner?2:1,C.ball.setPlayer(m.tossWinner),s+=" has the power"):s=d.elapsed<3e3?"choose your attack":null,null!==s?r(s,c.x,c.y,"center"):(m.state="attackSelection",d.started=!1)}else if("attackSelection"==m.state){var o=!1;1===m.defender&&m.playerTwoReversed>2?o=!0:2===m.defender&&m.playerOneReversed>2&&(o=!0),console.log("specialAvailable: ",o),x.displayAttacks(c,o),l()}else if("attack"==m.state){d.started||(d.elapsed=0,d.start=(new Date).getTime(),d.started=!0),d.elapsed=d.now-d.start,C.ball.setAttack(m.chosenAttack);var f=1===m.tossWinner?"one":"two",p="electric"===m.chosenAttack.type?"n ":" ",u="";u="special"!==m.chosenAttack.type?"mage "+f+" casts a"+p+m.chosenAttack.type+" spell":"mage "+f+" casts the ultimate dark magic spell",r(u,c.x,c.y,"center"),d.elapsed>1500&&(d.started=!1,l({state:"defense"}))}else if("defense"==m.state){if("special"!==m.chosenAttack.type){var v=1===m.defender?"one":"two";r("mage "+v+", reverse it!!",c.x,c.y,"center")}else{var b="uh oh...";r(b,c.x,c.y,"center")}d.started||(d.elapsed=0,d.start=(new Date).getTime(),d.started=!0),d.elapsed=d.now-d.start,d.elapsed>1500&&(d.started=!1,l({state:"attackIncoming"}),d.lastCall=(new Date).getDate())}else if("attackIncoming"==m.state){d.started||(d.start=(new Date).getTime(),d.started=!0,d.lastCall=d.start),d.elapsed=(new Date).getTime()-d.lastCall;var S=(new Date).getTime()+m.chosenAttack.time,A=m.chosenAttack.time-(S-d.start-m.chosenAttack.time);if(A>0){var D=600,H=0,R=0;2===m.defender?(C.ball.initialX=180,H=C.ball.initialX+D,R=H-C.ball.x):(C.ball.initialX=780,H=C.ball.initialX-D,R=C.ball.x-H);var P=R/A;C.ball.show=!0,2===m.defender?C.ball.x+=P*d.elapsed:C.ball.x-=P*d.elapsed}else console.log("ouch..."),C.ball.show=!1,d.started=!1,m.state="attackSuccess";if("special"!=m.chosenAttack.type)switch(m.defender){case 1:w.draw(h),w.getScore()>=T&&(m.state="reversing",m.playerOneReversed++,d.started=!1);break;case 2:g.draw(h),g.getScore()>=T&&(m.state="reversing",m.playerTwoReversed++,d.started=!1)}d.lastCall=(new Date).getTime()}else if("reversing"==m.state){d.started||(d.start=(new Date).getTime(),d.started=!0,d.lastCall=d.start),d.elapsed=(new Date).getTime()-d.lastCall;var L=2e3,B=(new Date).getTime()+L,K=L-(B-d.start-L),M=0;if(M=1===m.defender?C.ball.initialX-C.ball.x:C.ball.x-C.ball.initialX,K>0){var I=0,W=0;1===m.defender?(I=780,W=I-C.ball.x):(I=180,W=C.ball.x-I);var X=W/K;1===m.defender?C.ball.x+=X*d.elapsed:C.ball.x-=X*d.elapsed}else C.ball.show=!1,d.started=!1,m.state="attackFail";d.lastCall=(new Date).getTime()}else if("attackFail"==m.state)l(),C.ball.show=!1,1===m.defender?(m.playerTwoHealth-=m.chosenAttack.damage/2,C.ps2.health=m.playerTwoHealth,m.playerTwoHealth<=0?(m.playerTwoHealth=0,C.ps2.health=m.playerTwoHealth,l({state:"gameOver"}),y.playDeath(2)):(y.playOuch(2),m.state="preToss")):(m.playerOneHealth-=m.chosenAttack.damage/2,C.ps1.health=m.playerOneHealth,m.playerOneHealth<=0?(m.playerOneHealth=0,C.ps1.health=m.playerOneHealth,m.state="gameOver",d.started=!1,y.playDeath(1)):(y.playOuch(1),m.state="preToss"));else if("attackSuccess"==m.state){C.ball.show=!1;var E=!0;1===m.defender?(m.playerOneHealth-=m.chosenAttack.damage,C.ps1.health=m.playerOneHealth,m.playerOneHealth<=0?(m.playerOneHealth=0,C.ps1.health=m.playerOneHealth,m.state="gameOver",d.started=!1,E=!1,y.playDeath(1)):y.playOuch(1)):(m.playerTwoHealth-=m.chosenAttack.damage,C.ps2.health=m.playerTwoHealth,m.playerTwoHealth<=0?(m.playerTwoHealth=0,C.ps2.health=m.playerTwoHealth,m.state="gameOver",d.started=!1,E=!1,y.playDeath(2)):y.playOuch(2)),E&&l({state:"preToss"})}else if("gameOver"==m.state)d.started||(d.start=(new Date).getTime(),d.started=!0,d.lastCall=d.start),d.elapsed=(new Date).getTime()-d.start,d.elapsed>1500&&(m.state="winner",d.started=!1),d.lastCall=(new Date).getTime();else if("winner"===m.state){d.started||(d.start=(new Date).getTime(),d.started=!0,d.lastCall=d.start),d.elapsed=(new Date).getTime()-d.start,C.g.y=2e3,C.mod.y=2e3,C.w.y=2e3,C.m.y+=.5;var F=m.playerOneHealth<=0?2:1;1===F?(C.ps2.y=2e3,C.ps1.x=c.x,C.ps1.y=c.y,r("mage one wins!",c.x,c.y+80,"center")):(C.ps1.y=2e3,C.ps2.x=c.x,C.ps2.y=c.y,r("mage two wins!",c.x,c.y+80,"center")),C.stars.forEach(function(e){e.scroll()}),d.elapsed>2e3&&(m.canReset=!0,r("press any key to go again...",c.x,c.y+120,"center"))}window.requestAnimationFrame(e)}function t(){h.clearRect(0,0,o.width,o.height)}function a(e,t,a){var s=0;return{draw:function(){h.lineWidth=3,h.strokeStyle="black",r(a.getLetter(),e,t,"center","400px","rgba(255,255,255,0.8)"),h.strokeText(a.getLetter(),e,t),h.lineWidth=0},getScore:function(){return s},updateScore:function(e){s+=e},resetScore:function(){s=0}}}function s(){return{x:o.width/2,y:o.height/2}}function l(e){w.resetScore(),g.resetScore(),void 0!==e&&(void 0!==e.health&&(m.playerOneHealth=m.playerTwoHealth=b),void 0!==e.state&&(m.state=e.state))}function r(e,t,a,s,l,r){void 0!==s&&(h.textAlign=s),void 0===r?(h.fillStyle="rgb(255,255,255)",h.shadowColor="white"):(h.fillStyle=r,h.shadowColor=r),h.font=(void 0===l?"22px":l)+" sans-serif",h.shadowBlur=10,h.fillText(e,t,a),h.shadowBlur=0}function i(){C.stars.forEach(function(e){e.draw()}),C.mod.draw(),C.ball.draw(),C.ball.drawReflection(),C.m.draw(),C.g.draw(),C.ps1.draw(m.playerOneReversed,m.playerOneHealth,m.state),C.ps2.draw(m.playerTwoReversed,m.playerTwoHealth,m.state),"winner"!==m.state&&(C.ps1.drawReflection(),C.ps2.drawReflection()),C.w.draw()}var n="The Odul Mages",o=document.getElementById("canvas"),h=o.getContext("2d");o.width=960,o.height=540;var c=s(),d={elapsed:0,start:(new Date).getTime(),now:(new Date).getTime(),getElapsed:this.now-this.start,started:!1,lastCall:(new Date).getTime()},y=new Sounds,f=new AvailableKeys,p=new KeyStroke(f.getKey()),u=new KeyStroke(f.getKey()),w=a(240,o.height/2+100,p),g=a(720,o.height/2+100,u),x=new Attack(h),v={yOffset:1.25*o.height,medYOffset:1.25*o.height*.1,slowYOffset:1.25*o.height*.05},k={fast:2,med:.2,slow:.1},m={state:"menu",attackingPlayer:null,playerOneHealth:100,playerTwoHealth:100,playerOneReversed:0,playerTwoReversed:0,tossWinner:null,chosenAttack:null,defender:null,start:!1,canReset:!1},b=100,T=50,S={water:{type:"water",speed:7,damage:30,colour:"rgb(0,0,255)",time:4900},fire:{type:"fire",speed:10,damage:40,colour:"rgb(255,0,0)",time:6e3},electric:{type:"electric",speed:4,damage:15,colour:"rgb(255,255,0)",time:3750},special:{type:"special",speed:5,damage:70,colour:"rbg(255,0,255)",time:4e3}},O={says:["yikes. ","ouch. ",":( ","crikey. "],set:!1,index:0},C={stars:starField(h,30,v,k),ball:attackBall(h,180,290,40,5,1),g:ground(h,0,370,v.yOffset),ps1:playerSprite(h,150,340,v.yOffset),ps2:playerSprite(h,810,340,v.yOffset,2),w:water(h,0,380,v.yOffset),mod:modesty(h,0,380,v.yOffset),m:moon(h,800,100,v.medYOffset)};window.requestAnimationFrame(e),window.addEventListener("keydown",function(e){if("menu"===m.state)32===e.keyCode&&(m.state="intro");else if("toss"===m.state)e.keyCode===p.currentLetter?(f.keys[p.currentLetter-65].available=!0,p.assignLetter(f.getKey()),w.updateScore(10),y.playSuccess(Math.round(w.getScore()/10-1),1)):e.keyCode===u.currentLetter&&(f.keys[u.currentLetter-65].avaialble=!0,u.assignLetter(f.getKey()),g.updateScore(10),y.playSuccess(Math.round(g.getScore()/10-1),2));else if("attackIncoming"===m.state)e.keyCode===p.currentLetter?(f.keys[p.currentLetter-65].available=!0,p.assignLetter(f.getKey()),w.updateScore(10),y.playSuccess(Math.round(w.getScore()/10-1),1)):e.keyCode===u.currentLetter&&(f.keys[u.currentLetter-65].available=!0,u.assignLetter(f.getKey()),g.updateScore(10),y.playSuccess(Math.round(g.getScore()/10-1),2));else if("attackSelection"===m.state){if(x.available)switch(e.keyCode){case 87:x.available=!1,m.state="attack",m.chosenAttack=S.water;break;case 70:x.available=!1,m.state="attack",m.chosenAttack=S.fire;break;case 69:x.available=!1,m.state="attack",m.chosenAttack=S.electric;break;case 83:(1===m.defender&&m.playerTwoReversed>=3||2===m.defender&&m.playerOneReversed>=3)&&(x.available=!1,m.state="attack",m.chosenAttack=S.special,m.playerTwoReversed=2===m.defender?0:m.playerTwoReversed,m.playerOneReversed=1===m.defender?0:m.playerOneReversed)}}else"winner"===m.state&&m.canReset&&window.location.reload(!1)})}function moon(e,t,a,s){var l=a;return{x:t,y:a+s,radius:40,draw:function(){e.fillStyle="rgb(255,255,255)",e.shadowColor="rgba(255,255,255,0.8)",e.shadowBlur=30,e.beginPath(),e.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),e.closePath(),e.fill(),e.shadowBlur=0,e.fillStyle="rgb(0,0,0)",e.beginPath(),e.arc(this.x+10,this.y-10,this.radius,0,2*Math.PI,!0),e.closePath(),e.fill()},reduceOffset:function(e){this.y<=l?this.y=l:this.y-=e}}}function attackBall(e,t,a,s,l,r){var i=t;return{x:t,initialX:t,y:a,speed:l,player:r,radius:s,show:!1,colour:"rgb(255,255,255)",gradient:this.colour,speedSet:!1,setPlayer:function(e){this.player=e,this.x=1===this.player?180:780},setAttack:function(e){this.colour=e.colour,this.radius=e.damage},draw:function(){this.show&&(e.fillStyle=this.colour,e.shadowColor=this.colour,e.shadowBlur=40,e.beginPath(),e.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),e.closePath(),e.fill(),this.shadowBlur=0)},drawReflection:function(){this.show&&(e.fillStyle=this.colour,e.shadowColor=this.colour,e.shadowBlur=30,e.beginPath(),e.arc(this.x,this.y+170,this.radius,0,2*Math.PI,!0),e.closePath(),e.fill(),e.shadowBlur=0)},getInitialX:function(){return i}}}function star(e,t,a,s,l){var r=a;return{x:t,y:a+s,radius:rnd(1,3),draw:function(){e.fillStyle="rgb(255,255,255)",e.beginPath(),e.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),e.closePath(),e.fill()},reduceOffset:function(){this.y<=r?this.y=r:this.y-=l},scroll:function(){this.y+=4*l,this.y>canvas.height&&(this.y=rnd(-15,-5),this.x=rnd(0,canvas.width))}}}function starField(e,t,a,s){for(var l=[],r=0;t>r;r++){var i=rnd(0,960),n=rnd(0,540),o=rnd(0,1),h={};1===o?(h.speed=s.med,h.offset=a.medYOffset):(h.speed=s.slow,h.offset=a.slowYOffset),l.push(star(e,i,n,h.offset,h.speed))}return l}function ground(e,t,a,s){var l=a;return{x:t,y:a+s,height:10,draw:function(){e.fillStyle="rgb(99,99,99)",e.fillRect(this.x,this.y,canvas.width,this.height)},reduceOffset:function(e){this.y<=l?this.y=l:this.y-=e}}}function water(e,t,a,s){var l=a;return{x:t,y:a+s,height:70,draw:function(){var t=e.createLinearGradient(canvas.width/2,this.y,canvas.width/2,this.y+this.height);t.addColorStop(0,"rgba(0,0,0,1)"),t.addColorStop(.5,"rgba(0,0,0,0.4)"),t.addColorStop(.6,"rgba(0,0,0,0.2)"),t.addColorStop(.65,"rgba(0,0,0,0.1)"),t.addColorStop(.7,"rgba(0,0,0,0.05)"),t.addColorStop(.75,"rgba(0,0,0,0)"),t.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=t,e.rect(this.x,this.y,canvas.width,this.height),e.fill(),e.fillStyle="black"},reduceOffset:function(e){this.y<=l?this.y=l:this.y-=e}}}function modesty(e,t,a,s){var l=a;return{x:t,y:a+s,height:250,draw:function(){e.fillStyle="black",e.rect(this.x,this.y,canvas.width,this.height),e.fill()},reduceOffset:function(e){this.y<=l?this.y=l:this.y-=e}}}function playerSprite(e,t,a,s,l){var r=a,i=2===l?-1:1;return{x:t,y:a+s,health:100,scrollComplete:!1,draw:function(t,a,s){var l=new Path2D;if(e.fillStyle="rgb(255,255,255)",e.shadowColor="white",e.shadowBlur=10,l.moveTo(this.x,this.y),l.lineTo(this.x-40*i,this.y),l.lineTo(this.x-10*i,this.y-100),l.lineTo(this.x+20*i,this.y-100),l.lineTo(this.x+30*i,this.y),l.moveTo(this.x-10*i,this.y),l.lineTo(this.x-12*i,this.y+30),l.lineTo(this.x-20*i,this.y+30),l.lineTo(this.x-18*i,this.y),l.moveTo(this.x+15*i,this.y),l.lineTo(this.x+15*i,this.y+30),l.lineTo(this.x+7*i,this.y+30),l.lineTo(this.x+7*i,this.y),e.fill(l),e.shadowBlur=0,"winner"!==s){if(t>0){t=t>3?3:t;for(var r=7,n=1;t>=n;n++)e.fillStyle="white",e.shadowColor="white",e.shadowBlur=15,e.beginPath(),e.arc(this.x-45*i,this.y-20-20*n,r,0,2*Math.PI,!0),e.closePath(),e.fill()}e.fillStyle="white",e.fillRect(this.x-70*i,this.y,10,-1*a)}var o=new Path2D;e.fillStyle="rgb(40,40,40)",o.moveTo(this.x+17*i,this.y-98),o.lineTo(this.x+19*i,this.y-75),o.lineTo(this.x+4*i,this.y-75),o.lineTo(this.x+9*i,this.y-98),e.fill(o)},drawReflection:function(){var t=new Path2D;e.fillStyle="rgba(255,255,255,"+this.health/100+")",e.shadowColor="rgba(255,255,255,"+this.health/100+")",e.shadowBlur=20;var a=this.y+70;t.moveTo(this.x,a),t.lineTo(this.x-40*i,a),t.lineTo(this.x-10*i,a+100),t.lineTo(this.x+20*i,a+100),t.lineTo(this.x+30*i,a),t.moveTo(this.x-10*i,a),t.lineTo(this.x-12*i,a-30),t.lineTo(this.x-20*i,a-30),t.lineTo(this.x-18*i,a),t.moveTo(this.x+15*i,a),t.lineTo(this.x+15*i,a-30),t.lineTo(this.x+7*i,a-30),t.lineTo(this.x+7*i,a),e.fill(t),e.shadowBlur=0;var s=new Path2D;e.fillStyle="rgba(40,40,40,"+this.health/100+")",s.moveTo(this.x+17*i,a+98),s.lineTo(this.x+19*i,a+75),s.lineTo(this.x+4*i,a+75),s.lineTo(this.x+9*i,a+98),e.fill(s)},reduceOffset:function(e){this.y<=r?(this.y=r,this.scrollComplete=!0):this.y-=e}}}function rnd(e,t){return Math.floor(Math.random()*(t-e+1))+e}function KeyStroke(e){this.currentLetter=e}function AvailableKeys(){this.keys=[];for(var e=65;91>e;e++)this.keys.push({key:e,available:!0})}function Attack(e){this.ctx=e,this.available=!1}function Sounds(){this.audioContext=new AudioContext,this.notes=[{notes:[-3,2,9],delay:.1,feedback:.4},{notes:[0,5,12],delay:.1,feedback:.4},{notes:[3,8,15],delay:.1,feedback:.4},{notes:[6,11,18],delay:.1,feedback:.4},{notes:[9,14,21,22,28,30,32,32,35,9,9,9],delay:.1,feedback:.6}],this.p2notes=[{notes:[-5,-2,-1],delay:.1,feedback:.4},{notes:[-3,0,1],delay:.1,feedback:.4},{notes:[-1,2,3],delay:.1,feedback:.4},{notes:[1,4,5],delay:.1,feedback:.4},{notes:[3,6,7,2,12,10,14,17,20,0,0,2,1],delay:.1,feedback:.4}],this.p1ouch=[{notes:[-15,-10,-12,-17,-17],delay:.1,feedback:.8}],this.p2ouch=[{notes:[-32,-25,-22,-15,-30],delay:.1,feedback:.65}],this.p1death=[{notes:[-40,0,-35,-5,-20,-18,-23],delay:.1,feedback:.7}],this.p2death=[{notes:[-35,-34,-50,-25,-20,-1,-0],delay:.1,feedback:.7}]}KeyStroke.prototype.assignLetter=function(e){this.currentLetter=e},KeyStroke.prototype.getLetter=function(){return String.fromCharCode(this.currentLetter).toUpperCase()},KeyStroke.prototype.getRandom=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},AvailableKeys.prototype.getKey=function(){var e=0;try{e=rnd(0,this.keys.length-1)}catch(t){console.error(t),e=5}var a=this.keys[e];return a.available?(this.keys[e].available=!1,a.key):this.getKey()},Attack.prototype.displayAttacks=function(e,t){this.available=!0,this.ctx.fillStyle="white",this.ctx.shadowBlur=20,this.ctx.shadowColor="white",this.ctx.fillText("(F) fire",e.x-100,e.y),this.ctx.fillText("(W) water",e.x,e.y-100),this.ctx.fillText("(E) electric",e.x+105,e.y),t&&this.ctx.fillText("(S) special",e.x,e.y+100)},Attack.prototype.selectedAttack=function(e){this.available&&(this.ctx.textAlign="left",this.ctx.fillText(e+" selected",20,100))},Sounds.prototype.playSuccess=function(e,t){for(var a=.05,s=0-a,l=.15,r=1===t?this.notes:this.p2notes,i=0;i<r[e].notes.length;i++)this.play(s+=a,r[e].notes[i],l,r[e])},Sounds.prototype.playOuch=function(e){for(var t=.05,a=0-t,s=.15,l=1===e?this.p1ouch:this.p2ouch,r=0;r<l[0].notes.length;r++)this.play(a+=t,l[0].notes[r],s,l[0])},Sounds.prototype.playDeath=function(e){for(var t=.05,a=0-t,s=.15,l=1===e?this.p1death:this.p2death,r=0;r<l[0].notes.length;r++)this.play(a+=t,l[0].notes[r],s,l[0])},Sounds.prototype.play=function(e,t,a,s){var l=this.audioContext.currentTime+e,r=this.audioContext.createGain(),i=this.audioContext.createGain(),n=this.audioContext.createDelay(),o=this.audioContext.createGain();o.connect(this.audioContext.destination),n.delayTime.value=s.delay,i.gain.value=s.feedback,r.connect(o),r.connect(n),n.connect(i),i.connect(n),i.connect(o);var h=this.audioContext.createOscillator();h.connect(n),h.type="square",h.detune.value=100*t,h.start(l),h.stop(l+a)};