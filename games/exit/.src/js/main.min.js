AFRAME.registerComponent("game",{init:function(){g_playfield=new Playfield;g_playfield.init()},tick:function(e,t){while(t>0){var r=40;if(r>t){r=t}t-=r;g_playfield.tick(e,r)}}});var ARROW_COLOR="#cc6633";var ARROW_COLOR_ACTIVE="#ee9988";var Block=function(e,t,r){var i=this;var a=false;if(typeof r!="undefined"){a=r}var n=1;if(typeof t!="undefined"){n=t}var l=null;var s=null;var o=null;var u=null;var c=[];var v=[];var f=0;var b=false;var d=e;i.setSwitchDown=function(e){switch(d){case 7:if(e=="green"){l.setAttribute("position",new THREE.Vector3(0,-.56,0))}else{l.setAttribute("position",new THREE.Vector3(0,-.5,0))}break;case 6:if(e=="red"){l.setAttribute("position",new THREE.Vector3(0,-.56,0))}else{l.setAttribute("position",new THREE.Vector3(0,-.5,0))}break;case 10:if(e=="red"){u.setAttribute("material","opacity: 1;transparent: false");u.setAttribute("class","clickable");u.setAttribute("shadow","receive: true; cast: true")}else{u.setAttribute("material","opacity: 0.1;transparent: true");u.setAttribute("class","");u.setAttribute("shadow","receive: false; cast: false")}break;case 11:if(e=="green"){u.setAttribute("material","opacity: 1;transparent: false");u.setAttribute("class","clickable");u.setAttribute("shadow","receive: true; cast: true")}else{u.setAttribute("material","opacity: 0.1;transparent: true");u.setAttribute("class","");u.setAttribute("shadow","receive: false; cast: false")}break}};var p=function(){switch(d){case 9:a=m();break;case 10:a=h("red");break;case 11:a=h("green");break;case 1:a=x(180);break;case 2:a=x(90);break;case 3:a=x(0);break;case 4:a=x(270);break;case 5:a=E();break;case 6:a=g("#f00","#e00");break;case 7:a=g("#0c0","#0b0");break;case 12:a=A();break}};i.setExitUsed=function(){if(d==12){b=true}},i.getExitUsed=function(){return b};i.tick=function(e,t){if(d==12){var r=60;var i=.03;if(b){r=14;i=.22}if(e-f>r){f=e;var a=true;var n=.3;for(var l=0;l<c.length;l++){if(v[l]!==false){var s=v[l]+i;if(!b||s<c.length){s=s%c.length;v[l]=s;c[l].setAttribute("scale",new THREE.Vector3(.5+s*n,.5+s*n,.5+s*n));c[l].setAttribute("position",new THREE.Vector3(0,-.5+s*(n-.1),0));a=false}else{v[l]=false;c[l].setAttribute("visible",false)}}}if(a){d=0}}}};var A=function(){if(a===false){a=document.createElement("a-entity")}for(var e=0;e<4;e++){var t=document.createElement("a-torus");t.setAttribute("material","flatShading: true; color: orange");t.setAttribute("rotation","90 0 0");t.setAttribute("radius","0.25");t.setAttribute("radius-tubular","0.03");t.setAttribute("segments-radial","2");t.setAttribute("scale",new THREE.Vector3(.5+e*.3,.5+e*.3,.5+e*.3));t.setAttribute("position",new THREE.Vector3(0,-.5+e*.2,0));t.setAttribute("shadow","receive: false; cast: true");a.append(t);c.push(t);v.push(e)}return a};var g=function(e,t){if(a===false){a=document.createElement("a-entity")}l=document.createElement("a-cylinder");l.setAttribute("color",e);l.setAttribute("height",.2);l.setAttribute("radius",.2);l.setAttribute("position","0, -0.5, 0");l.setAttribute("segments-radial",16);l.setAttribute("shadow","receive: true; cast: true");a.append(l);var r=document.createElement("a-cylinder");r.setAttribute("color",t);r.setAttribute("height",.04);r.setAttribute("radius",.29);r.setAttribute("position","0, -0.5, 0");r.setAttribute("segments-radial",16);r.setAttribute("shadow","receive: true; cast: true");a.append(r);return a};var m=function(){if(a===false){a=document.createElement("a-entity")}u=document.createElement("a-box");u.setAttribute("color","#eeeeee");u.setAttribute("scale","0.9 0.9 0.9");u.setAttribute("shadow","receive: true; cast: true");u.setAttribute("class","clickable");a.append(u);return a};var h=function(e){if(a===false){a=document.createElement("a-entity")}u=document.createElement("a-box");u.setAttribute("color",e);u.setAttribute("material","transparent: true; opacity: 0.5");u.setAttribute("scale","0.9 0.9 0.9");u.setAttribute("shadow","receive: true; cast: true");u.setAttribute("class","clickable");a.append(u);return a};var E=function(){if(a===false){a=document.createElement("a-entity")}u=document.createElement("a-box");u.setAttribute("scale","0.3 0.05 0.3");u.setAttribute("position","0 -0.5 0");u.setAttribute("material","color: #555");if(n!=1){u.setAttribute("transparent","true");u.setAttribute("opacity",n)}a.append(u);u=document.createElement("a-box");u.setAttribute("scale","0.5 0.02 0.5");u.setAttribute("position","0 -0.45 0");u.setAttribute("material","color: yellow");if(n!=1){u.setAttribute("transparent","true");u.setAttribute("opacity",n)}else{u.setAttribute("shadow","receive: true; cast: true")}a.append(u);return a};var x=function(e){if(a===false){a=document.createElement("a-entity")}s=document.createElement("a-triangle");s.setAttribute("shadow","receive: true");s.setAttribute("color",ARROW_COLOR);s.setAttribute("position","0 -0.5 0.1");s.setAttribute("vertex-a","0 0 0.2");s.setAttribute("vertex-b","0.2 0 -0.2");s.setAttribute("vertex-c","-0.2 0 -0.2");if(n!=1){s.setAttribute("transparent","true");s.setAttribute("opacity",n)}a.append(s);o=document.createElement("a-plane");o.setAttribute("shadow","receive: true");o.setAttribute("color",ARROW_COLOR);o.setAttribute("scale","0.2 0.15 1");o.setAttribute("position","0 -0.5 -0.175");o.setAttribute("rotation","-90 0 0");if(n!=1){o.setAttribute("transparent","true");o.setAttribute("opacity",n)}a.append(o);a.setAttribute("rotation",{x:0,y:e,z:0});return a};i.actorEnterBlock=function(){switch(d){case 1:case 3:case 2:case 4:s.setAttribute("color",ARROW_COLOR_ACTIVE);o.setAttribute("color",ARROW_COLOR_ACTIVE);break;case 5:u.setAttribute("position",new THREE.Vector3(0,-.4,0));break}};i.actorExitBlock=function(){switch(d){case 1:case 3:case 2:case 4:s.setAttribute("color",ARROW_COLOR);o.setAttribute("color",ARROW_COLOR);break;case 5:u.setAttribute("position",new THREE.Vector3(0,-.47,0));break}};i.getEntity=function(){return a};i.setPosition=function(e,t,r){a.setAttribute("position",new THREE.Vector3(e,t,r));a.setAttribute("isblock","yes")};i.setScale=function(e){if(a){a.setAttribute("scale",new THREE.Vector3(e,e,e))}};p()};var ACTOR_STATE_GONE=4;var Actor=function(e){var b=this;var d=e;var a=null;var o=null;var t=null;var r=null;var p=true;var u=null;var c=Math.PI/2;var i=1;var v=null;var f=Math.PI/2;var n=-1;var A=.002;var g=new THREE.Vector3(0,0,0);var m=new THREE.Vector3(0,1,0);var h=new THREE.Vector3(1,0,0);var l=null;var s=null;var E=1;var x=0;var y=false;var T=1;var z=false;var _=false;b.removeEntity=function(){a.parentNode.removeChild(a)};b.createEntity=function(){a=document.createElement("a-entity");if(d==1){o=document.createElement("a-sphere");o.setAttribute("scale","0.7 0.9 0.7");o.setAttribute("radius","0.4");o.setAttribute("position","0 -0.15 0");o.setAttribute("material","color: green");o.setAttribute("shadow","receive: true; cast: true");a.append(o);t=document.createElement("a-box");t.setAttribute("position","0.4 0.12 -0.2");t.setAttribute("scale","0.02 0.2 0.2");t.setAttribute("material","color: white");o.append(t);r=document.createElement("a-box");r.setAttribute("position","0.4 0.1.2 0.2");r.setAttribute("scale","0.02 0.2 0.2");r.setAttribute("material","color: white");o.append(r);u=document.createElement("a-sphere");u.setAttribute("radius","0.16");u.setAttribute("position","0 -0.5 -0.24");u.setAttribute("material","color: red");u.setAttribute("phi-length","180");u.setAttribute("rotation","-90 0 0");u.setAttribute("scale","1 0.4 0.6");a.append(u);v=document.createElement("a-sphere");v.setAttribute("radius","0.16");v.setAttribute("position","0 -0.5 0.24");v.setAttribute("material","color: red");v.setAttribute("phi-length","180");v.setAttribute("rotation","-90 0 0");v.setAttribute("scale","1 0.4 0.6");a.append(v)}if(d==2){o=document.createElement("a-box");o.setAttribute("scale","0.6 0.8 0.6");o.setAttribute("position","0 -0.15 0");o.setAttribute("material","color: black");o.setAttribute("shadow","receive: true; cast: true");a.append(o);t=document.createElement("a-box");t.setAttribute("position","0.4 0.2 0");t.setAttribute("scale","0.4 0.25 0.6");t.setAttribute("material","color: white");o.append(t);r=document.createElement("a-box");r.setAttribute("position","0.0 0.4 0");r.setAttribute("scale","0.3 0.3 0.3");r.setAttribute("material","color: #554444");o.append(r);s=document.createElement("a-entity");a.append(s);l=document.createElement("a-cone");l.setAttribute("material","shader: flat; color: red");l.setAttribute("transparent","true");l.setAttribute("opacity","0.5");l.setAttribute("rotation","50 -90 0");l.setAttribute("scale","0.26 1.4 0.26");l.setAttribute("position","0.5 -0.16 0");l.setAttribute("segments-radial","6");s.append(l)}return a},b.setPosition=function(e,t,r){g.x=e;g.y=t;g.z=r;a.setAttribute("position",new THREE.Vector3(e,t,r))};b.setDirection=function(e,t,r){var i=0;if(r==-1){i=90}else if(r==1){i=270}else if(e==-1){i=180}else if(e==1){i=0}a.setAttribute("rotation",{x:0,y:i,z:0});h.x=e;h.z=r};var w=function(e){T=2;_=e};var k=function(e){var t=e-_;var r=1-t/300;if(r<.01){r=.01;T=3;g_playfield.actorExited()}a.setAttribute("scale",new THREE.Vector3(r,r,r))};var R=function(e,t){p=false;h.y-=t*.0086;var r=g.x+h.x*t*A;var i=g.y+h.y*t*A;var a=g.z+h.z*t*A;var n=Math.floor(r+.5);var l=Math.floor(i);var s=Math.floor(a+.5);if(h.y<0&&g_playfield.getBlockType(n,l,s)==9){p=true;l++;i=l;h.y=0}else{}var o=g_playfield.getBlockType(n,l,s);if(!p){if(h.y<0){o=0}}var u=false;if(h.x<0){if(n-r>=0){if(m.x!=n){u=true}if(o!=5&&g_playfield.getBlockType(n-1,l,s)==9){b.setDirection(1,0,0)}if(d==2&&(n-1<0||o!=5&&h.y==0&&g_playfield.getBlockType(n-1,l-1,s)==0)){b.setDirection(1,0,0)}}}if(h.x>0){if(n-r<=0){if(m.x!=n){u=true}if(o!=5&&g_playfield.getBlockType(Math.floor(n+1),Math.floor(l),Math.floor(s))==9){b.setDirection(-1,0,0)}if(d==2&&(n+1>=gridWidth||o!=5&&h.y==0&&g_playfield.getBlockType(n+1,l-1,s)==0)){b.setDirection(-1,0,0)}}}if(h.z<0){if(s-a>=0){if(m.z!=s){u=true}if(o!=5&&g_playfield.getBlockType(Math.floor(n),Math.floor(l),Math.floor(s-1))==9){b.setDirection(0,0,1)}if(d==2&&(s-1<0||o!=5&&h.y==0&&g_playfield.getBlockType(n,l-1,s-1)==0)){b.setDirection(0,0,1)}}}if(h.z>0){if(s-a<=0){if(m.z!=s){u=true}if(o!=5&&g_playfield.getBlockType(Math.floor(n),Math.floor(l),Math.floor(s+1))==9){b.setDirection(0,0,-1)}if(d==2&&(s+1>=gridDepth||o!=5&&h.y==0&&g_playfield.getBlockType(n,l-1,s+1)==0)){b.setDirection(0,0,-1)}}}if(p&&u){g_playfield.actorExitBlock(m.x,m.y,m.z);m.x=n;m.y=l;m.z=s;g_playfield.actorEnterBlock(m.x,m.y,m.z);switch(g_playfield.getBlockType(n,l,s)){case 2:b.setDirection(1,0,0);a=s;break;case 4:b.setDirection(-1,0,0);a=s;break;case 1:b.setDirection(0,0,-1);r=n;break;case 3:b.setDirection(0,0,1);r=n;break;case 5:g_sound.playSound(SOUND_JUMP);h.y=3.4;break;case 6:if(g_playfield.getSwitchDown()!="red"){g_sound.playSound(SOUND_RED)}g_playfield.setSwitchDown("red");break;case 7:if(g_playfield.getSwitchDown()!="green"){g_sound.playSound(SOUND_GREEN)}g_playfield.setSwitchDown("green");break;case 12:if(d==1){if(!g_playfield.getExitUsed(n,l,s)){g_sound.playSound(SOUND_EXIT);w(e);g_playfield.setExitUsed(n,l,s)}}break}}b.setPosition(r,i,a);if(i<0&&!z){z=true;g_sound.playSound(SOUND_FALL)}if(i<-20){if(d==1){g_playfield.restartLevel()}if(d==2&&i<-40){T=ACTOR_STATE_GONE}}if(d==1){V(e,t)}if(d==2){S(e,t);if(g_playfield.gridHasFriend(n,l,s)){g_sound.playSound(SOUND_DIE);g_playfield.restartLevel()}var c=g_playfield.gridHasFriend(n+h.x,l,s+h.z);if(c!==false){var v=false;var f=c.getPosition();if(h.x>0){v=f.x-g.x<.8}if(h.x<0){v=g.x-f<.8}if(v){g_sound.playSound(SOUND_DIE);g_playfield.restartLevel()}}}};var V=function(e,t){var r=0;var i=.12;var a=.06;var n=-.48;f=f+t/60;var l=i*Math.cos(-f);var s=-.44+a*Math.sin(-f);if(s<n){r=n-s;s=n}v.setAttribute("position",{x:l,y:s,z:.22});c=f+Math.PI;var l=i*Math.cos(-c);var s=-.44+a*Math.sin(-c);if(s<n){r=n-s;s=n}u.setAttribute("position",{x:l,y:s,z:-.22});o.setAttribute("position",new THREE.Vector3(0,-.15+r,0))};var S=function(e,t){x+=E*t/40;if(x>14){E=-1;r.setAttribute("color","#ff1111")}if(x<-14){E=1;r.setAttribute("color","#ff1111")}if(x>-4&&x<4){r.setAttribute("color","#554444")}s.setAttribute("rotation",new THREE.Vector3(0,x,0))};b.tick=function(e,t){switch(T){case 1:R(e,t);break;case 2:k(e,t);break}};b.getType=function(){return d};b.getState=function(){return T};b.getX=function(){return m.x};b.getY=function(){return m.y};b.getZ=function(){return m.z};b.getPosition=function(){return g}};var g_playfield=null;var g_sound=null;var gridWidth=0;var gridDepth=0;var gridHeight=0;var TOOL_COUNT=5;var Playfield=function(){var f=this;var n=0;var l=[];var b=[];var o=[];var u=null;var c=null;var r=null;var i=null;var a=false;var d=null;var e=null;var s=null;var t=null;var v=null;var p=null;var A=null;var g=-1;var m=y;var h=false;var E=false;var x=false;var y=1;var T=2;var z=3;var _=4;var w=5;var k=6;var R=7;var V=null;f.init=function(){g_sound=new Sound;p=new Cursor;d=new Palette(p);e=d.getEntity();t=new Restart;v=new Home;s=new LevelSelect;u=document.getElementById("playfield");c=document.getElementById("controls");V=document.getElementById("laser");i=document.getElementById("holder");r=document.querySelector("a-scene");A=document.getElementById("camera-rotation");r.addEventListener("enter-vr",function(e){});r.addEventListener("exit-vr",function(e){});f.startLevel(n)};var S=function(e,t,r){gridWidth=e;gridHeight=t;gridDepth=r;l=[];for(var i=0;i<r;i++){l[i]=[];b[i]=[];for(var a=0;a<t;a++){l[i][a]=[];b[i][a]=[];for(var n=0;n<e;n++){l[i][a][n]=0;b[i][a][n]=null}}}};f.startLevel=function(e){if(e>levels.length){return}u.setAttribute("visible",true);c.setAttribute("visible",true);m=y;E=false;var t=levels[e];var r=0;S(t[r++],t[r++],t[r++]);var i=t[r++];var a=t[r++];for(var n=0;n<i;n++){N(t[r++],t[r++],t[r++],t[r++],t[r++],t[r++])}for(var n=0;n<a;n++){I(t[r++],t[r++],t[r++],t[r++],t[r++],t[r++])}var l=false;d.selectTool(0);for(var n=0;n<TOOL_COUNT;n++){d.setToolCount(n+1,t[r]);if(!l&&t[r]>0){var s=n+1;d.selectTool(n+1);l=true}r++}for(var n=r;n<t.length;n+=4){C(t[n],t[n+1],t[n+2],t[n+3])}g_playfield.setSwitchDown("green");u.setAttribute("position",new THREE.Vector3(-(gridWidth/2),0,-gridDepth))};f.endLevel=function(){};f.nextLevel=function(){n++;if(n>=levels.length){n=0}this.startLevel(n)};var O=function(){for(var e=0;e<gridDepth;e++){for(var t=0;t<gridHeight;t++){for(var r=0;r<gridWidth;r++){if(b[e][t][r]!=null){var i=b[e][t][r].getEntity();i.parentNode.removeChild(i);b[e][t][r]=null}}}}for(var a=0;a<o.length;a++){o[a].removeEntity()}gridDepth=0;gridWidth=0;gridHeight=0;l=[];b=[];o=[];if(m==w){n--}if(m==k){m=R;u.setAttribute("visible",false);c.setAttribute("visible",false);s.show()}else{m=_;setTimeout(function(){f.nextLevel()},400)}};f.restartLevel=function(){m=w;x=false};f.gotoLevelSelect=function(){m=k;x=false};f.getExitUsed=function(e,t,r){if(f.getBlockType(e,t,r)==12){return b[r][t][e].getExitUsed()}};f.setExitUsed=function(e,t,r){if(f.getBlockType(e,t,r)==12){b[r][t][e].setExitUsed()}else{}},f.actorExited=function(){var e=0;for(var t=0;t<o.length;t++){if(o[t].getType()==1&&o[t].getState()!==3){e++}}if(e==0){s.setLevelAvailable(n+1,true);m=z;x=false}},f.getBlockType=function(e,t,r){if(e>=0&&e<gridWidth&&t>=0&&t<gridHeight&&r>=0&&r<gridDepth){var i=l[r][t][e];if(i==10&&a=="red"){i=9}if(i==11&&a=="green"){i=9}if(i==12&&b[r][t][e].getExitUsed()){i=0}return i}return 0};var D=function(e){var t=e.target;if(t.getAttribute("isblock")==null){t=t.parentNode}var r=t.getAttribute("position");var i=parseInt(r.x,10);var a=parseInt(r.y,10);var n=parseInt(r.z,10);if(i<0||i>=gridWidth||a<0||a>=gridHeight-1||n<0||n>=gridDepth){p.setVisible(false);return}if(f.getBlockType(i,a,n)==9){a++}var l=f.getBlockType(i,a,n);if(l>5){return}p.setPosition(i,a,n);if(!g_playfield.getIsMobile()){p.setVisible(true)}};var L=function(e){p.setVisible(false)};var H=function(e){g_sound.init();var t=e.target;if(t.getAttribute("isblock")==null){t=t.parentNode}var r=t.getAttribute("position");var i=parseInt(r.x,10);var a=parseInt(r.y,10);var n=parseInt(r.z,10);if(i<0||i>=gridWidth||a<0||a>=gridHeight-1||n<0||n>=gridDepth){return}if(f.getBlockType(i,a,n)==9){a++}var l=d.getCurrentToolIndex();var s=f.getBlockType(i,a,n);if(s>5||s==l){return}var o=d.getToolCount(l);if(o<=0){return}if(l!==false){if(b[n][a][i]!==null){var u=b[n][a][i].getEntity();u.parentNode.removeChild(u);b[n][a][i]=null;var c=d.getToolCount(s);c++;if(s!==0){d.setToolCount(s,c)}}C(i,a,n,l);d.setToolCount(l,o-1);if(l==0){g_sound.playSound(SOUND_REMOVE)}else{g_sound.playSound(SOUND_PLACE)}if(l==0||d.getToolCount(l)==0){if(s!=0){d.selectTool(s)}else{d.selectTool(0);for(var v=0;v<TOOL_COUNT;v++){if(d.getToolCount(v+1)>0){d.selectTool(v+1);break}}}}}};var C=function(e,t,r,i){l[r][t][e]=i;var a=false;if(i!==0){a=document.createElement("a-entity");u.append(a)}var n=new Block(i,1,a);if(a!==false){b[r][t][e]=n;n.setPosition(e,t,r);a.setAttribute("class","clickable");a.addEventListener("mouseenter",D);a.addEventListener("mouseleave",L);a.addEventListener("click",H)}};var N=function(e,t,r,i,a,n){var l=new Actor(1);var s=l.createEntity();l.setPosition(e,t,r);l.setDirection(i,a,n);u.append(s);o.push(l)};var I=function(e,t,r,i,a,n){var l=new Actor(2);var s=l.createEntity();l.setPosition(e,t,r);l.setDirection(i,a,n);u.append(s);o.push(l)};var U=function(e,t){if(E===false){E=e}var r=e-E;var i=r/500;if(i>1){i=1;m=T}for(var a=0;a<gridDepth;a++){for(var n=0;n<gridHeight;n++){for(var l=0;l<gridWidth;l++){if(b[a][n][l]!=null){b[a][n][l].setScale(i)}}}}};var B=function(e,t){if(x===false){x=e}var r=e-x;var i=1-r/500;if(i<.01){i=.01;O();return}for(var a=0;a<gridDepth;a++){for(var n=0;n<gridHeight;n++){for(var l=0;l<gridWidth;l++){if(b[a][n][l]!=null){b[a][n][l].setScale(i)}}}}};var M=function(e,t){for(var r=0;r<o.length;r++){o[r].tick(e,t)}for(var i=0;i<gridDepth;i++){for(var a=0;a<gridHeight;a++){for(var n=0;n<gridWidth;n++){if(b[i][a][n]!=null){b[i][a][n].tick(e,t)}}}}};f.tick=function(e,t){h=e;if(r.is("vr-mode")){if(g===false||g==-1){A.setAttribute("rotation",new THREE.Vector3(0,0,0));r.removeAttribute("cursor");r.removeAttribute("raycaster");i.setAttribute("rotation",new THREE.Vector3(0,180,0));i.setAttribute("position",new THREE.Vector3(0,-1.5,2));g=true}}else{if(g===true||g===-1){if(r.isMobile){A.setAttribute("rotation",new THREE.Vector3(0,0,0));i.setAttribute("position",new THREE.Vector3(0,-1,-1.5))}else{A.setAttribute("rotation",new THREE.Vector3(-45,0,0));i.setAttribute("position",new THREE.Vector3(0,-1,-2))}r.setAttribute("cursor","rayOrigin: mouse");r.setAttribute("raycaster","objects: .clickable");i.setAttribute("rotation",new THREE.Vector3(0,0,0));g=false}}switch(m){case y:U(e,t);break;case T:M(e,t);break;case z:case w:case k:B(e,t);break;case R:s.tick(e,t);break}};f.actorEnterBlock=function(e,t,r){if(e>=0&&e<gridWidth&&t>=0&&t<gridHeight&&r>=0&&r<gridDepth){if(b[r][t][e]!=null){b[r][t][e].actorEnterBlock()}}};f.actorExitBlock=function(e,t,r){if(e>=0&&e<gridWidth&&t>=0&&t<gridHeight&&r>=0&&r<gridDepth){if(b[r][t][e]!=null){b[r][t][e].actorExitBlock()}}};f.setSwitchDown=function(e){a=e;for(var t=0;t<gridDepth;t++){for(var r=0;r<gridHeight;r++){for(var i=0;i<gridWidth;i++){if(b[t][r][i]!=null){b[t][r][i].setSwitchDown(e)}}}}};f.getSwitchDown=function(){return a};f.gridHasFriend=function(e,t,r){for(var i=0;i<o.length;i++){if(o[i].getType()==1){if(o[i].getX()==e&&o[i].getY()==t&&o[i].getZ()==r){if(o[i].getState()==1){return o[i]}}}}return false};f.getIsMobile=function(){return r.isMobile&&g!==true}};var Palette=function(t){var l=this;var s="#999999";var r="#555555";var o="#bbbbbb";var i="#dddddd";var u=null;var c=null;var e=null;var v=false;var f=[];var b=[];var d=[];var a=function(){u=document.getElementById("palette");c=document.createElement("a-text");c.setAttribute("value","Selected Tool");c.setAttribute("scale","4 4 4");c.setAttribute("rotation","-90 0 0");c.setAttribute("color","#eeeeee");c.setAttribute("position","-0.5 0.1 -1");u.append(c);for(var e=0;e<6;e++){var t=document.createElement("a-entity");t.setAttribute("position",new THREE.Vector3(e,0,0));t.setAttribute("tool-index",e);f.push(t);var r=document.createElement("a-box");r.setAttribute("scale","0.9 0.1 0.9");r.setAttribute("color","#9a9a9a");r.setAttribute("class","clickable");t.append(r);var i=document.createElement("a-text");i.setAttribute("color","#cccccc");i.setAttribute("align","center");i.setAttribute("rotation","-90 0 0");i.setAttribute("position","-0 0 0.64");i.setAttribute("width","5");if(e==0){i.setAttribute("value","")}else{i.setAttribute("value","0")}i.setAttribute("scale","1.6 1.6 1.6");t.append(i);d.push(i);b.push(0);if(e!=0){var a=document.createElement("a-entity");a.setAttribute("position",new THREE.Vector3(0,.6,0));a.setAttribute("tool-index",e);t.append(a);var n=new Block(e,1,a)}u.append(t);t.addEventListener("mouseenter",function(e){var t=parseInt(e.target.parentNode.getAttribute("tool-index"),10);if(t!==v){if(t==0||b[t]>0){A(t,o)}p(t)}});t.addEventListener("mouseleave",function(e){var t=parseInt(e.target.parentNode.getAttribute("tool-index"),10);if(t!==v){if(t==0||b[t]>0){A(t,s)}p(v)}});t.addEventListener("click",function(e){g_sound.init();g_sound.playSound(SOUND_CLICK);var t=parseInt(e.target.parentNode.getAttribute("tool-index"),10);if(t==0||b[t]>0){l.selectTool(t)}})}};var n=function(e){switch(e){case 0:return"Remove";case 1:return"North";case 2:return"East";case 3:return"South";case 4:return"West";case 5:return"Jump"}return""};l.setToolCount=function(e,t){if(e>0&&e<d.length){if(t<=0){t=0;A(e,r)}else{A(e,s)}d[e].setAttribute("value",t);b[e]=parseInt(t,10)}};l.getToolCount=function(e){if(e>0){return b[e]}return 1};var p=function(e){c.setAttribute("value",n(e))};l.selectTool=function(e){e=parseInt(e,10);if(e!==0&&l.getToolCount(e)==0){return}if(e!==v){if(v!==false&&(l.getToolCount(v)>0||v==0)){A(v,s)}v=e;A(v,i);p(e);t.setType(e)}};var A=function(e,t){var r=f[e];r.children[0].setAttribute("color",t)};a();l.getEntity=function(){return u};l.getCurrentToolIndex=function(){return v}};var Restart=function(){var i=document.getElementById("restart");var t=document.createElement("a-box");t.setAttribute("scale","0.9 0.1 0.9");t.setAttribute("color","#9a9a9a");t.setAttribute("class","clickable");i.append(t);var e=document.createElement("a-torus");e.setAttribute("material","flatShading: true; color: red");e.setAttribute("rotation","90 0 0");e.setAttribute("radius","0.25");e.setAttribute("radius-tubular","0.03");e.setAttribute("position","0 0.1 0");e.setAttribute("segments-radial","2");e.setAttribute("arc","270");i.append(e);var r=document.createElement("a-triangle");r.setAttribute("shadow","receive: true");r.setAttribute("color","red");r.setAttribute("material","flatShading: true; color: red");r.setAttribute("rotation","-90 -90 0");r.setAttribute("position","0.1 0.1 -0.24");r.setAttribute("scale","0.3 0.3 0.3");i.append(r);var a=document.createElement("a-text");a.setAttribute("value","Restart");a.setAttribute("scale","4 4 4");a.setAttribute("rotation","-90 0 0");a.setAttribute("color","#eeeeee");a.setAttribute("visible","false");a.setAttribute("position","-2.5 0.1 -1");i.append(a);t.addEventListener("mouseenter",function(e){t.setAttribute("color","#bbbbbb");a.setAttribute("visible","true")});t.addEventListener("mouseleave",function(e){t.setAttribute("color","#9a9a9a");a.setAttribute("visible","false")});t.addEventListener("click",function(e){g_sound.init();g_sound.playSound(SOUND_CLICK);g_playfield.restartLevel()});this.setPosition=function(e,t,r){i.setAttribute("position",new THREE.Vector3(e,t,r))}};var Home=function(){var e=document.getElementById("home");var t=document.createElement("a-box");t.setAttribute("scale","0.9 0.1 0.9");t.setAttribute("color","#9a9a9a");t.setAttribute("class","clickable");e.append(t);var r=document.createElement("a-plane");r.setAttribute("material","flatShading: true; color: red");r.setAttribute("rotation","-90 0 0");r.setAttribute("scale","0.16 0.4 0.4");r.setAttribute("position","0.13 0.1 0.14");e.append(r);r=document.createElement("a-plane");r.setAttribute("material","flatShading: true; color: red");r.setAttribute("rotation","-90 0 0");r.setAttribute("scale","0.16 0.4 0.4");r.setAttribute("position","-0.13 0.1 0.14");e.append(r);r=document.createElement("a-plane");r.setAttribute("material","flatShading: true; color: red");r.setAttribute("rotation","-90 0 0");r.setAttribute("scale","0.4 0.2 0.4");r.setAttribute("position","-0.0 0.1 0.05");e.append(r);r=document.createElement("a-plane");r.setAttribute("material","flatShading: true; color: red");r.setAttribute("rotation","-90 0 0");r.setAttribute("scale","0.1 0.4 0.4");r.setAttribute("position","0.15 0.1 -0.08");e.append(r);var i=document.createElement("a-triangle");i.setAttribute("shadow","receive: true");i.setAttribute("color","red");i.setAttribute("material","flatShading: true; color: red");i.setAttribute("rotation","-90 0 0");i.setAttribute("position","0 0.1 -0.16");i.setAttribute("scale","0.6 0.24 0.5");e.append(i);var a=document.createElement("a-text");a.setAttribute("value","Home");a.setAttribute("scale","4 4 4");a.setAttribute("rotation","-90 0 0");a.setAttribute("color","#eeeeee");a.setAttribute("visible","false");a.setAttribute("position","-1 0.1 -1");e.append(a);t.addEventListener("mouseenter",function(e){t.setAttribute("color","#bbbbbb");a.setAttribute("visible","true")});t.addEventListener("mouseleave",function(e){t.setAttribute("color","#9a9a9a");a.setAttribute("visible","false")});t.addEventListener("click",function(e){g_sound.init();g_sound.playSound(SOUND_CLICK);g_playfield.gotoLevelSelect()});this.setPosition=function(e,t,r){restartEntity.setAttribute("position",new THREE.Vector3(e,t,r))}};var Cursor=function(){var i=document.getElementById("block-cursor");var r=[];var e=document.createElement("a-plane");e.setAttribute("rotation","-90 0 0");e.setAttribute("position","0 -0.52 0");e.setAttribute("scale","0.9 0.9 0.9");e.setAttribute("color","#444444");e.setAttribute("visible",false);i.append(e);r.push(e);for(var t=0;t<TOOL_COUNT;t++){var e=document.createElement("a-entity");e.setAttribute("visible",false);i.append(e);n=new Block(t+1,.4,e);r.push(e)}var a=false;var n=null;var l=null;var s=false;this.setType=function(e){if(e===a){return}a=e;if(!g_playfield.getIsMobile()){for(var t=0;t<TOOL_COUNT+1;t++){r[t].setAttribute("visible",t==a)}}if(l){if(!s){i.setAttribute("visible","false")}}};this.setPosition=function(e,t,r){i.setAttribute("position",new THREE.Vector3(e,t,r))};this.setVisible=function(e){if(e!=s){if(e){i.setAttribute("visible","true")}else{i.setAttribute("visible","false")}s=e}}};var levels=[];function levelCreatePlayfield(e){var t=e[0];var r=e[2];var i=0;for(var a=0;a<r;a++){for(var n=0;n<t;n++){e.push(n);e.push(i);e.push(a);e.push(9)}}}var level=[13,20,13,1,0,5,1,11,1,0,0,1,1,1,1,1,3,1,11,2,9,1,11,4,6,1,6,12];levelCreatePlayfield(level);levels.push(level);level=[13,20,13,1,0,5,1,11,1,0,0,1,0,0,0,1,1,1,11,2,3,1,11,5,11,1,11,4,9,1,11,5,6,1,3,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){if(z>=10||x>4&&x<8&&z!=7){level.push(x,0,z,9)}}}levels.push(level);var level=[13,20,13,1,3,5,1,11,1,0,0,1,1,5,1,0,0,11,1,7,-1,0,0,1,1,9,1,0,0,1,0,0,0,0,3,1,11,2,9,1,11,4,6,1,3,12];levelCreatePlayfield(level);levels.push(level);var level=[13,20,13,2,1,6,1,10,1,0,0,6,1,11,-1,0,0,1,1,7,1,0,0,1,0,0,0,0,0,1,11,9,12,1,11,9,0,1,10,9,12,1,10,9,2,1,3,12,10,1,3,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){if(z>=10||x<5||x>7||z==7){level.push(x,0,z,9)}}}levels.push(level);var level=[13,20,13,2,2,6,1,10,1,0,0,6,1,2,-1,0,0,2,1,6,0,0,1,10,1,6,0,0,-1,0,0,0,0,0,2,1,2,3,10,1,2,4,10,1,10,1,2,1,10,2,6,1,5,12,6,1,7,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){if(z==2||z==10||x==2||x==10||(z==5&&x>2&&x<7||z==7&&x>5&&x<10)){level.push(x,0,z,9)}}}levels.push(level);var level=[13,20,13,2,0,6,1,11,-1,0,0,6,1,1,1,0,0,1,1,1,1,1,11,1,11,9,1,1,11,9,3,1,11,6,9,1,11,7,11,1,1,9,1,1,1,9,5,1,6,12,7,1,6,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){if(z<4||z>9){level.push(x,0,z,9)}}}for(var z=4;z<10;z++){level.push(5,0,z,10);level.push(7,0,z,11)}levels.push(level);var level=[13,20,13,2,0,1,4,10,1,0,0,10,4,3,-1,0,0,1,1,1,1,2,9,1,10,6,0,4,10,2,2,4,10,4,0,4,3,11,12,4,3,11,3,1,3,7,9,1,3,7,0,1,3,9,12,1,3,9,10,3,7,12,6,1,7,12];for(var x=0;x<3;x++){for(var z=9;z<12;z++){level.push(x,3,z,9)}}for(var x=0;x<13;x++){level.push(x,3,3,11)}for(var x=5;x<8;x++){for(var z=4;z<5;z++){level.push(x,0,z,11)}}for(var x=5;x<8;x++){for(var z=6;z<9;z++){level.push(x,0,z,11)}}for(var x=0;x<13;x++){level.push(x,0,3,9)}for(var x=4;x<7;x++){for(var z=9;z<12;z++){level.push(x,1,z,9)}}for(var x=4;x<12;x++){for(var z=6;z<9;z++){level.push(x,2,z,10)}}for(var x=7;x<12;x++){for(var z=9;z<12;z++){level.push(x,0,z,9)}}levels.push(level);var level=[13,20,13,4,8,6,2,8,-1,0,0,6,2,4,1,0,0,8,2,6,0,0,1,4,2,6,0,0,-1,4,1,10,1,0,0,8,1,10,1,0,0,4,1,2,-1,0,0,8,1,2,-1,0,0,10,1,4,0,0,-1,10,1,8,0,0,-1,2,1,4,0,0,1,2,1,8,0,0,1,0,0,0,0,0,4,2,8,1,8,2,8,4,4,2,4,2,8,2,4,3,10,1,2,4,7,1,2,5,2,1,2,3,2,1,5,5,2,1,10,2,5,1,10,5,10,1,10,1,10,1,7,5,1,1,11,12,11,1,1,12,1,1,1,12,11,1,11,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){level.push(x,0,z,9)}}for(var x=3;x<10;x++){for(var z=3;z<10;z++){level.push(x,1,z,9)}}levels.push(level);var level=[13,20,13,1,2,7,1,6,1,0,0,4,3,10,1,0,0,10,3,4,-1,0,0,1,0,0,0,1,1,1,7,6,10,3,10,1,10,3,4,4,4,3,4,3,4,3,10,2,7,1,12,12];levelCreatePlayfield(level);for(var y=1;y<3;y++){for(var x=4;x<11;x++){for(var z=4;z<11;z++){if(x==4||x==10||z==4||z==10){if(y==1){level.push(x,y,z,11)}else{level.push(x,y,z,9)}}}}}levels.push(level);var level=[13,20,13,1,1,9,1,11,1,0,0,3,1,11,-1,0,0,5,5,5,5,5,8,1,11,9,12,1,11,9,10,1,10,11,10,1,12,9,0,1,11,9,4,1,11,9,2,1,10,6,2,1,8,7,2,1,12,9,10,1,0,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){if(x<5){level.push(x,0,z,9)}if(x>7){if(z<10&&z>6||z==0){level.push(x,0,z,10)}else if(z>2&&z<5){level.push(x,0,z,11)}else{level.push(x,0,z,9)}}}}levels.push(level);var level=[13,20,13,1,5,3,3,12,1,0,0,0,3,10,1,0,0,0,3,7,1,0,0,0,3,4,1,0,0,12,3,9,-1,0,0,12,3,5,-1,0,0,9,9,9,9,0,8,2,11,9,0,3,12,2,3,3,12,4,6,1,11,12];for(var x=0;x<13;x++){for(var z=0;z<13;z++){if(x==0||x==4){if(z>3){}}if(z<3){level.push(x,2,z,9)}else{if(x<4){level.push(x,2,z,9)}if(x>8){level.push(x,2,z,9)}}if(z>9&&x>4&&x<8){level.push(x,0,z,9)}}}levels.push(level);var level=[13,20,13,1,0,0,4,12,0,0,-1,9,9,9,9,9,11,1,11,12,0,4,0,3,0,4,12,1];for(var z=0;z<13;z++){level.push(0,3,z,9);if(z==10||z==11){for(var x=1;x<5;x++){level.push(x,3,z,9)}}if(z==2||z==1){for(var x=1;x<7;x++){level.push(x,3,z,9)}}}for(var z=1;z<6;z++){level.push(3,0,z,9);level.push(2,0,z,9)}for(var z=0;z<6;z++){level.push(12,0,z,9);level.push(11,0,z,9)}for(var z=0;z<6;z++){level.push(8,0,z,9);level.push(9,0,z,9)}for(var x=5;x<8;x++){level.push(x,1,5,9);level.push(x,1,4,9)}for(var z=10;z<13;z++){for(var x=10;x<13;x++){level.push(x,0,z,9)}}for(var z=7;z<10;z++){for(var x=5;x<6;x++){level.push(x,0,z,9)}}for(var x=5;x<9;x++){level.push(x,0,10,9)}for(var x=0;x<3;x++){for(var z=8;z<12;z++){level.push(x,0,z,9)}}for(var x=0;x<5;x++){level.push(x,0,0,9)}levels.push(level);var SOUND_CLICK=1;var SOUND_EXIT=2;var SOUND_DIE=3;var SOUND_JUMP=4;var SOUND_FALL=5;var SOUND_GREEN=6;var SOUND_RED=7;var SOUND_REMOVE=8;var SOUND_PLACE=9;var SOUND_LEVEL_END=10;var Sound=function(){var o=null;this.init=function(){if(o==null){o=new AudioContext}};var u=function(e){return Math.pow(2,(e-69)/12)*440};this.playSound=function(e){if(o==null){return}var t=o.currentTime;var r=1/16;var i=1/64;var a=r;var n=o.createGain();var l=null;var s=null;l=o.createOscillator();l.type="square";l.connect(n);n.connect(o.destination);switch(e){case SOUND_REMOVE:r=1/32;l.type="triangle";l.frequency.setValueAtTime(u(69),t);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.3,o.currentTime+1/16);n.gain.linearRampToValueAtTime(0,o.currentTime+r*3);a=r*3;break;case SOUND_PLACE:case SOUND_CLICK:r=1/32;l.type="triangle";l.frequency.setValueAtTime(u(69),t);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.3,o.currentTime+1/128);n.gain.linearRampToValueAtTime(0,o.currentTime+r*3);a=r*3;break;case SOUND_FALL:r=1/4;l.type="triangle";l.frequency.setValueAtTime(u(62),t);l.frequency.linearRampToValueAtTime(u(55),t+r*4);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.3,o.currentTime+1/128);n.gain.linearRampToValueAtTime(0,o.currentTime+r*3);a=r*4;break;case SOUND_DIE:r=1/12;l.type="sawtooth";l.frequency.setValueAtTime(u(56),t);l.frequency.linearRampToValueAtTime(u(49),t+r);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.2,o.currentTime+r);n.gain.linearRampToValueAtTime(0,o.currentTime+r*2);a=r*2;break;case SOUND_JUMP:r=1/12;l.type="triangle";l.frequency.setValueAtTime(u(55),t);l.frequency.setValueAtTime(u(62),t+r);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.2,o.currentTime+1/64);n.gain.linearRampToValueAtTime(0,o.currentTime+r*2);a=r*2;break;case SOUND_GREEN:r=1/4;l.type="triangle";l.frequency.setValueAtTime(u(43),t);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.2,o.currentTime+1/32);n.gain.linearRampToValueAtTime(0,o.currentTime+r);a=r;break;case SOUND_RED:r=1/4;l.type="triangle";l.frequency.setValueAtTime(u(47),t);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.2,o.currentTime+1/32);n.gain.linearRampToValueAtTime(0,o.currentTime+r);a=r;break;case SOUND_EXIT:r=1/12;l.type="triangle";l.frequency.setValueAtTime(u(55),t);l.frequency.setValueAtTime(u(62),t+r);l.frequency.setValueAtTime(u(67),t+r*2);n.gain.setValueAtTime(0,t);n.gain.linearRampToValueAtTime(.3,o.currentTime+1/64);n.gain.linearRampToValueAtTime(0,o.currentTime+r*6);a=r*6;break}l.start(o.currentTime);l.stop(o.currentTime+a)}};var LevelSelect=function(e){var d=this;var p=null;var A="#999999";var i="#333333";var g="#bbbbbb";var m=0;var h=0;var E=2;var r=false;var x=[];var y=[];var T=[];var a=0;var n=0;var l=1;var s=2;var o=3;var u=4;var t=function(){var e=levels.length;var t=4;var r=1;var i=1;var a=.4;m=t*(r+a)-a*1.5;h=Math.ceil(e/t)*(i+a);p=document.getElementById("level-select");p.setAttribute("visible",false);p.setAttribute("position",new THREE.Vector3(-(E*m/2),-10.5,0));p.setAttribute("scale","2 2 2");var n=document.createElement("a-text");n.setAttribute("value","Level Select");n.setAttribute("scale","4 4 4");n.setAttribute("color","#eeeeee");n.setAttribute("position",new THREE.Vector3(.05,1.6,-h+.5));p.append(n);for(var l=0;l<e;l++){T.push(false);var s=a+l%t*(r+a);var o=0;var u=-a-Math.floor(l/t)*(i+a);var c=document.createElement("a-entity");c.setAttribute("position",new THREE.Vector3(s,0,u));c.setAttribute("level-index",l);var v=document.createElement("a-box");v.setAttribute("scale",new THREE.Vector3(r,.05,i));v.setAttribute("color",A);v.setAttribute("class","clickable");c.append(v);var f=document.createElement("a-text");f.setAttribute("color","#eeeeee");f.setAttribute("align","center");f.setAttribute("rotation","-90 0 0");f.setAttribute("position","0 0.1 0");var b=l+1;f.setAttribute("value",b);f.setAttribute("scale","2.6 2.6 2.6");c.append(f);y.push(f);x.push(c);p.append(c);v.addEventListener("mouseenter",function(e){var t=parseInt(e.target.parentNode.getAttribute("level-index"),10);if(d.getLevelAvailable(t)){z(t,g)}});v.addEventListener("mouseleave",function(e){var t=parseInt(e.target.parentNode.getAttribute("level-index"),10);if(d.getLevelAvailable(t)){z(t,A)}});v.addEventListener("click",function(e){var t=parseInt(e.target.parentNode.getAttribute("level-index"),10);if(d.getLevelAvailable(t)){g_sound.init();g_sound.playSound(SOUND_CLICK);var t=parseInt(e.target.parentNode.getAttribute("level-index"),10);_(t)}})}T[0]=true};var z=function(e,t){var r=x[e];r.children[0].setAttribute("color",t);if(t==i){y[e].setAttribute("color","#999999")}else{y[e].setAttribute("color","#eeeeee")}};d.tick=function(e,t){switch(a){case l:n+=t/500;if(n>1){n=1;a=o}c(n);break;case s:n-=t/500;if(n<.01){n=.01;p.setAttribute("visible",false);p.setAttribute("position",new THREE.Vector3(-(E*m/2),-10.5,0));a=u;setTimeout(function(){g_playfield.startLevel(r)},20);return}c(n);break}};var c=function(e){n=e;for(var t=0;t<x.length;t++){x[t].setAttribute("scale",new THREE.Vector3(e,e,e))}};d.show=function(){v();c(.01);a=l;p.setAttribute("visible",true);p.setAttribute("position",new THREE.Vector3(-(E*m/2),-.5,0))};d.setLevelAvailable=function(e,t){if(e<T.length){T[e]=t}};d.getLevelAvailable=function(e){return T[e]};var v=function(){for(var e=0;e<x.length;e++){if(d.getLevelAvailable(e)){z(e,A)}else{z(e,i)}}};var _=function(e){r=e;a=s};t();v()};