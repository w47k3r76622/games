(function(){function e(i,h,g){this.instrument=i;this.notes=h.split(",");this.tempo=g||1;this.freq=[];this.time=0;this.index=0;if(e.freqs.length==0){var f=Math.pow(2,1/12);for(var j=-57;j<50;j++){e.freqs.push(440*Math.pow(f,j))}}}e.keys={c:0,db:1,d:2,eb:3,e:4,f:5,gb:6,g:7,ab:8,a:9,bb:10,b:11};e.freqs=[];e.prototype.parse=function(g){var f=g.match(/([a-z]+)(\d+)([a-z]*)(\d*)([a-z]*)(\d*)([a-z]*)(\d*)([a-z]*)(\d*)([a-z]*)(\d*)/);if(f){f.shift();while(f.length){var i=f.shift(),h=f.shift();if(h){this.freq.push(e.freqs[parseInt(h)*12+e.keys[i]])}}}};e.prototype.get=function(){if(++this.index>this.time){var h=this.notes.shift(),f=h?h.match(/^(\d+)(.*)$/):false;if(!f){return false}this.freq=[];this.time=this.instrument.sample/parseInt(f[1])*this.tempo;this.index=0;this.parse(f[2])}var j=0;for(var g=0;g<this.freq.length;g++){j+=this.instrument.get(this.freq[g],this.index)}return this.freq.length>0?j/this.freq.length:0};function d(h,g,f){this.oscillator=new b(h);this.sample=h;this.form=g;this.config=f}d.prototype.vol=function(f){if(this.form==0){return 1}var g=f/this.sample;return g<this.form?1-(g/this.form):0};d.prototype.get=function(i,f){var h=0;for(var g in this.config){h+=this.oscillator.get(i,f,g)*this.config[g]}if(h>1){h=1}if(h<-1){h=-1}return h*this.vol(f)};function b(f){this.sample=f;this.random=this.rnd();this.flop=0}b.prototype.rnd=function(){return Math.random()*2-1};b.prototype.get=function(j,g,h){var i,f=this.sample/j;switch(h){case"sin":return -Math.sin((g%f)/f*Math.PI*2);case"sqr":return Math.round(g/f*2)%2?1:-1;case"saw":return(g%f)/f*2-1;case"noi":i=Math.round(g/f)%2;if(this.flop!=i){this.flop=i;this.random=this.rnd()}return this.random}return 0};function c(f){this.keys="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.sample=f;this.instrument=[new d(f,1,{sqr:-0.2,sin:0.5}),new d(f,0.3,{sqr:0.4,sin:0.4}),new d(f,0.7,{sin:2}),new d(f,0.1,{noi:0.2}),new d(f,0.1,{sin:0.6})]}c.prototype.add=function(n){var h=this.buffer,i,g,f,m,l,k,j;if(n!==undefined){h.push(n)}if(h.length>2||n===undefined){i=h.shift();g=h.shift();f=h.shift();m=i>>2;l=((i&3)<<4)|(g>>4);k=((g&15)<<2)|(f>>6);j=f&63;if(isNaN(g)){k=j=64}else{if(isNaN(f)){j=64}}this.data=this.data+this.keys.charAt(m)+this.keys.charAt(l)+this.keys.charAt(k)+this.keys.charAt(j)}};c.prototype.str=function(g){for(var f=0;f<g.length;f++){this.add(g.charCodeAt(f))}return this};c.prototype.num=function(h,g){for(var f=0;f<g;f++){this.add(h%256);h=Math.floor(h/256)}return this};c.prototype.write=function(g){this.str("RIFF").num(g.length+36,4).str("WAVEfmt ").num(16,4).num(1,2).num(1,2).num(this.sample,4).num(this.sample,4).num(1,2).num(8,2).str("data").num(g.length,4);for(var f=0;f<g.length;f++){this.add(g[f])}this.add();delete g;return this.data};c.prototype.handle=function(l){this.buffer=[];this.data="data:audio/wav;base64,";var h=1.25,n=l.split("|",this.instrument.length);channel=[],data=[];for(var k=0;k<n.length;k++){channel.push(new e(this.instrument[k],n[k],h))}do{var g=0,m=0,o=0;for(var f=0;f<channel.length;f++){o=channel[f].get();if(o!==false){m+=o;g++}}if(g>0){data.push(Math.round(m/g*120+128))}}while(g>0);return this.write(data)};var a=new c(22050);self.addEventListener("message",function(g){var f=a.handle(g.data);self.postMessage(f)})})();