<!DOCTYPE html><html><head><meta name=viewport content="width=device-width,initial-scale=1.0,user-scalable=no"><meta name=monetization content=$ilp.uphold.com/h9LD2x8DNkhJ><script>(function(){const getId=(()=>{let e=0;return()=>++e})(),last=e=>e[e.length-1],resetArray=e=>e.length=0,on=(e,t,i,s=!1)=>e.addEventListener(t,i,s),off=(e,t,i)=>e.removeEventListener(t,i),once=(e,t,i)=>on(e,t,i,{once:!0}),onceFn=e=>{let t=!0;return()=>{t&&(t=!1,e())}},stopDead=e=>{e.preventDefault(),e.stopPropagation()},vec3=(e=0,t=0,i=0)=>new Float32Array([e,t,i]),vec4=(e=0,t=0,i=0,s=0)=>new Float32Array([e,t,i,s]),noop=()=>{},getBody=e=>e.body;function isTouchDevice(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}const setColor=(e,t,i,s)=>r=>(r.color[0]=e,r.color[1]=t,r.color[2]=i,r.color[3]=s,r),pointBody=(e,t)=>(i,s)=>{const r=i.drone.body,n=t.x-e.x,o=t.y-e.y,a=Math.sqrt(n*n+o*o)||1;r.x=e.x,r.y=e.y;const h=n/a,c=o/a,l=(o<0?-1:1)*Math.acos(h);r.x-=h*s*70+c*Math.cos(s%2)*100,r.y-=c*s*70+h*Math.sin(s%2)*100,r.angle=-l},show=e=>e.hidden=!1,hide=e=>e.hidden=!0,dist2=(e,t)=>(e.x-t.x)**2+(e.y-t.y)**2,getHash=()=>location.hash.split("#")[1],APP_NAME="404Race",DRONE_RADIUS=40,CP_RADIUS=125,CAMERA_Z=-20,MAX_LAPS=2,INIT_VIEW=1,MAIN_VIEW=2,RACE_VIEW=3,CREDITS_VIEW=4,isTouch=isTouchDevice(),clickEvent=isTouch?"touchstart":"click",brightRed=setColor(1,.2,0,1),dark=setColor(.1,.1,.1,1),darkGreen=setColor(0,.6,0,1),darkGrey=setColor(.3,.3,.3,1),lightGrey=setColor(.8,.8,.8,1),electricBlueTransparent=setColor(.31,.573,.816,.3),green=setColor(0,1,0,1),grey=setColor(.6,.6,.6,1),lila=setColor(.5,0,1,1),darkLila=setColor(.25,0,.7,1),red=setColor(1,0,0,1),blue=setColor(0,0,1,1),yellow=setColor(1,1,0,1),{PI:PI,cos:cos,sin:sin,sqrt:sqrt,floor:floor,tan:tan,ceil:ceil,abs:abs}=Math,PI2=2*PI,colors={ground:setColor(.9,.6,0,1),hill:darkGrey,other:setColor(1,.7,0,1)},levels={desert:{colors:colors,hills:[[0,0,150],[240,100,140],[-160,180,120],[260,550,150],[60,450,100],[60,320,50],[-160,650,200],[-370,580,80],[-390,500,40],[-440,460,30],[-395,420,30],[-490,450,30],[-455,420,30],[500,0,200],[500,600,200],[730,450,120],[1300,300,500],[1300,-500,500],[0,-1400,1100],[-300,-300,100],[-400,-200,50],[250,-300,100],[630,-230,100],[750,-500,100],[-1400,0,1e3]].map(e=>e.map(e=>2.7*e)),others:[[-4,-36.5,5,10,5,10],[22,3,5,5,5,10],[7,42,5,5,5,10],[-15,20,5,5,5,10],[-49,52,5,5,5,10],[60,-24,5,5,5,10]].map(e=>e.map(e=>.7*e)),checkpoints:[[13,2],[1,2],[0,2],[2,2],[2,3],[0,3],[0,0],[1,0],[13,0],[22,0],[22,1],[13,1],[15,0]]},forest:{colors:{ground:setColor(0,.5,0,1),hill:darkGrey,other:red},hills:[[0,0,180],[150,-330,200],[-100,-600,180],[-260,-280,100],[-150,-900,150],[-350,-850,100],[-450,-550,100],[-450,-850,100],[-450,-850,100],[-850,-1200,300],[-450,-1200,150],[-200,-1070,30],[-190,-1130,40],[-190,-1130,40],[-250,-1400,130],[-250,-1400,130],[-50,-1150,30],[-50,-1230,50],[-90,-1310,60],[30,-1010,60],[-1300,0,1e3],[0,390,40],[270,200,30],[430,-140,30],[430,-570,30],[130,-770,50],[230,-900,30],[240,-650,30]].map(e=>e.map(e=>2.7*e)),checkpoints:[[0,2],[22,3],[0,1],[23,3],[1,1],[24,3],[2,1],[25,1],[4,1],[19,1],[19,0],[16,2],[17,3],[12,3],[5,0],[7,0],[7,3],[7,2],[2,3],[1,3],[0,3]]},maze:(()=>{const e={hills:[],checkpoints:[[30,0],[23,0]],colors:colors};let t=0,i=0;for(t=-2;t<5;t++)for(i=-2;i<5;i++)e.hills.push([400*t,400*i,70]);for(t=0;t<4;t++)e.checkpoints.push([21+t+2,3]);for(t=4;t>0;t--)e.checkpoints.push([28+t+2,1]);return e})(),arena:{colors:colors,hills:[[0,0,150],[-300,0,150],[300,0,150],[-150,0,150],[150,0,150],[0,2400,2e3],[0,-2400,2e3],[2700,0,2e3],[-2700,0,2e3],[0,350,50]].map(e=>e.map(e=>2.7*e)),checkpoints:[[0,2],[1,2],[1,3],[1,0],[0,0],[2,0],[2,1],[2,2]]}};class Circle{constructor(e,t,i,s,r,n){this.x=e,this.y=t,this.vx=0,this.vy=0,this.r=i,this.angle=0,this.m=s,this.isSensor=r,this.isColliding=n,this.belongsTo=""}}class Collision{constructor(){this.a=null,this.b=null,this.dt=0,this.isSensor=!1}}function createPhysics(e,t){const i=[];let s=0,r=0,n=0;for(s=0;s<1e3;s++)i.push(new Collision);let o=0,a=0,h=0;const c=[],l=[],d=[],p=(e,t)=>{t.x+=t.vx*e,t.y+=t.vy*e},v=(e,t)=>{const s=t.x-e.x,r=t.y-e.y,n=s*s+r*r,h=e.r+t.r;if(n<h*h){const c=sqrt(n)||1,l=s/c,d=r/c;if(t.isColliding){const i=ceil((h-c)/2);e.x-=l*i,e.y-=d*i,t.x+=l*i,t.y+=d*i}else{const t=ceil(h-c);e.x-=l*t,e.y-=d*t}const p=i[o];return p.a=e,p.b=t,p.dt=0,p.isSensor=!1,o++,void a++}const c=y(e,t,!1);if(c<0||c>1)return;const l=i[o];l.a=e,l.b=t,l.dt=c,l.isSensor=!1,o++,a++},u=(e,t)=>{const s=t.x-e.x||1,r=t.y-e.y||1;if(s*s+r*r<t.r*t.r){const s=i[o];return s.a=e,s.b=t,s.dt=0,s.isSensor=!0,o++,void a++}const n=y(e,t,!0);if(n<0||n>1)return;const h=i[o];h.a=e,h.b=t,h.dt=n,h.isSensor=!0,o++,a++},y=(e,t,i)=>{const s=t.x-e.x,r=t.y-e.y,n=t.vx-e.vx,o=t.vy-e.vy,a=n*n+o*o;if(0===a)return 2;const h=n*s+o*r,c=h*h-a*(s*s+r*r-(i?(t.r-1)*(t.r-1):(t.r+e.r)*(t.r+e.r)));if(c<0)return-2;const l=h,d=sqrt(c),p=1/a,v=-(d+l)*p,u=(d-l)*p;return v<0||u<0?v<u?u:v:v<u?v:u},m=({a:t,b:i,isSensor:s})=>{if(s)return;const r=i.x-t.x,n=i.y-t.y,o=sqrt(r*r+n*n)||1,a=r/o,h=n/o;if(!i.isColliding){const e=i.r+t.r;return t.x-=r-a*e+2*a,t.y-=n-h*e+2*h,t.vx=-t.vx,void(t.vy=-t.vy)}const c=t.m,l=i.m,d=i.vx-t.vx,p=i.vy-t.vy;if(0===t.vx&&0===t.vy&&0===i.vx&&0===i.vy)return;let v=abs(2*(a*d+h*p)*(c*l)/(c+l));v<e&&(v=e),t.vx-=a*v/c,t.vy-=h*v/c,i.vx+=a*v/l,i.vy+=h*v/l},g=e=>{const t=a,o=c.length;let h=!1;for(s=0;s<o;s++){const e=c[s];for(r=s+1;r<o;r++){const t=c[r];for(h=!1,n=0;n<a;n++)if(i[n].a===e&&i[n].b===t){h=!0;break}h||v(e,t)}for(r=0;r<l.length;r++){const t=l[r];for(h=!1,n=0;n<a;n++)if(i[n].a===e&&i[n].b===t){h=!0;break}h||v(e,t)}}return t!==a},b=e=>{const t=a,o=c.length,h=d.length;let l=!1;for(s=0;s<o;s++){const e=c[s];for(r=0;r<h;r++){const t=d[r];for(l=!1,n=0;n<a;n++)if(i[n].a===e&&i[n].b===t){l=!0;break}l||u(e,t)}}return t!==a};return{isStarted:!1,circle:(e,t,i,s,r,n)=>new Circle(e,t,i,s,r,n),step:e=>{a=0,o=0;let n=0;for(;n<1;)if(h=a,g()||b()){let t=i[h];for(s=h+1;s<a;s++)i[s].dt<t.dt&&(t=i[s]);const o=t.dt;for(n+=o,s=h;s<a;s++){for(r=0;r<c.length;r++)p(o,c[r]);i[s].dt<=o&&(m(i[s]),e(i[s]))}}else{for(s=0;s<c.length;s++)p(1-n,c[s]);n=1}for(s=0;s<c.length;s++)(l=c[s]).vx=l.vx*t,l.vy=l.vy*t;var l},add(e){(e.isSensor?d:e.isColliding?c:l).push(e)},reset(){c.length=0,l.length=0,d.length=0}}}class Controls{constructor(e,t){this.target=e,this.isStarted=!1,this.keys=[],this.isTouch=t,this.center=new Float32Array(2),this.pointer=new Float32Array(2),this.prevPointer=new Float32Array(2),this.dir=new Float32Array(2),this.keydown=this.keydown.bind(this),this.keyup=this.keyup.bind(this),this.touch=this.touch.bind(this),this.touchEnd=this.touchEnd.bind(this)}keydown(e){this.keys[e.keyCode]=!0}keyup(e){this.keys[e.keyCode]=!1}touch(e){this.isTouch=!0,this.pointer[0]=e.changedTouches[0].clientX,this.pointer[1]=e.changedTouches[0].clientY}touchEnd(){this.pointer[0]=this.center[0],this.pointer[1]=this.center[1]}start(){this.isStarted||(this.pointer[0]=this.center[0],this.pointer[1]=this.center[1],this.isStarted=!0,this.target.addEventListener("keydown",this.keydown),this.target.addEventListener("keyup",this.keyup),this.target.addEventListener("touchstart",this.touch,!1),this.target.addEventListener("touchmove",this.touch,!1),this.target.addEventListener("touchend",this.touchEnd,!1))}stop(){this.isStarted&&(this.pointer[0]=this.center[0],this.pointer[1]=this.center[1],this.isStarted=!1,this.target.removeEventListener("keydown",this.keydown),this.target.removeEventListener("keyup",this.keyup),this.target.removeEventListener("touchstart",this.touch),this.target.removeEventListener("touchmove",this.touch),this.target.removeEventListener("touchend",this.touchEnd,!1))}isChanged(){return this.pointer[0]!==this.prevPointer[0]||this.pointer[1]!==this.prevPointer[1]}getDir(){if(this.pointer[0]||this.pointer[1]){if(this.isChanged()){this.prevPointer[0]=this.pointer[0],this.prevPointer[1]=this.pointer[1];const e=this.pointer[0]-this.center[0],t=this.pointer[1]-this.center[1],i=sqrt(e*e+t*t);this.dir[0]=e/i,this.dir[1]=t/i}}else this.prevPointer[0]=this.pointer[0],this.prevPointer[1]=this.pointer[1],this.dir[0]=0,this.dir[1]=0;return this.dir}left(){return this.keys[37]||this.keys[65]}up(){return this.keys[38]||this.keys[87]}right(){return this.keys[39]||this.keys[68]}down(){return this.keys[40]||this.keys[83]}draw(e){e.save(),e.translate(this.center[0],this.center[1]),e.strokeStyle="#fff",e.fillStyle="#f00",this.isTouch?this.drawTouch(e):this.drawKeyboard(e),e.restore()}drawKeyboard(e){e.fillRect(0,-40,30,30),e.fillRect(40,0,30,30),e.fillRect(0,0,30,30),e.fillRect(-40,0,30,30)}drawTouch(e){e.beginPath(),e.arc(0,0,50,0,PI2),e.closePath(),e.fill(),e.stroke();const t=this.pointer[0]-this.center[0],i=this.pointer[1]-this.center[1],s=Math.sqrt(t*t+i*i)||1;e.fillStyle="#fff",e.beginPath(),e.arc(t/s*50,i/s*50,10,0,PI2),e.closePath(),e.fill()}}const turnDir=(e,t,i)=>{const s=(i<0?-1:1)*Math.acos(t),r=e<=s?s-e:PI2-e+s,n=e>=s?e-s:e+PI2-s;return r<n?r:-n},keyboardAi=e=>t=>{const{specs:i}=t;let s=0,r=0;return e.right()?s=i.rotPower:e.left()&&(s=-i.rotPower),e.up()?r=i.power:e.down()&&(r=-i.power),!(!s&&!r)&&(t.commands.add(s,r),!0)},touchAi=e=>t=>{const i=e.getDir(),{specs:s}=t,r=s.power;let n=0;return!(!i[0]&&!i[1])&&(n=1.2*(turnDir(t.drone.body.angle,i[0],i[1])<0?-s.rotPower:s.rotPower),!!n&&(t.commands.add(n,r),!0))},autoAi=()=>e=>{const t=levelService.level.cps[e.nextCp].body,{body:i}=e.drone,s=t.x-i.x,r=t.y-i.y,n=sqrt(s*s+r*r),o=s/n;let a=turnDir(i.angle,o,-r)<0?-.05:.05,h=e.specs.power/2;n<100&&abs(a>PI2/8)&&(h=.1,h=.1),e.commands.add(a,h)},keepGoingAi=()=>e=>{e.drone.body.vx/=.95,e.drone.body.vy/=.95},CUBE=0,SPHERE=1,CONTAINER=2,vshader="\nattribute vec4 position;\nattribute vec4 color;\nattribute vec4 normal;\nuniform mat4 mvp;\nuniform mat4 m;\nuniform mat4 it;\nvarying vec4 v_c;\nvarying vec3 v_n;\nvarying vec3 v_p;\nvoid main() {\ngl_Position = mvp * position;\nv_p = vec3(m * position);\nv_n = normalize(vec3(it * normal));\nv_c = color;\n}",fshader="\nprecision mediump float;\nuniform vec3 a;\nuniform vec3 b;\nuniform vec3 c;\nvarying vec3 v_n;\nvarying vec3 v_p;\nvarying vec4 v_c;\nvoid main() {\nvec3 lightDirection = normalize(b - v_p);\nfloat nDotL = max(dot(lightDirection, v_n), 0.0);\nvec3 diffuse = a * v_c.rgb * nDotL;\nvec3 ambient = c * v_c.rgb;\ngl_FragColor = vec4(diffuse + ambient, v_c.a);\n}";class Object3D{constructor(e,t,i,s,r){this.position=e,this.scale=t,this.rotation=i,this.hidden=!1,this.transparent=s,this.type=r,this.parent=null,this.children=[],this.color=vec4(1,0,0,1),this.mMatrix=identity(),this.inverseMatrix=identity(),this.mvpMatrix=identity(),this.transposeMatrix=identity(),this.worldMatrix=identity()}setParent(e){this.parent&&this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent=e,this.parent.children.push(this)}removeParent(){this.parent&&this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent=null}updateTransforms(){transformMut(identityfy(this.mMatrix),this.position,this.scale,this.rotation),this.parent?multMat4Mat4(this.parent.worldMatrix,this.mMatrix,this.worldMatrix):this.worldMatrix.set(this.mMatrix);for(let e=0;e<this.children.length;e++)this.children[e].updateTransforms()}}class Camera extends Object3D{constructor(e,t,i){super(e,t,i,!1,2),this.perspectiveMatrix=null,this.resize()}resize(){this.perspectiveMatrix=perspective({fov:50/180*PI,aspect:window.innerWidth/window.innerHeight,near:1,far:100})}}const create=e=>(t=vec3(),i=vec3(1,1,1),s=vec3(),r=!1)=>new Object3D(t,i,s,r,e);class WebGL{constructor(e,t,i){this.canvas=e,this.shapes=[cube(),sphere(16)],this.object3ds=[[],[]],this.transparents=[[],[]],this.indicesCount=0,this.camera=new Camera(vec3(0,0,0),vec3(1,1,1),vec3()),this.camera.updateTransforms(),this.light=t,this.ambientColor=i,this.gl=this.canvas.getContext("webgl"),this.program=null,this.attribs=null,this.uniforms=null,this.buffers=null,this.aLocation=null,this.bLocation=null,this.cLocation=null,this.cube=create(0),this.sphere=create(1),this.container=create(2),this.add=this.add.bind(this),this.drawOne=this.drawOne.bind(this),this.drawShapes=this.drawShapes.bind(this)}init(){const{gl:e}=this,t=this.program=compile(e,vshader,fshader);this.attribs={position:e.getAttribLocation(t,"position"),normal:e.getAttribLocation(t,"normal"),color:e.getAttribLocation(t,"color")},this.uniforms={m:e.getUniformLocation(t,"m"),mvp:e.getUniformLocation(t,"mvp"),it:e.getUniformLocation(t,"it")},this.buffers={positions:buffer(e,this.shapes[0][0],this.attribs.position,3,e.FLOAT),normals:buffer(e,this.shapes[0][1],this.attribs.normal,3,e.FLOAT),indices:e.createBuffer()},e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.aLocation=e.getUniformLocation(t,"a"),this.bLocation=e.getUniformLocation(t,"b"),this.cLocation=e.getUniformLocation(t,"c"),this.gl.uniform3fv(this.cLocation,this.ambientColor)}add(e){const{transparent:t,type:i}=e;return 2!==i&&(t?this.transparents[i]:this.object3ds[i]).push(e),e.parent||e.setParent(this.camera),e.children.forEach(this.add),e}bindBuffer([e,t,i]){const{gl:s}=this;s.bindBuffer(s.ARRAY_BUFFER,this.buffers.positions),s.bufferData(s.ARRAY_BUFFER,e,s.STATIC_DRAW),s.vertexAttribPointer(this.attribs.position,3,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.buffers.normals),s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW),s.vertexAttribPointer(this.attribs.normal,3,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.buffers.indices),s.bufferData(s.ELEMENT_ARRAY_BUFFER,i,s.STATIC_DRAW),this.indicesCount=i.length}drawOne({worldMatrix:e,mvpMatrix:t,inverseMatrix:i,transposeMatrix:s,color:r,hidden:n,type:o}){if(n)return;const{gl:a}=this;a.uniformMatrix4fv(this.uniforms.m,!1,e),a.vertexAttrib4fv(this.attribs.color,r),a.uniformMatrix4fv(this.uniforms.mvp,!1,multMat4Mat4(this.camera.perspectiveMatrix,e,t)),a.uniformMatrix4fv(this.uniforms.it,!1,transpose(inverse(e,i),s)),a.drawElements(a.TRIANGLES,this.indicesCount,a.UNSIGNED_SHORT,0)}drawShapes(e,t){e&&e.length&&(this.bindBuffer(this.shapes[t]),e.forEach(this.drawOne))}draw(){this.gl.uniform3fv(this.aLocation,this.light.color),this.gl.uniform3fv(this.bLocation,this.light.position),this.gl.enable(this.gl.BLEND),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.object3ds.forEach(this.drawShapes),this.gl.disable(this.gl.DEPTH_TEST),this.transparents.forEach(this.drawShapes),this.gl.enable(this.gl.DEPTH_TEST)}reset(){this.object3ds.forEach(resetArray),this.transparents.forEach(resetArray)}resize(){this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.camera.resize(),this.camera.updateTransforms()}}function compile(e,t,i){const s=e.createShader(e.VERTEX_SHADER);e.shaderSource(s,t),e.compileShader(s);const r=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(r,i),e.compileShader(r);const n=e.createProgram();return e.attachShader(n,s),e.attachShader(n,r),e.linkProgram(n),e.useProgram(n),n}function buffer(e,t,i,s,r){const n=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.vertexAttribPointer(i,s,r,!1,0,0),e.enableVertexAttribArray(i),n}function identity(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function identityfy(e){return e.fill(0),e[0]=e[5]=e[10]=e[15]=1,e}function multMat4Mat4(e,t,i){let s,r,n,o,a;for(s=0;s<4;s++)r=e[s],n=e[s+4],o=e[s+8],a=e[s+12],i[s]=r*t[0]+n*t[1]+o*t[2]+a*t[3],i[s+4]=r*t[4]+n*t[5]+o*t[6]+a*t[7],i[s+8]=r*t[8]+n*t[9]+o*t[10]+a*t[11],i[s+12]=r*t[12]+n*t[13]+o*t[14]+a*t[15];return i}function perspective(e){const{near:t,far:i,fov:s,aspect:r}=e,n=1/tan(s),o=1/(t-i);return new Float32Array([n/r,0,0,0,0,n,0,0,0,0,(i+t)*o,-1,0,0,2*t*i*o,0])}const tmp=new Float32Array(16);function transformMut(e,[t,i,s],[r,n,o],[a,h,c]){return(t||i||s)&&(e[12]+=e[0]*t+e[4]*i+e[8]*s,e[13]+=e[1]*t+e[5]*i+e[9]*s,e[14]+=e[2]*t+e[6]*i+e[10]*s,e[15]+=e[3]*t+e[7]*i+e[11]*s),a&&(tmp.fill(0),tmp[0]=1,tmp[10]=tmp[5]=cos(a),tmp[6]=sin(a),tmp[9]=-tmp[6],tmp[15]=1,multMat4Mat4(e,tmp,e)),h&&(tmp.fill(0),tmp[0]=cos(h),tmp[8]=sin(h),tmp[5]=1,tmp[2]=-tmp[8],tmp[10]=tmp[0],tmp[15]=1,multMat4Mat4(e,tmp,e)),c&&(tmp.fill(0),tmp[0]=cos(c),tmp[1]=sin(c),tmp[4]=-tmp[1],tmp[5]=tmp[0],tmp[10]=1,tmp[15]=1,multMat4Mat4(e,tmp,e)),1!==r&&(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r),1!==n&&(e[4]*=n,e[5]*=n,e[6]*=n,e[7]*=n),1!==o&&(e[8]*=o,e[9]*=o,e[10]*=o,e[11]*=o),e}function transpose(e,t){for(let i=0,s=0;i<e.length;i+=4)t[i]=e[s],t[i+1]=e[s+4],t[i+2]=e[s+8],t[i+3]=e[s+12],s++;return t}function inverse(e,t){t[0]=e[5]*e[10]*e[15]-e[5]*e[11]*e[14]-e[9]*e[6]*e[15]+e[9]*e[7]*e[14]+e[13]*e[6]*e[11]-e[13]*e[7]*e[10],t[1]=-e[1]*e[10]*e[15]+e[1]*e[11]*e[14]+e[9]*e[2]*e[15]-e[9]*e[3]*e[14]-e[13]*e[2]*e[11]+e[13]*e[3]*e[10],t[2]=e[1]*e[6]*e[15]-e[1]*e[7]*e[14]-e[5]*e[2]*e[15]+e[5]*e[3]*e[14]+e[13]*e[2]*e[7]-e[13]*e[3]*e[6],t[3]=-e[1]*e[6]*e[11]+e[1]*e[7]*e[10]+e[5]*e[2]*e[11]-e[5]*e[3]*e[10]-e[9]*e[2]*e[7]+e[9]*e[3]*e[6],t[4]=-e[4]*e[10]*e[15]+e[4]*e[11]*e[14]+e[8]*e[6]*e[15]-e[8]*e[7]*e[14]-e[12]*e[6]*e[11]+e[12]*e[7]*e[10],t[5]=e[0]*e[10]*e[15]-e[0]*e[11]*e[14]-e[8]*e[2]*e[15]+e[8]*e[3]*e[14]+e[12]*e[2]*e[11]-e[12]*e[3]*e[10],t[6]=-e[0]*e[6]*e[15]+e[0]*e[7]*e[14]+e[4]*e[2]*e[15]-e[4]*e[3]*e[14]-e[12]*e[2]*e[7]+e[12]*e[3]*e[6],t[7]=e[0]*e[6]*e[11]-e[0]*e[7]*e[10]-e[4]*e[2]*e[11]+e[4]*e[3]*e[10]+e[8]*e[2]*e[7]-e[8]*e[3]*e[6],t[8]=e[4]*e[9]*e[15]-e[4]*e[11]*e[13]-e[8]*e[5]*e[15]+e[8]*e[7]*e[13]+e[12]*e[5]*e[11]-e[12]*e[7]*e[9],t[9]=-e[0]*e[9]*e[15]+e[0]*e[11]*e[13]+e[8]*e[1]*e[15]-e[8]*e[3]*e[13]-e[12]*e[1]*e[11]+e[12]*e[3]*e[9],t[10]=e[0]*e[5]*e[15]-e[0]*e[7]*e[13]-e[4]*e[1]*e[15]+e[4]*e[3]*e[13]+e[12]*e[1]*e[7]-e[12]*e[3]*e[5],t[11]=-e[0]*e[5]*e[11]+e[0]*e[7]*e[9]+e[4]*e[1]*e[11]-e[4]*e[3]*e[9]-e[8]*e[1]*e[7]+e[8]*e[3]*e[5],t[12]=-e[4]*e[9]*e[14]+e[4]*e[10]*e[13]+e[8]*e[5]*e[14]-e[8]*e[6]*e[13]-e[12]*e[5]*e[10]+e[12]*e[6]*e[9],t[13]=e[0]*e[9]*e[14]-e[0]*e[10]*e[13]-e[8]*e[1]*e[14]+e[8]*e[2]*e[13]+e[12]*e[1]*e[10]-e[12]*e[2]*e[9],t[14]=-e[0]*e[5]*e[14]+e[0]*e[6]*e[13]+e[4]*e[1]*e[14]-e[4]*e[2]*e[13]-e[12]*e[1]*e[6]+e[12]*e[2]*e[5],t[15]=e[0]*e[5]*e[10]-e[0]*e[6]*e[9]-e[4]*e[1]*e[10]+e[4]*e[2]*e[9]+e[8]*e[1]*e[6]-e[8]*e[2]*e[5];let i=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12];if(!i)return e;i=1/i;for(let e=0;e<16;e++)t[e]*=i;return t}function cube(){return[new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1]),new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23])]}function sphere(e=25){let t,i,s,r,n,o,a,h,c,l,d=[],p=[];for(n=0;n<=e;n++)for(o=n*PI/e,a=sin(o),h=cos(o),t=0;t<=e;t++)i=2*t*PI/e,s=sin(i),r=cos(i),d.push(s*a,h,r*a);for(n=0;n<e;n++)for(t=0;t<e;t++)c=n*(e+1)+t,l=c+(e+1),p.push(c,l,c+1,c+1,l,l+1);return[new Float32Array(d),new Float32Array(d),new Uint16Array(p)]}class Synth{constructor(e,t){this.tones=new Array(120);for(let e=0;e<120;e++)this.tones[e]=440*Math.pow(2,(e-49)/12);this.isMuted=e,this.ctx=null,this.master=null,this.osc=null,this.stop=this.stop.bind(this),this.onMute=t}init(){if(this.ctx)return;this.ctx=new(window.AudioContext||window.webkitAudioContext);const e=this.ctx.createGain();e.connect(this.ctx.destination),e.gain.value=1,this.master=e;const t=this.ctx.createOscillator();t.connect(this.master);const i=new Float32Array([0,0,1,0,1]),s=new Float32Array(i.length);t.setPeriodicWave(this.ctx.createPeriodicWave(s,i)),t.frequency.value=0,t.start(),this.osc=t}play(e,t,i){this.isMuted||this.timeout||(this.master.gain.setValueAtTime(i,this.ctx.currentTime+.015),this.osc.frequency.setValueAtTime(this.tones[e],this.ctx.currentTime+.015),this.timeout=setTimeout(this.stop,t))}stop(){this.osc.frequency.setValueAtTime(.01,this.ctx.currentTime+.05),setTimeout(()=>this.timeout=null,50)}toggle(){this.onMute(this.isMuted=!this.isMuted)}}class BodyObject3D{constructor(e,t){this.id=getId(),this.body=e,this.object3d=t}update(e){const{x:t,y:i,angle:s}=this.body;this.object3d.position[0]=t/e,this.object3d.position[1]=i/e,this.object3d.rotation[2]=-s}}class GameFactory{constructor(e,t,i){this.physics=e,this.webgl=t,this.scale=i,this.dirs=[[0,-1],[1,0],[0,1],[-1,0]],this.update=this.update.bind(this)}update(e){e.update(this.scale)}hill(e,t,i){const s=i/this.scale*1.01;return new BodyObject3D(this.physics.circle(e,t,i,100,!1,!1),this.webgl.sphere(vec3(0,0,0),vec3(s,s,s/2)))}checkpoint(e,t,i){const s=125/this.scale,r=new BodyObject3D(this.physics.circle(e,t,125,1,!0,!1),this.webgl.sphere(vec3(0,0,0),vec3(s,s,s/10)));return r.body.belongsTo=i,r}drone(e,t,i){const s=i/this.scale,r=cos(PI/3),n=s*r,o=s*(1-r),a=this.webgl.container(),h=grey(this.webgl.sphere(vec3(n,0,s/3*2),vec3(s/5,s/15*2,s/10))),c=this.webgl.sphere(vec3(0,0,o/2),vec3(n+n,o,s/4)),l=this.webgl.cube(vec3(0,o,o),vec3(o,o/4,s/8),vec3(0,PI/4,-PI/4)),d=this.webgl.cube(vec3(0,-o,o),vec3(o,o/4,s/8),vec3(0,PI/4,PI/4)),p=electricBlueTransparent(this.webgl.sphere(vec3(),vec3(s,s,s),vec3(),!0));return c.setParent(a),h.setParent(a),l.setParent(a),d.setParent(a),p.setParent(a),a.children.forEach(grey),brightRed(h),electricBlueTransparent(p),p.hidden=!0,new BodyObject3D(this.physics.circle(e,t,i,1,!1,!0),a)}rainbow(e,t,i){const s=this.webgl.container(),r=red(this.webgl.cube(vec3(0,0,0),vec3(t,e,i))),n=green(this.webgl.cube(vec3(e/3,0,0),vec3(t,e,i))),o=yellow(this.webgl.cube(vec3(e/3*2,0,0),vec3(t,e,i)));return r.setParent(s),n.setParent(s),o.setParent(s),s}vader404(e,t,i){const s=i/this.scale,r=cos(PI/3),n=s*r,o=s*(1-r),a=this.webgl.container(),h=darkGrey(this.webgl.sphere(vec3(0,0,s/3*2),vec3(o,o,o))),c=red(this.webgl.sphere(vec3(o/2,0,s/3*2+o),vec3(s/5,s/15*2,s/10))),l=dark(this.webgl.cube(vec3(0,-o,s),vec3(n/3*4,o/3,n/3*4))),d=dark(this.webgl.cube(vec3(0,o,s),vec3(n/3*4,o/3,n/3*4))),p=electricBlueTransparent(this.webgl.sphere(vec3(),vec3(s,s,s),vec3(),!0));return h.setParent(a),c.setParent(a),l.setParent(a),d.setParent(a),p.setParent(a),p.hidden=!0,new BodyObject3D(this.physics.circle(e,t,i,1,!1,!0),a)}level({hills:e,checkpoints:t,others:i=[],colors:s}){const{ground:r,hill:n,other:o}=s,{webgl:a}=this,h=a.container(),c=e=>e.setParent(h),l=e.map(([e,t,i])=>this.hill(e,t,i));l.map(e=>n(e.object3d)).map(c),l.map(this.update);const d=t.map(([t,i],s)=>this.checkpoint(e[t][0]+this.dirs[i][0]*(e[t][2]+200),e[t][1]+this.dirs[i][1]*(e[t][2]+200),s));d.map(e=>darkLila(e.object3d)).map(c),d.forEach(this.update);i.map(([e,t,i,s,r,n])=>a.cube(vec3(e,t,i),vec3(s,r,n))).map(o).forEach(c);const p=r(a.cube(vec3(0,0,-2),vec3(5e3,5e3,1)));p.setParent(h);const v=a.container(vec3(d[0].object3d.position[0],d[0].object3d.position[1],-.05)),u=dark(a.cube(vec3(0,0,0),vec3(1,10,.1)));u.setParent(v),v.setParent(h);const y=[a.sphere(vec3(-8,12,3),vec3(3,3,1)),a.sphere(vec3(0,12,3),vec3(3,3,1)),a.sphere(vec3(8,12,3),vec3(3,3,1))];return y.forEach(e=>e.setParent(v)),{container:h,cps:d,finishLine:u,ground:p,lights:y,map:l}}digit(e,t=1,i=1,s=1,r=red){const n=this.webgl.container();return[[0,3,0,3,1,1],[-1.5,1.5,0,1,3,1],[1.5,1.5,0,1,3,1],[0,0,0,3,1,1],[-1.5,-1.5,0,1,3,1],[1.5,-1.5,0,1,3,1],[0,-3,0,3,1,1]].map(e=>[vec3(e[0]*t,e[1]*i,e[2]*s),vec3(e[3]*t,e[4]*i,e[5]*s)]).filter((t,i)=>e[i]).map(e=>r(this.webgl.cube(e[0],e[1]))).forEach(e=>e.setParent(n)),n}zero(e,t,i,s){return this.digit([1,1,1,0,1,1,1],e,t,i,s)}four(e,t,i,s){return this.digit([0,1,1,1,0,1,0],e,t,i,s)}}function monetize(e){const t=!!document.monetization;return t&&document.monetization.addEventListener("monetizationstart",e),t}once(window,"load",(function(){const[e,t]=document.getElementsByTagName("canvas"),[i]=document.getElementsByTagName("div"),[s,r]=document.getElementsByTagName("button"),[n]=document.getElementsByTagName("input"),o=t.getContext("2d"),a=createPersistent(APP_NAME),h=new WebGL(e,{position:vec3(-0,-14,-9),color:vec3(.9,.9,.9)},vec3(.2,.2,.2)),c=createPhysics(7,.95),l=new Synth("true"===a.get("muted"),e=>a.set("muted",e)),d=new Controls(document.body,isTouch),p=new GameFactory(c,h,40);let v=0,u=0;if(h.init(),!h.gl)return void(i.innerHTML="<section><h1>Could not launch.</h1><p>WebGL is missing.</p></section>");function y(){const{devicePixelRatio:i,innerWidth:s,innerHeight:r}=window;d.center[0]=s-150,d.center[1]=r-150,e.width=s,e.height=r,t.width=s,t.height=r,h.resize()}h.camera.position[2]=-20,on(window,"resize",y),y(),r.style.visibility="hidden",s.innerText=l.isMuted?"Unmute":"Mute",on(s,clickEvent,e=>{stopDead(e),l.toggle(),s.innerText=l.isMuted?"Unmute":"Mute"});const m=new Player(getId(),p.drone(0,0,40),isTouch?touchAi(d):keyboardAi(d),a.get("name")||"Player");m.color=lightGrey,green(m.drone.object3d.children[0]),monetize(()=>{const{id:e,drone:t,shield:i}=m;t.object3d.hidden=!0,m.drone=p.vader404(t.body.x,t.body.y,50),m.drone.body.angle=t.body.angle,m.drone.body.m=2,m.drone.body.belongsTo=e,i.drone=m.drone,h.add(m.drone.object3d),c.add(m.drone.body)}),n.value=m.name,on(n,"change",()=>{m.name!==n.value&&a.set("name",m.name=n.value)}),on(n,"click",stopDead),playerService.add(m),playerService.me=m;const g=new RaceView(p,l,viewManager,r,d,o,i);on(r,clickEvent,g.reset),viewManager.add(new InitView),viewManager.add(new MainView(p,l,viewManager,i)),viewManager.add(g),viewManager.add(new CreditsView(p,viewManager,i)),viewManager.push(2),viewManager.push(1),function e(t){requestAnimationFrame(e),u=t-v,v=t,o.clearRect(0,0,window.innerWidth,window.innerHeight),viewManager.step(u,Date.now()),h.draw()}(Date.now())}));var createPersistent=e=>({set(t,i){window.localStorage&&window.localStorage.setItem(`${e}-${t}`,i)},get:t=>window.localStorage&&window.localStorage.getItem(`${e}-${t}`)});class Shield{constructor(e){this.drone=e,this.ticks=0}activate(){this.ticks=20,last(this.drone.object3d.children).hidden=!1}step(){this.ticks--<0&&(last(this.drone.object3d.children).hidden=!0)}}class Commands{constructor(){this.all=new Float32Array(480),this.latest=0,this.prevNext=0,this.next=0,this.length=0}add(e,t){this.all[this.next]=e,this.all[this.next+1]=t,this.all[this.next+2]=1,this.all[this.next+3]=Date.now(),this.prevNext=this.next,this.next+=4,this.length++,this.next>=this.all.length&&(this.next=0,this.length=120)}hasNonApplied(){return this.all[this.latest+2]}apply(e,t){if(!this.length)return;const i=this.latest,{body:s}=e;if(this.all[i+2]&&(this.all[i+2]=0,this.latest=this.latest+4>=this.all.length?0:this.latest+4,(this.next===this.all.length-4&&0===this.latest||this.latest>this.next)&&(this.latest=this.next),s.angle+=this.all[i],s.angle>PI2?s.angle-=PI2:s.angle<0&&(s.angle+=PI2),s.vx**2+s.vy**2<t.maxA**2)){const e=this.all[i+1];s.vx+=cos(s.angle)*e,s.vy+=-sin(s.angle)*e}}traceBack(e){let t=this.latest,i=t;for(;this.all[t+3]>e;)this.all[t+2]=1,i=t,t=(t-4<0?this.all.length:t)-4;this.latest=i}}class Player{constructor(e,t,i,s=""){this.id=e,this.name=s,this.color=red,this.shield=new Shield(t),this.drone=t,this.drone.body.belongsTo=e,this.ai=i,this.nextCp=0,this.cpTicks=0,this.lap=0,this.endTime=0,this.syncTics=0,this.specs={mInc:.1,maxA:10,maxAInc:.1,power:1,powerInc:.1,maxRot:2,rotPower:.05,rotPowerInc:.001},this.commands=new Commands,this.step=this.step.bind(this)}setId(e){this.id=e,this.drone.body.belongsTo=e}step(e){this.shield.step(),this.ai(this),this.commands.hasNonApplied()&&this.commands.apply(this.drone,this.specs)}}class LevelService{constructor(){this.startTime=0,this.index=0,this.prevIndex=-1,this.levels=["desert","maze","forest","arena"],this.level=null,this.wins=0}initLevel(e,t){const{webgl:i,physics:s}=e;return this.level=e.level(levels[t||this.levels[this.index]]),this.index!==this.prevIndex&&(this.prevIndex=this.index,playerService.playerArray.sort((e,t)=>e===playerService.me?1:t===playerService.me?-1:0)),this.index===this.levels.length-1&&playerService.playerArray.forEach(t=>{t!==playerService.me&&(t.drone=e.drone(0,0,40+10*(this.wins+1)),t.drone.body.belongsTo=t.id,t.shield.drone=t.drone)}),i.reset(),s.reset(),playerService.playerArray.forEach(t=>{s.add(t.drone.body),i.add(t.drone.object3d),t.color(t.drone.object3d.children[1]),t.nextCp=0,t.cpTicks=0,t.lap=0,t.endTime=0,e.update(t.drone)}),green(this.level.cps[0].object3d),this.level.cps.map(getBody).forEach(s.add),this.level.map.map(getBody).forEach(s.add),i.add(this.level.container),i.light.position[2]=-10,i.camera.position.fill(0),i.camera.position[2]=-20,i.camera.rotation.fill(0),this.level}incLevel(){this.index++}isWon(){return this.index>=this.levels.length}reset(e){this.index=0,0===this.index&&playerService.playerArray.forEach((t,i)=>{t!==playerService.me&&(t.drone=e.drone(0,0,40+4*i),t.drone.body.belongsTo=t.id,t.shield.drone=t.drone,t.specs.maxA+=1)})}}class PlayerService{constructor(){this.me=null,this.players={},this.playerArray=[],this.colors=[red,blue,lila,yellow,green,dark,brightRed],this.t=0,this.data=[8,[]],this.commandData=[7,new Array(4)]}prepareSinglePlayer(e,t){if(this.playerArray.length<2){this.players={},this.players[this.me.id]=this.me;for(let t=0;t<6;t++){const i=new Player(getId(),e.drone(0,0,40+2*t),e=>{const t=levelService.level.cps[e.nextCp].body,{body:i}=e.drone,s=t.x-i.x,r=t.y-i.y,n=sqrt(s*s+r*r),o=s/n;let a=turnDir(i.angle,o,-r)<0?-.05:.05,h=e.specs.power/2;n<100&&abs(a>PI2/8)&&(h=.1,h=.1),e.commands.add(a,h)},"Ai "+(t+1));i.color=this.colors[t],i.specs.maxA+=.1*t,this.add(i)}}}add(e){this.players[e.id]=e,this.playerArray=Object.values(this.players),this.data[1].push(new Array(11))}remove(e){this.players[e]&&(delete this.players[e],this.playerArray=Object.values(this.players),this.data[1].pop())}}const levelService=new LevelService,playerService=new PlayerService;var SET_ME=1,RESET=2,REMOVE_TARGET=3,SET_TARGET=4,SET_HOST=5,ADD_CANDIDATE=6,COMMAND=7,SYNC=8,NAME=9,START_TIME=10;class ViewManager{constructor(){this.views=[],this.a=[]}step(e,t){const i=this.views[last(this.a)];i.step(e,t),i.isDone&&(this.a.pop(),i.remove(),this.views[last(this.a)].init(e,t))}add(e){this.views[e.name]=e}push(e){return this.a.push(e)}}const viewManager=new ViewManager;class View{constructor(e){this.name=e,this.isDone=!1}init(e,t){}step(e,t){}remove(){}}class InitView extends View{constructor(){super(1),this.isDone=!0}}class MainView extends View{constructor(e,t,i,s){super(2),this.overlay=s,this.gameFactory=e,this.synth=t,this.viewManager=i,this.interval=-1,this.angle=0,this.t=0,this.singlePlayer=this.singlePlayer.bind(this)}singlePlayer(){playerService.prepareSinglePlayer(this.gameFactory,this.viewManager.views[3]),this.isDone=!0}init(e,t){this.t=t,this.isDone=!1,this.overlay.innerHTML=`<h1 id="b">Race</h1><h2 id="a">${isTouch?"TAP":"CLICK"} TO PLAY<h2>`,once(document.body,clickEvent,this.singlePlayer);const i=levelService.initLevel(this.gameFactory,"desert");[this.gameFactory.four(.7,.7,.7),this.gameFactory.zero(.7,.7,.7),this.gameFactory.four(.7,.7,.7)].map(e=>this.gameFactory.webgl.add(e)).forEach((e,t)=>{e.position[0]=i.finishLine.position[0]-5+5*t,e.position[1]=i.finishLine.position[1],e.position[2]=8,e.setParent(i.container)})}step(e,t){const i=sin(this.angle+=.001);this.t=t,this.gameFactory.webgl.camera.position[2]=-20+i,this.gameFactory.webgl.camera.rotation[1]=.3*i,this.gameFactory.webgl.camera.updateTransforms()}remove(){this.gameFactory.webgl.camera.position[2]=-20,this.gameFactory.webgl.camera.rotation[1]=0,this.synth.init(),this.gameFactory.webgl.reset(),this.overlay.innerHTML="",this.viewManager.push(3),levelService.prevIndex=-1}}class RaceView extends View{constructor(e,t,i,s,r,n,o){super(3),this.gameFactory=e,this.synth=t,this.viewManager=i,this.restartButton=s,this.controls=r,this.context2d=n,this.overlay=o,this.biip=null,this.boop=null,this.buup=null,this.isRaceDone=!1,this.isStarted=!1,this.isReady=!1,this.t=0,this.update=this.update.bind(this),this.reset=this.reset.bind(this),this.onCollision=this.onCollision.bind(this),this.leaderboard=new Leaderboard(this)}init(e,t){const{gameFactory:i,synth:s}=this,{physics:r}=i;this.isRaceDone=!1,this.isStarted=!1,this.isReady=!1,this.isDone=!1,r.isStarted=!1,this.leaderboard.init(),this.restartButton.style.visibility="visible",this.biip=onceFn(s.play.bind(s,50,500,.5)),this.boop=onceFn(s.play.bind(s,45,500,.5)),this.buup=onceFn(s.play.bind(s,40,500,.5)),this.controls.start();const n=levelService.initLevel(i);var o,a;playerService.playerArray.forEach((o=n.cps[0].body,a=n.cps[1].body,(e,t)=>{const i=e.drone.body,s=a.x-o.x,r=a.y-o.y,n=Math.sqrt(s*s+r*r)||1;i.x=o.x,i.y=o.y;const h=s/n,c=r/n,l=(r<0?-1:1)*Math.acos(h);i.x-=h*t*70+c*Math.cos(t%2)*100,i.y-=c*t*70+h*Math.sin(t%2)*100,i.angle=-l})),playerService.playerArray.forEach(this.update),n.lights.forEach(grey),levelService.startTime=t+1e3,this.overlay.innerHTML='<h1 class="b">1 / 2</h1>'}update(e){e.step(this.t),this.gameFactory.update(e.drone)}step(e,t){this.t=t;const i=t-levelService.startTime;this.controls.draw(this.context2d),i<0||(this.isReady?(playerService.playerArray.forEach(this.update),this.gameFactory.physics.step(this.onCollision),this.isRaceDone&&this.leaderboard.render(),this.isDone=this.leaderboard.isDone):i<1e3?(this.buup(),levelService.level.lights.forEach(red)):i<2e3?(this.boop(),levelService.level.lights.forEach(yellow)):(this.biip(),this.isStarted||(this.isStarted=!0,this.gameFactory.physics.isStarted=!0,levelService.level.lights.forEach(green)),playerService.playerArray.forEach(this.update),this.gameFactory.physics.step(this.onCollision),i>4e3&&(levelService.level.lights.forEach(hide),this.isReady=!0)));const s=this.gameFactory.webgl.camera.position[0]=-playerService.me.drone.object3d.position[0],r=this.gameFactory.webgl.camera.position[1]=-playerService.me.drone.object3d.position[1];this.gameFactory.webgl.light.position[0]=s+levelService.level.cps[playerService.me.nextCp].object3d.position[0],this.gameFactory.webgl.light.position[1]=r+levelService.level.cps[playerService.me.nextCp].object3d.position[1],this.gameFactory.webgl.camera.updateTransforms()}onCollision({a:e,b:t}){if(t.isSensor){const i=t.belongsTo,s=playerService.players[e.belongsTo];if(s.nextCp===i){s.cpTicks++;const e=s.nextCp;if(s.nextCp++,s.nextCp>=levelService.level.cps.length&&(s.nextCp=0),s===playerService.me&&(lila(levelService.level.cps[e].object3d),green(levelService.level.cps[s.nextCp].object3d),this.synth.play(50,.1,.1)),s.cpTicks>1&&0===e&&(s.lap++,s.lap>=2&&!s.endTime&&(this.isRaceDone=!0,s.endTime=this.t),s===playerService.me)){const e=s.lap+1;e<=2&&(this.overlay.innerHTML=`<h1 class="b">${e>2?2:e} / 2</h1>`)}}}else{const i=playerService.players[e.belongsTo],s=playerService.players[t.belongsTo],r=playerService.me;let n=r===i||r===s?.5:0;if(i&&(i.shield.activate(),!n)){const e=16e4-dist2(r.drone.body,i.drone.body);n=1-(e<=0?1:e/16e4)}if(s&&(s.shield.activate(),!n)){const e=16e4-dist2(r.drone.body,i.drone.body);n=1-(e<=0?1:e/16e4)}n&&this.synth.play(i&&s?45:25,.05,n)}}reset(e){stopDead(e),this.gameFactory.webgl.reset(),this.gameFactory.physics.reset(),this.init(0,this.t)}remove(){this.leaderboard.remove(),levelService.isWon()?(levelService.reset(this.gameFactory),this.viewManager.push(4)):this.viewManager.push(3),this.restartButton.style.visibility="hidden",this.gameFactory.webgl.reset(),this.gameFactory.physics.reset()}}class Leaderboard{constructor(e){this.view=e,this.isDone=!1,this.finishedCount=0,this.doneButton=null,this.setDone=this.setDone.bind(this)}init(){this.doneButton=null,this.isDone=!1,this.finishedCount=0}isFinished(e){return e.endTime}countFinished(e,t){return t.endTime?e+1:e}byRaceTime(e,t){return e.endTime||t.endTime?e.endTime?t.endTime?e.endTime-t.endTime:-1:1:t.cpTicks-e.cpTicks}setDone(e){stopDead(e);playerService.playerArray.sort(this.byRaceTime)[0]===playerService.me&&levelService.incLevel(),this.isDone=!0}toPlacement(e,t){return e.endTime?t<5?`<p>${t+1}. ${e.name}</p>`:5===t?"<p>...</p>":"":""}render(){const e=playerService.playerArray.reduce(this.countFinished,0);var t,i,s;this.finishedCount!==e&&(this.doneButton&&(t=this.doneButton,i=clickEvent,s=this.setDone,t.removeEventListener(i,s)),this.finishedCount=e,this.view.overlay.innerHTML=`<div><div class="a"><h1>FINISH</h1>${playerService.playerArray.sort(this.byRaceTime).map(this.toPlacement).join("")}<button>Play ${playerService.playerArray[0]===playerService.me?"Next":"Again"}</button></div></div>`,this.doneButton=this.view.overlay.getElementsByTagName("button")[0],once(this.doneButton,clickEvent,this.setDone))}remove(){this.view.overlay.innerHTML=""}}class CreditsView extends View{constructor(e,t,i){super(4),this.overlay=i,this.gameFactory=e,this.viewManager=t,this.angle=0,this.setDone=this.setDone.bind(this)}setDone(){this.isDone=!0}init(){this.isDone=!1,this.overlay.innerHTML=`<div><div class="a">\n    <h1>You won!</h1>\n    <p>Price 404</p>\n    <p>${levelService.wins?1===levelService.wins?"The bots will be even harder. Not sure if the game is winnable.":"The bots are insane. Can not win.":"The bots will be harder from now on."}</p>\n    <p>By: <a href="http://viljamipeltola.com/">VP</a></p>\n    <p>Thanks: KK, SN</p>\n    </div></div>\n    <h1 id="a"><br><br><br>To lobby</h1>`,levelService.initLevel(this.gameFactory,"arena"),this.gameFactory.webgl.camera.position[2]*=1.5,once(document.body,clickEvent,this.setDone),levelService.wins++}step(e,t){this.gameFactory.webgl.camera.rotation[1]=.3*sin(this.angle+=.001),this.gameFactory.webgl.camera.updateTransforms()}remove(){this.gameFactory.webgl.camera.rotation[1]=0,this.gameFactory.webgl.reset(),this.viewManager.push(2),this.overlay.innerHTML=""}}})();</script><style>body{background-color:#000}body,canvas,div,html{width:100%;height:100%;margin:0;padding:0;position:fixed;top:0;left:0;overflow:hidden;color:#fff;font-family:arial;overflow:hidden}.a{top:50%;left:50%;transform:translate(-50%,-50%);margin:10px;max-width:400px;padding:20px;height:auto;background-color:rgba(0,0,0,.5)}#a,section{position:fixed;top:50%;left:0;right:0;text-align:center;animation:a 2s infinite}#b{text-align:center;padding-top:50px}.b{float:right;margin-right:20px}button,input{position:relative;border:0;background:#fff;color:#000;padding:10px 20px;margin:0 0 5px 0}menu{position:fixed;bottom:0}@keyframes a{0%{color:#fff}50%{color:#666}100%{color:#fff}}</style></head><body><noscript>Enable JS</noscript><canvas></canvas><canvas></canvas><div></div><nav><input> <button>Mute</button> <button>Restart</button></nav></body></html>