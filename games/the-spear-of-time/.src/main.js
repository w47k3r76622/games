function resize_canvas(){game.adjustCanvas()}!function(t,e){"function"==typeof define&&define.amd?define(["exports"],e):e("object"==typeof exports&&"string"!=typeof exports.nodeName?exports:t.TinyMusic={})}(this,function(t){function e(t){var n=t.split(r);this.frequency=e.getFrequency(n[0])||0,this.duration=e.getDuration(n[1])||0}function n(t,e,n){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,n||[])}var a="B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb",i=440*Math.pow(Math.pow(2,1/12),-9),s=/^[0-9.]+$/,o=4,r=/\s+/,h=/(\d+)/,c={};a.split("|").forEach(function(t,e){t.split("-").forEach(function(t){c[t]=e})}),e.getFrequency=function(t){var e=t.split(h),n=c[e[0]],a=(e[1]||o)-o,s=i*Math.pow(Math.pow(2,1/12),n);return s*Math.pow(2,a)},e.getDuration=function(t){return s.test(t)?parseFloat(t):t.toLowerCase().split("").reduce(function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)},0)},n.prototype.createFxNodes=function(){var t=[["bass",100],["mid",1e3],["treble",2500]],e=this.gain=this.ac.createGain();return t.forEach(function(t,n){n=this[t[0]]=this.ac.createBiquadFilter(),n.type="peaking",n.frequency.value=t[1],e.connect(e=n)}.bind(this)),e.connect(this.ac.destination),this},n.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof e?t:new e(t))}.bind(this)),this},n.prototype.createCustomWave=function(t,e){e||(e=t),this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(e)]},n.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},n.prototype.scheduleNote=function(t,e){var n=60/this.tempo*this.notes[t].duration,a=n*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,a),this.setFrequency(0,e+a),e+n},n.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},n.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},n.prototype.slide=function(t,e,n){var a=this.getNextNote(t),i=this.getSlideStartDelay(n);return this.setFrequency(this.notes[t].frequency,e+i),this.rampFrequency(a.frequency,e+n),this},n.prototype.setFrequency=function(t,e){return this.osc.frequency.setValueAtTime(t,e),this},n.prototype.rampFrequency=function(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this},n.prototype.play=function(t){return t="number"==typeof t?t:this.ac.currentTime,this.createOscillator(),this.osc.start(t),this.notes.forEach(function(e,n){t=this.scheduleNote(n,t)}.bind(this)),this.osc.stop(t),this.osc.onended=this.loop?this.play.bind(this,t):null,this},n.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this},t.Note=e,t.Sequence=n}),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}();var letters={A:[[,1],[1,,1],[1,,1],[1,1,1],[1,,1]],B:[[1,1],[1,,1],[1,1,1],[1,,1],[1,1]],C:[[1,1,1],[1],[1],[1],[1,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1,1],[1,,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[1,1,1],[,,1],[,,1],[1,,1],[1,1,1]],K:[[1,,,1],[1,,1],[1,1],[1,,1],[1,,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,1,1,1,1],[1,,1,,1],[1,,1,,1],[1,,,,1],[1,,,,1]],N:[[1,,,1],[1,1,,1],[1,,1,1],[1,,,1],[1,,,1]],O:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],P:[[1,1,1],[1,,1],[1,1,1],[1],[1]],Q:[[0,1,1],[1,,,1],[1,,,1],[1,,1,1],[1,1,1,1]],R:[[1,1],[1,,1],[1,,1],[1,1],[1,,1]],S:[[1,1,1],[1],[1,1,1],[,,1],[1,1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[1,1,1]],V:[[1,,,,1],[1,,,,1],[,1,,1],[,1,,1],[,,1]],W:[[1,,,,1],[1,,1,,1],[1,,1,,1],[1,,1,,1],[1,1,1,1,1]],X:[[1,,,,1],[,1,,1],[,,1],[,1,,1],[1,,,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1,1,1],[,,,1],[,,1],[,1],[1,1,1,1,1]],0:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],1:[[,1],[,1],[,1],[,1],[,1]],2:[[1,1,1],[,,1],[1,1,1],[1,,],[1,1,1]],3:[[1,1,1],[,,1],[,1,1],[,,1],[1,1,1]],4:[[1,,1],[1,,1],[1,1,1],[,,1],[,,1]],5:[[1,1,1],[1,,],[1,1,1],[,,1],[1,1,1]],6:[[1,1,1],[1,,],[1,1,1],[1,,1],[1,1,1]]," ":[[,,],[,,],[,,],[,,],[,,]],"?":[[1,1,1],[,,1],[,1,1],[,1],[],[,1]],":":[[],[,1],[],[,1],[],[]],".":[[],[,,],[],[,,],[,1],[]],"!":[[,1],[,1],[,1],[,,],[,1],[,,]],"[":[[1,1],[1,,],[1,,],[1,,],[1,1]],"]":[[,1,1],[,,1],[,,1],[,,1],[,1,1]],">":[[,1],[,1,1],[,1,1,1],[,1,1],[,1]]},Story=function(){var t,e,n,a="rgb(0, 207, 20)",i="rgb(153, 153, 255)",s="rgb(204, 255, 229)",o="rgb(246, 207, 20)",r="rgb(153, 255, 153)",h=function(){t={presentation:{t:"      The spear of time",n:"thursday1",c:o,s:"music"},thursday1:{t:"It is thursday.",n:"thursday2",c:o},thursday2:{t:"In my experience nothing good happens on Thursdays.",n:"today_shame",c:o},today_shame:{t:"A shame it has to be done today or it may not happen again.",n:"item_list",c:o},item_list:{t:"Went through a lot of trouble to gather the items, but I am ready.",n:"obtained_items",c:o},obtained_items:{t:"Obtained: The list. Amulet of protection. Book of incantations. Spear of time.",n:"q1",c:s},q1:{t:"Use Item:",a:[{t:"Read list",n:"q1.list"},{t:"Use Amulet",n:"q1.nothing"},{t:"Read Incantation",n:"q1.nothing"},{t:"Use spear",n:"q1.spear"}],c:o},"q1.nothing":{t:"Is not the time to use this.",n:"q1",c:o},"q1.spear":{t:"You use the spear to pierce your heart.",n:"q1.spear.death",c:s,s:"clear"},"q1.spear.death":{t:"Death: Fool, It was not your time, but nothing escapes me.",n:"q1.spear.death2",c:i},"q1.spear.death2":{t:"Death: [ sings ]",n:"q1.spear.song",c:i},"q1.spear.song":{t:"You hear the song calling your soul, separating it from your body.",n:"q1.spear.dies",c:o},"q1.spear.dies":{t:"You died.",n:"q1.q1",c:o},"q1.q1":{t:"The spear grants you another chance:",a:[{t:"Try again",n:"thursday1"}],c:o},"q1.list":{t:"Alex Anderson 11:13 pm. The bus stop at 34th street.",n:"travel",c:s},travel:{t:"Let's go.",n:"watching",c:o,s:"start"},watching:{t:"There they are. Both on time, which is unfortunate for Alex. I will stay far from sight for now.",n:"d_presents",c:o},d_presents:{t:"Death: I was expecting you Alex. your life hangs by a thread. Your time is short.",n:"a_asks",c:i},a_asks:{t:"Alex: Who are you? How do you know my name?",n:"d_who",c:r},d_who:{t:"Death: I am Death. The Grim Reaper. And your time is up.",n:"n_usual",c:i},n_usual:{t:"Probably Alex is begging for more time. But nothing escapes death.",n:"n_ready",c:o},n_ready:{t:"I should get ready.",n:"q2",c:o},q2:{t:"Use Item:",a:[{t:"Use amulet",n:"q2.amulet"},{t:"Read Incantation",n:"q2.incantation"},{t:"Use spear",n:"q1.spear"}],c:o},"q2.amulet":{t:"This should stop Death.",n:"q2.amulet.shout",c:o},"q2.amulet.shout":{t:"Death! It is your time that is up. [ shouting ]",n:"q2.amulet.a",c:o},"q2.amulet.a":{t:"Alex: ... [ confused ]",n:"q2.amulet.d",c:r},"q2.amulet.d":{t:"Death: It is not you who I want. you are not on the list yet.",n:"q2.amulet.d.song",c:i},"q2.amulet.d.song":{t:"Death: [ sings ]",n:"q2.amulet.d.song2",c:i,s:"clear"},"q2.amulet.d.song2":{t:"You see Alex drop to the floor. And Death vanishes.",n:"q2.amulet.death",c:o},"q2.amulet.death":{t:"Not again...",n:"q2.amulet.death.item",c:o},"q2.amulet.death.item":{t:"Use Item:",a:[{t:"Use spear",n:"q1.spear"}],c:o},"q2.incantation":{t:"You open the book and read the first incantation.",n:"q2.incantation2",c:s},"q2.incantation2":{t:"Alex and Death are frozen in place.",n:"q2.incantation2.d",c:o},"q2.incantation2.d":{t:"The spell is not holding and Death will be free soon.",n:"q3",c:o},q3:{t:"Bought a bit of time. I can use an Item:",a:[{t:"Use amulet",n:"q3.items.amulet"},{t:"Read Incantation",n:"q2.incantation"},{t:"Use spear",n:"q1.spear"}],c:o},"q3.items.amulet":{t:"This should stop Death.",n:"q3.items2",c:o},"q3.items2":{t:"Use Item:",a:[{t:"Use spear",n:"q3.items2.spear"}],c:o},"q3.items2.spear":{t:"You use the spear to pierce your heart.",n:"q3.items2.spear2",c:s},"q3.items2.spear2":{t:"Death: ...[ Tries to move ]",n:"q3.items2.spear3",c:i},"q3.items2.spear3":{t:"The amulet absorbs your soul.",n:"q3.items2.spear4",c:s},"q3.items2.spear4":{t:"Death breaks the spell.",n:"q3.items2.spear5",c:o},"q3.items2.spear5":{t:"Death: [ sings ]",n:"q3.items2.spear6",c:i},"q3.items2.spear6":{t:"Nothing happens.",n:"q3.items2.spear7",c:o},"q3.items2.spear7":{t:"Death: [ confused ] [ sings again]",n:"q3.items2.spear8",c:i},"q3.items2.spear8":{t:"Nothing happens again.",n:"q3.items2.spear9",c:o},"q3.items2.spear9":{t:"You take out the spear from your heart.",n:"q4",c:o},q4:{t:"With the Spear in hand there is one more thing to do",a:[{t:"Kill Death",n:"q4.kill"}],c:o},"q4.kill":{t:"You pierce Death and it banishes leaving just the robes and the scythe.",n:"q4.kill2",c:o,s:"clear"},"q4.kill2":{t:"The robes float and wrap your body. you pick up the scythe.",n:"q4.kill3",c:o},"q4.kill3":{t:"Sorry Alex, but your life hangs by a thread. Your time is short.",n:"q4.kill4",c:o},"q4.kill4":{t:"           [ sings ]",n:"q4.kill.end",c:o,s:"stop"},"q4.kill.end":{t:"            The end",n:"q4.kill.end",c:o}},e=t.presentation,n=!1},c=function(){return e.t},u=function(a,i){if(l())for(var s=e.a,o=0;o<s.length;o++){var r=s[o];if("bb"in r){var h=r.bb;if(h.x1<=a&&a<=h.x2&&h.y1<=i&&i<=h.y2){e=t[r.n];break}}}else"s"in e&&("start"==e.s?n=!0:"clear"==e.s?n=!1:"music"==e.s?sequence.play():"stop"==e.s&&sequence.stop()),e=t[e.n]},l=function(){return!("n"in e)&&"a"in e},p=function(){if(l())return e.a},d=function(){return!!n},m=function(){return"c"in e?e.c:a};return{init:h,next:u,currentDescription:c,isQuestion:l,answers:p,displayBackground:d,color:m}},Game=function(){var t,e,n,a,i,s,o,r=document.getElementById("gameCanvas"),h=r.getContext("2d"),c=170,u="rgb(246, 207, 20)",l="rgb(255, 255, 153)",p=function(){h.fillStyle="rgb(0,0,0)",h.fillRect(0,0,r.width,r.height)},d=function(t,e,n,a){var i={tl:5,tr:5,br:5,bl:5};h.beginPath(),h.moveTo(t+i.tl,e),h.lineTo(t+n-i.tr,e),h.quadraticCurveTo(t+n,e,t+n,e+i.tr),h.lineTo(t+n,e+a-i.br),h.quadraticCurveTo(t+n,e+a,t+n-i.br,e+a),h.lineTo(t+i.bl,e+a),h.quadraticCurveTo(t,e+a,t,e+a-i.bl),h.lineTo(t,e+i.tl),h.quadraticCurveTo(t,e,t+i.tl,e),h.closePath(),h.lineWidth=2,h.fill(),h.stroke()},m=function(t,e,n,a,i){h.fillStyle=i,h.beginPath();var s=[];t=t.toUpperCase();for(var o=0;o<t.length;o++){var r=letters[t.charAt(o)];r&&s.push(r)}var c=n;for(o=0;o<s.length;o++){r=s[o];for(var u=a,l=0,p=0;p<r.length;p++){for(var d=r[p],m=0;m<d.length;m++)d[m]&&h.rect(c+m*e,u,e,e);l=Math.max(l,d.length*e),u+=e}c+=e+l}h.closePath(),h.fill()},q=function(t,e,n,i,s){h.strokeStyle=s,h.fillStyle="rgba(0, 0, 0, 0)",d(a+t,e,i,n),e+=5,t+=5,n-=10,d(a+t,e,i-10,n)},g=function(t,e){for(var n=[],a=t.split(" "),i="",s=0;s<a.length;s++){var o=i.length;o+a[s].length<=e?(i+=a[s]+" ",s==a.length-1&&n.push(i)):(n.push(i),i=a[s]+" ",s==a.length-1&&n.push(i))}return n},f=function(){var n=i+e.height+80,r=50,c=e.width-2*r,p=6,d=n+20,f=r+30,y=(c-f)/(4*p)+3,w=6*p,b=t.currentDescription(),v=g(b,y),x=t.color();q(r,n,(v.length+1)*w,c,x);for(var A=0,D=0;D<v.length;D++){var I={x1:a+f,y1:d+A,x2:a+f+c,y2:d+A+w};m(v[D],p,I.x1,I.y1,x),A+=w}A+=w,t.isQuestion()&&t.answers().forEach(function(t){var e=g("> "+t.t,y),n={x1:a+f,y1:d+A,x2:a+f+c,y2:d+A+e.length*w};t.bb=n;for(var i=n.y1,r=0;r<e.length;r++)n.x1<=s&&s<=n.x2&&n.y1<=o&&o<=n.y2?(x=l,h.strokeStyle=l):(x=u,h.strokeStyle=u),m(e[r],p,n.x1,i,x),A+=w,i+=w;A+=w/2})},y=function(){h.clearRect(0,0,r.width,r.height),p(),t.displayBackground()&&(h.drawImage(e,a,i),h.save(),h.scale(1,-1),h.globalAlpha=.2,h.drawImage(e,a,2*-e.height-i),h.restore()),f()},w=function(){},b=function(){y(),w(),requestAnimationFrame(b)},v=function(){r.width=window.innerWidth,r.height=window.innerHeight,void 0!=e&&(a=(r.width-e.width)/2,i=(r.height-e.height)/2-c)},x=function(t,e){var n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},A=function(a){t=new Story,t.init(),n=3,e=resize(a,n),v(),r.addEventListener("mousemove",function(t){var e=x(r,t);s=e.x,o=e.y},!1),r.addEventListener("mousedown",function(e){var n=x(r,e);"Mouse click: "+n.x+","+n.y;t.next(n.x,n.y)},!1)};return{init:A,loop:b,adjustCanvas:v}},resize=function(t,e){var n=t.width*e,a=t.height*e,i=document.createElement("canvas");i.width=t.width,i.height=t.height;var s=i.getContext("2d");s.drawImage(t,0,0);var o=s.getImageData(0,0,t.width,t.height),r=document.createElement("canvas");r.width=n,r.height=a;for(var h=r.getContext("2d"),c=h.getImageData(0,0,n,a),u=0;u<a;u++)for(var l=0;l<n;l++){var p=4*(Math.floor(u/e)*t.width+Math.floor(l/e)),d=4*(u*n+l);c.data[d]=o.data[p],c.data[d+1]=o.data[p+1],c.data[d+2]=o.data[p+2],c.data[d+3]=o.data[p+3]}return h.putImageData(c,0,0),r},game=new Game,gameImage=new Image;gameImage.src="./js13k_2016.png",gameImage.onload=function(){game.init(gameImage),game.loop()};var ac="undefined"!=typeof AudioContext?new AudioContext:new webkitAudioContext,tempo=40,sequence=new TinyMusic.Sequence(ac,tempo,["B2 q","G1 e","- e","G1 e","B2 e","G1 e","- e","G1 e","B2 e","C2 q","B2 q","D2 s","C2 s","A2 q","B2 q","G1 q","D2 q","E2 q","B2 q","D2 q","F2 q","E2 q","D2 q","C2 q","B2 q","D2 s","C2 s","A2 q","A2 q","G1 q","A2 q","B1 q","E1 e","G1 q","B1 e","D1 q","G1 e"]);sequence.gain.gain.value=.05,sequence.loop=!0;