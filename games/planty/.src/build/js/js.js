function animate(){var a=!1;for(keys.SHIFT&&player.stamina>0?(player.stamina-=4,moveSpeed=4):(player.stamina<=99&&player.stamina++,moveSpeed=2),frameCount++>=1e3&&(frameCount=0),i=0;i<spawns.length;i++)if(spawns[i].cd--<=0){spawns[i].cd=spawnCD;var b=spawns[i].nextElement;spawns[i].nextElement=spawns[i].types[Math.floor(4*Math.random())],enemies.push({x:spawns[i].x,y:spawns[i].y,w:5,h:5,hp:10,speed:Math.random()+.5,type:b})}c.save(),c.clearRect(0,0,800,600),drawWalls(),drawPickups(),drawProjectiles(),drawSpawns(),drawEnemies(),drawFinish(),collideEnemies(),checkFinish(),a=checkMove("LEFT","x",!0)||a,a=checkMove("RIGHT","x",!1)||a,a=checkMove("UP","y",!0)||a,a=checkMove("DOWN","y",!1)||a;var d=collision(player,enemies);d>-1&&die(),pickup(),collideProjecties(),keys.SPACE&&player.cd<=0&&player.type?(drawPlant("Shoot"),shoot()):drawPlant(player.cd>15?"Shoot":a===!0?frameCount%15>10?2:frameCount%15>5?1:3:1),"spirit"===player.type&&(walls.length>0&&(walls=outerWalls,projectileSpeed=5,get("howto").innerHTML="<h2>You found the 5th element! Now you get to spend eternity keeping the balance!<h2>"),shoot5()),player.cd>0&&player.cd--,c.restore(),stop===!1&&(animateID=window.requestAnimationFrame(animate))}function checkMove(a,b,c){if(keys[a]){if(player.lastDirection=a,c?player[b]-=moveSpeed:player[b]+=moveSpeed,index=collision(player,walls),!(index>-1)||elements[walls[index].type])return!0;c?player[b]+=moveSpeed:player[b]-=moveSpeed}return!1}function collideProjecties(){for(i=0;i<projectiles.length;i++){var a=collision(projectiles[i],walls);a>-1&&walls[a].type!==player.type?projectiles.splice(i,1):(a=collision(projectiles[i],enemies),a>-1&&(player.type===enemies[a].type?(enemies[a].w+=2,enemies[a].h+=2):(projectiles.splice(i,1),enemies.splice(a,1))))}}function collideEnemies(){for(i=0;i<enemies.length;i++){var a=enemies[i];a.x+=a.x<player.x?a.speed:-a.speed;var b=collision(a,walls);-1===b||a.type===walls[b].type||(a.x-=a.x<player.x?a.speed:-a.speed),a.y+=a.y<player.y?a.speed:-a.speed,b=collision(a,walls),-1===b||a.type===walls[b].type||(a.y-=a.y<player.y?a.speed:-a.speed)}}function finished(){currLvl++,goLevel(currLvl)}function checkFinish(){collision(player,[finish])>-1&&finished()}function shoot(){var a={x:player.x,y:player.y,w:6,h:6,color:colors[player.type],tX:0,tY:0};a=modDirection(a),projectiles.push(a),player.cd=shootCD}function shoot5(){var a=["RIGHT","LEFT","UP","DOWN"];for(i=0;i<a.length;i++){var b={x:player.x,y:player.y,w:6,h:6,color:"#"+(16777215*Math.random()<<0).toString(16),tX:10*Math.random()-5,tY:10*Math.random()-5};b[a[i]]=!0,b=modDirection(b),projectiles.push(b)}}function modDirection(a){return(keys.RIGHT||a.RIGHT)&&(a.x+=player.w,a.y+=10,a.tX=projectileSpeed),(keys.LEFT||a.LEFT)&&(a.y+=10,a.tX=0-projectileSpeed),(keys.UP||a.UP)&&(a.tY=0-projectileSpeed,a.x+=player.w/2),(keys.DOWN||a.DOWN)&&(a.y+=player.h,a.tY=projectileSpeed,a.x+=player.w/2),0===a.tX&&0===a.tY&&(a[player.lastDirection]=!0,a=modDirection(a)),a}function collision(a,b){var c;for(c=0;c<b.length;c++){var d=b[c];if(a.x+a.w>d.x&&a.x<d.x+d.w&&a.y+a.h>d.y&&a.y<d.y+d.h)return c}return-1}function pickup(){var a=collision(player,pickups);a>-1&&(gain(pickups[a].type),pickups.splice(a,1))}function gain(a){elements.push({type:a,color:colors[a]}),elements[a]=!0,1===elements.length&&(player.type=a)}function get(a){return document.getElementById(a)}function die(){window.cancelAnimationFrame(animateID),stop=!0,get("btn").classList.remove("hidden"),get("dead").classList.remove("hidden"),get("content").classList.add("disabled"),get("btn").focus(),get("dead").classList.remove("disabled"),get("btn").innerHTML="Try again",get("dead").style.top="579px"}function again(){goLevel(currLvl)}function goLevel(a){var b=window.location.toString();window.location=b.split("?")[0]+"?autoStart=1&level="+a}function drawPickups(){for(i=0;i<pickups.length;i++){var a=pickups[i];rect(a.x,a.y,a.w,a.h,colors[a.type])}}function drawWalls(){for(i=0;i<walls.length;i++){var a=walls[i];rect(a.x,a.y,a.w,a.h,colors[a.type])}}function drawEnemies(){for(i=0;i<enemies.length;i++){var a=enemies[i];a.w<enemyWidth&&(a.w++,a.h++),rect(a.x,a.y,a.w,a.h,colors[a.type],"purple")}}function drawProjectiles(){for(i=0;i<projectiles.length;i++){var a=projectiles[i];a.x+=a.tX,a.y+=a.tY,rect(a.x,a.y,a.w,a.h,a.color)}}function drawSpawns(){for(i=0;i<spawns.length;i++)c.strokeStyle="black",c.fillStyle=colors[spawns[i].nextElement],c.beginPath(),c.arc(spawns[i].x,spawns[i].y,spawns[i].w,0,2*Math.PI,!0),c.stroke(),c.fill()}function drawFinish(){c.fillStyle="gray",c.font="20pt Helvetica",c.fillText("Exit",finish.x+55,finish.y+45)}function rect(a,b,d,e,f,g){c.strokeStyle=g||"black",c.fillStyle=f,c.beginPath(),c.rect(a,b,d,e),c.stroke(),c.fill()}function drawPlant(a){var b=player.x,d=player.y;for(keys.LEFT||"LEFT"===player.lastDirection?flipImage(root["planty"+a],b,d):c.drawImage(root["planty"+a],b,d),i=0;i<elements.length;i++){var e=elements[i],f=player.type===e.type?6:5;rect(b+5*i,d,f,f,e.color)}rect(b,d+player.h,player.w*(player.stamina/100),3,"yellow")}function flipImage(a,b,d){b=-1*a.width+0-b,c.save(),c.scale(-1,1),c.drawImage(a,b,d,a.width,a.height),c.restore()}function showL1Instructions(){get("l1i").style.display="block",get("collect").style.top="46px",get("avoid").style.top="251px",get("go").style.top="545px"}function hideL1Instructions(){get("l1i").display="none"}function wall(a){var b=[];for(i=0;i<a.length;i++)b.push({x:a[i][0],y:a[i][1],w:a[i][2],h:a[i][3],type:a[i][4]});return b}function setKey(a,b){var c=a.keyCode;switch(c){case 32:keys.SPACE=b,stop===!1&&a.preventDefault();break;case 37:case 65:keys.LEFT=b,a.preventDefault();break;case 38:case 87:keys.UP=b,a.preventDefault();break;case 39:case 68:keys.RIGHT=b,a.preventDefault();break;case 40:case 83:keys.DOWN=b,a.preventDefault();break;case 16:keys.SHIFT=b;break;case 49:case 50:case 51:case 52:var d=3-(52-c);elements[d]&&(player.type=elements[d].type);break;case 97:case 98:case 99:case 100:var d=3-(100-c);elements[d]&&(player.type=elements[d].type)}}function onLoad(){var a=location.search;if(a.indexOf("autoStart")>-1){get("game").classList.remove("disabled"),get("btn").classList.add("hidden");var b=qs(location.search);currLvl=parseInt(b.level),1===currLvl?showL1Instructions():hideL1Instructions();var c=levels[currLvl],d=wall(c.walls);walls=outerWalls.concat(d),spawns=c.spawns,pickups=c.pickups,finish=c.finish[0]||{},player=c.player,spawnCD=spawns[0].cd,stop=!1,animateID=window.requestAnimationFrame(animate)}}function qs(a){for(var b,c={},d=/[?&]?([^=]+)=([^&]*)/g;b=d.exec(a);)c[b[1]]=b[2];return c}var can=document.getElementById("game"),c=can.getContext("2d"),animateID,player,stop=!0,root=this,f="fire",w="water",s="spirit",a="air",e="earth",planty1=new Image;planty1.src="./images/planty1.gif";var planty2=new Image;planty2.src="./images/planty2.gif";var planty3=new Image;planty3.src="./images/planty3.gif";var plantyShoot=new Image;plantyShoot.src="./images/plantyShoot.gif";var i,projectileSpeed=5,shootCD=20,spawnCD=120,enemyWidth=20,frameCount=0,moveSpeed=0,keys=[],currLvl=1,levels=[],outerWalls=[{x:0,y:0,w:10,h:600},{x:790,y:0,w:10,h:600},{x:0,y:590,w:800,h:10},{x:0,y:0,w:800,h:10}];levels[1]={walls:[[210,490,180,10,w],[210,490,10,100,w],[390,490,10,100,w]],spawns:[{x:400,y:250,w:10,h:10,types:[f,e,s,a],nextElement:e,cd:120}],pickups:[{x:40,y:40,w:10,h:10,type:w}],finish:[{x:225,y:510,w:160,h:70}],player:{x:100,y:100,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[2]={walls:[[80,400,10,190,a],[10,400,80,10,w],[100,150,400,10,e],[300,10,10,150,e],[610,490,180,10,f],[600,390,10,200,s]],spawns:[{x:350,y:370,w:10,h:10,types:[f,e,s,a],nextElement:a,cd:120}],pickups:[{x:280,y:40,w:10,h:10,type:w},{x:40,y:570,w:10,h:10,type:f},{x:320,y:40,w:10,h:10,type:a}],finish:[{x:620,y:510,w:160,h:70}],player:{x:300,y:200,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[3]={walls:[[10,80,80,10,a],[80,10,10,80,a],[80,400,10,190,e],[600,350,10,250,s],[600,80,10,80,e],[600,160,80,10,e],[10,400,80,10,w],[400,300,10,80,w],[480,300,10,80,w],[410,370,80,10,w],[400,300,80,10,w],[610,400,180,10,f],[610,430,180,10,a],[610,460,180,10,e],[610,490,180,10,w]],spawns:[{x:400,y:250,w:10,h:10,types:[f,e,s,a,w],nextElement:f,cd:120}],pickups:[{x:40,y:40,w:10,h:10,type:w},{x:40,y:570,w:10,h:10,type:f},{x:440,y:335,w:10,h:10,type:e},{x:620,y:140,w:10,h:10,type:a}],finish:[{x:620,y:510,w:160,h:70}],player:{x:100,y:100,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[4]={walls:[[10,100,100,10,f],[400,10,10,580,f],[600,10,10,150,e],[600,150,190,10,e],[600,250,10,250,e],[600,490,10,100,a],[600,490,190,10,a],[500,300,50,10,s],[550,250,60,10,s],[550,250,10,60,s],[500,300,10,60,s],[100,500,100,10,w],[100,10,10,500,w],[200,10,10,500,w]],spawns:[{x:500,y:540,w:10,h:10,types:[f,a,e],nextElement:f,cd:120},{x:300,y:40,w:10,h:10,types:[f,w],nextElement:w,cd:120}],pickups:[{x:40,y:40,w:10,h:10,type:w},{x:760,y:40,w:10,h:10,type:f},{x:580,y:290,w:10,h:10,type:e},{x:150,y:450,w:10,h:10,type:a}],finish:[{x:620,y:510,w:160,h:70}],player:{x:500,y:100,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[5]={walls:[[10,80,360,10],[10,260,360,10],[10,340,360,10],[10,500,360,10],[370,80,10,190],[370,340,10,170],[430,80,380,10],[430,260,380,10],[430,340,380,10],[430,500,380,10],[430,80,10,190],[430,340,10,170]],spawns:[{x:40,y:40,w:10,h:10,types:[f,a,e,w],nextElement:f,cd:10},{x:760,y:40,w:10,h:10,types:[f,a,e,w],nextElement:f,cd:10},{x:40,y:560,w:10,h:10,types:[f,a,e,w],nextElement:f,cd:10},{x:760,y:560,w:10,h:10,types:[f,a,e,w],nextElement:f,cd:10}],pickups:[{x:760,y:300,w:10,h:10,type:s}],finish:[],player:{x:40,y:280,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}};var walls,spawns,pickups,finish,elements=[],colors={fire:"#FA6900",water:"#046D8B",earth:"#784800",air:"ghostwhite",spirit:"black"},enemies=[],projectiles=[];document.addEventListener("keydown",function(a){setKey(a,!0)}),document.addEventListener("keyup",function(a){setKey(a,!1)}),window.addEventListener("blur",function(){keys=[]});