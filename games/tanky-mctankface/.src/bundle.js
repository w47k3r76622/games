!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(t,e,i){},function(t,e,i){"use strict";i.r(e);const s={};function n(t,e){s[t]=s[t]||[],s[t].push(e)}function h(t,e){let i;!s[t]||(i=s[t].indexOf(e))<0||s[t].splice(i,1)}function a(t,...e){s[t]&&s[t].map(t=>t(...e))}const r={};let o,l,c={},d={32:"space",37:"left",38:"up",39:"right",40:"down"};function g(t){const e=d[t.which];c[e]=!0,r[e]&&r[e](t)}function u(t){c[d[t.which]]=!1}function m(){c={}}function f(t){return!!c[t]}function p(){return l}class w{constructor(t=0,e=0){this.x=t,this.y=e}}function y(){const t=o;p().clearRect(0,0,t.width,t.height)}function M(t,e,i,s,n){const h=(performance.now()-t)/100;return{x:s+e*h*Math.cos(-i),y:n-(e*h*Math.sin(-i)-4.9*h*h)}}class x extends w{constructor(t,e,i,s,n){super(t,e),this.damage=1,this.startTime=performance.now(),this.v0=s,this.angle=i,this.damage=n,this.startX=t,this.startY=e}static createCanvas(){const t=document.createElement("canvas");t.width=4,t.height=4;const e=t.getContext("2d");return e.fillStyle="white",e.arc(2,2,2,0,2*Math.PI),e.fill(),t}render(){p().drawImage(x.prerendered,this.x-2,this.y-2)}update(){const t=M(this.startTime,this.v0,this.angle,this.startX,this.startY);super.x=t.x,super.y=t.y}scroll(t){super.x=this.x-t,this.startX=this.startX-t}}x.prerendered=x.createCanvas();class k{constructor(t){this.exploded=!1,this.height=t,this.originalHeight=t}}class S extends w{constructor(t){super(),this.offset=0,this.sectorWidth=t.width,this.gameDimensions=t,this.heightMapsPos=[this.generateHeightMap()],this.heightMapsNeg=[]}generateHeightMap(t){t||(t=100*Math.random());const e=100*Math.random(),i=new Array(this.sectorWidth);return i[0]=new k(t),i[this.sectorWidth-1]=new k(e),this.midpointDisplacement(i,0,this.sectorWidth-1),i}midpointDisplacement(t,e,i){const s=t[e].height,n=s-(s-t[i].height)/2;if(i-e<4)for(let s=e+1;s<i;s++)t[s]=new k(n);else{const s=Math.abs(e-i),h=(Math.random()-.5)*(s/6),a=Math.round(e+(i-e)/2);let r=n+h;r=Math.min(r,100),r=Math.max(r,0),t[a]=new k(r),this.midpointDisplacement(t,e,a),this.midpointDisplacement(t,a,i)}}render(){const t=p();t.fillStyle="#663300",t.beginPath(),t.moveTo(0,this.gameDimensions.height);for(let e=0;e<this.gameDimensions.width+1;e++){const i=this.getGlobalHeight(e);t.lineTo(e,i)}t.lineTo(this.gameDimensions.width,this.gameDimensions.height),t.fill(),t.beginPath(),t.strokeStyle="#006400",t.lineWidth=4,t.moveTo(0,this.getGlobalHeight(0)-1);let e=!1;for(let i=0;i<this.gameDimensions.width;i++){!e&&this.hasExploded(i)?(e=!0,t.stroke(),t.beginPath(),t.strokeStyle="black"):e&&!this.hasExploded(i)&&(e=!1,t.stroke(),t.beginPath(),t.strokeStyle="#006400");const s=this.getGlobalHeight(i)-1;t.lineTo(i,s)}t.stroke()}getGlobalHeight(t,e=!0,i=!1){return this.gameDimensions.height-this.gameDimensions.height/5-this.gameDimensions.height/3*(this.getHeight(t,e,i)/100)}scroll(t){this.offset=this.offset+t,a("scroll",t)}explosion(t){const e=this.getHeight(t);for(let i=t-30;i<t+31;i++){const s=e-(3-.05*Math.abs(i-t)*Math.abs(i-t));s<this.getHeight(i)&&this.changeHeight(i,s)}}getHeightMapAndIndex(t,e=!0){let i=0;e&&(i=this.offset);const s=Math.round(t)+i;let n;const h=s%this.sectorWidth;if(s<0){const t=Math.abs(Math.ceil(s/this.sectorWidth));for(;t>=this.heightMapsNeg.length;){let t;if(this.heightMapsNeg.length<1){t=this.heightMapsPos[0][0].height}else{const e=this.heightMapsNeg[this.heightMapsNeg.length-1];t=e[e.length-1].height}this.heightMapsNeg.push(this.generateHeightMap(t));const e=this.heightMapsNeg.length*-this.sectorWidth;a("newTerrain",e,e+this.sectorWidth-1,this.offset)}n=this.heightMapsNeg[t]}else{const t=Math.floor(s/this.sectorWidth);for(;t>=this.heightMapsPos.length;){const t=this.heightMapsPos[this.heightMapsPos.length-1],e=t[t.length-1].height;this.heightMapsPos.push(this.generateHeightMap(e));const i=(this.heightMapsPos.length-1)*this.sectorWidth;a("newTerrain",i,i+this.sectorWidth-1,this.offset)}n=this.heightMapsPos[t]}return{heightMap:n,idx:Math.abs(h)}}changeHeight(t,e){const{heightMap:i,idx:s}=this.getHeightMapAndIndex(t);i[s].height=Math.max(e,0),i[s].exploded=!0}getHeight(t,e=!0,i=!1){const{heightMap:s,idx:n}=this.getHeightMapAndIndex(t,e);return i?s[n].originalHeight:s[n].height}hasExploded(t){const{heightMap:e,idx:i}=this.getHeightMapAndIndex(t);return e[i].exploded}}class b extends w{constructor(t,e,i,s=!1,n=0){super(t),this.maxHealth=e,this.health=e,this.points=n,this.terrain=i,this.showHealthbar=s}render(){const t=p();if(t.save(),t.translate(this.x,this.y),this.showHealthbar){const e=b.HEALTHBAR_WIDTH*this.health/this.maxHealth;t.fillStyle="green",t.fillRect(b.HEALTHBAR_X,-b.HEALTHBAR_Y_DISPLACEMENT,e,b.HEALTHBAR_HEIGHT),t.fillStyle="red",t.fillRect(b.HEALTHBAR_X+e,-b.HEALTHBAR_Y_DISPLACEMENT,b.HEALTHBAR_WIDTH-e,b.HEALTHBAR_HEIGHT)}this.renderMachine(t),t.restore()}update(t){this.updateMachine(t)}takeDamage(t){this.health=this.health-t.damage}isDead(){return this.health<=0}scroll(t){super.x=this.x-t}}b.HEALTHBAR_WIDTH=30,b.HEALTHBAR_HEIGHT=5,b.HEALTHBAR_X=-b.HEALTHBAR_WIDTH/2,b.HEALTHBAR_Y_DISPLACEMENT=50;class P extends b{constructor(t,e,i,s,n,h,a,r,o,l,c){super(t,a,c,!0,o),this.radius=10,this.gunRotation=.75*-Math.PI,this.lastShot=performance.now(),this.seenTanky=!1,this.tank=e,this.shootingSpeed=i,this.msBetweenShots=s,this.directTrajectory=n,this.inaccuracy=h,this.currentInaccuracyX=2*(Math.random()-.5)*this.inaccuracy,this.currentInaccuracyY=2*(Math.random()-.5)*this.inaccuracy,this.damage=r,this.gameDimensions=l}collidesWith(t){const e=t.x-this.x,i=t.y-this.y;let s=!1;return(Math.sqrt(e*e+i*i)<this.radius+2||Math.abs(e)<this.radius&&t.y>this.y)&&(s=!0),s}renderMachine(t){t.beginPath(),t.fillStyle="grey",t.fillRect(-this.radius,0,2*this.radius,200);let e="green";this.tank.health<this.damage?e="red":this.tank.health/2<this.damage&&(e="orange"),t.fillStyle=e,t.arc(0,0,this.radius,Math.PI,0),t.fill(),t.beginPath(),t.fillStyle=e,t.translate(0,-4),t.rotate(this.gunRotation),t.fillRect(0,-2,20,4)}updateMachine(t){if(super.y=this.terrain.getGlobalHeight(this.x,!0,!0)-20,this.seenTanky||Math.abs(this.x-this.tank.x)<this.gameDimensions.width/2){this.seenTanky=!0;const e=this.tank.x-this.x+this.currentInaccuracyX,i=-(this.tank.y-(this.y-2)+this.currentInaccuracyY),s=Math.pow(this.shootingSpeed,2),n=Math.pow(s,2),h=9.8*(9.8*Math.pow(e,2)+2*i*s);let a;if(a=this.directTrajectory?(s-Math.sqrt(n-h))/(9.8*e):(s+Math.sqrt(n-h))/(9.8*e)){const e=Math.atan(a);let i;i=this.tank.x-this.x>0?-e:-Math.PI-e,this.gunRotation=this.gunRotation-Math.min(this.gunRotation-i,20)*t,performance.now()-this.lastShot>this.msBetweenShots&&(this.fireGun(),this.lastShot=performance.now(),this.currentInaccuracyX=2*(Math.random()-.5)*this.inaccuracy,this.currentInaccuracyY=2*(Math.random()-.5)*this.inaccuracy)}}}fireGun(){const{muzzleX:t,muzzleY:e}=this.getMuzzlePosition();a("spawnProjectile",t,e,this.gunRotation,this.shootingSpeed,this.damage)}getMuzzlePosition(){const t=this.x,e=this.y-2;return{muzzleX:t+20*Math.cos(this.gunRotation),muzzleY:e+20*Math.sin(this.gunRotation)}}}class D{constructor(t){this.currentScore=0,this.isHighscore=!1,this.oldHighScore=t}addPoints(t){this.currentScore+=t,!this.isHighscore&&this.currentScore>this.oldHighScore&&(this.isHighscore=!0),this.isHighscore&&localStorage.setItem("tankymctankface_highscore",String(this.currentScore))}getScore(){return this.currentScore}newHighscore(){return this.isHighscore}getHighscore(){return this.isHighscore?this.currentScore:this.oldHighScore}}const I={songData:[{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[1,1,1,1,1,1,1,1],c:[{n:[140,,,,149,,,,139,,,,148,,,,140,,,,153,,,,140,,,,144],f:[]}]},{i:[0,255,117,1,0,255,110,0,1,0,4,6,35,0,0,0,0,0,0,2,14,0,1,39,76,5,0,0],p:[,1,1,1,1,1,1,1],c:[{n:[140,,,,,,,,140,,,,,,,,140,,,,,,,,140],f:[]}]},{i:[0,160,124,1,0,111,128,0,1,195,4,7,41,0,0,0,93,6,1,2,255,0,0,32,61,5,0,6],p:[,,1,1,1,1,1,1],c:[{n:[,,,,142,,,,,,,,142,,,,,,,,142,,,,,,,,142],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,60,4,10,34,0,0,0,187,5,0,1,239,135,0,32,108,5,0,4],p:[,,,,1,1,2,2],c:[{n:[140,,140,,140,,140,,140,,140,,140,,140,,140,,140,,140,,140,,140,,140,,140,,140],f:[]},{n:[140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140],f:[]}]}],rowLen:6615,patternLen:32,endPattern:7,numChannels:4},R={songData:[{i:[0,255,136,1,0,255,116,0,1,0,4,6,35,0,0,0,0,0,0,2,66,0,0,32,0,0,0,0],p:[1],c:[{n:[116],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},H={songData:[{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,0,6],p:[1],c:[{n:[158],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},T={songData:[{i:[3,160,128,1,0,115,128,0,1,210,4,7,31,0,0,0,60,4,1,2,124,0,0,32,61,5,32,1],p:[1],c:[{n:[111],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1};class L{constructor(t){this.oscillators=[this.osc_sin,this.osc_square,this.osc_saw,this.osc_tri],this.song=t,this.lastRow=t.endPattern,this.currentCol=0,this.numWords=t.rowLen*t.patternLen*(this.lastRow+1)*2,this.mixBuf=new Int32Array(this.numWords)}generate(){const t=new Int32Array(this.numWords),e=this.song.songData[this.currentCol],i=this.song.rowLen,s=this.song.patternLen;let n=0,h=0,a=0,r=0,o=!1,l=[];for(let c=0;c<=this.lastRow;++c){const d=e.p[c];for(let g=0;g<s;++g){const u=d?e.c[d-1].f[g]:0;u&&(e.i[u-1]=e.c[d-1].f[g+s]||0,u<16&&(l=[]));const m=this.oscillators[e.i[15]],f=e.i[16]/512,p=Math.pow(2,e.i[17]-9)/i,w=e.i[18],y=e.i[19],M=43.23529*e.i[20]*3.141592/44100,x=1-e.i[21]/255,k=1e-5*e.i[22],S=e.i[23]/32,b=e.i[24]/512,P=6.283184*Math.pow(2,e.i[25]-9)/i,D=e.i[26]/255,I=e.i[27]*i&-2,R=(c*s+g)*i;for(let n=0;n<4;++n){const h=d?e.c[d-1].n[g+n*s]:0;if(h){l[h]||(l[h]=this.createNote(e.i,h,i));const s=l[h];for(let e=0,i=2*R;e<s.length;e++,i+=2)t[i]+=s[e]}}for(let e=0;e<i;e++){const i=2*(R+e);let s=t[i];if(s||o){let t=M;w&&(t*=m(p*i)*f+.5),h+=(t=1.5*Math.sin(t))*(a=x*(s-h)-(n+=t*h)),s=3===y?h:1===y?a:n,k&&(s=(s*=k)<1?s>-1?this.osc_sin(.25*s):-1:1,s/=k),o=(s*=S)*s>1e-5;const e=Math.sin(P*i)*b+.5;r=s*(1-e),s*=e}else r=0;i>=I&&(r+=t[i-I+1]*D,s+=t[i-I]*D),t[i]=0|r,t[i+1]=0|s,this.mixBuf[i]+=0|r,this.mixBuf[i+1]+=0|s}}}return this.currentCol++,this.currentCol/this.song.numChannels}createWave(){const t=44+2*this.numWords-8,e=t-36,i=new Uint8Array(44+2*this.numWords);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(let t=0,e=44;t<this.numWords;++t){let s=this.mixBuf[t];s=s<-32767?-32767:s>32767?32767:s,i[e++]=255&s,i[e++]=s>>8&255}return i}getData(t,e){const i=2*Math.floor(44100*t),s=new Array(e);for(let n=0;n<2*e;n+=1){const e=i+n;s[n]=t>0&&e<this.mixBuf.length?this.mixBuf[e]/32768:0}return s}osc_sin(t){return Math.sin(6.283184*t)}osc_saw(t){return t%1*2-1}osc_square(t){return t%1<.5?1:-1}osc_tri(t){const e=t%1*4;return e<2?e-1:3-e}getnotefreq(t){return.003959503758*Math.pow(2,(t-128)/12)}createNote(t,e,i){const s=this.oscillators[t[0]],n=t[1],h=t[3],a=this.oscillators[t[4]],r=t[5],o=t[8],l=t[9],c=t[10]*t[10]*4,d=t[11]*t[11]*4,g=t[12]*t[12]*4,u=1/g;let m=t[13];const f=i*Math.pow(2,2-t[14]),p=new Int32Array(c+d+g);let w=0,y=0,M=0,x=0;for(let i=0,k=0;i<c+d+g;i++,k++){k>=0&&(m=m>>8|(255&m)<<4,k-=f,M=this.getnotefreq(e+(15&m)+t[2]-128),x=this.getnotefreq(e+(15&m)+t[6]-128)*(1+8e-4*t[7]));let g=1;i<c?g=i/c:i>=c+d&&(g-=(i-c-d)*u);let S=M;h&&(S*=g*g);let b=s(w+=S)*n;S=x,o&&(S*=g*g),b+=a(y+=S)*r,l&&(b+=(2*Math.random()-1)*l),p[i]=80*b*g|0}return p}}class A{constructor(t,e,i=!1,s=!1){const n=new L(t);let h=!1;for(;!h;)h=n.generate()>=1;new Date;const a=n.createWave(),r=document.createElement("audio");i&&r.setAttribute("loop","loop"),r.src=URL.createObjectURL(new Blob([a],{type:"audio/wav"})),this.audio=r,this.isMusic=s,this.soundSettings=e,this.updateVolume()}play(){if(this.updateVolume(),this.audio.paused){const t=this.audio.play();void 0!==t&&t.then(t=>{}).catch(t=>{})}else this.audio.currentTime=0}pause(){this.audio.pause()}isPaused(){return this.audio.paused}updateVolume(){this.isMusic?this.audio.volume=this.soundSettings.musicVolume:this.audio.volume=this.soundSettings.fxVolume}}class v extends w{constructor(t){super(),this.starPatternX=[],this.starPatternY=[],this.gameDimensions=t,this.sectorWidth=t.width;for(let e=0;e<50;e++)this.starPatternX.push(Math.round(Math.random()*t.width)),this.starPatternY.push(Math.round(Math.random()*t.height))}static createMoon(){const t=document.createElement("canvas");t.width=40,t.height=60;const e=t.getContext("2d");return e.beginPath(),e.fillStyle="yellow",e.arc(30,30,30,0,2*Math.PI,!0),e.fill(),e.globalCompositeOperation="destination-out",e.beginPath(),e.arc(40,30,30,0,2*Math.PI,!0),e.fill(),t}static createStar(){const t=document.createElement("canvas");t.width=4,t.height=4;const e=t.getContext("2d");return e.beginPath(),e.fillStyle="yellow",e.arc(2,2,2,0,2*Math.PI),e.fill(),t}render(){const t=p();t.drawImage(v.prerenderedMoon,this.x+this.gameDimensions.width/2,150);const e=this.gameDimensions.width/this.sectorWidth;for(let i=0;i<this.starPatternX.length;i++){const s=this.starPatternX[i],n=this.starPatternY[i];let h=(s+this.x)%this.sectorWidth;h<0&&(h=this.sectorWidth+h),t.drawImage(v.prerenderedStar,h*e,n*e)}}scroll(t){super.x=this.x-t/5}}v.prerenderedMoon=v.createMoon(),v.prerenderedStar=v.createStar();class E extends w{constructor(t,e,i){super(t,e),this.startTime=performance.now(),this.ttl=i}render(){const t=p();t.save(),t.translate(this.x,this.y),t.beginPath(),this.renderEffect(t),t.restore()}effectDone(){return this.progress()>1}scroll(t){super.x=this.x-t}progress(){return(performance.now()-this.startTime)/this.ttl}}class C extends E{constructor(t,e,i,s,n){super(t,e,300),this.startX=t,this.startY=e,this.angle=i,this.v0=s,C.prerendered[n]||(C.prerendered[n]=this.createParticle(n)),this.prerenderedCanvas=C.prerendered[n]}scroll(t){super.scroll(t),this.startX=this.startX-t}renderEffect(t){const e=M(this.startTime,this.v0,this.angle,this.startX,this.startY);super.x=e.x,super.y=e.y,t.drawImage(this.prerenderedCanvas,0,0)}createParticle(t){const e=document.createElement("canvas");e.width=4,e.height=4;const i=e.getContext("2d");return i.fillStyle=t,i.arc(2,2,2,0,2*Math.PI),i.fill(),e}}C.prerendered={};class j extends w{constructor(t,e,i){super(t,e),this.name=i}render(){const t=p();t.save(),t.translate(this.x,this.y),t.beginPath(),this.renderItem(t),t.restore()}scroll(t){super.x=this.x-t}}class _ extends j{constructor(t,e){super(t,e,"damage")}getLabel(){return"double damage"}apply(t){t.damage*=2}renderItem(t){t.fillStyle="yellow",t.rotate(45*Math.PI/180),t.fillRect(-10,-3,20,6),t.fillRect(-3,-10,6,20)}}class B extends b{constructor(t,e,i,s,n=!1,h=0){super(t,1,i,n,h),this.power=0,this.lastShot=0,this.width=40,this.speed=65,this.damage=1,this.projectiles=1,this.acceleration=.1,this.reloadTime=1500,this.gunRotation=0,this.faceLeft=!1,this.startedMovingLeftAt=-1,this.startedMovingRightAt=-1,this.terrainRotationAngle=0,this.radius=10,this.height=20,this.gameDimensions=e,this.effects=s}renderMachine(t){this.faceLeft?(t.scale(-1,1),t.rotate(-this.terrainRotationAngle)):t.rotate(this.terrainRotationAngle),t.beginPath(),t.fillStyle="grey",t.fillRect(-this.width/2,0,this.width,this.height),t.beginPath(),t.fillStyle="black",t.ellipse(0,this.height/1.5,this.width/1.5,this.height/2,0,0,2*Math.PI),t.fill(),t.beginPath(),t.fillStyle="grey",t.ellipse(0,this.height/1.5,this.width/2,this.height/2.8,0,0,2*Math.PI),t.fill(),t.beginPath(),t.fillStyle=this.getTurretColor(),t.arc(0,0,this.radius,Math.PI,0),t.fill(),t.translate(0,-4),t.rotate(this.gunRotation),t.fillRect(0,-2,30,4)}updateMachine(t){this.moveTank(t),this.updateHeightAndRotation()}isDead(){return this.health<=0}collidesWith(t){const e=t.x-this.x,i=t.y-this.y;let s=!1;return(Math.sqrt(e*e+i*i)<this.radius+2||function(t,e,i,s,n,h,a){const r=t-Math.min(Math.max(t,s),s+h),o=e-Math.min(Math.max(e,n),n+a);return r*r+o*o<i*i}(t.x,t.y,2,this.x-this.width/2,this.y-this.height/2,this.width,this.height))&&(s=!0),s}takeDamage(t){this.health=this.health-t.damage}setInitialHealth(t){this.maxHealth=t,this.health=t}getInitialHealth(){return this.maxHealth}getSpeed(){return this.speed}isReloading(){return performance.now()-this.lastShot<this.reloadTime}goLeft(t){super.x=this.x-t*Math.min(this.speed-60*this.terrainRotationAngle,Math.max(2,this.acceleration*(performance.now()-this.startedMovingLeftAt))-60*this.terrainRotationAngle),this.faceLeft=!0,this.onDrive()}goRight(t){super.x=this.x+t*Math.min(this.speed+60*this.terrainRotationAngle,Math.max(2,this.acceleration*(performance.now()-this.startedMovingRightAt))+60*this.terrainRotationAngle),this.faceLeft=!1,this.onDrive()}fireGun(){const{originX:t,originY:e}=this.getProjectileOrigin();let i=this.gunRotation+this.terrainRotationAngle;this.faceLeft&&(i=Math.PI-this.gunRotation+this.terrainRotationAngle);const s=t+30*Math.cos(i),n=e+30*Math.sin(i);a("spawnProjectile",s,n,i,this.power,this.damage);for(let t=1;t<this.projectiles;t++)a("spawnProjectile",s,n,i+(Math.random()-.5)*(Math.PI/10),this.power,this.damage)}getProjectileOrigin(){const t=2*Math.sin(this.terrainRotationAngle),e=-2*Math.cos(this.terrainRotationAngle);return{originX:this.x+t,originY:this.y-2+e}}onDrive(){Math.random()>.6&&this.blowUpParticle()}updateHeightAndRotation(){const t=Math.round(this.x-this.width/2),e=Math.round(t+this.width),i=Math.round(t+(e-t)/2),s=[];for(let e=t;e<i+1;e++)s.push(this.terrain.getGlobalHeight(e));const n=s.reduce((t,e)=>t+e,0)/s.length,h=[];for(let t=i;t<e+1;t++)h.push(this.terrain.getGlobalHeight(t));const a=h.reduce((t,e)=>t+e,0)/h.length;super.y=Math.round(n-(n-a)/2)-20,this.terrainRotationAngle=Math.atan((a-n)/this.width)}blowUpParticle(){const t=Math.PI/4+Math.random()*Math.PI/4,e=-Math.PI/2+(this.faceLeft?t:-t),i=5+20*Math.random(),s=Math.random()*this.width/2*(this.faceLeft?1:-1),n=new C(this.x+s,this.y+20,e,i,"#663300");this.effects.push(n)}}class W extends B{constructor(t,e,i,s,n,h,a,r,o,l,c){super(t,e,i,s,!0,n),this.timeLastTurn=performance.now(),this.seenTanky=!1,this.msBetweenShots=a,this.directTrajectory=r,this.inaccuracy=o,this.damage=l,this.power=h,this.tanky=c,this.currentInaccuracyX=2*(Math.random()-.5)*this.inaccuracy,this.currentInaccuracyY=2*(Math.random()-.5)*this.inaccuracy,this.nextTripDuration=3+7*Math.random()}moveTank(t){this.faceLeft&&performance.now()-this.timeLastTurn>this.nextTripDuration?(this.startedMovingLeftAt=-1,this.startedMovingRightAt=performance.now(),this.goRight(t),this.timeLastTurn=performance.now(),this.nextTripDuration=3e3+7e3*Math.random()):!this.faceLeft&&performance.now()-this.timeLastTurn>this.nextTripDuration?(this.startedMovingRightAt=-1,this.startedMovingLeftAt=performance.now(),this.goLeft(t),this.timeLastTurn=performance.now(),this.nextTripDuration=3e3+7e3*Math.random()):this.faceLeft?this.goLeft(t):this.goRight(t);const{originX:e,originY:i}=this.getProjectileOrigin();if(this.seenTanky||Math.abs(e-this.tanky.x)<this.gameDimensions.width/2){this.seenTanky=!0;const s=this.tanky.x-e+this.currentInaccuracyX,n=-(this.tanky.y-i+this.currentInaccuracyY),h=Math.pow(this.power,2),a=Math.pow(h,2),r=9.8*(9.8*Math.pow(s,2)+2*n*h);let o;if(o=this.directTrajectory?(h-Math.sqrt(a-r))/(9.8*s):(h+Math.sqrt(a-r))/(9.8*s)){const i=Math.atan(o);let s;s=this.tanky.x-e>0?-i-this.terrainRotationAngle:-Math.PI-i-this.terrainRotationAngle,this.faceLeft&&(s=-Math.PI-s),this.gunRotation=this.gunRotation-Math.min(this.gunRotation-s,20)*t,performance.now()-this.lastShot>this.msBetweenShots&&(this.fireGun(),this.lastShot=performance.now(),this.currentInaccuracyX=2*(Math.random()-.5)*this.inaccuracy,this.currentInaccuracyY=2*(Math.random()-.5)*this.inaccuracy)}}}getTurretColor(){let t="green";return this.tanky.health<this.damage?t="red":this.tanky.health/2<this.damage&&(t="orange"),t}}class X extends j{constructor(t,e){super(t,e,"health")}getLabel(){return"double health"}apply(t){t.setInitialHealth(2*t.getInitialHealth())}renderItem(t){t.fillStyle="red",t.fillRect(-10,-3,20,6),t.fillRect(-3,-10,6,20)}}const G=["","k","M","G","T","P","E"];function N(t){const e=Math.log10(t)/3|0;if(e<1)return t.toLocaleString("en-us",{maximumFractionDigits:2});const i=G[e];return(t/Math.pow(10,3*e)).toFixed(2)+i}class O extends w{constructor(t,e,i){super(),this.tanky=t,this.score=e,this.gameDimensions=i}render(){const t=p();t.font='1em "Lucida Console",Monaco,monospace',t.beginPath();const e=this.gameDimensions.width/5,i=e*(this.tanky.health/this.tanky.maxHealth);t.fillStyle="green",t.fillRect(this.gameDimensions.width/9,this.gameDimensions.height-40,i,30),t.fillStyle="red",t.fillRect(this.gameDimensions.width/9+i,this.gameDimensions.height-40,e-i,30),t.fillStyle="black";const s=N(this.tanky.health),n=N(this.tanky.maxHealth);if(t.fillText(`${s}/${n} HP`,this.gameDimensions.width/9+20,this.gameDimensions.height-16),t.beginPath(),this.tanky.isReloading()){const i=e*this.tanky.reloadRatio();t.fillStyle="white",t.fillRect(this.gameDimensions.width/5*3,this.gameDimensions.height-40,-i,30),t.fillStyle="grey",t.fillRect(this.gameDimensions.width/5*2,this.gameDimensions.height-40,e-i,30),t.fillStyle="black",t.fillText("RELOADING",this.gameDimensions.width/5*2+20,this.gameDimensions.height-16)}else{const i=e*(this.tanky.power/100);t.fillStyle="orange",t.fillRect(this.gameDimensions.width/5*2,this.gameDimensions.height-40,i,30),t.fillStyle="grey",t.fillRect(this.gameDimensions.width/5*2+i,this.gameDimensions.height-40,e-i,30)}t.fillStyle="orange";const h=N(this.tanky.damage);t.fillText(`Damage/Shot: ${h}`,this.gameDimensions.width/3*2,this.gameDimensions.height-16),t.beginPath(),t.fillStyle="yellow";const a=this.gameDimensions.width/4*3,r=this.gameDimensions.height/30,o=N(this.score.getScore());if(t.fillText(`Current Score: ${o}`,a,40),this.score.newHighscore())t.fillStyle="pink",t.fillText("NEW HIGHSCORE!",a,70);else{t.fillStyle="white";const e=N(this.score.getHighscore());t.fillText(`Highscore: ${e}`,a,40+r)}t.fillStyle="white";let l=40+3*r;const c=this.tanky.getPickedUpItemsLabelCounts();if(Object.keys(c).length>0){t.fillText("Modifiers for next run:",a,l);for(const e of Object.keys(c)){const i=c[e];l+=r,t.fillText(`${i} x ${e}`,a,l)}}}}class Y extends E{constructor(t,e,i){super(t,e,50),this.angle=i}renderEffect(t){t.fillStyle="yellow",t.rotate(this.angle),t.fillRect(0,-1,8*this.progress(),2),t.fillRect(0,-2,2,6*this.progress()),t.fillRect(0,2,2,6*-this.progress())}}class U extends j{constructor(t,e){super(t,e,"proj")}getLabel(){return"one more projectile"}apply(t){t.projectiles+=1}renderItem(t){t.fillStyle="chartreuse",t.arc(-4,-4,3,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(4,-4,3,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(4,4,3,0,2*Math.PI),t.fill()}}class z extends j{constructor(t,e){super(t,e,"reload")}getLabel(){return"20% less reload time"}apply(t){t.reloadTime=.8*t.reloadTime}renderItem(t){t.fillStyle="pink",t.fillRect(-10,-10,4,20),t.fillRect(-2,-10,4,20),t.fillRect(6,-10,4,20)}}class q extends j{constructor(t,e){super(t,e,"speed")}getLabel(){return"20% more speed"}apply(t){t.speed*=1.2}renderItem(t){t.fillStyle="pink",this.drawArrow(t,-4),this.drawArrow(t,4)}drawArrow(t,e){t.moveTo(0+e,-10),t.lineTo(2+e,-10),t.lineTo(5+e,0),t.lineTo(2+e,10),t.lineTo(0+e,10),t.fill()}}class V extends B{constructor(t,e,i,s){super(t,e,i,s),this.items=[],this.itemLabelCounts={},this.setInitialHealth(3)}reloadRatio(){return(performance.now()-this.lastShot)/this.reloadTime}liftGun(t){this.gunRotation>-Math.PI/2+Math.PI/10&&(this.gunRotation=this.gunRotation-Math.PI*(t/5))}lowerGun(t){this.gunRotation<0+Math.PI/16&&(this.gunRotation=this.gunRotation+Math.PI*(t/5))}pickUp(t){this.items.push(t);const e=t.getLabel();this.itemLabelCounts[e]?this.itemLabelCounts[e]+=1:this.itemLabelCounts[e]=1}getPickedUpItems(){return this.items}getPickedUpItemsLabelCounts(){return this.itemLabelCounts}moveTank(t){this.isReloading()||(f("space")?this.power<30?this.power=35:this.power=Math.min(100,this.power+100*t):this.power>30&&(this.fireGun(),this.power=0,this.lastShot=performance.now())),f("up")?this.liftGun(t):f("down")&&this.lowerGun(t),f("right")?(this.startedMovingLeftAt=-1,this.startedMovingRightAt<0&&(this.startedMovingRightAt=performance.now()),this.goRight(t)):f("left")?(this.startedMovingRightAt=-1,this.startedMovingLeftAt<0&&(this.startedMovingLeftAt=performance.now()),this.goLeft(t)):(this.startedMovingRightAt=-1,this.startedMovingLeftAt=-1);const e=this.gameDimensions.width;this.x<e/2-30&&this.terrain.scroll(Math.round(this.x-(e/2-30))),this.x>e/2+30&&this.terrain.scroll(Math.round(this.x-(e/2+30)))}getTurretColor(){return"silver"}}class K extends w{constructor(t){super(),this.gameDimensions=t}render(){const t=p();if(t.font='0.5em "Lucida Console",Monaco,monospace',Math.abs(this.x)<2*this.gameDimensions.width){t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.7)",t.fillRect(this.x+50,10,this.gameDimensions.width/4,this.gameDimensions.height/3),t.fillStyle="black";const e="Welcome BACK Tanky McTankface,\n\nyour time has come to put your parts to the test.\n\nYou cannot win, as there are no winners in war\n(except for the arms industry...).\n\nWhen you break down, we will use parts you found\nin the last run to build a better version of you.\n\nControls:\nleft/right arrow key -> move the tank\nup/down arrow key -> change gun angle\nspace -> hold to charge shot".split("\n");for(let i=0;i<e.length;i++){const s=e[i];t.fillText(s,this.x+55,30+this.gameDimensions.height/50*i)}}}scroll(t){super.x=this.x-t/2}}class ${constructor(t,e,i){this.hasStarted=!1,this.spawnProjectileCallback=(t,e,i,s,n)=>this.spawnProjectile(t,e,i,s,n),this.newTerrainCallback=(t,e,i)=>this.newTerrain(t,e,i),this.enemyKilledCallback=t=>this.enemyKilled(t),this.scrollCallback=t=>this.scroll(t),o=document.querySelector("canvas"),(l=o.getContext("2d")).imageSmoothingEnabled=!1,function(){let t;for(t=0;t<26;t++)d[65+t]=(10+t).toString(36);for(t=0;t<10;t++)d[48+t]=""+t;window.addEventListener("keydown",g),window.addEventListener("keyup",u),window.addEventListener("blur",m)}(),this.numberOfActiveItems=e.length,this.backgroundSong=new A(I,i,!0,!0),this.shotSound=new A(T,i),this.explosionSound=new A(R,i),this.itemSound=new A(H,i),this.gameDimensions=t,this.effects=[],this.background=new v(this.gameDimensions),this.textLayer=new K(this.gameDimensions),this.terrain=new S(this.gameDimensions),this.tanky=new V(this.gameDimensions.width/2,this.gameDimensions,this.terrain,this.effects),e.forEach(t=>{t.apply(this.tanky)}),this.score=new D(Number(localStorage.getItem("tankymctankface_highscore"))),this.hud=new O(this.tanky,this.score,this.gameDimensions),this.projectiles=[],this.enemies=[],this.items=[],this.pickedUpItems=[],this.loop=function(t=60,e=!0,i,s){let n=0;const h=1e3/t,a=1/t,r=e?y:()=>{};let o,l,c,d;function g(){if(l=requestAnimationFrame(g),c=performance.now(),d=c-o,o=c,!(d>1e3)){for(n+=d;n>=h;)u.update(a),n-=h;r(),u.render()}}const u={isStopped:!0,render:s,update:i,start(){o=performance.now(),this.isStopped=!1,requestAnimationFrame(g)},stop(){this.isStopped=!0,cancelAnimationFrame(l)}};return u}(60,!0,t=>this.update(t),()=>this.render())}start(){n("spawnProjectile",this.spawnProjectileCallback),n("newTerrain",this.newTerrainCallback),n("enemyKilled",this.enemyKilledCallback),n("scroll",this.scrollCallback),this.backgroundSong.play(),this.loop.start(),this.hasStarted=!0}started(){return this.hasStarted}stop(){this.backgroundSong.pause(),this.loop.stop(),h("spawnProjectile",this.spawnProjectileCallback),h("newTerrain",this.newTerrainCallback),h("enemyKilled",this.enemyKilledCallback),h("scroll",this.scrollCallback)}scroll(t){this.background.scroll(t),this.textLayer.scroll(t),this.effects.forEach(e=>{e.scroll(t)}),this.items.forEach(e=>{e.scroll(t)}),this.enemies.forEach(e=>{e.scroll(t)}),this.projectiles.forEach(e=>{e.scroll(t)}),this.tanky.scroll(t)}render(){J(),this.background.render(),this.textLayer.render(),this.enemies.forEach(t=>{t.x>-40&&t.x<this.gameDimensions.width+40&&t.render()}),this.projectiles.forEach(t=>{t.x>-2&&t.x<this.gameDimensions.width+2&&t.render()}),this.tanky.render(),this.items.forEach(t=>{t.x>-20&&t.x<this.gameDimensions.width+20&&t.render()}),this.effects.forEach(t=>{t.x>-5&&t.x<this.gameDimensions.width+5&&t.render()}),this.terrain.render(),this.hud.render()}update(t){this.enemies.forEach(e=>{e.update(t)});const e=[];for(let t=0;t<this.effects.length;t++){this.effects[t].effectDone()&&e.push(t)}for(let t=e.length-1;t>=0;t--)this.effects.splice(e[t],1);const i=[];for(let t=0;t<this.items.length;t++){const e=this.items[t];if(Math.abs(this.tanky.x-e.x)<this.tanky.width/2){i.push(t),this.tanky.pickUp(e),this.pickedUpItems.push(e),this.itemSound.play();const s=this.pickedUpItems.map(t=>t.name);localStorage.setItem("tankymctankface_items",JSON.stringify(s))}}for(let t=i.length-1;t>=0;t--)this.items.splice(i[t],1);const s=[],n=new Set;for(let t=0;t<this.projectiles.length;t++){let e=!1;const i=this.projectiles[t];i.update();for(let t=0;t<this.enemies.length;t++){const s=this.enemies[t];Math.abs(i.x-s.x)<50&&s.collidesWith(i)&&(e=!0,this.blowUpParticles(i),this.explosionSound.play(),s.takeDamage(i),s.isDead()&&(n.has(t)||(n.add(t),a("enemyKilled",s))))}const h=this.terrain.getGlobalHeight(i.x);i.y>=h&&(this.terrain.explosion(i.x),e=!0,this.blowUpParticles(i),this.explosionSound.play()),Math.abs(i.x-this.tanky.x)<50&&this.tanky.collidesWith(i)&&(this.tanky.takeDamage(i),e=!0,this.blowUpParticles(i),this.explosionSound.play(),this.tanky.isDead()&&this.restartRun(this.score.getHighscore(),this.tanky.getPickedUpItems())),e&&s.push(t)}for(let t=s.length-1;t>=0;t--)this.projectiles.splice(s[t],1);const h=Array.from(n).sort((t,e)=>t-e);for(let t=h.length-1;t>=0;t--)this.enemies.splice(h[t],1);this.tanky.update(t)}restartRun(t,e){this.numberOfActiveItems=e.length,this.effects=[],this.background=new v(this.gameDimensions),this.textLayer=new K(this.gameDimensions),this.terrain=new S(this.gameDimensions),this.tanky=new V(this.gameDimensions.width/2,this.gameDimensions,this.terrain,this.effects),e.forEach(t=>{t.apply(this.tanky)}),this.score=new D(t),this.hud=new O(this.tanky,this.score,this.gameDimensions),this.projectiles=[],this.enemies=[],this.items=[],this.pickedUpItems=[]}spawnProjectile(t,e,i,s,n){this.projectiles.push(new x(t,e,i,s,n)),this.effects.push(new Y(t,e,i)),this.shotSound.play()}newTerrain(t,e,i){const s=Math.abs(t/2e3)+this.numberOfActiveItems/3,n=Math.round((e-t)/200*Math.random()),h=Math.pow(s,2);for(let a=0;a<n;a++){const{index:n,shootingSpeed:a,msBetweenShots:r,shootDirectly:o,inaccuracy:l,maxHealth:c,damage:d,points:g}=this.scaleDifficulty(t,e,s,h);this.enemies.push(new P(n-i,this.tanky,a,r,o,l,c,d,g,this.gameDimensions,this.terrain))}const a=Math.round((e-t)/400*Math.random());for(let n=0;n<a;n++){const{index:n,shootingSpeed:a,msBetweenShots:r,shootDirectly:o,inaccuracy:l,maxHealth:c,damage:d,points:g}=this.scaleDifficulty(t,e,s,h),u=new W(n-i,this.gameDimensions,this.terrain,this.effects,g,a,r,o,l,d,this.tanky);u.setInitialHealth(c),this.enemies.push(u)}}scaleDifficulty(t,e,i,s){const n=t+Math.random()*(e-t-40),h=i*Math.random()>2&&Math.random()>.3,a=Math.max(1,80-s*Math.random()),r=Math.max(100,4e3-s*Math.random()),o=100+40*(Math.random()-.5),l=Math.round(1+.2*Math.random()*s),c=Math.round(1+l/3);return{index:n,shootingSpeed:o,msBetweenShots:r,shootDirectly:h,inaccuracy:a,maxHealth:l,damage:c,points:Math.round(80/a*(4e3/r)*o*l*c*(h?5:1)/Math.log2(i+1))}}enemyKilled(t){if(this.score.addPoints(t.points),Math.random()<1/(1+this.tanky.getPickedUpItems().length/10)){const e=Math.random();e<.15?this.items.push(new U(t.x,t.y)):e<.4?this.items.push(new _(t.x,t.y)):e<.6?this.items.push(new q(t.x,t.y)):e<.85?this.items.push(new X(t.x,t.y)):this.items.push(new z(t.x,t.y))}}blowUpParticles(t){for(let e=0;e<5;e++){const e=Math.random()*-Math.PI,i=10+20*Math.random(),s=new C(t.x,t.y,e,i,"#696969");this.effects.push(s)}}}i.d(e,"resizeIfNeeded",function(){return J});i(0);const F=new class{constructor(){this.width=1920,this.height=1080}};function J(){const t=document.getElementById("gameArea");let e=window.innerWidth,i=window.innerHeight;e/i>16/9?(e=Math.round(i*(16/9)),t.style.height=i+"px",t.style.width=e+"px"):(i=Math.round(e/(16/9)),t.style.width=e+"px",t.style.height=i+"px"),t.style.marginTop=-i/2+"px",t.style.marginLeft=-e/2+"px",t.style.fontSize=e/1e3+"em";const s=document.getElementById("gameCanvas");s.width=e,s.height=i,F.width=e,F.height=i}window.addEventListener("resize",J,!1),window.addEventListener("orientationchange",J,!1),J();const Q=function(){const t=localStorage.getItem("tankymctankface_items"),e=[],i={},s=new U(0,0);i[s.name]=s;const n=new q(0,0);i[n.name]=n;const h=new _(0,0);i[h.name]=h;const a=new X(0,0);i[a.name]=a;const r=new z(0,0);if(i[r.name]=r,t){JSON.parse(t).forEach(t=>{e.push(i[t])})}return e}(),Z=document.getElementById("musicSlider");Z.oninput=t=>{et.musicVolume=Number(Z.value)/100,localStorage.setItem("tankymctankface_music",Z.value)};const tt=document.getElementById("fxSlider");tt.oninput=t=>{et.fxVolume=Number(tt.value)/100,localStorage.setItem("tankymctankface_fx",tt.value)};const et=new class{constructor(){this.musicVolume=.2,this.fxVolume=.5}},it=localStorage.getItem("tankymctankface_music");it?(Z.value=it,et.musicVolume=Number(it)/100):et.musicVolume=.1;const st=localStorage.getItem("tankymctankface_fx");st?(tt.value=st,et.fxVolume=Number(st)/100):et.fxVolume=.5;let nt=new $(F,Q,et);const ht=document.getElementById("startbutton"),at=document.getElementById("freshstartbutton"),rt=document.getElementById("gameMenu"),ot=document.getElementById("freshdiv");Q.length<1&&(ot.hidden=!0),ht.addEventListener("click",t=>{nt.start(),rt.hidden=!0}),at.addEventListener("click",t=>{localStorage.removeItem("tankymctankface_items"),(nt=new $(F,[],et)).start(),rt.hidden=!0}),document.addEventListener("keydown",t=>{"Escape"===t.key&&(ot.hidden=!1,ht.innerHTML="Continue",nt.stop(),rt.hidden=!1)},!1)}]);