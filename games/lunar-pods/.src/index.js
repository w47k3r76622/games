const HEX_SIZE=46,VERT_HEX_OFFSET=24,HORIZ_HEX_OFFSET=-10,HORIZ_MAP_OFFSET=30,VERT_MAP_OFFSET=40,BUILDING_OFFSET=40,HELIUM3_IN_MAP=6,MOUNTAIN_TILES=20,SEL_BRIGHTNESS_MIN=80,SEL_BRIGHTNESS_MAX=120,MAP_WIDTH=20,MAP_HEIGHT=8,HELIUM3_INC=10,LANDING_OFFSET=-100,STATES={TITLE:0,RUNNING:1,WIN:2,LOSE:3},DIFFICULTY={EASY:4,DIFFICULT:3,EXTREME:2},map=[];let loop=0,AIStepNumber=0,selCell=[0,0],helium3=1e3;const cooldownTimers={};let incrementalId=0;const canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),loadAsset=e=>{const l=new Image(46,46);return l.src=`assets/graphics/${e}`,l},tile=loadAsset("tile.png"),mountainTile=loadAsset("mountains.png"),helium3Tile=loadAsset("helium3.png"),ccTile=loadAsset("command-center.png"),refineryTile=loadAsset("refinery.png"),turretTile=loadAsset("turret.png"),podTile=loadAsset("pod.png"),ccTileCpu=loadAsset("command-center-cpu.png"),refineryTileCpu=loadAsset("refinery-cpu.png"),turretTileCpu=loadAsset("turret-cpu.png"),podTileCpu=loadAsset("pod-cpu.png"),aoiTile=loadAsset("aoi-human.png");let hOffset=0,selectionBrightness=80,selectionBrightnessInc=1;const stars=[];let buildBtnPressed,difficulty,pristineMap=!0,state=STATES.TITLE,particleSystems=[],selectedCellInfo="",debuggingMode=!1;const PLAYERS={HUMAN:1,CPU:2,SELECTION:3},DIRECTION={LEFT:-1,SAME:0,RIGHT:1},buildings={cc:{id:void 0,area:4,cooldown:30,cooldownRemaining:0,cost:300,hp:500,totalHP:500},turret:{id:void 0,area:2,cooldown:5,cooldownRemaining:0,cost:200,damage:20,hp:200,range:6,totalHP:200},refinery:{id:void 0,area:1,cooldown:10,cooldownRemaining:0,cost:100,hp:100,totalHP:100}},startParticleSystem=(e,l,t,i={r:255,g:255,b:255},a="up",r={})=>{const s=[],n=r.initTtl||50,c=r.initSize||6,o=r.maxParticles||10,d=r.speed||1,u=r.once||!1;s.push({x:l+10*Math.random(),y:t,ttl:n,opacity:1,size:c}),particleSystems.push({init:{color:i,direction:a,id:e,initX:l,initY:t,initTtl:n,initSize:c,maxParticles:o,once:u,speed:d},particles:s})},updateParticleSystems=()=>{state!==STATES.RUNNING&&state!==STATES.TITLE||particleSystems.forEach((e=>{const{initX:l,initY:t,initTtl:i,initSize:a,maxParticles:r,color:s,direction:n,speed:c,once:o}=e.init;e.particles.forEach(((r,d)=>{if(!r.dead){let{x:u,y:p,size:g}=r;ctx.clearRect(u,p,g,g);let f={...r};ctx.fillStyle=`rgba(${s.r}, ${s.g}, ${s.b}, ${f.opacity})`,ctx.fillRect(u,p,g,g),f.ttl-=1,f.ttl>0?("up"===n?(f.x+=2*Math.random()-1,f.y-=c):"down"===n?(f.x+=2*Math.random()-1,f.y-=-c):"left"===n?(f.x+=-c,f.y-=2*Math.random()-1):"right"===n?(f.x+=c,f.y-=2*Math.random()-1):"up left"===n?(f.x-=c/2,f.y-=c/2):"up right"===n?(f.x+=c/2,f.y-=c/2):"down left"===n?(f.x-=c/2,f.y+=c/2):"down right"===n&&(f.x+=c/2,f.y+=c/2),f.opacity-=1/i,f.size-=a/i):o?(f.opacity=0,f.dead=!0):(f.x=l,f.y=t,f.ttl=i+Math.floor(20*Math.random()),f.opacity=1,f.size=a),e.particles[d]=f}})),e.particles.length<r&&e.particles.push({x:l+10*Math.random(),y:t,opacity:1,size:5})}))},purgeEndedParticleSystems=()=>{particleSystems=particleSystems.filter((e=>!e.ended))},drawStars=()=>{let e="white";stars.forEach((l=>{ctx.fillStyle=e,e="white"===e?"gray":"white",ctx.fillRect(l[0],l[1],2,2)}))},drawHP=(e,l,t,i,a)=>{ctx.fillStyle="black",ctx.fillRect(46*e+t*e+40,46*l+(a?24:0)+40,32,4),ctx.fillStyle="lime",ctx.fillRect(46*e+t*e+40,46*l+(a?24:0)+40,32*i,4)},drawMap=()=>{selectionBrightness+=selectionBrightnessInc,(selectionBrightness>=120||selectionBrightness<=80)&&(selectionBrightnessInc=-selectionBrightnessInc),map.forEach(((e,l)=>{e.forEach(((e,t)=>{if(e){if(t>0&&(hOffset=-10),l===selCell[0]&&t===selCell[1]?e.invalidSelection?ctx.filter="sepia(1) hue-rotate(-40deg) saturate(200%)":"mountain"!==e.type&&e.aoi!==PLAYERS.CPU?ctx.filter=`brightness(${selectionBrightness}%)`:ctx.filter="sepia(1) hue-rotate(-40deg) saturate(200%)":e.aoi===PLAYERS.SELECTION?ctx.filter="sepia(1) hue-rotate(40deg) saturate(200%)":e.targeted?ctx.filter="sepia(1) hue-rotate(-40deg) saturate(200%)":ctx.filter="none",l%2==0){if(ctx.drawImage(tile,46*l+hOffset*l+30,46*t+24+40),e.aoi||e.invalidSelection){let i=ctx.filter;e.aoi===PLAYERS.CPU&&(ctx.filter="sepia(1) hue-rotate(0deg) saturate(140%)"),ctx.drawImage(aoiTile,46*l+hOffset*l+30,46*t+24+40),ctx.filter=i}e&&"helium3"===e.type&&ctx.drawImage(helium3Tile,46*l+hOffset*l+30,46*t+24+40),e&&"mountain"===e.type&&ctx.drawImage(mountainTile,46*l+hOffset*l+30,46*t+24+40)}else{if(ctx.drawImage(tile,46*l+hOffset*l+30,46*t+40),e.aoi||e.invalidSelection){let i=ctx.filter;e.aoi===PLAYERS.CPU&&(ctx.filter="sepia(1) hue-rotate(0deg) saturate(120%)"),ctx.drawImage(aoiTile,46*l+hOffset*l+30,46*t+40),ctx.filter=i}e&&"helium3"===e.type&&ctx.drawImage(helium3Tile,46*l+hOffset*l+30,46*t+40),e&&"mountain"===e.type&&ctx.drawImage(mountainTile,46*l+hOffset*l+30,46*t+40)}e.building&&(e.landingProgress<100?ctx.drawImage(e.aoi===PLAYERS.HUMAN?podTile:podTileCpu,46*l+hOffset*l+40,46*t+24+40+(-100+e.landingProgress)):e.building.cc?(l%2==0?(ctx.drawImage(e.aoi===PLAYERS.HUMAN?ccTile:ccTileCpu,46*l+hOffset*l+40,46*t+24+40),e.building.cc.hp<e.building.cc.totalHP&&drawHP(l,t,hOffset,e.building.cc.hp/e.building.cc.totalHP,!0)):(ctx.drawImage(e.aoi===PLAYERS.HUMAN?ccTile:ccTileCpu,46*l+hOffset*l+40,46*t+40),e.building.cc.hp<e.building.cc.totalHP&&drawHP(l,t,hOffset,e.building.cc.hp/e.building.cc.totalHP,!1)),debuggingMode&&(ctx.fillStyle="black",ctx.font="12px Arial",ctx.fillText(e.building.cc.hp,46*l+hOffset*l+30,46*t+24+40))):e.building.turret?(l%2==0?(ctx.drawImage(e.aoi===PLAYERS.HUMAN?turretTile:turretTileCpu,46*l+hOffset*l+40,46*t+24+40),e.building.turret.hp<e.building.turret.totalHP&&drawHP(l,t,hOffset,e.building.turret.hp/e.building.turret.totalHP,!0)):(ctx.drawImage(e.aoi===PLAYERS.HUMAN?turretTile:turretTileCpu,46*l+hOffset*l+40,46*t+40),e.building.turret.hp<e.building.turret.totalHP&&drawHP(l,t,hOffset,e.building.turret.hp/e.building.turret.totalHP,!1)),debuggingMode&&(ctx.fillStyle="black",ctx.font="12px Arial",ctx.fillText(e.building.turret.hp,46*l+hOffset*l+30,46*t+24+40))):e.building.refinery&&(l%2==0?(ctx.drawImage(e.aoi===PLAYERS.HUMAN?refineryTile:refineryTileCpu,46*l+hOffset*l+40,46*t+24+40),e.building.refinery.hp<e.building.refinery.totalHP&&drawHP(l,t,hOffset,e.building.refinery.hp/e.building.refinery.totalHP,!0)):(ctx.drawImage(e.aoi===PLAYERS.HUMAN?refineryTile:refineryTileCpu,46*l+hOffset*l+40,46*t+40),e.building.refinery.hp<e.building.refinery.totalHP&&drawHP(l,t,hOffset,e.building.refinery.hp/e.building.refinery.totalHP,!1)),debuggingMode&&(ctx.fillStyle="black",ctx.font="12px Arial",ctx.fillText(e.building.refinery.hp,46*l+hOffset*l+30,46*t+24+40))))}}))}))},canBuild=e=>{switch(e){case"cc":return helium3>buildings.cc.cost;case"turret":return helium3>buildings.turret.cost;case"refinery":return helium3>buildings.refinery.cost;default:return!1}},drawUI=()=>{if(state===STATES.RUNNING){const e=60,{cooldown:l,cooldownRemaining:t,cost:i}=buildings.cc,{cooldown:a,cooldownRemaining:r,cost:s}=buildings.turret,{cooldown:n,cooldownRemaining:c,cost:o}=buildings.refinery;ctx.fillStyle="#333333",ctx.fillRect(e,490,(l-t)/l*240,30),ctx.fillRect(e,520,(a-r)/a*240,30),ctx.fillRect(e,550,(n-c)/n*240,30),ctx.strokeStyle="gray",ctx.strokeRect(e,490,240,30),ctx.fillStyle="1"===buildBtnPressed&&canBuild("cc")?"#77aa33":"gray",ctx.fillRect(e+5,495,20,20),ctx.strokeRect(e,520,240,30),ctx.fillStyle="2"===buildBtnPressed&&canBuild("turret")?"#77aa33":"gray",ctx.fillRect(e+5,525,20,20),ctx.strokeRect(e,550,240,30),ctx.fillStyle="3"===buildBtnPressed&&canBuild("refinery")?"#77aa33":"gray",ctx.fillRect(e+5,555,20,20),ctx.fillStyle="black",ctx.font="14px Arial",ctx.fillText("1",e+10,510),ctx.fillText("2",e+10,540),ctx.fillText("3",e+10,570),ctx.fillStyle=t>0||helium3<i?"gray":"white",ctx.fillText(`Command Center (Cost: ${buildings.cc.cost})`,e+30,510),ctx.fillStyle=r>0||helium3<s?"gray":"white",ctx.fillText(`Turret (Cost: ${buildings.turret.cost})`,e+30,540),ctx.fillStyle=c>0||helium3<o?"gray":"white",ctx.fillText(`Mine (Cost: ${buildings.refinery.cost})`,e+30,570);const d="Press again to confirm";"1"===buildBtnPressed&&canBuild("cc")?ctx.fillText(d,e+250,510):"2"===buildBtnPressed&&canBuild("turret")?ctx.fillText(d,e+250,540):"3"===buildBtnPressed&&canBuild("refinery")&&ctx.fillText(d,e+250,570),ctx.fillStyle="white",ctx.font="20px Arial",ctx.fillText(`HELIUM-3: ${helium3}`,600,580),selectedCellInfo&&(ctx.fillStyle="gray",ctx.fillRect(600,450,150,80),ctx.fillStyle="#333333",ctx.fillRect(605,455,140,70),ctx.fillStyle="white",ctx.font="14px Arial",ctx.fillText(selectedCellInfo,630,500))}else state===STATES.WIN?(ctx.fillStyle="white",ctx.font="16px Arial",ctx.fillText("YOU WIN!",110,510),ctx.font="14px Arial",ctx.fillText("Press Enter to restart the game",310,510)):state===STATES.LOSE&&(ctx.fillStyle="white",ctx.font="16px Arial",ctx.fillText("YOU LOSE!",110,510),ctx.font="14px Arial",ctx.fillText("Press Enter to restart the game",310,510))},resetAoI=()=>{map.forEach(((e,l)=>{e.forEach(((e,l)=>{e.building||(e.aoi=void 0,e.aoiScore=0)}))}))},generateAoI=(e=0,l=4)=>{0===e&&map.forEach(((e,l)=>{e.forEach(((e,l)=>{e.aoi===PLAYERS.SELECTION&&(e.aoi=void 0,e.aoiScore=void 0),e.building?.placeholder&&(e.building=void 0)}))})),map[selCell[0]][selCell[1]].aoi||!buildBtnPressed||pristineMap?(map[selCell[0]][selCell[1]].building||("1"===buildBtnPressed?map[selCell[0]][selCell[1]].building={placeholder:{type:"placeholder",area:buildings.cc.area}}:"2"===buildBtnPressed?map[selCell[0]][selCell[1]].building={placeholder:{type:"placeholder",area:buildings.turret.area}}:"3"===buildBtnPressed&&(map[selCell[0]][selCell[1]].building={placeholder:{type:"placeholder",area:buildings.refinery.area}})),map.forEach(((t,i)=>{t.forEach(((t,a)=>{0===e?t?.building&&(t.building.cc?t.aoiScore=t.building.cc.area:t.building.turret?t.aoiScore=t.building.turret.area:t.building.refinery?t.aoiScore=t.building.refinery.area:t.building.placeholder&&(t.aoiScore=t.building.placeholder.area,t.aoi=PLAYERS.SELECTION)):e>=1&&t&&t.aoiScore===l&&(!map[i][a-1]||map[i][a-1]?.aoiScore||map[i][a-1]?.aoi||(map[i][a-1].aoiScore=t.aoiScore-1,map[i][a-1].aoi=t.aoi),!map[i][a+1]||map[i][a+1]?.aoiScore||map[i][a+1]?.aoi||(map[i][a+1].aoiScore=t.aoiScore-1,map[i][a+1].aoi=t.aoi),i>0&&map[i-1][a]&&!map[i-1][a]?.aoiScore&&!map[i-1][a]?.aoi&&(map[i-1][a].aoiScore=t.aoiScore-1,map[i-1][a].aoi=t.aoi),i<20&&map[i+1]&&map[i+1][a]&&!map[i+1][a]?.aoiScore&&!map[i+1][a]?.aoi&&(map[i+1][a].aoiScore=t.aoiScore-1,map[i+1][a].aoi=t.aoi),i%2==0?(i>0&&map[i-1][a+1]&&!map[i-1][a+1]?.aoiScore&&!map[i-1][a+1]?.aoi&&(map[i-1][a+1].aoiScore=t.aoiScore-1,map[i-1][a+1].aoi=t.aoi),i<20&&map[i+1]&&map[i+1][a+1]&&!map[i+1][a+1]?.aoiScore&&!map[i+1][a+1]?.aoi&&(map[i+1][a+1].aoiScore=t.aoiScore-1,map[i+1][a+1].aoi=t.aoi)):(i>0&&map[i-1][a-1]&&!map[i-1][a-1]?.aoiScore&&!map[i-1][a-1]?.aoi&&(map[i-1][a-1].aoiScore=t.aoiScore-1,map[i-1][a-1].aoi=t.aoi),i<20&&map[i+1]&&map[i+1][a-1]&&!map[i+1][a-1]?.aoiScore&&!map[i+1][a-1]?.aoi&&(map[i+1][a-1].aoiScore=t.aoiScore-1,map[i+1][a-1].aoi=t.aoi)))}))})),l>1&&generateAoI(e+1,e>0?l-1:l)):map[selCell[0]][selCell[1]].invalidSelection=!0},clearTurretRangePreview=()=>{map.forEach(((e,l)=>{e.forEach(((e,l)=>{e.targeted&&delete e.targeted}))}))},generateTurretRangePreview=(e,l)=>{const t=findAllCommandCenters(),i=findAllMines(),a=findAllTurrets().concat(i).concat(t),r=map[e][l];a.forEach(((t,i)=>{const a=Math.sqrt(Math.pow(t.x-e,2)+Math.pow(t.y-l,2));a>0&&a<buildings.turret.range&&r.aoi!==t.cell.aoi&&(t.cell.targeted=!0)}))},generateStarBackground=e=>{for(;e--;){const e=Math.floor(800*Math.random()),l=Math.floor(600*Math.random());stars.push([e,l])}},generateMap=(e,l)=>{for(let t=0;t<e;t++)map.push(Array(l).fill("blank"));map.forEach(((e,l)=>{e.forEach(((e,t)=>{map[l][t]={}}))}));for(let t=0;t<6;t++)map[Math.floor(Math.random()*e)][Math.floor(Math.random()*l)]={type:"helium3"};for(let t=0;t<20;t++)map[Math.floor(Math.random()*e)][Math.floor(Math.random()*l)]={type:"mountain"};drawMap()},gatherResources=()=>{map.forEach(((e,l)=>{e.forEach(((e,l)=>{e?.building?.refinery&&e.aoi===PLAYERS.HUMAN&&(helium3+=10)}))}))},findAvailableCellOfType=e=>{let l;return map.forEach(((t,i)=>{t.forEach(((t,a)=>{l||t?.type!==e||t?.building||t?.aoi&&t?.aoi!==PLAYERS.CPU||(l={cell:t,x:i,y:a})}))})),l},findHelium3Sources=()=>{const e=[];return map.forEach(((l,t)=>{l.forEach(((l,i)=>{"helium3"===l?.type&&e.push({cell:l,x:t,y:i})}))})),e},findAllCommandCenters=()=>{const e=[];return map.forEach(((l,t)=>{l.forEach(((l,i)=>{l?.building?.cc&&e.push({cell:l,x:t,y:i})}))})),e},findAllTurrets=()=>{const e=[];return map.forEach(((l,t)=>{l.forEach(((l,i)=>{l?.building?.turret&&e.push({cell:l,x:t,y:i})}))})),e},findAllMines=()=>{const e=[];return map.forEach(((l,t)=>{l.forEach(((l,i)=>{l?.building?.refinery&&e.push({cell:l,x:t,y:i})}))})),e},findOwnCells=e=>{const l=[];return map.forEach(((t,i)=>{t.forEach(((t,a)=>{t?.aoi===e&&l.push({cell:t,x:i,y:a})}))})),l},getEnemyDirection=()=>{let e,l,t;return map.forEach(((e,i)=>{e.forEach(((e,a)=>{e?.aoi===PLAYERS.HUMAN&&e?.building?.cc?l={cell:e,x:i,y:a}:e?.aoi===PLAYERS.CPU&&e?.building?.cc&&(t={cell:e,x:i,y:a})}))})),e=l?t.x<l.x?DIRECTION.RIGHT:t.x===l.x?DIRECTION.SAME:DIRECTION.LEFT:null,e},getCC=()=>{let e;return map.forEach(((l,t)=>{l.forEach(((l,i)=>{l?.aoi===PLAYERS.CPU&&l?.building?.cc&&(e={cell:l,x:t,y:i})}))})),e},FSM={state:"INIT",transitions:{INIT:{createCC(){const e=findAvailableCellOfType("helium3"),l=map[e.x+1][e.y];l.building={cc:{...buildings.cc},createdAt:loop},l.building.id=getNewId(),l.aoi=PLAYERS.CPU,l.landingProgress=0,setTimeout((()=>{const l=getCellCoordinates(e.x+1,e.y);startParticleSystem(map[e.x+1][e.y].building.id,l[0]+5,l[1]+10,{r:220,g:200,b:0},"down",{initTtl:20,once:!0,speed:.5,maxParticles:30})}),900),this.state="CREATE_CC"}},CREATE_CC:{createMine(){const e=findAvailableCellOfType("helium3"),l=map[e.x][e.y];l.building={refinery:{...buildings.refinery},createdAt:loop},l.building.id=getNewId(),l.aoi=PLAYERS.CPU,l.landingProgress=0,setTimeout((()=>{const l=getCellCoordinates(e.x+1,e.y);startParticleSystem(map[e.x][e.y].building.id,l[0]+5,l[1]+10,{r:220,g:200,b:0},"down",{initTtl:20,once:!0,speed:.5,maxParticles:30})}),900);const t=getCellCoordinates(e.x,e.y);startParticleSystem(map[e.x][e.y].building.id,t[0]+17,t[1],{r:0,g:255,b:0},"up",{speed:.3}),this.state="CREATE_MINE"}},CREATE_MINE:{nextMine(){const e=findHelium3Sources().filter((e=>e.cell.aoi===PLAYERS.CPU&&!e.cell.building));if(e.length>0){const l=map[e[0].x][e[0].y];l.building={refinery:{...buildings.refinery},createdAt:loop},l.building.id=getNewId(),l.aoi=PLAYERS.CPU,l.landingProgress=0,setTimeout((()=>{const l=getCellCoordinates(e[0].x,e[0].y);startParticleSystem(map[e[0].x][e[0].y].building.id,l[0]+5,l[1]+10,{r:220,g:200,b:0},"down",{initTtl:20,once:!0,speed:.5,maxParticles:30})}),900);const t=getCellCoordinates(e[0].x,e[0].y);startParticleSystem(map[e[0].x][e[0].y].building.id,t[0]+17,t[1],{r:0,g:255,b:0},"up",{speed:.3}),this.state="CREATE_MINE"}else this.state="LOCATE_ENEMY_CC"}},LOCATE_ENEMY_CC:{createTurret(){const e=findOwnCells(PLAYERS.CPU),l=getEnemyDirection(),t=getCC();if(l===DIRECTION.LEFT){let l=!0;const i=e.filter((e=>e.x<t.x));let a;for(;l;)a=i[Math.floor(Math.random()*i.length)],a&&a.cell&&!a.cell.building&&"mountain"!==a.cell.type&&(map[a.x][a.y].building={turret:{...buildings.turret},createdAt:loop},map[a.x][a.y].building.id=getNewId(),map[a.x][a.y].aoi=PLAYERS.CPU,map[a.x][a.y].landingProgress=0,l=!1)}else if(l===DIRECTION.SAME||l===DIRECTION.RIGHT){let l=!0;const i=e.filter((e=>e.x>t.x||e.x===t.x));for(;l;)cell=i[Math.floor(Math.random()*i.length)],cell&&cell.cell&&!cell.cell.building&&"mountain"!==cell.cell.type&&(map[cell.x][cell.y].building={turret:{...buildings.turret},createdAt:loop},map[cell.x][cell.y].building.id=getNewId(),map[cell.x][cell.y].aoi=PLAYERS.CPU,map[cell.x][cell.y].landingProgress=0,l=!1)}else{let l=!0;for(;l;)cell=e[Math.floor(Math.random()*e.length)],cell&&cell.cell&&!cell.cell.building&&"mountain"!==cell.cell.type&&(map[cell.x][cell.y].building={turret:{...buildings.turret},createdAt:loop},map[cell.x][cell.y].building.id=getNewId(),map[cell.x][cell.y].aoi=PLAYERS.CPU,map[cell.x][cell.y].landingProgress=0,l=!1)}setTimeout((()=>{if(cell){const e=getCellCoordinates(cell.x,cell.y);startParticleSystem(map[cell.x][cell.y].building.id,e[0]+5,e[1]+10,{r:220,g:200,b:0},"down",{initTtl:20,once:!0,speed:.5,maxParticles:30})}}),900),this.state="CREATE_MINE"}}},dispatch(e){const l=this.transitions[this.state][e];l&&l.call(this)}},AIStep=()=>{AIStepNumber+=1,AIStepNumber%difficulty==0&&("INIT"===FSM.state?(FSM.dispatch("createCC"),generateAoI()):"CREATE_CC"===FSM.state?(FSM.dispatch("createMine"),generateAoI()):"CREATE_MINE"===FSM.state?(FSM.dispatch("nextMine"),generateAoI()):"LOCATE_ENEMY_CC"===FSM.state&&(FSM.dispatch("createTurret"),generateAoI()))},getTurretDirection=(e,l,t,i)=>e<t&&l<i+1&&l>i-1?"right":e>t&&l<i+1&&l>i-1?"left":e<t+1&&e>t-1&&l>i?"up":e<t+1&&e>t-1&&l<i?"down":e>t+1&&l<i+1?"down left":e>t+1&&l>i-1?"up left":e>t+1&&l<i-1?"up right":e>t+1&&l>i?"down right":e<t?"right":e>t?"left":void 0,turretAttack=()=>{const e=findAllCommandCenters(),l=findAllTurrets(),t=findAllMines(),i=l.concat(t).concat(e);let a=!1;l.forEach(((e,l)=>{if(a=!1,i.forEach(((l,t)=>{if(!a){const t=Math.sqrt(Math.pow(l.x-e.x,2)+Math.pow(l.y-e.y,2));if(t>0&&t<buildings.turret.range&&e.cell.aoi!==l.cell.aoi){const t=getCellCoordinates(l.x,l.y);if(l.cell.building?.turret?(l.cell.building?.turret&&e.cell.building?.turret&&(l.cell.building.turret.hp-=e.cell.building.turret.damage),l.cell.building?.turret?.hp<=0?destroy(l):l.cell.building?.turret?.hp<l.cell.building?.turret?.totalHP/2&&startParticleSystem(map[l.x][l.y].building.id,t[0]+15,t[1]+10,{r:255,g:100,b:0},"up",{initSize:8,initTtl:15,maxParticles:5,speed:.5})):l.cell.building?.refinery?(l.cell.building?.refinery&&e.cell.building?.turret&&(l.cell.building.refinery.hp-=e.cell.building.turret.damage),l.cell.building?.refinery?.hp<=0?destroy(l):l.cell.building?.refinery?.hp<l.cell.building?.refinery?.totalHP/2&&startParticleSystem(map[l.x][l.y].building.id,t[0]+15,t[1]+10,{r:255,g:100,b:0},"up",{initSize:8,initTtl:15,maxParticles:5,speed:.5})):l.cell.building?.cc&&(l.cell.building?.cc&&e.cell.building?.turret&&(l.cell.building.cc.hp-=e.cell.building.turret.damage),l.cell.building?.cc?.hp<=0?destroy(l):l.cell.building?.cc?.hp<l.cell.building?.cc?.totalHP/2&&startParticleSystem(map[l.x][l.y].building.id,t[0]+15,t[1]+10,{r:255,g:100,b:0},"up",{initSize:8,initTtl:15,maxParticles:5,speed:.5})),map[e.x][e.y].building){const t=getCellCoordinates(e.x,e.y);startParticleSystem(map[e.x][e.y].building.id,t[0]+17,t[1],{r:255,g:180,b:0},(i=e.x,r=e.y,s=l.x,n=l.y,i<s&&r<n+1&&r>n-1?"right":i>s&&r<n+1&&r>n-1?"left":i<s+1&&i>s-1&&r>n?"up":i<s+1&&i>s-1&&r<n?"down":i>s+1&&r<n+1?"down left":i>s+1&&r>n-1?"up left":i>s+1&&r<n-1?"up right":i>s+1&&r>n?"down right":i<s?"right":i>s?"left":void 0),{initSize:4,initTtl:50,maxParticles:3,speed:4})}a=!0}}var i,r,s,n})),!a){const l=particleSystems.find((l=>l.init.id===e.cell.building.id));l&&(l.ended=!0)}}))},checkWinLoseConditions=()=>{if(!pristineMap&&"INIT"!==FSM.state){const e=findAllCommandCenters();e.find((e=>e.cell.aoi===PLAYERS.CPU))?e.find((e=>e.cell.aoi===PLAYERS.HUMAN))||(state=STATES.LOSE):state=STATES.WIN}},gameLogic=()=>{map.forEach(((e,l)=>{e.forEach(((e,l)=>{e?.building?.refinery&&e.aoi===PLAYERS.HUMAN&&(helium3+=10)}))})),AIStepNumber+=1,AIStepNumber%difficulty==0&&("INIT"===FSM.state?(FSM.dispatch("createCC"),generateAoI()):"CREATE_CC"===FSM.state?(FSM.dispatch("createMine"),generateAoI()):"CREATE_MINE"===FSM.state?(FSM.dispatch("nextMine"),generateAoI()):"LOCATE_ENEMY_CC"===FSM.state&&(FSM.dispatch("createTurret"),generateAoI())),turretAttack(),checkWinLoseConditions()},updateLandingProgress=()=>{map.forEach(((e,l)=>{e.forEach(((e,l)=>{e.landingProgress<80?e.landingProgress+=5-e.landingProgress/21:e.landingProgress<100&&(e.landingProgress+=.4)}))}))},startCooldown=e=>{buildings[e].cooldownRemaining=buildings[e].cooldown,cooldownTimers[e]=setInterval((()=>{buildings[e].cooldownRemaining-=1,0===buildings[e].cooldownRemaining&&clearInterval(cooldownTimers[e])}),1e3)},getCellCoordinates=(e,l)=>e%2==0?[46*e+40+-10*e,46*l+24+40]:[46*e+40+-10*e,46*l+40],getNewId=()=>(incrementalId+=1,incrementalId),build=e=>{if(helium3>=buildings[e].cost&&0===buildings[e].cooldownRemaining){map[selCell[0]][selCell[1]].building={[e]:{...buildings[e]},createdAt:loop},map[selCell[0]][selCell[1]].building.id=getNewId(),map[selCell[0]][selCell[1]].aoi=PLAYERS.HUMAN,map[selCell[0]][selCell[1]].landingProgress=0,helium3-=buildings[e].cost,generateAoI(),startCooldown(e);const l=selCell[0],t=selCell[1],i=map[selCell[0]][selCell[1]];setTimeout((()=>{const e=getCellCoordinates(l,t);startParticleSystem(i.building.id,e[0]+5,e[1]+10,{r:220,g:200,b:0},"down",{initTtl:20,once:!0,speed:.5,maxParticles:30})}),900),setTimeout((()=>{if("refinery"===e){const e=getCellCoordinates(l,t);startParticleSystem(i.building.id,e[0]+17,e[1],{r:0,g:255,b:0},"up",{speed:.3})}}),2e3)}},destroy=e=>{const l=particleSystems.filter((l=>l.init.id===e.cell.building.id));l&&l.forEach((e=>{e.ended=!0})),e.cell.aoi=null,e.cell.building=null,map.forEach(((e,l)=>{e.forEach(((e,l)=>{e.building||(e.aoi=void 0,e.aoiScore=0)}))})),generateAoI()},updateSelectedCellInfo=()=>{const e=map[selCell[0]][selCell[1]],{type:l,building:t}=e;selectedCellInfo=t?.cc?"Command Center":t?.turret?"Turret":t?.refinery?"Refinery":"mountain"===l?"Mountains":"helium3"===l?"Helium-3":""},initInteraction=()=>{document.addEventListener("keydown",(e=>{if(state===STATES.RUNNING)switch(e.keyCode){case 37:selCell[0]=selCell[0]>0?selCell[0]-1:0,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 38:selCell[1]=selCell[1]>0?selCell[1]-1:0,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 39:selCell[0]=selCell[0]<19?selCell[0]+1:19,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 40:selCell[1]=selCell[1]<7?selCell[1]+1:7,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 49:(map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU||!map[selCell[0]][selCell[1]].aoi&&pristineMap)&&"mountain"!==map[selCell[0]][selCell[1]].type&&("1"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("cc")):buildBtnPressed="1");break;case 50:map[selCell[0]][selCell[1]].aoi&&map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU&&"mountain"!==map[selCell[0]][selCell[1]].type&&("2"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("turret")):(buildBtnPressed="2",generateTurretRangePreview(selCell[0],selCell[1])));break;case 51:map[selCell[0]][selCell[1]].aoi&&map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU&&"helium3"===map[selCell[0]][selCell[1]].type&&("3"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("refinery")):buildBtnPressed="3");break;case 27:buildBtnPressed=void 0;break;case 46:destroy({cell:map[selCell[0]][selCell[1]]});break;case 68:debuggingMode=!debuggingMode}else if(state!==STATES.WIN&&state!==STATES.LOSE||"Enter"!==e.key){if(state===STATES.TITLE)particleSystems=[],state=STATES.DIFFICULTY_SELECTION;else if(state===STATES.DIFFICULTY_SELECTION)switch(e.keyCode){case 49:difficulty=DIFFICULTY.EASY,state=STATES.RUNNING,play();break;case 50:difficulty=DIFFICULTY.DIFFICULT,state=STATES.RUNNING,play();break;case 51:difficulty=DIFFICULTY.EXTREME,state=STATES.RUNNING,play()}}else location.reload();state===STATES.RUNNING&&generateAoI()}))},drawTitle=()=>{ctx.fillStyle="#333333",ctx.fillRect(0,50,canvas.width,250),ctx.fillStyle="black",ctx.font="80px Arial",ctx.fillText("LUNAR",300,150),ctx.fillText("PODS",400,250),ctx.drawImage(podTile,100,200),ctx.drawImage(podTileCpu,200,200),ctx.fillStyle="white",ctx.font="14px Arial",ctx.fillText("by Eric Ros (@ericrosbh) for the 2021 js13kgames",460,290),ctx.strokeStyle="white",ctx.fillStyle="rgba(50, 50, 50, 0.8)",ctx.strokeRect(10,350,canvas.width-20,240),ctx.fillRect(10,350,canvas.width-20,240),ctx.fillStyle="white",ctx.fillText("The year is 2050. Humanity is desperate for clean energy. The new fusion reactors are promising, but they are fueled with",20,370),ctx.fillText("helium-3.. very scarce on Earth but not on the Moon. Only the mightiest will claim the precious resource...",20,390),ctx.fillText("Use arrows to change your selection and press 1, 2, or 3 to build.",20,430),ctx.fillText("The goal is to destroy the enemy command center.",20,450),ctx.fillText("Command centers do nothing, but they generate a large territory.",20,470),ctx.fillText("Inside your territory, you can build turrets, to attack enemy buildings, and refineries, to increase your helium-3 reserves.",20,490),ctx.fillText("You cannot build in mountains. A part from that, they do not have any effect in the game.",20,510),ctx.fillText("Press any key to start",canvas.width-150,canvas.height-20)},drawDifficultySelection=()=>{ctx.strokeStyle="white",ctx.fillStyle="rgba(50, 50, 50, 0.8)";const e=300,l=250;ctx.strokeRect(e,l,200,40),ctx.fillRect(e,l,200,40),ctx.strokeRect(e,310,200,40),ctx.fillRect(e,310,200,40),ctx.strokeRect(e,370,200,40),ctx.fillRect(e,370,200,40),ctx.fillStyle="gray",ctx.fillRect(310,260,20,20),ctx.fillRect(310,320,20,20),ctx.fillRect(310,380,20,20),ctx.fillStyle="white",ctx.fillText("Choose difficulty level:",e,220),ctx.fillStyle="black",ctx.fillText("1",316,275),ctx.fillText("2",316,335),ctx.fillText("3",316,395),ctx.fillStyle="white",ctx.fillText("Easy",340,275),ctx.fillText("Hard",340,335),ctx.fillText("Extreme",340,395)},gameLoop=()=>{state===STATES.TITLE?(ctx.clearRect(0,0,canvas.width,canvas.height),drawStars(),ctx.fillStyle="#333333",ctx.fillRect(0,50,canvas.width,250),ctx.fillStyle="black",ctx.font="80px Arial",ctx.fillText("LUNAR",300,150),ctx.fillText("PODS",400,250),ctx.drawImage(podTile,100,200),ctx.drawImage(podTileCpu,200,200),ctx.fillStyle="white",ctx.font="14px Arial",ctx.fillText("by Eric Ros (@ericrosbh) for the 2021 js13kgames",460,290),ctx.strokeStyle="white",ctx.fillStyle="rgba(50, 50, 50, 0.8)",ctx.strokeRect(10,350,canvas.width-20,240),ctx.fillRect(10,350,canvas.width-20,240),ctx.fillStyle="white",ctx.fillText("The year is 2050. Humanity is desperate for clean energy. The new fusion reactors are promising, but they are fueled with",20,370),ctx.fillText("helium-3.. very scarce on Earth but not on the Moon. Only the mightiest will claim the precious resource...",20,390),ctx.fillText("Use arrows to change your selection and press 1, 2, or 3 to build.",20,430),ctx.fillText("The goal is to destroy the enemy command center.",20,450),ctx.fillText("Command centers do nothing, but they generate a large territory.",20,470),ctx.fillText("Inside your territory, you can build turrets, to attack enemy buildings, and refineries, to increase your helium-3 reserves.",20,490),ctx.fillText("You cannot build in mountains. A part from that, they do not have any effect in the game.",20,510),ctx.fillText("Press any key to start",canvas.width-150,canvas.height-20)):state===STATES.DIFFICULTY_SELECTION?(ctx.clearRect(0,0,canvas.width,canvas.height),drawStars(),drawDifficultySelection()):(loop%60==0&&state===STATES.RUNNING&&(map.forEach(((e,l)=>{e.forEach(((e,l)=>{e?.building?.refinery&&e.aoi===PLAYERS.HUMAN&&(helium3+=10)}))})),AIStepNumber+=1,AIStepNumber%difficulty==0&&("INIT"===FSM.state?(FSM.dispatch("createCC"),generateAoI()):"CREATE_CC"===FSM.state?(FSM.dispatch("createMine"),generateAoI()):"CREATE_MINE"===FSM.state?(FSM.dispatch("nextMine"),generateAoI()):"LOCATE_ENEMY_CC"===FSM.state&&(FSM.dispatch("createTurret"),generateAoI())),turretAttack(),checkWinLoseConditions()),ctx.clearRect(0,0,canvas.width,canvas.height),drawStars(),drawMap(),drawUI(),map.forEach(((e,l)=>{e.forEach(((e,l)=>{e.landingProgress<80?e.landingProgress+=5-e.landingProgress/21:e.landingProgress<100&&(e.landingProgress+=.4)}))}))),state!==STATES.RUNNING&&state!==STATES.TITLE||particleSystems.forEach((e=>{const{initX:l,initY:t,initTtl:i,initSize:a,maxParticles:r,color:s,direction:n,speed:c,once:o}=e.init;e.particles.forEach(((r,d)=>{if(!r.dead){let{x:u,y:p,size:g}=r;ctx.clearRect(u,p,g,g);let f={...r};ctx.fillStyle=`rgba(${s.r}, ${s.g}, ${s.b}, ${f.opacity})`,ctx.fillRect(u,p,g,g),f.ttl-=1,f.ttl>0?("up"===n?(f.x+=2*Math.random()-1,f.y-=c):"down"===n?(f.x+=2*Math.random()-1,f.y-=-c):"left"===n?(f.x+=-c,f.y-=2*Math.random()-1):"right"===n?(f.x+=c,f.y-=2*Math.random()-1):"up left"===n?(f.x-=c/2,f.y-=c/2):"up right"===n?(f.x+=c/2,f.y-=c/2):"down left"===n?(f.x-=c/2,f.y+=c/2):"down right"===n&&(f.x+=c/2,f.y+=c/2),f.opacity-=1/i,f.size-=a/i):o?(f.opacity=0,f.dead=!0):(f.x=l,f.y=t,f.ttl=i+Math.floor(20*Math.random()),f.opacity=1,f.size=a),e.particles[d]=f}})),e.particles.length<r&&e.particles.push({x:l+10*Math.random(),y:t,opacity:1,size:5})})),loop%200==0&&(particleSystems=particleSystems.filter((e=>!e.ended))),loop++,window.requestAnimationFrame(gameLoop)},initGame=()=>{generateStarBackground(200),startParticleSystem(99990,115,230,{r:220,g:200,b:0},"down",{initTtl:50,speed:.5,maxParticles:30}),startParticleSystem(99991,215,230,{r:220,g:200,b:0},"down",{initTtl:50,speed:.5,maxParticles:30}),document.addEventListener("keydown",(e=>{if(state===STATES.RUNNING)switch(e.keyCode){case 37:selCell[0]=selCell[0]>0?selCell[0]-1:0,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 38:selCell[1]=selCell[1]>0?selCell[1]-1:0,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 39:selCell[0]=selCell[0]<19?selCell[0]+1:19,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 40:selCell[1]=selCell[1]<7?selCell[1]+1:7,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 49:(map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU||!map[selCell[0]][selCell[1]].aoi&&pristineMap)&&"mountain"!==map[selCell[0]][selCell[1]].type&&("1"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("cc")):buildBtnPressed="1");break;case 50:map[selCell[0]][selCell[1]].aoi&&map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU&&"mountain"!==map[selCell[0]][selCell[1]].type&&("2"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("turret")):(buildBtnPressed="2",generateTurretRangePreview(selCell[0],selCell[1])));break;case 51:map[selCell[0]][selCell[1]].aoi&&map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU&&"helium3"===map[selCell[0]][selCell[1]].type&&("3"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("refinery")):buildBtnPressed="3");break;case 27:buildBtnPressed=void 0;break;case 46:destroy({cell:map[selCell[0]][selCell[1]]});break;case 68:debuggingMode=!debuggingMode}else if(state!==STATES.WIN&&state!==STATES.LOSE||"Enter"!==e.key){if(state===STATES.TITLE)particleSystems=[],state=STATES.DIFFICULTY_SELECTION;else if(state===STATES.DIFFICULTY_SELECTION)switch(e.keyCode){case 49:difficulty=DIFFICULTY.EASY,state=STATES.RUNNING,play();break;case 50:difficulty=DIFFICULTY.DIFFICULT,state=STATES.RUNNING,play();break;case 51:difficulty=DIFFICULTY.EXTREME,state=STATES.RUNNING,play()}}else location.reload();state===STATES.RUNNING&&generateAoI()})),window.requestAnimationFrame(gameLoop)},play=()=>{generateMap(20,8)};window.addEventListener("load",(()=>{generateStarBackground(200),startParticleSystem(99990,115,230,{r:220,g:200,b:0},"down",{initTtl:50,speed:.5,maxParticles:30}),startParticleSystem(99991,215,230,{r:220,g:200,b:0},"down",{initTtl:50,speed:.5,maxParticles:30}),document.addEventListener("keydown",(e=>{if(state===STATES.RUNNING)switch(e.keyCode){case 37:selCell[0]=selCell[0]>0?selCell[0]-1:0,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 38:selCell[1]=selCell[1]>0?selCell[1]-1:0,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 39:selCell[0]=selCell[0]<19?selCell[0]+1:19,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 40:selCell[1]=selCell[1]<7?selCell[1]+1:7,updateSelectedCellInfo(),buildBtnPressed=void 0,clearTurretRangePreview();break;case 49:(map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU||!map[selCell[0]][selCell[1]].aoi&&pristineMap)&&"mountain"!==map[selCell[0]][selCell[1]].type&&("1"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("cc")):buildBtnPressed="1");break;case 50:map[selCell[0]][selCell[1]].aoi&&map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU&&"mountain"!==map[selCell[0]][selCell[1]].type&&("2"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("turret")):(buildBtnPressed="2",generateTurretRangePreview(selCell[0],selCell[1])));break;case 51:map[selCell[0]][selCell[1]].aoi&&map[selCell[0]][selCell[1]].aoi!==PLAYERS.CPU&&"helium3"===map[selCell[0]][selCell[1]].type&&("3"===buildBtnPressed&&map[selCell[0]][selCell[1]].building?.placeholder?(buildBtnPressed=void 0,pristineMap=!1,build("refinery")):buildBtnPressed="3");break;case 27:buildBtnPressed=void 0;break;case 46:destroy({cell:map[selCell[0]][selCell[1]]});break;case 68:debuggingMode=!debuggingMode}else if(state!==STATES.WIN&&state!==STATES.LOSE||"Enter"!==e.key){if(state===STATES.TITLE)particleSystems=[],state=STATES.DIFFICULTY_SELECTION;else if(state===STATES.DIFFICULTY_SELECTION)switch(e.keyCode){case 49:difficulty=DIFFICULTY.EASY,state=STATES.RUNNING,play();break;case 50:difficulty=DIFFICULTY.DIFFICULT,state=STATES.RUNNING,play();break;case 51:difficulty=DIFFICULTY.EXTREME,state=STATES.RUNNING,play()}}else location.reload();state===STATES.RUNNING&&generateAoI()})),window.requestAnimationFrame(gameLoop)}));
