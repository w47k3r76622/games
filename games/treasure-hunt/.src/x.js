"use strict";var loop=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.update,n=e.render,o=e.fps,i=void 0===o?1e3/60:o,r={mode:"stopped",startTime:(new Date).getTime(),timeSinceLastUPdate:0,frameTime:i};if(!t||!n)throw new Error("You need to declare an update an a render method");var a=function e(o){window.requestAnimationFrame(function(t){"stopped"!==r.mode&&e(t)});var i=(new Date).getTime()-r.startTime,a=o-i;r.timeSinceLastUpdate+=a,r.timeSinceLastUpdate>=r.frameTime&&(t(r.timeSinceLastUpdate),r.timeSinceLastUpdate=0),n()},s={};return s.start=function(){return r.mode="playing",r.startTime=(new Date).getTime(),r.timeSinceLastUpdate=0,a(0),s},s.stop=function(){return r.mode="stopped",s},s.pause=function(){return r.mode="paused",s},s.getState=function(){return r.mode},s},canvasFactory=function(){var e=window.document.querySelectorAll("canvas")[0],t=e.getContext("2d");return Object.create({setSize:function(t){var n=t.width,o=t.height;e.width=n,e.height=o},getWidth:function(){return e.width},getHeight:function(){return e.height},getContext:function(){return t}})},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},slicedToArray=function(){function e(e,t){var n=[],o=!0,i=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(o=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(e){i=!0,r=e}finally{try{!o&&s.return&&s.return()}finally{if(i)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),particleFactory=function(e){var t=e.position,n=e.speed,o=e.color,i=void 0===o?"hsla(50, 100%, 50%, 0.3)":o,r=e.lifetime,a=void 0===r?100:r,s=e.isAffectedByGravity,c=void 0===s||s,u=function(e){return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&e.hasOwnProperty("x")&&"number"==typeof e.x&&e.hasOwnProperty("y")&&"number"==typeof e.y&&e.hasOwnProperty("z")&&"number"==typeof e.z},d=function(e){return new Error("Particle Error: "+e)};if(!u(t)||!u(n))throw d("position or speed is not valid");var l=function(e){if(!u(e))throw d("speed is not a valid object");return{x:e.x,y:e.y,z:e.z-2}},p=function(e){var t=e.currentPosition,n=e.speed;if(!u(t))throw d("currentPosition is not a valid object");if(!u(n))throw d("speed is not a valid object");return{x:t.x+n.x,y:t.y+n.y,z:t.z+n.z}};return Object.create({move:p,gravity:l,speed:n,position:t,color:i,isAffectedByGravity:c,liveRemaining:a})},hudFactory=function(e){var t=e.type,n=e.speed,o=void 0===n?4:n,i=e.position,r=e.lifeRemaining,a=void 0===r?100:r,s=function e(t){var n=null,e=t.cycle,o=t.type,i=t.speed,r=t.position,a=t.lifeRemaining;return a-i>0&&(n={cycle:e,type:o,speed:i,position:r,lifeRemaining:a-i}),n};return Object.create({cycle:s,type:t,speed:o,position:i,lifeRemaining:a})},updateFactory=function(e){var t=e.screen,n=e.camera,o=e.layers,i=e.io,r=e.endFunction,a=e.attempts,s=e.sfx;return function(){var e=slicedToArray(o.mobs.mobs,1),c=e[0],u=i.getInput(),d=2;if(c.frame+=.2,c.frame>7&&(c.frame=0),c.targetPosition.x!==c.position.x?c.speed.x=c.targetPosition.x<c.position.x?-d:d:c.speed.x=0,c.targetPosition.y!==c.position.y?c.speed.y=c.targetPosition.y<c.position.y?-d:d:c.speed.y=0,0===c.speed.x&&0===c.speed.y&&(c.direction=null),0!==c.speed.x||0!==c.speed.y||0===u.direction.x&&0===u.direction.y||null!==c.action||(c.targetPosition=c.setTargetPosition({currentPosition:c.position,direction:u.direction}),0===o.surface.canvas.getContext("2d").getImageData(c.targetPosition.x,c.targetPosition.y,1,1).data[3]&&(r(null),s.fall()),u.direction.x>0&&0===u.direction.y?c.direction="EAST":u.direction.x<0&&0===u.direction.y?c.direction="WEST":0===u.direction.x&&u.direction.y<0?c.direction="NORTH":0===u.direction.x&&u.direction.y>0?c.direction="SOUTH":u.direction.x<0&&u.direction.y<0?c.direction="NORTH-WEST":u.direction.x>0&&u.direction.y<0?c.direction="NORTH-EAST":u.direction.x<0&&u.direction.y>0?c.direction="SOUTH-WEST":u.direction.x>0&&u.direction.y>0&&(c.direction="SOUTH-EAST"),s.walk()),c.previousPosition=Object.assign({},c.position),c.position=c.move({currentPosition:c.position,speed:c.speed}),c.position.x<0?(c.position.x=0,c.targetPosition.x=c.position.x):c.position.x+32>o.mobs.canvas.width&&(c.position.x=o.mobs.canvas.width-32,c.targetPosition.x=c.position.x),c.position.y<0?(c.position.y=0,c.targetPosition.y=c.position.y):c.position.y+32>o.mobs.canvas.height&&(c.position.y=o.mobs.canvas.height-32,c.targetPosition.y=c.position.y),null===c.action&&u.action&&(c.action=c.setAction({type:"DIG"})),c.action)if(c.action.stepsToComplete>0){if(Math.random()>.6)for(var l=particleFactory({position:{x:c.position.x+16,y:c.position.y+16,z:1},speed:{x:10*Math.random()-5,y:10*Math.random()-5,z:50},color:"hsla(50, 100%, "+Math.floor(100*Math.random())+"%, 0.8)"}),p=0,f=20;p<f;p++)if(null===o.particles.particles[p]){o.particles.particles[p]=l;break}c.action.stepsToComplete--,s.dig()}else{a+=1;var m=o.treasure.position,y=Math.floor(c.position.x/32),h=Math.floor(c.position.y/32),v=Math.abs(m.x-y),g=Math.abs(m.y-h),x=v+g,w=o.treasure.lastGuess;if(null!==w){var T=void 0;w<x?(T=hudFactory({type:"status-cooler",position:{x:c.position.x,y:c.position.y}}),s.cooler()):w>x?(T=hudFactory({type:"status-warmer",position:{x:c.position.x,y:c.position.y}}),s.warmer()):0!==x&&(T=hudFactory({type:"status-same",position:{x:c.position.x,y:c.position.y}}));for(var b=0,S=20;b<S;b++)if(null===o.hud.elements[b]){o.hud.elements[b]=T;break}}if(0===x){for(var E=hudFactory({type:"status-win",position:{x:c.position.x,y:c.position.y}}),A=0,P=20;A<P;A++)if(null===o.hud.elements[A]){o.hud.elements[A]=E;break}r(a)}o.treasure.lastGuess=x;var R=o.surface.canvas.getContext("2d");R.clearRect(c.position.x,c.position.y,32,32),c.action=null}o.particles.particles.forEach(function(e,t){null!==e&&(e.speed={x:.8*e.speed.x,y:.8*e.speed.y,z:.8*e.speed.z-1},e.position=e.move({currentPosition:e.position,speed:e.speed}),e.position.z<0&&(o.particles.particles[t]=null))}),o.hud.elements.forEach(function(e,t){null!==e&&(o.hud.elements[t]=e.cycle(e))}),n.speed.x=1*(c.position.x-n.position.x),n.speed.y=1*(c.position.y-n.position.y);var F=n.move(n.position,n.speed);F.x>o.surface.canvas.width-.5*t.getWidth()?n.speed.x=0:F.x<.5*t.getWidth()&&(n.speed.x=0),F.y>o.surface.canvas.height-.5*t.getHeight()?n.speed.y=0:F.y<.5*t.getHeight()&&(n.speed.y=0),n.position=n.move(n.position,n.speed)}},renderFactory=function(e){var t=e.screen,n=e.camera,o=e.layers,i=(e.map,e.player,t.getContext("2d")),r=function(e){var o=e.canvas,r=n.currentView(n.position,t);i.drawImage(o,r.x,r.y,r.width,r.height,0,0,t.getWidth(),t.getHeight())};return function(){var e=o.mobs.mobs,t=o.mobs.canvas,n=t.getContext("2d");e.forEach(function(e){n.clearRect(e.previousPosition.x-32,e.previousPosition.y-50,64,150)}),e.forEach(function(e){var t=Math.floor(e.frame);if(e.action)return void n.drawImage(e.image,8*t+144,0,8,32,e.position.x+8,e.position.y-32,16,64);switch(e.direction){case"NORTH":n.drawImage(e.image,8*t+64,0,8,32,e.position.x+8,e.position.y-32,16,64);break;case"SOUTH":n.save(),n.translate(e.position.x+8,e.position.y-32),n.drawImage(e.image,8*t+64,0,8,32,0,0,16,64),n.restore();break;case"WEST":case"NORTH-WEST":case"SOUTH-WEST":n.save(),n.translate(e.position.x+8+16,e.position.y-32),n.scale(-1,1),n.drawImage(e.image,8*t,0,8,32,0,0,16,64),n.restore();break;case"EAST":case"NORTH-EAST":case"SOUTH-EAST":n.drawImage(e.image,8*t,0,8,32,e.position.x+8,e.position.y-32,16,64);break;default:n.drawImage(e.image,t%2*8+128,0,8,32,e.position.x+8,e.position.y-32,16,64)}});var a=o.particles.particles,s=o.particles.canvas,c=s.getContext("2d");s.width=s.width,a.forEach(function(e){if(null!==e){var t=.1*e.position.z,n=.5*t;c.fillStyle=e.color,c.fillRect(e.position.x-n,e.position.y-n,t,t)}});var u=o.hud.elements,d=o.hud.canvas,l=d.getContext("2d");l.clearRect(e[0].position.x-100,e[0].position.y-100,232,232),u.forEach(function(e){if(null!==e){var t=.25*(100-e.lifeRemaining)+32,n=.5*t,o=.01*e.lifeRemaining,i="hsla(0, 100%, 100%, "+o+")";switch(e.type){case"status-warmer":i="hsla(0, 100%, 70%, "+o+")";break;case"status-cooler":i="hsla(240, 100%, 70%, "+o+")";break;case"status-found":i="hsla(60, 100%, 50%, "+o+")"}l.strokeStyle=i,l.lineWidth=8,l.strokeRect(e.position.x+16-n,e.position.y+16-n,t,t)}}),i.drawImage(o.underground.canvas,0,0),r(o.surface),r(o.mobs),r(o.particles),r(o.hud)}},mobFactory=function(e){var t=e.position,n=e.image,o=function(e){return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&e.hasOwnProperty("x")&&"number"==typeof e.x&&e.hasOwnProperty("y")&&"number"==typeof e.y},i=function(e){return new Error("Mob Error: "+e)},r=function(e){var t=e.currentPosition,n=e.direction;if(!o(t))throw i("currentPosition is not a valid object");var r=32;return{x:t.x+n.x*r,y:t.y+n.y*r}},a=function(e){var t=e.currentPosition,n=e.speed;if(!o(t))throw i("currentPosition is not a valid object");return{x:t.x+n.x,y:t.y+n.y}},s=function(e){var t=e.type,n=void 0;switch(t){case"DIG":n=60}return{type:t,stepsToComplete:n}};return Object.create({image:n,move:a,position:t,setTargetPosition:r,setAction:s,speed:{x:0,y:0},previousPosition:Object.assign({},t),targetPosition:Object.assign({},t),direction:"EAST",action:null,frame:0})},cameraActions=function(e){var t=e.position,n=function(e){return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&e.hasOwnProperty("x")&&"number"==typeof e.x&&e.hasOwnProperty("y")&&"number"==typeof e.y},o=function(e){return new Error("Camera Error: "+e)},i=function(e,t){if(!n(e))throw o("cameraPosition is not a valid object");var i=t.getWidth(),r=t.getHeight();return{x:e.x-.5*i,y:e.y-.5*r,width:i,height:r}},r=function(e,t){if(!n(e))throw o("currentPosition is not a valid object");if(!n(t))throw o("distanceTraveled is not a valid object");return{x:e.x+t.x,y:e.y+t.y}};return Object.create({currentView:i,move:r,position:t,speed:{x:0,y:0}})},tileFactory=function(){var e=32,t=function(t){var n=t.width,o=t.height,i=t.pattern,r=t.color,a=e/n,s=window.document.createElement("canvas");s.width=n*a,s.height=o*a,s.style.imageRendering="pixelated";var c=s.getContext("2d");return i.forEach(function(e,t){var o=t%n,i=Math.floor(t/n);c.fillStyle="hsl("+r+", 100%, "+10*e+"%)",c.save(),c.translate(o*a,i*a),c.fillRect(0,0,a,a),c.restore()}),c.getImageData(0,0,n*a,o*a)},n=function(n){var o=n.name,i=n.texture,r=(n.color,t(i));return{name:o,imageData:r,width:e,height:e}},o=n({name:"grass",texture:{width:4,height:4,pattern:[2,8,5,4,6,4,8,5,5,2,6,3,3,6,4,8],color:112}}),i=n({name:"dirt",texture:{width:4,height:4,pattern:[7,4,6,5,3,6,2,8,5,8,6,4,7,3,5,8],color:50}});return[o,i]},mapFactory=function(){var e=tileFactory(),t=function(e){for(var t=e.width,n=e.height,o=t*n,i=[],r=0,a=o;r<a;r++)i.push(Math.floor(2*Math.random()));return{width:t,height:n,tiles:i}},n=function(t){var n=t.type;return e[n]},o=function(e){var t=e.canvas,o=e.tileMap,i=o.width,r=o.height,a=o.tiles,s=n({type:o.tiles[0]}),c=s.width,u=s.height;t.width=i*c,t.height=r*u;var d=t.getContext("2d");a.forEach(function(e,t){var o=n({type:e}),r=t%i,a=Math.floor(t/i);d.putImageData(o.imageData,r*c,a*u)})};return{generateMap:t,getTile:n,renderMap:o}},ioFactory=function(){var e={direction:{x:0,y:0},action:null},t=function(t){switch(t.keyCode){case 37:return void(e.direction.x=-1);case 38:return void(e.direction.y=-1);case 39:return void(e.direction.x=1);case 40:return void(e.direction.y=1);case 90:return void(e.action=!0)}},n=function(t){switch(t.keyCode){case 37:case 39:return void(e.direction.x=0);case 38:case 40:return void(e.direction.y=0);case 90:return void(e.action=null)}};window.addEventListener("keydown",t),window.addEventListener("keyup",n);var o=function(){return e};return{getInput:o}},soundFactory=function(){var e=!1,t=new AudioContext,n=new AudioContext,o=function(){for(var e=t.sampleRate,n=t.createBuffer(1,e,t.sampleRate),o=n.getChannelData(0),i=0;i<e;i++)o[i]=2*Math.random()-1;return n},i=function(){if(!e){e=!0;var n=t.currentTime,o=t.createOscillator(),i=t.createGain();o.connect(i),i.connect(t.destination),i.gain.setValueAtTime(1,n),i.gain.exponentialRampToValueAtTime(.001,n+.5),o.frequency.setValueAtTime(150,n),o.frequency.exponentialRampToValueAtTime(.001,n+.5),o.start(n),o.stop(n+.5),setTimeout(function(){e=!1},200)}},r=function(){if(!e){e=!0;var n=t.currentTime,i=t.createBufferSource();i.buffer=o(t);var r=t.createBiquadFilter();r.type="highpass",r.frequency.value=5e3,i.connect(r);var a=t.createGain();r.connect(a),a.connect(t.destination);var s=t.createOscillator();s.type="triangle";var c=t.createGain();s.connect(c),c.connect(t.destination),a.gain.setValueAtTime(1,n),a.gain.exponentialRampToValueAtTime(.01,n+.2),i.start(n),s.frequency.setValueAtTime(100,n),c.gain.setValueAtTime(.7,n),c.gain.exponentialRampToValueAtTime(.01,n+.1),s.start(n),s.stop(n+.2),i.stop(n+.2),setTimeout(function(){e=!1},200)}},a=function(){var e=n.currentTime,t=n.createOscillator(),o=n.createGain();t.connect(o),o.connect(n.destination),o.gain.setValueAtTime(1,e),o.gain.exponentialRampToValueAtTime(.001,e+.5),t.frequency.setValueAtTime(100,e),t.frequency.exponentialRampToValueAtTime(1e3,e+.5),t.start(e),t.stop(e+.5)},s=function(){var e=n.currentTime,t=n.createOscillator(),o=n.createGain();t.connect(o),o.connect(n.destination),o.gain.setValueAtTime(1,e),o.gain.exponentialRampToValueAtTime(.001,e+.5),t.frequency.setValueAtTime(1e3,e),t.frequency.exponentialRampToValueAtTime(100,e+.5),t.start(e),t.stop(e+.5)},c=function(){var e=n.currentTime,t=n.createOscillator(),o=n.createGain();t.connect(o),o.connect(n.destination),o.gain.setValueAtTime(1,e),o.gain.exponentialRampToValueAtTime(.001,e+5),t.frequency.setValueAtTime(200,e),t.frequency.exponentialRampToValueAtTime(.01,e+5),t.start(e),t.stop(e+5)};return{dig:i,walk:r,warmer:a,cooler:s,fall:c}},removeSmoothing=function(e){var t=e.getContext("2d");t.imageSmoothingEnabled=!1},stateFactory=function(e){var t=e.screen,n=e.heroImage,o=e.endFunction,i=e.attempts,r=void 0===i?0:i,a=mapFactory(),s={canvas:window.document.createElement("canvas")};s.canvas.width=t.getWidth(),s.canvas.height=t.getHeight();for(var c=s.canvas.getContext("2d"),u=8,d=0,l=t.getHeight()/u;d<l;d++)for(var p=0,f=t.getWidth()/u;p<f;p++)c.fillStyle="hsl(50, 100%, "+Math.floor(20*Math.random())+"%)",c.fillRect(p*u,d*u,u,u);for(var m=300,y=150,h={canvas:window.document.createElement("canvas"),tileMap:a.generateMap({width:m,height:y})},v={canvas:window.document.createElement("canvas"),mobs:[mobFactory({position:{x:32*(Math.floor(200*Math.random())+50),y:32*(Math.floor(100*Math.random())+25)},image:n})]},g={canvas:window.document.createElement("canvas"),particles:[]},x=0,w=20;x<w;x++)g.particles[x]=null;for(var T={position:{x:Math.floor(Math.random()*m),y:Math.floor(Math.random()*y)},lastGuess:null},b={canvas:window.document.createElement("canvas"),elements:[]},S=0,E=20;S<E;S++)b.elements[S]=null;a.renderMap(h),v.canvas.width=h.canvas.width,v.canvas.height=h.canvas.height,g.canvas.width=h.canvas.width,g.canvas.height=h.canvas.height,b.canvas.width=h.canvas.width,b.canvas.height=h.canvas.height;var A={underground:s,surface:h,mobs:v,particles:g,treasure:T,hud:b};removeSmoothing(A.underground.canvas),removeSmoothing(A.surface.canvas),removeSmoothing(A.mobs.canvas),removeSmoothing(A.particles.canvas),removeSmoothing(A.hud.canvas);var P=cameraActions({position:{x:.5*t.getWidth(),y:.5*t.getHeight()}}),R=ioFactory();return{screen:t,camera:P,map:a,layers:A,io:R,endFunction:o,attempts:r,sfx:soundFactory()}},fontFactory=function(e){var t=e.fontImage,n=e.width,o=void 0===n?5:n,i=e.height,r=void 0===i?7:i,a=function(e){switch(e){case"a":return 0;case"b":return 5;case"c":return 10;case"d":return 15;case"e":return 20;case"f":return 25;case"g":return 30;case"h":return 35;case"i":return 40;case"j":return 45;case"k":return 50;case"l":return 55;case"m":return 60;case"n":return 65;case"o":return 70;case"p":return 75;case"q":return 80;case"r":return 85;case"s":return 90;case"t":return 95;case"u":return 100;case"v":return 105;case"w":return 110;case"x":return 115;case"y":return 120;case"z":return 125;case"0":return 130;case"1":return 135;case"2":return 140;case"3":return 145;case"4":return 150;case"5":return 155;case"6":return 160;case"7":return 165;case"8":return 170;case"9":return 175;default:return null}},s=function(e){var n=e.ctx,i=e.position,s=e.text,c=0;s.toLowerCase().split("").forEach(function(e){var s=a(e);null!==s&&n.drawImage(t,s,0,o,r,i.x+c,i.y,2*o,2*r),c+=12})};return{draw:s}},game=void 0,screen=canvasFactory();screen.setSize({width:600,height:400});var assets=[{name:"hero",src:"hero.png",loaded:!1,el:window.document.createElement("img")},{name:"font",src:"font.png",loaded:!1,el:window.document.createElement("img")}],font=fontFactory({fontImage:assets[1].el}),state=stateFactory({screen:screen,heroImage:assets[0].el,endFunction:function(e){game.stop(),setTimeout(function(){var t=screen.getContext();t.fillStyle="hsl(180, 20%, 50%)",t.fillRect(0,0,screen.getWidth(),screen.getHeight()),null===e?(font.draw({ctx:t,position:{x:10,y:10},text:"treasure hunt"}),font.draw({ctx:t,position:{x:10,y:50},text:"you fell down a hold you dug"}),font.draw({ctx:t,position:{x:10,y:70},text:"game over"})):(font.draw({ctx:t,position:{x:10,y:10},text:"treasure hunt"}),font.draw({ctx:t,position:{x:10,y:50},text:"well done you found it"}),font.draw({ctx:t,position:{x:10,y:70},text:"you dug "+e+" holes"}))},0)}}),update=updateFactory(state),render=renderFactory(state);game=loop({update:update,render:render});var renderStartScreen=function(){var e=screen.getContext();e.imageSmoothingEnabled=!1,e.fillStyle="hsl(180, 20%, 50%)",e.fillRect(0,0,screen.getWidth(),screen.getHeight()),font.draw({ctx:e,position:{x:10,y:10},text:"treasure hunt"}),font.draw({ctx:e,position:{x:10,y:50},text:"use the arrow keys to move and z to dig"}),font.draw({ctx:e,position:{x:10,y:70},text:"red icons indicate you are getting closer"}),font.draw({ctx:e,position:{x:10,y:90},text:"blue icons indicate you are further away"}),font.draw({ctx:e,position:{x:10,y:130},text:"press any key to begin"});var t=void 0;t=function(){window.document.removeEventListener("keydown",t),game.start()},window.document.addEventListener("keydown",t)},isLoadComplete=function(){var e=assets.filter(function(e){return e.loaded}).length,t=assets.length;e===t&&renderStartScreen()};assets.forEach(function(e){e.el.src=e.src,e.el.onload=function(){e.loaded=!0,isLoadComplete()}});