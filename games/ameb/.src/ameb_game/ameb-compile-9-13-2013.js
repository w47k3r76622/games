var ActionScript=function(){function a(){c=G.EvntFactory.get();b();c.on("ActionScript.addTick",function(){e=!0});c.on("ActionScript.removeTick",function(){e=!1})}function b(){c.on("tick",function(a){if(!e)return!1;a%=f;if(d[a])d[a]()})}var c,f=10,e=!1,d={0:function(){c.trigger("ameb.moveHead",[0,-10]);c.trigger("ameb.footConstraintToggle")},1:function(){c.trigger("ameb.footConstraintToggle");c.trigger("ameb.moveHead",[0,-10])},2:function(){c.trigger("ameb.moveHead",[-20,0])},5:function(){c.trigger("ameb.moveHead",
[0,-10]);c.trigger("ameb.headConstraintToggle");c.trigger("ameb.footConstraintToggle")},6:function(){c.trigger("ameb.moveHead",[0,-40]);c.trigger("ameb.footConstraintToggle")},9:function(){c.trigger("ameb.headConstraintToggle")}};return{init:function(){a()}}}();var ameb;
ameb=function(){var a,b,c,f;function e(e){F=e.width;M=e.height;t=F/2;w=90;y=w-19;e=15;var u=200,D=80,E="rgba(200,"+u+","+D+",1.0 )";g=G.EvntFactory.get();for(var z=9;--z;)E={pos:new Vector2D(t,y),lastPos:new Vector2D(t,y),color:E,jitter:0,size:e,boundWidth:F,boundHeight:M},e-=1,N.push(E),y+=S,u+=10,D+=10,E="rgba(200,"+u+","+D+",1.0 )";g.on("tick",function(){0===O%3&&A--;0>=A&&(p(m),p(v),B=!1,g.trigger("ameb.die"));B&&(g.trigger("ameb.tick",{healthPoints:A,bugsEaten:P}),O++)});g.on("ameb.headConstraintToggle",d);
g.on("ameb.footConstraintToggle",l);g.on("ameb.moveHead",function(a){q.pos.dist(n.pos.add(new Vector2D(a[0],a[1])))<Q&&B&&(n.pos.mutableAdd(new Vector2D(a[0],a[1])),v.pos.mutableAdd(new Vector2D(a[0],a[1])))});g.on("ameb.eatGrub",function(){r()});g.on("game.reset",function(){B||(B=!0,A=45,n.pos=new Vector2D(t,w),n.lastPos=new Vector2D(t,w),q.pos=new Vector2D(t,w+5),q.lastPos=new Vector2D(t,w+5),m=new PinConstraint(q,q.pos),k.push(m))});g.on("game.frame",function(e){R++;H&&(0===R%10&&(I*=-1),J.pos.x+=
I);K?(x+=30,x%=250,n.color="rgba("+x+",250,"+x+",1)"):n.color="rgba(200, 200, 80, 1)";var d=0,d=d=d=0,s=[],l=[],L=[],u=[],g;for(g in h)h[g].frame(),d=Math.ceil(h[g].pos.y-h[g].size),s.push(d),d=Math.ceil(h[g].pos.y+h[g].size),L.push(d),d=Math.ceil(h[g].pos.x+h[g].size),l.push(d),d=Math.ceil(h[g].pos.x-h[g].size),u.push(d);var p=1/e;for(g=0;g<e;++g)for(var m in k)k[m].relax(p),k[m].cornerPoints&&(d=Math.ceil(Math.min(k[m].cornerPoints.p1.y,k[m].cornerPoints.p2.y,k[m].cornerPoints.p3.y,k[m].cornerPoints.p4.y)),
s.push(d));a=Math.min.apply(null,s);b=Math.max.apply(null,l);c=Math.max.apply(null,L);f=Math.min.apply(null,u)});g.on("game.draw",function(a){for(var b=0;b<h.length;++b)h[b].draw(a);for(b=0;b<k.length;++b)k[b].draw(a)});g.on("ameb.wagTail",function(a){s()});g.on("ameb.isInsideAmebBoundingBox",function(d){if(!(d.pos.y<a||d.pos.x>b||d.pos.x<f||d.pos.y>c)&&C(d)){var e=d.pos.x,s=d.pos.y;d.pos.x=d.lastPos.x;d.pos.y=d.lastPos.y;d.lastPos.x=e;d.lastPos.y=s}});h=particleFactory.get(N);n=h[0];q=h[1];J=h[h.length-
1];for(z in h)0<z&&k.push(new DistanceConstraint(h[z],h[z-1],0.02,30));n.size=10;n.color="rgba( 255, 90, 0, 0.9)";q.color="rgba( 200, 200, 0, 0.9)";v=new PinConstraint(n,n.pos);h[1].size=20;m=new PinConstraint(h[1],h[1].pos);k.push(m)}function d(){if(-1!==k.indexOf(v))p(v);else{var a=q.pos.dist(n.pos);Q=100<a?a:100;v=new PinConstraint(n,n.pos);k.push(v)}}function l(){-1!==k.indexOf(m)?p(m):(m=new PinConstraint(q,q.pos),k.push(m))}function r(){A++;P++;K=!0;n.color="#00f";setTimeout(function(){K=!1},
T)}function p(a){a=k.indexOf(a);-1!=a&&k.splice(a,1)}function s(){H=!0;setTimeout(function(){H=!1},U)}function C(a){var b=a.getNextPos(),c=h,d;for(d in c)if(Collide.circlePoint(c[d],b))return"0"===d?(g.trigger("ameb.eatGrub"),a.eatGrub(),!1):!0;var b=k.slice(0,7),e;for(e in b)if(c={},c.p1=b[e].cornerPoints.p1,c.p2=b[e].cornerPoints.p3,c.p3=b[e].cornerPoints.p4,d={},d.p1=b[e].cornerPoints.p1,d.p2=b[e].cornerPoints.p2,d.p3=b[e].cornerPoints.p3,Collide.trianglePoint(c,a.pos)||Collide.trianglePoint(d,
a.pos))return!0;return!1}var n=null,q=null,v=null,m=null,J=null,h=[],k=[],N=[],Q=100,B=!0,A=55,P=0,y=20,S=20,F=300,M=500,g=null,O=0,t=10,w=10,R=f=c=b=a=0,I=2,H=!1,U=4E3,T=3E3,x=200,K=!1;return{init:function(a){e(a)}}}();var Collide=function(){return{circlePoint:function(a,b){return Math.sqrt(Math.pow(b.x-a.pos.x,2)+Math.pow(b.y-a.pos.y,2))<a.size},trianglePoint:function(a,b){var c=((a.p2.y-a.p3.y)*(b.x-a.p3.x)+(a.p3.x-a.p2.x)*(b.y-a.p3.y))/((a.p2.y-a.p3.y)*(a.p1.x-a.p3.x)+(a.p3.x-a.p2.x)*(a.p1.y-a.p3.y)),f=((a.p3.y-a.p1.y)*(b.x-a.p3.x)+(a.p1.x-a.p3.x)*(b.y-a.p3.y))/((a.p2.y-a.p3.y)*(a.p1.x-a.p3.x)+(a.p3.x-a.p2.x)*(a.p1.y-a.p3.y));return 0<c&&0<f&&0<1-c-f}}}();function DistanceConstraint(a,b,c,f){this.a=a;this.b=b;this.distance="undefined"!=typeof f?f:a.pos.sub(b.pos).length();this.stiffness=c;this.cornerPoints=[]}DistanceConstraint.prototype.relax=function(a){var b=this.a.pos.sub(this.b.pos),c=b.length2();b.mutableScale((this.distance*this.distance-c)/c*this.stiffness*a);this.a.pos.mutableAdd(b);this.b.pos.mutableSub(b);this.setCornerPoints()};
DistanceConstraint.prototype.setCornerPoints=function(){rad=this.b.size/2+2;var a=(this.b.pos.x-this.a.pos.x)/Math.sqrt(Math.pow(this.a.pos.x-this.b.pos.x,2)+Math.pow(this.a.pos.y-this.b.pos.y,2)),b=(this.b.pos.y-this.a.pos.y)/Math.sqrt(Math.pow(this.a.pos.x-this.b.pos.x,2)+Math.pow(this.a.pos.y-this.b.pos.y,2)),a=this.a.pos.x-(this.a.pos.x+rad*a),b=this.a.pos.y-(this.a.pos.y+rad*b);this.cornerPoints={p1:{x:this.b.pos.x-b,y:this.b.pos.y+a},p2:{x:this.b.pos.x+b,y:this.b.pos.y-a},p3:{x:this.a.pos.x+
b,y:this.a.pos.y-a},p4:{x:this.a.pos.x-b,y:this.a.pos.y+a}}};DistanceConstraint.prototype.draw=function(a){a.beginPath();a.moveTo(this.a.pos.x,this.a.pos.y);a.lineTo(this.b.pos.x,this.b.pos.y);a.lineWidth=3;a.strokeStyle="#aa0";a.stroke();a.beginPath();a.fillStyle="rgba(0, 0, 250 , .2)";for(var b in this.cornerPoints)a.lineTo(this.cornerPoints[b].x,this.cornerPoints[b].y);a.closePath();a.fill()};function PinConstraint(a,b){this.a=a;this.pos=(new Vector2D).mutableSet(b)}
PinConstraint.prototype.relax=function(a){this.a.pos.mutableSet(this.pos)};PinConstraint.prototype.draw=function(a){};var G={};G.Evnt=function(){var a=[];return{trigger:function(b,c){for(var f in a)b===a[f].e&&a[f].callback(c)},on:function(b,c){a.push({e:b,callback:c})},remove:function(b){for(var c in a)b===a[c].e&&a.splice(c,1)}}}();G.EvntFactory=function(){var a=G.Evnt;return{get:function(){return a}}}();var game=function(){function a(){b(16);c();setTimeout(function(){requestAnimFrame(a)},40)}function b(a){C<Date.now()-q&&(C=Date.now(),f.trigger("tick",n),n++);f.trigger("game.frame",a);for(var b in p)p[b].frame(),f.trigger("ameb.isInsideAmebBoundingBox",p[b])}function c(){d.fillStyle="rgba(255,255,254, 0.9  )";d.rect(0,0,l,r);d.fill();for(var a in p)p[a].draw(d);f.trigger("game.draw",d)}var f,e,d,l,r,p=[],s,C,n=0,q=1E3;window.addEventListener("load",function m(){window.removeEventListener("load",
m,!1);f=G.EvntFactory.get();new Vector2D(0,0.1);C=s=Date.now();e=document.getElementById("board");var b=document.getElementsByTagName("body")[0],c=document.documentElement.clientHeight,k=document.documentElement.clientWidth;e.style.backgroundColor="#cff";b.style.backgroundColor="#000";b.style.margin="2px";l=k-15;r=c-15;b=window.devicePixelRatio||1;e.width=l*b;e.height=r*b;e.getContext("2d").scale(b,b);d=e.getContext("2d");p=GrubFactory.get({width:l,height:r});ameb.init({width:l,height:r});UserActions.init();
f.trigger("UserActions.addAmebAction");ActionScript.init();Messages.init();a()})}();var GrubFactory=function(){function a(){for(var a=[],d=170;--d;){var l=rand(10,b-10);rand(0,c);l={pos:new Vector2D(l,2),lastPos:new Vector2D(l,2),color:"rgba(55,"+rand(20,150)+", "+rand(20,150)+", 0.7)",size:5,boundWidth:b,boundHeight:c,gravity:new Vector2D(0,-0.0030),eatGrub:function(){var a=rand(10,b-10);this.pos=new Vector2D(a,1);this.lastPos=new Vector2D(a,0)}};a.push(l)}f=particleFactory.get(a)}var b,c,f=[];return{get:function(e){1>f.length&&(b=e.width,c=e.height,a());return f}}}();var Messages=function(){function a(){r=document.getElementById("status");Date.now();d.on("UserActions.userResponse",function(){p=!0});d.on("tick",function(){3!==l||p||(e=e!==f?f:[]);19===l&&(e=[]);l++});d.on("game.draw",function(a){if(0<e.length){var b=30;a.fillStyle="#f00";a.strokeStyle="#f00";a.font="18px Arial";a.closePath();a.beginPath();a.fillStyle="rgba(210, 250, 210, .7)";a.rect(1,10,450,22*e.length+10);a.fill();a.closePath();for(var c in e)a.font="18px Arial",a.fillStyle="#111",a.fillText(e[c],
10,b),a.font="18px Arial Bold",a.fillStyle="#00f",b+=22}});d.on("game.reset",function(a){e=[]});d.on("ameb.tick",function(a){r.innerHTML=b.labels.healthPoints+a.healthPoints+b.labels.bugsEaten+a.bugsEaten+"  "});d.on("ameb.die",function(){r.innerHTML=b.statusStates.die;e=[b.insructions[7]]});d.on("Messages.toggleIntro",function(a){e=e!==c?c:[]});d.on("Messages.toggleDescription",function(a){e=e!==b.description?b.description:[]});d.on("Messages.toggleFullDescription",function(a){e=e!==f?f:[]})}var b=
{title:["AMEB"],credit:["Designed and Developed by Goatstone, 2013"],description:["Ameb has only a head, a foot and a tail. ","Ameb must eat bugs to stay alive!"],insructions:'\'?\' key shows this description at any time.;Arrow keys Move Amebs\' head to catch bugs.;"c" key locks and unlocks Amebs\' head in place.;"space bar" locks and unlocks Amebs\' foot in place.;"a" key puts Ameb in Automatic mode.;"m" key puts Ameb in Manual mode.;"w" key to wag Amebs\' tail.;"r" key to reset the game.'.split(";"),
labels:{healthPoints:"Health Points: ",bugsEaten:" | Bugs Eaten: "},statusStates:{die:"Amed is Dead!"},keyboard:{c:"Lock or free the head",spaceBar:"Lock or free the Foot",arrowKeys:"move Ameb's head"}},c=[b.title[0],b.credit[0]],f=[b.title[0],b.credit[0]],f=f.concat(b.description),f=f.concat(b.insructions),e=[],d=G.EvntFactory.get(),l=0,r=null,p=!1;return{init:function(){a()}}}();var particleFactory=function(){function a(a){this.color="rgba( 20, 20, 20, 0.8)";this.pos=(new Vector2D).mutableSet(a);this.lastPos=(new Vector2D).mutableSet(a);this.size=15;this.boundWidth=this.boundHeight=250;this.jitter=1.06;this.gravity=new Vector2D(0,0.1)}a.prototype.getNextPos=function(a){var c=this.pos.sub(this.lastPos);a=new Vector2D(this.pos.x,this.pos.y);a=a.add(c);a=a.add(this.gravity);c=Math.floor(Math.random()*this.jitter);c=0.5<Math.random()?c:-1*c;return a=a.add(new Vector2D(c,c))};
a.prototype.draw=function(a){a.beginPath();a.arc(this.pos.x,this.pos.y,this.size,0,2*Math.PI);a.fillStyle=this.color;a.fill()};a.prototype.frame=function(){var a=this.pos.sub(this.lastPos);this.lastPos.mutableSet(this.pos);this.pos.mutableAdd(a);this.pos.mutableAdd(this.gravity);a=Math.floor(Math.random()*this.jitter);a=0.5<Math.random()?a:-1*a;this.pos.mutableAdd(new Vector2D(a,a));this.bounds()};a.prototype.bounds=function(){this.pos.y>this.boundHeight?this.pos.y=this.boundHeight-2:0>this.pos.y?
this.pos.y=2:0>this.pos.x?this.pos.x=2:this.pos.x>this.boundWidth-1&&(this.pos.x=this.boundWidth-2)};return{get:function(b){var c=[],f;for(f in b){var e=new a(b[f].pos),d;for(d in b[f])e[d]=b[f][d];c.push(e)}return c}}}();var UserActions=function(){function a(){addEventListener("keydown",function(a){c.trigger("UserActions.userResponse");87===a.which&&c.trigger("ameb.wagTail");65===a.which?(c.trigger("UserActions.removeAmebAction"),c.trigger("ActionScript.addTick")):77===a.which?(c.trigger("UserActions.addAmebAction"),c.trigger("ActionScript.removeTick")):82===a.which?c.trigger("game.reset"):73===a.which?c.trigger("Messages.toggleIntro"):191===a.which&&c.trigger("Messages.toggleFullDescription");e&&(67===a.which?c.trigger("ameb.headConstraintToggle"):
32===a.which?c.trigger("ameb.footConstraintToggle"):37<=a.which&&40>=a.which&&c.trigger("ameb.moveHead",f[a.which]))})}function b(){c=G.EvntFactory.get();a();c.on("UserActions.addAmebAction",function(){e=!0});c.on("UserActions.removeAmebAction",function(){e=!1})}var c,f={37:[-5,0],38:[0,-5],39:[5,0],40:[0,5]},e=!1;return{init:function(){b()}}}();function rand(a,b){var c=0,c=Math.random()*(b-a);return Math.floor(c+a)}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)};function Vector2D(a,b){this.x=a||0;this.y=b||0}Vector2D.prototype.add=function(a){return new Vector2D(this.x+a.x,this.y+a.y)};Vector2D.prototype.sub=function(a){return new Vector2D(this.x-a.x,this.y-a.y)};Vector2D.prototype.mul=function(a){return new Vector2D(this.x*a.x,this.y*a.y)};Vector2D.prototype.div=function(a){return new Vector2D(this.x/a.x,this.y/a.y)};Vector2D.prototype.scale=function(a){return new Vector2D(this.x*a,this.y*a)};
Vector2D.prototype.mutableSet=function(a){this.x=a.x;this.y=a.y;return this};Vector2D.prototype.mutableAdd=function(a){this.x+=a.x;this.y+=a.y;return this};Vector2D.prototype.mutableSub=function(a){this.x-=a.x;this.y-=a.y;return this};Vector2D.prototype.mutableMul=function(a){this.x*=a.x;this.y*=a.y;return this};Vector2D.prototype.mutableDiv=function(a){this.x/=a.x;this.y/=a.y;return this};Vector2D.prototype.mutableScale=function(a){this.x*=a;this.y*=a;return this};
Vector2D.prototype.equals=function(a){return this.x==a.x&&this.y==a.y};Vector2D.prototype.length=function(a){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector2D.prototype.length2=function(a){return this.x*this.x+this.y*this.y};Vector2D.prototype.dist=function(a){return Math.floor(Math.sqrt(this.dist2(a)))};Vector2D.prototype.dist2=function(a){var b=a.x-this.x;a=a.y-this.y;return b*b+a*a};
