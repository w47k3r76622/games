(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var View=function(){function View(canvas){this.stepObjects=new Array;this.renderObjects=new Array;this.countFPS=0;this.fps=0;this.countSPS=0;this.sps=0;this.running=false;this.canvas=canvas;this.resizeCanvas();this.keyboardController=new KeyboardController;this.addStepObject(this.keyboardController);this.resizeCanvas=this.resizeCanvas.bind(this)}View.prototype.addStepObject=function(o){this.stepObjects.push(o)};View.prototype.addRenderObject=function(o){this.renderObjects.push(o)};View.prototype.addObject=function(o){this.addStepObject(o);this.addRenderObject(o)};View.prototype.step=function(){this.stepObjects.forEach(function(o){return o.preStep()});this.stepObjects.forEach(function(o){return o.step()});this.countSPS++};View.prototype.render=function(){var _this=this;var g=this.canvas.getContext("2d");g.setTransform(1,0,0,1,0,0);g.clearRect(0,0,this.canvas.width,this.canvas.height);this.renderObjects.forEach(function(o){return o.render(g)});this.countFPS++;if(this.running)window.requestAnimationFrame(function(){return _this.render()})};View.prototype.start=function(sps){var _this=this;this.stop();this.keyboardController.stop();window.addEventListener("resize",this.resizeCanvas);this.running=true;this.keyboardController.start();this.step();window.requestAnimationFrame(function(){return _this.render()});this.stepToken=setInterval(function(){return _this.step()},1e3/sps);this.countFPSToken=setInterval(function(){_this.fps=_this.countFPS;_this.countFPS=0;_this.sps=_this.countSPS;_this.countSPS=0},1e3)};View.prototype.stop=function(){window.removeEventListener("resize",this.resizeCanvas);if(this.stepToken)clearInterval(this.stepToken);if(this.countFPSToken)clearInterval(this.countFPSToken);this.stepToken=null;this.countFPSToken=null;this.running=false};View.prototype.addKeyListener=function(keyCode,callback){this.keyboardController.addListener(keyCode,callback)};View.prototype.resizeCanvas=function(){this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight};return View}();exports.View=View;var KeyboardController=function(){function KeyboardController(){this.pressedKeys={};this.keyListeners={};this.onKeyDown=this.onKeyDown.bind(this);this.onKeyUp=this.onKeyUp.bind(this)}KeyboardController.prototype.start=function(){document.addEventListener("keydown",this.onKeyDown);document.addEventListener("keyup",this.onKeyUp)};KeyboardController.prototype.stop=function(){document.removeEventListener("keydown",this.onKeyDown);document.removeEventListener("keyup",this.onKeyUp)};KeyboardController.prototype.onKeyDown=function(ev){this.pressedKeys[ev.keyCode]=true};KeyboardController.prototype.onKeyUp=function(ev){this.pressedKeys[ev.keyCode]=false};KeyboardController.prototype.preStep=function(){};KeyboardController.prototype.step=function(){for(var keyCode in this.keyListeners){if(this.pressedKeys[keyCode])this.keyListeners[keyCode].forEach(function(callback){return callback()})}};KeyboardController.prototype.addListener=function(keyCode,callback){var listeners=this.keyListeners[keyCode];if(!listeners){listeners=[];this.keyListeners[keyCode]=listeners}listeners.push(callback)};return KeyboardController}();var Keys;(function(Keys){Keys[Keys["LEFT"]=37]="LEFT";Keys[Keys["UP"]=38]="UP";Keys[Keys["RIGHT"]=39]="RIGHT";Keys[Keys["DOWN"]=40]="DOWN";Keys[Keys["SPACE"]=32]="SPACE"})(Keys=exports.Keys||(exports.Keys={}))},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.bhaskara=function(a,b,c){var disc=b*b-4*a*c;if(disc<=0)return[undefined,undefined];var sqrtdisc=Math.sqrt(disc);var _2a=2*a;return[(-b+sqrtdisc)/_2a,(-b-sqrtdisc)/_2a]};var Segment=function(){function Segment(x1,y1,x2,y2){this.x=x1;this.y=y1;this.a=x2-x1;this.b=y2-y1}Segment.prototype.intersectionFactor=function(other){return(other.a*(this.y-other.y)-other.b*(this.x-other.x))/(other.b*this.a-this.b*other.a)};Segment.prototype.intersectionFactorOther=function(other,factor){if(other.a)return(this.x+this.a*factor-other.x)/other.a;else return(this.y+this.b*factor-other.y)/other.b};Segment.prototype.intersectsWith=function(other){var factor=this.intersectionFactor(other);if(factor<0||factor>1)return false;var otherFactor=this.intersectionFactorOther(other,factor);return otherFactor>=0&&otherFactor<=1};Segment.prototype.intersectsWithCircle=function(circle){var tx=this.x-circle.center[0];var ty=this.y-circle.center[1];var a=this.a*this.a+this.b*this.b;var b=2*(tx*this.a+ty*this.b);var c=tx*tx+ty*ty-circle.squaredRadius;var _a=exports.bhaskara(a,b,c),t1=_a[0],t2=_a[1];return 0<=t1&&t1<=1||0<=t2&&t2<=1};return Segment}();exports.Segment=Segment;var Polygon=function(){function Polygon(vertices){this.vertices=[];for(var i=0;i<vertices.length;i++){this.vertices.push([vertices[i][0],vertices[i][1],1])}}Polygon.prototype.intersectsWithSegment=function(segment){return this.anySegment(function(s){return s.intersectsWith(segment)})};Polygon.prototype.intersectsWithPolygon=function(other){return this.anySegment(function(s){return other.intersectsWithSegment(s)})};Polygon.prototype.intersectsWithCircle=function(circle){return this.anySegment(function(s){return circle.intersectsWithSegment(s)})};Polygon.prototype.anySegment=function(callback){for(var i=0;i<this.vertices.length;i++){var i1=(i+1)%this.vertices.length;var s=new Segment(this.vertices[i][0],this.vertices[i][1],this.vertices[i1][0],this.vertices[i1][1]);if(callback(s))return true}return false};return Polygon}();exports.Polygon=Polygon;exports.squaredDistance=function(p1,p2){var dx=p1[0]-p2[0];var dy=p1[1]-p2[1];return dx*dx+dy*dy};exports.direction=function(x1,y1,x2,y2){return Math.atan2(y1-y2,x2-x1)};var Circle=function(){function Circle(radius,center){this.radius=radius;this.squaredRadius=radius*radius;this.center=center}Circle.prototype.intersectsWithPolygon=function(polygon){return polygon.intersectsWithCircle(this)};Circle.prototype.intersectsWithCircle=function(circle){var radiusSum=this.radius+circle.radius;return exports.squaredDistance(this.center,circle.center)<=radiusSum*radiusSum};Circle.prototype.intersectsWithSegment=function(segment){return segment.intersectsWithCircle(this)};return Circle}();exports.Circle=Circle},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.SPS=120},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.minmax=function(min,max,value){return Math.max(min,Math.min(max,value))}},{}],5:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});var StarsManager_1=require("./StarsManager");var GlobalConstants_1=require("./GlobalConstants");var Ship_1=require("./Ship");var Vectorial_1=require("./Vectorial");var Geometry_1=require("./Geometry");var Game_1=require("./Game");var Helpers_1=require("./Helpers");var Resource_1=require("./Resource");var viewSize=[2e3,2e3];var viewPosition=[0,0];var roomSize=[4e5,4e5];var maxViewSize=2e3;var STARS=5e5;var MIN_Z=.1;var MAX_Z=.9;var gameInfo={getRoomSize:function(){return roomSize},getViewPosition:function(){return viewPosition},getViewSize:function(){return viewSize}};var border=[viewSize[0]/MIN_Z,viewSize[1]/MIN_Z];exports.nextP=function(position,coord,speed){position[coord]=(position[coord]+speed[coord]+roomSize[coord]-border[coord]-border[coord]/2)%(roomSize[coord]-border[coord])+border[coord]/2};var constrain=function(x,min,max){var delta=max-min;return(x-min-delta*Math.floor(x/delta))%delta+min};var constrainDeltaAngle=function(x){return constrain(x,-Math.PI,Math.PI)};var RenderableCircle=function(_super){__extends(RenderableCircle,_super);function RenderableCircle(center,radius,color){var _this=_super.call(this,radius,center)||this;_this.color=color;return _this}RenderableCircle.prototype.prepareContext=function(ctx){ctx.save();ctx.translate(this.center[0],this.center[1])};RenderableCircle.prototype.draw=function(ctx){ctx.save();ctx.scale(this.radius,this.radius);var fill=ctx.createRadialGradient(0,0,.3,0,0,1);fill.addColorStop(0,this.color);fill.addColorStop(1,"black");ctx.fillStyle=fill;ctx.strokeStyle=this.color;ctx.beginPath();ctx.arc(0,0,.99,0,6.3,true);ctx.fill();ctx.restore()};RenderableCircle.prototype.restoreContext=function(ctx){ctx.restore()};RenderableCircle.prototype.render=function(ctx){this.prepareContext(ctx);this.draw(ctx);this.restoreContext(ctx)};RenderableCircle.prototype.preStep=function(){};RenderableCircle.prototype.step=function(){};return RenderableCircle}(Geometry_1.Circle);var Planet=function(_super){__extends(Planet,_super);function Planet(){return _super!==null&&_super.apply(this,arguments)||this}return Planet}(RenderableCircle);var rand=function(min,max){return Math.random()*(max-min)+min};var randInt=function(min,max){return Math.floor(rand(min,max))};var randomPlanet=function(){var planet=new Planet([rand(border[0]+3e3,roomSize[0]-border[0]-3e3),rand(border[1]+3e3,roomSize[1]-border[1]-3e3)],randInt(200,1e3),"rgb("+randInt(128,256)+", "+randInt(128,256)+", "+randInt(128,256)+")");return planet};var createHomePlanet=function(){var homePlanet=randomPlanet();var angle=Math.random()*6.28;homePlanet.center=[roomSize[0]/2+(roomSize[0]/2-border[0]/2-3e3)*Math.cos(angle),roomSize[1]/2+(roomSize[1]/2-border[1]/2-3e3)*Math.sin(angle)];return homePlanet};var GameView=function(_super){__extends(GameView,_super);function GameView(onGameOver,canvas){var _this=_super.call(this,canvas)||this;_this.onGameOver=onGameOver;var stars=new StarsManager_1.default(MIN_Z,MAX_Z,3,STARS,gameInfo);var fuel=new Resource_1.default("FUEL",.02/GlobalConstants_1.SPS,20,20,.85,gameInfo);var food=new Resource_1.default("FOOD",.01/GlobalConstants_1.SPS,140,20,.85,gameInfo);var ship=new Ship_1.Ship(fuel,[roomSize[0]/2,roomSize[1]/2]);_this.addRenderObject({render:function(ctx){var px=_this.canvas.width/viewSize[0];var py=_this.canvas.height/viewSize[1];var p=Helpers_1.minmax(Math.max(px,py),1.5*Math.max(px,py),3/Math.pow(Vectorial_1.squaredLength(ship.speed),.3));var effectiveViewWidth=viewSize[0]*p;var effectiveViewHeight=viewSize[1]*p;ctx.save();ctx.translate((_this.canvas.width-effectiveViewWidth)/2,(_this.canvas.height-effectiveViewHeight)/2);ctx.scale(p,p);ctx.translate(-viewPosition[0],-viewPosition[1])}});_this.addRenderObject(stars);_this.addObject(ship);var planets=[];for(var i=0;i<20;i++){var planet=randomPlanet();_this.addObject(planet);planets.push(planet)}var homePlanet=createHomePlanet();planets.push(homePlanet);_this.addRenderObject(homePlanet);_this.addRenderObject({render:function(ctx){ctx.restore();var limitX=roomSize[0]/2-border[0]/2;var limitY=roomSize[1]/2-border[1]/2;ctx.save();ctx.lineWidth=5;planets.forEach(function(planet){var x=constrain(planet.center[0]-ship.position[0],-limitX,limitX);var y=constrain(planet.center[1]-ship.position[1],-limitY,limitY);var p=Math.min(Math.abs((canvas.width-100)/x),Math.abs((canvas.height-100)/y))/2;var distance=Math.pow(x*x+y*y,.25);var size=Helpers_1.minmax(1,50,1e3/distance);ctx.strokeStyle=planet===homePlanet?"red":"white";ctx.fillStyle=planet.color;ctx.beginPath();ctx.arc(canvas.width/2+x*p,canvas.height/2+y*p,size,0,2*Math.PI);ctx.stroke();ctx.fill()});ctx.restore()}});_this.addRenderObject(fuel);_this.addRenderObject(food);var breaking=false;_this.addKeyListener(Game_1.Keys.SPACE,function(){if(ship.landed||ship.dead){return}breaking=true;var desiredDirection=Geometry_1.direction(0,0,-ship.speed[0],-ship.speed[1]);var deltaDirection=constrainDeltaAngle(desiredDirection-ship.direction);if(deltaDirection!==0){var turn=0;var angularDirection=ship.angularSpeed>0?1:-1;if(deltaDirection>0!==ship.angularSpeed>0){turn=-angularDirection}else{var timeToStopRotation=angularDirection*ship.angularSpeed/Ship_1.Ship.STEER_ACCELERATION;var timesToZeroDelta=Geometry_1.bhaskara(-angularDirection*Ship_1.Ship.STEER_ACCELERATION/2,-ship.angularSpeed,deltaDirection).filter(function(t){return t>0}).sort().shift();if(timesToZeroDelta!==undefined&&timesToZeroDelta>timeToStopRotation){turn=angularDirection}else if(timesToZeroDelta<timeToStopRotation){turn=-angularDirection}}if(turn>0){ship.steerLeft()}else if(turn<0){ship.steerRight()}}if(Vectorial_1.squaredLength(ship.speed)>.01&&Math.abs(deltaDirection)<Math.PI/4){ship.accelerate(.5)}});_this.addKeyListener(Game_1.Keys.UP,function(){if(!breaking){ship.accelerate()}});_this.addKeyListener(Game_1.Keys.LEFT,function(){if(!breaking){ship.steerLeft()}});_this.addKeyListener(Game_1.Keys.RIGHT,function(){if(!breaking){ship.steerRight()}});_this.addStepObject({preStep:function(){breaking=false;exports.nextP(ship.position,0,ship.speed);exports.nextP(ship.position,1,ship.speed);if(ship.landed){fuel.generate();food.generate()}else{food.consume()}if(fuel.value<=0){_this.onGameOver("out_of_fuel")}if(food.value<=0){_this.onGameOver("out_of_food");ship.dead=true}if(!ship.dead&&!ship.landed){planets.forEach(function(planet){var squaredDistanceShipPlanet=Geometry_1.squaredDistance(ship.position,planet.center);if(squaredDistanceShipPlanet<9*planet.squaredRadius){var directionShipPlanet=Geometry_1.direction(ship.position[0],ship.position[1],planet.center[0],planet.center[1]);ship.speed[0]+=GlobalConstants_1.SPS*20*(planet.radius/500)*Math.cos(directionShipPlanet)/squaredDistanceShipPlanet;ship.speed[1]-=GlobalConstants_1.SPS*20*(planet.radius/500)*Math.sin(directionShipPlanet)/squaredDistanceShipPlanet}if(squaredDistanceShipPlanet>=planet.squaredRadius+200*200){return}if(ship.transformedPolygon.intersectsWithCircle(planet)){var speedLimit=100/GlobalConstants_1.SPS;var angleLimit=Math.PI/20;var speed=Vectorial_1.squaredLength(ship.speed);var landingAngle=Geometry_1.direction(planet.center[0],planet.center[1],ship.position[0],ship.position[1]);var deltaAngle=Math.abs(constrainDeltaAngle(ship.direction-landingAngle));if(speed<speedLimit&&deltaAngle<angleLimit){ship.direction=landingAngle;if(planet===homePlanet){ship.dead=true;_this.onGameOver("win")}else{ship.landed=true}}else{ship.dead=true;_this.onGameOver("crashed")}breaking=false;ship.speed=[0,0];ship.angularSpeed=0}})}},step:function(){stars.speed=ship.speed;viewPosition=[ship.position[0]-viewSize[0]/2,ship.position[1]-viewSize[1]/2]}});return _this}GameView.prototype.start=function(){_super.prototype.start.call(this,GlobalConstants_1.SPS)};return GameView}(Game_1.View);exports.GameView=GameView},{"./Game":1,"./Geometry":2,"./GlobalConstants":3,"./Helpers":4,"./Resource":8,"./Ship":9,"./StarsManager":10,"./Vectorial":11}],6:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});var StarsManager_1=require("./StarsManager");var Game_1=require("./Game");var viewSize=[2e3,2e3];var viewPosition=[0,0];var roomSize=[4e4,4e4];var STARS=1e3;var MIN_Z=.1;var MAX_Z=.9;var SPS=60;var gameInfo={getRoomSize:function(){return roomSize},getViewPosition:function(){return viewPosition},getViewSize:function(){return viewSize}};var border=[viewSize[0]/MIN_Z,viewSize[1]/MIN_Z];var nextP=function(position,coord,speed){position[coord]=(position[coord]+speed[coord]+roomSize[coord]-border[coord]-border[coord]/2)%(roomSize[coord]-border[coord])+border[coord]/2};var constrain=function(x,min,max){var delta=max-min;return(x-min-delta*Math.floor(x/delta))%delta+min};var Opening=function(_super){__extends(Opening,_super);function Opening(canvas){var _this=_super.call(this,canvas)||this;var stars=new StarsManager_1.default(MIN_Z,MAX_Z,3,STARS,gameInfo);_this.addRenderObject({render:function(ctx){var px=_this.canvas.width/viewSize[0];var py=_this.canvas.height/viewSize[1];var p=Math.max(px,py);var effectiveViewWidth=viewSize[0]*p;var effectiveViewHeight=viewSize[1]*p;ctx.save();ctx.translate((_this.canvas.width-effectiveViewWidth)/2,(_this.canvas.height-effectiveViewHeight)/2);ctx.scale(p,p);ctx.translate(-viewPosition[0],-viewPosition[1])}});_this.addRenderObject(stars);_this.addRenderObject({render:function(ctx){ctx.restore()}});var speed=[30/SPS,30/SPS];_this.addStepObject({preStep:function(){nextP(viewPosition,0,speed);nextP(viewPosition,1,speed)},step:function(){}});return _this}Opening.prototype.start=function(){_super.prototype.start.call(this,SPS)};return Opening}(Game_1.View);exports.Opening=Opening},{"./Game":1,"./StarsManager":10}],7:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});var Geometry_1=require("./Geometry");var Vectorial_1=require("./Vectorial");var RenderablePolygon=function(_super){__extends(RenderablePolygon,_super);function RenderablePolygon(position,vertices,color){var _this=_super.call(this,vertices)||this;_this.direction=0;_this.position=position;_this.color=color;_this.transformedPolygon=new Geometry_1.Polygon(Vectorial_1.Matrix.copy(_this.vertices));return _this}RenderablePolygon.prototype.prepareContext=function(ctx){ctx.save();ctx.translate(this.position[0],this.position[1]);ctx.rotate(-this.direction)};RenderablePolygon.prototype.draw=function(ctx){ctx.fillStyle=this.color;ctx.beginPath();ctx.moveTo(this.vertices[0][0],this.vertices[0][1]);for(var i=1;i<this.vertices.length;i++){ctx.lineTo(this.vertices[i][0],this.vertices[i][1])}ctx.fill()};RenderablePolygon.prototype.restoreContext=function(ctx){ctx.restore()};RenderablePolygon.prototype.render=function(ctx){this.prepareContext(ctx);this.draw(ctx);this.restoreContext(ctx)};RenderablePolygon.prototype.preStep=function(){var transform=Vectorial_1.Matrix.multiply(Vectorial_1.Matrix.rotate(this.direction),Vectorial_1.Matrix.translate(this.position[0],this.position[1]));Vectorial_1.Matrix.multiply(this.vertices,transform,this.transformedPolygon.vertices)};RenderablePolygon.prototype.step=function(){};return RenderablePolygon}(Geometry_1.Polygon);exports.default=RenderablePolygon},{"./Geometry":2,"./Vectorial":11}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Resource=function(){function Resource(name,consumptionRate,renderX,renderY,initialValue,gameInfo){this.name=name;this.consumptionRate=consumptionRate;this.renderX=renderX;this.renderY=renderY;this.gameInfo=gameInfo;this.value=initialValue}Resource.prototype.render=function(ctx){ctx.strokeStyle="#FFF";ctx.strokeRect(this.renderX,this.renderY,100,20);ctx.fillStyle="#0F0";ctx.fillRect(this.renderX+2,this.renderY+2,96*this.value,16);ctx.strokeText(this.name,this.renderX,55)};Resource.prototype.consume=function(factor){if(factor===void 0){factor=1}this.value=Math.max(0,this.value-factor*this.consumptionRate)};Resource.prototype.generate=function(){this.value=Math.min(1,this.value+20*this.consumptionRate)};return Resource}();exports.default=Resource},{}],9:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});var RenderablePolygon_1=require("./RenderablePolygon");var GlobalConstants_1=require("./GlobalConstants");var Ship=function(_super){__extends(Ship,_super);function Ship(fuel,position){var _this=_super.call(this,position,[[-30,7],[-35,26],[-34,32],[-16,35],[-10,30],[0,12],[-35,26],[26,8],[35,0],[26,-8],[-35,-26],[0,-12],[-10,-30],[-16,-35],[-34,-32],[-35,-26],[-30,-7]],"#C70")||this;_this.fuel=fuel;_this.speed=[0,0];_this.angularSpeed=0;_this.sprite=new Image;_this.sprite.src="./ship.svg";_this.fire=0;return _this}Ship.prototype.preStep=function(){this.fire=Math.max(0,this.fire-Ship.FireSpeed);if(this.dead){return}_super.prototype.preStep.call(this);this.direction+=this.angularSpeed};Ship.prototype.accelerate=function(factor){if(factor===void 0){factor=1}if(!this.dead&&this.fuel.value>0){this.fire=Math.min(factor,this.fire+2*Ship.FireSpeed);this.landed=false;this.speed[0]+=factor*5*Math.cos(this.direction)/GlobalConstants_1.SPS;this.speed[1]-=factor*5*Math.sin(this.direction)/GlobalConstants_1.SPS;this.fuel.consume(factor)}};Ship.prototype.steerLeft=function(){if(!this.landed&&!this.dead&&this.fuel.value>0){this.angularSpeed+=Ship.STEER_ACCELERATION;this.fuel.consume()}};Ship.prototype.steerRight=function(){if(!this.landed&&!this.dead&&this.fuel.value>0){this.angularSpeed-=Ship.STEER_ACCELERATION;this.fuel.consume()}};Ship.prototype.draw=function(ctx){_super.prototype.draw.call(this,ctx);ctx.save();ctx.translate(-this.sprite.width/2+5,0);ctx.scale(25*this.fire,8);var gradient=ctx.createRadialGradient(0,0,.4,0,0,1);gradient.addColorStop(0,"white");gradient.addColorStop(1,"rgba(64, 64, 255, 0)");ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(0,0,1,0,Math.PI*2);ctx.fill();ctx.restore();ctx.drawImage(this.sprite,-this.sprite.width/2,-this.sprite.height/2)};Ship.STEER_ACCELERATION=.05/GlobalConstants_1.SPS;Ship.FireSpeed=1/GlobalConstants_1.SPS;return Ship}(RenderablePolygon_1.default);exports.Ship=Ship},{"./GlobalConstants":3,"./RenderablePolygon":7}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var MapperStorage=function(){function MapperStorage(minValue,maxValue,length){this.minValue=minValue;this.maxValue=maxValue;this.length=length;this.storage=[];this.step=(maxValue-minValue)/length;for(var i=0;i<length;i++){this.storage.push(undefined)}}MapperStorage.prototype.get=function(value){var index=this.getIndex(value);return index!==null?this.storage[index]:null};MapperStorage.prototype.getIndex=function(value){var index=this.length*(value-this.minValue)/(this.maxValue-this.minValue)|0;return index};MapperStorage.prototype.getValue=function(index){return this.minValue+index*this.step};MapperStorage.prototype.setIndex=function(index,t){if(index!==null){this.storage[index]=t}};MapperStorage.prototype.forEachValue=function(callback){for(var i=0;i<this.length;i++){callback(this.getValue(i),i)}};MapperStorage.prototype.forEachItem=function(callback){var _this=this;this.storage.forEach(function(layer,index){return callback(layer,_this.getValue(index))})};return MapperStorage}();var StarsManager=function(){function StarsManager(MIN_Z,MAX_Z,Z_LAYERS,STARS,gameInfo){var _this=this;this.MIN_Z=MIN_Z;this.MAX_Z=MAX_Z;this.Z_LAYERS=Z_LAYERS;this.STARS=STARS;this.gameInfo=gameInfo;this.layers=new MapperStorage(this.MIN_Z,this.MAX_Z,this.Z_LAYERS);this.projector=new Projector(this.gameInfo);this.speed=[0,0];this.layers.forEachValue(function(minZ,layerIndex){var layer=new MapperStorage(0,_this.gameInfo.getRoomSize()[0],Math.round(_this.gameInfo.getRoomSize()[0]/(_this.gameInfo.getViewSize()[0]/minZ)));_this.layers.setIndex(layerIndex,layer);layer.forEachValue(function(minX,quadrantIndex){var quadrant=new MapperStorage(0,_this.gameInfo.getRoomSize()[1],Math.round(_this.gameInfo.getRoomSize()[1]/(_this.gameInfo.getViewSize()[1]/minZ)));layer.setIndex(quadrantIndex,quadrant);quadrant.forEachValue(function(minY,starsIndex){quadrant.setIndex(starsIndex,[])})})});for(var i=0;i<this.STARS;i++){var z=this.MIN_Z+Math.random()*(this.MAX_Z-this.MIN_Z);var layer=this.layers.get(z);var x=Math.random()*(this.gameInfo.getRoomSize()[0]-this.gameInfo.getViewSize()[0]/this.MIN_Z);var quadrant=layer.get(x);var y=Math.random()*(this.gameInfo.getRoomSize()[1]-this.gameInfo.getViewSize()[1]/this.MIN_Z);this.addStar(x,y,z)}}StarsManager.prototype.addStar=function(x,y,z){var layer=this.layers.get(z);var quadrant=layer.get(x);if(x<this.gameInfo.getViewSize()[0]/this.MIN_Z){var newX=this.gameInfo.getRoomSize()[0]-this.gameInfo.getViewSize()[0]/this.MIN_Z+x;layer.get(newX).get(y).push([newX,y,z])}if(y<this.gameInfo.getViewSize()[1]/this.MIN_Z){var newY=this.gameInfo.getRoomSize()[1]-this.gameInfo.getViewSize()[1]/this.MIN_Z+y;this.addStar(x,newY,z)}layer.get(x).get(y).push([x,y,z])};StarsManager.prototype.render=function(ctx){var _this=this;ctx.save();ctx.strokeStyle="#fff";ctx.lineCap="round";this.layers.forEachItem(function(layer,minZ){_this.iterateStorage(layer,0,minZ,function(quadrant,i){_this.iterateStorage(quadrant,1,minZ,function(stars,j){stars.forEach(function(star){var z=star[2];var x=_this.projector.from(0,star[0],z);var y=_this.projector.from(1,star[1],z);ctx.lineWidth=10*z;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x-_this.speed[0]*z,y-_this.speed[1]*z);ctx.stroke()})})})});ctx.restore()};StarsManager.prototype.iterateStorage=function(storage,coord,z,callback){var minI=this.normalizeIndex(storage,storage.getIndex(this.projector.to(coord,this.gameInfo.getViewPosition()[coord],z)));var maxI=this.normalizeIndex(storage,storage.getIndex(this.projector.to(coord,this.gameInfo.getViewPosition()[coord]+this.gameInfo.getViewSize()[coord],z)));for(var i=minI;i<=maxI;i++){callback(storage.storage[i],i)}};StarsManager.prototype.normalizeIndex=function(storage,index){return Math.min(storage.storage.length-1,Math.max(0,index))};return StarsManager}();exports.default=StarsManager;var Projector=function(){function Projector(gameInfoProvider){this.gameInfoProvider=gameInfoProvider}Projector.prototype.from=function(i,x,z){return this.gameInfoProvider.getViewPosition()[i]+this.gameInfoProvider.getViewSize()[i]/2+(x-this.gameInfoProvider.getViewPosition()[i]-this.gameInfoProvider.getViewSize()[i]/2)*z};Projector.prototype.to=function(i,x,z){return this.from(i,x,1/z)};return Projector}();exports.Projector=Projector},{}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.squaredLength=function(vector){return vector[0]*vector[0]+vector[1]*vector[1]};var Matrix=function(){function Matrix(lines,columns){this.length=lines;for(var i=0;i<lines;i++){this[i]=new Array(columns||lines)}}Matrix.copy=function(m){var copy=new Matrix(m.length,m[0].length);copy.length=m.length;for(var i=0;i<m.length;i++){copy[i]=new Array(m[i].length);for(var j=0;j<m[i].length;j++){copy[i][j]=m[i][j]}}return copy};Matrix.multiply=function(a,b,result,n,m,p){n=n||a.length;m=m||b.length;p=p||b[0].length;result=result||new Matrix(n,p);for(var i=0;i<n;i++){for(var j=0;j<p;j++){result[i][j]=0;for(var k=0;k<m;k++){result[i][j]+=a[i][k]*b[k][j]}}}return result};Matrix.translate=function(x,y){return[[1,0,0],[0,1,0],[x,y,1]]};Matrix.rotate=function(delta){var sin=Math.sin(delta);var cos=Math.cos(delta);return[[cos,-sin,0],[sin,cos,0],[0,0,1]]};Matrix.identity=function(n){var m=new Matrix(n);for(var i=0;i<n;i++){for(var j=0;j<n;j++){m[i][j]=0}m[i][i]=1}return m};return Matrix}();exports.Matrix=Matrix},{}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Lost_1=require("./Lost");var Opening_1=require("./Opening");var $=function(query){return document.querySelector(query)};var $$=function(query){return document.querySelectorAll(query)};var doTransition=function(callback1,callback2){if(callback1===void 0){callback1=null}if(callback2===void 0){callback2=null}$("#transition").classList.remove("off");window.requestAnimationFrame(function(){$("#transition").classList.add("visible");setTimeout(function(){$("#transition").classList.remove("visible");if(callback1)callback1();setTimeout(function(){$("#transition").classList.add("off");if(callback2)setTimeout(callback2)},1e3)},1e3)})};var opening;var game;var newGame=function(canvas){game=new Lost_1.GameView(function(result){doTransition(function(){$("#gameover").classList.add("active");for(var i=0;i<$("#gameresult").children.length;i++){$("#gameresult").children[i].classList.add("invisible")}$("#gameover_"+result).classList.remove("invisible");game.stop();game=null;opening.start()})},canvas);return game};window.onload=function(){if(!window.requestAnimationFrame){window.requestAnimationFrame=["webkit","moz","o","ms"].reduce(function(existing,vendor){return existing||window[vendor+"RequestAnimationFrame"]},null)||function(callback){window.setTimeout(callback,1e3/60)}}var canvas=$("canvas");opening=new Opening_1.Opening(canvas);opening.start();$("#btnStart").addEventListener("click",function(){doTransition(function(){opening.stop();$("#initial").classList.remove("active");game=newGame(canvas);game.start()})});$("#btnHelp").addEventListener("click",function(){doTransition(function(){$("#initial").classList.remove("active");$("#help").classList.add("active")})});$("#btnBack").addEventListener("click",function(){doTransition(function(){$("#help").classList.remove("active");$("#initial").classList.add("active")})});$("#btnGameOverBack").addEventListener("click",function(){doTransition(function(){$("#gameover").classList.remove("active");$("#initial").classList.add("active")})})}},{"./Lost":5,"./Opening":6}]},{},[12]);
