<html>
<head>
<title>L0ST</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script src="lost.js"></script>
<style type="text/css">
	body {
		margin:0;
	}
	#GUI {
		position:absolute;
		top:0;
		left:0;
	}
	#textInfo {
		width:300px;
		height:200px;
		border:5px outset #456;
		top:50%;
		left:50%;
		margin:-100px auto auto -150px;
		position:absolute;
		background-color:rgba(12,22,36,0.8);
	}
</style>
<script id="shader-fs" type="x-shader/x-fragment">
precision mediump float;varying vec2 vTextureCoord;varying float vLightWeighting;varying vec3 worldPosition;varying float crepit;varying float crepit2;uniform sampler2D uSampler;uniform vec4 lights[48];uniform int nbLights;uniform vec3 ambientColor;void main(void) {vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));vec3 totalLight = vec3(0.0,0.0,0.0) + ambientColor;for (int i=0; i<48; i++) {if (i==nbLights) {break;}vec3 light;float d = distance(worldPosition, lights[i].xyz);if (lights[i].a<=1.0) {light = vec3(0.88,0.59,0.12);light *= crepit;} else {light = vec3(0.2,0.2,1.+2.*crepit2);}light *= max(0.0,0.5-(0.2*(d)));totalLight += light;}gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a) + vec4(totalLight,textureColor.a);}
</script>
<script id="lava-fs" type="x-shader/x-fragment">
precision mediump float;precision highp int;varying vec2 vTextureCoord;varying float vLightWeighting;uniform sampler2D uSampler;uniform float iTime;uniform vec2 resolution;varying vec3 worldPosition;varying vec3 vPosition;uniform vec4 lights[48];uniform int nbLights;uniform vec3 ambientColor;varying float crepit;varying float crepit2;float rand(vec2 co){return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);}float hermite(float t) {return t * t * (3.0-2.0*t);}float dot3(vec3 a, vec3 b) {return a.x * b.x + a.y * b.y + a.z * b.z;}float rand(vec3 co) {return fract(sin(dot3(co.xyz ,vec3(12.9898,78.233, 33.87637))) * 43758.5453);}float noise(vec3 co, float freq) {vec3 v = co * vec3(freq, freq, freq); float ix1 = floor(v.x);float iy1 = floor(v.y);float iz1 = floor(v.z);float ix2 = floor(v.x + 1.0);float iy2 = floor(v.y + 1.0);float iz2 = floor(v.z + 1.0);float fx = hermite(fract(v.x));float fy = hermite(fract(v.y));float fz = hermite(fract(v.z));float mix1 = mix(mix(rand(vec3(ix1, iy1, iz1)), rand(vec3(ix2, iy1, iz1)), fx), mix(rand(vec3(ix1, iy2, iz1)), rand(vec3(ix2, iy2, iz1)), fx), fy);float mix2 = mix(mix(rand(vec3(ix1, iy1, iz2)), rand(vec3(ix2, iy1, iz2)), fx), mix(rand(vec3(ix1, iy2, iz2)), rand(vec3(ix2, iy2, iz2)), fx), fy);return mix(mix1, mix2, fz);}float pnoise(vec3 co, float freq, int steps, float persistence) {float value = 0.0;float ampl = 8.0;float sum = 0.0;const int maxStep = 5;for(int i=0 ; i<maxStep ; i++) {sum += ampl;value += noise(co, freq) * ampl;freq *= 2.0;ampl *= persistence;}return value / sum;}void main( void ) {vec2 position = gl_FragCoord.xy / resolution.xy;vec3 test;test.x = vPosition.x + (iTime/1000.0);test.y = vPosition.y + (iTime/1000.0);test.z = vPosition.z + (iTime/1000.0);float value = pnoise(test, 10.0, 5, 0.9);vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)) * 0.5;vec3 totalLight = vec3(0.0,0.0,0.0) + ambientColor;for (int i=0; i<48; i++) {if (i==nbLights) {break;}vec3 light;float d = distance(worldPosition, lights[i].xyz);if (lights[i].a<=1.0) {light = vec3(0.88,0.59,0.12);light *= crepit;} else {light = vec3(0.2,0.2,1.+2.*crepit2);}light *= max(0.0,0.5-(0.2*(d)));totalLight += light;}gl_FragColor = vec4(textureColor.rgb * vLightWeighting * 0.5,1.0) + vec4(mix(mix(vec3(1.0, 1.0, 0.0), vec3(1.0, 0.2, 0.0), (value + 1.0)),vec3(0.1, 0.0, 0.0) * vLightWeighting, value * 0.5 + 0.5) * vLightWeighting,1.0) + vec4(totalLight,1.0);}
</script>
<script id="torch-fs" type="x-shader/x-fragment">
precision mediump float;precision highp int;uniform float iTime;varying vec2 vTextureCoord;varying float vLightWeighting;vec2 hash(vec2 p) {p = vec2( dot(p,vec2(127.1,311.7)), dot(p,vec2(269.5,183.3)) );return -1.0 + 2.0*fract(sin(p)*43758.5453123);}float noise(in vec2 p) {const float K1 = 0.366025404;const float K2 = 0.211324865;vec2 i = floor( p + (p.x+p.y)*K1 );vec2 a = p - i + (i.x+i.y)*K2;vec2 o = (a.x>a.y) ? vec2(1.0,0.0) : vec2(0.0,1.0);vec2 b = a - o + K2;vec2 c = a - 1.0 + 2.0*K2;vec3 h = max( 0.5-vec3(dot(a,a), dot(b,b), dot(c,c) ), 0.0 );vec3 n = h*h*h*h*vec3( dot(a,hash(i+0.0)), dot(b,hash(i+o)), dot(c,hash(i+1.0)));return dot( n, vec3(70.0) );}float fbm(vec2 uv) {float f;mat2 m = mat2( 1.6,  1.2, -1.2,  1.6 );f  = 0.5000*noise( uv ); uv = m*uv;f += 0.2500*noise( uv ); uv = m*uv;f += 0.1250*noise( uv ); uv = m*uv;f += 0.0625*noise( uv ); uv = m*uv;f = 0.5 + 0.5*f;return f;}void main( void ) {vec2 q = vec2(0.5-vTextureCoord.x, vTextureCoord.y);vec2 uv = vec2(0.0,0.0);q.y *= 2.;float strength = 3.;float T3 = max(2.,1.25*strength)*(iTime/50.0);q.x = mod(q.x,1.)-0.5;q.y -= 0.25;float n = fbm(strength*q - vec2(0,T3));float c = 1. - 16. * pow( max( 0., length(q*vec2(1.8+q.y*1.5,.75) ) - n * max( 0., q.y+.25 ) ),1.2 );float c1 = n * c * (1.5-pow(1.0*uv.y,4.));c1=clamp(c1,0.,1.);vec3 col = vec3(1.5*c1, 1.5*c1*c1*c1, c1*c1*c1*c1*c1*c1);float a = c * (1.-pow(uv.y,3.));gl_FragColor =  vec4(col, a);}
</script>
<script id="portal-fs" type="x-shader/x-fragment">
precision mediump float;precision highp int;uniform float iTime;uniform vec4 lights[48];uniform vec2 resolution;uniform sampler2D uSampler;uniform vec3 ambientColor;varying vec3 vPosition;varying vec2 vTextureCoord;varying float vLightWeighting;mat2 makem2(in float theta){float c = cos(theta);float s = sin(theta);return mat2(c,-s,s,c);}float noise( in vec2 tcoord ){return texture2D(uSampler, tcoord*0.01).x / 2.0;}float fbm(in vec2 p) {vec4 tt=fract(vec4(iTime/512.0*2.)+vec4(0.0,0.25,0.5,0.75));vec2 p1=p-normalize(p)*tt.x;vec2 p2=vec2(1.0)+p-normalize(p)*tt.y;vec2 p3=vec2(2.0)+p-normalize(p)*tt.z;vec2 p4=vec2(3.0)+p-normalize(p)*tt.w;vec4 tr=vec4(1.0)-abs(tt-vec4(0.5))*2.0;float z=2.;vec4 rz = vec4(0.);for (float i= 1.;i < 4.;i++) {rz+= abs((vec4(noise(p1),noise(p2),noise(p3),noise(p4))-vec4(0.5))*2.)/z;z = z*2.;p1 = p1*2.;p2 = p2*2.;p3 = p3*2.;p4 = p4*2.;}return dot(rz,tr)*0.18;}float dualfbm(in vec2 p) {vec2 p2 = p*.7;vec2 basis = vec2(fbm(p2-iTime/255.0*1.6),fbm(p2+iTime/255.0*1.7));basis = (basis-.5)*.2;p += basis;return fbm(p); }float circ(vec2 p) {float r = length(p);r = log(sqrt(r));return abs(mod(r*2.,6.28318)-4.54)*1.+0.855;}void main( void ) {vec2 p = -1.0 * vTextureCoord.xy - 1.0;p.x*=2.0;p.y*=2.0;float rz = dualfbm(p);rz *= abs((-circ(vec2(p.x / 4.0, p.y / 4.0))));rz *= abs((-circ(vec2(p.x / 4.0, p.y / 4.0))));rz *= abs((-circ(vec2(p.x / 4.0, p.y / 4.0))));vec3 col = vec3(.1,0.1,0.4)/rz;col=pow(abs(col),vec3(.99));float i = 1.0 +ambientColor.x;gl_FragColor = vec4(col,(1.0-rz)*i);}
</script>
<script id="shader-vs" type="x-shader/x-vertex">
attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;uniform float fTime;uniform bool isLava;uniform vec3 cameraPosition;varying vec2 vTextureCoord;varying float vLightWeighting;varying vec3 vPosition;varying vec3 worldPosition;varying float crepit;varying float crepit2;varying vec2 frag_uv;void main(void) {if (isLava) {vPosition = normalize(aVertexPosition);vec3 newPosition = aVertexPosition;gl_Position = uMVMatrix * vec4(newPosition, 1.0);newPosition.z+=sin(gl_Position.x + gl_Position.y + fTime/40.0)*0.05;gl_Position = uPMatrix * uMVMatrix * vec4(newPosition, 1.0);} else {gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);vPosition = normalize(aVertexPosition);}vTextureCoord = aTextureCoord;vLightWeighting = 1.0-gl_Position.z/10.0;crepit = 1.0 + max(0.0, sin(fTime)/16.0);crepit2 = abs(sin(fTime/50.0));worldPosition = cameraPosition.xyz + aVertexPosition;}
</script>
</head>
<body onload="webGLStart();" onresize="resize()">
	<canvas id="textureCanvas" style="display:none"></canvas>
	<canvas id="game"></canvas>
	<div id="textInfo"></div>
	<canvas id="GUI"></canvas>
</body>
<script>
function SfxrP(){this.set=function(e){for(var t=0;24>t;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);var a=this.b+this.c+this.e;if(.18>a){var r=.18/a;this.b*=r,this.c*=r,this.e*=r}}}function sy(){this._p=new SfxrP;var e,t,a,r,o,i,l,n,s,c,d,g;this.reset=function(){var e=this._p;r=100/(e.f*e.f+.001),o=100/(e.g*e.g+.001),i=1-e.h*e.h*e.h*.01,l=-e.i*e.i*e.i*1e-6,e.a||(d=.5-e.n/2,g=5e-5*-e.o),n=1+e.l*e.l*(e.l>0?-.9:10),s=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();var r=this._p;return e=r.b*r.b*1e5,t=r.c*r.c*1e5,a=r.e*r.e*1e5+12,3*((e+t+a)/3|0)},this.sW=function(f,m){var v=this._p,u=1!=v.s||v.v,y=v.v*v.v*.1,x=1+3e-4*v.w,h=v.s*v.s*v.s*.1,p=1+1e-4*v.t,T=1!=v.s,E=v.x*v.x,b=v.g,A=v.q||v.r,M=v.r*v.r*v.r*.2,R=v.q*v.q*(v.q<0?-1020:1020),w=v.p?((1-v.p)*(1-v.p)*2e4|0)+32:0,I=v.d,U=v.j/2,S=v.k*v.k*.01,G=v.a,z=e,B=1/e,D=1/t,P=1/a,_=5/(1+v.u*v.u*20)*(.01+h);_>.8&&(_=.8),_=1-_;for(var F,L,k,C,W,O,N=!1,V=0,H=0,X=0,Y=0,j=0,Z=0,q=0,K=0,J=0,Q=0,$=new Array(1024),et=new Array(32),tt=$.length;tt--;)$[tt]=0;for(var tt=et.length;tt--;)et[tt]=2*Math.random()-1;for(var tt=0;m>tt;tt++){if(N)return tt;if(w&&++J>=w&&(J=0,this.reset()),c&&++s>=c&&(c=0,r*=n),i+=l,r*=i,r>o&&(r=o,b>0&&(N=!0)),L=r,U>0&&(Q+=S,L*=1+Math.sin(Q)*U),L|=0,8>L&&(L=8),G||(d+=g,0>d?d=0:d>.5&&(d=.5)),++H>z)switch(H=0,++V){case 1:z=t;break;case 2:z=a}switch(V){case 0:X=H*B;break;case 1:X=1+2*(1-H*D)*I;break;case 2:X=1-H*P;break;case 3:X=0,N=!0}A&&(R+=M,k=0|R,0>k?k=-k:k>1023&&(k=1023)),u&&x&&(y*=x,1e-5>y?y=1e-5:y>.1&&(y=.1)),O=0;for(var at=8;at--;){if(q++,q>=L&&(q%=L,3==G))for(var rt=et.length;rt--;)et[rt]=2*Math.random()-1;switch(G){case 0:W=d>q/L?.5:-.5;break;case 1:W=1-q/L*2;break;case 2:C=q/L,C=6.28318531*(C>.5?C-1:C),W=1.27323954*C+.405284735*C*C*(0>C?1:-1),W=.225*((0>W?-1:1)*W*W-W)+W;break;case 3:W=et[Math.abs(32*q/L|0)]}u&&(F=Z,h*=p,0>h?h=0:h>.1&&(h=.1),T?(j+=(W-Z)*h,j*=_):(Z=W,j=0),Z+=j,Y+=Z-F,Y*=1-y,W=Y),A&&($[K%1024]=W,W+=$[(K-k+1024)%1024],K++),O+=W}O*=.125*X*E,f[tt]=O>=1?1:-1>=O?-1:O}return m}}function getShader(e,t){var a=document.getElementById(t);if(!a)return null;for(var r="",o=a.firstChild;o;)3==o.nodeType&&(r+=o.textContent),o=o.nextSibling;var i;return"x-shader/x-fragment"==a.type?i=e.createShader(e.FRAGMENT_SHADER):"x-shader/x-vertex"==a.type&&(i=e.createShader(e.VERTEX_SHADER)),e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(alert(a.type+e.getShaderInfoLog(i)),null)}function initShaders(){for(var e=getShader(gl,"shader-vs"),t=getShader(gl,"shader-fs"),a=getShader(gl,"lava-fs"),r=getShader(gl,"torch-fs"),o=getShader(gl,"portal-fs"),i=[["shaderProgram",t],["shaderProgramLava",a],["shaderProgramTorch",r],["shaderProgramPortal",o]],l=0;l<i.length;l++){var n=i[l];s=gl.createProgram(),gl.attachShader(s,e),gl.attachShader(s,n[1]),gl.linkProgram(s),gl.getProgramParameter(s,gl.LINK_STATUS)||alert("Could not initialise shaders"),gl.useProgram(s),s.vertexPositionAttribute=gl.getAttribLocation(s,"aVertexPosition"),gl.enableVertexAttribArray(s.vertexPositionAttribute),s.textureCoordAttribute=gl.getAttribLocation(s,"aTextureCoord"),gl.enableVertexAttribArray(s.textureCoordAttribute),s.iTime=gl.getUniformLocation(s,"iTime"),s.resolution=gl.getUniformLocation(s,"resolution"),s.fTime=gl.getUniformLocation(s,"fTime"),s.pMatrixUniform=gl.getUniformLocation(s,"uPMatrix"),s.mvMatrixUniform=gl.getUniformLocation(s,"uMVMatrix"),s.samplerUniform=gl.getUniformLocation(s,"uSampler"),s.isLava=gl.getUniformLocation(s,"isLava"),s.cameraPosition=gl.getUniformLocation(s,"cameraPosition"),s.lights=gl.getUniformLocation(s,"lights"),s.nbLights=gl.getUniformLocation(s,"nbLights"),s.ambientColor=gl.getUniformLocation(s,"ambientColor"),window[n[0]]=s}initBuffers()}function handleLoadedTexture(e){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,e),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D)}function handleLoadedTextureFromCanvas(e,t){texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),window[e]=texture}function initTexture(){sol=gl.createTexture(),sol.image=new Image,sol.image.onload=function(){handleLoadedTexture(sol)},sol.image.src="boue.png"}function setMatrixUniforms(e){gl.uniformMatrix4fv(e.pMatrixUniform,!1,pMatrix),gl.uniformMatrix4fv(e.mvMatrixUniform,!1,mvMatrix)}function degToRad(e){return e*Math.PI/180}function initBuffers(){for(var e=0;16>e;e++){UVW[e]=new Float32Array(getUVW(e/2));for(var t=8;t<UVW[e].length;t++)UVW[e][t]*=2}UVW.key=new Float32Array(getUVW(.2)),UVW.key[2]=1,UVW.key[4]=1,UVW.key[5]=1,UVW.key[7]=1,cubeVertexIndexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer);var a=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),gl.STATIC_DRAW),cubeVertexIndexBuffer.itemSize=1,cubeVertexIndexBuffer.numItems=36}function drawTorch(e,t,a,r,o){var i=shaderProgramTorch;gl.useProgram(i),gl.uniform3f(i.cameraPosition,e,t,a),e+=camera.x,t+=camera.y,a+=-1.2-camera.z,mat4.identity(mvMatrix),mat4.rotate(mvMatrix,degToRad(camera.rotation.z),[1,0,0]),mat4.rotate(mvMatrix,degToRad(camera.rotation.x),[1,0,0]),mat4.rotate(mvMatrix,degToRad(camera.rotation.y),[0,1,0]),mat4.rotate(mvMatrix,degToRad(-90),[1,0,0]),mat4.translate(mvMatrix,[e,t,a]),mat4.rotate(mvMatrix,Math.PI-Math.atan(e/t),[0,0,1]),buffer=getCoord("torch"),gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.vertexAttribPointer(i.vertexPositionAttribute,buffer.itemSize,gl.FLOAT,!1,0,0),buffer=getUVWBuffer("torch",new Float32Array([-.5,1.5,-.5,0,.5,0,.5,1.5])),gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.vertexAttribPointer(i.textureCoordAttribute,buffer.itemSize,gl.FLOAT,!1,0,0),gl.uniform1i(i.isLava,!0),gl.uniform1f(i.iTime,frame+o),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer),setMatrixUniforms(i),gl.bindTexture(gl.TEXTURE_2D,mur),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}function drawCube(e,t,a,r,o,i,l){var n=getCube(r);if("portal2"==o)var s=shaderProgramPortal;else if("portal"==o)var s=shaderProgramPortal;else if(1===r)var s=shaderProgramLava;else var s=shaderProgram;gl.useProgram(s),gl.uniform3f(s.cameraPosition,e,t,a),lightsDisplayed.length&&gl.uniform4fv(s.lights,lightsDisplayed),gl.uniform1i(s.nbLights,lightsDisplayed.length/4),a+=i?i.z:0,e+=l?l:0;var c=r;if("door"===o)t--,cubeIndex="door",c=1;else if("key"===o){for(var d=0;d<n.length;d+=3)n[d]/=6,n[d+2]/=20,n[d+1]/=6;cubeIndex="key",c="key"}else if(cubeIndex=r,c=r,"a"===o){cubeIndex="a";for(var d=0;d<n.length;d+=3)n[d]/=3,n[d+2]/=20,n[d+1]/=6}if(buffer=getUVWBuffer(c,UVW[c]),gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.vertexAttribPointer(s.textureCoordAttribute,buffer.itemSize,gl.FLOAT,!1,0,0),e+=camera.x,t+=camera.y,a+=-1.2-camera.z,mat4.identity(mvMatrix),mat4.rotate(mvMatrix,degToRad(camera.rotation.z),[1,0,0]),mat4.rotate(mvMatrix,degToRad(camera.rotation.x),[1,0,0]),mat4.rotate(mvMatrix,degToRad(camera.rotation.y),[0,1,0]),mat4.rotate(mvMatrix,degToRad(-90),[1,0,0]),mat4.translate(mvMatrix,[e,t,a]),!GAME.player.isBorn)return void gl.uniform3f(s.ambientColor,-2,-2,-2);if(GAME.ending){var g=0-1/440*GAME.ending;camera.rotation.z=camera.rotation.z+(90-camera.rotation.z)/3e3,camera.rotation.y=camera.rotation.y+(74.6-camera.rotation.y)/3e3,gl.uniform3f(s.ambientColor,g,g,g)}else if(GAME.player.isDied){var g=-2/600*GAME.player.isDied;-1.5>=g&&showText("YOU ARE DIED..."),gl.uniform3f(s.ambientColor,g+.5,g-.2,g-.2)}else gl.uniform3f(s.ambientColor,0,0,0);"key"===o?mat4.rotate(mvMatrix,degToRad(2*frame),[0,0,1]):"door"==o&&(mat4.translate(mvMatrix,[0,1,0]),mat4.translate(mvMatrix,[0,-1,0])),buffer=getCoord(cubeIndex,n),gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.vertexAttribPointer(s.vertexPositionAttribute,buffer.itemSize,gl.FLOAT,!1,0,0),gl.uniform2f(s.resolution,1920,1e3),gl.uniform1i(s.samplerUniform,0),1==r&&(gl.uniform1i(s.isLava,!0),gl.uniform1f(s.iTime,frame)),gl.uniform1f(s.fTime,frame),gl.uniform1f(s.iTime,frame),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer),setMatrixUniforms(s),gl.activeTexture(gl.TEXTURE0),"key"==o?(gl.bindTexture(gl.TEXTURE_2D,textureKey),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0),gl.bindTexture(gl.TEXTURE_2D,mur),gl.drawElements(gl.TRIANGLES,30,gl.UNSIGNED_SHORT,12)):"door"==o?(gl.bindTexture(gl.TEXTURE_2D,textureDoor),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,24)):"portal"==o?(gl.bindTexture(gl.TEXTURE_2D,portal),d=24,gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,60)):"portal2"==o?(gl.bindTexture(gl.TEXTURE_2D,portal),d=24,gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,12)):(gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,sol),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0),1!=r&&(gl.bindTexture(gl.TEXTURE_2D,mur),gl.drawElements(gl.TRIANGLES,30,gl.UNSIGNED_SHORT,12)))}function drawScene(){if(!GAME.ended){if(GAME.player.isDied&&(GAME.player.isDied++,fov=Math.min(170,fov+(170-fov)/100),camera.rotation.z+=(-90-camera.rotation.z)/60),gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),!GAME.player.isBorn)return!1;mat4.perspective(fov,gl.viewportWidth/gl.viewportHeight,.001,100,pMatrix),mat4.identity(mvMatrix);for(var e=0;levelWidth>e;e++)for(var t=0;levelHeight>t;t++){var a=level[e][t].h;if(a){var r=Math.abs(GAME.player.tile.x-e);r+=Math.abs(GAME.player.tile.y-t),10>r&&(25==e&&20==t||24==e&&16==t||24==e&&14==t?(drawCube(2*e,2*-t,0,a,"",{z:.25+.5*Math.sin(e+frame/20)}),level[e][t].z=.25+.5*Math.sin(e+frame/20)):27==e&&15==t?(drawCube(2*e,2*-t,0,a,"",{z:-.25+1*Math.cos(e+frame/20)}),level[e][t].z=-.25+1*Math.cos(e+frame/20)):27==e&&15==t||28==e&&15==t?(drawCube(2*e,2*-t,0,a,"",{z:-.5+1.5*Math.cos(e+frame/20)}),level[e][t].z=-.5+1.5*Math.cos(e+frame/20)):drawCube(2*e,2*-t,0,a),level[e][t].c&&drawCube(2*e,2*-t,level[e][t].c,5))}}var r=Math.abs(GAME.player.tile.x-32);if(r+=Math.abs(GAME.player.tile.y-15),10>r&&drawCube(64,-30,7,2,"portal",!1,-.5),GAME.ending){for(var o=50;o>=0;o--)drawCube(64,2*-GAME.player.tile.y,5,2,"portal2",{z:10*-o},-64-camera.x);camera.z<-500&&(GAME.textInfo="TO BE CONTINUED...",GAME.ended=!0,playSound([3,,.3639,.16,1.3,.0833,,-.26,-.42,,,.7958,.8154,,,.6421,.1981,-.2936,1,,,,,.5]),setTimeout("GAME.textInfo += 'NEXT YEAR ?'",5e3)),GAME.ending++}var i=0;for(lightsDisplayed=[],o=0;o<lights.length;o+=4){var r=Math.abs(GAME.player.tile.x-lights[o]/2);r+=Math.abs(GAME.player.tile.y- -lights[o+1]/2),i+=2210,10>r&&(lightsDisplayed.push(lights[o]),lightsDisplayed.push(lights[o+1]),lightsDisplayed.push(lights[o+2]),lightsDisplayed.push(lights[o+3]),lights[o+3]<1&&(drawCube(lights[o],lights[o+1],lights[o+2],2,"a"),drawTorch(lights[o],lights[o+1],lights[o+2],2,i)))}for(var o=0;o<doors.length;o++){var l=doors[o];"opening"==l.status&&(l.decal.z+=.01,l.decal.z>2&&(l.status="opened",index=l.x+levelWidth*l.y,levelObj=levelObj.substr(0,index)+" "+levelObj.substr(index+1),clearInterval(doorTimer),playSound([0,,.0317,,.17,.2723,,-.3311,,,,,,.1324,,,,,1,,,,,.5]))),"closing"==l.status&&(l.decal.z-=.01,levelObj=levelObj.substr(0,index)+"D"+levelObj.substr(index+1),l.decal.z<=0&&(l.status="closed",index=l.x+levelWidth*l.y,clearInterval(doorTimer),playSound([0,,.0317,,.17,.2723,,-.3311,,,,,,.1324,,,,,1,,,,,.5]))),drawCube(2*l.x,2*-l.y,l.z,2,"door",{z:l.decal.z})}for(o=0;o<keys.length;o++)keys[o].visible&&drawCube(2*keys[o].x,2*-keys[o].y,keys[o].z,3,"key")}}function drawGUI(){ctx.clearRect(0,0,window.innerWidth,window.innerHeight),GAME.player.isBorn&&!GAME.ending&&(updatePreviewBackground(),ctx.beginPath(),ctx.arc(canvasGUI.width-128,canvasGUI.height-128,100,0,2*Math.PI,!1),ctx.lineWidth=10,ctx.strokeStyle="#FFF",ctx.fillStyle="rgba(0,0,0,0.3)",ctx.fill(),ctx.stroke()),GAME.textInfo?(drawText(window.innerWidth/2-130,window.innerHeight/2-80,GAME.textInfo),GAME.ended||drawText(window.innerWidth/2-60,window.innerHeight/2+70,"- CLICK TO HIDE - ")):GAME.ending||(ctx.beginPath(),ctx.arc(window.innerWidth/2,window.innerHeight/2,10,0,2*Math.PI,!1),ctx.lineWidth=1,ctx.strokeStyle="#FFF",ctx.stroke(),ctx.beginPath(),ctx.arc(window.innerWidth/2,window.innerHeight/2,2,0,2*Math.PI,!1),ctx.lineWidth=1,ctx.strokeStyle="#FFF",ctx.stroke())}function updatePreviewBackground(){for(previewID=ctx.createImageData(256,256),col=[],col[0]={r:0,g:0,b:255},col[1]={r:86,g:68,b:47},col[2]={r:81,g:106,b:102},col[3]={r:148,g:76,b:62},col[4]={r:158,g:146,b:94},col[5]={r:138,g:126,b:144},col[6]={r:128,g:12,b:32},col[7]={r:148,g:32,b:62},col[8]={r:184,g:17,b:154},col[9]={r:184,g:17,b:154},x=0;levelWidth>x;x++)for(y=0;levelHeight>y;y++)if(level[x][y].v){var e=levelTmp[x+y*levelWidth];" "!=e&&(c=col[e],setPixel(previewID,x,y,c.r,c.g,c.b))}ctx.putImageData(previewID,canvasGUI.width-192,canvasGUI.height-192),ctx.beginPath(),ctx.arc(2*-camera.x+canvasGUI.width-192,2*camera.y+canvasGUI.height-192,10+4*Math.sin(frame/16),0,2*Math.PI,!1),ctx.lineWidth=1,ctx.strokeStyle="#FFF",ctx.stroke()}function setPixel(e,t,a,r,o,l){t*=4,a*=4,t+=128-4*levelWidth,a+=128-4*levelHeight;for(var n=t;t+4>n;n++)for(var s=a;a+4>s;s++)i=4*(n+s*e.width),e.data[i+0]=r,e.data[i+1]=o,e.data[i+2]=l,e.data[i+3]=255}function tick(){if(frame++,GAME.player.isBorn){if(GAME.ending)camera.x+=velocity.x,camera.y+=velocity.y,camera.z-=velocity.z,velocity.z+=.004;else{var e={x:0-Math.round(camera.x/2),y:Math.round(camera.y/2)};if(e.z=levelTmp[e.x+e.y*levelWidth],!level[e.x][e.y].dv){level[e.x][e.y].dv=!0;for(var t=-2;2>=t;t++)for(var a=-2;2>=a;a++)level[e.x+t]&&level[e.x+t][e.y+a]&&(level[e.x+t][e.y+a].v=!0)}camera.x+=velocity.x,camera.y+=velocity.y,camera.z-=velocity.z,GAME.player.inJump?camera.z>level[e.x][e.y].c-1&&(camera.z=level[e.x][e.y].c-1.21,velocity.z=0,playSound([0,,.023,,.1569,.5238,,-.6165,,,,,,.387,,,,,1,,,,,.5])):(totalMove+=Math.abs(velocity.x)+Math.abs(velocity.y),totalMove>2.5&&(totalMove-=2.5,playSound([2,,.0785,,.1031,.263+.01*Math.random(),,-.3617,,,,,,.013,,,,,1,,,.2434,,.5]))),speedZ=0,camera.z<level[e.x][e.y].h+level[e.x][e.y].z&&0!=level[e.x][e.y].h?(speedZ=camera.z,camera.z=level[e.x][e.y].h+level[e.x][e.y].z,speedZ=camera.z-speedZ,GAME.player.inJump=!1,level[e.x][e.y].z||playSound([0,0,.016381476748580037,.4,.16687619143276416,.4082078254149436,0,-.5507417605915748,0,0,0,0,0,.18724223849979407,0,0,0,0,1,0,0,0,0,.5]),velocity.z=0,1==level[e.x][e.y].h&&(camera.rotation.y=camera.rotation.y%360,GAME.player.isDied=1,playSound([0,,.387,,.88,.4742,,-.12,-.0999,,.079,,,.4625,,.07,,,1,,,,,.5]))):camera.z>level[e.x][e.y].h+level[e.x][e.y].z&&(velocity.z+=.004,GAME.player.inJump=!0);var r={x:0-Math.round((camera.x+(velocity.x>0?.3:-.3))/2),y:Math.round((camera.y+(velocity.y>0?.3:-.3))/2)};r.z=level[r.x][r.y].h+level[r.x][r.y].z,tile3z=levelObj[r.x+r.y*levelWidth],"D"==tile3z||r.z>e.z&&camera.z<r.z?(camera.x-=velocity.x,camera.y-=velocity.y,velocity.x=0,velocity.y=0):(e.x!=GAME.player.tile.x||e.y!=GAME.player.tile.y)&&level[e.x][e.y].t&&(level[e.x][e.y].t.action(),"once"==level[e.x][e.y].t.type&&(level[e.x][e.y].t=!1)),GAME.player.tile=e,moveF&&(velocity.y+=Math.cos(.017453292519943295*camera.rotation.y)*delta,velocity.x+=Math.sin(.017453292519943295*camera.rotation.y)*delta),moveB&&(velocity.y-=Math.cos(.017453292519943295*camera.rotation.y)*delta,velocity.x-=Math.sin(.017453292519943295*camera.rotation.y)*delta),moveL&&(velocity.y+=Math.cos(.017453292519943295*(camera.rotation.y+90))*delta,velocity.x+=Math.sin(.017453292519943295*(camera.rotation.y+90))*delta),moveR&&(velocity.y-=Math.cos(.017453292519943295*(camera.rotation.y+90))*delta,velocity.x-=Math.sin(.017453292519943295*(camera.rotation.y+90))*delta)}velocity.x-=.1*velocity.x,velocity.y-=.1*velocity.y,0!=velocity.z&&(velocity.z+=.004)}drawScene(),drawGUI(),requestAnimationFrame(tick)}function resize(){var e=document.getElementById("game");e.width=window.innerWidth,e.height=window.innerHeight,gl=e.getContext("webgl"),gl.viewportWidth=e.width,gl.viewportHeight=e.height,canvasGUI.width=window.innerWidth,canvasGUI.height=window.innerHeight}function webGLStart(){tmp=playSound([3,.9573,.7063,.0608,1.8,.5235,,,-.0289,.5725,,.3533,,.6858,.0206,,.0407,-.2419,.5566,.0067,.1186,.0629,,.5]),tmp[2].stop(),endPlayedSnd=tmp[1].createBufferSource(),endPlayedSnd.buffer=tmp[0],endPlayedSnd.connect(tmp[1].destination),canvasGUI=document.getElementById("GUI"),ctx=canvasGUI.getContext("2d"),canvasGUI.requestPointerLock=canvasGUI.requestPointerLock||canvasGUI.mozRequestPointerLock,canvasGUI.onclick=function(){this.requestPointerLock(),(GAME.player.isDied||!GAME.player.isBorn)&&(initGame(),GAME.player.isBorn=!0),showText(!1)},resize(),gl||alert("Could not initialise WebGL, sorry :-("),initShaders(),initTexture(),gl.clearColor(0,0,0,1),gl.enable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),canvas2=document.getElementById("textureCanvas"),canvas2.width=512,canvas2.height=512;var e=canvas2.getContext("2d"),t=e.getImageData(0,0,canvas2.width,canvas2.height);e.clearRect(0,0,512,512);for(var a=0;a<t.data.length;a+=4)for(var r=0;128>r;r+=4){if(8192>a||a>65536&&73728>a||a>974848&&983040>a||a>1040384)var o=[209,82,6];else{if(!(65536>a||a>983040))continue;var o=[124,7,15]}t.data[a+r]=o[0],t.data[a+r+1]=o[1]+40*Math.random(),t.data[a+r+2]=o[2],t.data[a+r+3]=255}d=64;for(var a=65536;a<t.data.length-65536;a+=256)for(var r=0;128>r;r+=4){if(16>r||r>112||8192>a)var o=[209,82,6];else var o=[124,7,15];t.data[d+a+r]=o[0],t.data[d+a+r+1]=o[1]+40*Math.random(),t.data[d+a+r+2]=o[2],t.data[d+a+r+3]=255}e.putImageData(t,0,0),handleLoadedTextureFromCanvas("textureDoor",document.getElementById("textureCanvas")),e.clearRect(0,0,512,512),e.textAlign="center",e.textBaseline="middle",e.font="512px Arial",e.fillStyle="rgba(255,255,255,0.5)",e.fillRect(0,0,512,512),e.fillStyle="rgba(0,0,255,0.5)",e.strokeStyle="#000",e.lineWidth=8,e.fillText("⚷",canvas2.width/2,canvas2.height/2),e.strokeText("⚷",canvas2.width/2,canvas2.height/2),handleLoadedTextureFromCanvas("textureKey",document.getElementById("textureCanvas"));for(var a=0;a<t.data.length;a+=4){var o=Math.floor(255*Math.random());t.data[a]=193*(255-(255-o)/100*12)/255,t.data[a+1]=171*(255-(255-o)/100*12)/255,t.data[a+2]=146*(255-(255-o)/100*12)/255,t.data[a+3]=255}e.putImageData(t,0,0),handleLoadedTextureFromCanvas("mur",document.getElementById("textureCanvas"));for(var a=0;a<t.data.length;a+=4){var o=Math.floor(255*Math.random());t.data[a]=t.data[a+1]=t.data[a+2]=o,t.data[a+3]=255}e.putImageData(t,0,0),handleLoadedTextureFromCanvas("portal",document.getElementById("textureCanvas")),initGame(),tick()}var synth=new sy;window.jsfxr=function(e){window._audioContext=window._audioContext||new AudioContext;var t=window._audioContext;synth._p.set(e);var a=synth.totalReset(),r=a+1>>1<<1,o=t.createBuffer(1,r,t.sampleRate),i=o.getChannelData(0);return 2*synth.sW(i,a),o},window.playSound=function(e){jsfxr(e);var t=window._audioContext,a=t.createBufferSource();return a.buffer=jsfxr(e),a.loop=!1,a.connect(t.destination),a.start(t.currentTime),[a.buffer,t,a]},glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;var mat3={};mat3.create=function(e){var t=new glMatrixArrayType(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},mat3.transpose=function(e,t){if(!t||e==t){var a=e[1],r=e[2],o=e[5];return e[1]=e[3],e[2]=e[6],e[3]=a,e[5]=e[7],e[6]=r,e[7]=o,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t};var mat4={};mat4.create=function(e){var t=new glMatrixArrayType(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},mat4.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.toInverseMat3=function(e,t){var a=e[0],r=e[1],o=e[2],i=e[4],l=e[5],n=e[6],s=e[8],c=e[9],d=e[10],g=d*l-n*c,f=-d*i+n*s,m=c*i-l*s,v=a*g+r*f+o*m;return v?(v=1/v,t||(t=mat3.create()),t[0]=g*v,t[1]=(-d*r+o*c)*v,t[2]=(n*r-o*l)*v,t[3]=f*v,t[4]=(d*a-o*s)*v,t[5]=(-n*a+o*i)*v,t[6]=m*v,t[7]=(-c*a+r*s)*v,t[8]=(l*a-r*i)*v,t):null},mat4.translate=function(e,t,a){var r=t[0],o=t[1];if(t=t[2],!a||e==a)return e[12]=e[0]*r+e[4]*o+e[8]*t+e[12],e[13]=e[1]*r+e[5]*o+e[9]*t+e[13],e[14]=e[2]*r+e[6]*o+e[10]*t+e[14],e[15]=e[3]*r+e[7]*o+e[11]*t+e[15],e;var i=e[0],l=e[1],n=e[2],s=e[3],c=e[4],d=e[5],g=e[6],f=e[7],m=e[8],v=e[9],u=e[10],y=e[11];return a[0]=i,a[1]=l,a[2]=n,a[3]=s,a[4]=c,a[5]=d,a[6]=g,a[7]=f,a[8]=m,a[9]=v,a[10]=u,a[11]=y,a[12]=i*r+c*o+m*t+e[12],a[13]=l*r+d*o+v*t+e[13],a[14]=n*r+g*o+u*t+e[14],a[15]=s*r+f*o+y*t+e[15],a},mat4.rotate=function(e,t,a,r){var o=a[0],i=a[1];a=a[2];var l=Math.sqrt(o*o+i*i+a*a);if(!l)return null;1!=l&&(o*=l=1/l,i*=l,a*=l);var n=Math.sin(t),s=Math.cos(t),c=1-s;t=e[0],l=e[1];var d=e[2],g=e[3],f=e[4],m=e[5],v=e[6],u=e[7],y=e[8],x=e[9],h=e[10],p=e[11],T=o*o*c+s,E=i*o*c+a*n,b=a*o*c-i*n,A=o*i*c-a*n,M=i*i*c+s,R=a*i*c+o*n,w=o*a*c+i*n;return o=i*a*c-o*n,i=a*a*c+s,r?e!=r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=t*T+f*E+y*b,r[1]=l*T+m*E+x*b,r[2]=d*T+v*E+h*b,r[3]=g*T+u*E+p*b,r[4]=t*A+f*M+y*R,r[5]=l*A+m*M+x*R,r[6]=d*A+v*M+h*R,r[7]=g*A+u*M+p*R,r[8]=t*w+f*o+y*i,r[9]=l*w+m*o+x*i,r[10]=d*w+v*o+h*i,r[11]=g*w+u*o+p*i,r},mat4.frustum=function(e,t,a,r,o,i,l){l||(l=mat4.create());var n=t-e,s=r-a,c=i-o;return l[0]=2*o/n,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=2*o/s,l[6]=0,l[7]=0,l[8]=(t+e)/n,l[9]=(r+a)/s,l[10]=-(i+o)/c,l[11]=-1,l[12]=0,l[13]=0,l[14]=-i*o*2/c,l[15]=0,l},mat4.perspective=function(e,t,a,r,o){return e=a*Math.tan(e*Math.PI/360),t*=e,mat4.frustum(-t,t,-e,e,a,r,o)},speedZ=frame=totalMove=0;var doorTimer=!1,respawn=[{x:-8.7,y:46.52,z:3,rotX:10,rotY:-412,rotZ:-3},{x:-1.3,y:35.9,z:2.2,rotX:-1.3,rotY:25.9,rotZ:9},{x:-15.53,y:10.2,z:6,rotX:-1.3,rotY:42,rotZ:19.4},{x:-37.35,y:29.75,z:3,rotX:-1.3,rotY:170.4,rotZ:-19.1},{x:-60,y:50.5,z:3,rotX:-1.3,rotY:-11.1,rotZ:4.1}],lastRespawn=0,font=[];font[0]="111101101101111",font[1]="010110010010111",font[2]="111001111100111",font[3]="111001111001111",font[4]="101101111001001",font[5]="111100111001111",font[6]="111100111101111",font[7]="111001010010010",font[8]="111101111101111",font[9]="111101111001111",font.A="111101111101101",font.B="110101110101110",font.C="111100100100111",font.D="110101101101110",font.E="111100111100111",font.F="111100111100100",font.G="111100101101111",font.H="101101111101101",font.I="111010010010111",font.J="011001001101010",font.K="101101110101101",font.L="100100100100111",font.M="101111111101101",font.N="101111111111101",font.O="010101101101010",font.P="110101110100100",font.Q="111101101111001",font.R="110101111110101",font.S="111100111001111",font.T="111010010010010",font.U="101101101101111",font.V="101101101101010",font.W="101101111111101",font.X="101101010101101",font.Y="101101010010010",font.Z="111001010100111",font["-"]="000000111000000",font[":"]="000010000010000",font["."]="000000000000010",font[","]="000000000010100",font["'"]="001010000000000",font["?"]="010101001010010",font["+"]="000010111010000",font["="]="000111000111000",font["!"]="010010010000010";var gl,shaderProgram,shaderProgramLava,shaderProgramTorch,shaderProgramPortal,ctx,sol,mur,portal,textureDoor,textureKey;delta=.012,moveF=moveB=moveL=moveR=ctrl=!1;var UVW=[],mvMatrix=mat4.create(),pMatrix=mat4.create(),lights=new Float32Array([62.8,-30,8,16,4,-41.2,3.5,0,8.81,-60.8,2.2,0,8.81,-59.2,2.2,0,4.63,-55.21,3.5,0,8.05,-56.33,2.5,0,12.7,-32.8,3.5,0,1.3,-31.2,2.2,0,10.05,-17.2,4.5,0,14.68,-21,3.5,0,1.31,-24.2,3.5,0,8.7,-26,6,0,16.7,-15.7,6.5,0,20.7,-20,6.5,0,16,-1.3,6.5,0,38,-29.3,4.5,0,40,-48.7,6.5,0,36,-48.7,6.5,0,44.7,-56,5.5,0,31.3,-56,5.5,0,46,-59.2,4.5,0,30,-59.2,4.5,0,22,-25.3,3.5,0,60.7,-60,4.5,0,49.3,-45,3.5,0,52,-37.2,4.5,0,48,-37.2,4.5,0,43.3,-30,3.5,0,43.3,-32,3.5,0,43.3,-34,3.5,0,52,-34.8,4.5,0,48,-34.8,4.5,0]),lightsDisplayed=[];drawText=function(e,t,a){ctx.fillStyle="#FFF",a=a.toString(),ctx.lineWidth=.5,ctx.strokeStyle="#000",pX=e,pY=t,n=0;for(var r=0;r<a.length;r++){var o=0;if(n%33!=32&&"&"!=a[r]||(pX=e,pY+=18,n=0,"&"!=a[r])){for(y=0;5>y;y++)for(x=0;3>x;x++)" "!=a[r]&&"1"==font[a[r]][o++]&&ctx.fillRect(pX+2*x,pY+2*y,1.6,1.6);pX+=8,n++}}},getCube=function(e){return[-1,-1,e,1,-1,e,1,1,e,-1,1,e,-1,-1,0,-1,1,0,1,1,0,1,-1,0,-1,1,0,-1,1,e,1,1,e,1,1,0,-1,-1,0,1,-1,0,1,-1,e,-1,-1,e,1,-1,0,1,1,0,1,1,e,1,-1,e,-1,-1,0,-1,-1,e,-1,1,e,-1,1,0]},getUVW=function(e){return[0,0,4,0,4,4,0,4,-1,0,-1,-1,0,-1,0,0,0,e,0,0,1,0,1,e,1,e,0,e,0,0,1,0,0,0,-1,0,-1,-e,0,-e,-1,0,-1,-e,0,-e,0,0]};var cubeVertexIndexBuffer;coordBuffer=[],UVWBuffer=[],getCoord=function(e,t){return coordBuffer[e]||("torch"==e&&(t=[-.5,0,3,-.5,0,0,.5,0,0,.5,0,3]),coordBuffer[e]=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,coordBuffer[e]),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t),gl.STATIC_DRAW),coordBuffer[e].itemSize=3,coordBuffer[e].numItems=24),coordBuffer[e]},getUVWBuffer=function(e,t){return UVWBuffer[e]||(UVWBuffer[e]=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,UVWBuffer[e]),gl.bufferData(gl.ARRAY_BUFFER,t,gl.STATIC_DRAW),UVWBuffer[e].itemSize=2,UVWBuffer[e].numItems=24),UVWBuffer[e]},doorOpening=function(e){e.status="opening",doorTimer&&clearInterval(doorTimer),doorTimer=setInterval(function(){playSound([3,,.0675,,.1125,.6629,,-.5659,,,,,,,,.06,,,1,,,.0299,,.5])},200)},doorClosing=function(e){e.status="closing",doorTimer&&clearInterval(doorTimer),doorTimer=setInterval(function(){playSound([3,,.0675,,.1125,.6629,,-.5659,,,,,,,,.06,,,1,,,.0299,,.5])},200)},endPlayedSnd=null;var canvas2,canvasGUI,GAME,camera,velocity,keys,doors,triggers,fov,level;showText=function(e){document.getElementById("textInfo").style.display=e?"block":"none",GAME.textInfo=e},keys=[{x:4,y:30,z:2,visible:!0},{x:9,y:30,z:5,visible:!0},{x:13,y:14,z:2,visible:!0},{x:10,y:10,z:5,visible:!0},{x:30,y:5,z:2,visible:!0}],initGame=function(){GAME={player:{inJump:!1,isDied:!1,isBorn:!1,tile:{x:0,y:0}},ended:!1,ending:0},0==lastRespawn?(showText("YOU ARE LOST IN A STRANGE MAZE.&&YOU HAVE TO FIND THE EXIT&&MOVE : WASD, ZQSD AND MOUSE&JUMP : SPACE&&OH...AND BE CAREFUL TO LAVA..."),camera={x:0,y:0,z:0,rotation:{x:10,y:0,z:0}},GAME.player.isBorn=!1):GAME.player.isBorn=!0,r=respawn[lastRespawn],camera={rotation:{}},camera.x=r.x,camera.y=r.y,camera.z=r.z,camera.rotation.x=r.rotX,camera.rotation.y=r.rotY,camera.rotation.z=r.rotZ,console.log("init Camera"),velocity={x:0,y:0,z:0},doors=[{x:1,y:19,z:2,color:"b",status:"closed",decal:{z:0}},{x:8,y:6,z:5,color:"b",status:"closed",decal:{z:0}},{x:19,y:14,z:2,color:"b",status:"closed",decal:{z:0}},{x:30,y:27,z:2,color:"b",status:"closed",decal:{z:0}}],triggers=[{x:1,y:20,action:function(){keys[0].visible?(showText("YOU HAVE TO FIND A KEY TO OPEN&THIS DOOR"),playSound([0,,.05,.4586,.45,.18,,,,,,-.18,.46,,,,,,1,,,,,.5])):(doorOpening(doors[0]),triggers[0].type="once")},type:""},{x:1,y:18,action:function(){doorClosing(doors[0]),lastRespawn=1},type:"once"},{x:4,y:30,action:function(){keys[0].visible&&(showText("YOU FOUND A KEY"),keys[0].visible=!1,playSound([0,,.01,.3153,.4532,.587,,,,,,.526,.5895,,,,,,1,,,,,.5]))},type:"once"},{x:8,y:7,action:function(){keys[3].visible?playSound([0,,.05,.4586,.45,.18,,,,,,-.18,.46,,,,,,1,,,,,.5]):(doorOpening(doors[1]),triggers[3].type="once")},type:""},{x:8,y:5,action:function(){doorClosing(doors[1]),lastRespawn=2},type:""},{x:19,y:13,action:function(){keys[4].visible?playSound([0,,.05,.4586,.45,.18,,,,,,-.18,.46,,,,,,1,,,,,.5]):(doorOpening(doors[2]),triggers[5].type="once")},type:""},{x:19,y:15,action:function(){doorClosing(doors[2]),lastRespawn=3},type:""},{x:9,y:30,action:function(){keys[1].visible&&(keys[1].visible=!1,playSound([0,,.01,.3153,.4532,.587,,,,,,.526,.5895,,,,,,1,,,,,.5]))},type:"once"},{x:30,y:5,action:function(){keys[4].visible&&(keys[4].visible=!1,playSound([0,,.01,.3153,.4532,.587,,,,,,.526,.5895,,,,,,1,,,,,.5]))},type:"once"},{x:13,y:14,action:function(){keys[2].visible&&(keys[2].visible=!1,playSound([0,,.01,.3153,.4532,.587,,,,,,.526,.5895,,,,,,1,,,,,.5]))},type:"once"},{x:10,y:10,action:function(){keys[3].visible&&(keys[3].visible=!1,playSound([0,,.01,.3153,.4532,.587,,,,,,.526,.5895,,,,,,1,,,,,.5]))},type:"once"},{x:30,y:28,action:function(){keys[1].visible||keys[2].visible?(showText("YOU HAVE TO FIND TWO KEY TO OPEN&THIS DOOR"),playSound([0,,.05,.4586,.45,.18,,,,,,-.18,.46,,,,,,1,,,,,.5])):(doorOpening(doors[3]),triggers[0].type="once"),triggers[0].type="once"},type:""},{x:12,y:26,action:function(){setTimeout(function(){12==GAME.player.tile.x&&26==GAME.player.tile.y&&showText("DID YOU EVER PLAY&ASSASSIN CREED ?&&HAVE FAITH !")},5e3)},type:"once"},{x:30,y:26,action:function(){doorClosing(doors[3]),lastRespawn=4},type:"once"},{x:30,y:15,action:function(){velocity.x=-.6,camera.x=-60,camera.y=30,GAME.ending=1,endPlayedSnd.start(0)},type:"once"}],fov=45,levelWidth=33,levelHeight=32,levelTmp="88888888888888888888888888888888 ",levelTmp+="8      8511211111121111111111118 ",levelTmp+="8      8511211111122222211111118 ",levelTmp+="8      8511211111121111211111118 ",levelTmp+="8      8511222222221111211111118 ",levelTmp+="8      8511211112111111222222128 ",levelTmp+="8      8581211112111111211111118 ",levelTmp+="88888888581211111111111111111118 ",levelTmp+="83452524581211122222222222221118 ",levelTmp+="82222228588811121112111111111118 ",levelTmp+="82222222555822221112111111111118 ",levelTmp+="82222222888811111112111111111118 ",levelTmp+="82888818888888888881999999999999 ",levelTmp+="83456828121211111822281111111119 ",levelTmp+="88888828111112111842481121111119 ",levelTmp+="888888281211111118828821411341770",levelTmp+="82223328121111111883882121111119 ",levelTmp+="82888888121112111884882111111119 ",levelTmp+="82811111111111111885882994999999 ",levelTmp+="82811111111211111886881111111118 ",levelTmp+="82888811111111111186811112111118 ",levelTmp+="82212811111121111186811111111118 ",levelTmp+="82222811212211111186888882222228 ",levelTmp+="82222811111111114126211182222228 ",levelTmp+="82888812211111114126211188888828 ",levelTmp+="82882811111111111187811111111828 ",levelTmp+="82222812211199988887888777111828 ",levelTmp+="88282812111122281117111711111828 ",levelTmp+="88282822111111183456543711111828 ",levelTmp+="88288821111131173111111711188828 ",levelTmp+="88222834551133333333333333333328 ",levelTmp+="88888888888888888888888888888888 ",levelObj=levelTmp,ceil="                                 ",ceil+="                                 ",ceil+="                                 ",ceil+="                                 ",ceil+="                                 ",ceil+="                                 ",ceil+="        7                        ",ceil+="        7                        ",ceil+="                                 ",ceil+="                                 ",ceil+=" 6666555                         ",ceil+=" 6666555                         ",ceil+=" 6    5                          ",ceil+=" 688885                          ",ceil+="      5           444            ",ceil+="      5                        9 ",ceil+=" 455555                          ",ceil+=" 4                               ",ceil+=" 4                               ",ceil+=" 4                               ",ceil+=" 4                               ",ceil+="                                 ",ceil+="                                 ",ceil+="                                 ",ceil+=" 4                            4  ",ceil+=" 4                            4  ",ceil+=" 6666                         4  ",ceil+="  6 4                         4  ",ceil+="  6 4                         4  ",ceil+="  5                           4  ",ceil+="  544                            ",ceil+="                                 ",level=[];
for(var e=0;levelWidth>e;e++){level[e]=[];for(var t=0;levelHeight>t;t++){level[e][t]={h:levelTmp[e+t*levelWidth]?parseInt(levelTmp[e+t*levelWidth]):!1,v:!1,c:ceil[e+t*levelWidth]?parseInt(ceil[e+t*levelWidth]):!1,t:!1,z:0};for(var a=0;a<triggers.length;a++)triggers[a].x==e&&triggers[a].y==t&&(level[e][t].t={type:triggers[a].type,action:triggers[a].action})}}for(var a=0;a<doors.length;a++){var o=doors[a];index=o.x+levelWidth*o.y,levelObj=levelObj.substr(0,index)+"D"+levelObj.substr(index+1)}},document.onmousemove=function(e){GAME.player.isDied||GAME.ending||(camera.rotation.y+=e.movementX/10,camera.rotation.z+=e.movementY/10)},document.onkeydown=function(e){if(!GAME.player.isDied)switch(e.keyCode){case 90:case 87:case 38:moveB=!0;break;case 81:case 37:moveL=!0;break;case 40:case 83:case 65:moveF=!0;break;case 68:case 39:moveR=!0;break;case 17:case 32:GAME.player.inJump||(velocity.z=-.175-speedZ,GAME.player.inJump=!0,playSound([0,,.2226,,.2104,.12,,.252,,,,,,.1856,,,,,1,,,,,.5]))}},document.onkeyup=function(e){switch(e.keyCode){case 90:case 87:case 38:moveB=!1;break;case 81:case 37:moveL=!1;break;case 40:case 83:case 65:moveF=!1;break;case 68:case 39:moveR=!1}};	
</script>
</html>