(function(e){var t,n,r=new Image,i="start",s,o,u=8,a=4,f=[3,7],l,c,h,p,d,v,m=[],g=[0,0],y=!1,b=new Date;for(var w=0,E="";w!=256;w++)m[w]=!1;var S=function(){s==undefined&&(s={}),s.x=225,s.y=225,s.dx=0,s.dy=0,s.score=0,s.nectar=250,s.maxNectar=1500,s.luck=[75,100],s.ani={cell:0,rate:300,last:new Date},s.highScore||(s.highScore=0),o=[],l=[],c=100,d=new Date,h=new Date,p=1e3,score=0,v=!1};S();var x=function(e,t,r){if(!r)var r=!1;if(!e||!t)var e=250,t=60;if(r)var i=1.25,o=1.75,u=.3;else var i=tb.per(s.nectar,s.maxNectar)/100+1,o=c/100+1,a=new Date,u=tb.per(a-d,3e4)/100;var f=n;f.fillStyle="rgba(128,128,128,0.5)",f.strokeStyle="rgba(0,0,0,1)",f.lineWidth=2,f.beginPath(),f.arc(e,t,50,Math.PI,Math.PI*2),f.arc(e,t,30,Math.PI*2,Math.PI,!0),f.closePath(),f.stroke(),f.fill(),f.beginPath(),f.arc(e,t,25,Math.PI,Math.PI*2),f.arc(e,t,10,Math.PI*2,Math.PI,!0),f.closePath(),f.stroke(),f.fill(),f.beginPath(),f.arc(e,t+5,25,Math.PI*2,Math.PI),f.arc(e,t+5,10,Math.PI,Math.PI*2,!0),f.closePath(),f.stroke(),f.fill(),f.fillStyle="rgba(255,0,128,0.75)",f.beginPath(),f.arc(e,t,50,Math.PI,Math.PI*i),f.arc(e,t,30,Math.PI*i,Math.PI,!0),f.closePath(),f.stroke(),f.fill(),f.fillStyle="rgba(0,192,0,0.75)",f.beginPath(),f.arc(e,t,25,Math.PI,Math.PI*o),f.arc(e,t,10,Math.PI*o,Math.PI,!0),f.closePath(),f.stroke(),f.fill(),f.fillStyle="rgba(0,255,128,0.75)",f.beginPath(),f.arc(e,t+5,25,Math.PI,Math.PI-Math.PI*u,!0),f.arc(e,t+5,10,Math.PI-Math.PI*u,Math.PI,!1),f.closePath(),f.stroke(),f.fill();if(!r){f.strokeStyle="#000000",f.fillStyle="#ffffff",f.font="15px courier",f.textAlign="center";var l=tb.formatNumber(s.score);f.strokeText("score: "+l,100,20),f.fillText("score: "+l,100,20)}},T=function(){this.x=tb.rndInt(380)+60,this.y=tb.rndInt(280)+110,this.nectar=tb.rndInt(50+c,c*4.4+60),this.flowerSize=this.nectar*.05,this.grown=!1,this.growState=0,this.stemColor="rgb(0,"+Math.round(tb.rnd(127)+127)+",0)",this.x<=250?this.stemXRate=tb.rnd(this.x)/25/25:this.stemXRate=tb.rnd(480-this.x)/25/25,this.pettleHue=Math.round(tb.rnd(360)),this.pettleLightness=c,this.offset=tb.rnd(3.14),this.pettleCount=Math.round(tb.rnd(f[0],f[1]))},N=function(e,t){var r=o[t];n.strokeStyle=r.stemColor,n.save(),n.lineWidth=5,r.nectar<25?n.globalAlpha=tb.per(r.nectar,25)/100:n.globalAlpha=1,n.beginPath(),n.moveTo(r.x+r.flowerSize,500);for(var i=0;i!=e+1;i++){var s=(500-r.y-r.flowerSize)/50;if(i<=24)var u=i;else var u=50-i;if(r.x<=250)var f=r.x+r.flowerSize-u*r.stemXRate*i;else var f=r.x+r.flowerSize+u*r.stemXRate*i;var l=500-i*s;n.lineTo(f,l)}n.stroke();var c="rgb("+Math.round(r.nectar)+","+Math.round(r.nectar)+",0)",h="#ffffff",h="hsl("+r.pettleHue*30+","+Math.round(tb.per(r.nectar,500))+"%,"+r.pettleLightness+"%)";e==50?C(r.x+r.flowerSize,r.y+r.flowerSize,r.flowerSize*3,r.pettleCount,c,h,r.offset,a):C(f,l,r.flowerSize*3*(e/50),r.pettleCount,c,h,r.offset,a),n.restore()},C=function(e,t,r,i,s,o,u,a){if(u==undefined)var u=tb.rnd(0,3.14);n.beginPath(),n.lineWidth=2,n.moveTo(e,t);var f=i*2;if(!a)var a=4;var l=f*a,c=Math.PI*2/l,h=l/i,p=r/3;r=r*2/h;var d=!0;for(var v=u,m=0;v<Math.PI*2+u;v+=c)n.lineTo(e+Math.sin(v)*m*r,t+Math.cos(v)*m*r),d?m+=1:m-=1,m>=h/2&&(d=!d),m<=0&&(d=!d);n.closePath(),n.strokeStyle="#000000",n.stroke(),n.fillStyle=o,n.fill(),n.strokeStyle="#000000",n.beginPath(),n.arc(e,t,p,0,6.28),n.closePath(),n.stroke(),n.fillStyle=s,n.fill()},k=function(){var e=n.createLinearGradient(0,500,0,0);e.addColorStop(0,"#00ff80"),e.addColorStop(.75,"#0000ff"),n.fillStyle=e,n.fillRect(0,0,500,500)},L={firstTime:!0,start:function(){L.firstTime&&(t=tb.g("game"),n=t.getContext("2d"),n.textBaseline="top",r.src="img/fly_32_1.png",r.onload=function(){D(),b=new Date,i="menu"},tb.getIt()!=undefined&&(s.highScore=tb.getIt()),L.firstTime=!1)},maxMenuFlowers:10,menuFlowers:[],menuFlowerRadian:0,menuMessage:tb.breakToLines("Use the W,A,D keys, or touch screen, to move Mr BtterFly. Try your best to keep your nectar bar from fully depleting, by gathering Nectar from flowers. As time goes by your luck will change. ",12,400),menu:function(){if(L.menuFlowers.length<L.maxMenuFlowers){var e=L.menuFlowers.length;L.menuFlowers[e]={};var t=L.menuFlowers[e];t.size=tb.rnd(75)+25,t.x=Math.round(tb.rnd(t.size/2,500-t.size/2)),t.y=Math.round(tb.rnd(t.size/2,500-t.size/2)),t.pettleColor="hsl("+Math.round(tb.rnd(360))+",100%,"+Math.round(tb.rnd(50,100))+"%)",t.offset=tb.rnd(3.14),t.pettleCount=Math.round(tb.rnd(f[0],f[1]))}L.menuFlowers.length==L.maxMenuFlowers&&(y||m[32])&&new Date-b>=2e3&&(tb.boundingBox(g[0],g[1],1,1,100,200,300,50)||m[32])&&(L.menuFlowers=[],S(),b=new Date,i="game")},game:function(){m[87]?(s.dy>-5&&(s.dy-=.25),s.nectar-=.5,new Date-s.ani.last>=s.ani.rate*.25&&(s.ani.cell++,s.ani.last=new Date,s.ani.cell==2&&(s.ani.cell=0))):s.dy<5&&(s.dy+=.25),m[65]||m[68]?(s.nectar-=.5,m[65]&&s.dx>-5&&(s.dx-=.25),m[68]&&s.dx<5&&(s.dx+=.25)):(s.dx>0&&(s.dx-=.25),s.dx<0&&(s.dx+=.25)),s.x+=s.dx,s.y+=s.dy,s.x<0&&(s.x=0),s.x>450&&(s.x=450),s.y>450&&(s.y=450),s.y<0&&(s.y=0);if(new Date-h>=p){h=new Date;if(o.length<u){var e=tb.rnd(100);if(e<=c){var t=o.length;o[t]=new T(t)}}}for(var n=0;n!=o.length;n++){var t=o[n];t.grown?(tb.boundingBox(s.x,s.y+30,20,20,t.x,t.y,t.flowerSize*2,t.flowerSize*2)?(t.nectar>=20?(s.nectar+=2,t.nectar-=20,s.score+=20):(s.nectar+=t.nectar,s.score+=Math.floor(t.nectar),t.nectar=0),s.nectar>s.maxNectar&&(s.nectar=s.maxNectar)):(t.nectar-=.25,t.nectar<25&&t.y<480&&t.y++),t.nectar<0&&(t.nectar=0)):t.growState<50?t.growState++:t.grown=!0,t.nectar<=0&&(l[l.length]=n)}if(l.length>0){for(var r=l.length-1;r!=-1;r--)o.splice(l[r],1);l=[],h=new Date}new Date-d>=3e4&&(c=Math.round(tb.rnd(s.luck[1]-s.luck[0]))+s.luck[0],s.luck[0]>10&&(s.luck[0]-=5,s.luck[1]-=5),d=new Date),new Date-s.ani.last>=s.ani.rate&&(s.ani.cell++,s.ani.last=new Date,s.ani.cell==2&&(s.ani.cell=0));if(s.y==450||s.nectar<=0)s.nectar=0,b=new Date,i="lostGame"},lostGame:function(){if(m[32]||y&&new Date-b>=2e3)s.score>s.highScore&&(s.highScore=s.score,tb.parkIt(s.highScore)),S(),b=new Date,i="menu"}},A={start:function(){k(),n.fillText("I am loading...",10,10)},menu:function(){k();for(var e=0;e!=L.menuFlowers.length;e++){L.menuFlowers[e];var t=L.menuFlowers[e];C(t.x,t.y,t.size,t.pettleCount,"#ffff00",t.pettleColor,t.offset,a)}n.fillStyle="rgba(0,0,0,0.75)";if(e!=L.maxMenuFlowers){var r=Math.round(tb.per(e,L.maxMenuFlowers)*4),i=Math.round(r/2);n.fillRect(250-i,250-i,r,r)}else n.strokeStyle="#ffffff",n.fillRect(50,50,400,400),n.lineWidth=4,n.strokeRect(50,50,400,400),n.fillStyle="#ff0000",n.fillRect(100,200,300,50),n.strokeRect(100,200,300,50),n.fillStyle="#ffffff",n.font="80px arial",n.textAlign="center",n.fillText("bFly",250,70),n.font="40px arial",n.fillText("new game",250,200),n.font="15px arial",n.fillText("How to Play:",250,260),x(150,350,!0),n.strokeStyle="#ffffff",n.font="12px courier",n.beginPath(),n.moveTo(115,330),n.lineTo(100,300),n.closePath(),n.stroke(),n.beginPath(),n.moveTo(150,335),n.lineTo(150,290),n.closePath(),n.stroke(),n.beginPath(),n.moveTo(135,365),n.lineTo(160,400),n.closePath(),n.stroke(),n.fillStyle="#ffffff",n.fillText("Nectar",100,288),n.fillText("Luck",150,278),n.fillText("Time to luck change",160,400),tb.printStringArrayToContext(L.menuMessage,n,12,325,300),n.fillText("High Score: "+tb.formatNumber(s.highScore),250,170),tb.boundingBox(g[0],g[1],1,1,100,200,300,50)&&(C(100,200,40,7,"#ffff00","#ffffff",L.menuFlowerRadian,2),L.menuFlowerRadian+=.05,L.menuFlowerRadian>=Math.PI*2&&(L.menuFlowerRadian-=Math.PI*2))},game:function(){k();for(var e=0;e!=o.length;e++){var t=o[e];N(t.growState,e)}n.drawImage(r,s.ani.cell*16,0,16,15,s.x,s.y,50,50),x()},lostGame:function(){if(!v){n.fillStyle="rgba(0,0,0,0.8)",n.strokeStyle="#ffffff",n.lineWidth=4,n.fillRect(125,125,250,250),n.strokeRect(125,125,250,250),n.fillStyle="#ffffff",n.font="40px arial";var e="game over";n.textAlign="center",n.fillText(e,250,125);var e=tb.breakToLines("Oh no it looks as though mr butterFly could not keep up with its futial strugle, how sad.",7,250),t=tb.printStringArrayToContext(e,n,15,250,180);n.fillText("your score: "+tb.formatNumber(s.score),250,t),n.fillText("click or press to continue",250,t+40),v=!0}}},O=function(){var e=new Date,t=function(){new Date-e>=50&&(L[i](),A[i](),e=new Date),requestAnimFrame(t)};t()},M=function(){t.style.top="25px",t.style.left=Math.round(window.innerWidth/2-250)+"px"};e.addEventListener("load",function(e){tb.checkCanvas()?O():document.write("your browser does not seem to support canvas, sorry.")}),e.addEventListener("resize",function(e){t!=undefined}),e.addEventListener("keydown",function(e){e.keyCode==32&&e.preventDefault(),m[e.keyCode]=!0}),e.addEventListener("keyup",function(e){m[e.keyCode]=!1});var _=function(e){e.preventDefault(),m[32]=!1,m[87]=!1,m[65]=!1,m[68]=!1;var t=e.touches[0];g[0]=Math.round(tb.per(t.clientX,window.innerWidth))*5,g[1]=Math.round(tb.per(t.clientY,window.innerHeight))*5,g[1]<s.y&&(m[87]=!0),g[0]>s.x&&(m[68]=!0),g[0]<s.x&&(m[65]=!0)},D=function(){t.addEventListener("mousemove",function(e){g[0]=Math.floor(tb.per(e.clientX,window.innerWidth)*5),g[1]=Math.floor(tb.per(e.clientY,window.innerHeight)*5)}),t.addEventListener("mousedown",function(e){y=!0}),t.addEventListener("mouseup",function(e){y=!1}),t.addEventListener("touchstart",function(e){y=!0,_(e)}),t.addEventListener("touchend",function(e){e.preventDefault(),y=!1,g[0]=-1,g[1]=-1,m[32]=!1,m[87]=!1,m[65]=!1,m[68]=!1}),t.addEventListener("touchmove",function(e){_(e)})}})(window)