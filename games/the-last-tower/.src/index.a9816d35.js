class e{constructor(e,t){this.x=e,this.y=t}clone(){return new e(this.x,this.y)}scale(e){return this.x*=e,this.y*=e,this}normalize(){let e=i(this);return this.x/=e,this.y/=e,this}sub(e){return this.x-=e.x,this.y-=e.y,this}dotProduct(e){return this.x*e.x+this.y*e.y}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}direction(t){return new e(this.x,this.y).sub(t).normalize()}}class t{constructor(t,i,n,r,s=!1){this.pos=new e(t,i),this.size=new e(n,r),this.isTrigger=s}}function i(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function n(e,t){return{x:e.x-t.x,y:e.y-t.y}}function r(e,t,n){let r=function(e){let t=i(e);return{x:e.x/t,y:e.y/t}}(t);return e.x=e.x+n*r.x,e.y=e.y+n*r.y,e}function s(e,t,i){let n=t.split("."),r=n.pop(),s=e;for(let e of n)s[e]||(s[e]={}),s=s[e];s[r]=i}function o(e){return new t(e.pos.x-e.size.x/2,e.pos.y+e.size.y/2,e.size.x,e.size.y,e.isTrigger)}function a(e,t){let{sprites:i}=t.entities,n=i.get(e);if(!n){let t=e.substring(0,e.indexOf("_")+1);n=i.get(t)}return n}function l(e,t,i){let{rendering:n}=i,{camera:r,ctx:s}=n,{x:o,y:a}=r.worldToScreen({x:t.x-e.size.x/2,y:t.y+e.size.y/2}),l=r.zoom;s.drawImage(e.data,0,0,e.data.naturalWidth,e.data.naturalHeight,o,a,e.size.x*l,e.size.y*l)}class c{lastSpawnAt=void 0;active=!1;interval=5e3*Math.random()+1e4;constructor(t,i){this.position=new e(t,i)}}function p(e,t){return!(e.pos.x+e.size.x<t.pos.x)&&!(e.pos.y-e.size.y>t.pos.y)&&!(t.pos.x+t.size.x<e.pos.x)&&!(t.pos.y-t.size.y>e.pos.y)}function u(e,i,n){let r=o(new t(e.x,i.y,16,16)),s=o(new t(i.x,e.y,16,16)),a=p(n,r),l=p(n,s);return{x:a,y:l}}var d={perform:function(e,t,i){let{entities:{positions:n,performingAttack:s},time:{currentFrameTime:o}}=e,a=r(n.get(t).clone(),i,5),l=s.get(t);l||s.set(t,{startedAt:o,direction:i,position:a.clone()})},draw:function(t,i){var n,r;let{entities:{performingAttack:s,sprites:o},rendering:{ctx:a,camera:l},time:{currentFrameTime:c}}=t,p=s.get(i);if(!p)return;let u=o.get("slash"),d=(n=new e(1,0),r=p.direction,Math.acos(n.dotProduct(r)/(n.length*r.length)));p.direction.y>0&&(d=2*Math.PI-d);let m=l.worldToScreen(p.position);a.save(),a.translate(m.x,m.y),a.rotate(d),a.translate(0,-u.size.y*l.zoom/2),a.globalAlpha=1-(c-p.startedAt)/200,a.drawImage(u.data,0,0,u.size.x*l.zoom,u.size.y*l.zoom),a.restore()},update:function(e){let{entities:{performingAttack:t},time:{currentFrameTime:i}}=e;for(let[e,n]of t.entries())i-n.startedAt>=200&&t.delete(e)}};class m{hps=new Map;poolSize=0;futureSpawns={2e4:new e(0,-110),5e4:new e(0,110),9e4:new e(110,0),14e4:new e(-110,0)};constructor({spawns:e=[]}){this.spawns=e.map(e=>new c(e.x,e.y))}}function h(e,t,i){let{entities:{positions:n},time:{currentFrameTime:r}}=e,o=`enemy_${t}`,a=e.entities[o]?.lastAttackAt;if("number"==typeof a&&r-a<600)return!1;let l=n.get(i),c=n.get(o),p=l.direction(c);return s(e.entities,`${o}.lastAttackAt`,r),d.perform(e,o,p),!0}var y={draw:function(t){let{time:{currentFrameTime:i}}=t,{enemies:n,positions:r}=t.entities,{hps:o,poolSize:l}=n,{camera:c,ctx:p}=t.rendering,u=16*c.zoom,m=c.zoom;for(let h=0;h<l;h++){let l=`enemy_${h}`,y=o.get(l);if(y<=0)continue;let w=r.get(l),f=c.worldToScreen(w),x=[a("enemy-1_",t),a("enemy-2_",t)];n[`enemy_${h}`]?.lastSpriteSwitchAt===void 0&&s(n,`enemy_${h}.lastSpriteSwitchAt`,i),n[`enemy_${h}`]?.lastSpriteSwitchAt&&i-n[`enemy_${h}`]?.lastSpriteSwitchAt>=200&&(s(n,`enemy_${h}.lastSpriteSwitchAt`,i),s(n,`enemy_${h}.currentSpriteIndex`,((n[`enemy_${h}`]?.currentSpriteIndex||0)+1)%2));let g=x[n[`enemy_${h}`]?.currentSpriteIndex||0],S=w.direction(t.entities[l]?.target||new e(0,0));p.save(),p.translate(f.x,f.y),p.scale(Math.sign(S.x)||1,1),p.drawImage(g.data,0,0,g.data.naturalWidth,g.data.naturalHeight,-g.size.x*m/2,-g.size.y*m/2,g.size.x*m,g.size.y*m),p.restore();let z=c.worldToScreen(w),v={width:.7*u,height:4,yoffset:5};p.fillStyle="rgba(255, 255, 255, 0.25)",p.fillRect(z.x-v.width/2,z.y-u/2-v.height-v.yoffset,v.width,v.height);let T=y/100;p.fillStyle="rgb(0, 255, 0)",p.fillRect(z.x-v.width/2,z.y-u/2-v.height-v.yoffset,v.width*T,v.height),d.draw(t,`enemy_${h}`)}},getAliveItems:function(e){let{enemies:{hps:t,poolSize:i},positions:n}=e.entities,r={positions:[],hps:[]};for(let e=0;e<i;e++){let i=`enemy_${e}`,s=t.get(i);s<=0||(r.positions.push(n.get(i)),r.hps.push(s))}return r},createNew:function(e,t){let{enemies:i,positions:n}=e.entities,r=-1;for(let[e,t]of i.hps)if(t<=0){r=e;break}if(-1===r){i.poolSize+=1;let e=`enemy_${i.poolSize-1}`;n.set(e,t.clone()),i.hps.set(e,100);return}n.set(r,t.clone()),i.hps.set(r,100)},update:function(r){let{entities:{enemies:{hps:a,poolSize:l},positions:d,sprites:m,tower:y,player:w},time:{delta:f,currentFrameTime:x}}=r;!function(e){let{entities:{enemies:{futureSpawns:t,spawns:i}},time:{currentFrameTime:n,startTime:r}}=e;for(let[e,s]of Object.entries(t))if(n-r>=Number(e)){let n=i.push(new c(s.x,s.y));i[n-1].active=!0,delete t[e]}}(r);let g=d.get("player"),S=m.get("player-1");for(let c=0;c<l;c++){let m=`enemy_${c}`,z=d.get(m),v=a.get(m);if(v<=0)continue;let T=function(t,r){let{entities:{positions:s,tower:o}}=t,a=new e(0,0),l=s.get("player");if(o.isDead())return l;let c=i(n(l,r));return c<50&&(a=l),a}(r,z),A=z.clone();if(y.isDead(),!function(e,t,r){let s=n(t,e),o=i(s),a=r/o;e.x+=a*s.x,e.y+=a*s.y}(A,T,.015*f),function(e,i,n){let{entities:{performingAttack:r,sprites:s,enemies:{hps:a},tower:l,player:c},time:{currentFrameTime:u,delta:d}}=e,m=`enemy_${n}`,h=a.get(m),y=s.get("slash"),w=s.get("enemy-1_"),f=r.get("player");if(f&&f.startedAt>=u-d&&!f.dmgProcessed){let e=f.position,n=y.size;if(p(o(new t(e.x,e.y,n.x,n.y)),o(new t(i.x,i.y,w.size.x,w.size.y)))){f.dmgProcessed=!0;let e=h-20;if(a.set(m,e),e<=0)return l.increaseHP(5+Math.floor(6*Math.random())),c.killed+=1,!0}}return!1}(r,A,c))continue;let b=u(A,z,o(new t(g.x,g.y,S.size.x,S.size.y)));(b.x||b.y)&&h(r,c,"player")&&(w.decreaseHp(4),w.lastAttackedAt=x),s(r.entities,`${m}.target`,T);let M=function(e,t,i){let n=e.colliders.get("tower-down");return u(t,i,n)}(r,A,z);(M.x||M.y)&&!y.isDead()&&h(r,c,"tower-down")&&y.decreaseHP(1),M.x=b.x||M.x,M.y=b.y||M.y;for(let e=0;e<l;e++){if(c==e)continue;let i=`enemy_${e}`;if(0>=a.get(i))continue;let n=d.get(i),r=o(new t(n.x,n.y,16,16)),s=u(A,z,r);if(M.x=s.x||M.x,M.y=s.y||M.y,M.x&&M.y)break}M.x||(z.x=A.x),M.y||(z.y=A.y)}},getPositions:function(e){let{entities:{positions:t}}=e;return[...t.entries()].filter(([e])=>e.startsWith("enemy_")).map(([,e])=>e)}},w={update:function(e){let{spawns:t}=e.entities.enemies,{currentFrameTime:i}=e.time;for(let n of t)n.active&&(void 0===n.lastSpawnAt||i-n.lastSpawnAt>=n.interval)&&(y.createNew(e,n.position),n.lastSpawnAt=i)}};class f{constructor(e,t=4){var i;let n;this.canvas=e,this.calculateZoom(),window.onresize=(i=()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.calculateZoom()},(...e)=>{n&&clearTimeout(n),n=setTimeout(()=>i(...e),void 0)}),this.position={x:0,y:0}}calculateZoom(){let e=Math.min(this.canvas.width,this.canvas.height);this.zoom=Math.floor(e/200)}get gridCellSize(){return 32/this.zoom}worldToScreen({x:e,y:t}){let i={x:Math.ceil(e*this.zoom+this.canvas.width/2),y:Math.ceil(-t*this.zoom+this.canvas.height/2)};return i}screenToWorld({x:e,y:t}){let i={x:this.position.x+(e-this.canvas.width/2)/this.zoom,y:this.position.y-(t-this.canvas.height/2)/this.zoom};return i}isInViewport(e){let t=this.worldToScreen(e);return t.x>=0&&t.x<=this.canvas.width&&t.y>=0&&t.y<=this.canvas.height}}class x{hp=100;lastAttackedAt=0;lastHealAt=0;killed=0;decreaseHp(e){this.hp=Math.max(this.hp-e,0)}increaseHp(e){this.hp=Math.min(this.hp+e,100)}isDead(){return 0===this.hp}}var g={getCollider:function(e){let{entities:{positions:i,sprites:n}}=e,r=i.get("player"),s=n.get("player-1");return new t(r.x,r.y,s.size.x,s.size.y)},update:function(i){let{input:{mousedown:n,mouse:r},rendering:{camera:s},entities:{positions:o,player:a},time:{currentFrameTime:l}}=i;l-a.lastAttackedAt>=5e3&&a.lastHealAt+500<=l&&(a.increaseHp(3),a.lastHealAt=l),function(e){let{input:i,entities:n,time:{delta:r,currentFrameTime:s}}=e,{positions:o,sprites:a,directions:l,player:c}=n,{currentlyPressed:u}=i,d=u.has("KeyA")?-1:u.has("KeyD")?1:0,m=u.has("KeyW")?1:u.has("KeyS")?-1:0;if(!d&&!m)return;void 0===c.lastSpriteSwitchAt&&(c.lastSpriteSwitchAt=s),c.lastSpriteSwitchAt&&s-c.lastSpriteSwitchAt>=200&&(c.lastSpriteSwitchAt=s,c.currentSpriteIndex=((c.currentSpriteIndex||0)+1)%2);let h=.06*d*r,y=.06*m*r;h&&y&&(h/=1.41,y/=1.41);let w=l.get("player");w.x=d,w.y=m,l.set("player",w.normalize());let f=o.get("player"),x=f.x+h,g=f.y+y,S=!1,z=!1,v=a.get("player-1").size,T=v.x/2,A=e.colliders.values(),b=new t(x-T,f.y+T,v.x,v.y),M=new t(f.x-T,g+T,v.x,v.y);for(let e of A)S||=p(e,b),z||=p(e,M);S||(f.x+=h),z||(f.y+=y)}(i);let c=o.get("player");if(0==n.button){let t=s.screenToWorld(r),n=new e(t.x,t.y).sub(c).normalize();d.perform(i,"player",n)}},draw:function(e){let{entities:{sprites:t,positions:i,player:n},input:{mouse:r},rendering:{ctx:s,camera:o},time:{currentFrameTime:a}}=e,l=o.zoom,c=[t.get("player-1"),t.get("player-2")],p=c[n.currentSpriteIndex||0],u=o.screenToWorld(r),m=i.get("player"),h=o.worldToScreen(m),y=m.direction(u);s.save(),s.translate(h.x,h.y),s.scale(Math.sign(y.x),1),s.drawImage(p.data,0,0,p.data.naturalWidth,p.data.naturalHeight,-p.size.x*l/2,-p.size.y*l/2,p.size.x*l,p.size.y*l),s.restore(),d.draw(e,"player");let w={width:p?.size.x*o.zoom*.7,height:4,yoffset:-6},f={x:h.x-w.width/2,y:h.y-p?.size.y*o.zoom/2-w.height-w.yoffset};s.fillStyle="rgba(255, 255, 255, 0.25)",s.fillRect(f.x,f.y,w.width,w.height);let x=n.hp/100;s.fillStyle="rgb(0, 255, 0)",s.fillRect(f.x,f.y,w.width*x,w.height)}};class S{hp=100;decreaseHP(e){this.hp=Math.max(0,this.hp-e)}increaseHP(e){this.hp=Math.min(this.hp+e,100)}isDead(){return 0===this.hp}}function z(e){let t;let{projectiles:r}=e.entities;r.lastShotAt=e.time.currentFrameTime;let s={x:0,y:0},o=y.getAliveItems(e).positions;for(let e of o){let r=i(n(e,s));if(!t){t={p:e,dist:r};continue}r<t.dist&&(t={p:e,dist:r})}if(!t)return;let a=r.positions.filter(e=>!e.active);if(a.length){let e=a[0];e.pos.x=0,e.pos.y=0,e.active=!0,e.direction.x=t.p.x,e.direction.y=t.p.y}else r.positions.push({active:!0,pos:{x:0,y:0},direction:{x:t.p.x,y:t.p.y}})}var v={update:function(e){let{projectiles:i,tower:n}=e.entities;if(!i.lastShotAt&&!n.isDead()){z(e);return}e.time.currentFrameTime-i.lastShotAt>=600*Math.random()+1850&&!n.isDead()&&z(e),function(e){let{triggers:i,entities:n}=e,r=i["upper-tower"],a=n.sprites.get("player-1").size,l=n.positions.get("player"),c=a.x/e.rendering.camera.zoom,u=o(new t(l.x,l.y,c,c)),d=y.getAliveItems(e).positions.map(e=>o(new t(e.x,e.y,16,16)));for(let t of[...d,u])if(p(r.collider,t)){s(e.entities,"tower-up.isTransparent",!0);break}else s(e.entities,"tower-up.isTransparent",!1)}(e),function(e){let{projectiles:t}=e.entities;for(let i of t.positions.filter(e=>e.active))r(i.pos,i.direction,.06*e.time.delta),e.rendering.camera.isInViewport(i.pos)||(i.active=!1)}(e),function(e){let{projectiles:i,enemies:n,tower:r}=e.entities,s=new t(NaN,NaN,2,2),o=new t(NaN,NaN,16,16),a=y.getPositions(e);for(let e of i.positions.filter(e=>e.active)){s.pos=e.pos;for(let t=0;t<a.length;t++){let i=n.hps.get(`enemy_${t}`);if(i<=0)continue;let l=a[t];o.pos=l;let c=p(s,o);c&&(n.hps.set(`enemy_${t}`,i-50*Math.max(r.hp/100,.6)),e.active=!1)}}}(e)},draw:function(e){let{ctx:t,camera:i}=e.rendering,{projectiles:{positions:n},sprites:r,positions:s,tower:o}=e.entities,a={sprite:r.get("tower-up"),pos:s.get("tower-up"),entity:e.entities["tower-up"]};l(r.get("tower-down"),s.get("tower-down"),e),a.entity?.isTransparent?(t.save(),t.globalAlpha=.5,l(a.sprite,a.pos,e),t.restore()):l(a.sprite,a.pos,e),t.fillStyle="yellow";let c=2*i.zoom,p=n.filter(e=>e.active);for(let e of p){let n=i.worldToScreen(e.pos);t.beginPath(),t.ellipse(n.x+1,n.y+1,c,c,0,0,2*Math.PI),t.fill()}let u=i.worldToScreen(a.pos),d=a.sprite.size.clone().scale(i.zoom),m=.8*d.x;t.fillStyle="rgba(255, 255, 255, 0.25)",t.fillRect(u.x-m/2,u.y-d.y/2-5-5,m,5);let h=o.hp/100;t.fillStyle="rgb(0, 255, 0)",t.fillRect(u.x-m/2,u.y-d.y/2-5-5,m*h,5)}};const T=document.querySelector("#sprite-wall"),A=document.querySelector("#sprite-knight-1"),b=document.querySelector("#sprite-enemy-1");function M(e){let t=e/1e3,i=Math.floor(t/60),n=`${t.toFixed()}s`;return i>0&&(t%=60,n=`${i.toFixed()}m ${t.toFixed()}s`),n}function k(e,t,i){let{currentlyPressed:n}=e.input;i?n.add(t):n.delete(t)}window.startGame=function(){let i=document.querySelector("canvas");i.width=window.innerWidth,i.height=window.innerHeight;let n={meta:{stage:"main-menu"},time:{delta:0,currentFrameTime:0,startTime:-1},input:{currentlyPressed:new Set,wasPressedAt:new Map,mouse:{x:0,y:0},clicks:[],mousedown:{button:null}},rendering:{canvas:i,ctx:i.getContext("2d"),camera:new f(i)},entities:{positions:new Map([["player",new e(20,20)],["tower-down",new e(0,-12)],["tower-up",new e(0,12)]]),enemies:new m({spawns:[{x:-100,y:100},{x:100,y:100},{x:-100,y:-100},{x:100,y:-100}]}),directions:new Map([["player",new e(0,0)]]),performingAttack:new Map,sprites:new Map([["wall_",{data:T,size:new e(8,8)}],["enemy-1_",{data:b,size:new e(16,16)}],["enemy-2_",{data:document.querySelector("#sprite-enemy-2"),size:new e(16,16)}],["tower-down",{data:document.querySelector("#sprite-tower-down"),size:new e(32,24)}],["tower-up",{data:document.querySelector("#sprite-tower-up"),size:new e(32,24)}],["player-1",{data:A,size:new e(16,16)}],["player-2",{data:document.querySelector("#sprite-knight-2"),size:new e(16,16)}],["slash",{data:document.querySelector("#sprite-slash"),size:new e(16,16)}]]),projectiles:{lastShotAt:null,positions:[]},tower:new S,player:new x},colliders:new Map([["tower-down",new t(-16,0,32,24)]]),triggers:{"upper-tower":{collider:new t(-16,24,32,24)}}},r=function(i){!function(e){let{input:t,rendering:i}=e,{canvas:n}=i,{mouse:r,clicks:s}=t;window.onkeydown=t=>{k(e,t.code,!0)},window.onkeyup=t=>{k(e,t.code,!1)},window.onmousemove=e=>{r.x=e.x,r.y=e.y},document.onmouseup=e=>{s.push({x:e.x,y:e.y,button:e.button}),t.mousedown={button:null}},document.onmousedown=e=>{t.mousedown={button:e.button}}}(i);let{rendering:{ctx:n,canvas:r,camera:s},entities:{enemies:o,player:a},colliders:l}=i;document.body.dataset.stage="game",i.meta.stage="game",n.imageSmoothingEnabled=!1,o.spawns.forEach(e=>{e.active=!0});let c=s.screenToWorld(new e(0,0)),p=s.screenToWorld(new e(r.width,0)),u=s.screenToWorld(new e(0,r.height));return l.set("top-stop",new t(c.x,c.y+10,r.width/s.zoom,10)),l.set("right-stop",new t(p.x,p.y,10,r.height/s.zoom)),l.set("botttom-stop",new t(u.x,u.y,r.width/s.zoom,10)),l.set("left-stop",new t(c.x-10,c.y,10,r.height/s.zoom)),function e(t){(-1===i.time.startTime&&(i.time.startTime=t),i.time.currentFrameTime)?(i.time.delta=t-i.time.currentFrameTime,i.time.currentFrameTime=t,i.time.delta):i.time.currentFrameTime=t,"defeat"!==i.meta.stage&&"main-menu"!==i.meta.stage&&(a.isDead()?(i.meta.stage="defeat",function(e){let{time:{currentFrameTime:t,startTime:i},entities:{player:n}}=e;document.body.dataset.stage="defeat";let r=t-i,s=M(r);document.querySelector("#duration").innerHTML=s,document.querySelector("#killed").innerHTML=n.killed;let o=localStorage.getItem("0ctothorp.js13k23.bestDurationMs")||"0",a=localStorage.getItem("0ctothorp.js13k23.bestKills")||"0";Math.floor(r)>Number(o)&&localStorage.setItem("0ctothorp.js13k23.bestDurationMs",r.toFixed()),n.killed>Number(a)&&localStorage.setItem("0ctothorp.js13k23.bestKills",n.killed.toFixed()),Number(o)>0&&(document.querySelector("#best-effort-p").classList.remove("dispnone"),document.querySelector("#best-effort-v").innerHTML=M(Number(o)),document.querySelector("#best-effort-kills").innerHTML=a)}(i)):(g.update(i),y.update(i),w.update(i),v.update(i),d.update(i)),function(e){let{ctx:t,canvas:i}=e.rendering;t.clearRect(0,0,i.width,i.height),v.draw(e),y.draw(e),g.draw(e)}(i),requestAnimationFrame(e))}}(n);requestAnimationFrame(r)};
//# sourceMappingURL=index.a9816d35.js.map
