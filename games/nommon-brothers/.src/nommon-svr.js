var io=require("sandbox-io"),S={games:[],browsing_sockets:[],waiting_socket:null,get_registered_games:function(){for(var e=[],t=0;t<this.games.length;t++)e.push(this.games[t].name);return e}};S.log=function(){},io.on("connection",function(e){function t(){for(var t=0;t<S.games.length;t++)if(e.game_name==S.games[t].name){S.games.splice(t,1);for(var o=0;o<S.browsing_sockets.length;o++)S.browsing_sockets[o].emit("registered_games",S.get_registered_games());return}}S.log(e,"connected"),e.on("disconnect",function(){"browsing"==e.game_status?S.browsing_sockets.splice(S.browsing_sockets.indexOf(e),1):"waiting_for_player"==e.game_status?t():e.opponent&&(e.opponent.emit("left_game",{}),e.opponent.opponent=null,e.opponent=null)}),e.on("lets_play",function(){S.waiting_socket?(e.opponent=S.waiting_socket,S.waiting_socket.opponent=e,S.waiting_socket=null,e.emit("game_start",{game_host:!1}),e.opponent.emit("game_start",{game_host:!0})):S.waiting_socket=e}),e.on("game_update",function(t){e.opponent&&e.opponent.emit("game_update",t)}),e.on("game_update_both",function(t){e.opponent&&e.opponent.emit("game_update",t),e.emit("game_update",t)}),e.on("register_game",function(t){console.log("registered game:"+t.name),e.game_name=t.name,e.game_status="waiting_for_player",S.games.push({name:t.name,socket:e});for(var o=0;o<S.browsing_sockets.length;o++)S.browsing_sockets[o].emit("registered_games",S.get_registered_games())}),e.on("unregister_game",t),e.on("get_registered_games",function(){S.browsing_sockets.push(e),e.game_status="browsing",console.log("REGISTERED GAMES:"+S.get_registered_games()),e.emit("registered_games",S.get_registered_games())}),e.on("stop_browsing",function(){for(var t=0;t<S.browsing_sockets.length;t++)if(e==S.browsing_sockets[t]){S.browsing_sockets.splice(t,1);break}}),e.on("join_game",function(t){for(var o=0;o<S.games.length;o++)if(S.games[o].name==t.name){var n=S.games.splice(o,1)[0];n.socket.opponent=e,e.opponent=n.socket,e.game_status="",e.opponent.game_status="";for(var s=0;s<S.browsing_sockets.length;s++)S.browsing_sockets[s].emit("registered_games",S.get_registered_games()),S.browsing_sockets[s]==e&&(S.browsing_sockets.splice(s,1),s--);n.socket.emit("game_start",{game_host:!0}),e.emit("game_start",{game_host:!1});break}}),e.on("left_game",function(t){e.opponent.emit("left_game",t),e.opponent.opponent=null,e.opponent=null}),e.on("lets_rematch",function(){e.ready_for_rematch=!0,e.opponent.ready_for_rematch&&(e.ready_for_rematch=!1,e.opponent.ready_for_rematch=!1,e.emit("do_rematch",{}),e.opponent.emit("do_rematch",{}))})});