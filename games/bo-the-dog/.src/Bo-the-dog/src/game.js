class Sound{constructor(context){this.context=context}
init(){this.oscillator=this.context.createOscillator();this.gainNode=this.context.createGain();this.oscillator.connect(this.gainNode);this.gainNode.connect(this.context.destination);this.oscillator.type='square'}
play(value,time){this.init();this.oscillator.frequency.value=value;this.gainNode.gain.setValueAtTime(1,this.context.currentTime);this.oscillator.start(time);this.stop(time)}
stop(time){this.gainNode.gain.exponentialRampToValueAtTime(0.001,time+0.5);this.oscillator.stop(time+0.1)}}
kontra.init();kontra.assets.imagePath='src/img';kontra.assets.load('dog.png','dog-blue.png','dog-green.png','dog-red.png').then(function(){let starCount=500;let bgrdStars=[starCount];let mode;let size;let dy;for(var i=0;i<starCount;i++){size=Math.random();bgrdStars[i]=kontra.sprite({x:Math.round(Math.random()*320),y:Math.round(Math.random()*512),width:Math.round(size*3),height:Math.round(size*3),color:'white',dy:((Math.pow(Math.random(),2)*1.2)+0.3),})};var score=0;var c=document.getElementById("game");var ctx=c.getContext("2d");ctx.font="small-caps 26px Arial";ctx.lineWidth=2;ctx.fillStyle="#FFFFFF";ctx.fillText("Press 'enter' to start",20,470);ctx.fillText("'WOOF!' Bo the dog",20,40);ctx.fillText("fell into the screen.",20,70);ctx.fillText("Help Bo find his way back",20,120);ctx.fillText("into the OFFLINE world.",20,150);ctx.fillText("Get Bo a RGB color and",20,210);ctx.fillText("collect the right pixels.",20,240);let dogimgstart=new Image();dogimgstart.src='src/img/dog.png';ctx.drawImage(dogimgstart,130,350);ctx.strokeStyle="#FFFFFF";ctx.strokeRect(112,330,80,50);var win={showwin:function(){ctx.fillStyle="#ffffff";ctx.fillText("'WOOF!' YOU WON",20,200);ctx.fillText("Bo can go back into",20,300);ctx.fillText("the OFFLINE World",20,335)}}
var loss={showloss:function(){ctx.fillStyle="#ffffff";ctx.fillText("GAME OVER",60,250);ctx.fillText("Bo is lost in the screen",20,280)}}
var actualscore={showscore:function(){ctx.fillStyle="#ffffff";ctx.fillText("SCORE = "+score,20,50)}}
let context=new(window.AudioContext||window.webkitAudioContext)();let note=new Sound(context);kontra.keys.bind('p',function(){if(loop.isStopped){loop.start()}else{loop.stop()}});let dogimg=new Image();dogimg.src='src/img/dog.png';let dogredimg=new Image();dogredimg.src='src/img/dog-red.png';let dogblueimg=new Image();dogblueimg.src='src/img/dog-blue.png';let doggreenimg=new Image();doggreenimg.src='src/img/dog-green.png';var player=kontra.sprite({x:130,y:350,image:dogimg,dy:0});let redimg=new Image();var red=kontra.sprite({x:Math.random()*310,y:Math.random()*500,x:300,y:100,dy:1.5,color:'red',radius:11,render:function(){this.context.fillStyle=this.color;this.context.beginPath();this.context.arc(this.x,this.y,this.radius,0,2*Math.PI);this.context.fill()}});let greenimg=new Image();var green=kontra.sprite({x:Math.random()*310,y:Math.random()*500,dy:1.5,color:'#00ff00',radius:11,render:function(){this.context.fillStyle=this.color;this.context.beginPath();this.context.arc(this.x,this.y,this.radius,0,2*Math.PI);this.context.fill()}});let blueimg=new Image();var blue=kontra.sprite({x:Math.random()*310,y:Math.random()*500,dy:1.5,color:'blue',radius:11,render:function(){this.context.fillStyle=this.color;this.context.beginPath();this.context.arc(this.x,this.y,this.radius,0,2*Math.PI);this.context.fill()}});var items=[kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'red',dy:2.5}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'red',dy:2.5}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'red',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'red',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'red',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'blue',dy:2.5}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'blue',dy:2.5}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'blue',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'blue',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'blue',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'#00ff00',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'#00ff00',dy:2}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'#00ff00',dy:2.5}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'#00ff00',dy:2.5}),kontra.sprite({x:Math.random()*310,y:Math.random()*500,width:10,height:5,color:'#00ff00',dy:2})];var loop=kontra.gameLoop({update:function(){bgrdStars.forEach(function(star){if(star.y>512){star.y=0;star.x=Math.round(Math.random()*320)}else{star.update()}});if(kontra.keys.pressed('up')){player.y-=1}
if(kontra.keys.pressed('down')){player.y+=1}
if(kontra.keys.pressed('right')){player.x+=1}
if(kontra.keys.pressed('left')){player.x-=1}
if(player.x>=320){player.x=22}
else if(player.x<=0){player.x=298}
if(player.y>=512){player.y=22}
else if(player.y<=0){player.y=490}
items.forEach(function(item){if(score>=30){item.dy+=0.005}});if(score>=30){red.dy+=0.005;blue.dy+=0.005;green.dy+=0.005}
var plussound={plus:function(){let now=context.currentTime;note.play(440.00,now)}}
var minussound={minus:function(){let now=context.currentTime;note.play(196.00,now)}}
items.forEach(function(item){if(item.collidesWith(player)){item.y=-200;if(player.image==dogredimg){if(item.color=='red'){score+=10;plussound.plus()}else{score-=10;minussound.minus()}}else if(player.image==doggreenimg){if(item.color=='#00ff00'){score+=10;plussound.plus()}else{score-=10;minussound.minus()}}else if(player.image==dogblueimg){if(item.color=='blue'){score+=10;plussound.plus()}else{score-=10;minussound.minus()}}}else if(item.y>=512){item.x=Math.random()*320;item.y=(Math.random()*512)-512}else{item.update()}});if(red.collidesWith(player)){player.image=dogredimg;red.y=-200;let now=context.currentTime;note.play(329.63,now)}
if(blue.collidesWith(player)){player.image=dogblueimg;blue.y=-200;let now=context.currentTime;note.play(329.63,now)}
if(green.collidesWith(player)){player.image=doggreenimg;green.y=-200;let now=context.currentTime;note.play(329.63,now)}
if(blue.y>=512){blue.x=Math.random()*320;blue.y=(Math.random()*512)-512}
if(green.y>=512){green.x=Math.random()*320;green.y=(Math.random()*512)-512}
if(red.y>=512){red.x=Math.random()*320;red.y=(Math.random()*512)-512}
red.update();blue.update();green.update();player.update();},render:function(){bgrdStars.forEach(function(star){star.render()})
blue.render();green.render();red.render();items.forEach(function(item){item.render()});player.render();actualscore.showscore();if(score>=100){loop.stop();console.log(loop.isStopped);win.showwin()}
else if(score<=-50){loop.stop();console.log(loop.isStopped);loss.showloss()}}});kontra.keys.bind('enter',function(){loop.start()})})
