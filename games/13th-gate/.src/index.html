<!doctype html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>13th gate</title><style>body{background:#002b36;margin:0;padding:0;overflow:hidden;color:#e6e6fa;font-family:sans-serif;font-variant:small-caps}body>div{background:#002b36;position:absolute;top:0;width:100vw;height:100vh;display:grid;opacity:0;pointer-events:none;grid-template:30% 40% 20% 1fr/1fr 50% 1fr;grid-template-areas:"l t r" ". c ." " . b ." ". h .";transition:1s}canvas{transition:1s}#splash{background:0 0}#splash button{border-color:tomato;color:tomato}#win{background:#990}#intro>div{grid-area:c;text-align:center;font-size:5vb}#intro>div>div{opacity:0;transition:opacity 1s ease-in-out}#intro.active>div>div:first-child{opacity:1;transition-delay:0.5s}#intro.active>div>div:nth-child(2){opacity:1;transition-delay:2s}#intro.active>div>div:nth-child(3){opacity:1;transition-delay:5s}#intro.active>div>div:nth-child(4){opacity:1;transition-delay:6.5s}#win>div{grid-area:c;font-size:5vw;text-align:center}.active{opacity:1;pointer-events:auto}button{background:0 0;border:2px solid #e6e6fa;font-size:15vb;color:#e6e6fa;border-radius:5px;grid-area:b;font-weight:100}button:hover{border-color:#ff0!important}button[disabled]{color:#a9a9a9;border-color:#9a9a9a}#t{grid-area:t;display:flex;justify-content:center;align-items:center;font-size:5vw}strong{color:tomato}#ls{grid-area:c;display:flex;justify-content:space-around;text-align:center}#ls button{display:block;margin-bottom:5px}#dif{grid-area:b;display:flex;justify-content:space-around;align-items:center}label{border:2px solid #e6e6fa;font-size:1.5vw;width:10vw;height:8vh;display:grid;place-items:center}label:has(> :checked){border-color:#ff0}input{display:none}#h{grid-area:h;text-align:center;line-height:1.5}kbd{padding:0 5px;background:rgba(0,0,0,.2)}#hud{background:0 0}#hud div{display:grid;place-items:center;border-bottom:2px solid;width:50%;height:50%;font-size:2vw}#hscore{grid-area:l;transform:rotate(-15deg)}#hboosts{grid-area:r;justify-self:end;color:#ff0;transform:rotate(15deg)}#defeat{background:#993b2b}#defeat>div{grid-area:c;font-size:10vw;text-align:center}#debug{position:fixed;z-index:1000;right:50px;bottom:50px;background:#000}#debug *{display:block}</style><script type="module">var ct=`#version 300 es
precision highp float;in vec4 pos,col,uv,normal;uniform mat4 pv,eye,m,im;uniform vec4 bb;out vec4 v_pos,v_col,v_uv,v_normal;void main(){gl_Position=pv*(v_pos=bb.z>0.? m[3]+eye*(pos*bb): m*pos);v_col=col;v_uv=uv;v_normal=transpose(inverse(m))*normal;}`,lt=`#version 300 es
precision highp float;in vec4 v_pos,v_col,v_uv,v_normal;uniform vec3 light;uniform vec4 o;uniform sampler2D sampler;out vec4 c;void main(){c=mix(texture(sampler,v_uv.xy),v_col,o[3]);if(o[1]>0.){if(o[0]>0.){c=vec4(c.rgb*(max(dot(light,-normalize(vec3(v_normal.xyz))),0.0)+o[2]),c.a);}else{c=vec4(c.rgb*(max(dot(light,-normalize(cross(dFdx(v_pos.xyz),dFdy(v_pos.xyz)))),0.0)+o[2]),c.a);}}}`;class Q{#r=!1;current={};#t={};#o={};#d=0;#n="#000000";#i={};constructor(t){this.#r=t.debug,this.canvas=t.canvas,this.#n=t.clearColor||this.#n,this.gl=this.canvas.getContext("webgl2"),this.gl.blendFunc(770,771),this.gl.activeTexture(33984),this.#f(),this.gl.useProgram(this.program),this.#r&&console.log("program:",this.gl.getProgramInfoLog(this.program)||"OK"),this.gl.clearColor(...this.col(this.#n)),this.gl.enable(2929),this.light(t.light||{y:-1}),this.camera(t.camera||{fov:30}),this.ambient(t.ambient||.2);for(let i in t.geometry)this.#i[i]=t.geometry[i],this.#i[i].normals&&(this.#i[i].customNormals=1)}#h(t,i){const s=this.gl.createShader(t);return this.gl.shaderSource(s,i),this.gl.compileShader(s),this.#r&&console.log("shader:",this.gl.getShaderInfoLog(s)||"OK"),s}#f(){this.program=this.gl.createProgram(),this.gl.attachShader(this.program,this.#h(35633,ct)),this.gl.attachShader(this.program,this.#h(35632,lt)),this.gl.linkProgram(this.program)}#s(t,i,s){t.id||="o"+this.#d++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!this.#o[t.t.id]&&(s=this.gl.createTexture(),this.gl.pixelStorei(37441,!0),this.gl.bindTexture(3553,s),this.gl.pixelStorei(37440,1),this.gl.texImage2D(3553,0,6408,6408,5121,t.t),this.gl.generateMipmap(3553),this.#o[t.t.id]=s),t.fov&&(this.projection=new DOMMatrix([1/Math.tan(t.fov*Math.PI/180)/(this.canvas.width/this.canvas.height),0,0,0,0,1/Math.tan(t.fov*Math.PI/180),0,0,0,0,-1001/999,-1,0,0,-2002/999,0])),t={type:i,...this.current[t.id]=this.#t[t.id]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",o:1,mode:4,mix:0},...t,f:0};const r=this.#i[t.type];r&&(r.vertices&&!r.verticesBuffer&&(this.gl.bindBuffer(34962,r.verticesBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(r.vertices),35044),r.normals&&(this.gl.bindBuffer(34962,r.normalsBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(r.normals.flat()),35044))),r.uv&&!r.uvBuffer&&(this.gl.bindBuffer(34962,r.uvBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(r.uv),35044)),r.indices&&!r.indicesBuffer&&(this.gl.bindBuffer(34963,r.indicesBuffer=this.gl.createBuffer()),this.gl.bufferData(34963,new Uint16Array(r.indices),35044))),t.t?t.t&&!t.mix&&(t.mix=0):t.mix=1,this.#t[t.id]=t}draw(t){this.#t.camera?.g&&this.#a(this.#t[this.#t.camera.g],t,1);const i=this.#c("camera");this.#t?.camera?.g&&i.preMultiplySelf(this.#t[this.#t.camera.g].M||this.#t[this.#t.camera.g].m),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"eye"),!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(this.projection),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"pv"),!1,i.toFloat32Array()),this.gl.clear(16640);const s=[];for(let r in this.#t)!this.#t[r].t&&this.col(this.#t[r].b,this.#t[r].o)[3]===1?this.#a(this.#t[r],t):s.push(this.#t[r]);s.sort((r,o)=>this.#l(o)-this.#l(r)),this.gl.enable(3042);for(let r of s)["plane","billboard"].includes(r.type)&&this.gl.depthMask(0),this.#a(r,t),this.gl.depthMask(1);this.gl.disable(3042),this.gl.uniform3f(this.gl.getUniformLocation(this.program,"light"),this.#e("light","x"),this.#e("light","y"),this.#e("light","z"))}#a(t,i){if(t.t&&(this.gl.bindTexture(3553,this.#o[t.t.id]),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"sampler"),0)),t.f<t.a&&(t.f+=i),t.f>t.a&&(t.f=t.a),this.#t[t.id].m=this.#c(t.id),this.#t[t.g]&&this.#t[t.id].m.preMultiplySelf(this.#t[t.g].M||this.#t[t.g].m),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"m"),!1,(this.#t[t.id].M||this.#t[t.id].m).toFloat32Array()),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"im"),!1,new DOMMatrix(this.#t[t.id].M||this.#t[t.id].m).invertSelf().toFloat32Array()),["camera","light","group"].includes(t.type))return;let s;this.gl.bindBuffer(34962,this.#i[t.type].verticesBuffer),this.gl.vertexAttribPointer(s=this.gl.getAttribLocation(this.program,"pos"),3,5126,!1,0,0),this.gl.enableVertexAttribArray(s),this.#i[t.type].uvBuffer&&(this.gl.bindBuffer(34962,this.#i[t.type].uvBuffer),this.gl.vertexAttribPointer(s=this.gl.getAttribLocation(this.program,"uv"),2,5126,!1,0,0),this.gl.enableVertexAttribArray(s)),(t.s||this.#i[t.type].customNormals)&&this.#i[t.type].normalsBuffer&&(this.gl.bindBuffer(34962,this.#i[t.type].normalsBuffer),this.gl.vertexAttribPointer(s=this.gl.getAttribLocation(this.program,"normal"),3,5126,!1,0,0),this.gl.enableVertexAttribArray(s)),this.gl.uniform4f(this.gl.getUniformLocation(this.program,"o"),t.s,(t.mode>3||this.gl[t.mode]>3)&&!t.ns?1:0,this.ambientLight||.2,t.mix),this.gl.uniform4f(this.gl.getUniformLocation(this.program,"bb"),t.w,t.h,t.type==="billboard"?1:0,0),this.#i[t.type].indicesBuffer&&this.gl.bindBuffer(34963,this.#i[t.type].indicesBuffer),this.gl.vertexAttrib4fv(this.gl.getAttribLocation(this.program,"col"),this.col(t.b,t.o)),this.#i[t.type].indicesBuffer?this.gl.drawElements(+t.mode||this.gl[t.mode],this.#i[t.type].indices.length,5123,0):this.gl.drawArrays(+t.mode||this.gl[t.mode],0,this.#i[t.type].vertices.length/3)}#e=(t,i)=>this.#t[t]?.a?this.current[t][i]+(this.#t[t][i]-this.current[t][i])*(this.#t[t].f/this.#t[t].a):this.#t[t][i];#c=(t,i=new DOMMatrix)=>this.#t[t]?i.translateSelf(this.#e(t,"x"),this.#e(t,"y"),this.#e(t,"z")).rotateSelf(this.#e(t,"rx"),this.#e(t,"ry"),this.#e(t,"rz")).scaleSelf(this.#e(t,"w"),this.#e(t,"h"),this.#e(t,"d")):i;#l=(t,i=this.#t.camera)=>t?.m&&i?.m?(i.m.m41-t.m.m41)**2+(i.m.m42-t.m.m42)**2+(i.m.m43-t.m.m43)**2:0;ambient=t=>this.ambientLight=t;col=(t,i=1)=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(s=>("0x"+s)/(t.length<5?15:255)),i];add(t,i){this.#s(i,t)}group(t){this.#s(t,"group")}move(t,i){i?setTimeout(()=>{this.#s(t)},i):this.#s(t)}delete(t,i){setTimeout(()=>{this.#t[t].type==="group"&&Object.keys(this.#t).filter(s=>this.#t[s].g===t).forEach(s=>this.delete(s)),delete this.#t[t]},i||1)}camera(t,i){i?setTimeout(()=>{this.#s(t,t.id="camera")},i):this.#s(t,t.id="camera")}light(t,i){i?setTimeout(()=>{this.#s(t,t.id="light")},i):this.#s(t,t.id="light")}}const dt={vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]},ft={vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]},ut={vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]},mt=((e,t,i,s,r,o,n=[],d=[],h=[],a=15)=>{for(i=0;i<=a;i++)for(s=i*Math.PI/a,e=0;e<=a;e++)t=e*2*Math.PI/a,n.push(+(Math.sin(t)*Math.sin(s)/2).toFixed(6),+(Math.cos(s)/2).toFixed(6),+(Math.cos(t)*Math.sin(s)/2).toFixed(6)),h.push(Math.sin(e/a)*3.5,-Math.sin(i/a)),e<a&&i<a&&(r=i*(a+1)+e,o=r+(a+1),d.push(r,o,r+1,r+1,o,o+1));return{vertices:n,uv:h,indices:d}})();function C(e,t,i=1,s=0,r=0){const o=document.createElement("canvas"),n=300;o.width=o.height=n,o.id=self.crypto.randomUUID();const d=o.getContext("2d"),h=d.createLinearGradient(0,0,i?0:n,i&&n);return s?(h.addColorStop(0,e),h.addColorStop(.5-s/2,e),h.addColorStop(.5-s/2,t),h.addColorStop(.5+s/2,t),h.addColorStop(.5+s/2,e),h.addColorStop(1,e)):(h.addColorStop(0,e),h.addColorStop(1,t)),d.fillStyle=h,d.fillRect(0,0,n,n),r&&(document.body.appendChild(o),o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.zIndex=100),o}const gt=(e,t,i)=>Math.min(Math.max(e,t),i);let pt=0;const X=e=>e[0]+pt++,H=()=>JSON.parse(localStorage.getItem(j)||'""')||{score:[]},Y=e=>{localStorage.setItem(j,JSON.stringify(e))},yt=(e,t,i)=>(1-i)*e+i*t;function vt(e,t){for(let i=e.length-1;i>=0;i--){const s=Math.floor(t.f(1)*(i+1));[e[i],e[s]]=[e[s],e[i]]}}const W=e=>Math.sqrt(1-Math.pow(e-1,2));function z(e){function t(){e|=0,e=e+2654435769|0;let i=e^e>>>16;return i=Math.imul(i,569420461),i=i^i>>>15,i=Math.imul(i,1935289751),((i=i^i>>>15)>>>0)/4294967296}return{n:i=>Math.floor(t()*(i+1)),n1:i=>Math.floor(t()*(i+1)+1),f:i=>t()*i,r:(i,s)=>Math.floor(t()*(s-i+1))+i}}const U={body:{vertices:[2.6,.58,10,2.9,.55,10,2.9,.76,10,2.6,.72,10,2.03,1.3,0,0,.87,0,2.03,0,0,0,.44,0,2.9,.55,10,2.6,.58,10,3.5,.58,10,6.1,.44,0,6.1,.87,0,3.5,.72,10,0,.44,0,0,.87,0,4.07,1.3,0,6.1,.87,0,6.1,.44,0,4.07,0,0,3.2,.55,10,3.5,.58,10,3.2,.76,10,3.2,.55,10].map(e=>e/10),uv:[.38,0,.46,0,.46,.25,.38,.25,.46,.5,.38,.5,.46,.75,.38,.75,.46,1,.38,1,.63,0,.88,0,.88,.25,.63,.25,.13,0,.13,.25,.54,.5,.63,.5,.63,.75,.54,.75,.54,1,.63,1,.54,.25,.54,0],indices:[0,1,2,0,2,3,3,2,4,3,4,5,5,4,6,5,6,7,7,6,8,7,8,9,10,11,12,10,12,13,14,0,3,14,3,15,16,17,18,16,18,19,20,19,18,20,18,21,22,23,10,22,10,13,16,22,13,16,13,17,4,16,19,4,19,6,2,1,23,2,23,22,8,6,19,8,19,20,4,2,22,4,22,16]},fin:{vertices:[3.08,1.2,7.02,.48,4.84,1.42,.12,4.84,1.44,2.45,1.2,7.02,.35,4.84,0,0,4.84,.02,2.53,1.84,1.47,1.6,1.84,1.47,3.08,1.2,7.02,2.45,1.2,7.02,0,4.84,.02,1.6,1.84,1.47,2.53,1.84,1.47,.35,4.84,0,4.18,.3,9.9,3.31,1.32,8.25,2.29,1.11,8.32,2.74,0,10,2.43,2.13,.92,1.42,1.92,.99,3.32,.77,1.79,1.88,.47,1.89,1.42,1.92,.99,1.88,.47,1.89,3.32,.77,1.79,2.43,2.13,.92].map(e=>e/10),uv:[.38,0,.38,.25,.63,.25,.63,0,.38,.5,.63,.5,.38,.75,.63,.75,.38,1,.63,1,.88,.25,.88,0,.13,0,.13,.25,.38,0,.38,.25,.63,.25,.63,0,.38,.5,.63,.5,.38,.75,.63,.75,.88,.25,.88,0,.13,0,.13,.25],indices:[0,1,2,0,2,3,1,4,5,1,5,2,4,6,7,4,7,5,6,8,9,6,9,7,3,2,10,3,10,11,12,13,1,12,1,0,14,15,16,14,16,17,15,18,19,15,19,16,18,20,21,18,21,19,17,16,22,17,22,23,24,25,15,24,15,14]},wing:{vertices:[7.73,.1,10,7.73,.46,10,5.37,.43,7.35,5.37,.14,7.35,5.33,.57,.85,3.55,.5,.56,5.33,0,.85,3.55,.07,.56,7.73,.1,10,5.37,.14,7.35,.65,.21,2.05,.65,.36,2.05,0,.36,0,0,.21,0,1.78,.43,.28,1.78,.14,.28,0,.21,0,0,.36,0,3.01,.17,4.7,.65,.21,2.05,3.01,.39,4.7,3.01,.17,4.7].map(e=>e/10),uv:[.38,0,.38,.25,.46,.25,.46,0,.38,.5,.46,.5,.38,.75,.46,.75,.38,1,.46,1,.63,0,.63,.25,.88,.25,.88,0,.54,.5,.54,.75,.63,.75,.63,.5,.54,1,.63,1,.54,.25,.54,0],indices:[0,1,2,0,2,3,1,4,5,1,5,2,4,6,7,4,7,5,6,8,9,6,9,7,10,11,12,10,12,13,14,15,16,14,16,17,18,19,16,18,16,15,20,11,10,20,10,21,14,17,11,14,11,20,5,7,15,5,15,14,9,18,15,9,15,7,2,20,21,2,21,3,5,14,20,5,20,2]}},j="js13k13gate8bdb3b08a930",xt=5,Ft=[.1,.25,.5],bt=[.75,1,1.25],K=300,E=10,tt=2,R=10,Mt=20,zt=3,$=12,b=.25,wt=1e3,q={clearColor:"#002B36",debug:!0,light:{x:-.3,y:.9,z:-.9},camera:{z:1.2,y:-2.5,rx:80,fov:30},ambient:.1,geometry:{sphere:mt,plane:ft,cube:dt,pyramid:ut,shipBody:U.body,shipFin:U.fin,shipWing:U.wing}},At={alive:!0,x:0,y:0,z:b,boosts:0,score:0,turn:0,vz:0,lastFrame:0},G=10*60*1e3,w=[[,,1,,1,1,1,,2,2,2,,2,,2],[,1,1,,,,1,,,2,,,2,2,2],[,,1,,,1,1,,,2,,,2,,2],[,,1,,,,1,,,,,,,,],[,,1,,1,1,1,,,,,,,,],[,,,,,,,,,,,,,,],[2,2,2,,2,2,2,,2,2,2,,2,2,2],[2,,,,2,,2,,,2,,,2,,],[2,,2,,2,2,2,,,2,,,2,2],[2,,2,,2,,2,,,2,,,2,,],[2,2,2,,2,,2,,,2,,,2,2,2]],St=[()=>z(2),()=>z(3),()=>z(3),()=>z(6),()=>z(0),()=>z(Math.random()*2**32>>>0)],it=(e,t)=>{e.group({id:"ship"}),e.group({id:"shipPivot",g:"ship",y:-.25,z:.05});const i=C("#00FFFF","#FFA500",0,.081);e.add("shipBody",{id:"body",g:"shipPivot",x:-.305,z:0,rx:-90,b:"#00FFFF",t:i}),e.add("shipFin",{id:"fin1",g:"shipPivot",x:.3,z:-.045,rx:90,rz:180,b:"#00FFFF",size:.5}),e.add("shipFin",{id:"fin2",g:"shipPivot",x:-.3,z:-.045,rx:90,rz:180,b:"#00FFFF",w:-.5,h:.5,d:.5}),e.add("shipFin",{id:"fin3",g:"shipPivot",x:.3,z:-.045,rx:90,rz:180,b:"#00FFFF",w:.5,h:-.5,d:.5}),e.add("shipFin",{id:"fin4",g:"shipPivot",x:-.3,z:-.045,rx:90,rz:180,b:"#00FFFF",w:-.5,h:-.5,d:.5}),e.add("shipWing",{id:"wing1",g:"shipPivot",x:-.55,z:-.05,rx:-90,b:"#00FFFF",t:i,size:.5}),e.add("shipWing",{id:"wing2",g:"shipPivot",x:.55,z:-.05,rx:-90,b:"#00FFFF",t:i,w:-.5,h:.5,d:.5}),e.add("pyramid",{id:"canopy",g:"shipPivot",x:0,y:.42,z:-.038,rx:-4,b:"#191970",t:C("#191970","#2F4F4F",1),w:.12,h:.5,d:.075});const s={rx:180,w:.07,d:.07,h:.2,z:-.06,y:-.1,b:"#ffff00",o:.15};e.add("pyramid",{g:"shipPivot",id:"flame1",...s,x:.18}),e.add("pyramid",{g:"shipPivot",id:"flame2",...s,x:-.18})},V=(e,t,i)=>{const s=X`boost`;return e.group({id:s,x:t,y:i}),e.group({id:s+"p",g:s}),e.add("pyramid",{g:s+"p",z:.4,b:"#FFFF00AA",rx:90,rz:45,w:.5,d:.5,h:.4}),e.add("pyramid",{g:s+"p",z:0,b:"#FFFF00AA",rx:90,rz:45,w:.5,d:.5,h:-.4}),e.move({id:s+"p",rz:.2*G,a:G}),{id:s,x:t,y:i,t:"boost",s:"sphere",r:.375,z:.25}},Lt=C("#8A2BE2","#E6E6FA"),Bt=(e,t,i,s=2,r=3)=>{const o=X`spike`;return e.add("pyramid",{id:o,x:t,y:i,z:r/2-.01,rx:90,b:"#ff00ff",w:s,h:r,d:s,t:Lt}),{id:o,x:t,y:i,z:0,t:"wall",s:"pyramid",r:s,h:r}},Pt=(e,t,i,s,r)=>{const o="gate"+t;return e.group({id:o,x:i,y:s,z:r}),e.add("cube",{id:o+"c",g:o,z:13,b:"#FF6347",o:0,d:26,w:3,h:3}),{id:o,x:i,y:s,z:r,s:"box",w:3,h:26,d:3,t:"wall"}},et=(e,t=K)=>{e.add("plane",{id:"floor",x:0,y:t/2,z:0,b:"#E6E6FA",w:39,h:t,t:C("#D3D3D3","#E6E6FA",0,.85)})},It=(e,t)=>{e.add("plane",{id:"exit",x:0,y:t-1,z:13,b:"#FFFF00",rx:90,w:13*3,h:13*2})},kt=([e,t],i,s)=>{const r=s.r(2,3),o=s.r(3,5);return[[e,t-3,r,o],[e-3,t,r,o],[e+3,t,r,o],[e,t+3,r,o]].slice(0,i)},Dt=([e,t],i,s)=>Array.from({length:i},(r,o)=>[e+s.r(-1,1),t+s.r(-1,1),s.r(3,4),s.r(4,5)]),Et=([e,t],i,s)=>{const r=s.n(1);return Array.from({length:i},(o,n)=>{const d=s.r(2,3);return[e+n*(r?2:-2),t+n*d,d,3+n*.5]})},J=[Dt,Et,kt],qt=(e,t,i)=>{const s=[],r=[],o=E*3,n=K*(1+.2*(e-1)),d=e*2,h=Array.from({length:d+1}).fill(n/(d+1)).map((l,c)=>l/(E+tt*c)).reduce((l,c)=>l+c,0)*1e3;et(t,n),It(t,n),s.push(V(t,0,E*2));for(let l=1;l<(n-o)/15;l++)s.push(V(t,i.r(-8,8),o+l*20));const a=l=>{const c=i.r(2,2+e),g=[],y=J[i.n(J.length-1)];g.push(...y(l,c,i)),g.forEach(([F,k,D,O])=>s.push(Bt(t,F,k,D,O)))};for(let l=0;l<(n-o)/(25-e);l++){const c=o+(25-e)*l;switch(l%3){case 0:a([i.r(-14,-5),c]),a([i.r(-5,5),c+5]),a([i.r(5,14),c]);break;case 1:a([i.r(-14,-5),c]),a([i.r(5,14),c]);break;case 2:a([i.r(-14,-5),c]),a([i.r(-5,5),c-5]),a([i.r(5,14),c]);break}}const u=[];for(let l=0;l<13;l++)u.push(l);vt(u,i);const m=h/26,f=h/13*1.5,p=(h-f)/12;return u.forEach((l,c)=>{s.push(Pt(t,l,l*3-13*3/2+1.5,n,30+c*5));const g=m+p*c;r.push({id:"gate"+l+"c",key:"o",from:0,delta:1,duration:f*.2,delay:g,progress:0}),r.push({id:"gate"+l,key:"z",from:20+c*2,delta:-(20+c*2),duration:f,delay:g,progress:0})}),[s.sort((l,c)=>l.y-c.y),r]},_={explosion:e=>e>4e4?null:Math.sin(e/200-Math.sin(e/331)*Math.sin(e/61)+Math.sin(Math.sin(e/59)/39)*33)*Ct(e,4e4)*9,boost:e=>Math.sin(e/20)*Math.cos(Math.sqrt(e)/5)*Math.exp(-e/2e4),jump:e=>Math.sin(e/100+Math.random()*50)*Math.exp(-e/8e3),fall:e=>Math.sin(e*e/1e6)*Math.exp(-e/2e3)*9},Ct=(e,t)=>(t-e)/t,T=e=>{const t=new AudioContext,i=t.createGain();i.gain.value=.2;const s=t.createBuffer(1,96e3,48e3),r=s.getChannelData(0);for(let n=96e3;n--;)r[n]=e(n);const o=t.createBufferSource();return o.buffer=s,o.connect(i),i.connect(t.destination),o.start(),o},I={direction:0,jump:!1},v={ArrowLeft:0,KeyA:0,KeyD:0,ArrowRight:0,Space:0},st=()=>{I.jump=!!v.Space,I.direction=Math.sign(Math.max(v.ArrowRight,v.KeyD)-Math.max(v.ArrowLeft,v.KeyA))};document.addEventListener("keydown",e=>{v[e.code]=Date.now(),st()});document.addEventListener("keyup",e=>{v[e.code]=0,st()});document.addEventListener("blur",()=>{for(let e in v)v[e]=0});function _t(e,t,i,s){t.y+=(E+t.boosts*tt)*e;const r=Mt*(1.2-s/10)*e;I.direction?t.turn=gt(t.turn+r*I.direction,-R,R):t.turn&&(Math.abs(t.turn)<r?t.turn=0:t.turn-=r*Math.sign(t.turn));const o=Math.abs(t.x);o>18&&t.turn*t.x>0&&(t.turn*=o>19?0:1-o%18/3),t.x+=t.turn*e,I.jump&&t.z<=b&&t.boosts&&(t.vz=$,t.boosts-=1,T(_.jump)),t.vz=Math.max(-50,t.vz-10*e);const n=t.z+t.vz*e;t.z>b&&n<=b&&T(_.fall),t.z=Math.max(b,n),i.move({id:"shipPivot",ry:t.turn*zt,rx:yt(i.current.shipPivot.rx,t.z>b?t.vz/$*15:0,.2)}),i.move({id:"ship",x:t.x,y:t.y,z:t.z})}function Tt(e,t){let i=null,s=0;for(;s<t.length&&e.y+.25>t[s].y-xt;){if({sphere:()=>rt(e,t[s])<=e.r+t[s].r,pyramid:()=>Ot(e,t[s]),box:()=>Ut(e,t[s])}[t[s].s]()){i=t[s];break}s+=1}for(;t.length&&t[0].y+(t[0].r||t[0].d/2)<e.y-e.r;)t.shift();return i}const rt=({x:e,y:t,z:i},{x:s,y:r,z:o})=>x([e,t,i],[s,r,o]),Ot=({x:e,y:t,z:i,r:s},{x:r,y:o,r:n,h:d})=>{if(rt({x:e,y:t,z:i},{x:r,y:o,z:0})>Math.max(n/2*1.5,i>b?d:0)+s)return!1;const h=n/2,a=[r,o,d],u=[r-h,o-h,0],m=[r+h,o-h,0],f=[r+h,o+h,0],p=[r-h,o+h,0];return Math.min(N([e,t,i],[a,u,m]),N([e,t,i],e>r?[a,m,f]:[a,u,p]))<s},Ut=({x:e,y:t,z:i,r:s},{x:r,y:o,z:n,w:d,h,d:a})=>Ht([e,t,i],[r-d/2,o-a/2,n,r+d/2,o+a/2,n+h])<s;function N(e,t){const[i,s,r,o]=[e,...t],n=A(r,s),d=A(o,s),h=A(i,s),a=S(n,h),u=S(d,h);if(a<=0&&u<=0)return x(i,s);const m=A(i,r),f=S(n,m),p=S(d,m);if(f>=0&&p<=f)return x(i,r);const l=a*p-f*u;if(l<=0&&a>=0&&f<=0){const L=a/(a-f);return x(i,B(s,P(n,L)))}const c=A(i,o),g=S(n,c),y=S(d,c);if(y>=0&&g<=y)return x(i,o);const F=g*u-a*y;if(F<=0&&u>=0&&y<=0){const L=u/(u-y);return x(i,B(s,P(d,L)))}const k=f*y-g*p;if(k<=0&&p-f>=0&&g-y>=0){const L=(p-f)/(p-f+(g-y));return x(i,B(r,P(A(o,r),L)))}const D=1/(k+F+l),O=F*D,at=l*D,ht=B(s,B(P(n,O),P(d,at)));return x(i,ht)}function Ht(e,t){const[i,s,r]=e,[o,n,d,h,a,u]=t,m=Math.max(o-i,0,i-h),f=Math.max(n-s,0,s-a),p=Math.max(d-r,0,r-u);return Math.sqrt(m*m+f*f+p*p)}const x=(e,t)=>Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2+(t[2]-e[2])**2),A=(e,t)=>e.map((i,s)=>i-t[s]),B=(e,t)=>e.map((i,s)=>i+t[s]),P=(e,t)=>e.map(i=>i*t),S=(e,t)=>e.reduce((i,s,r)=>i+s*t[r],0),M=document.querySelector("#c");function Kt(e){M.width=window.innerWidth,M.height=window.innerHeight;const t=parseInt(document.querySelector("input:checked").value),i=new Q({canvas:M,...q}),s={...At,r:Ft[t-1]},[r,o]=qt(e,i,St[e-1]()),n=K*(1+.2*(e-1));let d=8e3,h=n/10*1e3,a=0;const u=c=>{a||=c;const g=Math.min(c-a,100);a=c,d-=g,d<0?m():requestAnimationFrame(u)},m=()=>{go("hud"),i.move({id:"camera",g:"ship",y:n-1,z:10}),i.draw(1),i.move({id:"camera",y:q.camera.y,z:q.camera.z,a:h}),requestAnimationFrame(f)},f=c=>{a||=c;const g=Math.min(c-s.lastFrame,100);a=c,h-=g,h<0?requestAnimationFrame(p):(i.draw(g),requestAnimationFrame(f))};it(i,s.r);const p=c=>{s.lastFrame||=c;const g=Math.min(c-s.lastFrame,100);s.lastFrame=c,_t(g/1e3,s,i,t),Z(s.score,s.boosts);let y=Tt(s,r);if(y?.t==="boost"&&(s.boosts+=1,s.score+=wt*bt[t],r.splice(r.findIndex(F=>F.id===y.id),1),i.move({id:y.id,z:.5,size:.5,a:50}),i.delete(y.id,50),Z(s.score,s.boosts),T(_.boost)),y?.t==="wall"){Rt();return}if(s.y>=n){Wt(e,s.score);return}$t(o,r,i,g),ot(i,c,s.boosts),i.draw(g),requestAnimationFrame(p)},l=H();l.seenIntro?m():(l.seenIntro=!0,Y(l),go("intro"),requestAnimationFrame(u))}document.querySelector("#ls").addEventListener("click",e=>{const t=e.target.dataset?.level;t&&Kt(parseInt(t,10))});function Wt(e,t){const i=H();i.score[e-1]=t,Y(i),document.querySelector("#score").innerHTML=t,nt(),go("win")}function Rt(){T(_.explosion),go("defeat")}function $t(e,t,i,s){e.forEach(r=>{if(!(r.progress>=r.duration)){if(r.delay>0){r.delay-=s;return}r.progress+=s,i.move({id:r.id,[r.key]:r.from+r.delta*W(r.progress/r.duration)}),["x","y","z"].includes(r.key)&&(t.find(o=>o.id===r.id)[r.key]=r.from+r.delta*W(r.progress/r.duration))}})}function ot(e,t,i=1){const s=Math.sin(t/150)*.015+.02*i;e.move({id:"flame1",h:.15+s,y:-s/2-.1}),e.move({id:"flame2",h:.15+s,y:-s/2-.1})}window.go=function(t){const[i,s]=document.querySelectorAll(`.active,#${t}`);M.style.opacity=t==="hud"?"1":"0",i.classList.toggle("active"),s.classList.toggle("active"),document.querySelectorAll("button").forEach(r=>r.blur())};function nt(){const e=document.querySelector("#ls"),t=H();let i="";for(let s=0;s<6;s++)i+=`<div><button data-level="${s+1}"${s>0&&!t.score[s-1]?"disabled":""}>${s===5?"?":s+1}</button>${t.score[s]||"Not Passed"}</div>`;e.innerHTML=i}nt();function Z(e,t){const[i,s]=document.querySelectorAll("#hscore,#hboosts");i.innerHTML=e,s.innerHTML=t+"  &#9671;"}function Gt(){M.width=window.innerWidth,M.height=window.innerHeight;const e=window.innerWidth/window.innerHeight;let[t,i,s,r,o,n,d]=[2.5,-2,2,68,-19,28,27];d*=1+Math.max(0,1.5-e);const h={x:t,y:i,z:s,rx:r,fov:d,ry:o,rz:n},a=new Q({canvas:M,...q,camera:h});it(a),et(a,1e3),a.move({id:"floor",w:22,y:-10}),a.group({id:"logo",y:50,z:w.length,x:-w[0].length/2+1});for(let m=0;m<w.length;m+=1)for(let f=0;f<w[0].length;f+=1)w[m][f]&&a.add("cube",{g:"logo",x:f,z:-m,b:[,"f00","fff"][w[m][f]]});const u=m=>{ot(a,m),a.draw(1),document.querySelector("#splash").classList.contains("active")&&requestAnimationFrame(u)};requestAnimationFrame(u)}Gt();
</script></head><body><main id="debug"></main><canvas id="c"></canvas><div id="splash" class="active"><button onclick="go('menu')">Start</button></div><div id="intro"><div><div>When 13th gates closes</div><div>all hope will be lost.</div><div>But with enough speed</div><div>you will glide through.</div><br/></div></div><div id="win"><div>Escape<div id="score"></div></div><button onclick="go('menu')">Continue</button></div><div id="defeat"><div>Death</div><button onclick="go('menu')">Return</button></div><div id="hud"><div id="hscore"></div><div id="hboosts"></div></div><div id="menu"><div id="t"><strong>13</strong>th gate</div><div id="ls"></div><div id="dif"><label><input type="radio" value="1" name="dif"/>Easy</label> <label><input type="radio" value="2" name="dif" checked="checked"/>Normal</label> <label><input type="radio" value="3" name="dif"/>Hard</label></div><div id="h"><kbd>←</kbd>, <kbd>→</kbd> or <kbd>A</kbd>, <kbd>D</kbd> to strafe<br/><kbd>Space</kbd> to jump by consuming a boost</div></div><div id="title">13th gate</div></body></html>