"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _construct(t,e,n){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var o=new(Function.bind.apply(t,r));return n&&_setPrototypeOf(o,n.prototype),o}).apply(null,arguments)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var rooms=new Map,playerNonce=0,projectileNonce=0,map_1='[{"type":"Starting","args":[50,40,50,800,1050,800,1050,40]},{"type":"Floor","args":[550,420,790,1040]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[150,400,20,250]},{"type":"Wall","args":[945,400,20,240]},{"type":"Wall","args":[540,680,260,20]},{"type":"Wall","args":[540,150,260,20]},{"type":"Wall","args":[120,165,130,20]},{"type":"Wall","args":[975,165,130,20]},{"type":"Wall","args":[920,100,20,130]},{"type":"Wall","args":[175,100,20,130]},{"type":"Wall","args":[120,680,130,20]},{"type":"Wall","args":[975,680,130,20]},{"type":"Wall","args":[180,735,20,140]},{"type":"Wall","args":[915,735,20,140]},{"type":"GroundShotgun","args":[150,136]},{"type":"GroundShotgun","args":[900,130]},{"type":"GroundShotgun","args":[900,670]},{"type":"GroundShotgun","args":[150,670]},{"type":"GroundMachineGun","args":[536,400]}]',map_2='[{"type":"Starting","args":[50,40,50,800,1050,800,1050,40]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[410,250,280,20]},{"type":"Wall","args":[670,250,280,20]},{"type":"Wall","args":[540,555,20,575]},{"type":"Wall","args":[265,477,137,20]},{"type":"Wall","args":[815,477,137,20]},{"type":"GroundSmg","args":[480,420]},{"type":"GroundSmg","args":[570,420]},{"type":"GroundShotgun","args":[290,500]},{"type":"GroundShotgun","args":[750,500]}]',map_3='[{"type":"Starting","args":[550,240,400,380,700,380,550,530]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[550,385,260,280]},{"type":"GroundShotgun","args":[55,35]},{"type":"GroundShotgun","args":[55,750]},{"type":"GroundShotgun","args":[1000,750]},{"type":"GroundShotgun","args":[1000,35]}]',map_4='[{"type":"Starting","args":[110,50,260,50,850,50,980,50]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[200,372,700,20]},{"type":"Wall","args":[565,460,705,20]},{"type":"Wall","args":[905,372,700,20]},{"type":"GroundMachineGun","args":[885,745]},{"type":"GroundMachineGun","args":[180,745]},{"type":"GroundSmg","args":[540,70]}]',map_5='[{"type":"Starting","args":[145,370,415,370,712,370,960,370]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[270,372,700,20]},{"type":"Wall","args":[565,460,705,20]},{"type":"Wall","args":[840,372,700,20]},{"type":"GroundMachineGun","args":[820,745]},{"type":"GroundMachineGun","args":[245,745]},{"type":"GroundMachineGun","args":[550,40]}]',map_6='[{"type":"Starting","args":[520,365,580,365,520,450,580,450]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[555,200,20,480]},{"type":"Wall","args":[305,396,412,20]},{"type":"Wall","args":[805,396,412,20]},{"type":"Wall","args":[555,612,20,520]},{"type":"GroundShotgun","args":[340,200]},{"type":"GroundShotgun","args":[720,200]},{"type":"GroundShotgun","args":[340,550]},{"type":"GroundShotgun","args":[720,550]}]',map_7='[{"type":"Starting","args":[280,180,800,280,280,740,850,740]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[535,393,500,20]},{"type":"Wall","args":[540,370,20,780]},{"type":"GroundSmg","args":[150,136]},{"type":"GroundShotgun","args":[900,130]},{"type":"GroundSmg","args":[900,670]},{"type":"GroundShotgun","args":[150,670]},{"type":"GroundMachineGun","args":[560,400]}]',map_8='[{"type":"Starting","args":[50,40,50,800,1050,800,1050,40]},{"type":"Floor","args":[550,420,790,1040]},{"type":"Wall","args":[30,420,820,20]},{"type":"Wall","args":[550,820,20,1035]},{"type":"Wall","args":[1075,420,820,20]},{"type":"Wall","args":[552,15,20,1065]},{"type":"Wall","args":[150,400,20,250]},{"type":"Wall","args":[945,400,20,240]},{"type":"Wall","args":[540,680,260,20]},{"type":"Wall","args":[540,150,260,20]},{"type":"Wall","args":[120,165,130,20]},{"type":"Wall","args":[975,165,130,20]},{"type":"Wall","args":[920,100,20,130]},{"type":"Wall","args":[175,100,20,130]},{"type":"Wall","args":[120,680,130,20]},{"type":"Wall","args":[975,680,130,20]},{"type":"Wall","args":[180,735,20,140]},{"type":"Wall","args":[915,735,20,140]},{"type":"GroundSmg","args":[150,136]},{"type":"GroundSmg","args":[900,130]},{"type":"GroundSmg","args":[900,670]},{"type":"GroundSmg","args":[150,670]},{"type":"GroundMachineGun","args":[536,400]}]',Room=function(t){function n(t){var e;return _classCallCheck(this,n),(e=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,0,0,0,0,0))).actors=new Map,e.phase="LOBBY",e.round=0,e.roundStartCountdown=0,e.requiredPlayers=2,e.nonce=t,e.environment=new Environment(_assertThisInitialized(_assertThisInitialized(e))),e}return _inherits(n,Entity),_createClass(n,[{key:"emit",value:function(t,e){io.in("room_"+this.nonce).emit(t,e)}},{key:"join",value:function(t){t.stats=new Stats(t),this.actors.set(t.nonce,t),2<=this.actors.size&&(this.countdown=15*tick_rate)}},{key:"leave",value:function(t){this.emit("destroy","enemy-"+t),this.actors.delete(t),this.actors.size<this.requiredPlayers&&delete this.countdown}},{key:"startGame",value:function(){this.phase="GAME",this.startRound()}},{key:"endGame",value:function(){var t=Array.from(this.actors.values()),e=t.reduce(function(t,e){var n=e.stats.getGameStats().totalWins;return t<n?n:t},0);t.forEach(function(t){t.stats.getGameStats().totalWins===e&&(t.isWinner=!0)});var n=1<t.filter(function(t){return t.isWinner}).length;this.emit("game-end",Array.from(this.actors.values()).map(function(t){return t.gameStats=t.stats.getGameStats(),t.isWinner&&(t.gameStats.winStatus=n?"TIE":"WINNER"),t.roundStats=t.stats.getRoundStats(),t})),rooms.delete(this.nonce)}},{key:"startRound",value:function(){this.actors.forEach(function(t){return t.stats.resetRoundStats()}),this.round++,this.environment=new Environment(this),this.emit("round-start",{actors:Array.from(this.actors.values()),walls:Array.from(this.environment.walls.values()),groundWeapons:Array.from(this.environment.groundWeapons.values())}),this.phase="GAME"}},{key:"endRound",value:function(){this.roundStartCountdown=200,this.phase="ROUND_STATS",this.actors.forEach(function(t){return t.reset()}),this.emit("round-end",Array.from(this.actors.values()).map(function(t){return t.stats.getRoundStats()}))}},{key:"checkRoundComplete",value:function(){var t=Array.from(this.actors.values()).filter(function(t){return!t.isDead});1===t.length&&(t[0].stats.awardRoundWin(),this.endRound())}},{key:"fireProjectile",value:function(t){var e=this;if(0===t.weaponCooldown){var n=[++projectileNonce,t.x,t.y,t.rotationDegrees,Date.now(),t.nonce],r=[];switch(t.activeWeapon){case"GroundPistol":r=[_construct(PistolProjectile,n)];break;case"GroundShotgun":for(var o=0;o<50;o++)n[0]=projectileNonce++,r.push(_construct(ShotgunProjectile,n));break;case"GroundMachineGun":for(o=0;o<2;o++)n[0]=projectileNonce++,r.push(_construct(MachineGunProjectile,n));break;case"GroundSmg":r=[_construct(SmgProjectile,n)]}t.weaponCooldown=r[0].weaponCooldown,r.forEach(function(t){e.environment.addProjectile(t)}),this.emit("projectile-fire",r)}}},{key:"_roomTick",value:function(){switch(this.phase){case"LOBBY":2<=this.actors.size&&this.countdown--,0===this.countdown&&this.startGame();break;case"ROUND_STATS":if(this.roundStartCountdown--,5===this.round)return void this.endGame();0===this.roundStartCountdown&&this.startRound();break;case"GAME":this.actors.forEach(function(t){return t.tickCooldown()}),this.environment.environmentTick(),this.checkRoundComplete()}}},{key:"asDTO",value:function(){return{nonce:this.nonce,serverTime:serverTime,countdown:this.countdown,actors:_toConsumableArray(this.actors.values()),playerSize:this.actors.length,roomName:this.roomName}}}]),n}(),Stats=function(){function e(t){_classCallCheck(this,e),this.playerNonce=t.nonce,this.roundHits=0,this.roundMisses=0,this.roundKills=0,this.roundWon=null,this.totalWins=0,this.totalHits=0,this.totalMisses=0,this.totalKills=0,this.totalDeaths=0}return _createClass(e,[{key:"awardHit",value:function(){this.roundHits++,this.totalHits++}},{key:"awardMiss",value:function(){this.roundMisses++,this.totalMisses++}},{key:"awardRoundWin",value:function(){this.roundWon=!0,this.totalWins++}},{key:"awardKill",value:function(){this.roundKills++,this.totalKills++}},{key:"awardDeath",value:function(){this.roundWon=!1,this.totalDeaths++}},{key:"resetRoundStats",value:function(){this.roundHits=0,this.roundMisses=0,this.roundKills=0,this.roundWon=null}},{key:"getRoundStats",value:function(){return{nonce:this.playerNonce,roundHits:this.roundHits,roundMisses:this.roundMisses,roundKills:this.roundKills,roundWon:this.roundWon,totalWins:this.totalWins,totalHits:this.totalHits,totalMisses:this.totalMisses,totalKills:this.totalKills,totalDeaths:this.totalDeaths}}},{key:"getGameStats",value:function(){return{nonce:this.playerNonce,totalWins:this.totalWins,totalHits:this.totalHits,totalMisses:this.totalMisses,totalKills:this.totalKills,totalDeaths:this.totalDeaths}}}]),e}();function serverTick(){serverTime=Date.now(),rooms.forEach(function(n){n._roomTick(),n.emit("update-chosen-room",n.asDTO(!0)),n.environment.eventQueue.forEach(function(t,e){n.emit(e,t),n.environment.eventQueue.delete(e)})})}function getBestRoom(){var t=Array.from(rooms.values()).filter(function(t){return"LOBBY"===t.phase&&t.actors.size<4}).reduce(function(t,e){return t?e.players>t.players?rooms.get(e):t:rooms.get(e.nonce)},void 0);return t||(playerNonce++,rooms.set(playerNonce,new Room(playerNonce)),rooms.get(playerNonce))}function loadMaps(){environmentMap[0]=JSON.parse(map_1),environmentMap[1]=JSON.parse(map_2),environmentMap[2]=JSON.parse(map_3),environmentMap[3]=JSON.parse(map_4),environmentMap[4]=JSON.parse(map_5),environmentMap[5]=JSON.parse(map_6),environmentMap[6]=JSON.parse(map_7),environmentMap[7]=JSON.parse(map_8)}function init(){loadMaps(),setInterval(function(){serverTick()},tick_rate)}function getPlayerFromRoom(t,e){return e&&e.actors?e.actors.get(t):null}function getWeaponFromRoom(t,e){return e&&e.environment&&e.environment.groundWeapons?e.environment.groundWeapons.get(t):null}init(),module.exports={io:function(e){var a,s=++playerNonce,n="Player-"+s;e.on("join",function(){a=getBestRoom();var t=new Actor(0,0,"red",n);t.nonce=s,a.join(t),e.join("room_"+a.nonce),e.emit("joined-room",t),e.emit("environment-walls",_toConsumableArray(a.environment.walls.values()))}),e.on("update-name",function(t){n=t}),e.on("update-player",function(t){var e=getPlayerFromRoom(s,a);e&&t.x&&t.y&&(e.x=t.x,e.y=t.y,e.rotationDegrees=t.rotationDegrees)}),e.on("fire-projectile",function(){var t=getPlayerFromRoom(s,a);t&&a.fireProjectile(t)}),e.on("weapon-pickup",function(t){var e=getPlayerFromRoom(s,a),n=getWeaponFromRoom(t,a);if(e&&n&&!e.isDead&&entitiesCollide(e,asCentered(n))){wallNonce++;var r=wallNonce,o=newGunWithNonce(r,e.activeWeapon,[e.x-10,e.y-10]);a.environment.groundWeapons.set(r,o),e.activeWeapon=n.weaponTag,a.emit("weapon-pickup",{nonce:t,playerNonce:s,droppedWeapon:o}),a.environment.groundWeapons.delete(t)}}),e.on("disconnect",function(){getPlayerFromRoom(s,a)&&a.leave(s)})}};