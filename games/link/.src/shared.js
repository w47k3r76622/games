"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _construct(t,e,n){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&_setPrototypeOf(r,n.prototype),r}).apply(null,arguments)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function forObj(e,n){Object.keys(e).forEach(function(t){n(e[t],t)})}function copyProps(e,n){Object.keys(e).forEach(function(t){return n[t]=e[t]})}var abs=Math.abs,wallNonce=0,map_count=8,tick_rate=25,max_health=50,serverTime=0,environmentMap=[],Entity=function t(e,n,i,r,o){_classCallCheck(this,t),this.nonce=null,this.namespace=null,this.x=e,this.y=n,this.height=i,this.width=r,this.hovered=!1,this.isOnScreen=function(){return this._screen===screen},this._screen=o,this._sethover=function(){this.hovered=this.isOnScreen()&&mouseInBounds(this.x,this.y,this.height,this.width)},this._anyclick=function(){this.isOnScreen()&&this.onAnyClick&&this.onAnyClick()},this._click=function(){this.hovered&&this.onClick&&this.onClick()},this._render=function(){this.isOnScreen()&&this.render()},this._mousemove=function(){this.isOnScreen()&&this.onMouseMove&&this.onMouseMove()},this._tick=function(t){this.isOnScreen()&&this.onTick&&this.onTick(t)},this._resize=function(){this.onResize&&this.onResize()},this._keydown=function(t){this["on"+t.toUpperCase()+"Down"]&&this.isOnScreen()&&this["on"+t.toUpperCase()+"Down"]()},this._anykeydown=function(t){this.isOnScreen()&&this.onAnyKeyDown&&this.onAnyKeyDown(t)},this.destroy=function(){delete entities[this.namespace||this.nonce]}};function asCentered(t){return{x:t.width/2+t.x,y:t.height/2+t.y,height:t.height,width:t.width}}function entitiesCollide(t,e){return 2*abs(t.x-e.x)<t.width+e.width&&2*abs(t.y-e.y)<t.height+e.height}function randomIntFromInterval(t,e){return Math.random()*(e-t+1)+t}function newGunWithNonce(t,e,n){var i=newGun(e,n);return i.nonce=t,i}function newGun(t,e){switch(t){case"GroundPistol":return _construct(GroundPistol,_toConsumableArray(e));case"GroundShotgun":return _construct(GroundShotgun,_toConsumableArray(e));case"GroundMachineGun":return _construct(GroundMachineGun,_toConsumableArray(e));case"GroundSmg":return _construct(GroundSmg,_toConsumableArray(e))}}var Environment=function(){function n(t){_classCallCheck(this,n),this.room=t,this.nonce=t.nonce,this.projectiles=new Map,this.eventQueue=new Map;var e=Math.floor(randomIntFromInterval(0,environmentMap.length-1));this.walls=this.buildWalls(e),this.assignStartingPositions(e),this.groundWeapons=this.buildGroundWeapons(e)}return _createClass(n,[{key:"buildWalls",value:function(t){return environmentMap[t].filter(function(t){return"Wall"===t.type}).reduce(function(t,e){var n=++wallNonce;return t.set(n,_construct(Wall,[n].concat(_toConsumableArray(e.args)))),t},new Map)}},{key:"buildGroundWeapons",value:function(t){return environmentMap[t].filter(function(t){return"GroundPistol"===t.type||"GroundShotgun"===t.type||"GroundMachineGun"===t.type||"GroundSmg"===t.type}).reduce(function(t,e){var n=++wallNonce,i=newGunWithNonce(n,e.type,e.args);return t.set(n,i),t},new Map)}},{key:"assignStartingPositions",value:function(t){var n=environmentMap[t].filter(function(t){return"Starting"===t.type})[0],i=0;this.room.actors.forEach(function(t,e){t.x=n.args[i],t.y=n.args[i+1],i+=2})}},{key:"addEventQueue",value:function(t,e){this.eventQueue.has(t)||this.eventQueue.set(t,[]),this.eventQueue.get(t).push(e)}},{key:"environmentTick",value:function(){var s=this;this.projectiles.forEach(function(t,e){var n=s.room.actors.get(t.playerNonce);t.onTick();var i=s.getPlayerColliding(t),r=s.getWallColliding(t),o=0<i.length||0<r.length||Date.now()>=t.fireTime+t.halfLife;0<i.length&&n.stats.awardHit(),0<r.length&&n.stats.awardMiss(),o&&(s.addEventQueue("projectile-collision",{nonce:t.nonce}),s.projectiles.delete(e)),i.forEach(function(t){t.takeDamage(1),t.isDead&&n.stats.awardKill()})})}},{key:"addProjectile",value:function(t){t&&t.nonce&&this.projectiles.set(t.nonce,t)}},{key:"addWall",value:function(t){t&&t.nonce&&this.walls.set(t.nonce,t)}},{key:"getPlayerColliding",value:function(e){return Array.from(this.room.actors.values()).filter(function(t){return!t.isDead&&t.nonce!==e.playerNonce&&entitiesCollide(t,e)})}},{key:"getWallColliding",value:function(e){return Array.from(this.walls.values()).filter(function(t){return entitiesCollide(t,e)})}}]),n}(),Actor=function(t){function o(t,e,n,i){var r;return _classCallCheck(this,o),(r=_possibleConstructorReturn(this,_getPrototypeOf(o).call(this,t,e,20,20,1))).health=max_health,r.activeWeapon="GroundPistol",r.weaponCooldown=0,r.name=i,r.isDead=!1,r.rotationDegrees=0,r.color=n,r.velocity=.15,r.getCallCtx=function(){return{cX:this.width/this.x+27,cY:this.height/-5}},r.render=function(){if(ctx.globalAlpha=this.isDead?.3:1,ctx.fillStyle=this.isDead?"white":this.color,ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.rotationDegrees*Math.PI/180),ctx.fillRect(this.width/this.x-10,this.height/this.y-10,this.width,this.height),!this.isDead)switch(this.activeWeapon){case"GroundPistol":(new GroundPistol).renderWeapon.call(this.getCallCtx());break;case"GroundMachineGun":(new GroundMachineGun).renderWeapon.call(this.getCallCtx());break;case"GroundShotgun":(new GroundShotgun).renderWeapon.call(this.getCallCtx());break;case"GroundSmg":(new GroundSmg).renderWeapon.call(this.getCallCtx())}ctx.fillStyle=this.isDead?"grey":"salmon",ctx.beginPath(),ctx.moveTo(-this.width/2,this.height/2),ctx.lineTo(-this.width/2,-this.height/2),ctx.lineTo(this.width/2,0),ctx.fill(),ctx.restore(),ctx.globalAlpha=1},r}return _inherits(o,Entity),_createClass(o,[{key:"takeDamage",value:function(t){this.health-=t,this.isDead=this.health<=0,this.isDead&&this.stats.awardDeath()}},{key:"reset",value:function(){this.health=max_health,this.activeWeapon="GroundPistol",this.isDead=!1}},{key:"tickCooldown",value:function(){0<this.weaponCooldown&&this.weaponCooldown--}}]),o}(),Projectile=function(t){function f(t,e,n,i,r,o,s,c,a,u,l){var h;return _classCallCheck(this,f),(h=_possibleConstructorReturn(this,_getPrototypeOf(f).call(this,e,n,5,5,1))).nonce=t,h.weaponCooldown=u,h._startingX=e,h._startingY=n,h.playerNonce=o,h.rotationDegrees=i,h.wobbleRotation=randomIntFromInterval(-s,s)+h.rotationDegrees,h.speed=randomIntFromInterval(c,a),h.halfLife=l-h.speed*randomIntFromInterval(-(s+5),s+5),h.fireTime=r,h.render=function(){var t=this;square(t.x,t.y,t.width,t.height,t.color||"orange",1),addEntity(new Contrail(this.x,this.y,this.height,this.width))},h._getDeltaTime=function(){return(serverTime-this.fireTime)/tick_rate},h.onTick=function(){this.x=this._startingX+this.speed*Math.cos(this.wobbleRotation*Math.PI/180)*this._getDeltaTime(),this.y=this._startingY+this.speed*Math.sin(this.wobbleRotation*Math.PI/180)*this._getDeltaTime()},h}return _inherits(f,Entity),f}(),PistolProjectile=function(t){function s(t,e,n,i,r,o){return _classCallCheck(this,s),_possibleConstructorReturn(this,_getPrototypeOf(s).call(this,t,e,n,i,r,o,1,8,8,10,4e3))}return _inherits(s,Projectile),s}(),ShotgunProjectile=function(t){function s(t,e,n,i,r,o){return _classCallCheck(this,s),_possibleConstructorReturn(this,_getPrototypeOf(s).call(this,t,e,n,i,r,o,9,5,8,50,900))}return _inherits(s,Projectile),s}(),MachineGunProjectile=function(t){function s(t,e,n,i,r,o){return _classCallCheck(this,s),_possibleConstructorReturn(this,_getPrototypeOf(s).call(this,t,e,n,i,r,o,8,7,9,1,1e3))}return _inherits(s,Projectile),s}(),SmgProjectile=function(t){function s(t,e,n,i,r,o){return _classCallCheck(this,s),_possibleConstructorReturn(this,_getPrototypeOf(s).call(this,t,e,n,i,r,o,3,10,11,5,1500))}return _inherits(s,Projectile),s}(),Surface=function(t){function r(t,e,n,i){return _classCallCheck(this,r),_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,t,e,n,i,1))}return _inherits(r,Entity),r}(),GroundWeapon=function(t){function o(t,e,n,i){var r;return _classCallCheck(this,o),(r=_possibleConstructorReturn(this,_getPrototypeOf(o).call(this,t,e,50,50,1))).weaponName=i,r.weaponTag=n,r.cX=r.width/2+r.x,r.cY=r.height/2+r.y,r.baseRender=function(){entitiesCollide(player,asCentered(this))&&(square(50,50,800,50,"white",.3),text("Press E to pickup: "+this.weaponName,60,85,"black",30))},r.onEDown=function(){entitiesCollide(player,asCentered(this))&&socket.emit("weapon-pickup",this.nonce)},r}return _inherits(o,Entity),o}(),GroundPistol=function(t){function i(t,e){var n;return _classCallCheck(this,i),(n=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,"GroundPistol","Pocket Pistol"))).render=function(){this.baseRender(),this.renderWeapon()},n.renderWeapon=function(){square(this.cX-10,this.cY-5,5,13,"brown"),square(this.cX-10,this.cY-5,15,5,"silver")},n.renderWeapon=function(){square(this.cX-10,this.cY-5,5,13,"brown"),square(this.cX-10,this.cY-5,15,5,"silver")},n}return _inherits(i,GroundWeapon),i}(),GroundShotgun=function(t){function i(t,e){var n;return _classCallCheck(this,i),(n=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,"GroundShotgun","Thunderous Blunderbuss"))).render=function(){this.baseRender(),this.renderWeapon()},n.renderWeapon=function(){var t=this;square(t.cX-15,t.cY-5,40,5,"silver"),square(t.cX-5,t.cY-1,20,6,"brown"),square(t.cX-20,t.cY-5,10,10,"brown"),square(t.cX-20,t.cY+5,10,5,"brown")},n}return _inherits(i,GroundWeapon),i}(),GroundMachineGun=function(t){function i(t,e){var n;return _classCallCheck(this,i),(n=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,"GroundMachineGun","Gatling Gun"))).render=function(){this.baseRender(),this.renderWeapon()},n.renderWeapon=function(){var t=this;square(t.cX-15,t.cY-5,35,4,"#BDDA00"),square(t.cX-15,t.cY,35,4,"#BDDA00"),square(t.cX-15,t.cY+5,35,4,"#BDDA00"),square(t.cX-25,t.cY-6,14,18,"#858585")},n}return _inherits(i,GroundWeapon),i}(),GroundSmg=function(t){function i(t,e){var n;return _classCallCheck(this,i),(n=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,"GroundSmg","SMG BABYY!"))).render=function(){this.baseRender(),this.renderWeapon()},n.renderWeapon=function(){var t=this;square(t.cX-15,t.cY-5,5,12,"black"),square(t.cX-2,t.cY-5,5,15,"black"),square(t.cX-15,t.cY-5,30,5,"black")},n}return _inherits(i,GroundWeapon),i}(),Floor=function(t){function o(t,e,n,i){var r;return _classCallCheck(this,o),(r=_possibleConstructorReturn(this,_getPrototypeOf(o).call(this,t,e,n,i))).render=function(){ctx.globalAlpha=.5,ctx.fillStyle="#bcb9ad",ctx.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),ctx.globalAlpha=1},r}return _inherits(o,Surface),o}(),Wall=function(t){function s(t,e,n,i,r){var o;return _classCallCheck(this,s),(o=_possibleConstructorReturn(this,_getPrototypeOf(s).call(this,e,n,i,r))).nonce=t,o.blocking=!0,o.render=function(){ctx.fillStyle="black",ctx.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height)},o}return _inherits(s,Surface),s}();