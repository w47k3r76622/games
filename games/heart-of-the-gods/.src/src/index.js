function e(e){function t(t){let s=ue(e);if(s===t)return;let r=s.get(F),i=s.get(T),a=t.get(T);for(let{r:e,offset:s}of r.hitCircles){let[r,l]=$e(i.angle,s),{x:n,y:o}=i,[h,c]=$e(a.angle,0),{x:d,y:p}=a;if(We([n+r,o+l,e],[d+h,p+c,10]))return t.get(I).hp=0,void Je("col")}}function s(e,t){let s=e.get(F),r=e.get(T),i=e.get(R),a=t.get(C),l=t.get(k),n=t.get(T);if(!(ge(e)&&"player"===l.allegiance||!ge(e)&&"enemy"===l.allegiance))for(let{r:o,offset:h}of s.hitCircles){let[s,c]=$e(r.angle,h),{x:d,y:p}=r;if(We([d+s,p+c,o],[n.x,n.y,a.circle.r]))return t.eject(),i.sprTimer.start(),e.get(I).hp-=l.dmg,void Je("hit1")}}function r(e,t){let s=e.get(F),r=e.get(T),i=t.get(v);for(let{r:e,offset:t}of s.hitCircles){let[s,a]=$e(r.angle,t),{x:l,y:n,w:o,h:h}=i.rect,c=r.x+s,d=r.y+a,p=l+o/2,g=n+h/2;if(We([c,d,e],[p,g,(o+16)/2])){let e=Ve([p,g],[c,d]),[t,s]=$e(e,1);r.x+=3*t,r.y+=3*s}}}function i(e,t){let s=e.get(T),r=e.get(R),i=t.get(C),a=t.get(C),l=t.get(k),n=t.get(T);if("enemy"===l.allegiance)return;let{x:o,y:h}=s;return We([o,h,i.circle.r],[n.x,n.y,a.circle.r])?(t.eject(),r.sprTimer.start(),e.get(I).hp-=l.dmg,void Je("hit2")):void 0}function a(t){let s=ue(e),r=s.get(F),i=s.get(A),a=s.get(T),l=t.get(C),n=t.get(T);for(let{r:e,offset:s}of r.hitCircles){let[r,o]=$e(a.angle,s),{x:h,y:c}=a;if(We([h+r,c+o,e],[n.x,n.y,l.circle.r]))return t.eject(),i.crates++,void Je("crate")}}function l(t){let s=ue(e),r=s.get(F),i=s.get(T),a=s.get(R),l=t.get(C),n=t.get(T),o=t.get(U);if(o.hitTimer.isComplete())for(let{r:e,offset:t}of r.hitCircles){let[r,h]=$e(i.angle,t),{x:c,y:d}=i;if(We([c+r,d+h,e],[n.x,n.y,l.circle.r]))return o.hitTimer.start(),a.sprTimer.start(),s.get(I).hp-=3,void Je("hit1")}}function n(e,t){let s=e.get(T),r=e.get(R),i=e.get(C),a=t.get(C),l=t.get(k),n=t.get(T);if("enemy"===l.allegiance)return;let{x:o,y:h}=s;return We([o,h,i.circle.r],[n.x,n.y,a.circle.r])?(t.eject(),r.sprTimer.start(),e.get(I).hp-=l.dmg,void Je("hit2")):void 0}let o=e.select(F,T,R,I),h=e.select(v,T),c=e.select(C,T,k),d=e.select(C,T,R,I),p=e.select(C,T,D),g=e.select(C,T,U),u=e=>{h.iterate(r.bind(this,e)),c.iterate(s.bind(this,e))},m=e=>{c.iterate(i.bind(this,e))},w=e=>{c.iterate(n.bind(this,e))};this.update=()=>{o.iterate(u),o.iterate(t),d.iterate(m),p.iterate(a),g.iterate(l),g.iterate(w)}}function t(e){let t=e.select(A,T,I),s=[],r=[];window.addEventListener("keydown",(e=>{s.push(e)})),window.addEventListener("keyup",(e=>{r.push(e)}));let i=0;x.bind(this)(t,(t=>{let a=t.get(A),l=t.get(T),n=t.get(I);s.forEach((s=>{a.gameStarted?a.gameOver||function(t,s,r,i){let a=xe(e).get(M),l=s.crates,n=e=>l<e?(a.setText(`Not enough supplies (need ${e}).`),!1):(s.crates-=e,!0);"1"===t?n(a.costUpgrade)?r.upgradeTurret()?(a.costUpgrade++,Je("upgrade"),a.setText("Turret upgraded!"),a.setTextFlash(0,"#71AA34")):(s.crates+=a.costUpgrade,a.setText("No more upgrades available!"),Je("invalid"),a.setTextFlash(0,"#E1534A")):(Je("invalid"),a.setTextFlash(0,"#E1534A")):"2"===t?n(a.costNew)?(r.addTurret(),a.costNew+=2,Je("create"),a.setText("Turret added!"),a.setTextFlash(0,"#71AA34")):(Je("invalid"),a.setTextFlash(1,"#E1534A")):"3"===t&&(n(a.costHeal)?(Je("heal"),a.costHeal+=5,a.setText("Ship repaired!"),i.hp+=10,i.hp>i.maxHp&&(i.hp=i.maxHp),a.setTextFlash(0,"#71AA34")):(Je("invalid"),a.setTextFlash(2,"#E1534A")))}(s.key,a,t.get(F),n):a.firstScreenUiVisible?(a.firstScreenUiVisible=!1,a.gameStarted=!0,xe(e).get(M).setText("Destroy the Hearts of the Gods!"),Je("start")):(Je("hit1"),a.firstScreenUiVisible=!0),a.setKeyDown(s.key)})),r.forEach((e=>{a.setKeyUp(e.key)})),y(e)&&((t,s,r,a,l)=>{if(r.hp<=0||we(e).get(I).hp<=0)return;let n=!1,o=!1,h=t.keys;(h.ArrowLeft||h.a)&&s.turn("l"),(h.ArrowRight||h.d)&&s.turn("r"),(h.ArrowUp||h.w)&&(n=!0),h.Shift?(l.enabled=!0,n=!0):l.enabled=!1,n||!h.ArrowDown&&!h.s||(o=!0),s.acc=n,s.accRev=o,(n||o)&&a.spawnTimer.isComplete()&&(i%2&&Je(l.enabled&&!l.onCooldown?"exh2":"exh"),i++)})(a,l,n,t.get(N),t.get(O)),r.length&&(r=[]),s.length&&(s=[])}))}function s(e){let t=e.select(E),s=e.select(E,S),r=e=>{e.get(E).timer.isComplete()&&e.eject()},i=e=>{let t=e.get(E),s=e.get(S);s.opacity=f(t.timer.getPctComplete(),0,1,t.opacity.start,t.opacity.end),s.scale=f(t.timer.getPctComplete(),0,1,t.scale.start,t.scale.end)};this.update=()=>{t.iterate(r),s.iterate(i)}}function r(e){let t=e.select(N,T);x.bind(this)(t,(t=>{let s=t.get(N),r=t.get(T);if(s.spawnTimer.isComplete()&&(r.acc||r.accRev)){let[t,i]=$e(r.angle,.8*-s.r);((e,t,s,r)=>{let i=new T(t,s);e.create().add(new S({circle:{r:7,color:r},z:9}),i,new E({duration:700,opacity:{start:.5,end:0},scale:{start:1,end:4}}))})(e,r.x+t,r.y+i,s.c),s.spawnTimer.start()}}))}function i(e){let t=(t,s,r,i,a)=>{let l=Ke(t,s),n=Ke(0,270)+180+45,[o,h]=$e(n,l);"ship"===i?((e,t,s,r)=>{let i={1:{sprites:[3,3],turrets:[{sprNum:22,ms:1e3,dmg:1,offset:0,range:300}],hp:1,spriteR:8},2:{sprites:[3,3,3],turrets:[{sprNum:22,ms:1e3,dmg:1,offset:0,range:300},{sprNum:22,ms:900,dmg:1,offset:0,range:400}],hp:3,spriteR:8},3:{sprites:[3,3,3],turrets:[{sprNum:24,ms:700,dmg:2,offset:0,range:350}],hp:10,spriteR:8},4:{sprites:[3,3,3,3],turrets:[{sprNum:24,ms:700,dmg:2,offset:0,range:400},{sprNum:24,ms:700,dmg:2,offset:0,range:400}],hp:20,spriteR:8}}[r],a=new F(i.sprites,i.turrets.map((e=>new b({...e,prjColor:"#F47E1B",prjSpd:10,prjSz:5}))),i.spriteR??8),l=new T(t,s),n=new S({ship:a,scale:2,z:10});e.create().add(a,n,l,new N(16),new R,new I(i.hp),new z)})(e,2048+o,2048+h,a):"ghost"===i&&((e,t,s)=>{let r=new T(t,s),i=new S({spriteName:"spr_20",scale:4,z:10,useHeading:!1});r.accRate=.5,r.angleRate=5,e.create().add(i,r,new R,new I(15),new C(Ge(0,0,28)),new z,new U)})(e,Math.random()>.5?-100:4196,2048+h),r.numEnemies++};this.update=()=>{if(ue(e).get(A).gameOver)return;let s=(e=>e.get(ye))(e),r=s.get(j);if(y(e)){if(r.waveTimer.isComplete()){let e=r.waveNumber+5;if(r.waveNumber++,r.waveTimer.start(),r.waveNumber%4==0)for(let e=0;e<r.waveNumber/4;e++)t(4096,6144,r,"ghost");r.waveNumber%3==0&&r.numEnemies2++,r.waveNumber%3==0&&r.numEnemies2>1&&r.numEnemies3++,r.waveNumber%3==0&&r.numEnemies3>1&&r.numEnemies4++;for(let s=0;s<e;s++)t(4096,6144,r,"ship",1);for(let e=0;e<r.numEnemies2;e++)t(4096,6144,r,"ship",2);for(let e=0;e<r.numEnemies2;e++)t(4096,6144,r,"ship",3);for(let e=0;e<r.numEnemies2;e++)t(4096,6144,r,"ship",4)}}else if(r.numEnemies<=0)for(let e=0;e<r.waveNumber+3;e++)t(0,2048,r,"ship",1)}}function a(e){let t=e.select(P);x.bind(this)(t,(t=>{let s=t.get(P);for(let t of s.tiles){let r=e.get(t.id);if(t.timer.isComplete()){let e=r.get(S);s.incTile(t),e.spriteName=s.getSpriteName(t),s.resetTileTimer(t)}}}))}function l(e){let t=e.select(S,R);x.bind(this)(t,(e=>{let t=e.get(S),s=e.get(R);t.highlighted=!s.sprTimer.isComplete()}))}function n(e){let t=e.select(S,H);x.bind(this)(t,(e=>{let t=e.get(S),s=e.get(H);s.sprTimer.isComplete()&&(s.sprTimer.start(),s.i=(s.i+1)%s.sprites.length,t.spriteName=s.sprites[s.i])}))}function o(e){let t=e.select(z,T);x.bind(this)(t,(t=>{let s=t.get(T),r=ue(e).get(A);if(!y(e)||r.gameOver)return;let i=ue(e).get(T);s.turnTowards([i.x,i.y]),s.acc=!0}))}function h(e){let t=e.select(_,F,T);x.bind(this)(t,(e=>{let t=e.get(_),s=e.get(T);t.x=s.x-t.w/2,t.y=s.y-t.h/2;let r=-32;t.x<r&&(t.x=r),t.x+t.w>4064&&(t.x=4064-t.w),t.y<r&&(t.y=r),t.y+t.h>4064&&(t.y=4064-t.h),t.x=Math.floor(t.x),t.y=Math.round(t.y)}))}function c(e){let t=e.select(T,I);x.bind(this)(t,(t=>{let s=t.get(I),{x:r,y:i}=t.get(T);if(s.hp<=0)if(s.hp=0,ge(t)){let t=ue(e),s=t.get(A);t.get(S).highlighted=!0;let r=xe(e).get(M);r.endTimer.isComplete()&&!s.gameOver&&(Je("end"),s.gameOver=!0,r.endTimer.start(),r.endTimer.onCompletion().then((()=>{_e(s.score),ve(e)}))),r.endTimer.update()}else if((e=>e.id===me)(t)){t.eject(),Ee(e,r,i),Je("baseExpl");let s=ue(e).get(A),a=[...s.usedCoords],l=a.findIndex((e=>e[0]===r&&e[1]===i));l>-1&&a.splice(l,1),s.score++;let[n,o]=a[Ke(0,a.length-1)];Se(e,n,o,2*s.score),xe(e).get(M).setText("A new Heart has spawned!"),ue(e).get(A).crates+=5}else t.has(F)?(Je("sink"),t.eject(),Ee(e,r,i),((e,t,s)=>{let r=new T(t,s);e.create().add(new S({scale:2,z:9}),r,new D,new H(["spr_8","spr_9"],400),new C(Ge(t,s,16)),new E({duration:6e4,scale:{start:2,end:2}}))})(e,r,i)):t.has(U)&&(Je("sink"),t.eject(),Ee(e,r,i))}))}function d(e){let t=e.select(T,O,N);x.bind(this)(t,(e=>{let t=e.get(O),s=e.get(N),r=e.get(T);t.enabled&&!t.onCooldown?(t.gauge.fill(.12),s.c="#A1EF79",r.accRate=.7,t.gauge.isFull()&&(t.onCooldown=!0)):(s.resetColor(),r.resetAcc(),t.onCooldown&&0===t.gauge.getPct()&&(t.onCooldown=!1)),t.gauge.update()}))}function p(e){let t=e.select(T,U,S);x.bind(this)(t,(t=>{let s=t.get(U),r=t.get(T),i=t.get(S),a=ue(e).get(T),l=Le(a.x,a.y,r.x,r.y);l>2e3&&s.timer.start();let n=s.timer.getPctComplete(),o=5*Math.sin(f(n,0,1,0,2*Math.PI));r.y+=o,s.timer.isComplete()&&(s.timer.start(),l<1e3&&Je("ghost")),i.flipped=r.vx>0}))}function g(e){let t=e.select(T);x.bind(this)(t,(e=>{let t=e.get(T);if(t.acc||t.accRev){let[e,s]=$e(t.angle,t.accRate);t.ax=e,t.ay=s,t.accRev&&(t.ax*=-.5,t.ay*=-.5)}let s=$.fm,r=t.ay/t.mass*s;t.vx+=t.ax/t.mass*s,t.vy+=r,t.dragOn&&function(e){let t=$.fm,s=e.coeff,r=0,i=0;r=s*e.vx/2,i=s*e.vy/2,e.vx-=r/e.mass*t,e.vy-=i/e.mass*t}(t),t.x+=t.vx*s,t.y+=t.vy*s,t.ax=0,t.ay=0,t.acc=!1}))}function u(e){let t=e.select(T,S),s=e.select(_),r=[],i=e=>{let{x:t,y:s,angle:r}=e.get(T),{spriteName:i,circle:a,rectangle:l,opacity:n,scale:o,flipped:h,highlighted:c,ship:d,useHeading:p}=e.get(S),g="";if(h&&(g+="_f"),c&&(g+="_h"),$.setOpacity(n),i&&$.drawSprite(i+g,t,s,p?r:0,o),a){let{r:e,color:r}=a;$.drawCircle(t,s,e*o,r)}if(l){let{w:e,h:r,color:i}=l;$.drawRect(t,s,e*o,r*o,i)}if(d){let e=d.getHitCirclePositions(r);for(let{offset:[i,a],spr:l}of e)$.drawSprite(l+g,t+i,s+a,r,o);let i=d.getTurretPositions(r);for(let{spr:e,physics:t}of i)$.drawSprite(e,t.x,t.y,t.angle,o)}$.setOpacity(1)},a=e=>{let t=e.get(S);!function(e,t){e.push(t);for(let t=e.length-1;t>0&&e[t].z<e[t-1].z;t--){let s=e[t];e[t]=e[t-1],e[t-1]=s}}(r,{entity:e,z:t.z})},l=t=>{let{x:s,y:a,w:l,h:n}=t.get(_),o=$.getCtx();o.save(),o.translate(-s,-a);for(let{entity:e}of r){let{x:t,y:r}=e.get(T);Le(s+l/2,a+n/2,t,r)<$.SCREEN_WIDTH/2+160&&i(e)}let{x:h,y:c}=we(e).get(T),{x:d,y:p}=ue(e).get(T),g=Ve([d,p],[h,c]),[u,m]=$e(g,96),[w,f]=$e(g,64);$.drawCircle(d+u,p+m,2,"#FFF"),$.drawLine(d+w,p+f,d+u,p+m,"#FFF"),o.restore(),r=[]},n=document.getElementById("canvasDiv");this.update=()=>{n.style.filter=ue(e).get(A).gameOver?"grayscale(1)":"",t.iterate(a),s.iterate(l)}}function m(e){function t(e,t,s,r,i,a){$.drawRect(e,t,s,20,"#000"),$.drawRect(e,t,s*r,20,a),$.drawText(i,e+4,t+11,{align:"left"})}let s=$.getCtx(),r=s.createLinearGradient(0,0,0,150);r.addColorStop(0,"rgba(0,0,0,0.25)"),r.addColorStop(.8,"rgba(0,0,0,0)");let i=s.createLinearGradient(0,$.height-100,0,$.height);i.addColorStop(1,"rgba(0,0,0,0.25)"),i.addColorStop(0,"rgba(0,0,0,0)");let a=new je(500);a.start();let l="spr_21",n="#aaa";this.update=()=>{let s=xe(e).get(M);s.textTimer.isComplete()||$.drawText(s.text,$.width/2,150,{size:32}),s.endTimer.isComplete()||$.drawText("Game over.",$.width/2,$.height/2,{size:48}),function(s){let a=ue(e),l=a.get(A),n=a.get(O),o=a.get(I),h=we(e).get(I),c=o.hp/o.maxHp,d=h.hp/h.maxHp,p=1-n.gauge.getPct(),g=$.height-40,u=$.width-256-20;$.drawRect(0,$.height-100,300,100,i),t(20,g,256,c,"Player HP","#42CAFD"),t(20,g-32,224,p,"Boost",n.onCooldown?"#243F72":"#827094"),$.drawRect($.width-300,$.height-100,300,100,i),t(u,g,256,d,"Heart HP","#F47E1B"),$.drawText("Hearts Destroyed: "+l.score,u,g-16,{align:"left"});let m=l.crates;$.drawRect(0,0,260,150,r),$.drawSprite("spr_8_f",64,34,0,4),$.drawText("Supplies: "+m,100,32,{align:"left"});let w=[m>=s.costUpgrade?"#FBFCAA":"#8D87A2",m>=s.costNew?"#FBFCAA":"#8D87A2",m>=s.costHeal?"#FBFCAA":"#8D87A2"];s.textFlashI>-1&&(w[s.textFlashI]=s.textFlashColor),s.textFlashTimer.isComplete()&&(s.textFlashI=-1),$.drawText(`Press 1: Upgrade Turret (${s.costUpgrade})`,20,64,{color:w[0],align:"left"}),$.drawText(`Press 2: New Turret (${s.costNew})`,20,96,{color:w[1],align:"left"}),$.drawText(`Press 3: Repair (${s.costHeal})`,20,128,{color:w[2],align:"left"})}(s),(()=>{let t=ue(e).get(A);if(!t.gameStarted){if($.drawRect(0,0,$.width,$.height,"#000"),a.isComplete()&&(l="spr_21"===l?"spr_21_f":"spr_21",n="#aaa"===n?"#fff":"#aaa",a.start()),t.firstScreenUiVisible)return $.drawText("Your objective: ",$.width/2,100,{size:24,color:"#aaa"}),$.drawText("Destroy the Hearts of the Gods",$.width/2,132,{size:24,color:"#fff"}),$.drawSprite(l,$.width/2,220,0,6),$.drawText("The underworld navy will try to stop you.",$.width/2,320,{size:24,color:"#fff"}),$.drawSprite("spr_3",$.width/2,380,0,4),$.drawText("Pick up supplies to upgrade your vessel.",$.width/2,448,{size:24,color:"#fff"}),$.drawSprite("spr_8",$.width/2,512,0,6),$.drawText("Left/Right Arrows: Turn Vessel   Up/Down Arrows: Accelerate Vessel",$.width/2,564,{size:24,color:"#aaa"}),$.drawText("Shift: Boost",$.width/2,600,{size:24,color:"#aaa"}),void $.drawText("Press any button.",$.width/2,$.height-100,{size:32,color:n});$.drawText("HEART OF THE GODS",$.width/2,140,{size:52,color:"#00635C",strokeColor:""}),$.drawText("HEART OF THE GODS",$.width/2,144,{size:52,color:"#8E478C",strokeColor:""}),$.drawText("HEART OF THE GODS",$.width/2,148,{size:52,color:"#00635C",strokeColor:""}),$.drawSprite(l,$.width/2,$.height/2,0,6),void 0!==ze&&$.drawText("Hearts Destroyed on Previous Mission: "+ze,$.width/2,$.height-300,{size:16,color:"#FFF"}),$.drawText("Welcome to the Underworld.",$.width/2,$.height-200,{size:16,color:"#00A383"}),$.drawText("Press any button.",$.width/2,$.height-100,{size:32,color:n})}})()}}function w(e){let t=e.select(F,T,I),s=e.select(U,T,I),r=e.select(b,T,I),i=(i,a,l)=>{let n=1/0,o=[],h=[];t.iterate((e=>{let t=e.get(F),{angle:s,x:r,y:n}=e.get(T);if(e.id!==l.id)for(let{offset:e}of t.hitCircles){let[t,l]=$e(s,e),o=r+t,c=n+l,d=Le(o,c,i,a);h.push([o,c,d])}})),r.iterate((e=>{let{x:t,y:s}=e.get(T),r=Le(t,s,i,a);h.push([t,s,r])})),s.iterate((e=>{let{x:t,y:s}=e.get(T),r=Le(t,s,i,a);h.push([t,s,r])}));let c=we(e).get(T),{x:d,y:p}=c,g=Le(d,p,i,a);h.push([d,p,g]);for(let e=0;e<h.length;e++){let t=h[e];t[2]<n&&(o=t,n=t[2])}return o.length?o:null},a=(t,s)=>{let r=ue(e).get(T),i=Le(t,s,r.x,r.y);return[r.x,r.y,i]},l=(t,s,r)=>{let[i,a,l]=r,{physics:n,range:o,timer:h,sprTimer:c,dmg:d}=t;if(l<o){if(n.lookAt([i,a]),h.isComplete()){h.start(),c.start();let r=$e(n.angle,16);Je("shoot1"),((e,t,{x:s,y:r,angle:i,spd:a,dmg:l,ms:n,col:o,sz:h})=>{let c=e.create(),d=new T(s,r);d.dragOn=!1,d.angle=i;let[p,g]=$e(i,a);d.setV(p,g),c.add(new k(l,t),new S({circle:{r:h,color:o},z:11}),new E({duration:n}),d,new C(Ge(s,r,5)))})(e,s,{col:t.prjColor,x:n.x+r[0],y:n.y+r[1],angle:n.angle,spd:t.prjSpd+Math.sqrt(n.vx**2+n.vy**2),dmg:d,ms:4e3,sz:t.prjSz})}return!0}},n=t=>{let s=t.get(F),{angle:r,x:n,y:o}=t.get(T),h=t.get(I),c=s.getTurretPositions(r);for(let s of c){let r,{offset:[c,d],physics:p}=s,g=p.x=n+c,u=p.y=o+d,m="player";if(ge(t)?r=i(g,u,t):(m="enemy",r=a(g,u)),!r||h.hp<=0)continue;let w=ue(e).get(A);y(e)&&!w.gameOver&&l(s,m,r)}};this.update=()=>{t.iterate(n)}}function f(e,t,s,r,i){return r+(e-t)*(i-r)/(s-t)}function x(e,t){return Object.assign(this,{update:"function"==typeof e?e:()=>e.iterate(t)})}function y(e){return ue(e).get(A).gameStarted}class T{vx=0;vy=0;ax=0;ay=0;mass=1;angle=0;angleRate=2;acc=!1;accRev=!1;accRate;coeff=.1;dragOn=!0;constructor(e,t){this.x=e,this.y=t,this.resetAcc()}resetAcc(){this.accRate=.3}setV(e,t){this.vx=e,this.vy=t}setAngle(e){e<0?e+=360:e>360&&(e-=360),this.angle=e}lookAt(e){this.setAngle(Ve([this.x,this.y],e))}turnTowards(e){let t=Ve([this.x,this.y],e);if(this.turn(this.angle<=t?Math.abs(this.angle-t)<180?"r":"l":Math.abs(this.angle-t)<180?"l":"r"),this.angle===t)return!0}turn(e){let t=this.angleRate*$.fm;"l"==e?this.setAngle(this.angle-t):"r"==e&&this.setAngle(this.angle+t)}}class C{circle;constructor(e){this.circle=e}}class v{constructor(e){this.rect=e}}class S{spriteName;flipped=!1;highlighted=!1;opacity=1;useHeading=!0;z;scale;circle;rectangle;ship;constructor(e){let{spriteName:t,circle:s,rectangle:r,z:i,scale:a,ship:l,useHeading:n}=e??{};this.spriteName=t??"",this.circle=s,this.rectangle=r,this.z=i??0,this.scale=a??1,this.ship=l,this.useHeading=n??!1}}class E{timer;opacity={start:1,end:1};scale={start:1,end:1};constructor({duration:e,scale:t,opacity:s}){this.timer=new je(e),this.opacity=s??this.opacity,this.scale=t??this.scale}}class b{constructor({sprNum:e,ms:t,dmg:s,offset:r,range:i,prjColor:a,prjSpd:l,prjSz:n}){this.sprNum=e,this.timer=new je(t),this.sprTimer=new je(100),this.dmg=s,this.offset=r,this.physics=new T(0,0),this.range=i,this.level=1,this.prjColor=a,this.prjSpd=l,this.prjSz=n}}class F{hitCircles=[];turrets;spriteNumbs;spriteR;constructor(e,t,s=16){let r=e.length;this.spriteNumbs=e,this.turrets=t,this.spriteR=s,this.buildHitCircles(r)}buildHitCircles(e){this.hitCircles=[];let t=0;e>1&&(t=-this.spriteR*(e-1));for(let s=0;s<e;s++)this.hitCircles.push({r:16,offset:2*s*this.spriteR+t})}addTurret(){this.turrets.push(new b({sprNum:22,ms:1e3,dmg:1,offset:32,range:300,prjSpd:10,prjColor:de,prjSz:5}));let e=this.spriteNumbs;this.spriteNumbs=[...e.slice(0,-2),10,...e.slice(-2)],this.buildHitCircles(this.spriteNumbs.length)}upgradeTurret(){let e;for(let t of this.turrets)(!e||t.level<e.level)&&(e=t);return!!(e&&e.level<4)&&(e.level++,e.sprNum+=2,e.dmg++,e.range+=10,e.prjSz++,e.prjSpd++,e.timer.start(e.timer.duration-100),!0)}getHitCirclePositions(e){let t=[];for(let s in this.hitCircles)t.push({r:this.hitCircles[s].r,offset:$e(e,this.hitCircles[s].offset),spr:"spr_"+this.spriteNumbs[s]});return t}getTurretPositions(e){let t=[];for(let s in this.turrets){let r=this.turrets[s];t.push({...r,offset:$e(e,this.hitCircles[s].offset),spr:"spr_"+(r.sprNum+(r.sprTimer.isComplete()?0:1))})}return t}}class A{keys={};score=0;crates=0;gameOver=!1;gameStarted=!1;firstScreenUiVisible=!1;usedCoords=[];setKeyDown(e){this.keys[e]=!0}setKeyUp(e){this.keys[e]=!1}}class N{spawnTimer=new je(100);c;constructor(e){this.r=e,this.resetColor()}resetColor(){this.c="#92F4FF"}}class R{constructor(){this.sprTimer=new je(100),this.sprTimer.timestampStart=0}}class H{constructor(e,t){this.sprTimer=new je(t),this.sprTimer.timestampStart=-9999,this.i=0,this.sprites=e}}class z{}class P{tiles=[];scale=4;width=64;height=64;constructor(e){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){let r={id:"",spr:0,timer:new je(Ke(100,2e4))};this.tiles.push(r);let i=be(e,s*this.scale*16,t*this.scale*16,this.getSpriteName(r),this.scale);r.id=i}}incTile(e){e.spr=(e.spr+1)%4}getSpriteName(e){return"spr_"+(e.spr+4)}resetTileTimer(e){e.timer.start(0===e.spr?Ke(5e3,2e4):150)}}class _{x=0;y=0;w=$.SCREEN_WIDTH;h=$.SCREEN_HEIGHT}class k{constructor(e,t){this.dmg=e,this.allegiance=t}}class I{constructor(e){this.hp=this.maxHp=e}}class j{waveNumber=0;numEnemies=0;numEnemies2=0;numEnemies3=0;numEnemies4=0;waveTimer=new je(2e4);constructor(){this.waveTimer.timestampStart=-this.waveTimer.duration}}class M{costUpgrade=5;costNew=10;costHeal=5;textTimer=new je(3e3);endTimer=new je(4e3);textFlashTimer=new je(250);textFlashI=-1;textFlashColor="";constructor(){this.endTimer.timestampStart=-9999,this.text=""}setText(e){this.text=e,this.textTimer.start()}setTextFlash(e,t){this.textFlashTimer.start(),this.textFlashI=e,this.textFlashColor=t}}class D{}class O{constructor(){this.gauge=new Me(10,.1),this.onCooldown=!1,this.enabled=!1}}class U{constructor(){this.timer=new je(3e3),this.timer.start(),this.hitTimer=new je(250),this.hitTimer.start()}}let B,G={},L={},W={WHITE:"#F8F8F8",BLACK:"#111",GREY:"#8D87A2",RED:"#E1534A",GREEN:"#71AA34",LIGHTGREEN:"#FBFCAA"},V={font:"Arial",color:"#F8F8F8",size:18,align:"center",strokeColor:"#111"},$=new class{width=0;height=0;fm=1;colors=W;SCREEN_HEIGHT=768;SCREEN_WIDTH=1024.5;enabled=!0;async init(){let[e]=this.createCanvas("canv",this.width,this.height);B=e,this.handleResize(),document.getElementById("canvasDiv")?.appendChild(B);let t=await new Promise((e=>{let t=new Image;t.onload=()=>{G.sprites=t,e(t)},t.src="res/sprites.png"})),s=t.width,r=16,i=0;for(let e=0;e<s/r;e++)for(let a=0;a<s/r;a++){let s=this.createSprite(t,a*r,e*r,r,r);L["spr_"+i]=s;let l=L["spr_"+i+"_f"]=this.createFlippedSprite(s);L["spr_"+i+"_h"]=this.createHitSprite(s),L["spr_"+i+"_f_h"]=this.createHitSprite(l),i++}}handleResize(){B&&(B.width=this.width=this.SCREEN_WIDTH,B.height=this.height=this.SCREEN_HEIGHT,this.getCtx().imageSmoothingEnabled=!1)}getCtx(){return B.getContext("2d")}setOpacity(e){this.getCtx().globalAlpha=e}createCanvas=(e,t,s)=>{let r=document.createElement("canvas");r.id=e,r.width=t,r.height=s;let i=r.getContext("2d");return i.imageSmoothingEnabled=!1,[r,i]};createSprite(e,t,s,r,i){let[a,l]=this.createCanvas("",16,16);return l.drawImage(e,t,s,r,i,0,0,r,i),[a,0,0,r,i]}createFlippedSprite(e){let[t,,,s,r]=e,[i,a]=this.createCanvas("",s,r);return a.translate(s,0),a.scale(-1,1),a.drawImage(t,0,0),[i,0,0,s,r]}createHitSprite(e){let[t,,,s,r]=e,[i,a]=this.createCanvas("",s,r);return a.filter="invert(1)",a.drawImage(t,0,0),[i,0,0,s,r]}clear(e){(e=e??this.getCtx()).clearRect(0,0,e.canvas.width,e.canvas.height)}drawSprite(e,t,s,r,i,a){if(!this.enabled)return;i=i||1,(a=a??this.getCtx()).save();let l=L[e];r=r||0;let[n,o,h,c,d]=l,p=c*i,g=d*i;a.translate(t-=p/2,s-=p/2),a.translate(p/2,g/2),a.rotate(r*Math.PI/180),a.drawImage(n,o,h,c,d,t=-p/2,s=-g/2,c*i,d*i),a.restore()}drawRect(e,t,s,r,i,a,l){l=l??this.getCtx(),a&&(s-=l.lineWidth/2,r-=l.lineWidth/2),l[a?"strokeStyle":"fillStyle"]=i,l[a?"strokeRect":"fillRect"](e,t,s,r)}drawCircle(e,t,s,r,i,a){(a=a??this.getCtx()).beginPath(),a.arc(e,t,s,0-Math.PI/2,2*Math.PI*(i??1)-Math.PI/2),a.fillStyle=r,a.fill()}drawLine(e,t,s,r,i,a,l){a=a??1,(l=l??this.getCtx()).lineWidth=a,l.strokeStyle=i,l.beginPath(),l.moveTo(e,t),l.lineTo(s,r),l.stroke()}drawText(e,t,s,r,i){let{font:a,size:l,color:n,align:o,strokeColor:h}={...V,...r??{}};(i=i??this.getCtx()).font=`${l}px ${a}`,i.textAlign=o,i.textBaseline="middle",h&&(i.strokeStyle=h,i.lineWidth=4,i.strokeText(e,t,s)),i.fillStyle=n,i.fillText(e,t,s)}},K=[],q=[],Y={},J="_sign",Q="_mask";"undefined"!=typeof Symbol&&(J=Symbol(J),Q=Symbol(Q));let X=(e,t)=>{let s=t[e];if(!s)throw Error("The component is not registered");return s},Z=X.bind(null,J),ee=X.bind(null,Q),te=e=>{e.id&&K.forEach((t=>t.match(e)))},se=1,re={};class ie{constructor(e){this.id=e||(se++).toString(36),this.components=Object.assign({},re),this.mask=0}add(...e){e.forEach((e=>{this.components[Z(e.constructor)]=e,this.mask|=ee(e.constructor)})),te(this)}remove(...e){e.forEach((e=>{let t=Z(e),s=this.components[t];s&&(s.destructor&&s.destructor(),delete this.components[t],this.mask&=~ee(e))})),te(this)}has(e){return Z(e)in this.components}get(e){return this.components[e[J]]}eject(){var e;e=this,K.forEach((t=>t.remove(e))),delete Y[e.id],e.id=0}}class ae{constructor(e,t){this.entity=e,this.prev=null,this.next=t}}class le{constructor(e){this.mask=e,this.map={},this.list=null,this.length=0;for(let e in Y)Object.prototype.hasOwnProperty.call(Y,e)&&this.match(Y[e])}iterate(e){let t=this.list;for(;t;)e(t.entity),t=t.next}match(e){(this.mask&e.mask)===this.mask?this.add(e):this.remove(e)}add(e){if(this.map[e.id])return;let t=new ae(e,this.list);this.list&&(this.list.prev=t),this.list=t,this.map[e.id]=t,this.length++}remove(e){let t=this.map[e.id];t&&(t.prev?t.prev.next=t.next:this.list=t.next,t.next&&(t.next.prev=t.prev),delete this.map[e.id],this.length--)}}let ne=0,oe=performance||Date,he=oe.now.bind(oe),ce={register(...e){e.forEach((e=>{let t=ne.toString(36);re[t]=null,e[J]=t,e[Q]=1<<ne,ne++}))},process(...e){e.forEach((e=>q.push(e)))},create(e){let t=new ie(e);if(!Y[t.id])return Y[t.id]=t,t},get:e=>Y[e],select(...e){let t=0;e.forEach((e=>{t|=ee(e)}));for(let e=0;e<K.length;e++)if(K[e].mask===t)return K[e];let s=new le(t);return K.push(s),s},update(e){let t={};return q.forEach((s=>{let r=he();s.update(e),t[s.constructor.name]=he()-r})),t},reset(){for(let e in Y)Y[e].eject()}},de="#42CAFD",pe="",ge=e=>e.id===pe,ue=e=>e.get(pe),me="",we=e=>e.get(me),fe="",xe=e=>e.get(fe),ye="",Te=(e,t,s,r)=>{for(let[i,a]of r)if(Le(e,t,i,a)<s)return!0;return!1},Ce=(e,t,s,r)=>{let i,a,l=0;do{let s=Ke(e,t),r=Ke(0,270)+180+45-360,[n,o]=$e(r,s);i=2048+n,a=2048+o,l++}while(l<10&&Te(i,a,s,r));if(l>=10)return[0,0];let n=[i,a];return r.push(n),n},ve=e=>{e.reset(),function(e){let t=new A,s=new F([2,1,0],[new b({sprNum:22,ms:1e3,dmg:1,offset:32,range:300,prjSpd:15,prjColor:de,prjSz:5})]),r=new T(2048,3072);r.angleRate=4;let i=new S({ship:s,scale:2,z:10}),a=e.create();a.add(t,s,i,r,new N(48),new _,new R,new I(50),new O),pe=a.id}(e),Fe(e),Re(e),He(e);let t=ue(e).get(A).usedCoords;for(let s=0;s<35;s++){let[s,r]=Ce(0,2e3,192,t);Ne(e,s,r)}let[s,r]=t[Ke(0,t.length-1)];Se(e,s,r,0)},Se=(e,t,s,r)=>{let i=e.create();i.add(new S({scale:6,z:3}),new C(Ge(t,s,44)),new H(["spr_21","spr_21_f"],500),new T(t,s),new R,new I(10+r)),me=i.id},Ee=(e,t,s)=>{let r=new T(t,s);e.create().add(new S({circle:{r:10,color:"#A05B53"},z:9}),r,new E({duration:1e3,opacity:{start:1,end:0},scale:{start:1,end:4}}))},be=(e,t,s,r,i)=>{let a=new T(t,s),l=e.create();return l.add(new S({spriteName:r,scale:i,z:0}),a),l.id},Fe=e=>{e.create().add(new P(e))},Ae=(e,t,s,r,i,a)=>{let l=e.create();if(l.add(new S({spriteName:"spr_"+r,scale:i,z:2}),new T(t,s)),a){let e=128;l.add(new v(Be(t-e/2,s-e/2,e,e)))}},Ne=(e,t,s)=>{let r=10;Ae(e,t,s,15,4,!0);for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++)r++,0===i&&0===a||Ae(e,t+64*a,s+64*i,r,4)},Re=e=>{let t=e.create();t.add(new M),fe=t.id},He=e=>{let t=e.create();t.add(new j),ye=t.id};window.addEventListener("load",(async()=>{await $.init(),window.addEventListener("resize",(()=>{$.handleResize()})),window.draw=$,ce.register(T,S,C,v,E,F,b,R,H,A,N,z,P,_,k,I,M,j,D,O,U),ce.process(...Pe(ce)),ve(ce),(()=>{let e=performance.now();setInterval((()=>{let t=performance.now(),s=t-e;e=t,s>4&&(s=4);let r=s;s-=r,$.fm=r/10,$.enabled=s<=0,(e=>{$.clear(),ce.update(e/1e3)})(r)}),16)})()}));let ze,Pe=f=>[new t(f),new i(f),new o(f),new p(f),new d(f),new r(f),new l(f),new n(f),new a(f),new g(f),new w(f),new h(f),new u(f),new m(f),new e(f),new s(f),new c(f)],_e=e=>{ze=e},ke=()=>window.performance.now(),Ie=[];class je{constructor(e){this.timestampStart=ke(),this.timestampPause=0,this.duration=e,this.paused=!1,this.awaits=[],Ie.push(this)}start(e){this.paused&&(this.timestampPause=ke(),this.unpause()),this.timestampStart=ke(),this.duration=e??this.duration}pause(){this.paused||(this.paused=!0,this.timestampPause=ke())}unpause(){this.paused&&(this.paused=!1,this.updateStart(ke()-this.timestampPause))}updateStart(e){this.timestampStart+=e}update(){this.isComplete()&&(this.awaits.forEach((e=>e())),this.awaits=[])}isComplete(){return this.getPctComplete()>=1}onCompletion(){return new Promise((e=>{this.isComplete()||this.awaits.push(e)}))}getPctComplete(){let e=ke();this.paused&&(e-=e-this.timestampPause);let t=e-this.timestampStart;return t>this.duration?t=this.duration:t<0&&(t=-1),Math.min(1,t/this.duration)}}class Me{constructor(e,t){this.max=e,this.current=0,this.decayRate=t}fill(e){this.current+=e,this.current>this.max&&(this.current=this.max)}empty(){this.current=0}isFull(){return this.current>=this.max}getPct(){return this.current/this.max}update(){this.current-=this.decayRate*$.fm,this.current<0&&(this.current=0)}}let De,Oe,Ue,Be=(e,t,s,r)=>({x:e,y:t,w:s,h:r}),Ge=(e,t,s)=>({x:e,y:t,r:s}),Le=(e,t,s,r)=>{let i=s-e,a=r-t;return Math.sqrt(i*i+a*a)},We=(e,t)=>{let[s,r,i]=e,[a,l,n]=t;return i=i||1,n=n||1,Le(s,r,a,l)<=i+n},Ve=(e,t)=>{let[s,r]=e,[i,a]=t,l=a-r,n=Le(s,r,i,a),o=0;return o=a>=r&&i>=s?180*Math.asin(l/n)/Math.PI+90:a>=r&&i<s?180*Math.asin(l/-n)/Math.PI-90:a<r&&i>s?180*Math.asin(l/n)/Math.PI+90:180*Math.asin(-l/n)/Math.PI-90,o>=360&&(o=360-o),o<0&&(o=360+o),o},$e=(e,t)=>{t=t??1;let s=e*Math.PI/180;return[Math.sin(s)*t,-Math.cos(s)*t]},Ke=(e,t)=>Math.floor(f(Math.random(),0,1,e,t+1)),qe={start:[,,253,.01,.02,.03,3,1.18,,-76,-2,,,,208,.1,,,.17,.01],end:[,,0,.25,.12,.23,3,.46,30,,-249,.05,.26,.9,,.2,,.97,.16,.02],invalid:[1.04,0,254,.01,.03,.13,1,.17,,.1,,,,.8,-61,.6,,.86,.02],col:[,,92,.02,.14,.01,1,.31,1.2,1.5,,,.11,,,,,,.08],upgrade:[1.21,,262,.11,.02,0,,2.4,,,221,.01,.16,,322,,.05,,.11],create:[,,104,,.06,.23,3,.32,,-71,-309,.01,,,20,,,.69,.17],heal:[1.1,,261,.18,.03,0,,1.63,-87,,,,.16,.2,-204,,.01,,.07],sink:[1.73,,187,.11,.02,.13,2,1.09,-97,,2,,,,11,.4,.08,.89,.04],baseExpl:[2.72,,749,.01,.29,.41,2,1.83,,.7,,,.14,.2,,.7,.17,.45,.02],shoot1:[.5,,424,.02,.01,.17,4,.16,-.7,,,,,2,.1,.2,,.62,.02,.21],exh:[.2,1,100,,.02,0,4,0,,36,,,,,8.4,-1,.13,,.15],exh2:[.4,1,100,,.02,0,4,0,,36,,,,,8.4,-1.4,.13,0,.15],hit1:[1.11,,325,.02,.1,.14,3,1.3,,-1.6,,,.05,1.3,-39,.1,,.88,.01,.24],hit2:[,,245,.01,,.16,4,2.46,2.5,,,,,1.7,,,,.46,.02],crate:[,,1727,.02,.01,.01,3,.33,,,108,.14,,,,.2],ghost:[2.18,,1258,.01,.08,.12,2,1.19,-.3,-8.5,-437,.01,.09,,,,.09,.57,.01,.17]},Ye=1,Je=e=>{let t=qe[e];if(!t)throw Error("no sound: "+e);Qe(.2*Ye),Xe(...t)};document.getElementById("volume").addEventListener("change",(e=>{Ye=+e.target.value/100,Je("coll")})),Oe=.3;let Qe=e=>{Oe=e};De=(e=1,t=.05,s=220,r=0,i=0,a=.1,l=0,n=1,o=0,h=0,c=0,d=0,p=0,g=0,u=0,m=0,w=0,f=1,x=0,y=0)=>{let T,C,v=Math,S=44100,E=2*v.PI,b=o*=500*E/S/S,F=s*=(1-t+2*t*v.random(t=[]))*E/S,A=0,N=0,R=0,H=1,z=0,P=0,_=0;for(h*=500*E/S**3,u*=E/S,c*=E/S,d*=S,p=S*p|0,C=(r=S*r+9)+(x*=S)+(i*=S)+(a*=S)+(w*=S)|0;R<C;t[R++]=_)++P%(100*m|0)||(_=l?1<l?2<l?3<l?v.sin((A%E)**3):v.max(v.min(v.tan(A),1),-1):1-(2*A/E%2+2)%2:1-4*v.abs(v.round(A/E)-A/E):v.sin(A),_=(p?1-y+y*v.sin(E*R/p):1)*(0<_?1:-1)*v.abs(_)**n*e*Oe*(R<r?R/r:R<r+x?1-(R-r)/x*(1-f):R<r+x+i?f:R<C-w?(C-R-w)/a*f:0),_=w?_/2+(w>R?0:(R<C-w?1:(C-R)/w)*t[R-w|0]/2):_),T=(s+=o+=h)*v.cos(u*N++),A+=T-T*g*(1-1e9*(v.sin(R)+1)%2),H&&++H>d&&(s+=c,F+=c,H=0),!p||++z%p||(s=F,o=b,H=H||1);return(e=Ue.createBuffer(1,C,S)).getChannelData(0).set(t),(s=Ue.createBufferSource()).buffer=e,s.connect(Ue.destination),s.start(),s},Ue=new(window.AudioContext||webkitAudioContext);let Xe=De;