var r=require("sandbox-io");
(function(){function C(a){for(var b in a)return!1;return!0}function D(){var a=24,b=20;function l(e){function f(a){1==d[a]&&(d[a]=m,h.push(a))}for(var c=0;c<b;c++)for(var g=0;g<a;g++){var l=a*c+g;d[l]&&(d[l]=1)}for(c=0;c<e.length;c++)d[e[c]]=10;for(var h=e.slice(),m;h.length;)l=h.shift(),m=d[l]+1,f(l+1),f(l-1),f(l+a),f(l-a)}var g={},d=[],c,e,f,n=[],h,m,q,p,t=[0,1,0,-1,1,0,1,0,1,0,-1,0,-1,0,-1,0];for(e=0;e<b;e++)for(f=0;2>f;f++)for(c=0;c<a;c++)g[c+","+e]=1,d.push(0),d.push(0);f=Math.random()*a|0;y0=
Math.random()*b|0;c=f;e=y0;a*=2;for(b*=2;!g[c+","+e]||(delete g[c+","+e],d[a*e*2+2*c]=1,!C(g));)for(q=t.slice();;){if(0==q.length){e=n.pop().split(",");c=+e[0];e=+e[1];break}p=q.splice(2*(q.length/2*Math.random()|0),2);h=c+p[0];m=e+p[1];if(g[h+","+m]){d[a*(2*e+p[1])+2*c+p[0]]=1;n.push(c+","+e);c=h;e=m;break}}l([a*y0+f]);for(g=0;5>g;g++)for(n=Math.random()*d.length|0;;){c=n%a;if(1<c&&c<a-1&&!d[n]&&d[n+1]&&d[n-1]&&!d[n-a]&&!d[n+a]&&20<Math.abs(d[n+1]-d[n-1])){d[n]=1;l([n]);break}n=(n+1)%d.length}d.m=
l;d.l=function(){for(var e={i:[],g:[]},c=0,f=0;f<b;f++)for(var l=0;l<a;l++)!d[c]||d[c+1]&&d[c-1]||(d[c+1]||d[c-1]?d[c+a]||d[c-a]||e.i.push(c):d[c+a]&&d[c-a]||d[c-a]&&e.g.push(c)),c++;return e}();return d}function A(a){for(var b=0;b<h.length;b++)if(h[b].id==a.id)return h[b]}function B(){var a={state:f,f:h,h:p};if(t){var b=(t-new Date)/1E3|0;b!=v&&(v=b,b=1==u?"<h2><span class='blue'>Blue</span> ":"<h2><span class='red'>Red</span> ",0==v?(b+=" TEAM WON!!!</h2>",r.b(m).a("news",{message:b}),f=0,a.state=
f,a.o=b):r.b(m).a("news",{message:b+"team winning in "+v+" !</h2>"}))}r.b(m).a("state",a)}function F(a){function b(){if(1==f){l--;if(0>=l&&5<g.length){f=2;var a=2*Math.random()|0;x=g[1-a];y=g[a];r.b(m).a("state",{state:f,u:48,v:40,s:q,red:x,blue:y,h:p});setTimeout(function E(){2==f&&(B(),setTimeout(E,33))},33)}else r.b(m).a("news",{message:"Game starting in "+l+"!"});setTimeout(b,1E3)}}f=1;t=0;r.b(m).a("news",{message:a.name+" started the game!"}).a("state",{state:f,f:h});var l=4,g=[];b();for(a=[];11>
a.length;)q=D(),a=q.l.g.concat(q.l.i);var d=Math.random()*a.length|0;for(g.push(a.splice(d,1)[0]);7>g.length;){q.m(g);for(var c=0,e=0;e<a.length;e++)q[a[e]]>c&&(c=q[a[e]],d=e);g.push(a.splice(d,1)[0])}p={};for(e=2;e<g.length;e++)p[g[e]]=0}function G(a){var b=A(a);b&&(h.splice(h.indexOf(b),1),z[a.id].disconnect(),delete z[a.id],b="",2>h.length&&(b=a.name+" left the game,<br> not enough players remained -<br> THE END",f=0,r.b(m).a("state",{state:f,f:h,o:b})),r.b(m).a("news",{message:a.name+" left the game"}))}
function H(a){p[a.j]=a.color;a=[0,0,0];for(var b in p)a[p[b]]++;r.b(m).a("news",{message:"<h3><span class='blue'><span style='font-size:x-large'>"+a[1]+"</span> blue</span> <span style='font-size:x-large'>"+a[0]+"</span> white <span class='red'><span style='font-size:x-large'>"+a[2]+"</span> red</span></h3>"});3<=a[1]?1!=u&&(t=+new Date+3E4,u=1):3<=a[2]?2!=u&&(t=+new Date+3E4,u=2):t=v=u=0}var h=[],p={},z={},x=-1,y=-1,t,u,v,q=[],m="g"+Math.random(),f=0,w=1;r.c("connection",function(a){w=3-w;var b=
{id:"p"+Math.random(),color:w};z[b.id]=a;a.c("playerInfo",function(a){for(k in a)b[k]=a[k];A(b)||(h.push(b),r.b(m).a("news",{message:b.name+" joined the game",A:b}));r.b(m).a("state",{state:f,f:h})});a.c("startGame",function(){F(b)});a.c("update",function(a){if(2==f){for(k in a)b[k]=a[k];a.w&&B()}});a.c("bulbUpdate",H);a.c("disconnect",G.bind(0,b));a.c("wallDestroyed",function(a){q[a.j]=1;r.b(m).a("onWallDestroyed",{B:a.j})});a.a("yourId",{id:b.id,color:w});2==f?(a.a("news",{message:"Game already started, join or wait?"}),
a.a("state",{state:3,u:48,v:40,s:q,red:x,blue:y,h:p,f:h})):a.a("state",{state:f,f:h})})})();
