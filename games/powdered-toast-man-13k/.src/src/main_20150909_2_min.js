var canvas,context,sheet,_={distance:function(t,i,e,a){return Math.sqrt(Math.pow(t-e,2)+Math.pow(i-a,2))},boundingBox:function(t,i,e,a,h,s,n,r){return t>h+n||h>t+e||s>i+a||i>s+r?!1:!0},getAngles:function(t,i){var e,a,h=Math.atan2(i.y-t.y,i.x-t.x);return 0>h&&(h+=2*Math.PI),e=h-t.heading,a=t.heading-h,0>=e&&(e+=2*Math.PI),0>=a&&(a+=2*Math.PI),e>=2*Math.PI&&(e-=2*Math.PI),a>=2*Math.PI&&(a-=2*Math.PI),{angle:h,clockwise:e,counter:a}}},map={width:3e3,height:1e3,horizon:-50},ptm={w:64,h:64,x:0,y:0,tempX:0,tempY:0,dx:0,dy:0,logs:0,target:{x:-500,y:map.horizon-75,w:75,h:75,size:75},radian:0,heading:0,userPress:!1,userPitch:0,flightPower:50,flightState:"ready",viewCentered:!0,win:!1,winLostCheck:function(){return _.distance(this.x,this.y,this.target.x,this.target.y)<this.target.size/2?(this.logs++,this.win=!0,void(this.flightState="over")):void(this.y>=map.horizon-this.h&&(this.flightState="over"))},onState:{ready:function(){this.win=!1,this.heading=2*Math.PI/4*3,this.radian=this.heading,this.x=-130,this.y=map.horizon-this.h,this.tempX=this.x,this.tempY=this.y,this.flightPower=330*dial.setting,toastBar.setting>0&&(this.flightState="bardrag")},bardrag:function(){this.heading=-(Math.PI*toastBar.setting),this.radian=Math.PI/2*3-Math.PI*toastBar.setting,this.x=120*Math.cos(this.heading)+this.tempX-120,this.y=120*Math.sin(this.heading)+this.tempY,0===toastBar.setting&&(this.flightState="ready"),toastBar.started&&(this.tempY=map.height*dial.setting*-1,this.flightState="launch")},launch:function(){toastBar.started=!1,this.dy=this.y>this.tempY?-1*(15*(this.tempY-this.y)/this.tempY+1):0,this.y+=this.dy,this.dy>=0&&(this.flightState="levelout")},levelout:function(){this.radian-=Math.PI/50,this.radian<=0&&(this.heading=0,this.radian=0,this.flightState="flying")},flying:function(){if(this.dx=5*Math.cos(this.radian-Math.PI),this.dy=5*Math.sin(this.radian-Math.PI),this.x+=this.dx,this.y+=this.dy,this.winLostCheck(),this.flightPower-=1,this.userPress){var t=viewPort.getVPRelative(this.x,this.y);this.heading=Math.atan2(t.y+32-this.tempY,t.x+32-this.tempX),this.heading>.78&&(this.heading=.78),this.heading<-.78&&(this.heading=-.78),this.radian=this.heading}this.flightPower<=0&&(this.flightState="freefall")},freefall:function(){this.winLostCheck(),this.heading>-.78?this.heading-=.025:this.heading=-.78,this.radian=this.heading,this.dx=5*Math.cos(this.radian-Math.PI),this.dy=5*Math.sin(this.radian-Math.PI),this.x+=this.dx,this.y+=this.dy},over:function(){}},update:function(){this.onState[this.flightState].call(this),this.x>=-this.w&&(this.x=-this.w),this.x<=-map.width&&(this.x=-map.width),this.y>=map.horizon-this.h&&(this.y=map.horizon-this.h),this.y<=-map.height&&(this.y=-map.height),this.viewCentered&&viewPort.moveViewPort(ptm.x+5,ptm.y+5)},pitch:function(t,i){var e;"flying"===this.flightState&&this.userPress&&(e=viewPort.getVPRelative(this.x,this.y),this.tempX=t,this.tempY=i)}},viewPort={width:640,height:480,x:-640,y:-480,getVPRelative:function(t,i){return{x:-1*(this.x-t),y:-1*(this.y-i)}},moveViewPort:function(t,i){this.x=t-Math.floor(this.width/2),this.y=i-Math.floor(this.height/2)}},toastBar={x:550,y:190,width:60,height:150,press:!1,setting:0,started:!1,update:function(){!this.started&&!this.press&&this.setting>0&&(this.setting-=.05),this.setting<0&&(this.setting=0)},getLeaverPos:function(){var t,i;return t=this.x+10,i=this.y+10+(this.height-40)*this.setting,{x:t,y:i,w:40,h:20}},onDrag:function(t,i){var e,a=i-this.y-20;this.press&&!this.started&&_.boundingBox(t,i,1,1,this.x,this.y,this.width,this.height)&&(e=this.getLeaverPos(),this.setting=a/(this.height-40),this.setting<0&&(this.setting=0),this.setting>=1&&(this.setting=1,this.started=!0))}},dial={x:580,y:430,radius:50,setting:.25,heading:0,press:!1,findHeading:function(){this.heading=.8*Math.PI+1.4*Math.PI*this.setting},onPoint:function(t,i){var e;!toastBar.started&&this.press&&_.distance(t,i,this.x,this.y)<=this.radius+10&&(e=_.getAngles(this,{x:t,y:i}),this.heading=e.angle>.8*Math.PI||e.angle<.2*Math.PI?e.angle:e.angle>.5*Math.PI?.8*Math.PI:.2*Math.PI,this.setting=this.heading>=.8*Math.PI?(this.heading-.8*Math.PI)/(1.4*Math.PI):(this.heading+1.2*Math.PI)/(1.4*Math.PI))}},draw=function(t){var i,e,a,h=Math.abs(viewPort.y)%50,s=Math.abs(viewPort.x)%50,n=255-12*Math.floor(Math.abs(viewPort.y)/50),r=0,l=0;for(t.fillRect(0,0,640,h);11>r;){for(n+=12,t.fillStyle="rgb(0,"+n+","+n+")",t.fillStyle="rgb(0,"+n+","+n+")",t.fillRect(0,h-50+50*r,640,50),t.strokeStyle="rgba(255,255,255,0.5)",l=0;14>l;)t.strokeRect(s-50+50*l,h-50+50*r,50,50),l++;r++}i=viewPort.getVPRelative(0,map.horizon),t.fillStyle="#00af00",t.fillRect(0,i.y,viewPort.width,viewPort.width-i.y),i=viewPort.getVPRelative(ptm.target.x,map.horizon-ptm.target.size),t.fillStyle="#ff00ff",t.fillRect(i.x,i.y,ptm.target.size,ptm.target.size),i=viewPort.getVPRelative(ptm.x,ptm.y),t.fillStyle="#ff0000",t.save(),t.translate(i.x+ptm.w/2,i.y+ptm.h/2),t.rotate(ptm.radian),t.drawImage(sheet,-32,-16,64,32),t.restore(),a=_.getAngles(ptm,ptm.target),t.save(),t.translate(i.x+ptm.w/2,i.y+ptm.h/2),t.rotate(a.angle),t.fillRect(100,-5,50,10),t.restore(),t.textAlign="left",t.strokeStyle="#000000",t.fillStyle="#ffffff",t.beginPath(),t.moveTo(dial.x,dial.y),t.lineTo(Math.cos(.8*Math.PI)*dial.radius+dial.x,Math.sin(.8*Math.PI)*dial.radius+dial.y),t.arc(dial.x,dial.y,dial.radius,.8*Math.PI,.2*Math.PI),t.closePath(),t.stroke(),t.fill(),t.fillStyle="#000000",t.beginPath(),t.arc(dial.x,dial.y,20,0,2*Math.PI),t.stroke(),t.fill(),e=toastBar.getLeaverPos(),t.fillStyle="#808080",t.fillRect(toastBar.x,toastBar.y,toastBar.width,toastBar.height),t.fillStyle="#c0c0c0",t.fillRect(e.x,e.y,e.w,e.h),t.fillStyle="#ff0000",t.beginPath(),t.moveTo(dial.x,dial.y),t.lineTo(10*Math.cos(dial.heading+1.57)+dial.x,10*Math.sin(dial.heading+1.57)+dial.y),t.lineTo(Math.cos(dial.heading)*(dial.radius+10)+dial.x,Math.sin(dial.heading)*(dial.radius+10)+dial.y),t.lineTo(10*Math.cos(dial.heading-1.57)+dial.x,10*Math.sin(dial.heading-1.57)+dial.y),t.closePath(),t.stroke(),t.fill(),t.fillStyle="#000000",t.textAlign="center",t.textBaseline="top",t.font="20px arial",t.fillText(dial.setting.toFixed(2),dial.x,dial.y+20),t.textAlign="left",t.font="15px courier",t.fillStyle="#ffff00",t.fillText("distance: "+_.distance(ptm.x,ptm.y,ptm.target.x,ptm.target.y).toFixed(2),10,10),t.fillText("flight Power! : "+Math.floor(ptm.flightPower),10,25),t.fillText("logs : "+Math.floor(ptm.logs),10,450)},start=function(){canvas=document.createElement("canvas"),canvas.width=640,canvas.height=480,context=canvas.getContext("2d"),document.getElementById("game_container").appendChild(canvas),canvas.addEventListener("mousedown",function(){ptm.userPress=!0,toastBar.press=!0,dial.press=!0,"over"===ptm.flightState&&newGame()}),canvas.addEventListener("mouseup",function(){ptm.userPress=!1,toastBar.press=!1,dial.press=!1}),canvas.addEventListener("mousemove",function(t){var i=this.getBoundingClientRect(),e=t.clientX-i.left,a=t.clientY-i.top;ptm.pitch(e,a),dial.onPoint(e,a),toastBar.onDrag(e,a)}),dial.findHeading(),newGame(),sheet=new Image,sheet.addEventListener("load",function(){thread()}),sheet.src="img/powdered_tost_man_64_32.png"},newGame=function(){ptm.target.x=Math.floor(-2500*Math.random()-500),ptm.flightState="ready"},update=function(){ptm.update(),toastBar.update()},thread=function(){setTimeout(thread,33),update(),draw(context)};start();