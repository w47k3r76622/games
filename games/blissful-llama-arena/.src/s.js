var a=require("sandbox-io"),b=0,c={};function A(){this.id=b++;c[this.id]=this;this.d={};this.e={};this.f={a:20,b:20,c:0,d:0,f:0};this.g={};for(var e=0;3>e;e++)for(var d=0;7>d;d++)this.e[e+15*d]=11;this.e[2+15*Math.floor(7*Math.random())]=9+Math.floor(2*Math.random())-1;for(e=3;12>e;e++)for(d=0;7>d;d++)this.e[e+15*d]=9+Math.floor(2*Math.random())-1;for(e=12;15>e;e++)for(d=0;7>d;d++)this.e[e+15*d]=12;this.e[12+15*Math.floor(7*Math.random())]=9+Math.floor(2*Math.random())-1;for(e=1;6>=e;e++)this.d[e]={f:e%2,x:e%2?3:11,y:e,i:e%2?3:6,j:0,p:0,l:0};for(e=1;6>=e;e++)this.g[this.d[e].x+15*this.d[e].y]={f:this.d[e].i,j:this.d[e].j};setTimeout(this.tic.bind(this),10)}A.prototype.tic=function(){this.f.f&&(a.to(this.id).emit("g",{e:this.e,g:this.g}),this.f.f=0);if(!this.s&&.9<Math.random()){var e=Math.floor(8*Math.random()+3),d=Math.floor(7*Math.random());this.g[e+15*d]||14==this.e[e+15*d]||(this.s={x:e,y:d,j:7,t:Math.floor(7*Math.random()),i:13},this.f.f=1)}else this.s&&.1<this.s.j&&(this.s.j-=.1,this.f.f=1);for(var g=new Date,f=1;6>=f;f++)if(!this.d[f].p&&.9<Math.random()&&this.d[f].l+500<g.getTime()){for(var h=1E3,d=this.d[f].y,k=5,p=1;6>=p;p++)if(this.d[p].p&&f%2!=p%2&&.9<Math.random()){var l=this.d[p].x,n=this.d[p].y;l*l+n*n<h&&(h=l*l+n*n,k=1<Math.abs(e-l)+Math.abs(d-n)?Math.abs(e-l)<Math.abs(d-n)?d<n?4:2:e<l?3:1:0)}C(this.d[f],this,5!=k?k:Math.floor(4*Math.random()+1));this.d[f].l=g.getTime()}for(var m in this.d).1<this.d[m].j&&(this.d[m].j-=.1,this.f.f=1);if(this.f.f){this.g={};for(m in this.d)this.g[this.d[m].x+15*this.d[m].y]={f:this.d[m].i,j:this.d[m].j};this.s&&(this.g[this.s.x+15*this.s.y]={f:this.s.i,j:this.s.j})}!this.d&&this.f.c?delete l[this.id]:setTimeout(this.tic.bind(this),50)};function B(e){this.a=e;for(var d=0;d<b;d++)c[d]&&!c[d].f.c&&6!=c[d].f.d&&(this.g=c[d]);this.g||(this.g=new A);for(d=1;!this.id;d++)this.g.d[d].p||(this.id=d,this.g.d[d].p++,this.g.f.d++);for(var g in this.g.d[this.id])this[g]=this.g.d[this.id][g];e.on("m",function(d){C(this,this.g,d)}.bind(this));e.on("disconnect",function(){this.g.d[this.id].p=0;this.g.f.d--}.bind(this));e.join(this.g.id)}function C(e,d,g){11!=d.e[e.x+15*e.y]||e.f||(d.e[e.x+15*e.y]=9,d.f.a--);12==d.e[e.x+15*e.y]&&e.f&&(d.e[e.x+15*e.y]=9,d.f.b--);d.f.a&&d.f.b||(c[d.id]&&(c[d.id].f.c=1),e.a&&e.a.disconnect());var f=e.x,h=e.y;1==g&&0<f?(f--,e.i=e.f?2:6):2==g&&0<h?(h--,e.i=e.f?0:4):3==g&&14>f?(f++,e.i=e.f?3:7):4==g&&14>h&&(h++,e.i=e.f?1:5);if(d.s&&.1>=d.s.j&&f==d.s.x&&h==d.s.y){if(0==d.s.t)for(g=d.f.a,d.f.a=d.f.b,d.f.b=g,g=0;15>g;g++)for(var k=0;7>k;k++)11==d.e[g+15*k]?d.e[g+15*k]=12:12==d.e[g+15*k]&&(d.e[g+15*k]=11);else if(1==d.s.t)d.e[d.s.x+15*d.s.y]=11,d.f.a++;else if(2==d.s.t)d.e[d.s.x+15*d.s.y]=12,d.f.b++;else if(3==d.s.t)d.e[d.s.x+15*d.s.y]=14;else if(4==d.s.t)for(g=1;6>=g;g++)d.d[g].f=0==d.d[g].f?1:0;else 5==d.s.t&&(e.f=0==e.f?1:0);delete d.g[d.s.x+15*d.s.y];delete d.s}if(d.g[f+15*h]||14==d.e[f+15*h])f-=2*(f-e.x),h-=2*(h-e.y);if(d.g[f+15*h]||14==d.e[f+15*h])f=e.x,h=e.y;if(0>f||14<f||0>h||6<h)f=e.x,h=e.y;e.j=.7;e.x=f;e.y=h;d.d[e.id]=e;d.f.f=1}a.on("connection",function(e){new B(e)});
