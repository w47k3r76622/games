let{init:init,Sprite:Sprite,Pool:Pool,initKeys:initKeys,bindKeys:bindKeys,load:load,setImagePath:setImagePath,imageAssets:imageAssets,getContext:getContext,keyPressed:keyPressed,GameLoop:GameLoop}=kontra,{canvas:canvas}=init();canvas.width=1200,canvas.height=canvas.width/16*9,canvas.style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; margin: auto; border:1px solid gray";let context=getContext("2d");context.webkitImageSmoothingEnabled=!1,context.mozImageSmoothingEnabled=!1,context.imageSmoothingEnabled=!1;let UNIT_MAP_WIDTH=canvas.width/16,UNIT_MAP_HEIGHT=canvas.height/9,BLACK="#333333",WHITE="#FFFFFF",IS_BACK_SIDE=!1,state=0,LEVEL_1=[[[0,6*UNIT_MAP_HEIGHT,10*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[10*UNIT_MAP_WIDTH,3*UNIT_MAP_HEIGHT,6*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT]],[12.5*UNIT_MAP_WIDTH,2.5*UNIT_MAP_HEIGHT,0]],LEVEL_2=[[[0,3*UNIT_MAP_HEIGHT,5*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[5*UNIT_MAP_WIDTH,6*UNIT_MAP_HEIGHT,6*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[11*UNIT_MAP_WIDTH,3*UNIT_MAP_HEIGHT,5*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT]],[13*UNIT_MAP_WIDTH,2.5*UNIT_MAP_HEIGHT,0]],LEVEL_3=[[[0,6*UNIT_MAP_HEIGHT,4*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[4*UNIT_MAP_WIDTH,2*UNIT_MAP_HEIGHT,3*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[7*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT,3*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[10*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,3*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[13*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT,3*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT]],[14*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT+5,1]],LEVEL_4=[[[0,2*UNIT_MAP_HEIGHT,3*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[3*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[4*UNIT_MAP_WIDTH,6*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[5*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,2*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[7*UNIT_MAP_WIDTH,6*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[8*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[9*UNIT_MAP_WIDTH,2*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[10*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[11*UNIT_MAP_WIDTH,6*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[12*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,2*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[14*UNIT_MAP_WIDTH,6*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[15*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT]],[15.1*UNIT_MAP_WIDTH,4*UNIT_MAP_HEIGHT+5,1]],LEVEL_5=[[[0,6*UNIT_MAP_HEIGHT,3*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[3*UNIT_MAP_WIDTH,2*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[4*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[5*UNIT_MAP_WIDTH,5.5*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[6*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[7*UNIT_MAP_WIDTH,3.5*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[8*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[9*UNIT_MAP_WIDTH,1.5*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[10*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[11*UNIT_MAP_WIDTH,3.5*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[12*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[13*UNIT_MAP_WIDTH,5.5*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[14*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT,UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT],[15*UNIT_MAP_WIDTH,3.5*UNIT_MAP_HEIGHT,1.5*UNIT_MAP_WIDTH,9*UNIT_MAP_HEIGHT]],[15.1*UNIT_MAP_WIDTH,3.5*UNIT_MAP_HEIGHT+5,1]],LEVELS=[LEVEL_1,LEVEL_2,LEVEL_3,LEVEL_4,LEVEL_5],CUR_LEVEL=0;setImagePath("img"),load("home.png","player1.png","player2.png","player3.png","player4.png","key1.png","key2.png").then(function(){let TITLE=imageAssets.home,PLAYER_FRAME1=imageAssets.player1,PLAYER_FRAME2=imageAssets.player2,PLAYER_BACK_FRAME1=imageAssets.player3,PLAYER_BACK_FRAME2=imageAssets.player4,KEYS=[imageAssets.key1,imageAssets.key2],goal=Sprite({x:12.5*UNIT_MAP_WIDTH,y:2*UNIT_MAP_HEIGHT,width:.8*UNIT_MAP_HEIGHT,height:UNIT_MAP_HEIGHT/2.5,image:imageAssets.key1,update:update_goal});function drawHomepage(){context.fillStyle=BLACK,context.fillRect(0,canvas.height/2-1,canvas.width,canvas.height/2);let _=TITLE;titleX=canvas.width/2-5*_.width,titleY=canvas.height/2-5*_.height,context.drawImage(_,titleX,titleY,10*_.width,10*_.height),context.font="24px Arial",context.textAlign="center",context.fillStyle=WHITE,context.fillText("Use ARROW KEY to control.",canvas.width/2,canvas.height/2+120),context.fillText("Press ENTER to start.",canvas.width/2,canvas.height/2+180)}function game_over(){context.font="100px Arial",context.textAlign="left",context.fillStyle=BLACK,context.fillText("Game over, you win!",150,350)}function update_goal(){goal.image=KEYS[LEVELS[CUR_LEVEL][1][2]],this.x=LEVELS[CUR_LEVEL][1][0],this.y=LEVELS[CUR_LEVEL][1][1],this.collidesWith(player)&&(CUR_LEVEL<LEVELS.length-1?(CUR_LEVEL++,player.x=100,player.y=0,player.is_landed=!1,tile_pool.clear()):state=2)}function generate_map(){LEVELS[CUR_LEVEL][0].forEach(function(_){get_tile(..._)})}let player=Sprite({x:100,y:0,pre_y:0,width:.64*UNIT_MAP_HEIGHT,height:UNIT_MAP_HEIGHT,dy:0,ddy:0,is_landed:!1,move_right:null,rotation:0,animCount:0,image:PLAYER_FRAME1,walk:player_walk});function player_walk(){30===player.animCount&&(player.image=IS_BACK_SIDE?PLAYER_BACK_FRAME2:PLAYER_FRAME2),60===player.animCount&&(player.image=IS_BACK_SIDE?PLAYER_BACK_FRAME1:PLAYER_FRAME1,player.animCount=0),player.animCount+=1}let tile_pool=Pool({create:Sprite,maxSize:16});function get_tile(_,e,I,T){tile_pool.get({x:_,y:e,width:I,height:T,anchor:{x:0,y:0},color:BLACK,update:update_status})}function update_status(){IS_BACK_SIDE?(this.anchor={x:0,y:1},this.color=WHITE):(this.anchor={x:0,y:0},this.color=BLACK),player.collidesWith(this)?IS_BACK_SIDE?player.y-player.height<=this.y&&player.x+player.width>=this.x&&player.x<=this.x+this.width&&(player.pre_y-player.height>=this.y?(player.y=this.y+player.height,player.dy=0,player.ddy=0,player.is_landed=!0):player.move_right?player.x=this.x-player.width:player.x=this.x+this.width):player.y+player.height>=this.y&&player.x+player.width>=this.x&&player.x<=this.x+this.width&&(player.pre_y+player.height<=this.y+1?(player.y=this.y-player.height+1,player.dy=0,player.ddy=0,player.is_landed=!0):player.move_right?player.x=this.x-player.width:player.x=this.x+this.width):(player.ddy=IS_BACK_SIDE?-1:1,Math.abs(player.dy)>0&&(player.is_landed=!1))}function fill_canvas(){context.fillStyle=IS_BACK_SIDE?BLACK:WHITE,context.fillRect(0,0,canvas.width,canvas.height)}function log_pre_pos(){player.pre_x=player.x,player.pre_y=player.y}function playShort(moveType){switch(moveType){case"jump":D=IS_BACK_SIDE?[13,12,10]:[13,12,15];break;case"flip":D=IS_BACK_SIDE?[10,15]:[15,10];break;default:D=[]}with(new AudioContext)with(G=createGain())for(i in D)with(createOscillator())D[i]&&(connect(G),G.connect(destination),start(.1*i),frequency.setValueAtTime(440*1.06**(13-D[i]),.1*i),gain.setValueAtTime(1,.1*i),gain.setTargetAtTime(1e-4,.1*i+.08,.005),stop(.1*i+.09))}initKeys();let loop=GameLoop({update:function(){0===state?keyPressed("enter")&&(state+=1):1===state&&(generate_map(),goal.update(),log_pre_pos(),!IS_BACK_SIDE&&player.y+player.height>=canvas.height&&(player.is_landed=!1,player.x=100,player.y=0),IS_BACK_SIDE&&player.y-player.height<0&&(player.is_landed=!1,player.x=100,player.y=9*UNIT_MAP_HEIGHT),keyPressed("up")?player.is_landed&&(playShort("jump"),IS_BACK_SIDE&&(IS_BACK_SIDE=!1,player.image=PLAYER_FRAME1,player.animCount=0,player.anchor={x:0,y:0},player.y-=150),player.dy=-20,player.ddy=1,player.is_landed=!1):keyPressed("down")&&player.is_landed&&(playShort("flip"),IS_BACK_SIDE||(IS_BACK_SIDE=!0,player.image=PLAYER_BACK_FRAME1,player.animCount=0,player.anchor={x:0,y:1},player.y+=150),player.dy=20,player.ddy=-1,player.is_landed=!1),keyPressed("right")?(player.x+=5,player.move_right=!0):keyPressed("left")&&(player.x-=5,player.move_right=!1),player.walk(),player.update(),tile_pool.update())},render:function(){0===state?drawHomepage():1===state&&(fill_canvas(),tile_pool.render(),goal.render(),player.render()),2===state&&game_over()}});loop.start()}).catch(function(_){console.log(_)});