(function(){"use strict";window.jw={gameWidth:800,gameHeight:480};window.addEventListener("load",function(){var e=document.querySelectorAll("canvas");for(var t=0;t<e.length;t++){e[t].width=jw.gameWidth;e[t].height=jw.gameHeight}jw.game.resetPoints();jw.game.resetRewinds()})})();(function(){"use strict";var e=document.querySelector("#title");var t=e.getContext("2d");var n=48;var i=32;var a="Courier New";window.addEventListener("load",function(){requestAnimationFrame(function(){t.font=n+"px "+a;t.fillStyle="white";t.fillText("Time Worm!",jw.gameWidth/3,jw.gameHeight/3-n);t.font=i+"px "+a;t.fillText("(c) James Wright 2015",jw.gameWidth/3-70,jw.gameHeight/2-i+n);t.fillText("jamesswright.co.uk",jw.gameWidth/3-35,jw.gameHeight/2+30+n);t.fillText("Click to play!",jw.gameWidth/3+10,jw.gameHeight/2+30+n+i*2)});e.addEventListener("click",function(){var t=document.querySelector("#instructions");t.style.display="block";e.style.display="none";jw.instructions.render()})})})();(function(){"use strict";var e=document.querySelector("#instructions");var t=document.querySelector("#player");var n=e.getContext("2d");var i="Courier New";var a=26;var r=20;var o=50;var s=50;var d=160;var c;e.addEventListener("click",function(){jw.game.begin();e.style.display="none"});function l(){t.style.display="block";requestAnimationFrame(function(){n.font=r+"px "+i;n.fillStyle="white";n.fillText("You are the Time Worm! Your job is to destroy",o,d);n.fillText("as many little grey men as possible. Your health",o,d+r);n.fillText("is represented by the number of your body's,",o,d+r*2);n.fillText("segments plus your head. The only way to restore",o,d+r*3);n.fillText("health is to rewind time. You can do so for up to",o,d+r*4);n.fillText('5 seconds. You can gain "rewinds" by collecting',o,d+r*5);n.fillText("the clocks.",o,d+r*6);c=d+r*6+s;n.font=a+"px "+i;n.fillText("Controls",o,c);n.font=r+"px "+i;n.fillText("Up - Move up",o,c+a);n.fillText("Down - Move down",o,c+a*2);n.fillText("Space - Fire",o,c+a*3);n.fillText("Left - Rewind time for 5 seconds",o,c+a*4);n.font=a+"px "+i;n.fillText("Click to begin!",jw.gameWidth-o-300,c)})}jw.instructions={render:l}})();(function(){"use strict";var e=new Event("begingame");var t=new Event("gameover");var n=new Event("restartgame");jw.game={points:0,rewinds:0,initialPoints:0,initialRewinds:1,maxRewinds:2,isRewinding:false,incrementPoints:function e(t){this.points+=t;jw.hud.renderPoints(this.points)},resetPoints:function e(t){this.points=this.initialPoints;jw.hud.renderPoints(this.points)},resetRewinds:function e(){this.rewinds=this.initialRewinds;this.canRewind=true;jw.hud.renderRewinds(this.rewinds)},incrementRewinds:function e(){if(this.rewinds<this.maxRewinds)this.rewinds++;this.canRewind=true;jw.hud.renderRewinds(this.rewinds)},decrementRewinds:function e(){if(this.canRewind)this.rewinds--;this.canRewind=this.rewinds>0;jw.hud.renderRewinds(this.rewinds)},gameOver:function e(){this.canRewind=false;if(this.isRewinding)jw.events.play();window.dispatchEvent(t);jw.hud.renderGameOver()},begin:function t(){var n=document.querySelectorAll(".game-canvas");for(var i=0;i<n.length;i++)n[i].style.display="block";window.dispatchEvent(e)},restart:function e(){this.resetPoints();this.resetRewinds();window.dispatchEvent(n)}}})();(function(){"use strict";var e=document.querySelector("#clocks").getContext("2d");var t=28;var n=new Image;var i=7e3;var a=Date.now();var r=false;var o=6;var s;var d;n.src="clock.png";function c(){var l=Date.now()-a>i&&!jw.game.isRewinding&&!r&&jw.game.rewinds<jw.game.maxRewinds;var w;var u;if(l){s=jw.gameWidth+t;d=Math.ceil(Math.random()*jw.gameHeight);r=true}if(r){e.clearRect(s,d,t,t);w=jw.player.getByPosition(s,d,t,t);s-=o;e.drawImage(n,s,d,t,t);if(w){jw.game.incrementRewinds();e.clearRect(s,d,t,t);u=true;jw.sounds.play("collect")}}if(u||s+t<0){r=u=false;s=0;d=Math.ceil(Math.random()*jw.gameHeight);a=Date.now()}requestAnimationFrame(c)}window.addEventListener("begingame",function(){requestAnimationFrame(c)});jw.clock={sprite:n,spriteSize:t}})();(function(){"use strict";var e=document.querySelector("#hud");var t=e.getContext("2d");var n=25;var i=50;var a=32;var r=28;var o="Courier New";window.addEventListener("begingame",s);window.addEventListener("restartgame",s);function s(){requestAnimationFrame(function(){t.drawImage(jw.clock.sprite,i+jw.gameWidth/3+25,n-3,jw.clock.spriteSize,jw.clock.spriteSize)})}function d(e){requestAnimationFrame(function(){t.clearRect(i,n,jw.gameWidth/3,a);t.fillStyle="white";t.font=a+"px "+o;t.fillText(e+" points",i,n+20)})}function c(e){requestAnimationFrame(function(){t.clearRect(i+jw.gameWidth/3,n,20,a);t.fillStyle="white";t.font=a+"px "+o;t.fillText(e,i+jw.gameWidth/3,n+20)})}function l(){requestAnimationFrame(function(){t.fillStyle="rgba(0, 0, 0, 0.3)";t.fillRect(0,0,jw.gameWidth,jw.gameHeight);t.fillStyle="white";t.font=a+"px "+o;t.fillText("Game Over!",jw.gameWidth/3+30,jw.gameHeight/2);t.font=r+"px "+o;t.fillText("Click to replay!",jw.gameWidth/3-5,jw.gameHeight/2+a)});e.addEventListener("click",w)}function w(){t.clearRect(0,0,jw.gameWidth,jw.gameHeight);jw.game.restart();e.removeEventListener("click",w)}jw.hud={renderPoints:d,renderGameOver:l,renderRewinds:c}})();(function(){"use strict";var e={up:{active:false,onDown:null,onUp:null},down:{active:false,onDown:null,onUp:null},left:{active:false,onDown:null,onUp:null},right:{active:false,onDown:null,onUp:null},space:{active:false,onDown:null,onUp:null,simultaneous:true}};var t={38:"up",40:"down",37:"left",39:"right",32:"space"};window.addEventListener("begingame",n);window.addEventListener("restartgame",n);window.addEventListener("gameover",i);function n(){window.addEventListener("keydown",a);window.addEventListener("keyup",r)}function i(){window.removeEventListener("keydown",a);window.removeEventListener("keyup",r);Object.keys(e).forEach(function(t){var n=e[t];n.active=false;n.onUp&&n.onUp()})}function a(n){var i=e[t[n.keyCode]];if(!i||i.active)return;!i.simultaneous&&o();i.active=true;i.onDown&&i.onDown()}function r(n){var i=e[t[n.keyCode]];if(!i||!i.active)return;i.active=false;i.onUp&&i.onUp()}function o(){for(var t in e){var n=e[t];if(!n.simultaneous){n.active=false;n.onUp&&n.onUp()}}}window.jw.keyman=e})();(function(){"use strict";var e=5e3;var t=[];var n={};window.addEventListener("restartgame",function(){t=[]});function i(){t=t.filter(function(t){return Date.now()-t.time<=e})}function a(e,t){n[e]=t}function r(e,n){i();t.push({type:e,data:n,time:Date.now()})}function o(i){var a=Date.now();jw.game.isRewinding=true;jw.game.decrementRewinds();jw.sounds.play("rewind");Object.keys(n).forEach(function(e){n[e].onRewindStart&&n[e].onRewindStart()});t.forEach(function(e){var t=n[e.type];if(t.onRewindFrame)setTimeout(n[e.type].onRewindFrame.bind(n[i],e),a-e.time)});setTimeout(s,e)}function s(){jw.game.isRewinding=false;Object.keys(n).forEach(function(e){n[e].onPlay&&n[e].onPlay()})}jw.events={add:r,register:a,rewind:o,play:s,trackingThreshold:e}})();(function(){"use strict";var e=document.querySelector("#background").getContext("2d");var t=r();jw.events.register("bg",t);function n(){}function i(){}function a(e){o();requestAnimationFrame(a)}function r(){var e=150;var t=[];for(var a=0;a<e;a++){var r=Math.ceil(Math.random()*3);var o=2*r;t.push({size:r,speed:o,decelerationRate:0,x:Math.ceil(Math.random()*jw.gameWidth),y:Math.ceil(Math.random()*jw.gameHeight)})}return{starFill:"white",stars:t,onRewindStart:n,onPlay:i}}function o(){e.fillStyle=t.starFill;t.stars.forEach(function(t){if(!jw.game.isRewinding)t.decelerationRate=0;else if(jw.game.isRewinding&&t.decelerationRate<t.speed*2)t.decelerationRate+=.5;e.clearRect(t.x-t.speed-t.decelerationRate,t.y-t.decelerationRate,t.size+t.decelerationRate+t.speed,t.size+t.decelerationRate);t.x-=t.speed-t.decelerationRate;if(t.x+t.size<0)t.x=jw.gameWidth+t.size;if(t.x>jw.gameWidth+t.size)t.x=0-t.size;e.fillRect(t.x,t.y,t.size,t.size)})}requestAnimationFrame(a)})();(function(){"use strict";jw.sounds={play:function e(t){var n=new Audio(t+".mp3");n.play()}}})();(function(){"use strict";var e=[];var t=50;var n=5;var i=document.querySelector("#laser").getContext("2d");var a={addBeam:o,onPlay:r};window.addEventListener("restartgame",function(){requestAnimationFrame(function(){i.clearRect(0,0,jw.gameWidth,jw.gameHeight)});e=[]});function r(){e.forEach(function(e){e.decelerationRate=0})}function o(t){if(jw.game.isRewinding)return;jw.events.add("beamAdded",{x:t.x,y:t.y});t.decelerationRate=0;e.push(t);jw.sounds.play("fire")}function s(){e=e.filter(function(e){return e.x+t>0&&e.x<=jw.gameWidth&&!e.hasHit});e.forEach(function(e){var a;i.clearRect(e.x-e.speed-e.decelerationRate,e.y,t+e.speed+e.decelerationRate,n);a=jw[e.target].getByPosition(e.x,e.y,t,n);if(a){a.onHit();e.hasHit=true;i.clearRect(e.x,e.y,t,n);jw.sounds.play("explosion")}else{if(jw.game.isRewinding&&e.isRewindable&&e.decelerationRate<Math.abs(e.speed*2))e.decelerationRate+=.8;e.x+=e.speed+e.decelerationRate;i.fillStyle="yellow";i.fillRect(e.x,e.y,t,n)}});requestAnimationFrame(s)}requestAnimationFrame(s);jw.events.register("beamAdded",a);jw.laser=a})();(function(){"use strict";var e=Date.now();var t=1e4;var n=3e3;var i=0;var a=[];var r=60;var o=32;var s=7;var d=100;var c=new Image;var l=document.querySelector("#enemy").getContext("2d");var w=0;c.src="enemy.png";var u={getByPosition:v,onRewindFrame:f,onPlay:m};window.addEventListener("restartgame",function(){a=[];requestAnimationFrame(function(){l.clearRect(0,0,jw.gameWidth,jw.gameHeight)})});function f(e){if(e.type==="enemyLeftScreen"){g(e.data.x,e.data.y)}}function m(){i=jw.events.trackingThreshold;w=0;setTimeout(function(){i=0},i)}function v(e,t,n,i){return a.filter(function(a){return e+n>=a.x&&e<=a.x+r&&t>=a.y&&t+i<=a.y+o})[0]}function g(e,t){var n={x:e||jw.gameWidth+r,y:t||Math.ceil(Math.random()*jw.gameHeight),onHit:function e(){this.dead=true;jw.game.incrementPoints(d);jw.events.add("enemyDestroyed",{x:u.x,y:u.y})}};a.push(n)}function h(){if(jw.game.isRewinding&&w<s*2)w+=.4;if(!jw.game.isRewinding&&Date.now()-e>Math.ceil(Math.random()*t)+i){g();e=Date.now()}a=a.filter(function(e){if(e.dead){l.clearRect(e.x,e.y,r,o)}if(e.x+r<-r){jw.events.add("enemyLeftScreen",{x:-r,y:e.y})}return!e.dead&&e.x+r>-1-r});a.forEach(function(e){var t=!e.lastLaser&&e.x+r<=jw.gameWidth;l.clearRect(e.x-s-w,e.y,r+s+w,o);e.x-=s-w;if(!jw.game.isRewinding&&(t||Date.now()-e.lastLaser>n)){jw.laser.addBeam({x:e.x,y:e.y+15,speed:-15,target:"player",isRewindable:true});e.lastLaser=Date.now()}l.drawImage(c,e.x,e.y,r,o)});requestAnimationFrame(h)}window.addEventListener("begingame",function(){requestAnimationFrame(h)});jw.events.register("enemyAmnesty",u);jw.events.register("enemyDestroyed",u);jw.events.register("enemyLeftScreen",u);jw.enemy=u})();(function(){"use strict";var e=jw.keyman;var t=5;var n=15;var i=1;var a=10;var r=50;var o=a;var s=r;var d=4;var c=4;var l=48;var w=new Image;var u=new Image;var f;var m=false;var v;var g=document.querySelector("#player").getContext("2d");w.src="body.png";u.src="head.png";var h=R();var y=l*h.length;window.addEventListener("restartgame",function(){o=a;s=r;d=c;h=R();y=l*h.length});function j(){if(--d===0){jw.game.gameOver()}g.clearRect(0,0,jw.gameWidth,jw.gameHeight);h=R();y=l*h.length;jw.events.add("playerHit",{x:o,y:s,health:d})}function p(e,t,i,a){var r=e+i>=o&&e<=o+y&&t>=s-n&&t+a<=s+l+n;return r?this:null}function R(){var e=[];var t;var i;for(var a=1;a<=d;a++){i=Math.round(n*2/d*a);t=a===d?u:w;e.push({sprite:t,yOffset:i,direction:i>0?"up":"down"})}return e}function x(){m=true;g.clearRect(o,s,y,l)}function E(e){if(e.type==="playerHit"){if(d<c){d++;h=R();y=l*h.length}}else if(e.type==="playerMove"){m=true;v=e.data.y}}function k(){m=false;v=null}function S(){for(var e=1;e<=h.length;e++){var i=h[e-1];b(i,e);g.drawImage(i.sprite,o+l*e,s-i.yOffset-t,l,l+t)}if(m&&s!==v){g.clearRect(o+l*e,s-i.yOffset-n,l,l+n*2);s=s>v?s-t:s+t}else if(m&&s===v){m=false;v=null}requestAnimationFrame(S)}function b(e,t){g.clearRect(o+l*t,s-e.yOffset-n,l,l+n*2);if(e.yOffset===n)e.direction="up";else if(e.yOffset===-n)e.direction="down";if(e.direction==="down")e.yOffset+=i;else e.yOffset-=i}window.addEventListener("load",function(){requestAnimationFrame(S)});e.up.onDown=function(){if(jw.game.isRewinding)return;f=setInterval(function(){s-=t},20)};e.down.onDown=function(){if(jw.game.isRewinding)return;f=setInterval(function(){s+=t},20)};e.up.onUp=e.down.onUp=function(){jw.events.add("playerMove",{y:s});clearInterval(f)};e.left.onDown=function(){if(jw.game.canRewind)jw.events.rewind()};e.space.onDown=function(){jw.laser.addBeam({x:y+10,y:s+10,speed:20,target:"enemy"})};jw.player={getByPosition:p,onHit:j,onRewindStart:x,onRewindFrame:E,onPlay:k};jw.events.register("playerHit",jw.player);jw.events.register("playerMove",jw.player)})();
