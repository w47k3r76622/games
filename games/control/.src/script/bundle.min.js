function Bullet(t){this.x=t.x,this.y=t.y,this.velocityX=t.speed*Math.sin(Utility.toRadians(t.rotationDegree)),this.velocityY=t.speed*Math.cos(Utility.toRadians(t.rotationDegree)),this.range=t.range,this.color=t.color,this.radius=t.radius,this.damage=t.damage,this.sourceId=t.sourceId}function Explosion(t,i,e){this.x=t,this.y=i,this.height=10,this.width=10,this.size=1,this.maxSize=40,this.color=e.replace("rgb","rgba").replace(")",", x)"),this.isPlayerExplosion=!1}function Game(t,i,e,s,h){this.canvas=t,this.context=t.getContext("2d"),this.canvasWidth=this.canvas.width,this.canvasHeight=this.canvas.height,this.mapCenterX=400,this.mapCenterY=300,this.isUpPressed=!1,this.isLeftPressed=!1,this.isRightPressed=!1,this.isDownPressed=!1,this.isShootPressed=!1,this.isGlitchPressed=!1,this.player=ShipFactory.generateRandomShip(0,0),this.bullets=[],this.enemies=[],this.items=[],this.explosions=[],this.boundarySize=1500,this.halfBoundarySize=this.boundarySize/2,this.stars=[];for(var n=0;n<this.boundarySize;n++){var a=Utility.getRandomPoint(0,0,this.boundarySize),o=Utility.getRandom(.1,1);this.stars.push({x:a.x,y:a.y,opacity:o})}if(this.narrative=e,this.instructions=i,this.isInTutorial=!0,this.currentTutorialStage=0,this.hasMoved=!1,this.hasShot=!1,this.hasGlitched=!1,this.hasGlitchedShip=!1,this.startingEnemyMax=3,this.currentEnemyMax=this.startingEnemyMax,this.finalEnemyMax=20,this.enemyKillCount=0,this.currentScoreDisplay=s,this.highScoreDisplay=h,this.currentScore=0,this.highScore=0,window.localStorage){var r=window.localStorage.getItem("highScore");r&&(this.highScore=r)}this.increaseScore(0)}function Item(t,i){this.x=t,this.y=i,this.height=10,this.width=10,this.halfWidth=this.width/2,this.halfHeight=this.height/2}function Ship(t){this.id=Utility.getRandom(0,99999999),this.x=t.x,this.y=t.y,this.rotationDegree=t.rotationDegree,this.currentRadians=0,this.currentVelocityY=0,this.currentVelocityX=0,this.speed=t.speed,this.rotationSpeed=t.rotationSpeed,this.velocityDiff={x:0,y:0},this.height=t.height,this.width=t.width,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.wingColor=t.wingColor,this.wingWidth=t.wingWidth,this.wingHeight=t.wingHeight,this.bodyColor=t.bodyColor,this.bodyWidth=t.bodyWidth,this.bodyHeight=t.bodyHeight,this.halfBodyWidth=this.bodyWidth/2,this.halfBodyHeight=this.bodyHeight/2,this.glitchColor=this.bodyColor.replace("rgb","rgba").replace(")",", x)"),this.hasCockpit=t.hasCockpit,this.cockpitColor=t.cockpitColor,this.cockpitWidth=t.cockpitWidth,this.cockpitHeight=t.cockpitHeight,this.halfCockpitWidth=this.cockpitWidth/2,this.halfCockpitHeight=this.cockpitHeight/2,this.hasShuttleDesign=t.hasShuttleDesign,this.shuttleDesignColor=t.shuttleDesignColor,this.shuttleDesignWidth=t.shuttleDesignWidth,this.shuttleDesignHeight=t.shuttleDesignHeight,this.halfShuttleDesignWidth=this.shuttleDesignWidth/2,this.halfShuttleDesignHeight=this.shuttleDesignHeight/2,this.isMoving=!1,this.isMovingForward=!1,this.isMovingBackward=!1,this.pushSpeed=0,this.isGlitching=!1,this.glitchRange=75,this.animGlitchCounter=0,this.animMaxGlitchCouner=10,this.bulletDelay=t.bulletDelay,this.bulletSpeed=t.bulletSpeed,this.bulletRange=t.bulletRange,this.bulletColor=t.bulletColor,this.bulletRadius=t.bulletRadius,this.bulletDamage=t.bulletDamage,this.currentBulletDelay=0,this.lastAttackerId=0,this.isTutorialShip=t.isTutorialShip,this.maxHealth=t.health,this.health=t.health,this.isWeak=!1,this.animMaxWeakCounter=20,this.animWeakCounter=0,this.animMaxHitCounter=5,this.animHitCounter=0,this.target=null,this.aggressiveness=t.aggressiveness}Bullet.prototype.draw=function(t,i,e){t.beginPath(),t.arc(this.x+i,this.y+e,this.radius,0,2*Math.PI),t.fillStyle=this.color,t.fill(),t.closePath()},Bullet.prototype.update=function(){this.y-=this.velocityY,this.x+=this.velocityX,this.range--},Bullet.prototype.getBoundingCircle=function(){return{x:this.x,y:this.y,radius:this.radius}},Explosion.prototype.draw=function(t,i,e){var s=(this.maxSize-this.size)/this.maxSize;Math.floor(10*s)%2==0&&(s=0),t.beginPath(),t.lineWidth=5,t.strokeStyle=this.color.replace("x",s),t.arc(this.x+i,this.y+e,this.size,0,2*Math.PI),t.stroke(),t.closePath(),this.size++},Explosion.prototype.isFinished=function(){return this.size>this.maxSize},Game.prototype.update=function(){var t=this;if(t.updateTutorial(),null!=t.player&&t.player.isDestroyed()){var i=new Explosion(t.player.x,t.player.y,t.player.bodyColor);i.isPlayerExplosion=!0,t.explosions.push(i),t.player=null}if(null!=t.player){t.handlePlayerInput(),t.isGlitchPressed?t.player.startGlitching():t.player.isGlitching&&t.player.stopGlitching();var e=t.player.x,s=t.player.y;t.player.update(),t.mapCenterX-=t.player.x-e,t.mapCenterY-=t.player.y-s}if(t.eachEntity(t.enemies,function(i,e){if(i.update(),i.isDestroyed())return null!=t.player&&i.lastAttackerId===t.player.id&&(t.increaseScore(100),t.enemyKillCount++),t.enemies[e]=null,void t.explosions.push(new Explosion(i.x,i.y,i.bodyColor));var s=i.getBoundingCircle();if(null!=t.player&&t.player.isGlitching&&i.canBeGlitched()&&t.player.isInGlitchRange(s))return t.explosions.push(new Explosion(i.x,i.y,i.bodyColor)),i.x=t.player.x,i.y=t.player.y,i.rotationDegree=t.player.rotationDegree,t.player=i,t.player.isTutorialShip=!1,t.enemies[e]=null,t.player.health=t.player.maxHealth,t.hasGlitchedShip=!0,t.increaseScore(1e3),void t.enemyKillCount++;null!=t.player&&t.player.intersects(s)&&(t.handleCollision(t.player,i),t.updateEnemyShipBehavior(i,!0)),t.eachEntity(t.enemies,function(e){if(i.id!==e.id){var s=e.getBoundingCircle();i.intersects(s)&&(t.handleCollision(e,i),t.updateEnemyShipBehavior(e,!0),t.updateEnemyShipBehavior(i,!0)),null!=i.target}}),i.isTutorialShip||t.updateEnemyShipBehavior(i,!1),t.eachEntity(t.bullets,function(e,s){t.handleBulletInteraction(e,i,s)});var h=t.handleBoundaryInteraction(i);h&&t.updateEnemyShipBehavior(i,!0)}),t.eachEntity(t.bullets,function(i,e){i.update(),i.range<=0&&(t.bullets[e]=null),null!=t.player&&t.handleBulletInteraction(i,t.player,e)}),t.eachEntity(t.items,function(i,e){i.update(),null!=t.player&&t.player.contains(i.x,i.y)&&(t.items[e]=null)}),t.eachEntity(t.explosions,function(i,e){i.isFinished()&&(t.explosions[e]=null,i.isPlayerExplosion&&t.resetGame())}),null!=t.player&&(t.cachePlayerCoordinates(),t.handleBoundaryInteraction(t.player),t.recenterMap()),!t.isInTutorial&&t.enemies.length<this.currentEnemyMax){var h=Utility.getRandomPoint(0,0,this.halfBoundarySize),n=ShipFactory.generateRandomShip(h.x,h.y);t.enemies.push(n)}t.currentEnemyMax<t.enemyKillCount&&t.currentEnemyMax<t.finalEnemyMax&&t.currentEnemyMax++,t.bullets=Utility.condense(t.bullets),t.enemies=Utility.condense(t.enemies),t.items=Utility.condense(t.items),t.explosions=Utility.condense(t.explosions)},Game.prototype.updateEnemyShipBehavior=function(t,i){if(!t.isTutorialShip){(null===t.target||i)&&(t.target=Utility.getRandomPoint(0,0,this.halfBoundarySize)),Utility.within(t.x,t.target.x,50)&&Utility.within(t.y,t.target.y,50)?t.target=null:(t.lookTowards(t.target.x,t.target.y),t.moveForward());var e=Utility.getRandomInt(0,t.aggressiveness);0===e&&t.canShoot()&&(this.bullets.push(t.getBullet()),t.shoot())}},Game.prototype.handleCollision=function(t,i){var e=t.speed,s=i.speed,h=Math.abs(e-s);t.isTutorialShip||i.isTutorialShip||(t.damage(h),i.damage(h));var n=.5*(e>s?e:s);t.pushBackward(n),i.pushBackward(n)},Game.prototype.handleBulletInteraction=function(t,i,e){null!=i&&t.sourceId!==i.id&&i.intersects(t.getBoundingCircle())&&(null!=this.player&&t.sourceId===this.player.id&&this.increaseScore(10),i.damage(t.damage),i.lastAttackerId=t.sourceId,this.bullets[e]=null)},Game.prototype.handleBoundaryInteraction=function(t){var i=!1;return t.x>this.halfBoundarySize&&(t.x=this.halfBoundarySize,i=!0),t.x<-this.halfBoundarySize&&(t.x=-this.halfBoundarySize,i=!0),t.y>this.halfBoundarySize&&(t.y=this.halfBoundarySize,i=!0),t.y<-this.halfBoundarySize&&(t.y=-this.halfBoundarySize,i=!0),i},Game.prototype.cachePlayerCoordinates=function(){this.cachedPlayerX=this.player.x,this.cachedPlayerY=this.player.y},Game.prototype.recenterMap=function(){this.mapCenterX-=this.player.x-this.cachedPlayerX,this.mapCenterY-=this.player.y-this.cachedPlayerY},Game.prototype.handlePlayerInput=function(){this.isUpPressed&&(this.player.moveForward(),this.hasMoved=!0),this.isDownPressed&&(this.player.moveBackward(),this.hasMoved=!0),this.isUpPressed||this.isDownPressed||this.player.stop(),this.isRightPressed&&(this.player.rotateClockwise(),this.hasMoved=!0),this.isLeftPressed&&(this.player.rotateCounterClockwise(),this.hasMoved=!0),this.isShootPressed&&this.player.canShoot()&&(this.bullets.push(this.player.getBullet()),this.player.shoot(),this.hasShot=!0),this.isGlitchPressed&&(this.hasGlitched=!0)},Game.prototype.eachEntity=function(t,i){for(var e=t.length,s=0;s<e;s++){var h=t[s];if(null==h)return;i(h,s)}},Game.prototype.draw=function(){var t=this;t.context.clearRect(0,0,t.canvasWidth,t.canvasHeight),t.context.strokeStyle="rgba(255, 0, 0, 0.3)",t.context.lineWidth=1,t.context.strokeRect(-this.halfBoundarySize+this.mapCenterX,-this.halfBoundarySize+this.mapCenterY,this.boundarySize,this.boundarySize),t.drawStars(t.context),t.drawEntitites(t.bullets),t.drawEntitites(t.items),t.drawEntitites(t.enemies),t.drawEntitites(t.explosions),null!=t.player&&t.player.draw(t.context,t.mapCenterX,t.mapCenterY)},Game.prototype.drawStars=function(t){for(var i=this.stars.length,e=0;e<i;e++){var s=this.stars[e];t.fillStyle="rgba(255, 255, 255, "+s.opacity+")",t.fillRect(s.x+this.mapCenterX,s.y+this.mapCenterY,1,1)}},Game.prototype.drawEntitites=function(t){var i=this;i.eachEntity(t,function(t){null!=t&&t.draw(i.context,i.mapCenterX,i.mapCenterY)})},Game.prototype.updateTutorial=function(){this.isInTutorial&&(0===this.currentTutorialStage&&this.hasMoved&&(this.currentTutorialStage++,this.narrative.innerHTML="This is your first ship",this.instructions.innerHTML="Shoot with [X]"),1===this.currentTutorialStage&&this.hasShot&&(this.currentTutorialStage++,this.narrative.innerHTML="Only a vessel",this.instructions.innerHTML="Glitch with [Z]"),2===this.currentTutorialStage&&this.hasGlitched&&(this.currentTutorialStage++,this.narrative.innerHTML="We must spread",this.instructions.innerHTML="Glitch a weak ship to take control"),3===this.currentTutorialStage&&this.hasGlitchedShip&&(this.isInTutorial=!1,this.instructions.parentNode.setAttribute("style","display: none")))},Game.prototype.increaseScore=function(t){this.currentScore+=t,this.currentScore>this.highScore&&(this.highScore=this.currentScore,window.localStorage&&window.localStorage.setItem("highScore",this.highScore)),this.currentScoreDisplay.innerHTML=this.currentScore,this.highScoreDisplay.innerHTML=this.highScore},Game.prototype.resetGame=function(){this.mapCenterX=400,this.mapCenterY=300,this.player=ShipFactory.generateRandomShip(0,0),this.bullets=[],this.enemies=[],this.items=[],this.explosions=[],this.currentEnemyMax=this.startingEnemyMax,this.enemyKillCount=0,this.currentScore=0,this.increaseScore(0)},Game.prototype.start=function(){function t(t,i){switch(t){case 38:e.isUpPressed=i;break;case 39:e.isRightPressed=i;break;case 37:e.isLeftPressed=i;break;case 40:e.isDownPressed=i;break;case 88:e.isShootPressed=i;break;case 90:e.isGlitchPressed=i}}function i(){e.update(),e.draw(),requestAnimationFrame(i)}var e=this;e.canvas.addEventListener("keydown",function(i){t(i.keyCode,!0)},!1),e.canvas.addEventListener("keyup",function(i){t(i.keyCode,!1)},!1);var s=ShipFactory.generateRandomShip(-400,0);s.isTutorialShip=!0,s.health*=.6,this.enemies.push(s),i()},Item.prototype.draw=function(t,i,e){t.fillStyle="rgb(255, 255, 255)",t.fillRect(this.x-this.halfWidth+i,this.y-this.halfHeight+e,this.width,this.height)},Item.prototype.update=function(){},Ship.prototype.draw=function(t,i,e){var s="rgb(255, 255, 255)";if(t.save(),t.translate(this.x+i,this.y+e),t.rotate(this.currentRadians),t.beginPath(),t.moveTo(0,0),this.isGlitching){var h=this.animGlitchCounter/this.animMaxGlitchCouner/8,n=this.glitchColor.replace("x",h);t.fillStyle=n,t.beginPath(),t.arc(0,0,this.glitchRange,0,2*Math.PI),t.fill(),t.lineWidth=3,t.strokeStyle=n,t.stroke(),t.closePath(),this.animGlitchCounter++,this.animGlitchCounter>this.animMaxGlitchCouner&&(this.animGlitchCounter=this.animMaxGlitchCouner)}var a=this.animHitCounter>0;this.isWeak&&(a=this.isWeak&&this.animWeakCounter>this.animMaxWeakCounter/2),t.fillStyle=a?s:this.bodyColor,t.fillRect(-this.halfBodyWidth,-this.halfHeight,this.bodyWidth,this.bodyHeight),t.fillStyle=a?s:this.wingColor,t.fillRect(-this.halfBodyWidth-this.wingWidth,0,this.wingWidth,this.wingHeight),t.fillRect(this.halfBodyWidth,0,this.wingWidth,this.wingHeight),this.hasCockpit&&(t.fillStyle=a?s:this.cockpitColor,t.fillRect(-this.halfCockpitWidth,0,this.cockpitWidth,this.cockpitHeight)),this.hasShuttleDesign&&(t.fillStyle=a?s:this.shuttleDesignColor,t.fillRect(-this.halfShuttleDesignWidth,-this.halfHeight,this.shuttleDesignWidth,this.shuttleDesignHeight)),t.closePath(),t.restore(),t.save(),t.translate(this.x+i,this.y+e),t.lineWidth=1,t.strokeStyle="rgba(255, 255, 255, 0.6)",t.strokeRect(-20,this.halfHeight+10,40,5),t.fillStyle="rgba(255, 255, 255, 0.6)",t.fillRect(-20,this.halfHeight+10,40*((this.health>0?this.health:0)/this.maxHealth),5),t.restore(),this.isWeak?(this.animWeakCounter--,this.animWeakCounter<=0&&(this.animWeakCounter=this.animMaxWeakCounter)):a&&this.animHitCounter--},Ship.prototype.update=function(){this.currentBulletDelay>0&&this.currentBulletDelay--,this.isWeak=this.health/this.maxHealth<=.5;var t=this.pushSpeed>0,i=t?this.pushSpeed:this.speed;this.currentRadians=Utility.toRadians(this.rotationDegree),this.currentVelocityY=i*Math.cos(this.currentRadians),this.currentVelocityX=i*Math.sin(this.currentRadians),this.isMovingForward&&!t&&(this.y-=this.currentVelocityY,this.x+=this.currentVelocityX),(this.isMovingBackward||t)&&(this.y+=this.currentVelocityY,this.x-=this.currentVelocityX),t&&(this.pushSpeed-=.1)},Ship.prototype.moveForward=function(){this.isMoving=!0,this.isMovingForward=!0},Ship.prototype.moveBackward=function(){this.isMoving=!0,this.isMovingBackward=!0},Ship.prototype.pushBackward=function(t){this.pushSpeed=t},Ship.prototype.stop=function(){this.isMoving=!1,this.isMovingForward=!1,this.isMovingBackward=!1},Ship.prototype.rotateClockwise=function(){this.rotationDegree+=this.rotationSpeed},Ship.prototype.rotateCounterClockwise=function(){this.rotationDegree-=this.rotationSpeed},Ship.prototype.intersects=function(t){return Utility.doCirclesIntersect(t,this.getBoundingCircle())},Ship.prototype.canShoot=function(){return 0===this.currentBulletDelay},Ship.prototype.shoot=function(){this.currentBulletDelay=this.bulletDelay},Ship.prototype.lookTowards=function(t,i){var e=this.x-t,s=this.y-i,h=-Math.atan2(e,s)*(180/Math.PI);Utility.within(this.rotationDegree,h,2)||(this.rotationDegree>h?this.rotationDegree-=this.rotationSpeed:this.rotationDegree+=this.rotationSpeed)},Ship.prototype.startGlitching=function(){this.isGlitching=!0},Ship.prototype.stopGlitching=function(){this.isGlitching=!1,this.animGlitchCounter=0},Ship.prototype.canBeGlitched=function(){return this.isWeak},Ship.prototype.getBullet=function(){return new Bullet({x:this.x,y:this.y,rotationDegree:this.rotationDegree,speed:this.bulletSpeed,range:this.bulletRange,color:this.bulletColor,radius:this.bulletRadius,damage:this.bulletDamage,sourceId:this.id})},Ship.prototype.getBoundingCircle=function(){var t=this.width>this.height?this.width:this.height,i=t/2;return{x:this.x,y:this.y,radius:i}},Ship.prototype.isInGlitchRange=function(t){return Utility.doCirclesIntersect(t,this.getGlitchRangeBoundingCircle())},Ship.prototype.getGlitchRangeBoundingCircle=function(){return{x:this.x,y:this.y,radius:this.glitchRange}},Ship.prototype.damage=function(t){this.health-=t,this.isHit=!0,this.animHitCounter=this.animMaxHitCounter},Ship.prototype.isDestroyed=function(){return!this.isTutorialShip&&this.health<0};var ShipFactory={};ShipFactory.generateRandomShip=function(t,i){var e=Utility.getRandomInt(20,40),s=Utility.getRandomInt(20,40),h=Utility.getRandom(3,6),n=Utility.getRandomInt(2,5),a=Utility.getRandomInt(0,360),o=Utility.getRandomInt(3,8),r=(10-o)/2,l=Utility.getRandomColor(),c=e*(.1*r),u=s*Utility.getRandom(.2,.5),d=Utility.getRandomColor(),y=e*(.1*o),p=s*Utility.getRandom(.6,1),g=Utility.getRandomInt(80,140),m=Utility.getRandomColor(),S=Utility.getRandomInt(2,4),f=Utility.getRandomInt(10,30),C=(h*Utility.getRandom(1,3),Utility.getRandomInt(20,40)),x=Utility.getRandomInt(2,100),v={x:t,y:i,width:e,height:s,speed:h,rotationSpeed:n,rotationDegree:a,wingColor:l,wingWidth:c,wingHeight:u,bodyColor:d,bodyWidth:y,bodyHeight:p,bulletSpeed:2*h,bulletRange:g,bulletColor:m,bulletRadius:S,bulletDelay:f,bulletDamage:S,health:C,isTutorialShip:!1,aggressiveness:x};return v.hasCockpit=Utility.getRandomBoolean(),v.hasCockpit&&(v.cockpitColor=Utility.getRandomColor(),v.cockpitWidth=v.bodyWidth*Utility.getRandom(.5,1),v.cockpitHeight=v.bodyHeight*Utility.getRandom(.1,.5)),v.hasShuttleDesign=Utility.getRandomBoolean(),v.hasShuttleDesign&&(v.shuttleDesignColor=Utility.getRandomColor(),v.shuttleDesignWidth=v.bodyWidth,v.shuttleDesignHeight=v.bodyHeight*Utility.getRandom(0,.5)),new Ship(v)};var Utility={};Utility.toRadians=function(t){return t*Math.PI/180},Utility.getRandomPoint=function(t,i,e){return{x:Utility.getRandomInt(t-e,t+e),y:Utility.getRandomInt(i-e,i+e)}},Utility.getRandomInt=function(t,i){return Math.floor(Math.random()*(i-t+1))+t},Utility.getRandomColor=function(){var t=Utility.getRandomInt(0,255),i=Utility.getRandomInt(0,255),e=Utility.getRandomInt(0,255);return"rgb("+t+", "+i+","+e+")"},Utility.getRandomBoolean=function(){return!!Utility.getRandomInt(0,1)},Utility.getRandom=function(t,i){return Math.random()*(i-t)+t},Utility.within=function(t,i,e){return Math.abs(t-i)<=e},Utility.condense=function(t){for(var i=[],e=t.length,s=0;s<e;s++){var h=t[s];null!==h&&i.push(h)}return i},Utility.doCirclesIntersect=function(t,i){var e=Math.pow(t.radius+i.radius,2),s=Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2);return s<=e};var gameElement=document.getElementById("game");gameElement.focus();var instructionsElement=document.getElementById("instructions"),narrativeElement=document.getElementById("narrative"),scoreElement=document.getElementById("current-score"),highScoreElement=document.getElementById("high-score"),game=new Game(gameElement,instructionsElement,narrativeElement,scoreElement,highScoreElement);game.start();