var st=Object.defineProperty;var it=(n,t,e)=>t in n?st(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(it(n,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const{abs:$}=Math;class w extends Float32Array{constructor(t=0,e=0,s=0){super(3),this[0]=t,this[1]=e,this[2]=s}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}clone(){return new w(this[0],this[1],this[2])}manhattanDistXY(t){return $(t.x-this.x)+$(t.y-this.y)}angleXY(t){return Math.atan2(t.y-this.y,t.x-this.x)}cross(t,e){e[0]=this[1]*t[2]-this[2]*t[1],e[1]=this[2]*t[0]-this[0]*t[2],e[2]=this[0]*t[1]-this[1]*t[0]}magnitude(){return Math.sqrt(this[0]**2+this[1]**2+this[2]**2)}rotateZ(t,e){const[s,i,o]=this,r=Math.cos(t),h=Math.sin(t);e[0]=s*r-i*h,e[1]=s*h+i*r,e[2]=o}rotateY(t,e){const[s,i,o]=this,r=Math.cos(t),h=Math.sin(t);e[0]=s*r+o*h,e[1]=i,e[2]=-s*h+o*r}rotateX(t,e){const[s,i,o]=this,r=Math.cos(t),h=Math.sin(t);e[0]=s,e[1]=i*r-o*h,e[2]=i*h+o*r}subtract(t,e){e[0]=this[0]-t[0],e[1]=this[1]-t[1],e[2]=this[2]-t[2]}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}}class at{constructor(){a(this,"angle",-2.2983780000001044);a(this,"distance",800);a(this,"horizon",-99.99200000000593);a(this,"position",new w(276.84564208984375,303.5342102050781,700.9903564453125))}update(t,e,s){e.keypressed=!1,e.leftright!==0&&(this.angle+=e.leftright*.1*t*.03,e.keypressed=!0),e.forwardbackward!==0&&(this.position.x-=e.forwardbackward*Math.sin(this.angle)*t*.03,this.position.y-=e.forwardbackward*Math.cos(this.angle)*t*.03,e.keypressed=!0),e.updown!==0&&(this.position.z+=e.updown*t*.03,e.keypressed=!0),e.lookup&&(this.horizon+=40*t*.03,e.keypressed=!0),e.lookdown&&(this.horizon-=40*t*.03,e.keypressed=!0);let i=((Math.floor(this.position.y)&s.width-1)<<s.shift)+(Math.floor(this.position.x)&s.height-1)|0;s.altitude[i]+10>this.position.z&&(this.position.z=s.altitude[i]+10)}}const nt=(n,t,e,s,i,o)=>{const r=e-i/2|0,h=s-i/2|0,c=5;n.fillStyle="#666667",t.fillStyle="rgb(5, 0 ,0)",n.fillRect(r-c*3,h-c*3,i+c*8,i+c*8),t.fillRect(r-c*3,h-c*3,i+c*8,i+c*8),n.fillStyle="#888",t.fillStyle=`rgb(${o}, 0 ,0)`,n.fillRect(r,h,c,i),t.fillRect(r,h,c,i),n.fillRect(r,h,i,c),t.fillRect(r,h,i,c),n.fillRect(r,h+i,i,c),t.fillRect(r,h+i,i,c),n.fillRect(r+i,h,c,i+c),t.fillRect(r+i,h,c,i+c);const d=c*3;n.fillStyle="#999",t.fillStyle=`rgb(${o+30}, 0 ,0)`,n.fillRect(r-c,h-c,d,d),t.fillRect(r-c,h-c,d,d),n.fillRect(r+i,h+i,d,d),t.fillRect(r+i,h+i,d,d),n.fillRect(r-c,h+i,d,d),t.fillRect(r-c,h+i,d,d),n.fillRect(r+i,h-c,d,d),t.fillRect(r+i,h-c,d,d),t.fillStyle=`rgb(${o+40}, 0 ,0)`,n.fillRect(e-c*4,s-c*4,i-c*6,i-c*6),t.fillRect(e-c*4,s-c*4,i-c*6,i-c*6)},ot=()=>{const n=Math.random()*2*Math.PI;return{x:Math.cos(n),y:Math.sin(n)}},rt=n=>6*n**5-15*n**4+10*n**3,O=(n,t,e)=>t+rt(n)*(e-t),T=(n,t)=>`${n},${t}`;class ht{constructor(){a(this,"gradients",{});a(this,"memory",{})}dot_prod_grid(t,e,s,i){let o;const r={x:t-s,y:e-i};return this.gradients[T(s,i)]?o=this.gradients[T(s,i)]:(o=ot(),this.gradients[T(s,i)]=o),r.x*o.x+r.y*o.y}get(t,e){let s=0;const i=Math.floor(t),o=Math.floor(e);if(this.memory.hasOwnProperty(T(t,e)))s=this.memory[T(t,e)];else{const r=this.dot_prod_grid(t,e,i,o),h=this.dot_prod_grid(t,e,i+1,o),c=this.dot_prod_grid(t,e,i,o+1),d=this.dot_prod_grid(t,e,i+1,o+1),u=O(t-i,r,h),y=O(t-i,c,d),m=O(e-o,u,y);this.memory[T(t,e)]=m,s=m}return s}save(t="default"){localStorage.setItem(`perlin-memory-${t}`,JSON.stringify(this.memory)),localStorage.setItem(`perlin-gradients-${t}`,JSON.stringify(this.gradients))}load(t="default"){const e=JSON.parse(localStorage.getItem(`perlin-memory-${t}`));e&&(this.memory=e);const s=JSON.parse(localStorage.getItem(`perlin-gradients-${t}`));s&&(this.gradients=s)}}const ct=n=>Math.min(n*255,255)|0,lt=(n,t,e,s)=>{n.fillStyle="rgb(255, 255, 150)",n.fillRect(0,0,e,s),t.fillStyle="#00ff00",t.fillRect(0,0,e,s);const i=Math.floor(e/10),o=Math.floor(s/10),r=new ht;for(let h=0;h<o;h++){let c=h/o*3;const d=new Array(i);for(let u=0;u<i;u++){let y=u/i*3;const m=r.get(y+1,c+1),S=ct(m)|0;if(d[u]=S,t.fillStyle=`rgb(${S}, 0, 0)`,t.fillRect(u*10,h*10,10,10),S<=2)n.fillStyle="rgb(100, 150, 255)";else{const E=Math.min(255-Math.abs(m*255),255)|0;n.fillStyle=`rgb(${E}, 200, 100)`}n.fillRect(u*10|0,h*10|0,10,10)}}},{max:dt}=Math;class ut{constructor(){a(this,"width",1024);a(this,"height",1024);a(this,"shift",10);a(this,"altitude",new Uint8Array(1024*1024));a(this,"color",new Uint32Array(1024*1024));a(this,"units",new Uint8Array(1024*1024));a(this,"unitsColor",new Uint32Array(1024*1024))}damage(t,e,s){for(let i=0;i<e;i++){const o=s+i*this.width,r=dt(this.altitude[o]-t,5)|0;r===5&&(this.color[o]+=1),this.altitude[o]=r}}toIndex(t,e){return t+e*this.width|0}createMap(){let t=document.createElement("canvas");t.width=this.width,t.height=this.height;const e=t.getContext("2d");if(e===null)throw new Error("colorContext not initialized");t=document.createElement("canvas"),t.width=this.width,t.height=this.height;const s=t.getContext("2d");if(s===null)throw new Error("heightContext not initialized");return lt(e,s,this.width,this.height),nt(e,s,this.width/2|0,this.height/2|0,80,100),[e.getImageData(0,0,this.width,this.height).data,s.getImageData(0,0,this.width,this.height).data]}load(){const[t,e]=this.createMap();for(var s=0;s<this.width*this.height;s++)this.color[s]=4278190080|t[(s<<2)+2]<<16|t[(s<<2)+1]<<8|t[(s<<2)+0],this.altitude[s]=e[s<<2];this.clearUnits()}clearUnits(){this.units.fill(0)}isUnit(t){const{x:e,y:s}=t.position,{color:i,height:o,width:r}=t,h=e+s*this.width|0;return this.unitsColor[h]===i}setUnit(t){const{x:e,y:s}=t.position,{color:i,height:o,width:r}=t;for(let h=0;h<r;h++){let c=s+h|0;if(c>=this.height)break;for(let d=0;d<r;d++){let u=e+d|0;if(u>=this.width)break;const y=u+c*this.width|0;this.units[y]=o|0,this.unitsColor[y]=i}}}getUnitsColorAt(t){return this.unitsColor[t]}getGroundColorAt(t){return this.color[t]}}const X=4278190335,pt=4294967040,wt=4278255615,C=4278190080,ft=4289498831,mt=n=>{const t=n&255,e=n>>8&255,s=n>>16&255;return t!==0&&t===e&&e===s},H=()=>!1,g=n=>{const t=document.getElementById(n);if(t===null)throw new Error(`No #${n} element found`);return t};let gt=0;const N=()=>++gt,{cos:yt,sin:St}=Math;var p=(n=>(n[n.PEASANT=1]="PEASANT",n[n.ROYALTY=2]="ROYALTY",n))(p||{});const bt=N();class M{constructor(t,e,s,i){a(this,"position");a(this,"height");a(this,"width",10);a(this,"color");a(this,"maxSpeed",0);a(this,"reloadTime",1e3);a(this,"shotTime",0);a(this,"health",100);a(this,"healthMax",100);a(this,"power",5);a(this,"angle",0);a(this,"range",10);a(this,"isRemovable",!1);a(this,"team",1);a(this,"target");a(this,"attackTargetColorFn");this.position=new w(t,e,0),this.height=s,this.color=i}update(t,e){}attack({ground:t},e){}move(t){this.position.x=this.position.x+this.maxSpeed*yt(this.angle)*t,this.position.y=this.position.y+this.maxSpeed*St(this.angle)*t,this.position.x>=1024?this.position.x=0:this.position.x<0&&(this.position.x=1023),this.position.y>=1024?this.position.y=0:this.position.y<0&&(this.position.y=1023)}damage(t){this.health-=t.power,this.health<=0&&(this.isRemovable=!0)}}a(M,"TYPE",bt);const xt=N(),{cos:kt,sin:vt}=Math;class j extends M{update(t,e){let s;this.shotTime+=t,this.team===p.PEASANT?s=e.getOneInRange(this,p.ROYALTY):s=e.getOneInRange(this,p.PEASANT),s?this.target=s:this.target||(this.target=e.royalty),this.target&&!this.target.isRemovable&&(this.angle=this.position.angleXY(this.target.position));const{ground:i}=e,o=this.position.x+this.maxSpeed*kt(this.angle)*t,r=this.position.y+this.maxSpeed*vt(this.angle)*t;let h=i.toIndex(o,r);this.attackTargetColorFn(i.getGroundColorAt(h))?this.attack(e,h):(h=i.toIndex(o+this.width,r),this.attackTargetColorFn(i.getGroundColorAt(h))?this.attack(e,h):(h=i.toIndex(o,r+this.width),this.attackTargetColorFn(i.getGroundColorAt(h))?this.attack(e,h):(h=i.toIndex(o+this.width,r+this.width),this.attackTargetColorFn(i.getGroundColorAt(h))?this.attack(e,h):(this.position.x=o,this.position.y=r,this.position.x>=1024?this.position.x=0:this.position.x<0&&(this.position.x=1023),this.position.y>=1024?this.position.y=0:this.position.y<0&&(this.position.y=1023)))))}attack(t,e){let s=p.PEASANT;if(this.team===p.PEASANT&&(t.ground.damage(this.power,this.width,e),s=p.ROYALTY),this.shotTime>this.reloadTime){const i=t.getOneInRange(this,s);i&&(this.shotTime=0,i.damage(this))}}}a(j,"TYPE",xt);const Tt=(n,t)=>{const e=new j(n,t,40,4294901760);return e.width=10,e.maxSpeed=.05,e.reloadTime=1/0,e.health=10,e.attackTargetColorFn=mt,e},Y=(n,t)=>{n.type.startsWith("touch")?(t.x=n.targetTouches[0].pageX,t.y=n.targetTouches[0].pageY):(t.x=n.pageX,t.y=n.pageY)};class It{constructor(t){a(this,"forwardbackward",0);a(this,"leftright",0);a(this,"updown",0);a(this,"lookup",!1);a(this,"lookdown",!1);a(this,"startPosition",new w);a(this,"position",new w);a(this,"mouseDown",!1);a(this,"keypressed",!1);a(this,"camera");a(this,"isDisabled",!0);a(this,"onMouseDown",t=>{if(!this.isDisabled)return this.forwardbackward=3,this.mouseDown=!0,Y(t,this.startPosition),Y(t,this.position),!1});a(this,"onMouseUp",()=>{if(!this.isDisabled)return this.mouseDown=!1,this.forwardbackward=0,this.leftright=0,this.updown=0,!1});a(this,"onMouseMove",t=>{if(this.isDisabled||(t.preventDefault(),Y(t,this.position),!this.mouseDown||this.forwardbackward==0))return;const{x:e,y:s}=this.position;return this.leftright=(this.startPosition[0]-e)/window.innerWidth*2,this.camera.horizon=100+(this.startPosition[1]-s)/window.innerHeight*500,this.updown=(this.startPosition[1]-s)/window.innerHeight*10,!1});a(this,"onKeysDown",t=>{if(!this.isDisabled){switch(t.keyCode){case 37:case 65:this.leftright=1;break;case 39:case 68:this.leftright=-1;break;case 38:case 87:this.forwardbackward=3;break;case 40:case 83:this.forwardbackward=-3;break;case 82:this.updown=2;break;case 70:this.updown=-2;break;case 69:this.lookup=!0;break;case 81:this.lookdown=!0;break;default:return}return!1}});a(this,"onKeysUp",t=>{if(!this.isDisabled){switch(t.keyCode){case 37:case 65:this.leftright=0;break;case 39:case 68:this.leftright=0;break;case 38:case 87:this.forwardbackward=0;break;case 40:case 83:this.forwardbackward=0;break;case 82:this.updown=0;break;case 70:this.updown=0;break;case 69:this.lookup=!1;break;case 81:this.lookdown=!1;break;default:return}return!1}});this.camera=t}start(){this.mouseDown=!1,this.forwardbackward=0,this.leftright=0,this.updown=0,this.isDisabled=!1}stop(){this.mouseDown=!1,this.forwardbackward=0,this.leftright=0,this.updown=0,this.isDisabled=!0}}const{floor:F}=Math;class Rt{constructor(t,e,s,i){a(this,"canvas");a(this,"context");a(this,"imagedata");a(this,"bufarray");a(this,"buf8");a(this,"buf32");a(this,"hiddenYs");a(this,"bgColor",4292907152);a(this,"camera");a(this,"ground");a(this,"input");a(this,"resize",()=>{let t=window.innerWidth/window.innerHeight;this.canvas.width=window.innerWidth<800?window.innerWidth:800,this.canvas.height=this.canvas.width/t,this.imagedata=this.context.createImageData(this.canvas.width,this.canvas.height),this.bufarray=new ArrayBuffer(this.imagedata.width*this.imagedata.height*4),this.buf8=new Uint8Array(this.bufarray),this.buf32=new Uint32Array(this.bufarray),this.hiddenYs=new Int32Array(this.canvas.width)});this.canvas=t;const o=t.getContext("2d");if(o===null)throw new Error("Could not load context 2d");this.context=o,this.camera=e,this.ground=s,this.input=i,this.resize()}drawVerticalLine(t,e,s,i,o){t=t|0,e=e|0,s=s|0,i=i|0;const r=this.buf32;if(e<0&&(e=0),e>s)return;let h=e*o+t|0;for(let c=e;c<s;c++)r[h|0]=i|0,h+=o|0}drawBackground(){this.buf32.fill(this.bgColor|0)}flip(){this.imagedata.data.set(this.buf8),this.context.putImageData(this.imagedata,0,0)}render(){const{hiddenYs:t,camera:e,ground:s,canvas:i,input:o}=this,{units:r,unitsColor:h}=s,c=s.width-1,d=s.height-1,u=i.width|0,y=i.height|0,m=Math.sin(e.angle),S=Math.cos(e.angle);t.fill(i.height);let E=1;for(let f=1;f<e.distance;f+=E){let x=-S*f-m*f,k=m*f-S*f;const q=S*f-m*f,Z=-m*f-S*f,Q=q-x,tt=Z-k,W=Q/u,U=tt/y;x+=e.position.x,k+=e.position.y;const _=1/f*240;for(let b=0;b<u;b++){if(k<0||k>=1024||x<0||x>=1024){x+=W,k+=U;continue}const v=((F(k)&c)<<s.shift)+(F(x)&d)|0;let I=(e.position.z-s.altitude[v])*_+e.horizon|0,et=s.color[v];this.drawVerticalLine(b,I|0,t[b],et,u),r[v]>0&&(I=(e.position.z-s.altitude[v]-r[v])*_+e.horizon|0,this.drawVerticalLine(b,I|0,t[b],h[v],u)),I<t[b]&&(t[b]=I),x+=W,k+=U}E+=.005}}}const A=(n,t)=>Math.floor(Math.random()*(t-n))+n,At=n=>Math.floor(Math.random()*n);class Mt extends M{}const Pt=(n,t)=>{const e=new Mt(n,t,50,wt);return e.team=p.ROYALTY,e.maxSpeed=.01,e},Et=N();class V extends M{update(t,e){if(this.move(t),this.height<=0?this.isRemovable=!0:this.height--,this.shotTime+=t,this.shotTime>this.reloadTime){const s=e.getOneInRange(this,p.PEASANT);s&&(this.shotTime=0,s.damage(this),s.health<=0&&(s.health=s.healthMax,s.team=p.ROYALTY,s.color=X,s.isRemovable=!1,s.target=e.getOneInRange(this,p.PEASANT)))}}}a(V,"TYPE",Et);const G=(n,t,e,s,i)=>{const o=new V(n,t,e.height,e.color);return o.team=i,o.angle=e.angle,o.maxSpeed=s,o.power=e.power,o.range=100,o.attackTargetColorFn=H,o},zt=N();class B extends M{constructor(){super(...arguments);a(this,"projectiles",1)}update(e,s){if(this.shotTime+=e,this.shotTime>this.reloadTime){const i=s.getOneInRange(this,p.PEASANT);if(i)if(this.angle=this.position.angleXY(i.position),this.shotTime=0,this.projectiles===1)s.actors.push(G(this.position.x,this.position.y,this,.05,p.ROYALTY));else for(let o=0;o<this.projectiles;o++)s.actors.push(G(this.position.x+A(-20,20),this.position.y+A(-20,20),this,.05,p.ROYALTY))}}}a(B,"TYPE",zt);const Nt=(n,t,e,s,i)=>{const o=new B(n,t,60,e);return o.team=p.ROYALTY,o.power=s,o.maxSpeed=0,o.range=100,o.projectiles=i,o.attackTargetColorFn=H,o},z=[];class Ot{constructor(t,e,s){a(this,"activeWeapon",0);a(this,"selectorEl");a(this,"containerEl");a(this,"buildButton");a(this,"game");a(this,"buildTower",t=>{t.stopPropagation(),t.preventDefault();const[e,s,i,o,r]=z[this.activeWeapon];return this.game.actors.push(Nt(A(400,600),A(400,600),s,i,o)),!1});a(this,"selectWeapon",t=>{this.activeWeapon=t.target.selectedIndex});this.selectorEl=e,this.containerEl=t,this.buildButton=g("build-button"),this.game=s,this.buildButton.addEventListener("click",this.buildTower,{capture:!0},!0)}setTowers(){this.selectorEl.innerHTML="",z.map(([t,e],s)=>{const i=document.createElement("option");return i.value=`${s+1}`,i.innerHTML=t,i}).forEach(t=>this.selectorEl.appendChild(t))}getActiveWeapon(){return z[this.activeWeapon]}show(){this.containerEl.className=""}hide(){this.containerEl.className="hidden"}}const Yt=n=>{const t=g("war-room"),e=g("towers"),s=new Ot(t,e,n);return s.setTowers(),e.addEventListener("change",s.selectWeapon),s};class R{constructor(t,e,s){a(this,"attacks");a(this,"phrase");a(this,"newWeapon");this.attacks=t,this.phrase=e,this.newWeapon=s}}class Dt{constructor(){a(this,"royaltyView");a(this,"flyPath");a(this,"fightPos");a(this,"waves");a(this,"waveIndex",0)}reset(){this.waveIndex=0}}const l=new Dt;l.royaltyView={angle:-4.339305820702128,distance:800,horizon:-65.0189757964443,position:new w(588.982421875,469.964111328125,273.84217834472656)};l.waves=[new R([[3,1500],[5,1e4],[4,1e4],[1,1e4]],"The peasants have gotten tired of eating dirt! I need to invent new weapon...",["Empty promises",pt,1,1,20]),new R([[10,1500],[5,1e4],[4,1e4],[1,1e4]],"I convinced some peasants to stay in dirt and wear red but others keep coming. Luckily I invented a new weapon...",["Patriarchy",ft,5,2,20]),new R([[4,1500],[10,15e3],[20,15e3],[1,1e4]],"If the peasants have no bread, let them eat cake! Haha... I need a new weapon...",["Religion",C,10,3,20]),new R([[5,1500],[20,2e4],[20,1e4],[1,1e4]],"The peasants will fall to their knees when I release...",["Prejudice",X,20,4,20]),new R([[10,1500],[10,2e4],[30,15e3],[1,1e4]],"I will fall don't they see that I have god given right! Lets try... ",["Patriotism",C,30,5,20])];l.fightPos={angle:-4.150429608133125,distance:800,horizon:-201.90282802547313,position:new w(634.6865234375,321.7402648925781,598.1404418945312)};l.flyPath=[{angle:-2.9437311127542665,distance:800,horizon:215.74858161965486,position:new w(415.08856201171875,199.0737762451172,240.19976806640625)},{angle:-3.119694499075897,distance:800,horizon:329.01558762511377,position:new w(511.4964599609375,420.7003479003906,177.53883361816406)},{angle:-4.4944084547135885,distance:800,horizon:317.26144567789015,position:new w(569.4714965820312,509.56884765625,128.94207763671875)},{angle:-6.1943404547136085,distance:800,horizon:179.99679999999645,position:new w(492.73663330078125,641.3016357421875,140)},{angle:-8.147667041005946,distance:800,horizon:37.21565059144677,position:new w(331.5606689453125,425.4092712402344,264.7362060546875)}];const K="game-over",D="intro",J="play",L="royalty-speaks",Lt="win";class Wt{constructor(){a(this,"states",[new Ut,new _t,new $t,new Ct,new Ft]);a(this,"activeState");this.activeState=this.states[0]}update(t,e){if(this.activeState.update(t,e),this.activeState.isDone(e)){console.log("Prev state: ",this.activeState.name),this.activeState.end(e);const s=this.activeState.getNextStateName(e);this.activeState=this.states.find(i=>i.name===s),this.activeState.start(e),console.log("New state: ",this.activeState.name)}}}class P{constructor(t){a(this,"name");this.name=t}start(t){}end(t){}}class Ut extends P{constructor(){super(D);a(this,"cameraState",{...l.flyPath[0]});a(this,"nextCameraState",{...l.flyPath[1]});a(this,"cameraStateIndex",0);a(this,"currentTime",0);a(this,"duration",2e3);a(this,"isInteracted",!1)}getNextStateName(e){return L}isDone(e){return e.input.keypressed||e.input.mouseDown}reset(){this.currentTime=0,this.cameraStateIndex=0,this.cameraState=l.flyPath[this.cameraStateIndex],this.nextCameraState=l.flyPath[this.cameraStateIndex+1]}update(e,s){this.currentTime+=e,this.currentTime>this.duration&&(this.currentTime=0,this.cameraStateIndex++,this.cameraStateIndex>=l.flyPath.length?(this.cameraStateIndex=0,this.cameraState=l.flyPath[this.cameraStateIndex],this.nextCameraState=l.flyPath[this.cameraStateIndex+1]):(this.cameraState=this.nextCameraState,this.nextCameraState=l.flyPath[this.cameraStateIndex]));const i=this.currentTime/this.duration;s.camera.angle=this.cameraState.angle+(this.nextCameraState.angle-this.cameraState.angle)*i,s.camera.distance=this.cameraState.distance+(this.nextCameraState.distance-this.cameraState.distance)*i,s.camera.horizon=this.cameraState.horizon+(this.nextCameraState.horizon-this.cameraState.horizon)*i,s.camera.position.x=this.cameraState.position.x+(this.nextCameraState.position.x-this.cameraState.position.x)*i,s.camera.position.y=this.cameraState.position.y+(this.nextCameraState.position.y-this.cameraState.position.y)*i,s.camera.position.z=this.cameraState.position.z+(this.nextCameraState.position.z-this.cameraState.position.z)*i}start(e){e.reset(),e.input.start()}end(e){g("banner-start").style.display="none",e.input.stop()}}class _t extends P{constructor(){super(L);a(this,"minDuration",500);a(this,"time",0);a(this,"isWeaponShown",!1);a(this,"banner");this.banner=g("banner-roalty-speaks")}getNextStateName(e){return J}isDone(e){return this.time>this.minDuration&&this.isWeaponShown&&(e.input.keypressed||e.input.mouseDown)?(z.push(l.waves[l.waveIndex].newWeapon),!0):!1}reset(){this.time=0,this.isWeaponShown=!1}update(e,s){this.time+=e,this.time>this.minDuration&&!this.isWeaponShown&&(s.input.keypressed||s.input.mouseDown)&&(this.isWeaponShown=!0,this.time=0,g("speak").innerText=`"The new weapon is '${l.waves[l.waveIndex].newWeapon[0]}'!"`)}start(e){const{royaltyView:s}=l;e.camera.angle=s.angle,e.camera.distance=s.distance,e.camera.horizon=s.horizon,e.camera.position.x=s.position.x,e.camera.position.y=s.position.y,e.camera.position.z=s.position.z,this.banner.className="",g("speak").innerText=`"${l.waves[l.waveIndex].phrase}"`,e.warRoom.setTowers(),e.input.stop(),setTimeout(()=>e.input.start(),500)}end(e){this.banner.className="hidden",this.reset(),e.input.stop(),e.warRoom.setTowers()}}class $t extends P{constructor(){super(J);a(this,"time",0);a(this,"attackIndex",0);a(this,"attack",l.waves[l.waveIndex].attacks[0]);a(this,"fightOver",!1);a(this,"win",!1)}getNextStateName(e){return this.win||e.royalty.isRemovable?K:L}isDone(e){return this.fightOver||e.royalty.isRemovable}reset(){this.fightOver=!1,this.attackIndex=0,this.attack=l.waves[l.waveIndex].attacks[0],this.win=!1}update(e,s){this.time+=e,this.time>this.attack[1]&&(this.time=0,s.spawnWave(this.attack[0]),this.attackIndex++,this.attackIndex>=l.waves[l.waveIndex].attacks.length&&(this.attackIndex=0,this.fightOver=!0,l.waveIndex++,l.waveIndex>=l.waves.length&&(l.waveIndex=0,this.win=!0)),this.attack=l.waves[l.waveIndex].attacks[this.attackIndex])}start(e){const{fightPos:s}=l;e.camera.angle=s.angle,e.camera.distance=s.distance,e.camera.horizon=s.horizon,e.camera.position.x=s.position.x,e.camera.position.y=s.position.y,e.camera.position.z=s.position.z,e.warRoom.show()}end(e){e.warRoom.hide(),this.reset(),e.input.stop()}}class Ct extends P{constructor(){super(K);a(this,"time",0)}getNextStateName(e){return D}isDone(e){return this.time<5e3}reset(){}update(e,s){this.time+=e}start(e){g("banner-end").className=""}end(){g("banner-end").className="hidden"}}class Ft extends P{constructor(){super(Lt)}getNextStateName(t){return D}isDone(t){return!1}reset(){}update(t,e){}}class Gt{constructor(t){a(this,"isRunning",!1);a(this,"input");a(this,"camera");a(this,"ground");a(this,"view");a(this,"actors");a(this,"royalty");a(this,"warRoom");a(this,"stateManager");this.camera=new at,this.input=new It(this.camera),this.ground=new ut,this.ground.load(),this.view=new Rt(t,this.camera,this.ground,this.input),this.stateManager=new Wt;const e=this.ground.width/2|0,s=this.ground.height/2|0;this.royalty=Pt(e,s),this.actors=[this.royalty],this.warRoom=Yt(this),this.warRoom.hide(),this.input.start()}spawnWave(t){const e=this.ground.height/2;for(let s=0;s<t;s++){const i=Tt(100+At(50)|0,A(e-50,e+50)|0);i.target=this.royalty,this.actors.push(i)}}getOneInRange({position:t,range:e},s){for(let i=0;i<this.actors.length;i++){const o=this.actors[i];if(!o.isRemovable&&o.team===s&&o.position.manhattanDistXY(t)<e)return o}}update(t){this.stateManager.update(t,this),this.camera.update(t,this.input,this.ground),this.ground.clearUnits(),this.actors.forEach(e=>(e.update(t,this),this.ground.setUnit(e),!e.isRemovable))}draw(t){this.view.drawBackground(),this.view.render(),this.view.flip()}reset(){this.actors=[this.royalty]}}const Xt=()=>{const n=g("app"),t=new Gt(n);for(var e=0;e<t.ground.width*t.ground.height;e++)t.ground.color[e]=4278218832,t.ground.altitude[e]=0;t.ground.load(),t.view.resize(),window.onresize=t.view.resize,window.onkeydown=t.input.onKeysDown,window.onkeyup=t.input.onKeysUp,window.onmousedown=t.input.onMouseDown,window.onmouseup=t.input.onMouseUp,window.onmousemove=t.input.onMouseMove,window.ontouchstart=t.input.onMouseDown,window.ontouchend=t.input.onMouseUp,window.ontouchmove=t.input.onMouseMove;let s=0;const i=o=>{window.requestAnimationFrame(i);const r=s===0?1:o-s;t.update(r),t.draw(r),s=o};window.requestAnimationFrame(i)};window.addEventListener("load",()=>{console.log("Loading..."),Xt(),console.log("Loaded.")},{once:!0});
