'use strict';class aa{constructor(a,b,l){function m(c,n){var e=c.findIndex(d=>d[0]>=n);if(0<=e){const d=c.splice(e)[0];if(0<e){e=c[e-1];const h=d[2]?Math.max(0,Math.min(1,(n-e[0])/(d[0]-e[0]))):0;c.push([n,e[1]*(1-h)+d[1]*h,d[2]])}}}this.duration=0;this.f=b.tracks.map(c=>{const n=a.createGain(),e=b.bpm*b.ppqn/60,d=c.adsr,h=c.mixer,f=c.data,g=Math.floor((f.length+.5)/4),r=[],q=[],p=[];let u=n,v=b.gaps[0];u.gain.value=h[0];[100,1E3,2500].map((t,H)=>{const I=a.createBiquadFilter();I.type="peaking";I.frequency.value=
t;I.gain.value=h[H+2];u.connect(u=I)});u.connect(l);for(let t=0;t<g;t++){v+=f[t]/e;const H=f[t+g]/e,I=f[t+2*g],Q=1-(1-f[t+3*g]/127)*h[1],Ba=440*2**((I-69)/12),Ca=0<t&&0<c.portamento;0<t&&(m(q,v-Math.max(c.cutoffDuration,1E-6)),q.push([Math.max(0,v-5E-7),0,!0]));0<d[0]&&q.push([v,0,!1]);0<d[1]&&q.push([v+d[0],Q,0<d[0]]);q.push([v+d[0]+d[1],d[2]*Q,0<d[0]+d[1]]);q.push([Infinity,d[2]*Q,!1]);m(q,v+H);q.push([v+H+d[3],0,!0]);if(Ca){const Da=r[r.length-1];p.push([v-(v-Da.time)*c.portamento,Da.frequency,
!1])}p.push([v,Ba,Ca]);this.duration=Math.max(this.duration,v+H+d[3]+b.gaps[1]);r.push({time:v,duration:H,I,frequency:Ba,volume:Q})}return{i:c.wave,gain:n,A:q,v:p,B:r}});let k=null;this.play=(c,n,e)=>{c=void 0===c?!1:c;n=void 0===n?1:n;e=void 0===e?null:e;this.stop();null===e&&(e=a.currentTime);k=e;this.f.map((d,h)=>{let f;if("noise"===d.i){const g=a.createBuffer(1,2*a.sampleRate,a.sampleRate);g.getChannelData(0).forEach((r,q,p)=>p[q]=2*Math.random()-1);f=d.source=a.createBufferSource();f.buffer=
g;f.loop=!0}else f=d.source=a.createOscillator(),f.type=d.i,d.v.forEach(g=>g[2]?f.frequency.linearRampToValueAtTime(Math.max(1E-6,g[1]),e+g[0]):f.frequency.setValueAtTime(g[1],e+g[0]));d.b=a.createGain();d.b.gain.value=0;d.b.connect(d.gain);d.A.forEach(g=>g[2]?d.b.gain.linearRampToValueAtTime(Math.max(1E-6,g[1]*n),e+g[0]):d.b.gain.setValueAtTime(g[1]*n,e+g[0]));f.connect(d.b);f.start(e);f.stop(e+this.duration);0===h&&(f.onended=()=>{this.stop();c&&this.play(!0,n,e+this.duration)})})};this.stop=()=>
{null!==k&&(k=null,this.f.map(c=>{c.source.onended=null;c.source.stop();c.source.disconnect();c.b.disconnect()}))};this.h=()=>null!==k;this.currentTime=()=>a.currentTime-k}}
const A=(a,b)=>[...Array(a).keys()].map(b),ba=THREE.MathUtils,B=ba.clamp,ca=ba.lerp,da=(a,b,l,m)=>{l=1-l**m;return a*(1-l)+b*l},C=ba.randFloat,D=Math.min,E=Math.max,F=Math.floor,ea=Math.ceil,fa=Math.round,ha=Math.abs,ia=Math.sin,ja=Math.cos,ka=Math.sign,G=Math.PI,J=new THREE.Vector3,la=new THREE.Vector3,K=new THREE.Matrix4,ma=new THREE.Matrix4;let na=0,L=null,oa=!0,M=!0,pa=!1,N=1,O=0,P=0,R=0,qa=0,ra=!0,S=0,sa=null,ta=!1,ua=!1;const va=new AudioContext,wa=va.createDynamicsCompressor();wa.connect(va.destination);
const T={};for(let a in window.soundData)T[a]=new aa(va,JSON.parse(window.soundData[a]),wa);const xa=new THREE.Clock(!1),U=new THREE.WebGLRenderer;U.setClearColor(8254);U.xr.enabled=!0;U.xr.setReferenceSpaceType("local-floor");document.body.appendChild(U.domElement);const V=new THREE.Scene,ya=document.querySelector("button");let za=null;const Aa=navigator.xr;
void 0!==Aa&&Aa.isSessionSupported("immersive-vr").then(a=>{a&&(ya.innerHTML="ENTER VR<br/><small>Warning: This game contains flashing lights that may make it unsuitable for people with photosensitive epilepsy</small>",ya.onclick=()=>{pa=!0;T.silent.play();za?(za.end(),za=null):Aa.requestSession("immersive-vr",{optionalFeatures:["local-floor","hand-tracking"]}).then(b=>{za=b;b.addEventListener("end",function m(){pa=!1;b.removeEventListener("end",m);ya.innerHTML="ENTER VR<br/><small>Warning: This game contains flashing lights that may make it unsuitable for people with photosensitive epilepsy</small>"});
U.xr.setSession(b);ya.textContent="EXIT VR"})})});
function Ea(a,b){const l=document.createElement("canvas");l.width=512;l.height=256;const m=new THREE.CanvasTexture(l),k=new THREE.Mesh(new THREE.PlaneGeometry(a,a/2),new THREE.MeshBasicMaterial({map:m,transparent:!0}));k.renderOrder=b?2:-2;const c=l.getContext("2d");c.textAlign="center";c.textBaseline="middle";c.lineJoin="round";const n=(d,h,f,g,r,q,p)=>{q=void 0===q?null:q;p=void 0===p?6:p;c.font=`${g}px "Lucida Sans Unicode", "Lucida Grande", sans-serif`;null!==q&&(c.lineWidth=p,c.strokeStyle=q,
c.strokeText(d,h,f));c.fillStyle=r;c.fillText(d,h,f);m.needsUpdate=!0};k.clear=()=>{c.clearRect(0,0,512,256);m.needsUpdate=!0};k.j=()=>{n(A(4,()=>fa(C(1,255))).join("."),256,128,48,"#060c2c")};k.u=()=>{var d=L;k.clear();c.fillStyle="#f005";c.fillRect(0,0,512,195);n(`FILE ${na+1} OF ${Fa.length}`,256,40,24,"#fff");n(d.title,256,70,25,"#fff");n("READY TO TRANSFER",256,112,36,"#fff");n("PLACE HANDS IN SOCKETS",256,160,28,"#fff");c.beginPath();c.moveTo(32,128);c.lineTo(64,160);c.lineTo(64,140);c.lineTo(448,
140);c.lineTo(448,160);c.lineTo(480,128);c.fillStyle="#a00";c.fill()};k.s=()=>{k.clear();n("CONNECTING",256,127,40,"#fff","#000")};k.l=()=>{k.clear();n("TRANSFER COMPLETE",256,127,40,"#0f0","#000")};let e=null;k.o=()=>{var d=fa(O/L.a.length*100);d!==e&&(e=d,k.clear(),n(d+"%",256,127,40,"#fff","#000"))};k.m=()=>{k.clear();n("404",256,127,127,"#f00","#000");n("FILE NOT FOUND",256,205,50,"#f00","#000")};return k}const Ga=new THREE.Geometry,Ha=[];
A(1E3,a=>{J.set(C(-.5,.5),C(-.5,.5),C(-.5,.5)).setLength(C(1E3,4E3));Ga.merge(new THREE.OctahedronGeometry(C(20,40)),K.identity().makeTranslation(J.x,J.y,J.z));30>a&&(a=Ea(700,!1),a.j(),a.position.copy(J),a.up.set(C(-.5,.5),C(-.5,.5),C(-.5,.5)).normalize(),a.lookAt(0,0,0),a.matrixAutoUpdate=!1,a.updateMatrix(),V.add(a));Ha.filter(b=>500>J.distanceTo(b)).forEach(b=>{K.identity().makeTranslation((J.x+b.x)/2,(J.y+b.y)/2,(J.z+b.z)/2).multiply(ma.identity().lookAt(J,b,la.set(0,1,0)));b=(new THREE.CylinderGeometry(2,
2,J.distanceTo(b),3)).rotateX(G/2);Ga.merge(b,K)});Ha.push(J.clone())});const Ia=new THREE.Mesh(Ga,new THREE.MeshBasicMaterial({color:396332}));V.add(Ia);
const W=new Uint8Array(16384),Ja=new THREE.DataTexture(W,4096,1,void 0,void 0,void 0,void 0,void 0,THREE.LinearFilter),Ka=A(4,()=>new THREE.Vector3),La=new THREE.ShaderMaterial({uniforms:{tex:{value:Ja},d:{type:"v3v",value:Ka}},vertexShader:"\nvarying vec2 vUv;\n\nvoid main() {\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);\n}",fragmentShader:"\n#include <common>\n\nuniform sampler2D tex;\nuniform vec3 d[4];\n\nvarying vec2 vUv;\n\nvoid main() {\n    float x = vUv.x * d[0].x;\n    float dx = x - d[1].x;\n    float t = d[1].y;\n\n    for (int i = 0; i < 2; i++) {\n        float waveWidth = pow(max(1. - abs(d[2 + i].y - dx + sin((dx + t) * 40.) * (d[2 + i].z + .1) * .1), .0) * .2, 2.);\n        float waveDist = abs(mod((d[2 + i].x - 1. / 4.) - vUv.y + .5, 1.) - .5);\n        float waveOverlap = max((waveWidth - waveDist) / waveWidth, 0.);\n\n        gl_FragColor.xyz += (i > 0 ? vec3(10., 2., 2.) : vec3(2., 2., 10.)) * waveOverlap * d[1].z;\n    }\n\n    vec4 laneData = (\n        texture2D(tex, vec2((x - .5) / 4096., .5)) +\n        texture2D(tex, vec2(x / 4096., .5)) +\n        texture2D(tex, vec2((x + .5) / 4096., .5))) / 3.;\n    float laneBorderWidth = .02 +\n        sin(mod(t, 1.) * PI * 4. + mod(x * .5, 2.) * PI) * .005 +\n        sin(mod(t, 1.) * PI * 4. + mod(x * .5, 1.) * PI * 4.) * .005 +\n        max(.05 - abs(dx), 0.);\n    vec2 laneDist = abs(mod((laneData.xy - 1. / 4.) - vUv.y + .5, 1.) - .5);\n    vec2 laneOverlap = (laneData.zw - laneDist) / laneBorderWidth * 5.;\n    float isBorder = max(0., max(1. - abs(laneOverlap.x), 1. - abs(laneOverlap.y)));\n    float isTunnel = step(1., -max(laneOverlap.x, laneOverlap.y));\n    float tunnelWall = .2 + pow(sin((vUv.y + sin(dx + x * .5) * .1 + dx * .02 + x * .002) * PI * 6.), 3.) * .1;\n\n    gl_FragColor += vec4(\n        isBorder * 10. + max(laneOverlap.y * .5, 0.),\n        max(isTunnel * tunnelWall, isBorder * 10.),\n        max(isTunnel * tunnelWall, isBorder * 10. + max(laneOverlap.x * .5, 0.)),\n        1.);\n\n    gl_FragColor *= max(min(d[0].z - x, 1.), 0.) * max(min(dx + 8., 1.), 0.);\n    gl_FragColor += max(sin(vUv.y * PI * 16. + x * 2.) + 2. - abs(d[0].z - x) * .5, 0.) * min(d[0].z * .01, 1.);\n    gl_FragColor *= mix(vec4(1., 1., 1., 1.), vec4(1., 0., 0., 1.), d[0].y) * min(d[0].z, 1.);\n    gl_FragColor = min(gl_FragColor, 1.) * .8;\n}",
blending:THREE.AdditiveBlending,depthTest:!1,side:THREE.DoubleSide,transparent:!0}),Ma=a=>{const b=a.getLength(),l=F(b),m=a.getLengths(l),k=a.getSpacedPoints(l),c=(p,u,v)=>{u=u/b*l;const t=B(F(u),0,l-2);p=g[p];return v.copy(p[t]).lerp(p[t+1],u-t)},n=new THREE.Vector3,e=new THREE.Vector3,d=new THREE.Quaternion,h=new THREE.Raycaster,f=[],g=Object.assign({},{H:c,length:b,lengths:m,points:k},a.computeFrenetFrames(l,!1),{C:(p,u,v,t)=>{c("normals",p,n).multiplyScalar(ia(v)*u);c("binormals",p,e).multiplyScalar(ja(v)*
u);return c("points",p,t).sub(n).sub(e)},moveTo:(p,u,v,t)=>{t=void 0===t?1:t;c("points",p,u.position);c("binormals",p,u.up);p=d.setFromRotationMatrix(K.lookAt(u.position,c("tangents",p,n).multiplyScalar(v).add(u.position),c("binormals",p,e)));u.quaternion.slerp(p,t)},D:(p,u,v,t)=>{const H=r.drawRange.start,I=r.drawRange.count,Q=r.index.count;p=B(96*F(p/g.length*l),0,Q-1);u=B(96*ea(u/g.length*l),0,Q-1);r.setDrawRange(p,u-p);h.ray.set(v,t);f.length=0;h.intersectObject(g.object,!1,f);r.setDrawRange(H,
I);return f}}),r=new THREE.TubeBufferGeometry(a,l,2,16,!1);g.object=new THREE.Mesh(r,La);g.object.renderOrder=1;V.add(g.object);const q=new THREE.Geometry;A(50,()=>{const p=C(0,2*G),u=C(-.005,.005),v=C(4,24),t=A(l,H=>g.C(m[H],v,p+u*m[H],new THREE.Vector3));q.merge(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(t),t.length,.05,3,!1))});g.object.add(new THREE.Mesh(q,new THREE.MeshBasicMaterial({color:396332})));g.object.visible=!1;return g},X=new THREE.Group;V.add(X);const Na=new THREE.Group;X.add(Na);
const Y=new THREE.PerspectiveCamera(80,1,.1,1E4);Y.position.setY(1.6);Na.add(Y);const Oa=()=>{U.setSize(innerWidth,innerHeight);Y.aspect=innerWidth/innerHeight;Y.updateProjectionMatrix()};addEventListener("resize",Oa);Oa();const Z=Ea(2,!0);Z.position.set(0,1,-2);X.add(Z);const Pa=new THREE.Group;V.add(Pa);const Qa=[];
A(2,a=>{const b=new THREE.ConeGeometry(4,5,4,1,!0);b.translate(0,2.495,0);A(32,()=>{const m=C(0,3),k=2.6-ha(m)+C(.1,.3),c=C(0,2*G);b.merge(new THREE.CylinderGeometry(k,k,C(.02,.1),20,1,!0,c,1),K.makeTranslation(0,m,0))});b.rotateX(a*G);a=new THREE.MeshBasicMaterial({color:143720,side:THREE.DoubleSide});a=new THREE.Mesh(b,a);const l=new THREE.LineSegments(new THREE.EdgesGeometry(b,16),new THREE.LineBasicMaterial({color:0}));l.scale.set(.995,.995,.995);a.add(l);Pa.add(a);Qa.push(a)});
A(2,a=>{var b=new THREE.ConeGeometry(.6+.03*a,.5,6,1,!1);b.translate(0,.25+.01*a,0);b.rotateX(G);a=new THREE.MeshBasicMaterial({color:a?16711680:3342336,transparent:!0});b=new THREE.Mesh(b,a);b.renderOrder=3;X.add(b)});
const Ra=A(2,a=>A(2,b=>{const l=b?new THREE.OctahedronGeometry(.15,2):new THREE.RingGeometry(.2,.3,6),m=new THREE.MeshBasicMaterial({color:a?16729156:4474111,transparent:!0,side:THREE[b?"FrontSide":"DoubleSide"],opacity:.8});b=new THREE.Mesh(l,m);b.renderOrder=1.5;b.position.set(1.2*a-.6,0,.4);Pa.add(b);let k=null;b.F=c=>{c!==k&&(k=c,.2<qa&&c&&(qa=0,T.click.play()),m.color.setHex(c?a?16755370:11184895:a?8912896:136),m.needsUpdate=!0)};return b})),Sa=A(2,a=>{const b=U.xr.getControllerGrip(/[?]swap/.test(location.search)?
a:1-a);Na.add(b);const l=new THREE.Group;b.add(l);const m=new THREE.Group;m.rotateX(G);b.add(m);const k=new THREE.MeshBasicMaterial({transparent:!0,side:THREE.BackSide,blending:THREE.AdditiveBlending,depthTest:!1});A(4,d=>{var h=new THREE.OctahedronGeometry(.15-.01*d,2);h=new THREE.Mesh(h,k);h.renderOrder=3;l.add(h);h=A(11,f=>new THREE.Vector2((.05+.003*f**1.8)*(1-.15*d),.1*-f));h=(new THREE.LatheGeometry(h,16)).rotateX(-G/2);h=new THREE.Mesh(h,k);h.renderOrder=3;m.add(h)});let c=0,n=null;const e=
{update:d=>{b.getWorldPosition(J);if(M){var h=Ra[a][1];e.g=.23>h.getWorldPosition(la).distanceTo(J);h.F(e.g)}h=M||20>O||O>L.a.length-20;var f=L.a.D(O-4,O+10,J,la.set(0,0,-1).transformDirection(b.matrixWorld));if(0<f.length&&!M){m.scale.setZ(f[0].distance);f=f[0].uv;var g=f.x*L.a.length;const r=f.y+.25,q=B(F(g),0,4094),p=ca(W[4*q+a],W[4*(q+1)+a],g-q)/255;g=ca(W[4*q+a+2],W[4*(q+1)+a+2],g-q)/255;h=h||Math.abs((r-p+.5)%1-.5)<g;c=da(c,1-h,1E-4,d);Ka[2+a].set(r,f.x*L.a.length-O,c)}else Ka[2+a].set(0,-100,
0);n!==h&&(n=h,k.color.setHex(h||M?a?14500932:4474077:a?13373713:1118668),k.needsUpdate=!0);f=1+.02*ia(5*R);l.scale.set(f,f,f);m.position.set(1E3*M,0,0);M||(h||(ta=!0),f=h?1:C(.3,.7),m.scale.setX(f),m.scale.setY(f),N=D(1,N+(h?.5*d:-d)))}};return e}),Fa=window.levelData.map(a=>{const b=new aa(va,JSON.parse(a.song),wa),l=a.curve,m=A(l[0],e=>new THREE.Vector3(C(-l[1],l[1]),C(-l[1],l[1]),e*l[2])),k=Ma(new THREE.CatmullRomCurve3(m)),c=A(16384,e=>(1<e%4)*E(2-e/32,a.defaultWidth/64)),n=(e,d,h,f,g)=>{const r=
e/b.duration*k.length;e=(e+d)/b.duration*k.length;for(d=E(ea(r),0);d<D(ea(e),4096);d++)c[4*d+f]=B(c[4*d+f]+(g?ca(h,0,(d-r)/(e-r)):h),-1,1)};b.f.forEach((e,d)=>{const h=a.influences[d];null!==h&&A(2,f=>{e.B.forEach(g=>{var r=ia(h[2+f]+ia(g.time/5*G*2))/2+.5;const q=h[0]*r*(1-2*(.5>C(0,1)));r*=h[1];n(g.time,g.duration,q,f,!1);n(g.time+g.duration,2,q,f,!0);n(g.time,g.duration,r,2+f,!1);n(g.time+g.duration,2,r,2+f,!0)})})});return{title:a.title,c:b,a:k,data:c.map((e,d)=>B(fa((0===d%4)*(64+64*B(e,-.7,
.7))+(1===d%4)*(192-64*B(e,-.7,.7))+(1<d%4)*B(64*e,a.minWidth,64)),0,255)),G:k.length/b.duration}}),Ta=()=>{null!==L&&(L.a.object.visible=!1,L.c.stop());L=Fa[na];L.a.object.visible=!0;W.set(L.data);Ja.needsUpdate=!0;N=1;P=O=0;oa=!0;Z.u()},Ua=(a,b)=>{b=void 0===b?null:b;const l=xa.getDelta();R+=l;qa+=l;L.c.h()&&(O=L.c.currentTime()*L.G);a=E(O-D(3,L.a.length-O),0);L.a.moveTo(a,X,1,oa?1:da(0,1,.01,l));X.position.sub(X.up);X.updateWorldMatrix(!1,!0);ta=!1;Sa.forEach(m=>m.update(l));ta!==ua&&((ua=ta)?
T.hurt.play(!0):T.hurt.stop());Ra.forEach((m,k)=>m.forEach(c=>{c.scale.set(1-S,1-S,1-S);c.rotation.set(0,G/2,R*(.5-k))}));M?(oa&&.1>S&&pa&&Sa.every(m=>m.g)&&(ra=oa=!1,T.hub.play(),Z.s(),setTimeout(()=>{L.c.play(!1,.2);Z.clear();M=!1},1E3)),P=E(0,P-50*l)):(Z.o(),L.c.h()?0>=N&&(setTimeout(Ta,4E3),setTimeout(()=>{ra=!0;T.hub.play()},2E3),T.lose.play(),M=!0,Z.m()):(na=(na+1)%Fa.length,setTimeout(Ta,3500),ra=M=!0,T.hub.play(),Z.l()),P=D(O+50,O**1.1));a=M?a/L.a.length:D(F(O/L.a.length*2),1);sa!==a&&(sa=
a,L.a.moveTo(a*L.a.length,Pa,-1));S=da(S,1-ra,.3,l);Qa.forEach((m,k)=>{k=1-k%2*2;m.rotation.set(0,.15*R+E(0,2*S)**3*k,0);m.position.set(0,E(0,2*S)**2*k,0)});Ia.position.copy(X.position).multiplyScalar(.7);Ka[0].set(L.a.length,1-N,P);Ka[1].set(O,R,1-M);null!==b&&U.xr.isPresenting&&(b=b.getViewerPose(U.xr.getReferenceSpace()),null!==b&&0<b.views.length&&(b=J.copy(Na.position).negate().sub(b.views[0].transform.position),Na.position.add(b.set(E(ha(b.x)-.5,0)*ka(b.x),0,E(ha(b.z)-.5,0)*ka(b.z)))));U.render(V,
Y)};addEventListener("load",()=>{xa.start();U.setAnimationLoop(Ua);Ta();U.compile(V,Y)});