(function(){var t,i,e,s,h,o,n,r,a,p,l,d,c,u,f,x,m,w,y,g,S,v=function(t,i){for(var e in i)I.call(i,e)&&(t[e]=i[e]);function s(){this.constructor=t}return s.prototype=i.prototype,t.prototype=new s,t.__super__=i.prototype,t},I={}.hasOwnProperty;s=function(){function t(){this.w=this.sprite.imageW,this.h=this.sprite.imageH,this.offsetX=this.w/-2,this.offsetY=this.h/-2,this.direction||(this.direction=Math.random()>.5?1:-1),this.facingLeft=this.direction<0,this.canBeDestroyed=!0}return t.prototype.draw=function(t){return this.sprite.draw(this.x+this.offsetX-t,this.y+this.offsetY,this.facingLeft)},t.prototype.update=function(t){return!0},t.prototype.onExplode=function(){return!0},t}(),t=function(t){function i(t,e){this.x=t,this.y=e,this.sprite=sprites.building,i.__super__.constructor.apply(this,arguments),this.offsetY=-this.h,this.canBeDestroyed=!1,this.hitbox=buildHitbox(this.offsetX,this.offsetY,1,3,13,32)}return v(i,s),i}(),p=function(t){function i(t,e){this.x=t,this.y=e,this.sprite=sprites.mine,i.__super__.constructor.apply(this,arguments),this.points=100,this.hitbox=buildHitbox(this.offsetX,this.offsetY,1,1,15,15)}return v(i,s),i.prototype.onExplode=function(){var t,i,e,s,h,n;for(n=50*u.pixelD,h=[],i=0,e=(s=[0,Math.PI,-Math.PI/2,Math.PI/2]).length;i<e;i++)t=s[i],h.push(o.world.getNextEnemyShot().fire(this.x,this.y,n,t));return h},i}(),c=function(t){function i(t,e){this.x=t,this.y=e,this.sprite=sprites.radar,i.__super__.constructor.apply(this,arguments),this.offsetY=-this.h,this.cooldown=Math.random(),this.firePattern=[3,.5],this.patternIndex=0,this.points=100,this.hitbox=buildHitbox(this.offsetX,this.offsetY,1,2,15,16)}return v(i,s),i.prototype.update=function(t){if(this.cooldown-=t,this.cooldown<0)return this.offScreen||this.fire(),this.patternIndex+=1,this.patternIndex===this.firePattern.length&&(this.patternIndex=0),this.cooldown=this.firePattern[this.patternIndex]},i.prototype.fire=function(){var t,i,e,s,h,n;for(n=50*u.pixelD,h=[],i=0,e=(s=[Math.PI,-Math.PI/2,0]).length;i<e;i++)t=s[i],h.push(o.world.getNextEnemyShot().fire(this.x-3*u.pixelW,this.y-13*u.pixelH,n,t));return h},i}(),h=function(){function t(){this.sprite=sprites.enemyShot,this.w=this.sprite.imageW,this.h=this.sprite.imageH,this.offsetX=this.w/-2,this.offsetY=this.h/-2,this.dead=!0}return t.prototype.fire=function(t,i,e,s){return this.x=t,this.y=i,this.dead=!1,this.offScreen=!1,this.hSpeed=Math.cos(s)*e,this.vSpeed=Math.sin(s)*e},t.prototype.draw=function(t){return this.sprite.draw(this.x+this.offsetX-t,this.y+this.offsetY,!1)},t.prototype.update=function(t){if(this.x+=this.hSpeed*t,this.y+=this.vSpeed*t,this.offScreen)return this.dead=!0},t}(),o={state:(n={PRE_LAUNCH:"PRE_LAUNCH",TITLE_SCREEN:"TITLE_SCREEN",PLAYING_IN_PLAY:"PLAYING_IN_PLAY",PLAYING_WARPING:"PLAYING_WARPING",PLAYING_WARPING_WIN:"PLAYING_WARPING_WIN",START_OF_LEVEL:"START_OF_LEVEL",PLAYING_SPAWNING:"PLAYING_SPAWNING",GAME_OVER:"GAME_OVER",PLAYER_WINS:"PLAYER_WINS"}).PRE_LAUNCH,run:function(){return this.ctx=u.ctx,this.canvas=u.canvas,this.cooldown=0,u.setSize(25,23),addChars(48,astroDigits),addChars(97,lowercase),this.showStory()},update:function(t){var i;if(i=this.lastTimestamp?(t-this.lastTimestamp)/1e3:0,this.lastTimestamp=t,this.cooldown-=i,this.state===n.PRE_LAUNCH?keysDown.fire&&this.cooldown<=0&&(this.cooldown=.5,this.showTitleScreen()):this.state===n.TITLE_SCREEN?keysDown.fire&&this.cooldown<=0&&this.startGame():this.state===n.GAME_OVER||this.state===n.PLAYER_WINS?keysDown.fire&&this.cooldown<=0&&(this.state=n.TITLE_SCREEN,this.cooldown=1,this.showTitleScreen()):this.state===n.PLAYING_SPAWNING?this.cooldown<0?(this.state=n.PLAYING_IN_PLAY,this.ship.invulnerable=!1):this.cooldown<2&&(this.ship.dead=!1,this.ship.autopilot=!1,this.ship.invulnerable=!0):this.state===n.PLAYING_WARPING?this.cooldown<0?(this.state=n.PLAYING_SPAWNING,this.ship.autopilot=!1,this.ship.invulnerable=!0,this.ship.warping=!1,this.cooldown=2):this.cooldown<2&&this.world.levelEnded&&(this.level+=1,this.world.generate(this.level)):this.state===n.PLAYING_WARPING_WIN&&this.cooldown<0&&(this.state=n.PLAYER_WINS,this.cooldown=1,this.showEnding()),this.state!==n.TITLE_SCREEN&&this.state!==n.PRE_LAUNCH&&this.state!==n.PLAYER_WINS)return this.world.update(i),this.draw()},draw:function(){var t,e,s,h;if(this.state===n.PLAYING_WARPING?(u.screenColour=i.PURPLE,u.clear(),u.textColour=i.WHITE,s=this.world.levelEnded?this.level:this.level-1,u.printAt(6,8,"MOON "+s+" CLEARED"),u.printAt(8,10,"WARPING ..."),u.textColour=i.BLUE):this.state===n.PLAYING_WARPING_WIN?(u.screenColour=i.GREEN,u.clear(),u.textColour=i.WHITE,u.printAt(3,8,"MISSION SUCCESSFUL!"),u.printAt(7,10,"WARPING TO"),u.printAt(3,11,"RENDEZVOUS POINT..."),u.textColour=i.BLUE):(this.ctx.fillStyle=i.BLACK,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),u.textColour=i.WHITE),u.printAt(1,2,""+this.score),u.printAt(12,2,""+this.level),this.livesLeft>0)for(t=e=1,h=this.livesLeft;1<=h?e<=h:e>=h;t=1<=h?++e:--e)u.printAt(24-t,2,"/");if(this.world.draw(),this.state===n.GAME_OVER&&(u.textColour=i.WHITE,u.printAt(8,8,"GAME OVER"),this.cooldown<0))return u.printAt(7,10,"Press  FIRE")},startGame:function(){return this.state=n.PLAYING_SPAWNING,addChars(97,lowercase),u.clear(),u.printAt(8,4,"Playing ..."),this.score=0,this.kills=0,this.shotsFired=0,this.livesLeft=4,this.level=1,this.ship=new f,this.world=new S(1,this.ship),this.ship.y=this.world.blockToPixelH(13),this.cooldown=2},warpToNextWorld:function(){return 5===this.level?this.state=n.PLAYING_WARPING_WIN:this.state=n.PLAYING_WARPING,this.cooldown=5,this.ship.warping=!0,this.world.levelEnded=!0},endGame:function(){return this.state=n.GAME_OVER,this.cooldown=3},respawnPlayer:function(){return this.ship.dead=!0,this.ship.autopilot=!0,0===this.livesLeft?this.endGame():(this.livesLeft-=1,this.ship.y=96*u.pixelH,this.state=n.PLAYING_SPAWNING,this.cooldown=3)},hLine:function(t){return u.printAt(0,t,";;;;;;;;;;;;;;;;;;;;;;;;;")},showTitleScreen:function(){return w.clear(),addChars(97,triangles),this.state=n.TITLE_SCREEN,e.hide(),u.setBorder(i.BLUE),u.screenColour=i.BLACK,u.clear(),u.textColour=i.YELLOW,u.printAt(3,2,"n nopnianean n n kea"),u.textColour=i.GREEN,u.printAt(3,3,"bdnopnldnhdn n nkea "),u.textColour=i.PURPLE,u.printAt(3,5,"  b"),u.textColour=i.RED,u.printAt(3,1,"d dopcn nhdd mnnmnnd"),u.printAt(10,3,"d"),u.textColour=i.BLUE,u.printAt(3,4," bnopbn neabnm bjhnd"),u.printAt(10,2,"a"),u.textColour=i.WHITE,u.printAt(0,6,"GET THE SHIP BACK TO BASE"),this.hLine(7),u.printAt(15,9,"50"),u.printAt(15,12,"50"),u.printAt(15,15,"100"),u.printAt(15,18,"150"),u.printAt(1,10,"MOVE"),u.printAt(1,12,"OR"),u.printAt(1,16,"FIRE"),this.hLine(20),this.hLine(22),u.textColour=i.YELLOW,u.printAt(3,21,"PRESS SPACE TO START"),u.textColour=i.PURPLE,u.printAt(1,11,"^ _ $ &"),u.printAt(1,13,"W A S D"),u.printAt(1,17,"SPACE"),u.textColour=i.BLUE,u.drawSprite(96,71,ufo),u.drawSprite(96,88,radar),u.drawSprite(96,112,mine),u.drawSprite(96,140,guppie)},showStory:function(){return u.screenColour=i.BLACK,u.setBorder(i.BLACK),u.clear(),w.display(["c:GREEN","t:","t: ** INCOMING  MESSAGE **","t:","t:Pilot,","t:","t:You've infiltrated       The Foundation's secret  research base and stolen their next gen fighter.","t:","t:Now you'll need to fight your way past their      defences on the five     outer moons, back to our ship waiting in deep     space.","t:","t:Fly well,","t:The rebellion depends on you.","d: ","d:","c:BLUE","d:       Press SPACE"]),requestAnimationFrame(update)},showEnding:function(){return u.screenColour=i.BLACK,u.setBorder(i.BLACK),u.clear(),w.display(["c:GREEN","t:","t: ** INCOMING  MESSAGE **","t:","t:Awesome skill, Pilot!","t:","t:The technology in this   ship will be invaluable  in our fight against     The Foundation and their evil schemes.","t:","t:Well done.","t:","t:","c:YELLOW","t:   Score       "+(""+this.score).padStart(5," "),"t:   Kills       "+(""+this.kills).padStart(5," "),"t:   Shots fired "+(""+this.shotsFired).padStart(5," "),"t:   Accuracy    "+((this.kills/this.shotsFired*100).toFixed(1)+"%").padStart(6," "),"t:","c:BLUE","t:       Press SPACE","p:1"])}},a=function(){function t(t,i){var e,s;for(this.pool=[],e=0,s=i;0<=s?e<=s:e>=s;0<=s?++e:--e)this.pool.push(new t);this.itemIndex=0}return t.prototype.getNextItem=function(){var t;return t=this.pool[this.itemIndex],this.itemIndex+=1,this.itemIndex===this.pool.length&&(this.itemIndex=0),t},t}(),l=function(){function t(){this.w=1.5*u.pixelW,this.h=1.5*u.pixelH,this.offsetX=this.w/-2,this.offsetY=this.h/-2,this.dead=!0,this.maxLife=Math.random()+2,this.colour={},this.drag=.985}return t.prototype.fire=function(t,i,e,s,h){return this.x=t,this.y=i,e+=Math.random()/10-.05,s*=.9+.2*Math.random(),this.dead=!1,this.offScreen=!1,this.hSpeed=Math.cos(e)*s,this.vSpeed=Math.sin(e)*s,this.life=this.maxLife,this.initColour(h)},t.prototype.draw=function(t){return u.ctx.fillStyle=this.colour.hexString+this.colour.alphaHex,u.ctx.fillRect(this.x+this.offsetX-t,this.y+this.offsetY,this.w,this.h)},t.prototype.update=function(t){var i,e;return this.hSpeed*=this.drag,this.vSpeed*=this.drag,this.x+=this.hSpeed*t,this.y+=this.vSpeed*t,this.life-=t,this.life<=0?this.dead=!0:(e=this.life/this.maxLife)<.5?(1===(i=Math.round(2*e*255).toString(16)).length&&(i="0"+i),this.colour.alphaHex=i):void 0},t.prototype.initColour=function(t){var i,e,s;return 1===(s=t.r.toString(16)).length&&(s="0"+s),1===(e=t.g.toString(16)).length&&(e="0"+e),1===(i=t.b.toString(16)).length&&(i="0"+i),this.colour.rgb=t,this.colour.hexString="#"+s+e+i,this.colour.alphaHex="ff"},t}(),e={x:0,y:0,visible:!1,blinkTimer:null,blinkStateOn:!0,show:function(){return this.blinkTimer||(this.blinkTimer=setInterval(e.blink,500)),this.visible=!0,this.blinkStateOn=!0,this.draw()},hide:function(){return clearInterval(this.blinkTimer),this.blinkTimer=null,this.blinkStateOn=!1,this.draw(),this.visible=!1},blink:function(){return e.blinkStateOn=!e.blinkStateOn,e.draw()},draw:function(){var t;if(this.visible)return t=this.blinkStateOn?u.textColour:u.screenColour,u.drawCharRect(e.x,e.y,t)},moveTo:function(t,i){return this.visible&&u.drawCharRect(e.x,e.y,u.screenColour),e.x=t,e.y=i,this.draw()},newLine:function(){return this.moveTo(0,e.y+1)}},u={screenColour:(i={BLACK:"#000000",WHITE:"#ffffff",RED:"#e32d2d",CYAN:"#2de3e3",PURPLE:"#b31de3",GREEN:"#2dc32d",BLUE:"#2d2de3",YELLOW:"#e3e32d"}).WHITE,textColour:i.BLUE,colour2:i.YELLOW,colour3:i.RED,columnsWide:22,rowsHigh:23,pixelW:5,pixelH:3,init:function(t,i){return this.pixelW=t,this.pixelH=i,this.pixelD=Math.sqrt(this.pixelW*this.pixelW+this.pixelH*this.pixelH),this.canvas=document.getElementById("game"),this.ctx=this.canvas.getContext("2d"),this.setSize(this.columnsWide,this.rowsHigh),this.clear()},clear:function(){return this.ctx.fillStyle=this.screenColour,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),e.x=0,e.y=0},setBorder:function(t){return document.body.style.backgroundColor=t},setSize:function(t,i){return this.columnsWide=t,this.rowsHigh=i,this.canvas.width=8*this.columnsWide*this.pixelW,this.canvas.height=8*this.rowsHigh*this.pixelH},setCursor:function(t,i){return e.x=t,e.y=i},moveCursor:function(){var t,i;return t=e.x+1,i=e.y,t===this.columnsWide&&(t=0,(i=e.y+1)===this.rowsHigh&&(i=0)),e.moveTo(t,i)},drawCharRect:function(t,i,e){return this.ctx.fillStyle=e,this.ctx.fillRect(8*t*this.pixelW,8*i*this.pixelH,8*u.pixelW,8*u.pixelH)},drawCharAtCursor:function(t){var i,s,h;return i=charBytes[t],s=8*e.x*this.pixelW,h=8*e.y*this.pixelH,this.moveCursor(),this.ctx.fillStyle=this.textColour,i.forEach(function(t){var i;for(i=0;i<8;)t&Math.pow(2,7-i)&&u.ctx.fillRect(s+i*u.pixelW,h,u.pixelW,u.pixelH),i++;return h+=u.pixelH}),!0},print:function(t){var i,e,s,h;for(h=[],i=e=0,s=t.length;0<=s?e<s:e>s;i=0<=s?++e:--e)h.push(this.drawCharAtCursor(this.asciiToVic(t.charCodeAt(i))));return h},println:function(t){return this.print(t),e.newLine()},printAt:function(t,i,s){return e.moveTo(t,i),this.print(s)},asciiToVic:function(t){return t},drawSprite:function(t,i,e){var s,h,o,n,r,a,p,l,d,c,f,x;for(t*=this.pixelW,i*=this.pixelH,r=0,l=(f=e.trim().split("\n")).length;r<l;r++){for(c=0,a=0,d=(x=f[r].match(/(..?)/g)).length;a<d;a++)for(o=x[a],h=parseInt(o,16),p=0;p<=3;++p)(n=0===(s=192&h)?null:64===s?this.textColour:128===s?this.colour2:192===s?this.colour3:void 0)&&(this.ctx.fillStyle=n,this.ctx.fillRect(t+c*u.pixelW,i,2*u.pixelW,u.pixelH)),c+=2,h<<=2;i+=u.pixelH}return!0}},f=function(){function t(){this.sprite=sprites.ship,this.w=this.sprite.imageW,this.h=this.sprite.imageH,this.offsetX=this.w/-2,this.offsetY=this.h/-2,this.x=100,this.y=100,this.facingLeft=!1,this.maxVSpeed=120*u.pixelH,this.maxHSpeed=180*u.pixelW,this.vThrust=3e3,this.hThrust=3e3,this.vSpeed=0,this.hSpeed=0,this.minY=18*u.pixelH,this.maxY=165*u.pixelH,this.offScreen=!1,this.dead=!1,this.autopilot=!1,this.invulnerable=!1,this.warping=!1,this.cooldown=.3,this.hitbox=buildHitbox(this.offsetX,this.offsetY,1,4,30,12)}return t.prototype.update=function(t){return this.cooldown>0&&(this.cooldown-=t,this.cooldown<0&&(this.cooldown=0)),this.warping||(this.y+=this.vSpeed*t,this.y<this.minY&&(this.y=this.minY),this.y>this.maxY&&(this.y=this.maxY),this.x+=this.hSpeed*t,this.movingV||(this.vSpeed*=.8),this.movingH||(this.hSpeed*=.8)),this.movingV=!1,this.movingH=!1},t.prototype.draw=function(t){return this.sprite.draw(this.x+this.offsetX-t,this.y+this.offsetY,this.facingLeft)},t.prototype.moveV=function(t,i){var e;return this.warping?(e=o.world.blockToPixelH(13),Math.abs(e-this.y)<2?this.y=e:this.y>e?this.y-=1:this.y+=1):(this.vSpeed+=this.vThrust*t*i,this.vSpeed>this.maxVSpeed?this.vSpeed=this.maxVSpeed:this.vSpeed<-this.maxVSpeed&&(this.vSpeed=-this.maxVSpeed),this.movingV=!0)},t.prototype.moveH=function(t,i){return this.warping?this.x+=t*this.maxHSpeed*5:(this.hSpeed+=this.hThrust*t*i,this.hSpeed>this.maxHSpeed?this.hSpeed=this.maxHSpeed:this.hSpeed<-this.maxHSpeed&&(this.hSpeed=-this.maxHSpeed),this.movingH=!0),this.facingLeft=i<0},t.prototype.switchDirection=function(){return this.facingLeft=!this.facingLeft},t.prototype.fireShot=function(){var t,i;if(!(this.warping||this.cooldown>0))return i=250*u.pixelW,t=14*u.pixelW,this.facingLeft&&(i*=-1,t*=-1),o.world.getNextPlayerShot().fire(this.x+t,this.y+2*u.pixelH,i),o.shotsFired+=1,this.cooldown=.2},t}(),d=function(){function t(){this.sprite=sprites.playerShot,this.w=this.sprite.imageW,this.h=this.sprite.imageH,this.offsetX=this.w/-2,this.offsetY=this.h/-2,this.dead=!0,this.hitbox=buildHitbox(this.offsetX,this.offsetY,2,-4,14,6)}return t.prototype.fire=function(t,i,e){return this.x=t,this.y=i,this.hSpeed=e,this.dead=!1,this.offScreen=!1,this.facingLeft=this.hSpeed<0},t.prototype.draw=function(t){return this.sprite.draw(this.x+this.offsetX-t,this.y+this.offsetY,this.facingLeft)},t.prototype.update=function(t){if(this.x+=this.hSpeed*t,this.offScreen)return this.dead=!0},t}(),x=function(t){function i(t,e){this.x=t,this.direction=e,this.sprite=sprites.snake,this.base=8*u.pixelH*10,this.y=this.base,this.vSpeed=200*u.pixelH,this.hSpeed=30*u.pixelW,i.__super__.constructor.apply(this,arguments),this.points=100,this.hitbox=buildHitbox(this.offsetX,this.offsetY,1,2,14,14)}return v(i,s),i.prototype.update=function(t){if(this.x+=this.direction*this.hSpeed*t,this.y=this.base+8*Math.sin(this.x/200)*7*u.pixelH,!this.offScreen&&Math.random()>.991)return this.fire()},i.prototype.fire=function(){var t;return t=150*u.pixelH,o.world.getNextEnemyShot().fire(this.x,this.y,t,0),o.world.getNextEnemyShot().fire(this.x,this.y,t,Math.PI)},i}(),m=function(){function t(t,i,e,s){this.spriteData=t,this.w=i,this.h=e,this.colours=s,this.canvas=document.createElement("canvas"),this.imageW=u.pixelW*this.w*2,this.imageH=u.pixelH*this.h,this.canvas.width=this.imageW,this.canvas.height=2*this.imageH,this.ctx=this.canvas.getContext("2d"),this.createCanvas()}return t.prototype.createCanvas=function(){var t,i,e,s,h,o,n,r,a,p,l,d,c,f;for(c=0,f=0,c*=u.pixelW,f*=u.pixelH,h=0,r=(l=this.spriteData.trim().split("\n")).length;h<r;h++){for(p=0,o=0,a=(d=l[h].match(/(..?)/g)).length;o<a;o++)for(e=d[o],i=parseInt(e,16),n=0;n<=3;++n)(s=0===(t=192&i)?null:64===t?this.colours[0]:128===t?this.colours[1]:192===t?this.colours[2]:void 0)&&(this.ctx.fillStyle=s,this.ctx.fillRect(c+p*u.pixelW,f,2*u.pixelW,u.pixelH)),p+=2,i<<=2;f+=u.pixelH}return this.ctx.save(),this.ctx.scale(-1,1),this.ctx.drawImage(this.canvas,0,this.imageH,-1*this.imageW,2*this.imageH),this.ctx.restore()},t.prototype.draw=function(t,i,e){var s;return s=e?this.imageH:0,u.ctx.drawImage(this.canvas,0,s,this.imageW,this.imageH,t,i,this.imageW,this.imageH)},t.prototype.getImageData=function(t){var i;return i=t?this.imageH:0,this.ctx.getImageData(0,i,this.imageW,this.imageH).data},t}(),w={command:null,commandPos:0,display:function(t,i){return this.commands=t,this.callback=i,this.execNextCommand()},execNextCommand:function(){var t;if(0!==this.commands.length)return t=this.commands.shift().split(":"),this.commandText=t[1],this.command=t[0],this.commandPos=0,this.execCommand();"function"==typeof this.callback&&this.callback()},execCommand:function(){return"d"===this.command?(e.hide(),u.println(this.commandText),setTimeout(function(){return w.execNextCommand()},50)):"w"===this.command?(e.show(),setTimeout(function(){return w.execNextCommand()},parseInt(this.commandText))):"t"===this.command?(e.show(),this.commandPos<this.commandText.length?(u.print(this.commandText.charAt(this.commandPos)),this.commandPos+=1,setTimeout(function(){return w.execCommand()},50)):(e.newLine(),setTimeout(function(){return w.execNextCommand()},800))):"p"===this.command?(e.hide(),setTimeout(function(){return w.execNextCommand()},parseInt(this.commandText))):"x"===this.command?(u.clear(),setTimeout(function(){return w.execNextCommand()},50)):"c"===this.command?(u.textColour=i[this.commandText],setTimeout(function(){return w.execNextCommand()},50)):void 0},clear:function(){return this.commands=[],this.command=null,this.commandText="",this.callback=null}},y=function(t){function i(t,e){this.x=t,this.base=e,this.sprite=sprites.ufo,this.y=this.base,this.vSpeed=200*u.pixelH,this.hSpeed=30*u.pixelW,i.__super__.constructor.apply(this,arguments),this.points=50,this.hitbox=buildHitbox(this.offsetX,this.offsetY,1,2,14,6)}return v(i,s),i.prototype.update=function(t){if(this.x+=this.direction*this.hSpeed*t,this.y=this.base+10*Math.sin(this.x/100)*u.pixelH,!this.offScreen&&Math.random()>.99)return this.fire()},i.prototype.fire=function(){var t,i,e;return i=4*u.pixelW,e=20*u.pixelD,t=Math.random()*Math.PI*2,o.world.getNextEnemyShot().fire(this.x+i,this.y+2*u.pixelH,e,t)},i}(),r=function(t){function i(t){this.x=t,this.sprite=sprites.seeker,this.y=100,this.vSpeed=15*u.pixelH,this.hSpeed=40*u.pixelW,i.__super__.constructor.apply(this,arguments),this.points=150,this.hitbox=buildHitbox(this.offsetX,this.offsetY,2,2,12,8)}return v(i,s),i.prototype.setRandomTargetDelta=function(){return this.targetDeltaX=(randInt(200)-100)*u.pixelW,this.targetY=(randInt(130)+30)*u.pixelH},i.prototype.update=function(t){var i,e;if(i=o.ship.x+this.targetDeltaX-this.x,e=this.targetY-this.y,Math.abs(i)>10?(i>0?(this.direction=1,this.facingLeft=!1):(this.direction=-1,this.facingLeft=!0),this.x+=this.direction*this.hSpeed*t):this.setRandomTargetDelta(),Math.abs(e)>10&&(this.direction=e>0?1:-1,this.y+=this.direction*this.vSpeed*t),!this.offScreen&&Math.random()>.99)return this.fire()},i.prototype.fire=function(){var t,i,e;return i=4*u.pixelW,e=20*u.pixelD,t=Math.random()*Math.PI*2,o.world.getNextEnemyShot().fire(this.x+i,this.y+2*u.pixelH,e,t)},i}(),g={angleDistBetweenPoints:function(t,i){var e,s,h,o;return t===i?0:(h=i.x-t.x,o=i.y-t.y,s=Math.sqrt(h*h+o*o),e=Math.acos(h/s),o<0&&(e=0-e),{angle:e,distance:s})}},S=function(){function e(t,i){this.level=t,this.ship=i,this.ctx=u.ctx,this.canvas=u.canvas,this.width=this.blockToPixelW(200),this.halfWidth=this.width/2,this.spawnWidth=this.width-this.blockToPixelW(3),this.cameraX=this.canvas.width/2,this.offScreenDist=this.cameraX+this.blockToPixelW(2),this.sky=this.blockToPixelH(2),this.ground=this.blockToPixelH(22),this.height=this.ground-this.sky,this.items=[],this.levelEnded=!1,this.playerShots=new a(d,10),this.enemyShots=new a(h,200),this.particles=new a(l,2e3),this.generate(this.level)}return e.prototype.blockToPixelH=function(t){return 8*t*u.pixelH},e.prototype.blockToPixelW=function(t){return 8*t*u.pixelW},e.prototype.generate=function(i){var e,s,h,o,n,a,l,d,f,m,w,g,S,v,I,E,H,b,A,P,W,N,L,T,C,_,R;for(this.levelEnded=!1,this.items=[],o=0,l=(H=this.playerShots.pool).length;o<l;o++)H[o].dead=!0;for(n=0,d=(b=this.enemyShots.pool).length;n<d;n++)b[n].dead=!0;for(a=0,f=(A=this.particles.pool).length;a<f;a++)A[a].dead=!0;if(e=randInt(3)+4,1===i)R=5,E=3;else if(2===i)R=12,E=5,w=0,s=0;else if(3===i)R=10,E=5,w=6,s=0;else if(4===i)R=3,E=3,w=0,s=10;else if(5===i)for(R=5,E=3,w=0,s=0,_=this.ship.x+this.spawnWidth/2,h=m=0;m<=12;h=++m)this.items.push(new x(_+32*h*u.pixelH,-1)),this.items.push(new x(_+32*h*u.pixelH,1));for(h=g=0,P=e;0<=P?g<P:g>P;h=0<=P?++g:--g)this.items.push(new t(randInt(this.spawnWidth),this.ground));if(E)for(h=S=0,W=E;0<=W?S<W:S>W;h=0<=W?++S:--S)this.items.push(new c(randInt(this.spawnWidth),this.ground));if(R)for(h=v=0,N=R;0<=N?v<N:v>N;h=0<=N?++v:--v)this.items.push(new y(randInt(this.spawnWidth),randInt(this.blockToPixelH(11))+this.blockToPixelH(4.5)));if(w)for(h=I=0,L=w;0<=L?I<L:I>L;h=0<=L?++I:--I)this.items.push(new p(randInt(this.spawnWidth),randInt(this.blockToPixelH(11))+this.blockToPixelH(4.5)));if(s)for(h=C=0,T=s;0<=T?C<T:C>T;h=0<=T?++C:--C)this.items.push(new r(randInt(this.spawnWidth)));return this.guppies=i>1,this.nextGuppieSpawn=20},e.prototype.getNextPlayerShot=function(){return this.playerShots.getNextItem()},e.prototype.getNextEnemyShot=function(){return this.enemyShots.getNextItem()},e.prototype.addParticle=function(t,i,e,s,h){return this.particles.getNextItem().fire(t,i,e,s,h)},e.prototype.spawnGuppie=function(){return this.nextGuppieSpawn=20,this.items.push(new r(this.ship.x+this.spawnWidth/2))},e.prototype.update=function(t){var i,e,s,h,o,n,r,a,p,l,d,c,u,f,x;for(this.guppies&&(this.nextGuppieSpawn-=t,this.nextGuppieSpawn<0&&this.spawnGuppie()),this.ship.dead||this.ship.autopilot||this.ship.warping||(keysDown.right?this.ship.moveH(t,1):keysDown.left&&this.ship.moveH(t,-1),keysDown.up?this.ship.moveV(t,-1):keysDown.down&&this.ship.moveV(t,1),this.ship.update(t),keysDown.fire&&this.ship.fireShot()),this.ship.warping&&(this.ship.moveH(t,1),this.ship.moveV(t,1)),x=this.ship.x+this.halfWidth,p=this.ship.x-this.halfWidth,e=0,o=(d=this.playerShots.pool).length;e<o;e++)i=d[e],this.updateItem(i,t,x,p);for(s=0,n=(c=this.items).length;s<n;s++)i=c[s],this.updateItem(i,t,x,p);for(h=0,r=(u=this.enemyShots.pool).length;h<r;h++)i=u[h],this.updateItem(i,t,x,p);for(l=0,a=(f=this.particles.pool).length;l<a;l++)i=f[l],this.updateItem(i,t,x,p);if(!(this.ship.dead||this.ship.autopilot||this.ship.warping||(this.seeIfEnemyHit(),this.ship.invulnerable)))return this.seeIfPlayerHit()},e.prototype.updateItem=function(t,i,e,s){if(!t.dead)return t.update(i),t.x>e?t.x-=this.width:t.x<s&&(t.x+=this.width),t.offScreen=Math.abs(t.x-this.ship.x)>this.offScreenDist||t.y<9*u.pixelH||t.y>this.ground},e.prototype.draw=function(){var t,e,s,h,o,n,r,a,p,l,d,c,u,f;for(this.ctx.fillStyle=i.GREEN,l=this.ship.x-this.cameraX,this.ctx.fillRect(0,this.ground,this.canvas.width,this.blockToPixelH(1)),e=0,o=(d=this.enemyShots.pool).length;e<o;e++)t=d[e],this.drawItem(t,l);for(s=0,n=(c=this.items).length;s<n;s++)t=c[s],this.drawItem(t,l);for(h=0,r=(u=this.playerShots.pool).length;h<r;h++)t=u[h],this.drawItem(t,l);for(p=0,a=(f=this.particles.pool).length;p<a;p++)t=f[p],this.drawItem(t,l);return this.ship.invulnerable&&(this.ctx.globalAlpha=.5),this.drawItem(this.ship,l),this.ctx.globalAlpha=1,this.drawRadar()},e.prototype.drawItem=function(t,i){if(!t.dead&&!t.offScreen)return t.draw(i)},e.prototype.drawRadar=function(){var e,s,h,o,n,r,a,p,l,d,c,f;for(n=this.ship.x,r=this.sky,a=this.canvas.width/this.width,p=this.blockToPixelH(1)/this.height,e=this.canvas.width/2,this.ctx.fillStyle=i.BLUE,this.ctx.fillRect(e-12*u.pixelW,u.pixelH,25*u.pixelW,8*u.pixelH),this.ctx.fillStyle=i.WHITE,this.ctx.fillRect(0,9*u.pixelH,this.canvas.width,u.pixelH),d=[],h=0,o=(l=this.items).length;h<o;h++)(s=l[h]).dead?d.push(void 0):(c=(s.x-n)*a+e,f=(s.y-r)*p,this.ctx.fillRect(c,f,u.pixelW,u.pixelH),s instanceof t?d.push(this.ctx.fillRect(c,f-u.pixelH,u.pixelW,u.pixelH)):d.push(void 0));return d},e.prototype.seeIfPlayerHit=function(){var t,i,e,s,h,o,n,r,a;for(i=0,s=(o=this.enemyShots.pool).length;i<s;i++)!(a=o[i]).dead&&this.pointInHitbox(this.ship,a.x,a.y)&&(a.dead=!0,this.playerDies(a.x,a.y));for(r=[],e=0,h=(n=this.items).length;e<h;e++)!(t=n[e]).dead&&this.hitboxesIntersect(this.ship,t)?r.push(this.playerDies(this.ship.x,this.ship.y)):r.push(void 0);return r},e.prototype.seeIfEnemyHit=function(){var t,i,e,s,h,o;for(h=[],i=0,e=(s=this.playerShots.pool).length;i<e;i++)(o=s[i]).dead?h.push(void 0):h.push(function(){var i,e,s,h;for(h=[],i=0,e=(s=this.items).length;i<e;i++)(t=s[i]).canBeDestroyed&&!t.dead&&this.hitboxesIntersect(o,t)?(o.dead=!0,h.push(this.enemyDies(t,o.x,o.y,o.hSpeed))):h.push(void 0);return h}.call(this));return h},e.prototype.hitboxesIntersect=function(t,i){return t.x+t.hitbox.right>i.x+i.hitbox.left&&i.x+i.hitbox.right>t.x+t.hitbox.left&&t.y+t.hitbox.bottom>i.y+i.hitbox.top&&i.y+i.hitbox.bottom>t.y+t.hitbox.top},e.prototype.pointInHitbox=function(t,i,e){return!!t.hitbox&&(i>t.x+t.hitbox.left&&i<t.x+t.hitbox.right&&e>t.y+t.hitbox.top&&e<t.y+t.hitbox.bottom)},e.prototype.playerDies=function(t,i){var e;if(!this.ship.dead)return e={x:t-this.ship.x,y:i-this.ship.y},this.explodeSprite(this.ship,e,1),o.respawnPlayer()},e.prototype.enemyDies=function(t,i,e,s){var h,n,r,a,p,l;for(n={x:i-t.x,y:e-t.y},this.explodeSprite(t,n,s),t.onExplode(),t.dead=!0,o.score+=t.points,o.kills+=1,h=0,a=0,p=(l=this.items).length;a<p;a++)!(r=l[a]).dead&&r.canBeDestroyed&&(h+=1);if(0===h)return o.warpToNextWorld()},e.prototype.explodeSprite=function(t,i,e){var s,h,o,n,r,a,p,l,d,c,f,x,m,w,y,S,v;for(m=t.sprite,r=m.getImageData(t.facingLeft),y=m.imageW,n=m.imageH,h=e>0?10*u.pixelW:-10*u.pixelW,{x:0,y:0},x=[],v=a=0,c=n,f=u.pixelH;f>0?a<c:a>c;v=a+=f)x.push(function(){var e,n,a,c;for(c=[],S=e=0,n=y,a=u.pixelW;a>0?e<n:e>n;S=e+=a)d=r[p=v*(4*y)+4*S],o=r[p+1],s=r[p+2],r[p+3]>0?(l={x:S+t.offsetX,y:v+t.offsetY},w=Math.abs(i.y-l.y)<3*u.pixelH?g.angleDistBetweenPoints(i,{x:15*(h+l.x),y:l.y}):g.angleDistBetweenPoints(i,l),l.x+=t.x,l.y+=t.y,c.push(this.addParticle(l.x,l.y,w.angle,w.distance/2+300,{r:d,g:o,b:s}))):c.push(void 0);return c}.call(this));return x},e}(),window.update=function(t){return o.update(t),window.requestAnimationFrame(update),!0},window.keysDown={left:!1,right:!1,up:!1,down:!1,fire:!1},window.paused=!1,window.keyToggled=function(t,i){if(32===t&&(window.keysDown.fire=i),38!==t&&90!==t&&87!==t||(window.keysDown.up=i),39!==t&&68!==t||(window.keysDown.right=i),40!==t&&83!==t||(window.keysDown.down=i),37!==t&&65!==t&&81!==t||(window.keysDown.left=i),66===t)return window.paused=i},window.onkeydown=function(t){return keyToggled(t.keyCode,!0)},window.onkeyup=function(t){return keyToggled(t.keyCode,!1)},window.Game=o,window.Screen=u,window.Typer=w,window.Colours=i,window.Sprite=m}).call(this);