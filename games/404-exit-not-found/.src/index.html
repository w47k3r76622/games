<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><script>zzfx=(...z)=>zzfxP(zzfxG(...z)),zzfxP=(...z)=>{let t=zzfxX.createBufferSource(),f=zzfxX.createBuffer(z.length,z[0].length,zzfxR);return z.map((z,t)=>f.getChannelData(t).set(z)),t.buffer=f,t.connect(zzfxX.destination),t.start(),t},zzfxG=(z=1,t=.05,f=220,a=0,x=0,e=.1,n=0,h=1,M=0,r=0,R=0,i=0,o=0,s=0,u=0,c=0,d=0,l=1,b=0,m=0)=>{let P,X,g=2*Math.PI,C=M*=500*g/zzfxR**2,p=(0<u?1:-1)*g/4,w=f*=(1+2*t*Math.random()-t)*g/zzfxR,A=[],B=0,G=0,I=0,V=1,k=0,D=0,S=0;for(a=99+zzfxR*a,b*=zzfxR,x*=zzfxR,e*=zzfxR,d*=zzfxR,r*=500*g/zzfxR**3,u*=g/zzfxR,R*=g/zzfxR,i*=zzfxR,o=zzfxR*o|0,X=a+b+x+e+d|0;I<X;A[I++]=S)++D%(100*c|0)||(S=n?1<n?2<n?3<n?Math.sin((B%g)**3):Math.max(Math.min(Math.tan(B),1),-1):1-(2*B/g%2+2)%2:1-4*Math.abs(Math.round(B/g)-B/g):Math.sin(B),S=(o?1-m+m*Math.sin(2*Math.PI*I/o):1)*(0<S?1:-1)*Math.abs(S)**h*z*zzfxV*(I<a?I/a:I<a+b?1-(I-a)/b*(1-l):I<a+b+x?l:I<X-d?(X-I-d)/e*l:0),S=d?S/2+(d>I?0:(I<X-d?1:(X-I)/d)*A[I-d|0]/2):S),P=(f+=M+=r)*Math.sin(G*u-p),B+=P-P*s*(1-1e9*(Math.sin(I)+1)%2),G+=P-P*s*(1-1e9*(Math.sin(I)**2+1)%2),V&&++V>i&&(f+=R,w+=R,V=0),!o||++k%o||(f=w,M=C,V=V||1);return A},zzfxV=.3,zzfxR=44100,zzfxX=new AudioContext;</script><title>Exit Not Found</title><style>.font-regular{font-weight:400;font-style:normal;}.font-bold{font-weight:700;font-style:normal;}body{background-color:black;}*{margin:0;box-sizing:border-box;font-family:monospace;}.container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100vw;overflow-x:hidden;height:100vh;z-index:500;padding:0 50px;display:flex;justify-content:space-between;align-items:center;transition:0.3s ease-out opacity;}.p-turn{animation:pGlow 1.5s linear infinite both alternate;}@keyframes pGlow{from{box-shadow:0 0 25px 10px #16c551;}to{box-shadow:0 0 50px 5px #16c551;}}.e-turn{animation:eGlow 1.5s linear infinite both alternate;}@keyframes eGlow{from{box-shadow:0 0 25px 10px #a70707;}to{box-shadow:0 0 50px 5px #a70707;}}.n-turn{animation:nGlow 1.5s linear infinite both alternate;}@keyframes nGlow{from{box-shadow:0 0 25px 10px #0787A7;}to{box-shadow:0 0 50px 5px #0787A7;}}canvas{width:33vw;min-width:480px;min-height:480px;max-height:90vh;margin:10px auto;background-color:#2b2b2b;position:relative;}canvas::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;}.enemy-item, .player-item{margin:0.4vw 0.4vw 0.8vw;}.enemy-item p, .player-item{margin:0.16vw 0 0.16vw 0.8vw;}.attack-btn, .block-btn{width:5.1vw;height:3vw;}.attack-btn{background-color:#a70707;} .block-btn{background-color:#0787A7;}.toggle-game{margin-top:25px;font-size:50px;}.invisible{visibility:hidden;opacity:0;transition:opacity .2s ease-out;}.headline{text-align:center;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}.headline h1{font-size:75px;color:wheat;position:relative;display:inline-block;height:85px;width:200px;}.headline h2{margin-top:80px;font-size:50px;color:firebrick;}.headline h3{margin-top:25px;font-size:38px;color:white;}h1 span{position:absolute;animation:upAndDown 1s ease-in-out infinite both alternate;}h1 span:first-child{left:0;}h1 span:nth-child(2){left:37.5%;animation-delay:-0.3s;}h1 span:last-child{right:0;animation-delay:-0.6s;}.level-up{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);background-color:#fff;z-index:1000;width:400px;text-align:center;text-transform:capitalize;padding:25px 15px;}.level-up div{display:flex;justify-content:space-around;flex-wrap:wrap;padding-top:20px;}.level-up button{width:40%;text-align:center;list-style:none;font-family:inherit;font-size:56px;padding:5px;margin:10px;border:none;cursor:pointer;}.level-up h5{font-size:27px;}.level-up h6{font-size:21px;}.player-create-wrapper{width:800px;margin:0 auto;}.create-name-wrapper,.create-class-wrapper{color:#fff;font-size:24px;margin-top:20px;margin-bottom:60px;text-align:center;}#createName{outline:none;color:#08fa25;}#blink{display:inline-block;width:12px;height:20px;margin-left:-12px;vertical-align:bottom;background-color:chartreuse;animation:blink 0.5s linear infinite both alternate;pointer-events:none;}.create-class-wrapper label{margin:4px 8px;padding:10px;}input[type="radio"]{display:none;}label[for="meleeClass"]{background-color:rgba(245, 79, 79, 0.45);}label[for="magicClass"]{background-color:rgba(51, 51, 216, 0.45);}label[for="rangedClass"]{background-color:rgba(17, 194, 17, 0.45);}input[id="meleeClass"]:checked + label{background-color:rgba(245, 79, 79, 1);}input[id="magicClass"]:checked + label{background-color:rgba(51, 51, 216, 1);}input[id="rangedClass"]:checked + label{background-color:rgba(17, 194, 17, 1);}#cursorModal{position:fixed;top:0; left:0;transition:opacity .4s ease-out;min-width:100px;min-height:100px;background-color:rgba(0, 0, 0, 0.555);z-index:5000;cursor:pointer;}.enemy-item, .player-item{display:flex;flex-wrap:wrap;padding:10px;justify-content:space-between;color:#fff}.enemy-item h4, .player-item h4{font-size:21px;flex:1 1 100%;margin-top:5px;}.enemy-item .attack-btn, .player-item .block-btn{width:40%;align-self:flex-end;}.enemy-item-stats, .player-item-stats{width:50%;min-width:150px;font-size:16px;}@keyframes blink{from{opacity:0.1;}40%{opacity:0.1;}75%{opacity:1;}to{opacity:1;}}@keyframes upAndDown{from{transform:translateY(0);}to{transform:translateY(75%);}}.chat-box{position:relative; width:100%; height:100%; background-color:transparent;overflow:hidden scroll; padding:20px;}.chat-box-container{position:relative;border:4px solid #0787A7;height:80vh;width:33.3vw;}.chat-message-group{min-height:100%;width:100%;display:flex; flex-direction:column; justify-content:flex-end;position:relative;bottom:0;left:0;}.chat-box-container::before{content:'';pointer-events:none;position:absolute;z-index:1;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(to bottom, rgba(0, 0, 0, 0.82) 10%, transparent 35%);}.chat-box-title{position:absolute;z-index:6000;top:0;left:50%;transform:translate(-50%,0);color:#0787A7;text-align:center;width:100%;margin-top:15px;} .box{position:relative; width:100%; padding:5px 15px 10px; display:flex; flex-direction:column;font-size:18px;} .message-box{ padding:15px 35px 25px 25px; margin:0; width:66%; position:relative;} .box-enemy,.box-narrator{ align-items:flex-start;animation:fadeInLeft .8s ease-out;} .box-enemy .message-box{ background-color:#a70707;} .box-enemy .author{ color:#a70707;} .box-player{ align-items:flex-end;animation:fadeInRight .8s ease-out;} .box-player .message-box{ background-color:#16c551;}.box-narrator .message-box{background-color:#3948d4;}.box-narrator .author{color:#3948d4;} .message-box svg{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;}.message-box svg rect{width:100%;height:100%;} .box-player .author{ color:#16c551;} .help{ position:absolute; bottom:-35px; left:50%; transform:translateX(-50%);} .help label{ color:#fff;}#playAgain{position:absolute;top:50%;left:50%;z-index:6000;transform:translate(-50%,-50%);display:flex;flex-direction:column;width:250px;height:auto;background-color:black;transition:opacity .8s ease-out;}#playAgain button{text-transform:uppercase;padding:10px 5px;margin:7.5px;font-size:21px;cursor:pointer;}.play-again-btn{background-color:black;color:white;}.new-character-btn{background-color:white;color:black;}@keyframes fadeInRight{from{transform:translateX(120%);opacity:0;height:0%;}to{transform:translateX(0);opacity:1;height:100%;}}@keyframes fadeInLeft{from{transform:translateX(-120%);opacity:0;height:0%;}to{transform:translateX(0);opacity:1;height:100%;}}@media screen and (min-width:2600px){.box{font-size:23px;}}</style></head><body><div id="playAgain" class="invisible"><button class="play-again-btn">play again?</button><button class="new-character-btn">new character</button></div><div id="cursorModal" class="invisible font-regular"></div><div class="container invisible"><aside class="level-up font-bold invisible"><h5>You Leveled Up!</h5><h6>pick a skill to upgrade</h6><div class="font-regular lvlUp"><button class="lvl-up-btn" id="lvlUpAtk" data-stat="0">üî™</button><button class="lvl-up-btn" id="lvlUpAgil" data-stat="1">üèÉ</button><button class="lvl-up-btn" id="lvlUpDef" data-stat="2">üõ°</button><button class="lvl-up-btn" id="lvlUpActions" data-stat="3">‚åõ</button></div></aside><canvas id="gameBG" width="256" height="256"></canvas><div class="chat-box-container"><h1 class="chat-box-title font-bold">Recent Activities</h1><div class="chat-box"><div class="chat-message-group"></div></div><div class="help"><label for="help">disable help</label><input type="checkbox" name="help" /></div></div></div><div class="headline"><h1 class="font-bold"><span>4</span><span>0</span><span>4</span></h1><h2 class="font-bold">Exit Not Found</h2><h3 class="font-bold">Create Your Player</h3><div class="player-create-wrapper"><div class="create-name-wrapper font-regular">Start Typing To Choose Your Name:<br /><br /><span id="createName">Bob The Destroyer</span><div id="blink"></div></div><div class="create-class-wrapper font-regular">Choose Your Class:<br /><br /><input type="radio"name="class"id="meleeClass"value="0"class="class-radio"checked/><label for="meleeClass">Melee</label><input type="radio"name="class"id="magicClass"value="1"class="class-radio"/><label for="magicClass">Magic</label><input type="radio"name="class"id="rangedClass"value="2"class="class-radio"/><label for="rangedClass">Ranged</label></div></div><button class="toggle-game font-regular">play</button></div><script>const pMove=[zzfxG(...[,.25,195,.03,.01,.24,,1.26,-.4,-1.6,,,,,,.1,,.67,.025]),zzfxG(...[,.25,195,.03,.01,.24,,1.26,-.4,-1.6,,,,,,.1,,.67,.025]),zzfxG(...[,.25,195,.03,.01,.24,,1.26,-.4,-1.6,,,,,,.1,,.67,.025]),zzfxG(...[,.25,195,.03,.01,.24,,1.26,-.4,-1.6,,,,,,.1,,.67,.025])],eMove=[zzfxG(...[,.5,30,.03,.01,.07,2,.1,1,20,130,.1,.01,,5,.1,.03,.8,.03,1]),zzfxG(...[,.5,30,.03,.01,.07,2,.1,1,20,130,.1,.01,,5,.1,.03,.8,.03,1]),zzfxG(...[,.5,30,.03,.01,.07,2,.1,1,20,130,.1,.01,,5,.1,.03,.8,.03,1]),zzfxG(...[,.5,30,.03,.01,.07,2,.1,1,20,130,.1,.01,,5,.1,.03,.8,.03,1])],levelUpSound=[zzfxG(...[,.25,406,.04,.34,.52,1,.73,-.4,,-361,.01,.09,.2,,,,.7,.07,.12]),zzfxG(...[,.25,406,.04,.34,.52,1,.73,-.4,,-361,.01,.09,.2,,,,.7,.07,.12]),zzfxG(...[,.25,406,.04,.34,.52,1,.73,-.4,,-361,.01,.09,.2,,,,.7,.07,.12]),zzfxG(...[,.25,406,.04,.34,.52,1,.73,-.4,,-361,.01,.09,.2,,,,.7,.07,.12])],passDungeonSound=[zzfxG(...[.7,.5,694,.15,.02,.43,2,1.26,6.9,,-15,.1,.15,,,,,.38,.01]),zzfxG(...[.7,.5,694,.15,.02,.43,2,1.26,6.9,,-15,.1,.15,,,,,.38,.01]),zzfxG(...[.7,.5,694,.15,.02,.43,2,1.26,6.9,,-15,.1,.15,,,,,.38,.01]),zzfxG(...[.7,.5,694,.15,.02,.43,2,1.26,6.9,,-15,.1,.15,,,,,.38,.01])],playerAttackSounds=[[zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22]),zzfxG(...[,.5,755,,.08,.15,2,.75,,,,,,1.3,,.1,,.73,.1,.22])],[zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04]),zzfxG(...[,.25,371,.1,,.28,1,1.4,.8,,,,,3.4,,.1,,.99,.04])],[zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14]),zzfxG(...[,.5,321,.02,,.3,3,1.23,-.5,.9,,,,,,.1,.09,.7,.08,.14])]],enemyAttackSounds=[[zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2])],[zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19]),zzfxG(...[,.75,175,.02,.19,1.33,,.65,,,,,,.3,,.9,,.97,.06,.19])],[zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2]),zzfxG(...[,.15,190,.12,.03,.42,3,1.02,,-.9,,,,,5.6,.1,,.5,.1,.2])]],messageSound={player:[zzfxG(...[,.25,500,.05,,.01,,.8,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,500,.05,,.01,,.8,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,500,.05,,.01,,.8,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,500,.05,,.01,,.8,-48,-.3,,,,,,,,,.01])],enemy:[zzfxG(...[,.25,1e3,.05,,.01,,.88,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,1e3,.05,,.01,,.88,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,1e3,.05,,.01,,.88,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,1e3,.05,,.01,,.88,-48,-.3,,,,,,,,,.01])],narrator:[zzfxG(...[,.25,750,.05,,.01,,.88,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,750,.05,,.01,,.88,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,750,.05,,.01,,.88,-48,-.3,,,,,,,,,.01]),zzfxG(...[,.25,750,.05,,.01,,.88,-48,-.3,,,,,,,,,.01])]},missedSound=[zzfxG(...[,,41,.05,,0,,2.3,-10,,,,,,,.1,.04,.76,.15]),zzfxG(...[,,41,.05,,0,,2.3,-10,,,,,,,.1,.04,.76,.15]),zzfxG(...[,,41,.05,,0,,2.3,-10,,,,,,,.1,.04,.76,.15]),zzfxG(...[,,41,.05,,0,,2.3,-10,,,,,,,.1,.04,.76,.15])],blockSound=[zzfxG(...[,,156,,,.12,1,1.84,,,,,,1.3,-.5,.2,.13,.53]),zzfxG(...[,,156,,,.12,1,1.84,,,,,,1.3,-.5,.2,.13,.53]),zzfxG(...[,,156,,,.12,1,1.84,,,,,,1.3,-.5,.2,.13,.53]),zzfxG(...[,,156,,,.12,1,1.84,,,,,,1.3,-.5,.2,.13,.53])],gameOverSound=[zzfxG(...[,,352,.01,.15,1.81,,1.91,,.8,,,,.5,-.6,.7,.34,.64,.05]),zzfxG(...[,,352,.01,.15,1.81,,1.91,,.8,,,,.5,-.6,.7,.34,.64,.05])];

const rng=(a=4)=>Math.floor(Math.random()*a),colors={player:"#fff",inSight:{walkable:"transparent",unwalkable:"#000",enemy:"#940404"},unseenOrUnwalkable:"#000",outOfSight:"#00000066",fovHighlight:"#3370d422",walkHighlight:"#08fa2555"},narrator={start:[a=>`${a} has entered the dungeon...`,a=>`but will ${a} find the exit?`,"...what was that voice?  Is someone there?",`Use the WASD keys to move your character. Hint: It's the White box ;)`,"ok....thanks?","**whoever you are**","the green squares are where you can move to on your turn",`you can also hover yourself and check your stats`,`you'll also notice a block button...that will use all the actions you have left and convert half of it to defense`,"use it wisely"],fog:["Tiles you have not explored yet are completely hidden by the fog of war.","Tiles you've discovered will stay visible until they are out of your field of view (FOV).","You'll remember the dungeon layout, but you'll no longer be able to see 'activity'","So watch out!","There could be vampires","WHO ARE YOU?!"],enemy:["That....is an enemy","If you want to check out it's stats or attack just look at it!","....or hover your mouse over it for those that don't have extra sensory abilities","....whelp.  Guess the \"jokes\" are just gonna keep coming"],taunting:[`you're going the wrong way`,`you sure the exit is over there?`,`you're never leaving....muahahahaha`,`no don't go that way!!`,`good luck....`,`you sure you want to go that way?`,`don't leave me...ha you can't!`,`trust me....this is NOT a dream`,`I will always be here for you...whether or not you like it`,`I'm in your head and I'm not leaving....just like you aren't leaving here!`],gameOver:[a=>`....looks like ${a} was not able to find the exit`,a=>`didn't think ${a} would`,"well at least the jokes can stop now"],aoo:[a=>`${a}....here's the deal`,`.....`,`you can try to run if you want`,`but if the enemy has seen you and you've seen them...`,`all you're doing by running is giving them a free shot at you`,`and if they hit you...your turn is OVER!`,`so you're better off sticking around for the fight...`,"if you can hack it",`you can have this one for free....next one won't be`]},_createNameInput=document.querySelector("#createName"),game=document.querySelector("#gameBG"),ctx=game.getContext("2d"),body=document.querySelector("body"),_btnStart=document.querySelector(".toggle-game"),_btnReset=document.querySelector(".reset"),_container=document.querySelector(".container"),_landing=document.querySelector(".headline"),_cursorModal=document.querySelector("#cursorModal"),_help=document.querySelector(".help"),_lvlUpAtk=document.querySelector("#lvlUpAtk"),_lvlUpDef=document.querySelector("#lvlUpDef"),_lvlUpAgil=document.querySelector("#lvlUpAgil"),_lvlUpActions=document.querySelector("#lvlUpActions"),_lvlUp=document.querySelector(".level-up"),_enemyDetails=document.querySelector(".enemy-details"),_chatBox=document.querySelector(".chat-box"),_chatMessageGroup=document.querySelector(".chat-message-group"),_playAgain=document.querySelector("#playAgain"),_newGameBtn=document.querySelector(".play-again-btn"),_newCharacterBtn=document.querySelector(".new-character-btn"),NUMBER_OF_ROWS=16,NUMBER_OF_COLUMNS=16,CHECKER_INT=Math.pow(NUMBER_OF_COLUMNS-2,2)+2,CANVAS_HEIGHT=NUMBER_OF_COLUMNS*NUMBER_OF_COLUMNS,CANVAS_WIDTH=NUMBER_OF_ROWS*NUMBER_OF_ROWS,ROWS=Array(NUMBER_OF_ROWS).fill(),COLUMNS=Array(NUMBER_OF_COLUMNS).fill(),TILE_HEIGHT=CANVAS_HEIGHT/NUMBER_OF_ROWS,TILE_WIDTH=CANVAS_WIDTH/NUMBER_OF_ROWS,WALKABLE_TILE_CHANCE=.8,xyMax=TILE_HEIGHT*TILE_HEIGHT-TILE_HEIGHT,COORDINATES={},WALKABLE_COORDINATES=[];let player,handleKeyPress,enemyCount,steps=0,dungeon=1,dungeonEXP=20+10*dungeon,lvl=1,playerCoord=[],enemies=[],totalEnemyPower=100;const enemyPowerMult=()=>0;let moveTimer,exit;const start=[];let firstEnemySpotted,startedTyping,walkableTiles=0,enemyIndex=0,firstAOO=1,helpDisabled=0;_help.addEventListener("change",()=>helpDisabled=!helpDisabled);

const asyncForEach=async(a,b)=>{for(let c=0;c<a.length;c++){if(1>player.hp)return;await b(a[c],c,a)}},inverseCoords=([a,b])=>a?b?a==xyMax?[0,b]:[a,0]:[a,xyMax]:[xyMax,b],roundUp=a=>{const b=a.toString().split(".")[1];return b?5<=parseInt(b.split("")[0])?Math.round(a):a:a},checker=([a,b])=>{const c={...COORDINATES},d=[[a,b]];for(let e=0;100>e;e++){for(let e=0;e<d.length;e++){const[f,g]=d[e],h=[[f,g-TILE_HEIGHT],[f+TILE_HEIGHT,g],[f,g+TILE_HEIGHT],[f-TILE_HEIGHT,g]];for(let e=0;e<h.length;e++){const[f,g]=h[e];if(c[f]?.[g]?.walkable)if(c[f][g].checked||f==a&&g==b)continue;else{if(c[f][g].exit)return 1;c[f][g].checked=1,d.push(h[e])}}}if(2>d.length)return}},startGame=(a,b)=>{window.removeEventListener("keydown",typeName),window.removeEventListener("keypress",handleKeyPress);const c=document.querySelector("input[name=\"class\"]:checked");_landing.classList.add("invisible"),_btnStart.classList.add("invisible"),_container.classList.remove("invisible"),game.classList.add("p-turn"),player=new Character(_createNameInput.textContent,parseInt(c.value)),b||(player=new Character(_createNameInput.textContent,parseInt(c.value))),game.classList.remove("p-turn"),game.classList.remove("e-turn"),game.classList.add("n-turn"),helpDisabled||(player.awaitingUser=!0,asyncForEach(narrator.start,(a,b,c)=>new Promise(d=>0==b?void(createChatMessage("narrator","narrator",a(player.name)),d()):setTimeout(()=>{createChatMessage(4!=b&&5!=b?"narrator":"player",4!=b&&5!=b?"narrator":"player",1==b?a(player.name):a),b==c.length-1&&(player.awaitingUser=!1,game.classList.remove("n-turn"),game.classList.add("p-turn")),d()},rng(750)+1500)))),buildDungeon([0,160])},inRange=([a,b],[c,d],e)=>{const f=Math.abs(a-c)/TILE_HEIGHT,g=Math.abs(b-d)/TILE_HEIGHT;return~~Math.sqrt(f*f+g*g)<=e},getCenterOfCoords=a=>[a.coords[0]+TILE_WIDTH/2,a.coords[1]+TILE_WIDTH/2],generatePlayer=async(a,b,c)=>{for(handleKeyPress=a=>handlePlayerMovement(a,b,c),playerCoord=a,player.coords=a;player.awaitingUser;){const a=await checkIfWaiting()}window.addEventListener("keypress",handleKeyPress)},generateEnemies=(a,b,c)=>{enemies=[],enemyCount=rng(a/2+2);for(let d=0;d<enemyCount;d++){const a=new Enemy(getEnemyStartCoordinate(b,c),~~(totalEnemyPower/enemyCount));enemies.push(a);const{coords:[d,e]}=a;COORDINATES[d][e].occupied=1}player.checkFOV(),paintCanvas(),player.hiliteMoveArea()},getEnemyStartCoordinate=(a,b)=>{const c=rng(NUMBER_OF_ROWS)*TILE_HEIGHT,d=rng(NUMBER_OF_ROWS)*TILE_HEIGHT;return 0!=c&&0!=d&&c!=a&&d!=a&&b[c]?.[d]?.walkable&&!b[c]?.[d]?.occupied?[c,d]:getEnemyStartCoordinate(a,b)},handlePlayerMovement=async(a,b,c)=>{if("KeyW"!=a.code&&"KeyD"!=a.code&&"KeyS"!=a.code&&"KeyA"!=a.code)return;zzfxP(pMove[rng(pMove.length-1)]);let{key:d}=a;d=d.toLowerCase();let[e,f]=playerCoord;const[g,h]={w:[e,f-c],d:[e+c,f],s:[e,f+c],a:[e-c,f]}[d];if(g==exit[0]&&h==exit[1])return(await tryAOO())?enemyTurn():(game.classList.remove("e-turn"),game.classList.add("p-turn"),clearTimeout(moveTimer),window.removeEventListener("keypress",handleKeyPress),player.xp+=lvl,lvl++,enemyPowerMult(),0==lvl%10&&(player.xp+=100),player.checkIfNextLvl(),zzfxP(passDungeonSound[rng(passDungeonSound.length-1)]),player.resetActions(),createChatMessage("narrator","narrator",`${player.name} has reached level ${lvl} in ${steps} steps!`),buildDungeon(exit));if(b[g]?.[h]?.walkable&&!b[g]?.[h]?.occupied){if(player.awaitingUser=1,await tryAOO())return enemyTurn();for(;player.awaitingUser;){const a=await checkIfWaiting()}if(enemies.length&&player.actionsLeft--,b[e][f].occupied=0,b[g][h].occupied=1,++steps,0==steps%30&&createChatMessage("narrator","narrator",narrator.taunting[rng(narrator.taunting.length)]),playerCoord=[g,h],player.coords=playerCoord,paintCanvas(),player.hiliteMoveArea(),player.checkFOV(),steps==Math.ceil(player.fov)&&!helpDisabled)for(window.removeEventListener("keypress",handleKeyPress),game.classList.remove("p-turn"),game.classList.add("n-turn"),player.awaitingUser=!0,asyncForEach(narrator.fog,(a,b,c)=>new Promise(d=>0==b?(createChatMessage("narrator","narrator",a),d()):void setTimeout(()=>{b==c.length-1?(createChatMessage("player",player.name,a),game.classList.remove("n-turn"),game.classList.add("p-turn"),player.awaitingUser=!1,d()):(createChatMessage("narrator","narrator",a),d())},rng(750)+2e3)));player.awaitingUser;){const a=await checkIfWaiting();if(a)continue;else window.addEventListener("keypress",handleKeyPress)}if(!firstEnemySpotted&&player.inRange.length&&!helpDisabled)for(window.removeEventListener("keypress",handleKeyPress),game.classList.remove("p-turn"),game.classList.add("n-turn"),player.awaitingUser=!0,asyncForEach(narrator.enemy,(a,b,c)=>new Promise(d=>0==b?(createChatMessage("narrator","narrator",a),d()):void setTimeout(()=>{b==c.length-1?(game.classList.remove("n-turn"),game.classList.add("p-turn"),player.awaitingUser=!1,firstEnemySpotted=1,createChatMessage("player",player.name,a)):createChatMessage("narrator","narrator",a),d()},rng(750)+1500)));player.awaitingUser;){const a=await checkIfWaiting();if(a)continue;else window.addEventListener("keypress",handleKeyPress)}!player.actionsLeft&&enemies.length&&enemyTurn()}},goFullScreen=()=>{body.requestFullscreen?body.requestFullscreen():body.mozRequestFullScreen?body.mozRequestFullScreen():body.webkitRequestFullscreen?body.webkitRequestFullscreen():body.msRequestFullscreen&&body.msRequestFullscreen()},generateRandomEndpoint=([a,b])=>{let c=[];for(let d in COORDINATES)for(let e in COORDINATES[d])COORDINATES[d][e].border&&d!=a&&e!=b&&!COORDINATES[d][e].corner&&c.push([parseInt(d),parseInt(e)]);c=c.filter(([c,d])=>COORDINATES[c][d].quadrant!==COORDINATES[a][b].quadrant);const d=c[~~(Math.random()*c.length)];return d},paintCanvas=()=>{for(let a in COORDINATES)for(let b in COORDINATES[a]){inRange(player.coords,[a,b],player.fov)?(COORDINATES[a][b].hasBeenSeen=1,COORDINATES[a][b].inSight=1):COORDINATES[a][b].inSight=0;let{highlighted:c,occupied:d,walkable:e,hasBeenSeen:f,inSight:g,border:h,exit:i}=COORDINATES[a][b];const j=player.coords[0]==a&&player.coords[1]==b;ctx.clearRect(a,b,TILE_HEIGHT,TILE_HEIGHT),c&&(COORDINATES[a][b].highlighted=0),g?e?d?ctx.fillStyle=colors.inSight.enemy:e&&(i?ctx.fillStyle=getExitGradient(a,b):f?ctx.fillStyle=colors.inSight.walkable:ctx.fillStyle=colors.unseenOrUnwalkable):ctx.fillStyle=colors.unseenOrUnwalkable:f?e?ctx.fillStyle=colors.outOfSight:ctx.fillStyle=colors.unseenOrUnwalkable:ctx.fillStyle=colors.unseenOrUnwalkable,h&&!i&&(ctx.fillStyle=colors.unseenOrUnwalkable),j&&(ctx.fillStyle=colors.player),ctx.fillRect(a,b,TILE_HEIGHT,TILE_HEIGHT)}},enemyTurn=()=>{const a=["you ready?","it's my turn now!","I'm gonna get ya..."];window.removeEventListener("keypress",handleKeyPress),game.classList.remove("p-turn"),game.classList.remove("n-turn"),game.classList.add("e-turn"),moveTimer=setTimeout(()=>asyncForEach(enemies,(b,c)=>{const[d,e]=b.coords;return player.inRange.some(({coords:[a,b]})=>a==d&&b==e)&&createChatMessage("enemy",`#${c} - ${b.name}`,a[rng(a.length)]),b.block=0,new Promise(async a=>{for(;0<b.speedLeft;)await new Promise(a=>b.handleTurn(a,c));c==enemies.length-1&&setTimeout(()=>{window.addEventListener("keypress",handleKeyPress),game.classList.remove("e-turn"),game.classList.add("p-turn"),player.resetActions(),player.hiliteMoveArea()},300),setTimeout(()=>{b.resetActions(),a()},2e3)})}),500)},checkIfWaiting=()=>new Promise(a=>setTimeout(()=>player.awaitingUser?a(!0):a(!1),500)),getExitGradient=(a,b)=>{let c;return 0==a?c=ctx.createLinearGradient(-20,0,20,0):a==xyMax?c=ctx.createLinearGradient(240,0,260,0):0==b?c=ctx.createLinearGradient(0,-20,0,20):b==xyMax&&(c=ctx.createLinearGradient(0,240,0,260)),0==a||0==b?(c.addColorStop(.2,"black"),c.addColorStop(1,"yellow")):(c.addColorStop(1,"black"),c.addColorStop(0,"yellow")),c},gameOver=()=>{enemies=[];const a=setTimeout(()=>0,0);zzfxP(gameOverSound[rng(gameOverSound.length-1)]);for(let b=0;b<a;b++)clearTimeout(b);const b=[];for(let a in COORDINATES)for(let c in COORDINATES[a])!COORDINATES[a][c].border&&COORDINATES[a][c].hasBeenSeen&&b.push([a,c]);const c=setInterval(()=>{const a=rng(b.length),[d,e]=b[a];b.splice(a,1),ctx.fillStyle="black",ctx.fillRect(d,e,TILE_HEIGHT,TILE_HEIGHT),b.length<.2*CANVAS_HEIGHT&&_playAgain.classList.remove("invisible"),b.length||(ctx.fillRect(0,0,CANVAS_HEIGHT,CANVAS_HEIGHT),clearInterval(c))},500/TILE_HEIGHT);window.removeEventListener("keypress",handleKeyPress),asyncForEach(narrator.gameOver,(a,b,c)=>new Promise(d=>setTimeout(()=>b==c.length-1?void setTimeout(()=>d(),5e3):(createChatMessage("narrator","narrator",a(player.name)),d()),rng(1e3)+2e3)))},setAttributes=(a,b)=>{for(let c in b)a.setAttribute(c,b[c])},createChatMessage=(a,b,c)=>{"player"===a?zzfxP(messageSound.player[rng(messageSound.player.length-1)]):"enemy"===a?zzfxP(messageSound.enemy[rng(messageSound.enemy.length-1)]):"narrator"==a&&zzfxP(messageSound.narrator[rng(messageSound.narrator.length-1)]);const d=document.createElement("div");d.classList.add(`box`,`box-${a}`);const e=document.createElement("p");e.classList.add(`message-box`,`font-regular`),e.innerHTML=generateChatBorder()+c;const f=document.createElement("p");f.classList.add("author"),f.innerText=b,d.append(e,f),_chatMessageGroup.append(d),_chatBox.scrollTo(0,_chatBox.scrollHeight)},generateChatBorder=()=>`<svg width="100%" height="100%"><rect width='100%' height='100%' fill='none' stroke='black' stroke-width='7' stroke-dasharray=${rng(41)+40},${rng(31)+30},${rng(11)+20} stroke-dashoffset='84' stroke-linecap='square' /></svg>`,attackOfOpp=async(a,b)=>{const c=["going somewhere?  take this with you!","think you can just run do ya??",`You can run, ${player.name}....but you can't hide`];let d;if(!inRange(a.coords,player.coords,a.fov))return new Promise(a=>a());return inRange(a.coords,player.coords,a.fov)?new Promise(e=>setTimeout(()=>0==player.actionsLeft?e():void(createChatMessage("enemy",`${a.name}`,c[rng(c.length)]),firstAOO=0,setTimeout(()=>{a.atkChar(()=>1,b,a=>d=a),player.awaitingUser=0,d?(player.actionsLeft=0,setTimeout(()=>{paintCanvas(),e(1)},2e3)):e()},1e3)),500)):void 0},tryAOO=async()=>{if(enemies.some(a=>inRange(a.coords,player.coords,a.fov)&&a.playerSpotted&&a.hasBeenSpotted)){if(window.removeEventListener("keypress",handleKeyPress),firstAOO&&!helpDisabled)return void asyncForEach(narrator.aoo,(a,b,c)=>new Promise(d=>setTimeout(()=>{0==b?createChatMessage("narrator","narrator",a(player.name)):1==b?createChatMessage("player",player.name,a):(createChatMessage("narrator","narrator",a),b==c.length-1&&setTimeout(()=>{player.awaitingUser=0,firstAOO=0,window.addEventListener("keypress",handleKeyPress),d()},2e3)),b!=c.length-1&&d()},0==b?1:rng(1e3)+1500)));let a;for(let b=0;b<enemies.length;b++)(await attackOfOpp(enemies[b],b,enemies))&&(a=1);return window.addEventListener("keypress",handleKeyPress),a?1:void 0}player.awaitingUser=0};

const weapons=[["Brass knuckles","Fists"],[""],["Pistol","Rifle","Sniper"]],enemyType=["Skeleton \uD83D\uDC80","Vampire \uD83E\uDDDB","Wizard \uD83E\uDDD9","Demon \uD83D\uDC79"],Character=function(a,b){const c=this;c.class=b,c.name=a,c.xp=0,c.nextLvl=100,c.lvl=1,c.hp=b?1==b?50:75:100,c.maxHp=c.hp,c.attackStrength=b&&1!=b?rng(3)+1:rng()+3,c.def=b?1==b?rng(2)+1:rng(3)+1:rng()+2,c.crit={mult:1.5,chance:10},c.agility=b?1==b?rng(2)+1:rng(5)+3:rng()+2,c.actionsPerTurn=b?1==b?rng(2)+3:rng()+4:rng()+4,c.actionsLeft=c.actionsPerTurn,c.attackSpeed=~~(c.attackStrength/2)||1,c.fov=b?rng(3)+2:rng(2)+1,c.fov=Math.ceil(Math.sqrt(c.fov*c.fov+c.fov*c.fov)),c.accuracy=c.class?1==c.class?60+rng(41):75+rng(6):65+rng(26),c.items=[],c.awaitingUser=!1,c.checkIfNextLvl=function(){0>=c.nextLvl-c.xp&&c.lvlUp()},c.lvlUp=function(){c.nextLvl+=c.nextLvl+Math.pow(c.lvl,3),c.lvl++,c.awaitingUser=!0,_lvlUp.classList.remove("invisible"),c.maxHp*=1.1,zzfxP(levelUpSound[rng(levelUpSound.length-1)]),window.removeEventListener("onkeypress",handleKeyPress)},c.weapons=weapons[c.class],c.addStat=function(a){if(0==a){const a=Math.ceil(1.2*c.attackStrength);createChatMessage("player",c.name,`I increased my attack strength by ${a-c.attackStrength}!`),c.attackStrength=a}else if(1==a){const a=Math.ceil(1.1*c.agility);createChatMessage("player",c.name,`I increased my agility by ${a-c.agility}!`),c.agility=a}else if(2==a){const a=Math.ceil(1.15*c.def);createChatMessage("player",c.name,`I increased my defense by ${a-c.def}!`),c.def=a}else if(3==a){const a=Math.ceil(1.1*c.actionsPerTurn);createChatMessage("player",c.name,`I increased my actions per turn by ${a-c.actionsPerTurn}!`),c.actionsPerTurn=a,c.actionsLeft=a}_lvlUp.classList.add("invisible"),c.awaitingUser=!1,window.addEventListener("keypress",handleKeyPress)},c.coords=playerCoord,c.highlighted=0,c.hiliteMoveArea=function(){const a=[c.coords];for(let b=0;b<c.actionsLeft;b++)a.forEach(([b,d])=>{const e=[[b,d-TILE_HEIGHT],[b+TILE_HEIGHT,d],[b,d+TILE_HEIGHT],[b-TILE_HEIGHT,d]];e.filter(([a,b])=>COORDINATES[a]?.[b]?.walkable&&!COORDINATES[a]?.[b]?.occupied&&!COORDINATES[a]?.[b]?.highlighted&&!COORDINATES[a]?.[b]?.exit&&(COORDINATES[a]?.[b]?.hasBeenSeen||inRange([a,b],c.coords,c.fov))).forEach(([b,d])=>{b==c.coords[0]&&d==c.coords[1]||(COORDINATES[b][d].highlighted=1,a.push([b,d]))})});a.forEach(([a,b],c)=>{c&&(ctx.clearRect(a,b,TILE_HEIGHT,TILE_HEIGHT),ctx.fillStyle=colors.walkHighlight,ctx.fillRect(a,b,TILE_HEIGHT,TILE_HEIGHT))})},c.attackEnemy=async function(a){const b=["I'm tired....","Can I take a moment rest first?","If you want me to do something...I need more actions!"];if(c.attackSpeed>c.actionsLeft)return b[rng(b.length)];const d=c.accuracy-a.agility>=rng(100)&&c.attackStrength>a.def+a.block;c.actionsLeft-=c.attackSpeed;const e=rng(100)<=c.crit.chance?Math.ceil(c.crit.mult*c.attackStrength):c.attackStrength;if(d?(a.hp-=e-a.def-a.block,zzfxP(playerAttackSounds[player.class][rng(playerAttackSounds[player.class].length-1)])):e<=a.block+a.def?zzfxP(blockSound[rng(blockSound.length-1)]):zzfxP(missedSound[rng(missedSound.length-1)]),1>a.hp){const[b,d]=a.coords;COORDINATES[b][d].occupied=0,enemies.splice(enemyIndex,1),c.xp+=a.xp,_cursorModal.classList.add("invisible"),enemies.length||(c.actionsLeft=c.actionsPerTurn),c.checkIfNextLvl()}if(showHoveredDetails(a),0==c.actionsLeft){for(;c.awaitingUser;){const a=await checkIfWaiting()}enemyTurn(exit)}return paintCanvas(),c.hiliteMoveArea(),e<=a.block+a.def?`${a.name} blocked your attack!`:d&&1>a.hp?`I defeated the ${a.name} by dealing ${e-a.def-a.block} damage!`:d?`I hit the ${a.name} for ${e-a.def-a.block}!`:`I missed the ${a.name}!`},c.inRange=[],c.checkFOV=function(){c.inRange=[],enemies.forEach(a=>{inRange(c.coords,a.coords,c.fov)&&(a.hasBeenSpotted=1,c.inRange.push(a))})},c.block=0,c.resetActions=function(){c.actionsLeft=c.actionsPerTurn,c.block=0},c.defStance=async function(){if(enemies.length){for(c.block=~~(c.actionsLeft/2),c.actionsLeft=0;c.awaitingUser;){const a=await checkIfWaiting()}return paintCanvas(),enemyTurn()}}},Enemy=function(a,b){const c=this,d=rng(100);c.coords=a,c.class=60>d?0:85>d?2:1,c.name=enemyType[rng(3)],c.hp=Math.floor(Math.sqrt(b))+~~(b/10),c.agility=c.class?1==c.class?rng(2)+1:rng(5)+3:rng()+2,c.attackStrength=c.class&&1!=c.class?~~(b/(rng(11)+20)):Math.ceil(b/(rng(11)+10)),c.attackSpeed=0<~~(c.attackStrength/2)-1?~~(c.attackStrength/2)-1:1,c.accuracy=c.class?1==c.class?60+rng(41):75+rng(6):65+rng(26),c.def=c.class?0:~~(b/(rng(21)+40)),c.fov=c.class?rng()+4:rng(2)+2,c.speed=0==c.class?6:1==c.class?3:4,c.speedLeft=c.speed,c.playerSpotted=0,c.hasBeenSpotted,c.xp=~~(b/5),c.crit={mult:2,chance:60},c.atkChar=function(a,b,d){const[e,f]=c.coords,g=rng(100),h=[`uhhhhh....why am I bleeding?!`,`ouch....what was that?`,`is someone there...stop throwing stuff at me!!`,`ok....I can't even see you.`,`oh voice of the cave, please stop hurting me.`],i=c.accuracy-player.agility>=g&&player.def+player.block<c.attackStrength,j=rng(100)<=c.crit.chance?c.attackStrength*c.crit.mult:c.attackStrength;i&&(player.hp-=j-~~player.def-player.block),c.speedLeft-=c.attackSpeed;const k=j-player.block-player.def,l=player.def+player.block>=j?`${player.name} blocked ${c.name}'s attack!`:i&&c.attackStrength!=j?`hehehehehe....get crit'd. you just got hit for ${k}`:i?`just hit you for ${k}!`:`I missed!`;if(i?zzfxP(enemyAttackSounds[c.class][rng(enemyAttackSounds[c.class].length-1)]):player.def+player.block>=c.attackStrength&&c.accuracy-player.agility>=g?zzfxP(blockSound[rng(blockSound.length-1)]):c.accuracy-player.agility<g&&zzfxP(missedSound[rng(missedSound.length-1)]),player.inRange.some(({coords:[a,b]})=>e==a&&f==b)?(d&&i&&d(1),createChatMessage("enemy",`#${b} - ${c.name}`,l)):i&&!inRange([e,f],player.coords,player.fov)&&(d&&i&&d(1),createChatMessage("player",player.name,`${h[rng(h.length)]}  (-${k} hp)`)),a(),1>player.hp)return clearTimeout(moveTimer),gameOver()},c.handleTurn=function(a,b){const[d,e]=c.coords,f=([c,a])=>exit[0]==c&&exit[1]==a,g=c.checkFOV(),h=0<=c.speedLeft-c.attackSpeed;if(g&&h)return setTimeout(()=>c.atkChar(a,b),2e3);if(g&&75>=rng(100))return setTimeout(()=>c.defStance(a,b),1400);const i=[{pos:"top",coord:[d,e-TILE_WIDTH],available:COORDINATES[d]?.[e-TILE_WIDTH]?.walkable,occupied:COORDINATES[d]?.[e-TILE_WIDTH]?.occupied,checkIfExit:f([d,e-TILE_WIDTH])},{pos:"right",coord:[d+TILE_WIDTH,e],available:COORDINATES[d+TILE_WIDTH]?.[e]?.walkable,occupied:COORDINATES[d+TILE_WIDTH]?.[e]?.occupied,checkIfExit:f([d+TILE_WIDTH,e])},{pos:"bottom",coord:[d,e+TILE_WIDTH],available:COORDINATES[d]?.[e+TILE_WIDTH]?.walkable,occupied:COORDINATES[d]?.[e+TILE_WIDTH]?.occupied,checkIfExit:f([d,e+TILE_WIDTH])},{pos:"left",coord:[d-TILE_WIDTH,e],available:COORDINATES[d-TILE_WIDTH]?.[e]?.walkable,occupied:COORDINATES[d]?.[e-TILE_WIDTH]?.occupied,checkIfExit:f([d-TILE_WIDTH,e])}];let j=i.filter(a=>a.available&&!a.checkIfExit&&!a.occupied);if(player.checkFOV(),c.speedLeft--,c.playerSpotted){const[a,b]=[player.coords[0]-d,player.coords[1]-e],c=j.filter(d=>"left"==d.pos?0>a:"right"==d.pos?0<a:"top"==d.pos?0>b:"bottom"==d.pos?0<b:void 0);c.length&&(j=c)}const k=rng(j.length);COORDINATES[d][e].occupied=0,c.coords=0<j.length?j[k].coord:c.coords;const{coords:[l,m]}=c;COORDINATES[l][m].occupied=1,setTimeout(()=>{paintCanvas(),zzfxP(eMove[rng(eMove.length-1)]),a()},300)},c.block=0,c.defStance=function(a,b){const d=[a=>`betcha can't hurt me now ${a}`,a=>`hey ${a}...check out this shield`,a=>`no way you're gonna break this defense ${a}`];c.block=c.speedLeft,c.speedLeft=0,inRange(c.coords,player.coords,player.fov)&&createChatMessage("enemy",`#${b} - ${c.name}`,d[rng(d.length)](player.name)),a()},c.checkFOV=function(){return inRange(c.coords,player.coords,c.fov)?(c.playerSpotted=1,1):void(inRange(c.coords,player.coords,c.fov+c.fov)||(c.playerSpotted=0))},c.resetActions=function(){c.speedLeft=c.speed,c.block=0}};

const buildDungeon=([a,b])=>{walkableTiles=0,ctx.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT),start.length=0;const[c,d]=inverseCoords([a,b]);return start.push(c,d),COLUMNS.forEach((a,b)=>{const e=b;b*=TILE_WIDTH,COORDINATES[b]={},ROWS.forEach((a,f)=>{const g=c==b&&d==f,h=f;f*=TILE_HEIGHT;const i=Math.random(),j=c===b&&d===f;COORDINATES[b][f]={hasBeenSeen:0,inSight:0,quadrant:b>=xyMax/2&&f<=xyMax/2?1:b<=xyMax/2&&f<=xyMax/2?2:b<=xyMax/2&&f>=xyMax/2?3:4,corner:0==b&&0==f?1:0==b&&f==xyMax?1:b==xyMax&&f==xyMax?1:b==xyMax&&0==f?1:0},0==e||0==h||f==xyMax||b==xyMax?(COORDINATES[b][f].walkable=c==b&&d==f?1:0,g?COORDINATES[b][f].start=1:COORDINATES[b][f].border=1):b<xyMax&&f<xyMax?(COORDINATES[b][f].walkable=i<=WALKABLE_TILE_CHANCE||j?1:0,COORDINATES[b][f].walkable?walkableTiles++:COORDINATES[b][f].occupied=1):COORDINATES[b][f].corner&&(COORDINATES[b][f].walkable=0)})}),exit=generateRandomEndpoint([c,d],TILE_HEIGHT),COORDINATES[exit[0]][exit[1]].walkable=1,COORDINATES[exit[0]][exit[1]].exit=1,checker([c,d])?void(generatePlayer([c,d],COORDINATES,TILE_HEIGHT),generateEnemies(lvl,xyMax,COORDINATES),dungeon++):buildDungeon([a,b])};

_btnStart.addEventListener("click",startGame);const handleCanvasHover=a=>{_cursorModal.style.transform=`translate(calc(-25% + ${a.clientX}px),calc(-25% + ${a.clientY}px))`;const{top:b,left:c}=game.getBoundingClientRect(),d=game.width/a.target.clientWidth,e=(a.clientX-c)*d,f=(a.clientY-b)*d,[g]=enemies.filter((a,b)=>{if(checkIfTargetCoord([e,f],a.coords))return enemyIndex=b,1}),h=checkIfTargetCoord([e,f],player.coords);g&&inRange(g.coords,player.coords,player.fov)?(_cursorModal.classList.remove("invisible"),showHoveredDetails(g)):h?(_cursorModal.classList.remove("invisible"),showHoveredDetails(1,1)):(enemyIndex=0,_cursorModal.classList.add("invisible"),_cursorModal.innerHTML="")};game.addEventListener("mousemove",handleCanvasHover);const playerAttack=async()=>{const a=await player.attackEnemy(enemies[enemyIndex]);createChatMessage("player",player.name,a)},showHoveredDetails=(a,b)=>{_cursorModal.innerHTML="";const c=document.querySelector(`${b?"block":"attack"}-btn`),d=document.querySelector(`${b?"block":"attack"}-btn`);c&&c.removeEventListener("click",player.defStance),d&&d.removeEventListener("click",playerAttack);const e=b?{...player}:{...a},f=document.createElement("section");f.classList.add(`${b?"player":"enemy"}-item`);const g=document.createElement("h4");g.innerHTML=`${e.name} - ${e.class?1==e.class?"Magic":"Ranged":"Melee"}`,f.append(g);const h=b?`${e.hp}/${e.maxHp}`:e.hp,i=document.createElement("div");b&&i.append(createParSpanPair("XP:",`${player.xp}/${player.nextLvl}`)),b&&i.append(document.createElement("br")),i.classList.add(`${b?"player":"enemy"}-item-stats`),i.append(createParSpanPair("\u2764 HP: ",h)),i.append(createParSpanPair("\uD83D\uDD2A Attack: ",e.attackStrength)),i.append(createParSpanPair("\uD83D\uDD2A Attack Speed: ",e.attackSpeed)),i.append(createParSpanPair("\uD83D\uDEE1 Defense: ",e.def)),f.append(i);const j=document.createElement("button");j.classList.add(`${b?"block":"attack"}-btn`,"font-bold"),j.innerText=b?"block":"attack",f.append(j),_cursorModal.append(f),j.addEventListener("click",b?player.defStance:playerAttack)},typeName=a=>{startedTyping||(_createNameInput.textContent="",startedTyping=1),20<_createNameInput.textContent.length&&8!=a.keyCode&&46!=a.keyCode?a.preventDefault():a.key.match(/[A-Za-z0-9]/g)&&1==a.key.length?_createNameInput.textContent+=a.key:8==a.keyCode&&(_createNameInput.textContent=_createNameInput.textContent.substr(0,_createNameInput.textContent.length-1))};window.addEventListener("keydown",typeName);const createParSpanPair=(a,b)=>{const c=document.createElement("p"),d=document.createElement("span");return c.innerHTML=a,d.innerHTML=b,c.append(d),c},checkIfTargetCoord=([a,b],[c,d])=>!!(a>=c&&b>=d&&a<c+TILE_WIDTH&&b<d+TILE_WIDTH);_lvlUp.addEventListener("click",a=>a.target.dataset.stat?player.addStat(a.target.dataset.stat):null),_cursorModal.addEventListener("mouseleave",()=>{enemyIndex=0,_cursorModal.classList.add("invisible")}),_newGameBtn.addEventListener("click",()=>{player=new Character(player.name,player.class),_playAgain.classList.add("invisible"),_chatMessageGroup.innerHTML="",startGame(!0)}),_newCharacterBtn.addEventListener("click",()=>location.reload());</script></body></html>