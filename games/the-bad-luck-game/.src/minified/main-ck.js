(function(e,t){"use strict";function n(e){this.element=typeof e=="object"?e:t.getElementById(e);this.moved=!1;this.startX=0;this.startY=0;this.hasTouchEventOccured=!1;this.element.addEventListener("touchstart",this,!1);this.element.addEventListener("mousedown",this,!1)}n.prototype.start=function(e){e.type==="touchstart"&&(this.hasTouchEventOccured=!0);this.moved=!1;this.startX=e.type==="touchstart"?e.touches[0].clientX:e.clientX;this.startY=e.type==="touchstart"?e.touches[0].clientY:e.clientY;this.element.addEventListener("touchmove",this,!1);this.element.addEventListener("touchend",this,!1);this.element.addEventListener("touchcancel",this,!1);this.element.addEventListener("mousemove",this,!1);this.element.addEventListener("mouseup",this,!1)};n.prototype.move=function(e){var t=e.type==="touchmove"?e.touches[0].clientX:e.clientX,n=e.type==="touchmove"?e.touches[0].clientY:e.clientY;if(Math.abs(t-this.startX)>10||Math.abs(n-this.startY)>10)this.moved=!0};n.prototype.end=function(e){var n;if(this.hasTouchEventOccured&&e.type==="mouseup"){e.preventDefault();e.stopPropagation();this.hasTouchEventOccured=!1;return}if(!this.moved){if(typeof CustomEvent!="undefined")n=new CustomEvent("tap",{bubbles:!0,cancelable:!0});else{n=t.createEvent("Event");n.initEvent("tap",!0,!0)}e.target.dispatchEvent(n)}this.element.removeEventListener("touchmove",this,!1);this.element.removeEventListener("touchend",this,!1);this.element.removeEventListener("touchcancel",this,!1);this.element.removeEventListener("mousemove",this,!1);this.element.removeEventListener("mouseup",this,!1)};n.prototype.cancel=function(e){this.moved=!1;this.startX=0;this.startY=0;this.element.removeEventListener("touchmove",this,!1);this.element.removeEventListener("touchend",this,!1);this.element.removeEventListener("touchcancel",this,!1);this.element.removeEventListener("mousemove",this,!1);this.element.removeEventListener("mouseup",this,!1)};n.prototype.handleEvent=function(e){switch(e.type){case"touchstart":this.start(e);break;case"touchmove":this.move(e);break;case"touchend":this.end(e);break;case"touchcancel":this.cancel(e);break;case"mousedown":this.start(e);break;case"mousemove":this.move(e);break;case"mouseup":this.end(e)}};e.Tap=n})(window,document);(function(){"use strict";function e(e){e.parentNode.replaceChild(e.cloneNode(!0),e)}function t(e,n){var r=e.parentNode;return!r||!r.tagName?!1:r.tagName.toLowerCase()==n?r:t(r,n)}function n(e){while(e.hasChildNodes())e.removeChild(e.lastChild)}var r=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),i=/Safari/.test(navigator.userAgent)&&/Apple Computer/.test(navigator.vendor);window.DOMHelper={isChrome:r,isSafari:i,transitionEnd:r||i?"webkitTransitionEnd":"transitionEnd",unbindAllEvents:e,getParentByTagName:t,purgeElement:n}})();(function(){window.CollisionDetector=function(){function t(e){var t=Math.PI/180,n=0,r=(e.width-n)/2,i=(e.height-n)/2,s=-r,o=-i,u=Math.cos(e.rotate*t),a=Math.sin(e.rotate*t),f={x:~~(s*u-o*a+e.x+.5),y:~~(o*u+s*a+e.y+.5)},l={x:~~(r*u-o*a+e.x+.5),y:~~(o*u+r*a+e.y+.5)},c={x:~~(s*u-i*a+e.x+.5),y:~~(i*u+s*a+e.y+.5)},h={x:~~(r*u-i*a+e.x+.5),y:~~(i*u+r*a+e.y+.5)};return{topLeft:f,topRight:l,bottomLeft:c,bottomRight:h}}function n(e){return[{x:e.topRight.x-e.topLeft.x,y:e.topRight.y-e.topLeft.y},{x:e.topRight.x-e.bottomRight.x,y:e.topRight.y-e.bottomRight.y}]}function r(e,t){var n=(t.x*e.x+t.y*e.y)/(e.x*e.x+e.y*e.y);return{x:n*e.x,y:n*e.y}}function i(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function s(e,t,n){var s=r(e,t.topLeft),o=r(e,t.topRight),u=r(e,t.bottomLeft),a=r(e,t.bottomRight),f=[i(s),i(o),i(u),i(a)];f.sort();return{min:f[0],max:f[3]}}function o(e,t){return t.min<=e.max&&t.max>=e.min}function u(e,r){var i=t(e),u=t(r),a=n(i),f=n(u),l=[a[0],a[1],f[0],f[1]],c=l.length;while(c--){var h=s(l[c],i,e),p=s(l[c],u,r);if(!o(h,p))return!1}return!0}var e=[];this.addObject=function(t){e.push(t)};this.removeObject=function(t){var n=e.length;while(n--)t===e[n]&&e.splice(n,1)};this.checkCollisions=function(){var t,n,r,i;t=n=e.length;while(t--){n=t;while(n--){r=e[t];i=e[n];if(u(r,i)){r.collision(i);i.collision(r)}}}}}})();(function(){"use strict";window.EventListenersManager=function(e){function n(){var n,r;for(n in e){if(!e.hasOwnProperty(n))continue;r=e[n];t[r]=[]}}var t={};n();this.trigger=function(e,n){if(t[e]===undefined)throw"Event invalid.";for(var r=0,i=t[e].length;r<i;r++)t[e][r](n)};this.addEventListener=function(e,n){if(t[e]===undefined)throw"Event invalid.";if(typeof n!="function")throw"Event invalid.";t[e].push(n)};this.removeEventListener=function(e,n){if(e&&t[e]===undefined)throw"Event invalid.";if(!e){t=[];return}if(!n)t[e]=[];else for(var r in t[e]){if(!t[e].hasOwnProperty(r))continue;if(t[e][r]===n){t[e].splice(r,1);break}}}}})();(function(){window.Car=function(e){this.x=-100;this.y=-100;this.rotate=0;this.alive=!0;this.appearance=e.appearance;this.width=this.appearance.skin.width;this.height=this.appearance.skin.height;this._t=0;this._velocity=e.velocity;this._board=e.board;this._currentTile=e.board.getTile(e.startTileX,e.startTileY);this._prevTile=this._currentTile;this._endTileX=e.endTileX;this._endTileY=e.endTileY;this._p0={x:0,y:0};this._p1={x:0,y:0};this._p2={x:0,y:0};this._p3={x:0,y:0};this._ax=0;this._ay=0;this._bx=0;this._by=0;this._cx=0;this._cy=0;this._initialDirection="";this._endDirection="";this._listenersMgr=new EventListenersManager(["crash","trip-end"])};window.Car.prototype.on=function(e,t){this._listenersMgr.addEventListener(e,t)};window.Car.prototype._updateDirections=function(){var e=this._currentTile.roadFromNorth(),t=this._currentTile.roadFromSouth(),n=this._currentTile.roadFromEast(),r=this._currentTile.roadFromWest(),i=this._board.getWidth()-1,s=this._board.getHeight()-1;if(this._prevTile===this._currentTile)if(this._currentTile.getX()===0)if(this._currentTile.getY()===0&&!r){this._initialDirection="n";this._endDirection=e}else if(this._currentTile.getY()===s&&!r){this._initialDirection="s";this._endDirection=t}else{this._initialDirection="w";this._endDirection=r}else if(this._currentTile.getX()===i)if(this._currentTile.getY()===0&&!n){this._initialDirection="n";this._endDirection=e}else if(this._currentTile.getY()===s&&!n){this._initialDirection="s";this._endDirection=t}else{this._initialDirection="e";this._endDirection=n}else if(this._currentTile.getY()===0){this._initialDirection="n";this._endDirection=e}else if(this._currentTile.getY()===s){this._initialDirection="s";this._endDirection=t}else{if(e){this._initialDirection="n";this._endDirection=e}else if(t){this._initialDirection="s";this._endDirection=t}else if(r){this._initialDirection="w";this._endDirection=r}else{this._initialDirection="e";this._endDirection=n}this._initialDirection="s";this._endDirection=e||t||r||n}else switch(this._endDirection){case"n":this._initialDirection="s";this._endDirection=t;break;case"s":this._initialDirection="n";this._endDirection=e;break;case"e":this._initialDirection="w";this._endDirection=r;break;case"w":this._initialDirection="e";this._endDirection=n}};window.Car.prototype._updateRoadPoints=function(e){var t=this._currentTile.getX()*e,n=this._currentTile.getY()*e,r=0,i=0;this._currentTile.isStart()&&this._currentTile===this._prevTile&&(r=this.width);this._currentTile.isEnd()&&(i=this.width);switch(this._initialDirection){case"n":if(this._endDirection==="s"){this._p0.x=this._p1.x=this._p2.x=t+e/2;this._p0.y=n-r;this._p1.y=n+e/4;this._p2.y=n+e/4*3;this._p3.y=n+e-1+i;this._p3.x=t+e/2}else if(this._endDirection==="w"){this._p0.x=this._p1.x=t+e/2;this._p2.y=this._p3.y=n+e/2;this._p0.y=n-r;this._p1.y=n+e/2;this._p2.x=t+e/2;this._p3.x=t+i}else if(this._endDirection==="e"){this._p0.x=this._p1.x=t+e/2;this._p2.y=this._p3.y=n+e/2;this._p0.y=n-r;this._p1.y=n+e/2;this._p2.x=t+e/2;this._p3.x=t+e-1-i}break;case"s":if(this._endDirection==="n"){this._p0.x=this._p1.x=this._p2.x=this._p3.x=t+e/2;this._p0.y=n+e-1+r;this._p1.y=n+e/4*3;this._p2.y=n+e/4;this._p3.y=n-i}else if(this._endDirection==="w"){this._p0.x=this._p1.x=t+e/2;this._p2.y=this._p3.y=n+e/2;this._p0.y=n+e-1+r;this._p1.y=n+e/2;this._p2.x=t+e/2;this._p3.x=t+i}else if(this._endDirection==="e"){this._p0.x=this._p1.x=t+e/2;this._p2.y=this._p3.y=n+e/2;this._p0.y=n+e-1+r;this._p1.y=n+e/2;this._p2.x=t+e/2;this._p3.x=t+e-1-i}break;case"e":if(this._endDirection==="w"){this._p0.y=this._p1.y=this._p2.y=this._p3.y=n+e/2;this._p0.x=t+e-1+r;this._p1.x=t+e/4*3;this._p2.x=t+e/4;this._p3.x=t-i}else if(this._endDirection==="n"){this._p0.y=this._p1.y=n+e/2;this._p2.x=this._p3.x=t+e/2;this._p0.x=t+e-1+r;this._p1.x=t+e/2;this._p2.y=n+e/2;this._p3.y=n-i}else if(this._endDirection==="s"){this._p0.y=this._p1.y=n+e/2;this._p2.x=this._p3.x=t+e/2;this._p0.x=t+e-1+r;this._p1.x=t+e/2;this._p2.y=n+e/2;this._p3.y=n+e-1+i}break;case"w":if(this._endDirection==="e"){this._p0.y=this._p1.y=this._p2.y=n+e/2;this._p0.x=t-r;this._p1.x=t+e/4;this._p2.x=t+e/4*3;this._p3.x=t+e-1+i;this._p3.y=n+e/2}else if(this._endDirection==="n"){this._p0.y=this._p1.y=n+e/2;this._p2.x=this._p3.x=t+e/2;this._p0.x=t-r;this._p1.x=t+e/2;this._p2.y=n+e/2;this._p3.y=n-i}else if(this._endDirection==="s"){this._p0.y=this._p1.y=n+e/2;this._p2.x=this._p3.x=t+e/2;this._p0.x=t-r;this._p1.x=t+e/2;this._p2.y=n+e/2;this._p3.y=n+e-1+i}}};window.Car.prototype._updateBezierValues=function(){this._cx=3*(this._p1.x-this._p0.x);this._bx=3*(this._p2.x-this._p1.x)-this._cx;this._ax=this._p3.x-this._p0.x-this._cx-this._bx;this._cy=3*(this._p1.y-this._p0.y);this._by=3*(this._p2.y-this._p1.y)-this._cy;this._ay=this._p3.y-this._p0.y-this._cy-this._by};window.Car.prototype._updateRotation=function(){var e=this._t+.2,t=this._getX(e),n=this._getY(e),r=n-this.y,i=t-this.x;e<=1&&(this.rotate=~~(Math.atan2(r,i)*180/Math.PI+.5))};window.Car.prototype._getX=function(e){return~~(this._ax*e*e*e+this._bx*e*e+this._cx*e+this._p0.x+.5)};window.Car.prototype._getY=function(e){return~~(this._ay*e*e*e+this._by*e*e+this._cy*e+this._p0.y+.5)};window.Car.prototype.collision=function(e){this.alive=!1;this._listenersMgr.trigger("crash",this);!this._prevTile.isStart()&&!this._prevTile.isEnd()&&this._prevTile.unlock();e&&!this._prevTile.isStart()&&!this._prevTile.isEnd()&&this._currentTile.unlock()};window.Car.prototype.drive=function(e){var t,n;if(this._currentTile.isStart()&&this._t===0){this._updateDirections();this._updateRoadPoints(e);this._updateBezierValues()}if(this._t>1){this._t=0;if(this._currentTile.getX()===this._endTileX&&this._currentTile.getY()===this._endTileY){this._listenersMgr.trigger("trip-end",this);return}this._prevTile=this._currentTile;switch(this._endDirection){case"w":t=this._currentTile.getX()-1;n=this._currentTile.getY();if(t>=this._board.getWidth()||t<0||n>=this._board.getHeight()||n<0){this.collision();return}this._currentTile=this._board.getTile(t,n);if(!this._currentTile.roadFromEast()){this.collision();return}break;case"n":t=this._currentTile.getX();n=this._currentTile.getY()-1;if(t>=this._board.getWidth()||t<0||n>=this._board.getHeight()||n<0){this.collision();return}this._currentTile=this._board.getTile(t,n);if(!this._currentTile.roadFromSouth()){this.collision();return}break;case"e":t=this._currentTile.getX()+1;n=this._currentTile.getY();if(t>=this._board.getWidth()||t<0||n>=this._board.getHeight()||n<0){this.collision();return}this._currentTile=this._board.getTile(t,n);if(!this._currentTile.roadFromWest()){this.collision();return}break;case"s":t=this._currentTile.getX();n=this._currentTile.getY()+1;if(t>=this._board.getWidth()||t<0||n>=this._board.getHeight()||n<0){this.collision();return}this._currentTile=this._board.getTile(t,n);if(!this._currentTile.roadFromNorth()){this.collision();return}}this._prevTile.isStart()||this._prevTile.unlock();this._currentTile.isEnd()||this._currentTile.lock();this._updateDirections();this._updateRoadPoints(e);this._updateBezierValues()}this.x=this._getX(this._t);this.y=this._getY(this._t);this._updateRotation();this._t+=this._velocity}})();(function(){"use strict";window.CarApperance=function(){var e,t,n;e=document.createElement("canvas");e.width=50;e.height=30;t=e.getContext("2d");t.fillStyle="#BEBEBE";t.fillRect(0,0,10,5);t.fillRect(40,0,10,5);t.fillRect(0,25,10,5);t.fillRect(40,25,10,5);t.fillStyle="#77B88B";t.rect(0,5,50,20);t.fill();t.lineWidth=1;t.strokeStyle="black";t.stroke();n=document.createElement("img");n.setAttribute("src",e.toDataURL());this.skin=n}})();(function(){"use strict";window.CarManager=function(e){function u(e){var t=s.length;while(t--)e===s[t]&&s.splice(t,1)}function a(t){u(t);e.carLost()}function f(t){u(t);e.carWon()}var t=e.getBoard(),n=t.getStartTiles(),r=t.getEndTiles(),i=[new CarApperance("sedan"),new CarApperance("van")],s=[],o=Math.PI/180;this.addCar=function(e){var e=e||{},o=n[Math.floor(Math.random()*n.length)],u=r[Math.floor(Math.random()*r.length)],l=i[Math.floor(Math.random()*i.length)],c=e.startX!==undefined?e.startX:o.getX(),h=e.startY!==undefined?e.startY:o.getY(),p=e.endX!==undefined?e.endX:u.getX(),d=e.endY!==undefined?e.endY:u.getY(),v=e.velocity!==undefined?e.velocity:.02,m=new Car({startTileX:c,startTileY:h,endTileX:p,endTileY:d,appearance:l,board:t,tileSize:200,velocity:v});m.on("crash",a);m.on("trip-end",f);s.push(m);return m};this.render=function(e){var t=s.length;while(t--){e.save();e.translate(s[t].x,s[t].y);e.rotate(s[t].rotate*o);e.drawImage(s[t].appearance.skin,-(s[t].width/2),-(s[t].height/2),s[t].width,s[t].height);e.restore()}};this.step=function(e){var t=s.length;while(t--)s[t].drive(e)}}})();(function(){"use strict";window.CanvasManager=function(e){function o(){t=e.element;n=154;t.width=e.tilesHorizontal*n;t.height=e.tilesVertical*n;r=t.getContext("2d");i=[]}function u(){if(!s)return;var e=i.length;r.clearRect(0,0,t.width,t.height);while(e)i[--e].render(r,n);window.requestAnimationFrame(u)}var t,n,r,i,s;this.addManager=function(e,t){t===undefined?i.push(e):i.splice(t,0,e)};this.startAnimation=function(){s=!0;u()};this.stopAnimation=function(){s=!1};this.getWidth=function(){return t.width};this.getHeight=function(){return t.height};this.getTileSize=function(){return n};this.destroy=function(){s=!1;t=null;r=null;i=null};o()}})();(function(){"use strict";window.Tile=function(e,t,n){if(n.start&&n.end)throw"Invalid tile.";if(n.swappable&&(n.start||n.end))throw"Invalid tile.";this._x=e;this._y=t;this._roads=n.roads?n.roads:[];this._start=n.start;this._end=n.end;this._swappable=n.swappable;this._locked=n.locked;this._listenersMgr=new EventListenersManager(["rotate","lock","unlock","swap","flag-added","flag-removed"]);this._cars=n.cars;this._flags=[]};Tile.prototype.on=function(e,t){this._listenersMgr.addEventListener(e,t)};Tile.prototype.off=function(e,t){this._listenersMgr.removeEventListener(e,t)};Tile.prototype.getX=function(){return this._x};Tile.prototype.getY=function(){return this._y};Tile.prototype.lock=function(){if(this.isStart()||this.isEnd())throw"Not allowed.";this._locked=!0;this._listenersMgr.trigger("lock")};Tile.prototype.unlock=function(){if(this.isStart()||this.isEnd())throw"Not allowed.";this._locked=!1;this._listenersMgr.trigger("unlock")};Tile.prototype.rotateLeft=function(){if(this.isLocked())throw"Not allowed.";var e=function(e){if(!e)return e;var t={n:"w",s:"e",w:"s",e:"n"};return t[e]};this._roads={n:e(this._roads.e),s:e(this._roads.w),w:e(this._roads.n),e:e(this._roads.s)};this._listenersMgr.trigger("rotate","left")};Tile.prototype.swap=function(e){if(this.isLocked()||!this.isSwappable())throw"Not allowed.";this._roads={n:e.roadFromNorth(),s:e.roadFromSouth(),w:e.roadFromWest(),e:e.roadFromEast()};this._locked=e.isLocked();this._start=e.isStart();this._end=e.isEnd();this._swappable=e.isSwappable();this._listenersMgr.trigger("swap")};Tile.prototype.clone=function(){return new Tile(this.getX(),this.getY(),{roads:this._roads,start:this._start,end:this._end,swappable:this._swappable,locked:this._locked})};Tile.prototype.rotateRight=function(){if(this.isLocked())throw"Not allowed.";var e=function(e){if(!e)return e;var t={n:"e",s:"w",w:"n",e:"s"};return t[e]};this._roads={n:e(this._roads.w),s:e(this._roads.e),w:e(this._roads.s),e:e(this._roads.n)};this._listenersMgr.trigger("rotate","right")};Tile.prototype.addFlag=function(e){if(this.hasFlag(e))throw"Not allowed.";this._flags.push(e);this._listenersMgr.trigger("flag-added",e)};Tile.prototype.removeFlag=function(e){if(!this.hasFlag(e))throw"Not allowed.";this._flags.splice(this._flags.indexOf(e),1);this._listenersMgr.trigger("flag-removed",e)};Tile.prototype.hasFlag=function(e){return this._flags.indexOf(e)!==-1};Tile.prototype.getFlags=function(){return this._flags};Tile.prototype.roadFromNorth=function(){return this._roads.n};Tile.prototype.roadFromSouth=function(){return this._roads.s};Tile.prototype.roadFromWest=function(){return this._roads.w};Tile.prototype.roadFromEast=function(){return this._roads.e};Tile.prototype.hasAnyRoad=function(){return this.roadFromNorth()||this.roadFromSouth()||this.roadFromWest()||this.roadFromEast()};Tile.prototype.isStart=function(){return this._start===!0};Tile.prototype.isEnd=function(){return this._end===!0};Tile.prototype.isSwappable=function(){return this._swappable};Tile.prototype.isLocked=function(){return this._locked===!0||this.isStart()||this.isEnd()};Tile.prototype.getCarIndexes=function(){if(!this.isStart())throw"Not allowed.";return this._cars}})();(function(){"use strict";window.Board=function(e){function i(){var i,s,o;for(s=0;s<e.height;s++)for(i=0;i<e.width;i++){if(!e.tiles[s]||!e.tiles[s][i])throw"Map invalid.";o=new Tile(i,s,e.tiles[s][i]);e.tiles[s][i]=o;o.isStart()&&t.push(o);o.isEnd()&&n.push(o)}if(!t.length)throw"Map invalid.";if(!n.length)throw"Map invalid.";if(e.swapTile){e.swapTile.swappable=!0;r=new Tile(0,0,e.swapTile)}}function s(t,n){if(e.tiles[n]===undefined||e.tiles[n][t]===undefined)throw"Tile invalid"}var t=[],n=[],r=null;i();this.getWidth=function(){return e.width};this.getHeight=function(){return e.height};this.getStartTiles=function(){return t};this.getEndTiles=function(){return n};this.getSwapTile=function(){return r};this.getTile=function(t,n){s(t,n);return e.tiles[n][t]};this.getTiles=function(){var t,n,r=[];for(n=0;n<e.height;n++)for(t=0;t<e.width;t++)r.push(e.tiles[n][t]);return r}}})();(function(){"use strict";window.Game=function(e){function f(){t=new EventListenersManager(["game-started","car-added","car-lost","car-won","game-won","game-lost"]);if(e.carCount<1||e.carCount<e.carsToWin||!e.starLimits||e.starLimits.length!==3)throw"Level invalid.";n=new Board(e.map);u=setTimeout(l,e.startTimeout);var r=c();r.addFlag("car-approaching")}function l(){o="running";t.trigger("game-started");h()}function c(){var e,t,i,s,o;i=n.getStartTiles();for(e=0,t=i.length;e<t;e++){s=i[e];o=s.getCarIndexes();if(o&&o.indexOf(r)!==-1)break}return s}function h(){var n;if(o==="lost"||o==="won")throw"Game finished.";n=c();n.removeFlag("car-approaching");r++;t.trigger("car-added",{startTile:n,velocity:e.carSpeed});if(r<e.carCount){a=setTimeout(h,e.carTimeout);n=c();n.addFlag("car-approaching")}}function p(){if(e.carCount-i<e.carsToWin){o="lost";t.trigger("game-lost");clearInterval(a)}else if(s+i===e.carCount){o="won";t.trigger("game-won")}}var t,n,r=0,i=0,s=0,o="waiting",u,a;f();this.pause=function(){clearTimeout(u);clearTimeout(a)};this.resume=function(){o==="running"?a=setTimeout(h,e.carTimeout):o==="waiting"&&(u=setTimeout(l,e.startTimeout))};this.getBoard=function(){return n};this.hasEnded=function(){return o==="lost"||o==="won"};this.getDeployedCarsCount=function(){return r};this.getAllCarsCount=function(){return e.carCount};this.getStarLimits=function(){return e.starLimits};this.carWon=function(){s++;t.trigger("car-won");p()};this.carLost=function(){i++;t.trigger("car-lost");p()};this.on=function(e,n){t.addEventListener(e,n)};this.destroy=function(){t.removeEventListener();u&&clearTimeout(u);a&&clearTimeout(a)}}})();(function(){"use strict";window.ScoreTracker=function(e){function s(){if(e.game.hasEnded()||n<=0)return;n--;t.trigger("change",{score:n,stars:i.getNumberOfStars()})}function o(){var i,o;t=new EventListenersManager(["change"]);n=100;r=e.game.getStarLimits();var u=e.game.getBoard().getTiles();for(i=0,o=u.length;i<o;i++){u[i].on("rotate",s);u[i].on("swap",s)}}var t,n,r,i=this;o();this.on=function(e,n){t.addEventListener(e,n)};this.getNumberOfStars=function(){var e=0;for(var t=0;t<3;t++){if(n<r[t])break;e++}return e};this.getCurrentScore=function(){return n};this.destroy=function(){var n,r,i=e.game.getBoard().getTiles();for(n=0,r=i.length;n<r;n++){i[n].off("rotate",s);i[n].off("swap",s)}t.removeEventListener()}}})();(function(){"use strict";window.ProgressManager=function(){function n(){e=new EventListenersManager(["level-update","level-unlock"]);r()}function r(){var e;if(localStorage.gameProgress)try{e=JSON.parse(localStorage.gameProgress)}catch(n){throw"Error parsing."}e&&e.levels&&(t=e.levels)}function i(){localStorage.gameProgress=JSON.stringify({levels:t})}var e,t={};n();this.getLevelInfo=function(e){return t[e]};this.update=function(n){if(t[n.levelName]&&t[n.levelName].score>n.score)return;t[n.levelName]||e.trigger("level-unlock");t[n.levelName]={score:n.score,stars:n.stars};e.trigger("level-update",n);i()};this.on=function(t,n){e.addEventListener(t,n)}}})();(function(){"use strict";window.MapLoader=function(){var e=new EventListenersManager(["load","error"]);this.on=function(t,n){e.addEventListener(t,n)};this.load=function(t){var n=new XMLHttpRequest,r;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){try{r=JSON.parse(n.responseText)}catch(t){throw"Map invalid."}e.trigger("load",r)}};n.open("GET","levels/"+t+".json");n.send()}}})();(function(){"use strict";window.HTMLTile=function(e){this._tile=e;this._node=null;this._rotation=0;this._tile.on("rotate",this._wasRotated.bind(this));this._tile.on("lock",this._wasLocked.bind(this));this._tile.on("unlock",this._wasUnlocked.bind(this));this._tile.on("swap",this._wasSwapped.bind(this));this._tile.on("flag-added",this._flagAdded.bind(this));this._tile.on("flag-removed",this._flagRemoved.bind(this))};HTMLTile.prototype._rotate=function(){this._node.style.transform="rotate("+this._rotation+"deg)";this._node.style.webkitTransform="rotate("+this._rotation+"deg)"};HTMLTile.prototype._flagAdded=function(e){this._node.classList.add(e)};HTMLTile.prototype._flagRemoved=function(e){this._node.classList.remove(e)};HTMLTile.prototype._wasRotated=function(e){e==="left"?this._rotation-=90:e==="right"&&(this._rotation+=90);this._rotate()};HTMLTile.prototype._wasLocked=function(){this._node.classList.add("locked")};HTMLTile.prototype._wasUnlocked=function(){this._node.classList.remove("locked")};HTMLTile.prototype._wasSwapped=function(){var e=this._node;this._createDOMNode();e.parentNode.replaceChild(this._node,e)};HTMLTile.prototype._createDOMNode=function(){this._node=document.createElement("div");var e="",t=this._tile.roadFromNorth(),n=this._tile.roadFromSouth(),r=this._tile.roadFromEast(),i=this._tile.roadFromWest();if(t==="s"&&n==="n"&&!i&&!r){e="straight";this._rotation=90}else if(i==="e"&&r==="w"&&!t&&!n){e="straight";this._rotation=0}else if(i==="n"&&!r&&t==="w"&&!n){e="turn";this._rotation=90}else if(i==="s"&&!r&&!t&&n==="w"){e="turn";this._rotation=0}else if(!i&&r==="n"&&t==="e"&&!n){e="turn";this._rotation=180}else if(!i&&r==="s"&&!t&&n==="e"){e="turn";this._rotation=270}else if(t==="s"&&n==="n"&&i==="e"&&r==="w"){e="junction";this._rotation=0}else if(t==="e"&&r==="n"&&i==="s"&&n==="w"){e="two-turns";this._rotation=0}else if(t==="w"&&i==="n"&&r==="s"&&n==="e"){e="two-turns";this._rotation=90}else if(i==="e"&&r==="w"&&n==="w"&&!t){e="t-road";this._rotation=0}else if(i==="n"&&t==="s"&&n==="n"&&!r){e="t-road";this._rotation=90}else if(i==="e"&&r==="w"&&t==="e"&&!n){e="t-road";this._rotation=180}else if(t==="s"&&n==="n"&&r==="s"&&!i){e="t-road";this._rotation=270}this._node.classList.add("tile");e&&this._node.classList.add(e);this._rotate();this._tile.isStart()?this._node.classList.add("start"):this._tile.isEnd()?this._node.classList.add("end"):this._tile.isLocked()?this._node.classList.add("locked"):this._tile.isSwappable()&&this._node.classList.add("swappable");var s=this._tile.getFlags();for(var o=0,u=s.length;o<u;o++)this._flagAdded(s[o]);this._node.dataset.x=this._tile.getX();this._node.dataset.y=this._tile.getY();this._node.appendChild(document.createElement("p"))};HTMLTile.prototype.getDOMNode=function(){this._node||this._createDOMNode();return this._node}})();(function(){window.HTMLBoard=function(e){function i(){t.draw();h()}function s(){var t,n=10,r=65,i=4,s,o=Math.floor((window.innerWidth-n)/e.board.getWidth())-i,u=Math.floor((window.innerHeight-r)/e.board.getHeight())-i;s=o<u?o:u;t=document.styleSheets[0];t.insertRule(".tiles .row .tile { width: "+s+"px; height: "+s+"px }",t.cssRules.length)}function o(t){if(!t.target.classList.contains("tile"))return;var r=t.target,i=e.board.getTile(r.dataset.x,r.dataset.y);n?l(i):u(i)}function u(e){if(e.isLocked())return;r?e.rotateLeft():e.rotateRight()}function a(e){if(e.keyCode===32){r=!0;e.stopPropagation();e.preventDefault()}}function f(e){e.keyCode===32&&(r=!1)}function l(t){if(t.isLocked()||!t.isSwappable())return;var n=t.clone(),r=e.board.getSwapTile();t.swap(r);r.swap(n);c()}function c(){if(!n){e.element.classList.add("swap-mode");n=!0}else{e.element.classList.remove("swap-mode");n=!1}}function h(){new Tap(e.element);e.element.addEventListener("tap",o,!1);new Tap(e.swapContainer);e.swapContainer.addEventListener("tap",c);window.addEventListener("resize",s);document.addEventListener("keypress",a);document.addEventListener("keyup",f)}var t=this,n=!1,r=!1;this.getDOMNode=function(){return e.element};this.draw=function(){var t=e.board.getWidth(),n=e.board.getHeight(),r=document.createDocumentFragment(),i=document.createElement("div"),o,u,a,f,l,c;i.className="row";for(a=0;a<n;a++){o=i.cloneNode(!1);for(u=0;u<t;u++){f=e.board.getTile(u,a);l=new HTMLTile(f);o.appendChild(l.getDOMNode())}r.appendChild(o)}DOMHelper.purgeElement(e.element);e.element.appendChild(r);s();f=e.board.getSwapTile();if(f){var h=new HTMLTile(f);c=h.getDOMNode();e.swapContainer.style.display="block";e.swapContainer.appendChild(c)}else e.swapContainer.style.display="none"};this.destroy=function(){DOMHelper.purgeElement(e.element);DOMHelper.unbindAllEvents(e.element);e.element.classList.remove("swap-mode");DOMHelper.purgeElement(e.swapContainer);DOMHelper.unbindAllEvents(e.swapContainer);n=!1;window.removeEventListener("resize",s);document.removeEventListener("keypress",a);document.removeEventListener("keyup",f)};i()}})();(function(){"use strict";window.HTMLGameStatus=function(e){function t(){e.game.on("car-added",n);e.scoreTracker.on("change",r);n();r({score:e.scoreTracker.getCurrentScore(),stars:e.scoreTracker.getNumberOfStars()})}function n(){e.carsStatusContainer.innerHTML=e.game.getDeployedCarsCount()+"/"+e.game.getAllCarsCount()}function r(t){e.scoreContainer.innerHTML=t.score;var n=e.starsContainer.querySelectorAll("i");for(var r=0;r<3;r++)t.stars<r+1?n[r].classList.add("inactive"):n[r].classList.remove("inactive")}t()}})();(function(){"use strict";window.ScreenManager=function(){function n(e){var t=function(n){if(n.target===n.currentTarget){var r=e.getDOMNode();r.style.visibility="hidden";r.removeEventListener(DOMHelper.transitionEnd,t);e.afterHide&&e.afterHide()}};return t}function r(e,t){var n=function(r){if(r.target===r.currentTarget){var i=e.getDOMNode();i.removeEventListener(DOMHelper.transitionEnd,n);e.afterShow&&e.afterShow(t)}};return n}var e={},t=null;this.addScreen=function(t,n){e[n]=t;t.getDOMNode().style.visibility="hidden"};this.goToScreen=function(i,s){var o=e[i];if(!o)throw"Screen invalid.";if(t){o.beforeHide&&o.beforeHide();var u=n(t);t.getDOMNode().addEventListener(DOMHelper.transitionEnd,u);t.getDOMNode().classList.remove("visible")}o.getDOMNode().style.visibility="visible";o.beforeShow&&o.beforeShow(s);var a=r(o,s);o.getDOMNode().addEventListener(DOMHelper.transitionEnd,a);o.getDOMNode().classList.add("visible");t=o}}})();(function(){"use strict";window.LevelsScreen=function(e){function n(){t=new EventListenersManager(["level-chosen"]);var n=e.element.querySelector(".levels");new Tap(n);n.addEventListener("tap",function(e){var n=DOMHelper.getParentByTagName(e.target,"li");n&&!n.classList.contains("inactive")&&t.trigger("level-chosen",{levelName:n.dataset.levelName})},!1);r()}function r(){var t,n,r=e.element.querySelectorAll(".levels li");for(t=0,n=r.length;t<n;t++){var o=r[t].dataset.levelName,u=e.progressManager.getLevelInfo(o);s(r[t],u)}i();e.progressManager.on("level-update",function(e){for(t=0,n=r.length;t<n;t++){var i=r[t].dataset.levelName;i===e.levelName&&s(r[t],e)}});e.progressManager.on("level-unlock",i)}function i(){var t=e.element.querySelector(".levels li.inactive");t&&t.classList.remove("inactive")}function s(e,t){var n,r=e.querySelectorAll("i");if(!t){e.classList.add("inactive");for(n=0;n<3;n++)r[n].classList.add("inactive")}else{e.classList.remove("inactive");for(n=0;n<3;n++)t.stars<n+1?r[n].classList.add("inactive"):r[n].classList.remove("inactive")}}var t;n();this.on=function(e,n){t.addEventListener(e,n)};this.getDOMNode=function(){return e.element}}})();(function(){"use strict";window.PauseScreen=function(e){function s(){t=new EventListenersManager(["resume-game","back-to-levels"]);n=e.element;r=n.querySelector("#resume-button");i=n.querySelector("#levels-button");new Tap(r);new Tap(i);r.addEventListener("tap",function(e){o();t.trigger("resume-game")},!1);i.addEventListener("tap",function(e){o();t.trigger("back-to-levels")},!1)}function o(){n.style.display="none"}var t,n,r,i;s();this.show=function(){n.style.display="block"};this.on=function(e,n){t.addEventListener(e,n)};this.destroy=function(){DOMHelper.unbindAllEvents(r);DOMHelper.unbindAllEvents(i);t.removeEventListener();t=n=r=i=undefined}}})();(function(){"use strict";window.EndScreen=function(e){function a(){t=new EventListenersManager(["back-to-levels","restart-level"]);n=e.element;r=n.querySelector("#win");i=n.querySelector("#loose");s=n.querySelector("#win-levels-button");o=n.querySelector("#loose-levels-button");u=n.querySelector("#restart-button");new Tap(s);new Tap(o);new Tap(u);o.addEventListener("tap",function(){l();t.trigger("back-to-levels")},!1);s.addEventListener("tap",function(){f();t.trigger("back-to-levels")},!1);u.addEventListener("tap",function(){l();t.trigger("restart-level")},!1)}function f(){n.style.display="none";r.style.display="none"}function l(){n&&(n.style.display="none");i.style.display="none"}function c(t){var n=e.element.querySelectorAll("i");for(var r=0;r<3;r++)t<r+1?n[r].classList.add("inactive"):n[r].classList.remove("inactive")}var t,n,r,i,s,o,u;a();this.showWin=function(e){c(e);n.style.display="block";r.style.display="block"};this.showLoose=function(){n.style.display="block";i.style.display="block"};this.on=function(e,n){t.addEventListener(e,n)};this.destroy=function(){DOMHelper.unbindAllEvents(s);DOMHelper.unbindAllEvents(o);t.removeEventListener();t=n=r=i=s=o=undefined}}})();(function(){"use strict";window.PlayScreen=function(e){function v(){a=new EventListenersManager(["close","won"]);t=new MapLoader;t.on("load",S)}function m(){var t=e.element.querySelector("#pause-button");new Tap(t);t.addEventListener("tap",function(){g()})}function g(){n.pause();b();s.stopAnimation();c.show()}function y(){setTimeout(function(){e.element.classList.add("shake");setTimeout(function(){e.element.classList.remove("shake")},400)},70)}function b(){clearInterval(f);f=undefined}function w(){f||(f=setInterval(function(){o.step(s.getTileSize());u.checkCollisions()},16))}function E(){d.afterHide();d.beforeShow({levelName:p})}function S(t){n=new Game(t);l=new ScoreTracker({game:n});c=new PauseScreen({element:e.element.querySelector("#paused")});h=new EndScreen({element:e.element.querySelector("#win-loose")});c.on("resume-game",function(){n.resume();w();s.startAnimation()});c.on("back-to-levels",function(){a.trigger("close")});h.on("back-to-levels",function(){a.trigger("close")});h.on("restart-level",E);r=new HTMLBoard({board:n.getBoard(),swapContainer:e.element.querySelector("#swap-tile"),element:e.element.querySelector(".tiles")});i=new HTMLGameStatus({game:n,scoreTracker:l,carsStatusContainer:e.element.querySelector(".cars-deployed"),scoreContainer:e.element.querySelector(".current-score"),starsContainer:e.element.querySelector(".stars")});s=new CanvasManager({element:e.element.querySelector("#canvas"),tilesHorizontal:n.getBoard().getWidth(),tilesVertical:n.getBoard().getHeight()});o=new CarManager(n);u=new CollisionDetector;n.on("car-added",function(e){var t=o.addCar({startX:e.startTile.getX(),startY:e.startTile.getY(),velocity:e.velocity});t.on("crash",function(e){if(!e.alive){u.removeObject(e);y(
)}});t.on("trip-end",function(e){u.removeObject(e)});u.addObject(t)});n.on("game-started",function(){w()});n.on("game-won",function(){h.showWin();a.trigger("won",{levelName:p,score:l.getCurrentScore(),stars:l.getNumberOfStars()})});n.on("game-won",function(){h.showWin(l.getNumberOfStars())});n.on("game-lost",function(){h.showLoose()});s.addManager(o);s.startAnimation()}var t,n,r,i,s,o,u,a,f,l,c,h,p,d=this;v();this.on=function(e,t){a.addEventListener(e,t)};this.getDOMNode=function(){return e.element};this.beforeShow=function(e){p=e.levelName;t.load(p)};this.afterShow=function(){m()};this.beforeHide=function(){DOMHelper.unbindAllEvents(e.element.querySelector("#pause-button"))};this.afterHide=function(){l.destroy();l=null;r.destroy();r=null;n.destroy();n=null;o=null;u=null;s.destroy();s=null;c.destroy();c=null;h.destroy();h=null;clearInterval(f);f=null}}})();document.addEventListener("DOMContentLoaded",function(){var e=new ProgressManager,t=new LevelsScreen({element:document.getElementById("levels-screen"),progressManager:e}),n=new PlayScreen({element:document.getElementById("play-screen")}),r=new ScreenManager;r.addScreen(t,"levels");r.addScreen(n,"play");t.on("level-chosen",function(e){r.goToScreen("play",e)});n.on("close",function(){r.goToScreen("levels")});n.on("won",function(t){e.update(t)});r.goToScreen("levels")},!1);