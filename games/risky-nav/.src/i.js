kontra={init(t){var e=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");this.context=e.getContext("2d")},_noop:new Function,_tick:new Function},kontra.gameLoop=function(t){let e,n,g,i,s=(t=t||{}).fps||60,a=0,r=1e3/s,o=1/s,l=!1===t.clearCanvas?kontra._noop:function(){kontra.context.clearRect(0,0,kontra.canvas.width,kontra.canvas.height)};function h(){if(n=requestAnimationFrame(h),g=performance.now(),i=g-e,e=g,!(i>1e3)){for(kontra._tick(),a+=i;a>=r;)m.update(o),a-=r;l(),m.render()}}let m={update:t.update,render:t.render,isStopped:!0,start(){e=performance.now(),this.isStopped=!1,requestAnimationFrame(h)},stop(){this.isStopped=!0,cancelAnimationFrame(n)}};return m};"use strict";class Char{constructor(t,e,n=!1){this._last=0,this.x=t,this.y=e,this.x_old=t,this.y_old=e,this.x_px=this.x*g.tw,this.y_px=this.y*g.tw,this.dmg=0,this.monster=n,this.path=null,this._invincible=0,this._progress=0,this._speed=n?.24:.12,this.dir=3}getImgCut(){let t=[0,0,16,16];return 1==this.dir?t[0]=16:2==this.dir?t[1]=16:4==this.dir&&(t[0]=16,t[1]=16),!this.monster&&g.isOnline&&(t[0]+=32),this.dmg&&(t[1]+=32),t}mv(t,e,n){if(!g.started)return;if(n&&n-this._lastMV<1e3*this._speed)return;this._lastMV=n,this._progress=0,this.x_old=this.x,this.y_old=this.y,this.x+=t,this.y+=e,4&g.map[this.y*g.mc+this.x]||this.x<1||this.y<1||this.x>=g.mc-1||this.y>=g.mr-1?(this.x-=t,this.y-=e):this.monster||(this.path=PF.findGoal(this.x,this.y)),this.dir=e?e<0?1:3:t<0?4:2}takeDamage(){if(this._invincible)return;this._invincible=2,this.dmg++;let t=document.getElementById("hit");t.style.opacity=.5,setTimeout(()=>{t.style.opacity=0},150)}update(t){this._invincible=Math.max(this._invincible-t,0),this._progress+=g.dt/1e3/this._speed,this._progress>1&&(this._progress=1);let e=this._progress;this.x_px=~~((e*this.x+(1-e)*this.x_old)*g.tw),this.y_px=~~((e*this.y+(1-e)*this.y_old)*g.tw)}updateMonster(t,e){this.update(t),this._last+=t;let n=!1,i=this.x-e.x,s=this.y-e.y;if(!g.isGameOver){let t=Math.sqrt(i*i+s*s);n=g.isOnline||t<6}let a=n?this._speed:1;if(this._last<a)return;this._last=0;let r=0,o=0,l=!0;if(n){Math.abs(i)>Math.abs(s)?r=i<0?1:-1:o=s<0?1:-1,l=4&g.map[(this.y+o)*g.mc+this.x+r]}l&&(g.rnd()<.5?(r=Math.round(2*g.rnd()-1),o=0):(r=0,o=Math.round(2*g.rnd()-1))),this.mv(r,o)}}var Keys={_handler:{},state:{},getArrowKey(){let t=this.state[40]||0,e=this.state[37]||0,n=this.state[39]||0,g=this.state[38]||0,i=[t,e,n,g];i.sort((t,e)=>e-t);let s=i[0];return s?s==t?40:s==e?37:s==n?39:s==g?38:null:null},init(){document.body.onkeydown=(t=>{this.state[t.which]=Date.now(),this._handler[t.which]&&this._handler[t.which]()}),document.body.onkeyup=(t=>{this.state[t.which]=0})},isPressed(t){return!!this.state[t]},on(t,e){this._handler[t]=e}};let PF={map:null,generateMap(t,e){let n=(t,e,n)=>{let s=[],a=t+1,r=t-1,o=e+1,l=e-1;return a<g.mc&&!i[a][e]&&2&g.map[e*g.mc+a]&&(i[a][e]=n,s.push({x:a,y:e,step:n})),t>0&&!i[r][e]&&2&g.map[e*g.mc+r]&&(i[r][e]=n,s.push({x:r,y:e,step:n})),o<g.mr&&!i[t][o]&&2&g.map[o*g.mc+t]&&(i[t][o]=n,s.push({x:t,y:o,step:n})),e>0&&!i[t][l]&&2&g.map[l*g.mc+t]&&(i[t][l]=n,s.push({x:t,y:l,step:n})),s},i=Array(g.mc);for(let t=0;t<g.mc;t++)i[t]=Array(g.mr).fill(0);i[t][e]=1;let s=[{x:t,y:e,step:1}];for(;s.length;){let t=s.splice(0,1)[0];s=s.concat(n(t.x,t.y,t.step+1))}this.map=i},findGoal(t,e){let n=this.map,i=n[t][e];if(!i)return null;let s=[{x:t,y:e}];for(;--i;){let a=null;t>0&&(a=n[t-1][e])==i?(s.push({x:t-1,y:e}),t--):t<g.mc-1&&(a=n[t+1][e])==i?(s.push({x:t+1,y:e}),t++):e>0&&(a=n[t][e-1])==i?(s.push({x:t,y:e-1}),e--):e<g.mr-1&&(a=n[t][e+1])==i&&(s.push({x:t,y:e+1}),e++)}return s}};window.addEventListener("load",()=>{function t(){let t=document.createElement("canvas"),e=t.getContext("2d");return[t,e]}function e(t,n=0){let i=2+~~(g.rnd()*(g.mc-4)),s=2+~~(g.rnd()*(g.mr-4)),a=Math.abs(t.x-i),r=Math.abs(t.y-s);if(a<10&&r<10)return n>5?null:e(t,n+1);let o=s*g.mc+i;return g.map[o]=2,[i,s]}function n(){let t=~~(g.ww/g.mc),e=~~(g.wh/g.mc);g.tw=Math.max(g.tw,Math.max(t,e)),g.mw=g.mc*g.tw,g.mh=g.mr*g.tw}function i(){g.groundCanvas.width=g.mc,g.groundCanvas.height=g.mr,g.groundCtx.imageSmoothingEnabled=!1;let t=0,e=1;g.map.forEach((n,i)=>{let s=i%g.mc,a=`rgb(18,${~~(90+20*g.rndSeed(e++))},40)`;if(4&n)a="#282828";else if(!s||!t||s==g.mc-1||t==g.mr-1){a=`rgb(30,90,${~~(140+60*g.rndSeed(e++))})`,g.map[i]=16}g.groundCtx.fillStyle=a,g.groundCtx.fillRect(s,t,1,1),t+=!(++i%g.mc)})}function s(){g.fogCanvas.width=g.mc,g.fogCanvas.height=g.mr,g.fogCtx.imageSmoothingEnabled=!1;let t=Math.ceil(g.ww/g.tw),e=Math.ceil(g.wh/g.tw);for(let n=0;n<e;n++)for(let e=0;e<t;e++){let t=Math.sqrt(e*e+n*n),i=t<2?0:Math.min(1.15-Math.min(3/t,1),1);g.fogCtx.fillStyle=`rgba(0,0,0,${i})`,g.fogCtx.fillRect(e,n,1,1)}}let a=0;window.onresize=(()=>{clearTimeout(a),a=setTimeout(()=>{g.ww=window.innerWidth,g.wh=window.innerHeight,n(),i(),s(),k.canvas.width=g.ww,k.canvas.height=g.wh,k.context.imageSmoothingEnabled=!1,M&&M.isStopped&&M.render()},200)}),window.g={isAtGoal:!1,isGameOver:!1,isOnline:!1,started:!1,rnd:Math.random,rndSeed:t=>{let e=1e4*Math.sin(t);return e-Math.floor(e)},tw:48,ww:window.innerWidth,wh:window.innerHeight},g.mc=128+~~(128*g.rnd()),g.mr=128+~~(128*g.rnd()),window.k=kontra,n();let r=new Array(g.mc*g.mr);g.map=r.fill(2);let o=.06*r.length;for(;o-- >0;)r[~~(g.rnd()*r.length)]=4;let l={x:4+~~(g.rnd()*(g.mc-8)),y:4+~~(g.rnd()*(g.mr-8))};r[l.y*g.mc+l.x]=8,r[(l.y-1)*g.mc+l.x]=2,r[(l.y+1)*g.mc+l.x]=2,r[l.y*g.mc+l.x-1]=2,r[l.y*g.mc+l.x+1]=2,[g.groundCanvas,g.groundCtx]=t(),i(),[g.fogCanvas,g.fogCtx]=t(),s(),PF.generateMap(l.x,l.y),k.init(),k.canvas.width=g.ww,k.canvas.height=g.wh,k.context.imageSmoothingEnabled=!1;let[h,m]=function t(){let e=g.rnd(),n=null,i=null;e<.33?(n=2+4*g.rnd(),i=g.rnd()*(g.mr-4)):e<.66?(n=g.mc-2-4*g.rnd(),i=g.rnd()*(g.mr-4)):(n=g.rnd()*(g.mc-4),i=2+4*g.rnd()),i=~~i;let s=(n=~~n)-l.x,a=i-l.y;if(Math.sqrt(s*s+a*a)<50||!PF.findGoal(n,i))return t();let r=i*g.mc+n;return g.map[r]=2,[n,i]}(),d=new Char(h,m);Keys.init(),Keys.on(79,()=>{g.started&&(g.isOnline=!g.isOnline)});let w=[1,1,g.mc-1,g.mr-1],c=k.context,y=.002*r.length,p=[];for(let t=0;t<y;t++){let t=e(d);t&&p.push(new Char(...t,!0))}y=p.length;let u=document.getElementById("p"),x=document.getElementById("m"),f=document.getElementById("v");d.path=PF.findGoal(d.x,d.y);let v=["A gnashing of teeth.","Ah, that wasâ€¦ a little unsatisfying.","Stared at the phone for too long?","Offline again."],_=v.length-1;document.getElementById("ot").textContent=v[Math.round(g.rnd()*_)];let C=0;g.dt=1/60;let M=k.gameLoop({update:t=>{if(C&&(g.dt=performance.now()-C),C=performance.now(),d.x==l.x&&d.y==l.y&&!g.isAtGoal)return g.isAtGoal=!0,g.isOnline=!1,M.stop(),M.render(),void(document.getElementById("w").style.display="flex");if(d.dmg>1)g.isGameOver=!0,g.isOnline=!1,document.getElementById("over").style.display="flex";else{let t=Keys.getArrowKey();40==t?d.mv(0,1,Date.now()):37==t?d.mv(-1,0,Date.now()):39==t?d.mv(1,0,Date.now()):38==t&&d.mv(0,-1,Date.now())}d.update(t);for(let e=0;e<y;e++){let n=p[e];n.updateMonster(t,d),g.isGameOver||n.x!=d.x||n.y!=d.y||d.takeDamage()}},render:()=>{let t=g.ww-g.mw,e=g.wh-g.mh,n=~~(g.tw/2),i=~~(g.tw/6),s=[0,0,g.mw,g.mh],a=[g.tw,g.tw,g.mw-g.tw,g.mh-g.tw],r=d.x_px,o=d.y_px;(g.isAtGoal||g.isGameOver)&&(r=d.x*g.tw,o=d.y*g.tw);let h=g.ww/2-r;h=(h=h>0?0:h)<t?t:~~h;let m=g.wh/2-o;m=(m=m>0?0:m)<e?e:~~m,c.setTransform(1,0,0,1,h,m),c.drawImage(g.groundCanvas,...s);let v=d.x-l.x,_=d.y-l.y,C=Math.sqrt(v*v+_*_);C<4&&(c.globalAlpha=C<2?1:.4,c.drawImage(f,0,0,16,16,l.x*g.tw,l.y*g.tw,g.tw,g.tw),c.globalAlpha=1),g.isGameOver&&c.drawImage(f,16,0,16,16,d.x*g.tw,d.y*g.tw,g.tw,g.tw);for(let t=0;t<y;t++){let e=p[t];c.drawImage(x,...e.getImgCut(),e.x_px,e.y_px,g.tw,g.tw)}let M=h+r,k=m+o;c.setTransform(1,0,0,1,M,k),g.isAtGoal||g.isGameOver||c.drawImage(u,...d.getImgCut(),0,0,g.tw,g.tw),c.drawImage(g.fogCanvas,...w,...a),c.setTransform(-1,0,0,1,M+g.tw,k),c.drawImage(g.fogCanvas,...s),c.setTransform(1,0,0,-1,M,k+g.tw),c.drawImage(g.fogCanvas,...s),c.setTransform(-1,0,0,-1,M+g.tw,k+g.tw),c.drawImage(g.fogCanvas,...w,...a);let b=d.path,I=b&&b.length,S=~~(Date.now()/250);if(b&&I>2&&g.isOnline){c.setTransform(1,0,0,1,h+n,m+n),c.beginPath(),c.lineJoin="miter",c.lineWidth=i,c.fillStyle="rgba(255, 255, 255, 0.9)",c.strokeStyle="#6BBEE1";let t=b[1];c.moveTo(t.x*g.tw,t.y*g.tw);for(let e=2;e<I;e++){t=b[e],c.lineTo(t.x*g.tw,t.y*g.tw);let n=.5*g.rndSeed(t.x*t.y+S)-.25,s=.5*g.rndSeed(t.x+t.y+S)-.25,a=Math.max(g.rndSeed(e)*i/3,1);c.fillRect((t.x+n)*g.tw,(t.y+s)*g.tw,a,a)}c.stroke(),t=b[I-1],c.fillStyle="#6BBEE1",c.fillRect(t.x*g.tw-i,t.y*g.tw-i,2*i,2*i)}}});M.render(),Keys.on(82,()=>{(g.isGameOver||g.isAtGoal)&&(M.stop(),window.location.reload())}),Keys.on(83,()=>{g.started||(g.started=!0,document.getElementById("t").style.display="none",M.start())})});