function startState(){var t={t:"The",f:"65px Sans-serif",c:"#FFF"},e={t:"Keeper",f:"70px Sans-serif",c:"#FFF"},n={t:"Click the circle to start",f:"30px Sans-serif",c:"#F0F0F0"};return{create:function(){textWidth([t,e,n]),configLvl(0,200,[-200,-150],null,1,200,!1,!1,!1,!1,!1,[{x:cnv.width/2,y:cnv.height/2+50,r:150,tmp:1}])},update:function(){fillText(t,cnv.width/2-t.w/2,90),fillText(e,cnv.width/2-e.w/2,170),fillText(n,cnv.width/2-n.w/2,cnv.height-10)},finish:function(){switchState(INTRO_STATE)}}}function lvl1State(){return{repeat:!0,lifes:1,create:function(){configLvl(70,100,[-100,-10],25,5,30,!0,!0,!0,!0,!0,[{x:cnv.width/2,y:cnv.height/2,r:200,tmp:1}])},update:function(){},finish:function(){},wonClick:function(){switchState(SKILL2_STATE)},lostClick:function(){this.create()}}}function lvl2State(){return{repeat:!0,lifes:4,create:function(){configLvl(70,100,[-20,20],25,5,30,!0,!0,!0,!0,!0,[{x:cnv.width/2-100,y:cnv.height/2,r:100,tmp:1},{x:cnv.width/2+100,y:cnv.height/2,r:120,tmp:1}])},update:function(){},finish:function(){},wonClick:function(){switchState(SKILL3_STATE)},lostClick:function(){this.create()}}}function lvl3State(){return{repeat:!0,lifes:16,create:function(){configLvl(-150,200,[-100,100],25,5,30,!0,!0,!0,!0,!0,[{x:cnv.width/2,y:cnv.height/2-150,r:70,tmp:1},{x:cnv.width/2+80,y:cnv.height/2+100,r:140,tmp:0},{x:cnv.width/2-80,y:cnv.height/2+100,r:140,tmp:0}])},update:function(){},finish:function(){},wonClick:function(){switchState(READY_STATE)},lostClick:function(){this.create()}}}function readyState(t,e,n){var i=1,l={t:"You seem",f:"50px Sans-serif",c:"#FAFAFA"},c={t:"to be ready",f:"50px Sans-serif",c:"#FAFAFA"},r={t:"Let's work",f:"90px Sans-serif",c:"#4DCC00"},a={t:"Please, do it well",f:"40px Sans-serif",c:"#FAFAFA"};return{create:function(){"undefined"!=typeof Storage&&localStorage.setItem("keeper-tutorial",4),textWidth([l,c,r,a]),configLvl(-100,100,[-100,100],null,null,null,!1,!1,!1,!1,!1,null)},update:function(){tmp+=i,tmp>=100&&this.finish(),fillText(l,center(l.w,cnv.width),100),fillText(c,center(c.w,cnv.width),140),fillText(r,center(r.w,cnv.width),320),fillText(a,center(a.w,cnv.width),550)},finish:function(){switchState(LVLGEN_STATE)}}}function introState(){function t(){ctx.strokeStyle="#FAFAFA",ctx.lineWidth=4,ctx.setLineDash([10]),ctx.beginPath(),ctx.moveTo(cnv.width/2,420),ctx.lineTo(cnv.width/2,cnv.height-50),ctx.stroke(),ctx.closePath(),o.t="Saved worlds",o.c="#4DBF00",s.t=""+savedWorlds,h.t="("+savedLifes+" species)",textWidth(o),textWidth(s),textWidth(h),fillText(o,center(o.w,cnv.width/2),460),fillText(s,center(s.w/2,cnv.width/2),550),fillText(h,center(h.w,cnv.width/2),570),o.t="Non saved worlds",o.c="#CC170A",s.t=""+lostWorlds,h.t="("+lostLifes+" species)",textWidth(o),textWidth(s),textWidth(h),fillText(o,center(o.w,cnv.width/2)+cnv.width/2,460),fillText(s,center(s.w/2,cnv.width/2)+cnv.width/2,550),fillText(h,center(h.w,cnv.width/2)+cnv.width/2,570)}var e=0,n=.5,i=["loading propulsors","detecting user mood","cleaning dishes","preparing coffee","taking nap pills","asking for indications","writing a song","holding breath","thinking a joke","flirting with OS"],l=null,c={f:"70px Sans-serif",t:"Hi",c:"#FDFDFD"},r={t:"keeper",f:"85px Sans-serif",c:"#FDFDFD"},a={t:"",f:"95px Sans-serif",c:"#F0F0F0"},o={t:"",f:"25px Sans-serif",c:""},s={t:"",f:"30px Sans-serif",c:"#FFF"},h={t:"",f:"15px Sans-serif",c:"#DADADA"};return{create:function(){if("undefined"!=typeof Storage){var t=localStorage.getItem("keeper-nick");t?(c.t="Hi again",firstTime=!1):(c.t="Hi",t=genNick(),localStorage.setItem("keeper-nick",t)),e=parseInt(localStorage.getItem("keeper-tutorial"))||1,a.t=t,savedWorlds=parseInt(localStorage.getItem("keeper-saved"))||0,savedLifes=parseInt(localStorage.getItem("keeper-saved-l"))||0,lostWorlds=parseInt(localStorage.getItem("keeper-lost"))||0,lostLifes=parseInt(localStorage.getItem("keeper-lost-l"))||0}l={t:i[Math.floor(Math.random(i.length)*i.length)],f:"40px Sans-serif",c:"#F0F0F0"},textWidth([c,r,a,l]),configLvl(-70,200,[-70,70],null,null,null,!1,!1,!1,!1,!1,null)},update:function(){return tmp>=70?void this.finish():(t(),tmp+=n,0==Math.abs(tmp%50)&&(l.t=i[Math.floor(Math.random(i.length)*i.length)],textWidth(l)),ctx.setLineDash([1]),fillText(c,center(c.w,cnv.width),100),fillText(r,center(r.w,cnv.width),210),fillText(a,center(a.w,cnv.width),390),drawSquare(center(a.w+90,cnv.width),300,a.w+90,110,"#FDFDFD"),void fillText(l,center(l.w,cnv.width),cnv.height-5))},finish:function(){3>=e?(console.log("here"),switchState(SKILL1_STATE+e-1)):switchState(LVLGEN_STATE)}}}function lvlgenState(){function t(t,e){if(0==e.length)return!1;var n=0;return e.forEach(function(e){n+=distanceBetween(t.x,t.y,e.x,e.y)}),n/(10*e.length)<t.r/3}return{lifes:0,repeat:!1,create:function(){for(var e=getRandomInt(2,6),n=getRandomInt(5,20),i=100,l=calculateTempRange(i),c=[],r=e;r>0;r--){var a=getRandomInt(50,250/Math.log(e+1)),o=calculateCirclePos(a),s={x:o.x,y:o.y,r:a};t(s,c)?r++:(s.tmp=getRandomInt(0,1),c.push(s))}var h=calculateInitTemp(l,i),f=calculateTimeRange(c,n,l),d=calculateTimeLvl(f,h,l);this.lifes=getRandomInt(2,54),configLvl(h,i,l,d,f,n,!0,!0,!0,!0,!0,c)},update:function(){},finish:function(){console.log("Aquí es donde uno se pregunta, ¿vale la pena sufrir por un par de tetas?")},wonClick:function(){switchState(LVLGEN_STATE)},lostClick:function(){this.wonClick()}}}function skillState(t,e,n){var i=1.5,l={t:"Skills",f:"80px Sans-serif",c:"#FAFAFA"},c={t:"Tests",f:"80px Sans-serif",c:"#FAFAFA"},r={t:"Step "+t+":",f:"60px Sans-serif",c:"#FAFAFA"},a={t:e,f:"40px Sans-serif",c:"#FAFAFA"},o={t:"Prepare to start",f:"40px Sans-serif",c:"#F0F0F0"};return{create:function(){"undefined"!=typeof Storage&&localStorage.setItem("keeper-tutorial",t),textWidth([l,c,r,a,o]),configLvl(70,200,[-70,70],null,null,null,!1,!1,!1,!1,!1,null)},update:function(){tmp-=i,-70>=tmp&&this.finish(),fillText(l,center(l.w,cnv.width)-30,100),fillText(c,center(c.w,cnv.width)+30,180),ctx.fillRect(0,230,cnv.width,5),fillText(r,center(r.w,cnv.width),350),fillText(a,center(a.w,cnv.width),480),drawSquare(center(a.w+90,cnv.width),420,a.w+90,100,"#FDFDFD"),fillText(o,center(o.w,cnv.width),cnv.height-5)},finish:function(){switchState(n)}}}function eventWindowLoaded(){var t=document.getElementById("canvas13K");t.width=window.innerWidth>480?480:window.innerWidth,t.style.left=window.innerWidth/2-t.width/2+"px",t.height=window.innerHeight,init()}function init(){cnv=document.getElementById("canvas13K"),cnv&&cnv.getContext&&(ctx=cnv.getContext("2d"),cnv.addEventListener("click",function(t){onMouseClick(t)},!1),initLvl(),switchState(START_STATE),setInterval(function(){updateLvl(),mouseX=mouseY=null},33))}function onMouseClick(t){mouseX=t.clientX-cnv.offsetLeft,mouseY=t.clientY-cnv.offsetTop}function getClick(){return mouseX&&mouseY?{x:mouseX,y:mouseY}:null}function clearCanvas(){ctx.fillStyle="#191919",ctx.fillRect(0,0,cnv.width,cnv.height)}function lerp(t,e,n){return(1-n)*t+n*e}function getRGBText(t){return"rgb("+t.r+","+t.g+","+t.b+")"}function fade(t,e,n,i){var l=100,c=i/l,r=1/c,a=0,o=setInterval(function(){return a>=1?void clearInterval(o):(t.r=Math.round(lerp(e.r,n.r,a)),t.g=Math.round(lerp(e.g,n.g,a)),t.b=Math.round(lerp(e.b,n.b,a)),void(a+=r))},l);return o}function deltaTmp(){for(var t=0,e=0;e<circles.length;e++)t+=circles[e].temperatureSpeed;return t}function textWidth(t){t.length||(t=[t]),t.forEach(function(t){ctx.font=t.f,t.w=ctx.measureText(t.t).width})}function fillText(t,e,n){ctx.fillStyle=t.c,ctx.font=t.f,ctx.fillText(t.t,e,n)}function center(t,e){return e/2-t/2}function distanceBetween(t,e,n,i){return Math.sqrt(Math.pow(t-n,2)+Math.pow(e-i,2))}function genNick(){var t=Date.now();return"K"+t%1e3+String.fromCharCode(t%10+65)}function drawTriangle(t,e){ctx.fillStyle=getRGBText(e),ctx.lineWidth=2,ctx.lineCap="square",ctx.beginPath(),ctx.moveTo(t-10,cnv.height-60),ctx.lineTo(t,cnv.height-40),ctx.lineTo(t+10,cnv.height-60),ctx.lineTo(t-10,cnv.height-60),ctx.fill(),ctx.closePath()}function drawSquare(t,e,n,i,l){ctx.strokeStyle=l,ctx.lineCap="square",ctx.lineWidth=6,ctx.strokeRect(t,e,n,i)}function calculateTFL(t){return 10*t}function calculateCirclePos(t){return{x:getRandomInt(t+5,cnv.width-5-t),y:getRandomInt(cnv.height-(cnv.height-45)+t,cnv.height-45-t)}}function calculateTempRange(t){var e=getRandomInt(-t+10,t-10),n=getRandomInt(e+40,e+60);return n>=t-10&&(n=e,e=getRandomInt(n-60,n-40)),[e,n]}function calculateInitTemp(t,e){var n=0;do n=Math.abs(-e-t[0])>e-t[1]?getRandomInt(-e-10,t[0]-10):getRandomInt(t[1]+10,e-10);while(-e>n||n>e);return n}function calculateTimeRange(t,e,n,i){var l=0;return t.forEach(function(t){l+=calculateTFL(t.r)/e}),l/=t.length,l=Math.floor(l*(n[1]-n[0])/1e3),1>=l&&(l=2),l}function calculateTimeLvl(t,e,n){var i=0;i=Math.abs(e-n[0])<Math.abs(e-n[1])?Math.abs(e-n[0]):Math.abs(e-n[1]);var l=Math.floor(i*t/(n[1]-n[0]));return 3>=l&&(l=4),l+=getRandomInt(l+2,l+5)}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function getRandomArbitrary(t,e){return Math.random()*(e-t)+t}function savedWorldsInfo(){"undefined"!=typeof localStorage&&(localStorage.setItem("keeper-saved",savedWorlds),localStorage.setItem("keeper-saved-l",savedLifes),localStorage.setItem("keeper-lost",lostWorlds),localStorage.setItem("keeper-lost-l",lostLifes))}function drawDashedLine(t,e){ctx.strokeStyle=getRGBText(e),ctx.lineWidth=2,ctx.setLineDash([6]),ctx.beginPath(),ctx.moveTo(t,cnv.height-40),ctx.lineTo(t,cnv.height),ctx.stroke(),ctx.closePath()}function initLvl(){textWidth([tempRest1Text,tempRest2Text,timeOverText,tryAgainText,nextLvlText,touchConTxt])}function configLvl(t,e,n,i,l,c,r,a,o,s,h,f,d){tmp=t,maxTmp=e,range=n,rangeT=rmRangeT=l,levelT=i,dgLap=c,isWorldLvl=r,eWinLvl=a,eLostLvl=o,eTimeBar=s,eTmpText=h,circles=[],createCircles(f),lvlStatus="PLAYING",lvlTimer&&(clearInterval(lvlTimer),lvlTimer=null),lvlTimer=setInterval(function(){levelT&&(levelT-=1)},1e3),ftir=!1,lockAll=!1}function createCircles(t){t&&t.forEach(function(t){"object"==typeof t&&circles.push(new Circle(ctx,t.r,t.x,t.y,0,t.tmp,12,calculateTFL(t.r),dgLap))})}function updateLvl(){if("LOST"==lvlStatus)getClick()&&state.lostClick&&state.lostClick();else if("WON"==lvlStatus)getClick()&&state.wonClick&&state.wonClick();else{if(null!=levelT&&0>=levelT)return void endLvl("LOST");if(null!=rmRangeT&&0>=rmRangeT)return endLvl("WON"),void state.finish();var t=getClick();if(t){for(var e=0;e<circles.length;e++){var n=circles[e].checkClick(t.x,t.y);if(n&&ftir){lockAll=!0;break}}if(lockAll)for(var e=0;e<circles.length;e++)circles[e].listenClicks=!1}if(tmp+=deltaTmp(),Math.abs(tmp)>maxTmp&&(tmp=0>tmp?-1*maxTmp:maxTmp),intoRange()){if(inRangeTimer=inRangeTimer||setInterval(function(){rmRangeT-=1},1e3),!ftir){ftir=!0;for(var e=0;e<circles.length;e++)circles[e].listenClicks=!0}}else if(clearInterval(inRangeTimer),inRangeTimer=null,rmRangeT=rangeT,ftir=!1,lockAll){for(var e=0;e<circles.length;e++)circles[e].listenClicks=!0;lockAll=!1}}clearCanvas(),drawCircles(),drawTmpBar(),eTimeBar&&drawTimeBar(),eTmpText&&drawTmpText(),drawRange(),drawTmpIndicator(),"WON"==lvlStatus?winLvl():"LOST"==lvlStatus&&lostLvl(),state.update()}function stopCircles(){for(var t=0;t<circles.length;t++)circles[t].ball.speed=0,circles[t].listenClicks=!1}function switchState(t){state=gameStates[t](),state.create()}function drawCircles(){for(var t=0;t<circles.length;t++)circles[t].draw()}function winLvl(){eWinLvl&&(stopCircles(),fillText(tempRest1Text,center(tempRest1Text.w,cnv.width),cnv.height/2),fillText(tempRest2Text,center(tempRest2Text.w,cnv.width),cnv.height/2+60),svdWorldsTxt.t=state.lifes+" "+svdWorldsTxt.dt,textWidth(svdWorldsTxt),fillText(svdWorldsTxt,center(svdWorldsTxt.w,cnv.width),cnv.height/2+110),fillText(touchConTxt,center(touchConTxt.w,cnv.width),cnv.height/2+140))}function lostLvl(){eLostLvl&&(fillText(timeOverText,center(timeOverText.w,cnv.width),cnv.height/2),state.repeat?fillText(tryAgainText,center(tryAgainText.w,cnv.width),cnv.height/2+50):state.repeat||fillText(nextLvlText,center(nextLvlText.w,cnv.width),cnv.height/2+50))}function endLvl(t){lvlStatus=t,stopCircles(),clearInterval(lvlTimer),clearInterval(inRangeTimer),inRangeTimer=null,lvlTimer=null,isWorldLvl&&("WON"==t?(savedWorlds+=1,savedLifes+=state.lifes):"LOST"==t&&(lostWorlds+=1,lostLifes+=state.lifes),savedWorldsInfo())}function intoRange(){return rangeT&&tmp<=range[1]&&tmp>=range[0]}function drawRange(){for(var t=range.length-1;t>=0;t--){var e=Math.abs(range[t])*(cnv.width/2)/maxTmp;({r:Math.floor(255*range[t]/maxTmp),g:0,b:Math.floor(255*range[t]/(-1*maxTmp))});e=range[t]<=0?cnv.width/2-e:cnv.width/2+e,drawTriangle(e,{r:230,g:230,b:230}),drawDashedLine(e,{r:21,g:21,b:21})}}function drawTmpIndicator(){var t=Math.abs(tmp.toFixed(2))*(cnv.width/2)/maxTmp;t=0>=tmp?cnv.width/2-t:cnv.width/2+t,drawTriangle(t,barColor)}function drawTmpBar(){barColor={r:Math.floor(123+tmp*(123/maxTmp)),g:0,b:Math.floor(123-tmp*(123/maxTmp))},ctx.fillStyle=getRGBText(barColor),ctx.fillRect(0,cnv.height-40,cnv.width,cnv.height)}function drawTimeBar(){if(ctx.fillStyle=intoRange()?"#4DBF00":"#464D4D",ctx.fillRect(0,0,cnv.width/2,cnv.height-(cnv.height-40)),ctx.fillStyle="#2E3333",ctx.fillRect(cnv.width/2,0,cnv.width/2,cnv.height-(cnv.height-40)),ctx.font="40px Sans-serif",ctx.fillStyle="#F0F0F0",rmRangeT>=0){var t=rmRangeT+" sec",e=ctx.measureText(t);ctx.fillText(t,.25*cnv.width-e.width/2,35)}if(levelT>=0){var t=levelT+" sec",e=ctx.measureText(t);ctx.fillText(t,.75*cnv.width-e.width/2,35)}}function drawTmpText(){ctx.font="40px Sans-serif",ctx.fillStyle="#F0F0F0";var t=tmp.toFixed(2)+"°C",e=ctx.measureText(t);ctx.fillText(t,cnv.width/2-e.width/2,cnv.height-5)}window.addEventListener("load",eventWindowLoaded,!1);var START_STATE=0,INTRO_STATE=1,LVLGEN_STATE=2,SKILL1_STATE=3,SKILL2_STATE=4,SKILL3_STATE=5,LEVEL1_STATE=6,LEVEL2_STATE=7,LEVEL3_STATE=8,READY_STATE=9,cnv=null,ctx=null,mouseX=null,mouseY=null,barColor={r:255,g:255,b:255},gameStates=[startState,introState,lvlgenState,skillState.bind(null,1,"Reversed warming",LEVEL1_STATE),skillState.bind(null,2,"Now keep it!",LEVEL2_STATE),skillState.bind(null,3,"Touch them together",LEVEL3_STATE),lvl1State,lvl2State,lvl3State,readyState],Circle=function(t,e,n,i,l,c,r,a,o){var s=2*Math.PI*e,h=s/(a/33);this.ball={x:0,y:0,speed:360/(s/h)*(Math.PI/180)*(0==c?-1:1)};var f=Math.pow(n+(e-(r-r/2))-n,2),d=Math.sqrt(f),v=Math.pow(n+(e+(r-r/2))-n,2),u=Math.sqrt(v),T=null;this.color={r:255,g:0,b:0},0==c&&(this.color={r:0,g:0,b:255}),this.temperatureSpeed=33*o/a*(0==c?-1:1),this.listenClicks=!0,this.draw=function(){t.beginPath(),t.strokeStyle=getRGBText(this.color),t.lineWidth=r,t.arc(n,i,e,0,2*Math.PI,!0),t.stroke(),t.closePath(),this.ball.x=n+Math.cos(l)*e,this.ball.y=i+Math.sin(l)*e,l+=this.ball.speed,t.fillStyle=getRGBText(this.color),t.beginPath(),t.arc(this.ball.x,this.ball.y,15,0,2*Math.PI,!0),t.closePath(),t.fill(),this.listenClicks||(t.strokeStyle="#313131",t.setLineDash([1]),t.lineWidth=r+1,t.beginPath(),t.arc(n,i,e,0,Math.PI/180*315,!0),t.stroke(),t.closePath(),t.beginPath(),t.arc(n,i,e,Math.PI/180*180,Math.PI/180*135,!0),t.stroke(),t.closePath())},this.checkClick=function(t,e){if(1==this.listenClicks){var l=Math.pow(n-t,2),c=Math.pow(i-e,2),r=Math.sqrt(l+c);if(r>=d&&u>=r){clearInterval(T);var a=this.color,o=null;return o=this.ball.speed>0?{r:0,g:0,b:255}:{r:255,g:0,b:0},T=fade(this.color,a,o,2e3),this.ball.speed*=-1,this.temperatureSpeed*=-1,this.listenClicks=!1,!0}}return!1},this.drawDebug=function(){t.fillStyle="blue",t.beginPath(),t.arc(n,i,1,0,2*Math.PI,!0),t.closePath(),t.fill(),t.fillStyle="blue",t.beginPath(),t.arc(n+e+(r-r/2),i,1,0,2*Math.PI,!0),t.arc(n+e-(r-r/2),i,1,0,2*Math.PI,!0),t.closePath(),t.fill()}},tmp=0,maxTmp=0,range=[0,0],rangeT=0,levelT=0,circles=[],eTmpText=!1,eWinLvl=!1,eLostLvl=!1,eTimeBar=!1,state=null,dgLap=0,rmRangeT=0,lvlTimer=null,inRangeTimer=null,ftir=null,lockAll=null,lvlStatus=!1,isWorldLvl=!1,savedWorlds=0,savedLifes=0,lostWorlds=0,lostLifes=0,tempRest1Text={t:"Temperature",f:"60px Sans-serif",c:"#FDFDFD"},tempRest2Text={t:"restored",f:"60px Sans-serif",c:"#FDFDFD"},touchConTxt={t:"touch to continue",f:"30px Sans-serif",c:"#D6990B"},svdWorldsTxt={t:"",dt:"saved species",f:"35px Sans-serif",c:"#F0F0F0"},timeOverText={t:"Time is over",f:"60px Sans-serif",c:"#D6990B"},tryAgainText={t:"Touch to try again",f:"45px Sans-serif",c:"#FFF"},nextLvlText={t:"Touch to try another world",f:"35px Sans-serif",c:"#FFF"};