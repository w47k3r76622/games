var numerals=["","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII"],icons={attack:["swords",25,80,1],defense:["shield",25,85,1],shamrock:["shamrock",10,70,.65],death:["skull",25,87,1]},ctx=getElement("ctx"),timer=getElement("timer"),hands=getElement("hands"),stage=getElement("stage");add(InfoArea("cpu")),add(InfoArea("player"));var playerInfo=getElement("playerinfo"),playerturn=getElement("playerturn"),playerHpBar=getElement("playerhpbar"),playerActionBar=getElement("playeractionbar"),cpuInfo=getElement("cpuinfo"),cputurn=getElement("cputurn"),cpuHpBar=getElement("cpuhpbar"),cpuActionBar=getElement("cpuactionbar");function getElement(e){return document.getElementById(e)}function add(e){ctx.appendChild(e)}var SHAMROCKS_ON_START=1,IMMORTALS=!1,SHAMROCK_AND_DEATH_TEST=!1,TIMER_DURATION=.5,SHOW_CARD_DURATION=.5,SHOW_CARD_DELAY=1,MOVE_CARD_DURATION=.4,DEATH_DURATION=3,HP_BAR_WIDTH=352,AT_BAR_WIDTH=352,sfxPick=[,,313,.02,.02,.02,1,2.4,-30,,-247,.08,,,,,,.98,.03],sfxMove=[.4,,243,.01,.05,.19,,.2,,90,,,,.1,,,,.56,.05,,100],sfxHit=[1.1,,101,.03,.05,.25,4,.6,,2,,,.04,1.3,,.1,,.75,.04,.19],sfxVanish=[,,229,.05,.21,.09,1,1.3,,,,,.03,,3.8,.1,,.56,.3,.43,305],sfxLuck=[5,,593,.03,.23,.3,,3.1,,,290,.08,.07,,,.1,,.65,.27,.12,-1406],sfxDeath=[,,418,.06,.28,.35,,2,-7,-104,-57,.1,.01,,,,,.93,.26],sfxWin=[1.8,,417,,.3,.05,3,2.7,-3,,373,.35,,.1,,,.3,.63,.09,.37];function playSound(e){zzfx(...e)}var turn=0,isActionTime=!1,stageNumber=1,playerName="Knight",playerLv=1,playerMaxHP=20,playerAttack=2,playerHP=playerMaxHP,playerActionBarDuration=10,playerActionBarAnimation=null,cpuName="Green Bomb",cpuLv=1,cpuMaxHP=10,cpuAttack=2,cpuHP=cpuMaxHP,cpuActionBarDuration=13,cpuActionBarAnimation=null,cardsInDeck=7,attackDeck=[],defenseDeck=[],playerAttackHand=[],playerLuckyHand=[],playerDefenseHand=[],cpuAttackHand=[],cpuLuckyHand=[],cpuDefenseHand=[],scale=1;function resizeWindow(){var e=window.innerWidth,a=window.innerHeight,t=ctx.offsetWidth,n=ctx.offsetHeight;scale=Math.min(e/t,a/n),ctx.style.transform=`scale(${scale})`;var r=(e-t)/2,s=(a-n)/2;ctx.style.left=`${r}px`,ctx.style.top=`${s}px`}function vibrate(e){"vibrate"in navigator&&navigator.vibrate(e)}function screenShake(){for(var e=[],a=0;a<10;a++){var t=Math.round(6*Math.random())-3,n=Math.round(6*Math.random())-3,r=Math.round(2*Math.random())-1;e.push({transform:`translate(${t}px, ${n}px) scale(${scale}) rotate(${r}deg)`})}ctx.animate(e,{duration:500}),vibrate(500)}window.onresize=resizeWindow,resizeWindow();var timerAnim=document.createElementNS("http://www.w3.org/2000/svg","animate");function updateStageInfo(){stage.innerHTML=`Stage ${stageNumber}`}function progressPlayer(){playerMaxHP=20+5*(playerLv+=1),playerAttack=6+3*playerLv}function progressCpu(){cpuLv=stageNumber+Math.round(Math.random(4*stageNumber)),cpuMaxHP=10*cpuLv,cpuAttack=4*cpuLv,cpuActionBarDuration=8+Math.round(Math.random(6))}function nextStage(){vibrate(500),stageNumber+=1,progressCpu(),resetGame()}function gameOver(){vibrate(500),stageNumber=1,progressCpu(),resetGame()}function resetGame(){updatePlayerInfo(),updateCpuInfo(),updateStageInfo(),playerHP=playerMaxHP,cpuHP=cpuMaxHP,refreshPlayerHpBar(),refreshCpuHpBar(),removeAllCards(),attackDeck=[],defenseDeck=[],playerAttackHand=[],playerLuckyHand=[],playerDefenseHand=[],cpuAttackHand=[],cpuLuckyHand=[],cpuDefenseHand=[],turn=0,isActionTime=!1,toggleTurns(),addShamrocks(SHAMROCKS_ON_START),addDecksIfEmpty(),resetTimer(),resetCpuActionBar(),resetPlayerActionBar()}function updatePlayerInfo(){playerInfo.innerHTML=`${playerName} Lv. ${playerLv}`}function updateCpuInfo(){cpuInfo.innerHTML=`${cpuName} Lv. ${cpuLv}`}function removeAllCards(){document.querySelectorAll(".card").forEach((e=>{e.remove()}))}timerAnim.setAttribute("attributeName","stroke-dashoffset"),timerAnim.setAttribute("from",360),timerAnim.setAttribute("to",0),timerAnim.setAttribute("dur",`${TIMER_DURATION}s`),timerAnim.setAttribute("fill","forwards"),timer.appendChild(timerAnim),progressCpu(),resetGame();var turnTimer=null;function resetTimer(){timerAnim.beginElement(),clearTimeout(turnTimer),turnTimer=setTimeout(onTimer,1e3*TIMER_DURATION)}function onTimer(){toggleTurns(),toggleHands(),1==turn&&CPU()}var cpuMoveTimout=null;function CPU(){if(1==isActionTime)return!1;clearTimeout(cpuMoveTimout),cpuMoveTimout=setTimeout((()=>{cpuPickCard()}),500+Math.floor(1e3*Math.random()))}function resumeCpu(){1==turn&&0==isActionTime&&CPU()}function changeTurn(){turn=(turn+1)%2}function toggleHands(){toggleTurns(),hands.style.display=0==turn?"block":"none"}function toggleTurns(){cputurn.classList.remove("active"),playerturn.classList.remove("active"),0==turn?playerturn.classList.add("active"):cputurn.classList.add("active")}function resetPlayerActionBar(){(playerActionBarAnimation=playerActionBar.animate([{width:"0px"},{width:`${AT_BAR_WIDTH}px`}],{duration:1e3*playerActionBarDuration,fill:"forwards"})).finished.then((()=>{doPlayerAction()}))}function doPlayerAction(){isActionTime=!0,pauseActionBars(),playSound(sfxPick);var e=getHandActionPoints(playerAttackHand,playerLv)-getHandActionPoints(cpuDefenseHand,cpuLv);if((e=playerAttack+(e<0?0:e))>0)if(0==playerAttackHand.length)cpuHP=cpuHP-e<0?0:cpuHP-e,playSound(sfxHit),screenShake(),refreshCpuHpBar(),removeCardsFromHand(cpuDefenseHand),0==cpuHP?(cpuHP=0,refreshCpuHpBar(),playSound(sfxWin),progressPlayer(),setTimeout(nextStage,1e3*DEATH_DURATION)):(resumeActionBars(),resetPlayerActionBar(),isActionTime=!1,resumeCpu());else for(var a in playerAttackHand){var t=playerAttackHand[a];t.style.zIndex=500,t.animate([{transform:"translate(475px, 185px) scale(0.75) rotate(-360deg)"}],{duration:800,fill:"forwards"}).finished.then((()=>{a==playerAttackHand.length-1&&(cpuHP=cpuHP-e<0?0:cpuHP-e,playSound(sfxHit),screenShake(),refreshCpuHpBar(),removeCardsFromHand(playerAttackHand),removeCardsFromHand(cpuDefenseHand),0==cpuHP?(cpuHP=0,refreshCpuHpBar(),playSound(sfxWin),progressPlayer(),setTimeout(nextStage,1e3*DEATH_DURATION)):(resumeActionBars(),resetPlayerActionBar(),isActionTime=!1,resumeCpu()))}))}else resetPlayerActionBar(),resumeActionBars(),isActionTime=!1,resumeCpu()}function refreshPlayerHpBar(){var e=Math.round(playerHP/playerMaxHP*HP_BAR_WIDTH);playerHpBar.style.width=`${e}px`}function refreshCpuHpBar(){var e=Math.round(cpuHP/cpuMaxHP*HP_BAR_WIDTH);cpuHpBar.style.width=`${e}px`}function resetCpuActionBar(){(cpuActionBarAnimation=cpuActionBar.animate([{width:"0px"},{width:`${AT_BAR_WIDTH}px`}],{duration:1e3*cpuActionBarDuration,fill:"forwards"})).finished.then((()=>{doCpuAction()}))}function doCpuAction(){isActionTime=!0,pauseActionBars(),playSound(sfxPick);var e=getHandActionPoints(cpuAttackHand,cpuLv)-getHandActionPoints(playerDefenseHand,playerLv);if((e=cpuAttack+(e<0?0:e))>0)if(0==cpuAttackHand.length)playerHP=playerHP-e<0?0:playerHP-e,playSound(sfxHit),screenShake(),refreshPlayerHpBar(),removeCardsFromHand(playerDefenseHand),0==playerHP?(playerHP=0,refreshPlayerHpBar(),playSound(sfxDeath),setTimeout(gameOver,1e3*DEATH_DURATION)):(resetCpuActionBar(),resumeActionBars(),isActionTime=!1,resumeCpu());else for(var a in cpuAttackHand){var t=cpuAttackHand[a];t.style.display="block",t.style.zIndex=500,t.animate([{transform:"translate(100px, 1000px) scale(0.75) rotate(-360deg)"}],{duration:800,fill:"forwards"}).finished.then((()=>{a==cpuAttackHand.length-1&&(playerHP=playerHP-e<0?0:playerHP-e,playSound(sfxHit),screenShake(),refreshPlayerHpBar(),removeCardsFromHand(cpuAttackHand),removeCardsFromHand(playerDefenseHand),0==playerHP?(playerHP=0,refreshPlayerHpBar(),playSound(sfxDeath),setTimeout(gameOver,1e3*DEATH_DURATION)):(resumeActionBars(),resetCpuActionBar(),isActionTime=!1,resumeCpu()))}))}else resetCpuActionBar(),resumeActionBars(),isActionTime=!1,resumeCpu()}function addShamrocks(e){for(var a=0;a<e;a++){var t=newCard("defense",12,"front"),n=playerLuckyHand.length,r=297+15*(n%2==0?-1:1),s=780-15*n;t.style.transform=`translate(${r}px, ${s}px)`,playerLuckyHand.push(t),add(t)}}function addDeck(e,a,t,n,r){for(var s=[12,12,13,13,12,13,13],i=[],o=1;o<=13;o++)i.push(o),i.push(o);for(o=0;o<a;o++){if(SHAMROCK_AND_DEATH_TEST)u=s[6-o];else{var c=Math.floor(Math.random()*i.length),u=i[c];i.splice(c,1)}var p=newCard(e,u),d=n-6*o;p.style.transform=`translate(${t}px, ${d}px)`,p.onclick=playerPickCard,r.push(p),add(p)}}function addDecksIfEmpty(){0==attackDeck.length&&addDeck("attack",cardsInDeck,150,480,attackDeck),0==defenseDeck.length&&addDeck("defense",cardsInDeck,450,480,defenseDeck)}function showCard(e,a,t){hands.style.display="none",e.style.zIndex=500,setTimeout((function(){e.classList.contains("back")&&(e.classList.remove("back"),e.classList.add("front"))}),1e3*SHOW_CARD_DURATION/2),e.animate([{transform:"translate(300px, 450px) scale(1.5)"}],{duration:1e3*SHOW_CARD_DURATION,easing:"ease-out",endDelay:1e3*SHOW_CARD_DELAY,fill:"forwards"}).finished.then((()=>{a(e,t)}))}function moveToHand(e,a,t,n,r){playSound(sfxMove),e.style.zIndex=n,e.animate([{transform:`translate(${a}px, ${t}px) scale(1) rotate(360deg)`}],{duration:1e3*MOVE_CARD_DURATION,easing:"ease-out",fill:"forwards"}).finished.then((()=>{e.style.transform=`translate(${a}px, ${t}px) scale(1) rotate(0deg)`,r()}))}function pauseActionBars(){playerActionBarAnimation.pause(),cpuActionBarAnimation.pause()}function resumeActionBars(){playerActionBarAnimation.play(),cpuActionBarAnimation.play()}function endTurn(){addDecksIfEmpty(),changeTurn(),toggleHands(),resetTimer(),resumeActionBars()}function playerPickCard(){var e="none"!=hands.style.display;if(1==turn||0==e||1==isActionTime)return!1;if(pauseActionBars(),playSound(sfxPick),vibrate(50),this.classList.contains("attack")){var a=attackDeck.pop(),t=45+35*(r=playerAttackHand.length),n=752+15*r*(r%2==0?-1:1);showCard(a,(()=>{moveToHand(a,t,n,r,(()=>{playerAttackHand.push(a),flushHandIfNeeded(playerAttackHand),endTurn()}))}))}else if(this.classList.contains("defense")){a=defenseDeck.pop(),t=472+35*(r=playerDefenseHand.length),n=752+15*r*(r%2==0?-1:1);showCard(a,(()=>{moveToHand(a,t,n,r,(()=>{playerDefenseHand.push(a),flushHandIfNeeded(playerDefenseHand),endTurn()}))}))}else if(this.classList.contains("shamrock")){var r;a=(s=getCardDeck(this)).pop(),t=297+15*((r=playerLuckyHand.length)%2==0?-1:1),n=780-15*r;showCard(a,(()=>{moveToHand(a,t,n,r,(()=>{playerLuckyHand.push(a),playSound(sfxLuck),endTurn()}))}))}else if(this.classList.contains("death")){var s=getCardDeck(this);showCard(a=s.pop(),(()=>{playerUseShamrockOrDie(a,playerLuckyHand)}))}}function cpuPickCard(){if(0==turn||1==isActionTime)return!1;pauseActionBars(),playSound(sfxPick),vibrate(50);var e=0==Math.round(Math.random(1))?attackDeck:defenseDeck,a=getHandPoints(cpuAttackHand);getHandPoints(cpuDefenseHand)<a&&(e=defenseDeck);var t=e.pop();t.classList.contains("attack")?showCard(t,(()=>{moveToHand(t,475,185,50,(()=>{cpuAttackHand.push(t),t.style.display="none",flushHandIfNeeded(cpuAttackHand),endTurn()}))})):t.classList.contains("defense")?showCard(t,(()=>{moveToHand(t,475,185,50,(()=>{cpuDefenseHand.push(t),t.style.display="none",flushHandIfNeeded(cpuDefenseHand),endTurn()}))})):t.classList.contains("shamrock")?showCard(t,(()=>{moveToHand(t,475,185,50,(()=>{cpuLuckyHand.push(t),t.style.display="none",playSound(sfxLuck),endTurn()}))})):t.classList.contains("death")&&showCard(t,(()=>{cpuUseShamrockOrDie(t,cpuLuckyHand)}),(()=>{}))}function playerUseShamrockOrDie(e,a){0==a.length?IMMORTALS?moveToHand(e,297,810,500,(()=>{playSound(sfxLuck),e.remove(),endTurn()})):(playerHP=0,refreshPlayerHpBar(),playSound(sfxDeath),setTimeout(gameOver,1e3*DEATH_DURATION)):moveToHand(e,297,810,500,(()=>{var t=a.pop();playSound(sfxLuck),t.remove(),e.remove(),endTurn()}))}function cpuUseShamrockOrDie(e,a){0==a.length?IMMORTALS?moveToHand(e,475,185,50,(()=>{playSound(sfxLuck),e.remove(),endTurn()})):(cpuHP=0,refreshCpuHpBar(),playSound(sfxWin),progressPlayer(),setTimeout(nextStage,1e3*DEATH_DURATION)):moveToHand(e,475,185,50,(()=>{var t=a.pop();playSound(sfxLuck),t.remove(),e.remove(),endTurn()}))}function getCardDeck(e){var a=e.getAttribute("deck");return"attack"==a?attackDeck:"defense"==a?defenseDeck:void 0}function getHandPoints(e){var a=0;for(var t in e)a+=1*e[t].getElementsByClassName("value")[0].textContent;return a}function getHandActionPoints(e,a){var t=0;for(var n in e)t+=.5*e[n].getElementsByClassName("value")[0].textContent*a;return t}function flushHandIfNeeded(e){getHandPoints(e)>=13&&(playSound(sfxVanish),removeCardsFromHand(e))}function removeCardsFromHand(e){for(var a=e.length,t=0;t<a;t++){e.pop().remove()}}function strToHtml(e){var a=new DOMParser;return DOM=a.parseFromString(e,"text/html"),DOM.body.childNodes[0]}function newCard(e,a=0,t="back"){var n=13==a?"death":12==a?"shamrock":e;return strToHtml(`<div class="card ${n} ${t}" deck="${e}">\n  <div class="bg">\n  <svg width="100%" height="100%">\n      <text class="value" x="6" y="17">${a}</text>\n      <text class="numeral" x="50%" y="38%">${numerals[a]}</text>\n    </svg>\n    <img class="icon" src="img/${icons[n][0]}.svg" style="transform: translate(${icons[n][1]}px, ${icons[n][2]}px) scale(${icons[n][3]})" />\n  </div>\n  <div class="${e}bg"></div>\n  <div class="pattern ${e}"></div>\n  </div>`)}function InfoArea(e){return"cpu"==e?(t=145,x=18,x2=495,y2=40,s2=1.5,x3=540,y3=235,s3=2.5,l2=78):(t=1e3,x=290,x2=40,y2=10,s2=3,x3=90,y3=-15,s3=2.5,l2=350),strToHtml(`<div id="${e}" style="left: 0px; top: ${t}px; width: 100%; height: 270px">\n    <svg width="100%" height="100%" style="position: absolute">\n      <text id="${e}info" class="name" x="${x}" y="55"></text>\n\n      <text class="info" x="${x}" y="113">HP</text>\n      <rect x="${x+56}" y="95" width="360" height="40" fill="#262c45" />\n\n      <text class="info" x="${x}" y="155">AT</text>\n      <rect x="${x+56}" y="145" width="360" height="24" fill="#262c45" />\n    </svg>\n\n    <img id="${e}image" src="img/${e}.svg" style="position: absolute; left: ${x2}px; top: ${y2}px; transform: scale(${s2}); z-index: 2;"/>\n    <img id="${e}turn" src="img/${e}turn.svg" style="position: absolute; left: ${x3}px; top: ${y3}px; transform: scale(${s3}); z-index: 3;"/>\n\n    <svg id="${e}hpbar" style="left: ${l2}px; top: 99px; width: 352px; height: 40px">\n      <rect class="hp" x="0" y="0" width="352" height="32" fill="#f00" />\n      <rect class="hp" x="0" y="0" width="352" height="8" fill="#d00" />\n    </svg>\n\n    <svg id="${e}actionbar" style="left: ${l2}px; top: 149px; width: 352; height: 18">\n      <rect x="0" y="0" width="352" height="16" fill="#ffe415" />\n      <rect x="0" y="0" width="352" height="6" fill="#e27f1b" />\n    </svg>\n  </div>`)}