class Player{constructor(t){this.id=t.id,this.index=t.index,this.name=t.name}}class Char{constructor(t){this.id=id("char"),this.owner=null,this.pos=t.pos,this.hp=100,this.directions=new Array(4).fill(0).map(()=>({dir:pick(DIRS),size:4})),this.nextDir=0,this.dir=pick(DIRS)}}class Event{constructor(t,s){this.name=t,this.data=s}}class Game{constructor(t){this.id=id("game"),t.participants=t.participants||2,t.squad=t.squad||4,this.cfg=t,this.state=null,this.players=[],this.chars=[],this.field={height:2*(t.squad+t.participants)-2,width:2*(t.squad+t.participants)-2},this.turn=0}emit(t,s){this.cfg.onevent(new Event(t,s))}changeState(t,s){"game-over"!==this.state&&(this.state=t,this.emit("state",{state:this.state,chars:this.chars,cfg:{squad:this.cfg.squad,participants:this.cfg.participants},players:this.players,field:this.field,data:s}))}isFull(){return this.players.length===this.cfg.participants}addPlayer(t,s){if(!this.state||"wait"===this.state)if(this.isFull()||this.players.push(new Player({id:t,index:this.players.length,name:s})),this.isFull()){for(let t=0;t<this.cfg.squad*(this.cfg.participants+1);t++)this.chars.push(new Char({pos:this.getRandomFreePos()}));this.changeState("pick")}else this.changeState("wait")}end(t){this.changeState("game-over",{reason:"abandon",loser:this.getPlayer(t),winner:this.players.find(s=>s.id!==t)})}getRandomPos(){return{x:rand(this.field.width-1),y:rand(this.field.height-1)}}getInPos(t){return this.chars.find(s=>s.pos.x===t.x&&s.pos.y===t.y)}getNearestEnemy(t){let s=shuffle(this.chars.filter(s=>s.owner!==t.owner)).map(s=>({dist:dist(s.pos,t.pos),char:s})).sort((t,s)=>t.dist-s.dist);if(s.length)return s[0].char}getRandomFreePos(){let t=this.getRandomPos();for(;this.getInPos(t);)t=this.getRandomPos();return t}getNewPos(t,s){let i;switch(s){case"left":i={...t,x:t.x-1};break;case"right":i={...t,x:t.x+1};break;case"up":i={...t,y:t.y-1};break;case"down":i={...t,y:t.y+1}}return i.x<0&&(i.x=this.field.width-1),i.y<0&&(i.y=this.field.height-1),i.x>=this.field.width&&(i.x=0),i.y>=this.field.height&&(i.y=0),i}getPlayer(t){return this.players.find(s=>s.id==t)}getChar(t){return this.chars.find(s=>s.id==t)}getPlayerChars(t){return this.chars.filter(s=>s.owner==t)}pick(t,s){if(this.getPlayerChars(t).length===this.cfg.squad)return;let i=this.getChar(s);if(i&&!i.owner){i.owner=t,this.emit("pick",{pid:t,pindex:this.getPlayer(t).index,cid:s,done:this.getPlayerChars(t).length===this.cfg.squad});for(let t=0;t<this.players.length;t++)if(this.getPlayerChars(this.players[t].id).length<this.cfg.squad)return;this.removeChars(),this.changeState("play"),this.turn=0,this.emit("turn",{turn:this.turn})}}async move(t,s){let i=this.getPlayer(t);if(this.turn%this.players.length!==i.index)return;let e=this.getChar(s);if(e.owner!==t)return;if(this._moving)return;this._moving=!0,this.turn++;let h=e.directions[e.nextDir];e.nextDir=(e.nextDir+1)%e.directions.length||0;let r,a=h.size,n=[];for(;a--;){let t=this.getNewPos(r||e.pos,h.dir);if(this.getInPos(t))break;r=t,n.push(t)}r&&(e.pos=r),e.dir=h.dir,this.emit("new-pos",{char:e,moves:n}),await sleep(1+n.length/2);let l=this.getNearestEnemy(e),d=isFromBack(e.pos,l.pos,l.dir),c=3*dist(e.pos,l.pos)*(d?3:1);if(l.hp=Math.max(l.hp-c,0),this.emit("attack",{char:e,enemy:l,damage:c,fromBack:d,chars:this.chars}),0===l.hp){if(await sleep(1),this.chars=this.chars.filter(t=>t.id!==l.id),this.emit("die",{enemy:l}),!this.getNearestEnemy(e))return void this.changeState("game-over",{winner:i,loser:this.getPlayer(l.owner)})}await sleep(1),this._moving=!1,this.emit("turn",{turn:this.turn})}removeChars(){this.emit("remove-chars",{chars:this.chars.filter(t=>null===t.owner)}),this.chars=this.chars.filter(t=>null!==t.owner)}}
let sockets=[],game=null;module.exports={io:e=>{let a,t=e.handshake.query.name;e.on("disconnect",()=>{console.log("disconnected",e.id,t),a&&clearTimeout(a),delete sockets[e.id],e.game.isFull()?e.game.end(e.id):game=null}),e.on("bot",()=>{let a=rand(10);e.game.addPlayer("bot"+a,"Bot-"+a),e.game.bot="bot"+a,console.log(t+" play against bot "+a)}),e.on("activate",a=>{"pick"===e.game.state?(e.game.pick(e.id,a.char),e.game.bot&&setTimeout(()=>{let a=pick(e.game.chars.filter(e=>!e.owner));a&&e.game.pick(e.game.bot,a.id)},2e3)):"play"===e.game.state&&(e.game.move(e.id,a.char),e.game.bot&&setTimeout(()=>{let a=pick(e.game.chars.filter(a=>a.hp>0&&a.owner===e.game.bot));a&&e.game.move(e.game.bot,a.id)},7e3))}),console.log("connected",e.id,t,JSON.stringify(e.handshake)),sockets[e.id]=e,game&&!game.isFull()||(game=new Game({onevent:async a=>{if(e.game.players.forEach(e=>{sockets[e.id]&&sockets[e.id].emit(a.name,a.data)}),"state"===a.name&&"game-over"===a.data.state){let e=a.data;console.log(`Game Over: ${e.data.winner.name} won against ${e.data.loser.name}. ${e.data.reason||""}`);let t=await storage.get("ranking",[]),o=t.find(a=>a.n===e.data.winner.name);o||(o={n:e.data.winner.name,p:1500,w:0,l:0},t.push(o));let n=t.find(a=>a.n===e.data.loser.name);n||(n={n:e.data.loser.name,p:1500,w:0,l:0},t.push(n)),o.w++,n.l++;let g=1/(1+Math.pow(10,(n.p-o.p)/400)),m=1/(1+Math.pow(10,(o.p-n.p)/400));o.p=Math.round(o.p+32*(1-g)),n.p=Math.round(n.p+32*(0-m)),t.sort((e,a)=>a.p!==e.p?a.p-e.p:a.w-e.w);let s=!1;for(;!s;)(s=await storage.set("ranking",t))||t.pop()}}}),console.log("new game",game.id),a=setTimeout(()=>{if("wait"===e.game.state){let a=rand(10);e.game.addPlayer("bot"+a,"Bot-"+a),e.game.bot="bot"+a,console.log(t+" autoplay against bot "+a)}},12e4)),e.game=game,game.addPlayer(e.id,t)},ranking:(e,a)=>{storage.get("ranking",[]).then(e=>{a.send(e)})}};