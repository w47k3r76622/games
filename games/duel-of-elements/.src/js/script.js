window.a={},a.v=function(t,a){this.v=t||0,this.a=a||0,this.set=function(t,a){this.v=t,this.a=a},this.add=function(t){this.x=this.v*Math.cos(this.a)+t.v*Math.cos(t.a),this.y=this.v*Math.sin(this.a)+t.v*Math.sin(t.a),this.v=Math.sqrt(this.x*this.x+this.y*this.y),this.a=Math.atan2(this.y,this.x)},this.addS=function(t,a){this.x=this.v*Math.cos(this.a)+t*Math.cos(a),this.y=this.v*Math.sin(this.a)+t*Math.sin(a),this.v=Math.sqrt(this.x*this.x+this.y*this.y),this.a=Math.atan2(this.y,this.x)},this.sub=function(t){var a=this.v*Math.cos(this.a)-t.v*Math.cos(t.a),e=this.v*Math.sin(this.a)-t.v*Math.sin(t.a);this.v=Math.sqrt(a*a+e*e),this.a=Math.atan2(e,a)},this.rot=function(t){this.a+=t,this.a>Math.PI&&(this.a-=2*Math.PI),this.a<-Math.PI&&(this.a+=2*Math.PI)}},a.util={addAng:function(t,a){return t+=a,t>Math.PI&&(t-=2*Math.PI),t<-Math.PI&&(t+=2*Math.PI),t}},a.sp={0:{p:[],d:[],bar:0,exp:[]},1:{p:[],d:[],bar:0,exp:[]},well:[[],[]]},a.canvas={elemFg:null,ctxFg:null,ctxBg:null,ratio:1,resize:function(){var t=window.innerWidth/this.w,a=window.innerHeight/this.h;t>a?(a=a>1?1:a,this.elemFg.style.height=this.h*a+"px",this.elemFg.style.width=this.w*a+"px",this.ratio=a):(t=t>1?1:t,this.elemFg.style.width=this.w*t+"px",this.elemFg.style.height=this.h*t+"px",this.ratio=t),this.elemFg.style.left=window.innerWidth/2-this.w/2*this.ratio+"px",this.elemFg.style.top=window.innerHeight/2-this.h/2*this.ratio+"px",this.rect=this.elemFg.getBoundingClientRect()},init:function(){var t=document.getElementById("c-fg");t.height=this.h=1200,t.width=this.w=800,this.w2=this.w/2,this.h2=this.h/2,this.elemFg=t,this.ctxFg=t.getContext("2d"),this.ctxFg.multiLine=function(t,a,e,s,i){var t=t.split("\n"),n=parseInt(this.font.match(/\d{1,3}/))*s;t.forEach(function(s,h){this[i](s,a,e-n*((t.length-1)/2)+h*n)},this)},t=document.createElement("canvas"),t.height=this.h,t.width=this.w,this.ctxBg=t.getContext("2d"),this.resize(),window.addEventListener("resize",function(){a.canvas.resize()}),this.extendFn(this.ctxFg),this.extendFn(this.ctxBg),this.drawBg(),this.bgImg=new Image,this.bgImg.src=a.sp.bg=t.toDataURL(),this.elemFg.style.backgroundSize="cover"},extendFn:function(t){t.roundRect=function(t,a,e,s,i,n,h){this.beginPath(),this.moveTo(t+i,a),this.lineTo(t+e-i,a),this.quadraticCurveTo(t+e,a,t+e,a+i),this.lineTo(t+e,a+s-i),this.quadraticCurveTo(t+e,a+s,t+e-i,a+s),this.lineTo(t+i,a+s),this.quadraticCurveTo(t,a+s,t,a+s-i),this.lineTo(t,a+i),this.quadraticCurveTo(t,a,t+i,a),this.closePath(),h&&this.stroke(),n&&this.fill()}},clr:function(){this.ctxFg.clearRect(0,0,this.w,this.h)},drawBg:function(){var t=this.ctxBg;t.lineWidth=5,t.strokeStyle="#b43535",t.roundRect(10,25,this.w-20,this.h/2-40,5,0,1),t.strokeStyle="#42a2a2",t.roundRect(10,this.h/2+20,this.w-20,this.h/2-40,5,0,1),t.fillStyle="#000",t.beginPath(),t.fillRect(25,5,this.w-50,40),t.fillRect(25,this.h-45,this.w-50,40)},shapeDefs:[{ang:0,fi:5},{ang:.6283185307179586,fi:3},{ang:1.2566370614359172,fi:16},{ang:1.8849555921538759,fi:10},{ang:2.5132741228718345,fi:7},{ang:3.141592653589793,fi:15},{ang:3.7699111843077517,fi:14},{ang:4.39822971502571,fi:12},{ang:5.026548245743669,fi:19},{ang:5.654866776461628,fi:0}],initSprites:function(){this.drawBatt(),this.drawPlasma(0,this.shapeDefs),this.drawPlasma(1,this.shapeDefs),this.drawDef(0),this.drawDef(1),this.drawBar(0),this.drawBar(1),this.drawWell(0),this.drawWell(1)},colors:{fire:["#ae0000","#cb0000","#ec0000","#ff0303","#ff5303","#ff9416","#ffd52e"]},drawPlasma:function(t,e){var s=document.createElement("canvas");s.height=128,s.width=128;var i=s.getContext("2d");i.lineWidth=2,i.fillStyle="#befcff",i.strokeStyle="#a2f7fa";for(var n=0;20>n;n++){for(var h=0;10>h;h++){var r=n+e[h].fi;e[h].fr=r>19?r-=19:r}var o=e.sort(function(t,a){return t.fr<a.fr?-1:t.fr>a.fr?1:0});i.clearRect(0,0,s.width,s.height),i.save(),i.globalAlpha=.8,i.translate(s.width/2,s.height/2);for(var h=0;10>h;h++){if(i.save(),t)i.fillStyle=this.colors.fire[6-Math.round(o[h].fr/19*6)],i.beginPath(),i.arc((7+o[h].fr/19*20)*Math.cos(o[h].ang)+2*Math.cos(2*Math.PI/19*4*h)*Math.sin(o[h].ang),(7+o[h].fr/19*20)*Math.sin(o[h].ang)+2*Math.sin(2*Math.PI/19*4*h)*Math.sin(Math.PI/2+o[h].ang),15-Math.round(o[h].fr/19*12),0,6.3),i.fill();else{i.globalAlpha=.9-e[h].fr/19*.4,i.translate((3+e[h].fr/19*20)*Math.cos(e[h].ang),(3+e[h].fr/19*20)*Math.sin(e[h].ang)),i.rotate(3*e[h].ang-.5*Math.PI*e[h].fr/19),i.beginPath();var l=18-Math.round(e[h].fr/19*12);i.rect(-l/2,-l/2,l,l),i.fill(),i.stroke()}i.restore()}var c=new Image;c.src=s.toDataURL(),a.sp[t].p[n]=c,i.restore()}for(var n=0;20>n;n++){i.clearRect(0,0,s.width,s.height),i.save(),i.translate(s.width/2,s.height/2),i.globalAlpha=1-n/19;for(var h=0;10>h;h++)if(t)i.fillStyle=this.colors.fire[6-Math.round(e[h].fr/19*6)],i.beginPath(),i.arc((7+1.5*n+e[h].fr/19*20)*Math.cos(e[h].ang),(7+1.5*n+e[h].fr/19*20)*Math.sin(e[h].ang),15-Math.round(e[h].fr/19*12),0,6.3),i.fill();else{i.save(),i.translate((3+1.5*n+e[h].fr/19*20)*Math.cos(e[h].ang),(3+1.5*n+e[h].fr/19*20)*Math.sin(e[h].ang)),i.beginPath();var l=18-Math.round(e[h].fr/19*12);i.rect(-l/2,-l/2,l,l),i.fill(),i.stroke(),i.restore()}var c=new Image;c.src=s.toDataURL(),a.sp[t].exp[n]=c,i.restore()}},drawDef:function(t){var e=document.createElement("canvas");e.height=64,e.width=840;for(var s=e.getContext("2d"),i=[],n=0;160>n;n++)i.push({x:n,ang:2*Math.PI*Math.random(),fi:Math.round(19*Math.random())});s.lineWidth=2,s.fillStyle="#befcff",s.strokeStyle="#a2f7fa";for(var h=0;20>h;h++){for(var n=0;160>n;n++){var r=h+i[n].fi;i[n].fr=r>19?r-=19:r}{i.sort(function(t,a){return t.fr<a.fr?-1:t.fr>a.fr?1:0})}s.clearRect(0,0,e.width,e.height),s.save(),t&&(s.save(),s.beginPath(),s.globalAlpha=1,s.shadowBlur=10,s.shadowColor=this.colors.fire[6],s.lineWidth=7,s.strokeStyle=this.colors.fire[6],s.lineCap="round",s.moveTo(20,32),s.lineTo(820,32),s.stroke(),s.restore()),s.globalAlpha=.6;for(var n=0;100>n;n++){if(s.save(),t)s.beginPath(),s.fillStyle=this.colors.fire[6-Math.round(i[n].fr/19*6)],s.arc(20+5*i[n].x,32+3*Math.sin((2*(1&i[n].x)-1)*Math.PI*i[n].fr/19),10-Math.round(i[n].fr/19*8),0,6.3),s.fill();else{s.globalAlpha=.9-i[n].fr/19*.4,s.translate(20+5*i[n].x,32+3*Math.sin((2*(1&i[n].x)-1)*Math.PI*i[n].fr/19)),s.rotate(i[n].ang),s.beginPath();var o=12-Math.round(i[n].fr/19*8);s.rect(-o/2,-o/2,o,o),s.fill(),s.stroke()}s.restore()}s.restore();var l=new Image;l.src=e.toDataURL(),a.sp[t].d[h]=l}},drawBar:function(t){var e=document.createElement("canvas");e.height=64,e.width=800;var s=e.getContext("2d");a.canvas.extendFn(s),s.fillStyle=t?"#42a2a2":"#b43535";for(var i=0;40>i;i++)s.roundRect(0+18.5*i,0,16,36,3,1,0);var n=new Image;n.src=e.toDataURL(),a.sp[t].bar=n},circSwitch:function(t,a,e,s,i,n,h,r,o,l){t.save(),t.translate(a,e),t.beginPath(),t.arc(0,0,s+n/2+10,0,6.3),t.stroke(),t.beginPath(),t.arc(0,0,s-n/2-10,0,6.3),t.stroke();var c=6.29/h.length;h.forEach(function(a,e){if(t.beginPath(),t.arc(0,0,s,0+e*c+.08+i,c+e*c-.08+i),t.strokeStyle=a.st?r:o,t.lineWidth=n,t.stroke(),a.txt&&a.txt.length){t.beginPath(),t.strokeStyle=o,t.lineWidth=3;var h=e*c+c/2+i;t.moveTo((s+n/2+10)*Math.cos(h),(s+n/2+10)*Math.sin(h)),t.lineTo((s+n/2+20)*Math.cos(h),(s+n/2+20)*Math.sin(h)),t.stroke();var l=h>1.57&&4.71>h;t.textAlign=l?"right":"left",t.multiLine(a.txt,(l?-10:10)+(s+n/2+20)*Math.cos(h),(s+n/2+20)*Math.sin(h),1.1,"fillText")}},this),t.textAlign="center",t.multiLine(l,0,0,1.1,"fillText"),t.restore()},drawWell:function(t){var e=document.createElement("canvas");e.height=128,e.width=128;var s=e.getContext("2d");s.fillStyle=t?"#f0f":"#0f7";for(var i=0;20>i;i++){s.clearRect(0,0,e.width,e.height);var n=15;s.save(),s.translate(e.width/2,e.height/2);for(var h=20,r=0;h>r;r++){s.save();var o=9.5*(1+Math.sin(2*Math.PI/19*r*5))+i;o>19?o-=19:o,s.globalAlpha=Math.sin(Math.PI/19*(19-o));var l=10-o/19*7;s.fillRect(3*(n-o/19*n)*Math.cos(2*Math.PI/h*r),3*(n-o/19*n)*Math.sin(2*Math.PI/h*r),l,l),s.restore()}var c=new Image;c.src=e.toDataURL(),a.sp.well[t][i]=c,a.sp.well[t][20+i]=c,s.restore()}},drawBatt:function(){var t=document.createElement("canvas");t.height=128,t.width=1e3;var e=t.getContext("2d");this.extendFn(e),e.lineWidth=3;for(var s=0;11>s;s++)e.save(),e.translate(90*s,0),e.strokeStyle="#42a2a2",e.fillStyle="#42a2a2",e.roundRect(2,12,6,20,3,1,0),e.roundRect(8,2,80,40,5,0,1),e.fillRect(83-7*s,7,7*s,30),e.restore(),e.save(),e.translate(90*s,64),e.strokeStyle="#b43535",e.fillStyle="#b43535",e.roundRect(82,12,6,20,3,1,0),e.roundRect(2,2,80,40,5,0,1),e.fillRect(7,7,7*s,30),e.restore();var i=new Image;i.src=t.toDataURL(),a.sp.batt=i}},a.touch={touches:{},events:{tStart:["touchstart","MSPointerDown","pointerdown"],tMove:["touchmove","MSPointerMove","pointermove"],tEnd:["touchend","MSPointerUp","pointerup"]},buttons:[{x:170,y:855,r:75,val:1,fn:"speed"},{x:335,y:930,r:75,val:2,fn:"speed"},{x:155,y:1030,r:75,val:0,fn:"speed"},{x:725,y:955,r:120,val:0,fn:"levels"},{x:500,y:820,r:120,val:1,fn:"levels"},{x:720,y:700,r:120,val:2,fn:"levels"},{x:475,y:1075,r:80,val:1,fn:"tutorial"},{x:405,y:495,r:150,val:1,fn:"start"}],adjX:function(t){return this.tempX=(t-a.canvas.rect.left)/a.canvas.ratio,this.tempX<0&&(this.tempX=0),this.tempX>a.canvas.w&&(this.tempX=a.canvas.w),this.tempX},adjY:function(t){return this.tempY=(t-a.canvas.rect.top)/a.canvas.ratio,this.tempY<0&&(this.tempY=0),this.tempY>a.canvas.h&&(this.tempY=a.canvas.h),this.tempY},tStart:function(t){t.preventDefault&&t.preventDefault(),t.preventManipulation&&t.preventManipulation(),t.changedTouches||(t.changedTouches=[t]);for(var a=0;a<t.changedTouches.length;a++){var e=void 0!==t.changedTouches[a].identifier?t.changedTouches[a].identifier:void 0!==t.changedTouches[a].pointerId?t.changedTouches[a].pointerId:1;this.touches[e]={startX:this.adjX(t.changedTouches[a].pageX),startY:this.adjY(t.changedTouches[a].pageY),x:this.adjX(t.changedTouches[a].pageX),y:this.adjY(t.changedTouches[a].pageY)}}},tMove:function(t){t.preventDefault&&t.preventDefault(),t.preventManipulation&&t.preventManipulation(),t.changedTouches||(t.changedTouches=[t]);for(var a=0;a<t.changedTouches.length;a++){var e=void 0!==t.changedTouches[a].identifier?t.changedTouches[a].identifier:void 0!==t.changedTouches[a].pointerId?t.changedTouches[a].pointerId:1;this.touches[e]||(this.touches[e]={}),this.touches[e].x=this.adjX(t.changedTouches[a].pageX),this.touches[e].y=this.adjY(t.changedTouches[a].pageY)}},tEnd:function(t){if(t.preventDefault&&t.preventDefault(),t.preventManipulation&&t.preventManipulation(),t.changedTouches||(t.changedTouches=[t]),1==a.app.sta&&!a.app.trans&&!a.app.tutMode)for(var e=0;e<t.changedTouches.length;e++){var s=void 0!==t.changedTouches[e].identifier?t.changedTouches[e].identifier:void 0!==t.changedTouches[e].pointerId?t.changedTouches[e].pointerId:1,i=this.touches[s].x-this.touches[s].startX,n=this.touches[s].y-this.touches[s].startY,h=Math.atan2(n,i),r=Math.abs(i),o=Math.abs(n);if(r>2*o){for(var l=0;l<a.pool.defend.length&&a.pool.defend[l]&&a.pool.defend[l].state;l++);var c=this.touches[s].startY<a.canvas.h/2?1:0;a.pool.objCnt[c]&&l<a.pool.defend.length&&(this.touches[s].startY<a.canvas.h/2-30&&this.touches[s].y<a.canvas.h/2-30||this.touches[s].startY>a.canvas.h/2+30&&this.touches[s].y>a.canvas.h/2+30)?a.pool.defend[l].init(this.touches[s].startX,this.touches[s].startY,this.touches[s].x,this.touches[s].y,c,0>i):a.sfx.audioSupport&&a.sfx.playFailSnd()}if(o>2*r){for(var l=0;l<a.pool.balls.length&&a.pool.balls[l]&&a.pool.balls[l].state;l++);var c=this.touches[s].y<a.canvas.h/2?1:0;a.pool.objCnt[c]&&l<a.pool.balls.length&&(this.touches[s].startY<a.canvas.h/2-30&&this.touches[s].y<a.canvas.h/2-30||this.touches[s].startY>a.canvas.h/2+30&&this.touches[s].y>a.canvas.h/2+30)?a.pool.balls[l].init(this.touches[s].x,this.touches[s].y,h,c):a.sfx.audioSupport&&a.sfx.playFailSnd()}this.touches[s]={}}if(0==a.app.sta&&!a.app.trans&&t.changedTouches[0]){var i=this.adjX(t.changedTouches[0].pageX),n=this.adjY(t.changedTouches[0].pageY);this.buttons.forEach(function(t){if((t.x-i)*(t.x-i)+(t.y-n)*(t.y-n)<t.r*t.r)switch(t.fn){case"tutorial":a.app.startTutorial(),a.app.nextState();break;case"start":a.app.nextState();break;default:this.changeSetting(t.val,t.fn)}},this)}2!=a.app.sta||a.app.trans||a.app.nextState()},changeSetting:function(t,e){a.app.menu[e].forEach(function(a,e){a.st=e==t?1:0})},init:function(){var t=document.getElementById("c-fg");for(var a in this.events)this.events[a].forEach(function(e){t.addEventListener(e,this[a].bind(this))},this)}},a.anim={T1:0,T2:0,dT:0,cnt:0,fps:0,fpsAvg:0,calcDT:function(t){this.T1=this.T2,this.T2=t,this.dT=(this.T2-this.T1)/1e3,this.dT>.1&&(this.dT=.1),this.fps+=1/this.dT,this.cnt++,100==this.cnt&&(this.cnt=0,this.fpsAvg=Math.round(this.fps/100),this.fpsAvg>60&&(this.fpsAvg=60),this.fps=0)}},a.sfx={init:function(){var t=0;try{for(var a=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),e=a.createBuffer(1,44100,44100),s=e.getChannelData(0),i=0;i<s.length;i++)s[i]=2*Math.random()-1;for(this.noise=a.createBufferSource(),this.noise.loop=!0,this.noise.buffer=e,this.zzzzOsc=a.createOscillator(),this.zzzzOsc.frequency.value=80,this.zzzzOsc.type="sawtooth",this.bigPre=a.createGain(),this.bigPre.gain.value=0,this.bigOsc=a.createOscillator(),this.bigOsc.frequency.value=30,this.bigOsc.type="triangle",this.zzzzFilter=a.createBiquadFilter(),this.zzzzFilter.frequency.value=600,this.zzzzFilter.type="bandpass",this.expLp1=a.createBiquadFilter(),this.expLp1.frequency.value=500,this.expLp1.type="lowpass",this.lchLp1=a.createBiquadFilter(),this.lchLp1.frequency.value=1e3,this.lchLp1.type="lowpass",this.bigLp1=a.createBiquadFilter(),this.bigLp1.frequency.value=300,this.bigLp1.type="lowpass",this.dComp=a.createDynamicsCompressor(),this.zzzzFilter.connect(this.dComp),this.noise.connect(this.bigPre),this.bigOsc.connect(this.bigPre.gain),this.bigLp1.connect(this.dComp),this.expLp1.connect(this.dComp),this.lchLp1.connect(this.dComp),this.dComp.connect(a.destination),this.failSnd=[],i=0;5>i;i++){var n={osc:a.createOscillator(),amp:a.createGain(),play:function(){var t=a.currentTime;this.amp.gain.cancelScheduledValues(t),this.amp.gain.setValueAtTime(0,t),this.amp.gain.linearRampToValueAtTime(.3,t+.1),this.amp.gain.exponentialRampToValueAtTime(.01,t+.35),this.amp.gain.setValueAtTime(0,t+.36),this.osc.frequency.cancelScheduledValues(t),this.osc.frequency.setValueAtTime(200,t),this.osc.frequency.exponentialRampToValueAtTime(100,t+.35)}};n.osc.type="triangle",n.amp.gain.value=0,n.osc.connect(n.amp),n.amp.connect(this.dComp),this.failSnd.push(n)}}catch(h){t=1}return t},start:function(){this.noise.start(0),this.bigOsc.start(0),this.zzzzOsc.start(0),this.failSnd.forEach(function(t){t.osc.start(0)})},playFailSnd:function(){for(var t=0;5>t&&this.failSnd[t].amp.gain.value;t++);5>t&&a.sfx.failSnd[t].play()}},a.app={shake:{0:0,1:0},animT:0,animFr:0,animRot:0,firstRun:20,sta:0,trans:0,transCnt:0,featureDetect:function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;var t=document.documentElement;return t.fullScr=t.requestFullscreen||t.msRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen,this.features=[!!("ontouchstart"in window||navigator.maxTouchPoints||navigator.msMaxTouchPoints),!!document.documentElement.fullScr,!!window.requestAnimFrame,!!document.createElement("canvas").getContext,!(!window.AudioContext&&!window.webkitAudioContext||a.sfx.init())],this.features.push(this.features[0]&&this.features[2]&&this.features[3]),this.features.forEach(function(t,a){t?0:document.querySelectorAll("#str .feat div")[a].style.display="block"}),this.features[5]},start:function(){if(!this.featureDetect())return document.querySelector("#str>p").style.display="none",!1;a.canvas.init(),a.canvas.initSprites(),a.sfx.audioSupport=this.features[4],document.querySelector("button").addEventListener("click",function(){document.documentElement.fullScr&&document.documentElement.fullScr(),document.querySelector("#str").style.display="none",document.querySelector("#c-fg").style.display="block",a.app.trans=1,a.touch.init(),a.sfx.audioSupport&&a.sfx.start(),clearInterval(a.app.imgAnim),document.body.removeChild(document.querySelector("#str")),a.app.animloop(),a.canvas.resize()},this),document.querySelector("button").style.display="block",document.querySelector("#str>p").style.display="none",this.imgCnt=0;for(var t,e=0;20>e;e++)t=document.createElement("img"),t.src=a.sp[0].p[e].src,document.querySelector("#i span").appendChild(t),t=document.createElement("img"),t.src=a.sp[1].p[e].src,document.querySelector("#f span").appendChild(t);this.imgAnim=setInterval(function(){document.querySelector("#i span").style.top=-64*a.app.imgCnt+"px",document.querySelector("#f span").style.top=-64*a.app.imgCnt+"px",a.app.imgCnt++,20==a.app.imgCnt&&(a.app.imgCnt=0),document.querySelector("#i").style.display=document.querySelector("#f").style.display="block"},100)},nextState:function(){this.trans=2,this.showHideBg()},doTrans:function(t){this.transCnt+=t,this.transCnt>1&&(this.transCnt=0,1==this.trans&&(this.trans=0),2==this.trans&&(this.trans=1,this.sta++,this.tutMode&&2==this.sta&&(this.tutMode=0,this.sta=0),this.animT=0,this.animFr=0,this.animRot=0,this.done=0,this.sta>2&&(this.sta=0),1==this.sta&&(a.pool.init(20,20,5,a.app.menu.speed[0].st&&400||a.app.menu.speed[1].st&&600||a.app.menu.speed[2].st&&800),a.ply.reset(),this.kickerTimer=5,a.pool.objCnt=[10,10])),this.showHideBg())},showHideBg:function(){1==this.sta&&0==this.trans?(a.canvas.elemFg.style.background="no-repeat 0 0 url('"+a.sp.bg+"')",a.canvas.elemFg.style.backgroundSize="cover"):a.canvas.elemFg.style.background="none"},animloop:function(t){a.app.firstRun?a.app.firstRun--:(a.anim.calcDT(t),a.app.drawFrame(a.anim.dT)),window.requestAnimFrame(a.app.animloop)},collision:function(){a.pool.balls.forEach(function(t,e){1==t.state&&a.pool.balls.forEach(function(a,s){1==a.state&&s>e&&(t.x-a.x)*(t.x-a.x)+(t.y-a.y)*(t.y-a.y)<(t.r+a.r)*(t.r+a.r)&&(t.explode(),a.explode())},this)},this),a.pool.defend.forEach(function(t){1==t.state&&a.pool.balls.forEach(function(e){if(1==e.state){var s=2*e.r*Math.cos(t.a),i=2*e.r*Math.sin(t.a);t.se.set(Math.sqrt((t.endX-t.startX+s)*(t.endX-t.startX+s)+(t.endY-t.startY+i)*(t.endY-t.startY+i)),Math.atan2(t.endY-t.startY+i,t.endX-t.startX+s)),t.sb.set(Math.sqrt((e.x-t.startX)*(e.x-t.startX)+(e.y-t.startY)*(e.y-t.startY)),Math.atan2(e.y-t.startY,e.x-t.startX)),t.eb.set(Math.sqrt((e.x-t.endX)*(e.x-t.endX)+(e.y-t.endY)*(e.y-t.endY)),Math.atan2(e.y-t.endY,e.x-t.endX)),t.angS=a.util.addAng(t.sb.a,-t.se.a),t.angE=a.util.addAng(t.eb.a,-t.se.a),t.dist=Math.sin(t.angS)*t.sb.v,Math.abs(t.dist)<e.r&&Math.abs(Math.cos(t.angS)*t.sb.v)+Math.abs(Math.cos(t.angE)*t.eb.v)<=t.se.v&&(e.explode(),t.hit())}},this)},this)},move:function(t){a.pool.balls.forEach(function(a){a.state&&a.move(t)},this),a.pool.defend.forEach(function(a){a.state&&a.move(t)},this),a.pool.grav.forEach(function(a){a.state&&a.move(t)},this)},drawFrame:function(t){switch(a.canvas.clr(),this.animT+=t,this.animT>.05&&(this.animT-=.05,this.animFr++,40==this.animFr&&(this.animFr=0)),this.animRot+=t/2,this.animRot>2*Math.PI&&(this.animRot-=2*Math.PI),this.sta){case 0:this.startPage(t);break;case 1:if(this.move(t),this.collision(),this.drawObj(t),this.tutMode&&this.tutorial(t),!this.tutMode&&!a.app.menu.levels[0].st&&(this.kickerTimer-=t,this.kickerTimer<0)){this.kickerTimer=5+3*Math.random();for(var e=0;e<a.pool.grav.length&&a.pool.grav[e]&&a.pool.grav[e].state;e++);a.pool.grav[e]&&a.pool.grav[e].init(a.app.menu.levels[1].st?0:Math.round(Math.random()))}break;case 2:this.endPage(t)}this.shake[0]>0&&(this.shake[0]-=t,this.shake[0]<0&&(this.shake[0]=0)),this.shake[1]>0&&(this.shake[1]-=t,this.shake[1]<0&&(this.shake[1]=0)),this.trans&&this.doTrans(t)},tutorialData:[{t:1,dir:0,v:0,a:0,text:"",pointerOff:1},{t:2,dir:0,v:90,a:0,text:"Two players sit face-to-face across a single device"},{t:2,dir:3.14,v:90,a:0,text:"^",x:100,y:250},{t:1,dir:-1.4,v:0,a:0,text:"",x:250,y:900},{t:1,dir:-1.4,v:150,a:-Math.PI/2,text:"Swipe vertically to attack your enemy"},{t:3,dir:-1.4,v:0,a:0,text:"^",fn:function(){a.pool.balls[0].init(250,750,-Math.PI/2,0)}},{t:1,dir:1.57,v:150,a:1.57,text:"^",x:300,y:250},{t:3,dir:1.57,v:0,a:0,text:"^",fn:function(){a.pool.balls[0].init(300,400,Math.PI/2,1)}},{t:2,dir:3.14,v:150,a:0,text:"Swipe horizontally to create a shield",x:300,y:250},{t:1,dir:3.14,v:0,a:0,text:"^",fn:function(){a.pool.defend[1].init(300,250,600,250,1,0)}},{t:2.5,dir:0,v:150,a:0,text:"^",x:150,y:900},{t:1,dir:0,v:0,a:0,text:"^",fn:function(){a.pool.defend[0].init(150,900,525,900,0,0)}},{t:1,dir:0,v:0,a:0,text:"Shields decrease with time and \nsuccessfully defended attacks"},{t:1,dir:1.57,v:150,a:1.57,text:"^",x:300,y:250},{t:3,dir:1.57,v:0,a:0,text:"^",fn:function(){a.pool.balls[0].init(300,400,Math.PI/2,1)}},{t:1,dir:1.57,v:150,a:1.57,text:"^",x:300,y:250},{t:2,dir:1.57,v:0,a:0,text:"Health levels decrease with successful attacks",fn:function(){a.pool.balls[0].init(300,400,Math.PI/2,1)}},{t:2,dir:-3.14,v:150,a:0,text:"^",x:100,y:1160},{t:2,dir:-3.14,v:0,a:0,text:"^"},{t:1,dir:0,v:90,a:0,text:"Each active weapon or shield consumes battle energy\nYou can attack and defend as long as you have \nbattle energy",x:650,y:650},{t:4,dir:0,v:0,a:0,text:"^"},{t:1,dir:0,v:0,a:0,text:"Random gravity wells will deflect attacks\nThey can be tricky... ;-)",x:500,y:580},{t:2,dir:0,v:0,a:0,text:"^",fn:function(){a.pool.grav[0].init(1,500,500)}},{t:1,dir:1.57,v:150,a:-Math.PI/2,text:"^",x:300,y:900},{t:4,dir:1.57,v:0,a:0,text:"^",fn:function(){a.pool.balls[0].init(300,750,-Math.PI/2,0)}},{t:2,dir:0,v:0,a:0,text:"Enjoy the game!"},{t:1,dir:0,v:0,a:0,text:"",fn:function(){a.app.nextState()},hide:1}],startTutorial:function(){this.tutTime=0,this.tutTimeSum=0,this.tutTimeTotal=0,this.tutX=150,this.tutY=900,this.tutIdx=0,this.tutMode=1,this.tutorialData.forEach(function(t){this.tutTimeSum+=t.t},this)},tutorial:function(t){var e=a.canvas.ctxFg,s=this.tutorialData[this.tutIdx];"^"==s.text&&(s.text=this.tutorialData[this.tutIdx-1].text),s.hide||(e.save(),e.beginPath(),e.font="18pt Trebuchet MS",e.textAlign="left",e.textBaseline="middle",e.fillStyle="#e0e0e0",e.strokeStyle="#d0d0d0",e.lineWidth=2,e.save(),e.globalAlpha=.2,e.beginPath(),e.roundRect(100,1e3,600,115,5,1,1),e.moveTo(110,1095),e.lineTo(690,1095),e.stroke(),e.fillStyle="#fff",e.fillRect(110+580*this.tutTimeTotal/this.tutTimeSum,1088,7,14),e.restore(),e.multiLine(s.text,110,1050,1.1,"fillText"),e.restore(),s.pointerOff||(e.save(),e.beginPath(),e.lineJoin="miter",e.strokeStyle="#0effe2",e.fillStyle="#1f6e65",e.shadowBlur=10,e.shadowColor="#0effe2",e.lineCap="butt",e.lineWidth=3,e.translate(Math.round(this.tutX),Math.round(this.tutY)),e.save(),e.rotate(s.dir),e.translate(-35,-15),e.moveTo(28,67),e.bezierCurveTo(23,58,20,46,19,42),e.bezierCurveTo(21,41,23,40,25,43),e.bezierCurveTo(27,45,30,53,33,51),e.bezierCurveTo(34,45,32,22,34,15),e.bezierCurveTo(37,14,39,14,40,15),e.bezierCurveTo(41,22,40,29,41,36),e.bezierCurveTo(46,40,55,39,59,44),e.bezierCurveTo(60,52,59,59,56,67),e.bezierCurveTo(48,68,33,68,28,67),e.closePath(),e.fill(),e.stroke(),e.restore(),e.restore())),this.tutTime+=t,this.tutTimeTotal+=t,this.tutX+=s.v*t*Math.cos(s.a),this.tutY+=s.v*t*Math.sin(s.a),this.tutTime>s.t&&(this.tutIdx++,this.tutTime=0,this.tutorialData[this.tutIdx]&&this.tutorialData[this.tutIdx].x&&(this.tutX=this.tutorialData[this.tutIdx].x,this.tutY=this.tutorialData[this.tutIdx].y),this.tutIdx==this.tutorialData.length||this.tutorialData[this.tutIdx].fn&&this.tutorialData[this.tutIdx].fn())},drawObj:function(){var t=a.canvas.ctxFg;if(t.save(),2==this.trans&&(t.translate(a.canvas.w2,a.canvas.h2),t.scale(this.transCnt>.5?1-2*(this.transCnt-.5):1,this.transCnt<.5?1-2*this.transCnt:.005),t.translate(-a.canvas.w2,-a.canvas.h2),t.beginPath(),t.fillStyle="rgba(255,255,255,"+this.transCnt+")",t.fillRect(0,0,a.canvas.w,a.canvas.h)),t.save(),1==this.trans&&(t.translate(0,a.canvas.h2),t.scale(1,this.transCnt<.5?2*this.transCnt:1)),this.trans&&t.drawImage(a.canvas.bgImg,0,0,a.canvas.w,a.canvas.h,0,1==this.trans?-a.canvas.h2:0,a.canvas.w,a.canvas.h),t.restore(),t.save(),1==this.trans&&t.translate(0,300*(1-this.transCnt)),a.ply[0].len&&t.drawImage(a.sp[1].bar,0,0,a.ply[0].len,36,30+(a.app.shake[0]?3*Math.sin(2*Math.PI*this.animT*10):0),a.canvas.h-39,a.ply[0].len,36),t.restore(),t.save(),1==this.trans&&t.translate(0,-300*(1-this.transCnt)),a.ply[1].len&&t.drawImage(a.sp[0].bar,0,0,a.ply[1].len,36,a.canvas.w-30-a.ply[1].len+(a.app.shake[1]?3*Math.sin(2*Math.PI*this.animT*10):0),5,a.ply[1].len,36),t.restore(),1==this.trans){var e=Math.ceil((this.transCnt-.8)/.02);a.pool.objCnt[0]=a.pool.objCnt[1]=e>0?e:0}t.drawImage(a.sp.batt,90*a.pool.objCnt[0],0,90,60,a.canvas.w-108,a.canvas.h2+28,90,60),t.drawImage(a.sp.batt,90*a.pool.objCnt[1],64,90,60,18,a.canvas.h2-67,90,60),a.pool.grav.forEach(function(a){a.state&&a.draw(t,this.animFr)},this),a.pool.balls.forEach(function(a){a.state&&a.draw(t,this.animFr,this.animRot)},this),a.pool.defend.forEach(function(a){a.state&&a.draw(t,this.animFr)},this),t.beginPath(),t.restore()},menu:{levels:[{txt:"easy",st:1},{txt:"medium"},{txt:"hard"}],speed:[{txt:"slow",st:1},{txt:"medium"},{txt:"fast"}]},startPage:function(){var t=a.canvas.ctxFg;t.save(),t.strokeStyle="#adeaff",t.lineWidth=5,t.textAlign="center",t.textBaseline="middle",t.fillStyle="#adeaff",t.save(),t.translate(a.canvas.w2,a.canvas.h2-100),2==this.trans&&(t.globalAlpha=1-this.transCnt),1==this.trans&&(t.globalAlpha=this.transCnt),t.beginPath(),t.moveTo(-300,-350),t.lineTo(300,-350),t.moveTo(0,120),t.lineTo(0,220),t.moveTo(0,-120),t.lineTo(0,-220),t.moveTo(120,0),t.lineTo(220,0),t.moveTo(-120,0),t.lineTo(-220,0),t.stroke(),t.beginPath(),t.strokeStyle="#000",t.lineWidth=40,t.arc(0,0,170,0,6.3,0),t.stroke(),t.beginPath(),t.strokeStyle="#adeaff",t.lineWidth=5,t.arc(0,0,190,0,6.3,0),t.moveTo(150,0),t.arc(0,0,150,0,6.3,0),t.stroke(),t.save(),t.rotate(.3145*this.animFr),t.beginPath(),t.lineWidth=20;for(var e=0,s=.3145;20>e;e++)t.beginPath(),t.strokeStyle=10>e?"rgba(138,255,214,"+(e-5)/5+")":"rgba(253,122,122,"+(e-15)/5+")",t.arc(0,0,170,0+e*s+.03,s+e*s-.03),t.stroke();t.restore(),t.beginPath(),t.font="30pt bold Trebuchet MS",t.fillText("S T A R T",0,0),t.restore(),t.font="small-caps 32pt Trebuchet MS",t.save(),2==this.trans&&t.translate(-1e3*this.transCnt,0),1==this.trans&&t.translate(1500*(1-this.transCnt),0);var i="Duel of Elements";t.beginPath(),t.save(),t.fillStyle="#fd7a7a",t.translate(a.canvas.w2,110),t.rotate(Math.PI),t.fillText(i,0,0),t.restore(),t.restore(),t.save(),2==this.trans&&t.translate(1e3*this.transCnt,0),1==this.trans&&t.translate(-1500*(1-this.transCnt),0),t.beginPath(),t.fillText(i,a.canvas.w2,190),t.restore(),t.save(),2==this.trans&&t.translate(0,1e3*this.transCnt),1==this.trans&&t.translate(0,1500*(1-this.transCnt)),t.translate(475,1075),t.beginPath(),t.arc(0,0,80,0,6.3),t.moveTo(60,0),t.arc(0,0,60,0,6.3),t.stroke(),t.beginPath(),t.font="small-caps 20pt Trebuchet MS",t.fillText("Tutorial",0,0),t.restore(),t.font="20pt Trebuchet MS",t.save(),2==this.trans&&t.translate(1e3*this.transCnt,0),1==this.trans&&t.translate(1500*(1-this.transCnt),0),a.canvas.circSwitch(t,650,830,100,0,20,this.menu.levels,"#fd7a7a","#adeaff","difficulty"),t.restore(),t.save(),2==this.trans&&t.translate(-1e3*this.transCnt,0),1==this.trans&&t.translate(-1500*(1-this.transCnt),0),a.canvas.circSwitch(t,220,930,80,1.047,20,this.menu.speed,"#fd7a7a","#adeaff","game\nspeed"),t.restore(),t.restore()},endPage:function(){var t=a.canvas.ctxFg;if(t.save(),t.translate(a.canvas.w2,a.canvas.h2),t.textAlign="center",t.textBaseline="middle",t.fillStyle="#adeaff",t.font="40pt Trebuchet MS",t.fillStyle=1==a.ply.win?"#fd7a7a":"#adeaff",t.save(),2==this.trans&&(t.globalAlpha=this.transCnt>.5?2*(1-this.transCnt):1),t.beginPath(),t.strokeStyle="#adeaff",t.lineWidth=5,t.arc(0,0,220,0,6.3,0),t.moveTo(180,0),t.arc(0,0,180,0,6.3,0),t.stroke(),t.save(),1==this.trans&&(t.globalAlpha=this.transCnt>.75?4*(this.transCnt-.75):0),t.beginPath(),t.fillStyle="#adeaff",t.font="32pt bold Trebuchet MS",t.fillText("R E S T A R T",0,0),t.restore(),t.beginPath(),t.lineWidth=20,0==this.trans||2==this.trans)for(var e=0,s=.3145;20>e;e++)t.beginPath(),t.strokeStyle=1==a.ply.win?"#fd7a7a":"#adeaff",(5*this.animRot>e*s||this.done)&&(t.arc(0,0,200,0+e*s+.03,s+e*s-.03),19==e&&(this.done=1)),t.stroke();t.beginPath(),t.strokeStyle="#adeaff",t.lineWidth=5,t.save(),t.rotate(this.animRot);for(var e=0,s=.78625;8>e;e++)t.save(),t.rotate(s*e),t.save(),1==this.trans&&t.translate(0,-500*(1-4*(this.transCnt<.25?this.transCnt:.25))),t.beginPath(),t.moveTo(0,-310),t.lineTo(40,-345),t.lineTo(-40,-345),t.closePath(),t.stroke(),t.restore(),t.restore();t.restore(),t.restore();var i="You "+(1==a.ply.win?"win":"lose"),n="You "+(1==a.ply.win?"lose":"win");t.save(),t.fillStyle="#adeaff",1==this.trans&&t.translate(0,1e3*(1-this.transCnt)),2==this.trans&&t.translate(0,1e3*this.transCnt),t.fillText(n,0,450),t.restore(),t.save(),t.fillStyle="#fd7a7a",t.rotate(3.1415),1==this.trans&&t.translate(0,1e3*(1-this.transCnt)),2==this.trans&&t.translate(0,1e3*this.transCnt),t.beginPath(),t.fillText(i,0,450),t.restore(),t.restore()}},a.ply={win:"",0:{},1:{},cons:function(t,e){this[e].energy-=t,this[e].energy<1&&(this[e].energy=0,this.win=1-e,a.app.nextState()),this[e].len=this[e].energy/100*40*18.5},reset:function(){this[0].energy=this[1].energy=100,this[0].len=this[1].len=740}},a.pool={init:function(t,e,s,i){this.balls=[],this.defend=[],this.grav=[];for(var n=0;t>n;n++)this.balls.push(new a.factory.ball({audioCtx:a.sfx.audioCtx,speed:i}));for(var n=0;e>n;n++)this.defend.push(new a.factory.defend({audioCtx:a.sfx.audioCtx}));for(var n=0;s>n;n++)this.grav.push(new a.factory.grav);this.gravCnt=this.grav.length,this.objCnt=[10,10]}},a.factory={ball:function(t){this.state=0,this.animState=0,this.r=30,this.speed=t&&t.speed,this.initSfx=function(){this.sfx={ctx:t.audioCtx,launch:t.audioCtx.createGain(),explode:t.audioCtx.createGain(),bigEx:t.audioCtx.createGain(),playLaunch:function(){var t=this.ctx.currentTime;this.launch.gain.cancelScheduledValues(t),this.launch.gain.setValueAtTime(0,t),this.launch.gain.linearRampToValueAtTime(.1,t+.15),this.launch.gain.exponentialRampToValueAtTime(.01,t+.6),this.launch.gain.setValueAtTime(0,t+.61)},playExp:function(){var t=this.ctx.currentTime;this.explode.gain.cancelScheduledValues(t),this.explode.gain.setValueAtTime(0,t),this.explode.gain.linearRampToValueAtTime(1,t+.1),this.explode.gain.exponentialRampToValueAtTime(.01,t+.55),this.explode.gain.setValueAtTime(0,t+.56)},playBigEx:function(){var t=this.ctx.currentTime;this.bigEx.gain.cancelScheduledValues(t),this.bigEx.gain.setValueAtTime(0,t),this.bigEx.gain.linearRampToValueAtTime(3,t+.05),this.bigEx.gain.exponentialRampToValueAtTime(.01,t+1),this.bigEx.gain.setValueAtTime(0,t+1.01)}},this.sfx.launch.gain.value=0,this.sfx.explode.gain.value=0,this.sfx.bigEx.gain.value=0,a.sfx.noise.connect(this.sfx.launch),a.sfx.noise.connect(this.sfx.explode),a.sfx.bigPre.connect(this.sfx.bigEx),this.sfx.launch.connect(a.sfx.lchLp1),this.sfx.explode.connect(a.sfx.expLp1),this.sfx.bigEx.connect(a.sfx.bigLp1)},this.init=function(t,e,s,i){this.gConst=1e8,this.gConstM=-1e7,this.v=new a.v(this.speed,s),this.expT=.2,this.side=i?1:0,this.rotConst=2*(1+Math.random())*(2*Math.random()&1)-1,this.p=new a.v(Math.sqrt(t*t+e*e),Math.atan2(e,t)),this.a=new a.v(0,s),this.gra=new a.v(0,0),this.dir=s,this.state=1,a.pool.objCnt[this.side]--,a.sfx.audioSupport&&this.sfx.playLaunch()},this.move=function(t){if(this.a.set(0,0),a.pool.grav.forEach(function(t){t.state&&(this.gra.set(t.p.v,t.p.a),this.gra.sub(this.p),this.a.addS((t.sign*this.gConst+(1-t.sign)*this.gConstM)/(this.gra.v*this.gra.v),this.gra.a))},this),this.v.addS(this.a.v*t,this.a.a),this.v.v>3e3&&(this.v.v=3e3),this.p.addS(this.v.v*t,this.v.a),this.x=this.p.v*Math.cos(this.p.a),this.y=this.p.v*Math.sin(this.p.a),(this.x<0||this.x>a.canvas.w)&&this.die(),(this.y<0||this.y>a.canvas.h)&&1==this.state){var e=this.y<a.canvas.h/2?1:0;
a.ply.cons(5,e),this.explode(),a.sfx.audioSupport&&this.sfx.playBigEx(),a.app.shake[e]=.55}2==this.state&&(this.expT-=t,this.expT<0&&this.die())},this.explode=function(){this.state=2,this.v.v=50,a.sfx.audioSupport&&this.sfx.playExp()},this.die=function(){this.state=0,a.pool.objCnt[this.side]++},this.draw=function(t,e,s){t.save(),t.translate(Math.round(this.x),Math.round(this.y)),t.rotate(s*this.rotConst),2==this.state?t.drawImage(a.sp[this.side].exp[19-Math.round(95*this.expT)],-64,-64):t.drawImage(a.sp[this.side].p[e>>1],-64,-64),t.restore()},a.sfx.audioSupport&&this.initSfx()},defend:function(t){this.state=0,this.animState=0,this.v=20,this.se=new a.v(0,0),this.sb=new a.v(0,0),this.eb=new a.v(0,0),this.len=0,this.initSfx=function(t){this.sfx={ctx:t.audioCtx,launch:t.audioCtx.createGain(),playLaunch:function(){var t=this.ctx.currentTime;this.launch.gain.cancelScheduledValues(t),this.launch.gain.setValueAtTime(0,t),this.launch.gain.linearRampToValueAtTime(.3,t+.1),this.launch.gain.setValueAtTime(.3,t+.2),this.launch.gain.linearRampToValueAtTime(.01,t+.3),this.launch.gain.setValueAtTime(0,t+.31)}},this.sfx.launch.gain.value=0,a.sfx.zzzzOsc.connect(this.sfx.launch),this.sfx.launch.connect(a.sfx.zzzzFilter)},this.init=function(t,e,s,i,n,h){this.side=n?1:0,this.startX=h?s:t,this.startY=h?i:e,this.endX=h?t:s,this.endY=h?e:i,this.a=Math.atan2(this.endY-this.startY,this.endX-this.startX),this.state=1,a.pool.objCnt[this.side]--,a.sfx.audioSupport&&this.sfx.playLaunch()},this.move=function(t){this.startX+=this.v*t*Math.cos(this.a),this.endX-=this.v*t*Math.cos(this.a),this.startY+=this.v*t*Math.sin(this.a),this.endY-=this.v*t*Math.sin(this.a),this.len=Math.sqrt((this.startX-this.endX)*(this.startX-this.endX)+(this.startY-this.endY)*(this.startY-this.endY)),this.len2=this.len>>1,this.endX-this.startX<5&&(this.state=0,a.pool.objCnt[this.side]++)},this.hit=function(){this.move(3)},this.draw=function(t,e){t.save(),t.translate(Math.round(this.startX),Math.round(this.startY)),t.rotate(this.a),t.drawImage(a.sp[this.side].d[e>>1],0,0,this.len2+20,64,-20,-32,this.len2+20,64),t.drawImage(a.sp[this.side].d[e>>1],840-this.len2-20,0,this.len2+20,64,this.len2,-32,this.len2+20,64),t.restore()},a.sfx.audioSupport&&this.initSfx(t)},grav:function(){this.state=0,this.animState=0,this.init=function(t,e,s){this.sign=t?1:0,this.state=1,this.lifeTime=4+5*Math.random(),this.x=e||40*Math.round(2+16*Math.random())+(3+6*Math.random()),this.y=s||40*Math.round(10+10*Math.random())+(3+6*Math.random()),this.p=new a.v(Math.sqrt(this.x*this.x+this.y*this.y),Math.atan2(this.y,this.x)),a.pool.gravCnt--},this.move=function(t){this.lifeTime-=t,this.lifeTime<0&&(this.state=0,a.pool.gravCnt++)},this.draw=function(t,e){t.save(),t.translate(Math.round(this.x),Math.round(this.y)),t.drawImage(a.sp.well[this.sign][this.sign?e:39-e],-64,-64),t.restore()}}},window.onload=function(){a.app.start()};