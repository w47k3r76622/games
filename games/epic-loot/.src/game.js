const Decktet=function(){const e=Object.prototype.hasOwnProperty,t={};return t.str={value:1,suits:["str"]},t.bld={value:1,suits:["bld"]},t.qck={value:1,suits:["qck"]},t.int={value:1,suits:["int"]},t.wil={value:1,suits:["wil"]},t.chr={value:1,suits:["chr"]},t.exc={value:0,suits:[]},t.aut={value:2,suits:["int","wil"]},t.pai={value:3,suits:["str","int"]},t.sav={value:3,suits:["bld","chr"]},t.sai={value:4,suits:["bld","qck"]},t.sol={value:5,suits:["int","chr"]},t.lun={value:6,suits:["qck","wil"]},t.pen={value:6,suits:["str","chr"]},t.dip={value:8,suits:["str","wil"]},t.mer={value:9,suits:["bld","int"]},t.wat={value:10,suits:["int","wil","chr"]},t.lgt={value:10,suits:["str","qck","int"]},t.con={value:11,suits:["qck","int","wil"]},t.bar={value:12,suits:["str"]},t.hun={value:12,suits:["wil"]},t.jou={value:3,suits:["qck","wil"]},t.bat={value:4,suits:["int","chr"]},t.dis={value:5,suits:["str","qck"]},t.mar={value:6,suits:["bld","int"]},t.cha={value:7,suits:["bld","wil"]},t.bet={value:8,suits:["int","chr"]},t.pac={value:9,suits:["str","wil"]},t.har={value:10,suits:["str","bld","wil"]},t.rit={value:11,suits:["bld","wil","chr"]},t.cal={value:12,suits:["chr"]},t.win={value:12,suits:["int"]},t.ori={value:2,suits:["bld","qck"]},t.des={value:2,suits:["str","chr"]},t.mou={value:4,suits:["str","wil"]},t.for={value:5,suits:["bld","wil"]},t.cas={value:7,suits:["str","int"]},t.cav={value:7,suits:["qck","chr"]},t.mil={value:8,suits:["bld","qck"]},t.drk={value:9,suits:["qck","chr"]},t.bor={value:10,suits:["bld","qck","chr"]},t.isl={value:11,suits:["str","qck","chr"]},t.dow={value:11,suits:["str","bld","int"]},t.sea={value:12,suits:["qck"]},t.end={value:12,suits:["bld"]},{attributes:function(){return["str","bld","qck","int","wil","chr"]},personalities:function(){return["exc","aut","pai","sav","sai","sol","lun","pen","dip","mer","wat","lgt","con","bar","hun"]},events:function(){return["jou","bat","dis","mar","cha","bet","pac","har","rit","cal","win"]},locations:function(){return["ori","des","mou","for","cas","cav","mil","drk","bor","isl","dow","sea","end"]},get:function(n){if(e.call(t,n))return Object.assign({name:n,title:n,text:""},t[n])}}}(),PRNG=function(){function e(){return((n+=n*n|5)>>>32)/t}const t=2**32;let n=Math.floor(Math.random()*t);return{random:e,shuffle:function(t){let n,s,i=t.length;for(;i>0;)s=Math.floor(e()*i),n=t[i-=1],t[i]=t[s],t[s]=n},pick:function(t){return t[Math.floor(e()*t.length)]}}}(),Loot=function(){function e(e){const t=Decktet.get(e);if(!t||t.suits.length<=0||t.value<=0)return{type:"mushrooms",variety:"",title:"mushrooms",article:"some",pronoun:"them"};if(Decktet.locations().indexOf(e)>-1)return{type:"gold",variety:"",title:"some gold",article:"",pronoun:""};let n=t.suits[1];n||(n=t.suits[0]),(!(n={str:"armour",bld:"bow",qck:"staff",int:"sword",wil:"helmet",chr:"helmet"}[n])||t.value<=1)&&(n="bottle");const s={helmet:3,armour:3,sword:3,bow:2,staff:3,bottle:1};return r.call(g,n)?(g[n]+=1,g[n]%=s[n]):g[n]=0,{type:n,variety:g[n],article:"a",pronoun:"it"}}function t(){return u.length<=0&&(u=["wonder through the forest","come to a clearing in the forest","halt at a glade in the forest","arrive at a fork in the road"],PRNG.shuffle(u)),u.pop()}function n(){return d.length<=0&&(d=["blinks","growls","hisses","howls","glares"],PRNG.shuffle(d)),d.pop()}function s(e){const t=Decktet.get(e);if(t){const e={str:"strong",bld:"bold",qck:"quick",int:"intelligent",wil:"wilful",chr:"charming"},n=t.suits.map(t=>e[t]);let s="";for(;n.length>0;){const e=n.shift();e&&(s+=` ${e}`,n.length>1&&(s+=","),1===n.length&&(s+=" and"))}return s.trim()}}function i(){h.length<=0&&(h=["coif","helmet","helm"],PRNG.shuffle(h));let e=h.pop();const t=PRNG.pick(["plate","mail","leather",void 0]);return t&&(e=`${t} ${e}`),e}function o(){f.length<=0&&(f=["brigandine","hauberk","cuirass","plackart"],PRNG.shuffle(f));let e=f.pop();const t=PRNG.pick(["plate","mail","leather",void 0]);return t&&(e=`${t} ${e}`),e}function a(e){let t=e;const n=PRNG.pick(["metal","glass","bone",void 0]);return n&&(t=`${n} ${t}`),t}function c(){m.length<=0&&(m=["potion","tonic","salve"],PRNG.shuffle(m));let e=m.pop();const t=PRNG.pick(["sticky","noxious","fragrent",void 0]);return t&&(e=`${t} ${e}`),e}function l(l){const r=e(l);if(r.where=t(),r.what=n(),r.how=s(l),r.title)return r;"helmet"===r.type?r.title=i():"armour"===r.type?r.title=o():"bottle"===r.type?r.title=c():r.title=a(r.type);const u=PRNG.pick(["epic","greater","lesser",void 0]);u&&(r.title=`${u} ${r.title}`),"epic"===u&&(r.article="an");const d=PRNG.pick(["healing","casting","shocking","poisoning","burning","freezing","archery","smiting","wondering",void 0]);return d&&(r.title=`${r.title} of ${d}`),r}const r=Object.prototype.hasOwnProperty;let u=[],d=[],h=[],f=[],m=[],p={},g={};return{get:function(e){return r.call(p,e)||(p[e]=l(e)),p[e]},reset:function(){u=[],d=[],h=[],f=[],m=[],p={},g={}}}}(),Personalities=function(){let e=[];return{deal:function(){return e.pop()},remove:function(t){const n=e.indexOf(t);n>-1&&e.splice(n,1)},reset:function(){e=Decktet.personalities(),PRNG.shuffle(e)}}}(),Events=function(){let e=[];return{deal:function(){return e.pop()},size:function(){return e.length},reset:function(){e=Decktet.events(),PRNG.shuffle(e)}}}(),Locations=function(){let e=[],t=[];return{add:function(e){Decktet.locations().indexOf(e)>-1&&t.push(e)},shuffle:function(){e=e.concat(t),t=[],PRNG.shuffle(e)},deal:function(){return e.pop()},size:function(){return e.length+t.length},reset:function(){e=Decktet.locations(),t=[],PRNG.shuffle(e)}}}(),Obstacles=function(){let e,t=1,n=[],s=[],i=[];return{get:function(){let t=i;return e&&(t=[e]),t.map(e=>Object.assign({},e))},deal:function(){if(i=[],e=void 0,1===t){const e=Personalities.deal(),n=Events.deal();e&&n?i=[e,n]:t=2}if(2===t){let e=Locations.deal();e||(Locations.shuffle(),e=Locations.deal()),e&&i.push(e);let t=Locations.deal();t||(Locations.shuffle(),t=Locations.deal()),t&&i.push(t)}PRNG.shuffle(i),i=i.map(e=>Decktet.get(e));for(let e=0;e<i.length;e+=1)i[e].value<=0?i[e].title="mushrooms":1===t?(n.length<=0&&(n=["rabbit","arachnid","bat","snake","boar"],PRNG.shuffle(n)),i[e].title=n.pop()):(s.length<=0&&(s=["scorpion","ghost","skeleton","eye","octo"],PRNG.shuffle(s)),i[e].title=s.pop())},pick:function(t){e||i.length<1||(i.length<2?e=i[0]:(i[0].name===t&&(Locations.add(i[1].name),e=i[0]),i[1].name===t&&(Locations.add(i[0].name),e=i[1]),i=[e]))},use:function(t){if(!e)return;const n=Decktet.get(t);if(!n)return;let s=!1;n.suits.forEach(t=>{e.suits.indexOf(t)>-1&&(s=!0)}),s&&(e.value-=n.value,e.value<0&&(e.value=0))},defeated:function(){return e&&e.value<=0},stage:function(){return t},reset:function(){Personalities.reset(),Events.reset(),Locations.reset(),t=1,n=[],s=[],i=[],e=void 0}}}(),Deck=function(){function e(t,n){const s=[];let i,o,a,c;for(i=0;i<t.length;i+=1)if(1===n)s.push([t[i]]);else for(a=e(t.slice(i+1,t.length),n-1),o=0;o<a.length;o+=1)(c=a[o]).unshift(t[i]),s.push(c);return s}const t=[];let n=[],s=[],i=[],o=[],a=!1;return{get:function(){const e=[],t=[].concat(o).reverse();return[].concat(n,s).forEach(t=>{Decktet.attributes().indexOf(t)>-1&&e.push(t)}),{cards:n.length,discards:s.length,attributes:e,bag:t}},empty:function(){return a},shuffle:function(){n=[].concat(n,s,i),s=[],i=[],PRNG.shuffle(n)},deal:function(){const e=n.pop();return e&&s.push(e),e||(a=!0),e},add:function(e){e&&Decktet.locations().indexOf(e)<0&&(i.push(e),o.push(e),Decktet.attributes().indexOf(e)>-1&&(a=!1))},used:function(e){return n.indexOf(e)<0},reset:function(){t.length<=0&&(e(Decktet.personalities(),4).forEach(e=>{let n=[];e.forEach(e=>{const t=Decktet.get(e);n=n.concat(t.suits)}),6===(n=new Set(n)).size&&(PRNG.shuffle(e),t.push(e))}),PRNG.shuffle(t)),n=t.pop(),s=[],i=[],o=[].concat(n,s),a=!1}}}(),Gems=function(){const e=Object.prototype.hasOwnProperty,t=9;let n={};return{get:function(){return n},count:function(t){return e.call(n,t)?n[t]:0},spend:function(t){e.call(n,t)&&n[t]>0&&(n[t]-=1)},add:function(s){e.call(n,s)&&n[s]<t&&(n[s]+=1)},max:function(){return t},reset:function(){n={},Decktet.attributes().forEach(e=>{n[e]=t})},size:function(){return Object.values(n).reduce((e,t)=>e+t,0)}}}(),Stage=function(){function e(){Loot.reset(),Obstacles.reset(),Deck.reset(),Gems.reset(),a=[],c="encumbered"}function t(e){return"d6"===e&&Deck.reset(),"items"===e&&(Deck.get().bag.forEach(e=>{Personalities.remove(e)}),Deck.shuffle(),Obstacles.deal(),c="choice"),this}function n(e){const t=Obstacles.get();if(t.length<1)return this;let n;return"d6"===e&&(n=Math.floor(PRNG.random()*t.length)),"sign1"===e&&(n=0),"sign2"===e&&(n=1),void 0===n?this:(n>=t.length&&(n=0),Obstacles.pick(t[n].name),c="combat",this)}function s(e){const t=e.split("-");if("d6"===e){const e=Decktet.attributes();for(PRNG.shuffle(e),t[0]="gems",t[1]=e.pop();t[1]&&Gems.count(t[1])<=0;)t[1]=e.pop()}if("gems"===t[0]){const e=t[1];if(Gems.count(e)<=0)return this;if(Obstacles.defeated())return this;if(1!==Obstacles.get().length)return this;Gems.spend(e),Obstacles.use(e);let n=Deck.deal();n||(Deck.shuffle(),n=Deck.deal()),Obstacles.use(n),a.push(n)}if("items"===e){if(Obstacles.defeated())return c="loot",this;if(Gems.size()<=0)return c="madness",this}return this}function i(e){if("items"!==e)return this;let t=Obstacles.get();return t.length<1?this:(Deck.add(t[0].name),Obstacles.deal(),t=Obstacles.get(),a=[],t.length<1?(c="victory",this):Deck.empty()?(c="level-up",this):(c="choice",this))}function o(e){const t=e.split("-");if("d6"===e){const e=Decktet.attributes(),n=Math.floor(PRNG.random()*e.length);t[0]="level",t[1]=e[n]}return"level"!==t[0]?this:Decktet.attributes().indexOf(t[1])<0?this:Deck.empty()?(Gems.add(t[1]),Deck.add(t[1]),c="choice",this):this}let a=[],c="encumbered";return{get:function(){return c},next:function(a){return"encumbered"===c?t(a):"choice"===c?n(a):"combat"===c?s(a):"loot"===c?i(a):"level-up"===c?o(a):("victory"!==c&&"madness"!==c||"items"===a&&e(),this)},items:function(){return[].concat(a)},reset:e}}(),Renderer=function(){function e(){const e=window.jQuery,t=Deck.get().bag,n=t.filter(e=>Deck.used(e)),s=t.filter(e=>!Deck.used(e));let i="";[].concat(s,["end"],n).forEach(e=>{const t=Decktet.get(e),n=Loot.get(e);if(i+='<div class="row item">',i+=`<span class="pixelated icon loot ${n.type}${n.variety}"></span>`,i+=`<span class="name">${n.title}</span>`,"gold"!==n.type){i+='<span class="info">',i+=`<span class="value">${t.value}</span>`,t.suits.forEach(e=>{i+=`<span class="${e} gem"></span>`});for(let e=t.suits.length;e<3;e+=1)i+='<span class="invisible gem"></span>'}i+="</span>",i+="</div>"}),e("#bag").html(i)}function t(){const e=window.jQuery;Decktet.attributes().forEach(t=>{const n=Gems.max();let s=n-Gems.count(t);s<1&&(s=1),s>n&&(s=n);let i="";i+=`<span class="stat">${s}`,i+=`<span class="${t} gem"></span>`,i+="</span>",e(`#stats-${t}`).html(i.trim())})}function n(){const e=window.jQuery,t=Deck.get(),n=Stage.get();let s=t.discards,i=t.discards+t.cards,o=100*s/i;if(Deck.empty()&&(s="??",i="??",o=100),e("#xp-points").html(s),e("#xp-needed").html(i),e("#this-level").html(t.attributes.length+1),e("#next-level").html(t.attributes.length+2),e("#xp-progress").style("width",`${o}%`),1===Obstacles.stage()?(e("#world").add("day"),e("#world").remove("night")):(e("#world").add("night"),e("#world").remove("day")),"encumbered"===n||"loot"===n){let t='<span class="celestial"></span>',n=0;for(s=(i=Decktet.events().length+Decktet.locations().length)-Events.size()-Locations.size(),n=0;n<s;n+=1)t+='<span class="filled diamond"></span>';for(n=s;n<i;n+=1)t+='<span class="diamond"></span>';e("#game-progress").html(t)}}function s(e,t,n){let s;if(e){let i="col sign";(n||t)&&(i+=" mini"),t&&(i+=" loot");let o=e.title;t&&(o=`${t.type}${t.variety}`);let a="gems";t&&"gold"===t.type&&(a+=" gold"),s="",s+=`<div class="${i}">`,s+=`<span class="value">${e.value}</span>`,s+='<div class="row">',s+=`<span class="pixelated icon ${o}"></span>`,s+='<span class="text">',s+=`<span class="iconic title">${e.title}</span>`,s+="</span>",s+="</div>",s+=`<div class="row ${a}">`,e.suits.forEach(e=>{s+=`<span class="${e} gem"></span>`}),s+="</div>",s+="</div>"}return s}function i(){const e=window.jQuery;let t,n,i;switch(Stage.get()){case"level-up":Decktet.attributes().forEach(o=>{n=Decktet.get(o),i=Loot.get(o),t=s(n,i,!0),e(`#level-${o}`).html(t)}),e("#level-up").remove("hidden"),e("#used-items").add("hidden");break;default:e("#used-items").remove("hidden"),e("#level-up").add("hidden")}}function o(){const e=window.jQuery;let t,n,i;switch(Stage.get()){case"encumbered":t="",Deck.get().bag.forEach(e=>{n=Decktet.get(e),i=Loot.get(e),n&&i&&(t+=s(n,i,!0))}),e("#used-items").remove("hidden").html(t);break;case"combat":t="",Stage.items().slice(-6).forEach(e=>{n=Decktet.get(e),i=Loot.get(e),n&&i&&(t+=s(n,i,!0))}),e("#used-items").remove("hidden").html(t);break;case"loot":case"victory":case"madness":e("#used-items").remove("hidden").html("");break;default:e("#used-items").add("hidden").html("")}}function a(){const e=window.jQuery,t=Obstacles.get();let n,i,o,a;switch(Stage.get()){case"encumbered":n='<div class="col sign"></div>';break;case"combat":n=s(t[0],void 0,!1);break;case"choice":n=s(t[0],void 0,!0),i=s(t[1],void 0,!0),1===t.length&&(i=n);break;case"loot":n=s(o=Decktet.get(t[0].name),a=Loot.get(t[0].name),!0)}n||i?e("#signpost").remove("hidden"):e("#signpost").add("hidden"),n?e("#sign1").remove("hidden").html(n):e("#sign1").add("hidden").html(""),i?e("#sign2").remove("hidden").html(i):e("#sign2").add("hidden").html("")}function c(){const e=window.jQuery,t=Gems.get();"encumbered"===Stage.get()?e("#gems").add("invisible"):e("#gems").remove("invisible"),Object.keys(t).forEach(n=>{let s="";for(let e=0;e<9;e+=1){s+='<span class="box">';let i=!1;(i=(i=(i=(i=(i=(i=(i=(i=(i=i||0===e&&t[n]>=7)||1===e&&t[n]>=6)||2===e&&t[n]>=5)||3===e&&t[n]>=8)||4===e&&t[n]>=1)||5===e&&t[n]>=4)||6===e&&t[n]>=9)||7===e&&t[n]>=2)||8===e&&t[n]>=3)&&(s+=`<span class="${n} gem"></span>`),s+="</span>"}e(`#gems-${n}`).html(s.trim())})}function l(){const e=window.jQuery,t=Obstacles.get();let n,s,i="";switch(Stage.get()){case"encumbered":i='You are encumbered! You empty your bag on the ground and pick through the items you&rsquo;ve collected, looking for <span class="iconic">epic loot</span>.';break;case"choice":n=Loot.get(t[0].name),i=1===Obstacles.stage()?`You ${n.where}. Wild animals block your path. You&rsquo;ll have to scare one of them away. Pick an animal or roll the dice.`:`You ${n.where}. Monsters block your path. You&rsquo;ll have to scare one of them away. Pick a monster or roll the dice.`;break;case"combat":(s=Stage.items()).length>0?(i=`You pull ${(n=Loot.get(s.slice(-1)[0])).article} ${n.title} from your bag and throw ${n.pronoun} at the ${t[0].title}, which`,Obstacles.defeated()?i+=" flees.":i+=` ${n.what} at you.`):"mushrooms"===t[0].title?i="You find some mushrooms growing in the forest.":(n=Loot.get(t[0].name),i=`The ${t[0].title} ${n.what} at you.`,n.how&&(i+=` If you are ${n.how}, you may be able to scare it away.`),i+=" Pick a gem or roll the dice.");break;case"loot":i="mushrooms"===(n=Loot.get(t[0].name)).type?"The mushrooms look delicious.":`You find ${n.article} ${n.title}!`;break;case"level-up":i="You have gained in experience. Level up! Pick a bottle or roll the dice.";break;case"victory":i='You are victorious! You heft your bag of <span class="iconic">epic loot</span> and realize&hellip;';break;case"madness":i='The monsters chew a hole in your bag and take some of your <span class="iconic">epic loot</span>. But that&rsquo;s okay. You were starting to feel like&hellip;'}e("#narrative").html(i)}function r(){const e=window.jQuery;let t;switch(Stage.get()){case"encumbered":t="take";break;case"combat":Gems.size()<=0&&(t="flee"),Obstacles.defeated()&&(t="loot");break;case"loot":t="take";break;case"victory":case"madness":t="rest"}t?e("#button").remove("hidden").html(t):e("#button").add("hidden").html("")}function u(){const e=window.jQuery,t=new Set(["#button","#d6"]),n=Decktet.attributes().map(e=>`#gems-${e}`),s=Decktet.attributes().map(e=>`#level-${e}`);switch(Stage.get()){case"choice":t.add("#sign1"),t.add("#sign2");break;case"combat":Obstacles.defeated()||n.forEach(e=>t.add(e));break;case"level-up":s.forEach(e=>t.add(e))}const i=new Set(["#d6","#button","#sign1","#sign2"].concat(n,s));t.forEach(t=>{e(t).add("pickable"),i.delete(t)}),i.forEach(t=>{e(t).remove("pickable")})}function d(){h&&(t(),e(),o(),a(),c(),n(),i(),l(),r(),u(),h=!1),requestAnimationFrame(d)}let h=!0;return{render:d,invalidate:function(){h=!0}}}(),Game=function(){function e(e){e.add("picked")}function t(e){e.remove("picked"),Stage.next(e.unwrap().id),Renderer.invalidate()}function n(e){e.remove("picked"),Stage.next(e.unwrap().id),Renderer.invalidate()}function s(e){e.remove("picked"),Stage.next("items"),Renderer.invalidate()}function i(e){e.remove("picked"),Stage.next(e.unwrap().id),Renderer.invalidate()}function o(){return l.length<=0&&(l=["d1","d2","d3","d4"],PRNG.shuffle(l)),l.pop()}function a(e){let t="";t+=`<span class="${o()}"></span>`,t+=`<span class="${o()}"></span>`,e.html(t).remove("picked"),Stage.next("d6"),Renderer.invalidate()}function c(){(0,window.jQuery)("#world").toggle("dw")}let l=[];return{play:function(){const o=window.jQuery;Decktet.attributes().forEach(s=>{o(`#gems-${s}`).touch(e,t),o(`#level-${s}`).touch(e,n)}),o("#button").touch(e,s),o("#sign1").touch(e,i),o("#sign2").touch(e,i),o("#d6").touch(e,a),o("#dw").touch(void 0,c),Stage.reset(),Renderer.invalidate(),Renderer.render()}}}();!function(){function e(t){return t instanceof e?t:(this.element=t,"string"==typeof t&&0===t.indexOf("#")&&(this.element=document.getElementById(t.slice(1))),this)}e.prototype.html=function(e){return this.element&&(this.element.innerHTML=e),this},e.prototype.add=function(e){return this.element&&this.element.classList&&this.element.classList.add(e),this},e.prototype.remove=function(e){return this.element&&this.element.classList&&this.element.classList.remove(e),this},e.prototype.toggle=function(e){return this.element&&this.element.classList&&this.element.classList.toggle(e),this},e.prototype.style=function(e,t){if(this.element){if(!t)return this.element.style[e];this.element.style[e]=t}return this},e.prototype.touch=function(e,t){const n=this;return this.element&&("ontouchstart"in document.documentElement==!1?this.element.onmousedown=function(s){e&&e(n,s),document.onmousemove=function(e){e.preventDefault()},document.onmouseup=function(e){t&&t(n,e),document.onmousemove=void 0,document.onmouseup=void 0}}:this.element.ontouchstart=function(s){e&&e(n,s),document.ontouchmove=function(e){e.preventDefault()},document.ontouchend=function(e){t&&t(n,e),document.ontouchmove=void 0,document.ontouchend=void 0}}),this},e.prototype.unwrap=function(){return this.element},window.jQuery=function(t){return new e(t)}}(),Game.play();