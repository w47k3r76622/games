class t{constructor(t={}){console.log("BASE TILE CREATED: ",t),this.lastX=t.x,this.lastY=t.y,this.x=t.x,this.y=t.y,this.width=16,this.height=16,this.scale=1,this.velocity={x:0,y:0},this.isPlaced=!0,this.isPlacing=!1,this.isFalling=!1,this.positionHistory=[],this.isLiving=!1,this.isBg=!1,this.canDestroy=!1,this.hp=999999,this.texture=t.texture}basePostInit(){this.moveTo(this.x,this.y)}moveTo(t,e){this.positionHistory.push({x:t,y:e}),this.lastX=this.x,this.lastY=this.y,this.x=t,this.y=e;try{this.scene.bgTilemap[this.lastX][this.lastY]=null,this.scene.tilemap[this.lastX][this.lastY]=null}catch{console.log("Failed to set last X and Y at ",this.lastX,this.lastY)}this.isBg?this.scene.bgTilemap[t][e]=this:this.scene.tilemap[t][e]=this}render(t){this.isBg?this.scale=2:this.scale=1,this.width=16*this.scale,this.height=16*this.scale;let e=.5*-(this.width-16),i=.5*-(this.height-16);this.texture&&t.drawImage(this.texture,16*this.x+e,16*this.y+i,this.width,this.height)}}class e extends t{constructor(t,e){super({x:t,y:e})}hit(){console.log("HIT BRICK"),this.hp>0?this.hp--:this.canDestroy=!0}postInit(){let t=["BRICK0","BRICK1"];this.textureKey=t[y(0,t.length-1)],this.texture=this.scene.textures[this.textureKey],this.hp=10}}class i extends t{constructor(t,e){super({x:t,y:e})}postInit(){let t=["DIRT"],e=t[y(0,t.length-1)];this.texture=this.scene.textures[e]}}class s extends t{constructor(t,e){super({x:t,y:e})}postInit(){this.texture=this.scene.textures.GRASS}}class h extends t{constructor(t,e){super({x:t,y:e})}postInit(){this.textureKey="CROWN",this.texture=this.scene.textures[this.textureKey],this.hp=1}hit(){this.hp>0?this.hp--:(this.scene.startGameOver("stolen"),this.canDestroy=!0)}}class a{constructor(t,e){this.x=t,this.y=e,this.velocity={x:0,y:0},this.hasGravity=!0,this.canDestroy=!1,this.depth=0}updateAnimation(t){return void 0!==t.destroyWhenComplete&&t.destroyWhenComplete,t.tick<t.delay?t.tick++:(t.frame<t.maxFrames-1?t.frame++:(t.destroyWhenComplete&&(this.canDestroy=!0),t.frame=0),t.tick=0),t}baseUpdate(){this.x+=this.velocity.x,this.y+=this.velocity.y}update(){}}class l extends a{constructor(t={}){super(t.x,t.y),this.animData={maxFrames:t.texture.width/t.frameWidth,frame:0,frameWidth:t.frameWidth,frameHeight:t.frameHeight,delay:t.animDelay,destroyWhenComplete:!0},this.texture=t.texture,this.timeLeft=t.timeLeft,this.scale=1,this.growRate=void 0===t.growRate?0:t.growRate,this.depth=1}update(){this.timeLeft>0&&this.timeLeft--,this.animData=this.updateAnimation(this.animData),this.scale+=this.growRate}render(t){t.drawImage(this.texture,this.animData.frame*this.animData.frameWidth,0,this.animData.frameWidth,this.animData.frameHeight,this.x,this.y,this.animData.frameWidth*this.scale,this.animData.frameHeight*this.scale)}}class n extends t{constructor(t={}){super(t),this.direction=1,this.scaleX=1,this.scaleY=1,this.isLiving=!0,this.accessories=[]}getAccessory(t){for(let e=0;e<this.accessories.length;e++)if(this.accessories[e].name==t)return this.accessories[e];return null}postInit(){this.width=8,this.height=16,this.headFrameWidth=9,this.headFrameHeight=8,this.chestFrameWidth=7,this.chestFrameHeight=this.chestTexture.height,this.chestAnim={maxFrames:this.chestTexture.width/this.chestFrameWidth,frame:0,delay:5,tick:0},this.pantsFrameWidth=7,this.pantsFrameHeight=this.pantsTexture.height,this.pantsAnim={maxFrames:this.pantsTexture.width/this.pantsFrameWidth,frame:0,delay:5,tick:0}}updateAnimation(t){return t.tick<t.delay?t.tick++:(t.frame<t.maxFrames-1?t.frame++:t.frame=0,t.tick=0),t}baseUpdate(){this.chestAnim=this.updateAnimation(this.chestAnim),this.pantsAnim=this.updateAnimation(this.pantsAnim),this.scaleX=this.direction}update(){this.baseUpdate()}render(t){t.save(),t.drawImage(this.pantsTexture,this.pantsAnim.frame*this.pantsFrameWidth,0,this.pantsFrameWidth,this.pantsFrameHeight,16*this.x+1,16*this.y+11,this.pantsFrameWidth,this.pantsFrameHeight),t.drawImage(this.chestTexture,this.chestAnim.frame*this.chestFrameHeight,0,this.chestFrameWidth,this.chestFrameHeight,16*this.x+1,16*this.y+5,this.chestFrameWidth,this.chestFrameHeight),t.drawImage(this.headTexture,16*this.x-4,16*this.y,this.headTexture.width,this.headTexture.height),t.restore()}}class r extends n{constructor(t,e){super({x:t,y:e}),this.hasGravity=!0,this.direction=1,this.attackCooldownDelay=10,this.scaleX=1,this.scaleY=1}kill(){this.isLiving=!1,this.canDestroy=!0}postInit(){this.headTexture=this.scene.textures.KNIGHT_HEAD,this.chestTexture=this.scene.textures.KNIGHT_CHEST,this.pantsTexture=this.scene.textures.KNIGHT_PANTS,this.attackCooldownLeft=this.attackCooldownDelay,console.log("ATTACK COOLDOWN LEFT: ",this.attackCooldownLeft),super.postInit()}update(){this.baseUpdate(),this.scaleX=this.direction}}class o extends n{constructor(t,e){super({x:t,y:e}),this.hasGravity=!0,this.direction=1,this.attackCooldownDelay=10,this.bowAnim={maxFrames:4,frame:0,delay:5,tick:0},this.bowScaleX=1,this.bowScaleY=1}kill(){this.isLiving=!1,this.canDestroy=!0}postInit(){this.headTexture=this.scene.textures.ARCHER_HEAD,this.chestTexture=this.scene.textures.ARCHER_CHEST,this.pantsTexture=this.scene.textures.ARCHER_PANTS,this.attackCooldownLeft=this.attackCooldownDelay,console.log("ATTACK COOLDOWN LEFT: ",this.attackCooldownLeft),super.postInit()}update(){this.baseUpdate(),this.scaleX=this.direction,this.bowAnim=this.updateAnimation(this.bowAnim)}renderAfterBaseRender(t){console.log("rendering bow",8*this.bowAnim.frame,0,16*this.x,16*this.y,this.bowScaleX,this.bowScaleY),t.drawImage(this.scene.textures.BOW,8*this.bowAnim.frame,0,8,8,16*this.x,16*this.y,8*this.bowScaleX,8*this.bowScaleY)}}class c extends a{constructor(t,e){super(t,e),this.velocity.x=-p(.05,.3),this.width=32,this.height=16,this.scale=32*Math.abs(this.velocity.x),this.width*=this.scale,this.height*=this.scale,this.hasGravity=!1,this.depth=-2}render(t){t.drawImage(this.scene.textures.CLOUD0,this.x,this.y,this.width,this.height)}}class d{constructor(t={}){this.key=t.key,this.isRunning=!1}}class g extends d{constructor(t){super({key:"SceneMain"}),this.game=t,this.canvas=this.game.canvas,this.ctx=this.game.ctx,this.textures=this.game.textures,this.bgTextures=this.game.bgTextures,this.mapWidth=Math.floor(this.canvas.width/16),this.mapHeight=Math.floor(this.canvas.height/16),this.bgTilemap=E(this.mapWidth,this.mapHeight,null),this.tilemap=E(this.mapWidth,this.mapHeight,null),this.moveCooldownDelay=10,this.moveCooldown=0,this.fallFaster=!1,this.placeTileAsBg=!1,this.hasPlacedCrown=!1,this.tilesLeftUntilJewels=3,this.timeUntilNextWaveDelay=3600,this.timeUntilNextWaveTick=this.timeUntilNextWaveDelay,this.eventIdKey=0,this.events=[],this.tiles=[],this.entities=[],this.moveEventId=null,this.placingTiles=[],this.tutorialStep=-1,this.isPaused=!1,this.generateTerrain(),this.callUpNewTileToPlace();let e=0;this.addEvent((function(){if(!this.isPaused){for(let t=0;t<this.tiles.length;t++){let i=this.tiles[t];i.velocity.y=1;let s=2;i.isPlacing&&this.fallFaster&&(s=1);let h=[];if(i.isBg?(h.push(this.tilemap),h.push(this.bgTilemap)):h.push(this.tilemap),e%s==0){for(let t=0;t<h.length;t++){let e=h[t];if(null===e[i.x][i.y+i.velocity.y]&&i.y+i.velocity.y<this.mapHeight?i.isFalling=!0:i.isFalling=!1,!i.isFalling&&(i.isLiving||(i.velocity.x=0),i.velocity.y=0,i.isPlacing&&!i.isPlaced)){if(this.placeMoreTiles&&this.hasPlacedCrown)for(let t=-1;t<2;t++)for(let e=-1;e<2;e++)if(i.x+t>=0&&i.x+t<this.mapWidth&&i.y+e>=0&&i.y+e<this.mapHeight){let s=new i.constructor(i.x+t,i.y+e);this.addTile(s),s.isBg=this.placeTileAsBg,s.moveTo(s.x,s.y)}i.isPlacing=!1,i.isPlaced=!0,this.hasPlacedCrown||(this.hasPlacedCrown=!0),this.placingTiles.length=0}(i.x+i.velocity.x<0||i.x+i.velocity.x>this.mapWidth-1)&&(i.velocity.x=0),0==i.velocity.x&&0==i.velocity.y||null!==e[i.x+i.velocity.x][i.y+i.velocity.y]&&(i.velocity.x=0)}i.moveTo(i.x+i.velocity.x,i.y+i.velocity.y);let t=this.tilemap[i.x][i.y+1];if(t)if(t.isLiving)console.log("KNIGHT: ",t),t.kill&&t.kill();else if(i.isPlacing&&0==i.velocity.x&&1==i.velocity.y){for(let t=0;t<5;t++){console.log(16*i.x+4,16*i.y+16);let t=new l({texture:this.textures.PUFF,x:16*i.x+4,y:16*i.y+16,frameWidth:8,frameHeight:8,animDelay:20,growRate:.1});t.velocity={x:p(-2,2),y:p(-2,2)},this.addEntity(t),console.log("SPAWNED PARTICLE: ",t)}t.texture&&("GRASS"==t.texture.id?t.texture=this.textures.DIRT:"CROWN"==t.texture.id&&(this.startGameOver("crushed"),delete this.tilemap[t.x][t.y],this.tilemap[t.x][t.y]=null))}let e=i.x-1>=0?this.tilemap[i.x-1][i.y]:null;e&&i.isLiving&&!e.isLiving&&0==i.attackCooldownLeft&&e.hit&&(console.log("TILE LEFT: ",e),e.hit(),i.attackCooldownLeft=i.attackCooldownDelay);let s=i.x+1<this.mapWidth-1?this.tilemap[i.x+1][i.y]:null;s&&i.isLiving&&!s.isLiving&&(console.log("COOLDOWN: ",i.attackCooldownLeft,i),0==i.attackCooldownLeft&&s.hit&&(console.log("TILE RIGHT: ",s),s.hit(),i.attackCooldownLeft=i.attackCooldownDelay))}}e++}}),2,!0),this.wave=1,this.enemyWaveId=this.addEvent((function(){for(let t=0;t<y(2,4)*this.wave;t++){let t=[{x:0,y:this.mapHeight-6},{x:this.mapWidth-1,y:this.mapHeight-6}],e=t[y(0,t.length-1)],i=new r(e.x,e.y);this.addTile(i);let s=new o(e.x,e.y);this.addTile(s)}this.wave++,this.timeUntilNextWaveDelay-=5*this.wave,this.timeUntilNextWaveTick=this.timeUntilNextWaveDelay,this.changeEventDelay(this.enemyWaveId,this.timeUntilNextWaveDelay)}),this.timeUntilNextWaveDelay,!0);for(let t=0;t<10;t++){let t=new c(y(0,this.canvas.width),y(0,.75*this.canvas.height));this.addEntity(t)}this.addEvent(this.startTutorial,10,!1)}addEvent(t,e,i=!1){console.log("Added event");let s=this.eventIdKey;return this.events.push({id:s,tick:0,delay:e,callback:t,loop:i}),this.eventIdKey++,console.log("NEW EVENT ID: ",s),s}changeEventDelay(t,e){for(let i=0;i<this.events.length;i++)console.log("is "+t+" == "+this.events[i].id),t==this.events[i].id&&(this.events[i].delay=e,console.log("Changed event "+t+" delay to "+e))}removeEvent(t){for(let e=0;e<this.events.length;e++)t==this.events[e].id&&(this.events.splice(e,1),e--)}addTile(t){t.scene=this,t.basePostInit(),t.postInit&&t.postInit(),this.tiles.push(t)}addEntity(t){t.scene=this,t.postInit&&t.postInit(),t.baseAfterPostInit&&t.baseAfterPostInit(),this.entities.push(t)}generateTerrain(){console.log("GENERATING TERRAIN");for(let t=0;t<this.mapWidth;t++)for(let e=this.mapHeight-5;e<this.mapHeight;e++)if(e==this.mapHeight-5){let i=new s(t,e);this.addTile(i)}else{let s=new i(t,e);this.addTile(s)}}callUpNewTileToPlace(){console.log("Call up new tile");let t=Math.round(this.mapWidth/2),i=null;this.hasPlacedCrown?(i=new e(t,3),this.tilesLeftUntilJewels--):(i=new h(t,3),i.texture=this.textures.CROWN,this.crown=i),i.isFalling=!1,i.isPlacing=!0,i.isPlaced=!1,this.addTile(i),this.placingTiles.push(i),3==this.tutorialStep&&this.setTutorialStep(4)}startTutorial(){this.setTutorialStep(0),this.isPaused=!0}setTutorialStep(t){switch(this.tutorialStep=t,t){case 0:this.isPaused=!0,this.addEvent((()=>{this.setTutorialStep(1)}),150,!1);break;case 1:this.isPaused=!1,this.addEvent((()=>{this.setTutorialStep(2)}),100,!1);break;case 2:this.isPaused=!0,this.addEvent((()=>{this.setTutorialStep(3)}),150,!1);break;case 3:this.isPaused=!1;break;case 4:this.isPaused=!0,this.addEvent((()=>{this.setTutorialStep(5)}),150,!1);break;case 5:this.isPaused=!1,this.addEvent((()=>{this.setTutorialStep(6)}),50,!1)}}startGameOver(t){this.addEvent((()=>{this.game.setScene("SCENE_GAME_OVER",{ending:t})}),100,!1)}update(){for(let t=0;t<this.events.length;t++){let e=this.events[t];e.tick<e.delay?e.tick++:(e.callback.bind(this)(),e.loop?e.tick=0:(this.events.splice(t,1),t--,console.log("REMOVED EVENT "+e.id)))}this.isPaused||this.mainUpdate()}mainUpdate(){if(this.placeTileAsBg=!!this.game.KEY_SPACE,this.placeMoreTiles=!!this.game.KEY_SHIFT,this.fallFaster=!!this.game.KEY_DOWN,this.placingTiles.length>0)for(let t=0;t<this.placingTiles.length;t++){let e=this.placingTiles[t];this.game.KEY_LEFT?e.velocity.x=-1:this.game.KEY_RIGHT||(e.velocity.x=0),this.game.KEY_RIGHT?e.velocity.x=1:this.game.KEY_LEFT||(e.velocity.x=0),this.placeTileAsBg?(e.isBg=!0,e.moveTo(e.x,e.y)):(e.isBg=!1,e.moveTo(e.x,e.y)),e.isPlaced&&(this.placingTiles.splice(t,1),t--)}else console.log("COLLIDED!"),this.callUpNewTileToPlace();for(let t=0;t<this.entities.length;t++){let e=this.entities[t];e.baseUpdate&&e.baseUpdate(),e.width&&e.x<-e.width&&(e.x=16*this.mapWidth+128),e.update(),e.canDestroy&&(this.entities.splice(t,1),t--)}for(let t=0;t<this.tiles.length;t++){let e=this.tiles[t];e.update&&e.update(),e.isBg?e.texture&&(e.texture=this.bgTextures[e.texture.id]):e.texture&&(e.texture=this.textures[e.texture.id]),e.canDestroy&&(this.tilemap[e.x][e.y]=null,this.tiles.splice(t,1),t--)}this.timeUntilNextWaveTick>0&&this.timeUntilNextWaveTick--}drawImageRotated(t,e,i,s,h,a){const l=Math.PI/180;this.ctx.save(),this.ctx.translate(e,i),this.ctx.rotate(a*l),this.ctx.drawImage(t,-t.width/2,-t.height/2,s,h),this.ctx.restore()}render(t){console.log("RENDERING"),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#64a5ff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.entities.length;t++)-2==this.entities[t].depth&&this.entities[t].render(this.ctx);for(let t=0;t<this.entities.length;t++)-1==this.entities[t].depth&&this.entities[t].render(this.ctx);for(let t=0;t<this.placingTiles.length;t++){let e=this.placingTiles[t];for(let t=-1;t<2;t++)for(let i=-1;i<2;i++)if(this.placeMoreTiles&&this.hasPlacedCrown&&(this.ctx.fillStyle="#ffffff",this.ctx.globalAlpha=.5,this.ctx.fillRect(16*(e.x+t),16*(e.y+i),16,16),this.ctx.globalAlpha=1,this.ctx.fillRect(16*(e.x+t)+1,16*(e.y+i)+1,14,14)),0==this.tutorialStep&&(0==t||0==i)){let s=0;0==t&&1==i?s=90:-1==t&&0==i?s=180:0==t&&-1==i&&(s=270),this.drawImageRotated(this.textures.ARROW_GUI,16*(e.x+t)+8,16*(e.y+i)+8,16,16,s)}0==this.tutorialStep?this.game.fillText("USE [A], [S], [D] TO MOVE FALLING TILES",16*e.x+8,16*e.y-24,{align:"center"}):2==this.tutorialStep?this.game.fillText("PLACE THE CROWN WHERE IT CAN BE DEFENDED",this.canvas.width/2,this.canvas.height/4,{align:"center"}):4==this.tutorialStep?this.game.fillText("USE BRICKS TO BUILD WALLS AROUND THE CROWN",this.canvas.width/2,this.canvas.height/4,{align:"center"}):6==this.tutorialStep&&this.game.fillText("HOLD [SHIFT] TO LAY EXTRA BRICKS",this.canvas.width/2,this.canvas.height/4,{align:"center"})}let e=!1;for(let t=0;t<this.bgTilemap.length;t++)for(let i=0;i<this.bgTilemap[t].length;i++){let s=this.bgTilemap[t][i];s&&s.isBg&&(s.texture&&"CROWN"==s.texture.id&&(e=!0),s.render(this.ctx))}console.log("SIZE: ",this.tilemap.length);for(let t=0;t<this.tilemap.length;t++)for(let i=0;i<this.tilemap[t].length;i++){let s=[this.bgTilemap,this.tilemap];for(let h=0;h<s.length;h++){let a=s[h][t][i];if(a&&!a.isBg){if(a.texture&&"CROWN"==a.texture.id&&(e=!0),void 0!==a.attackCooldownLeft&&a.attackCooldownLeft>0&&a.attackCooldownLeft--,a.isFalling)for(let t=0;t<5;t++){let e=a.positionHistory[a.positionHistory.length-t];this.ctx.globalAlpha=1/t,a.render(this.ctx,e),this.ctx.globalAlpha=1}this.crown&&void 0!==a.direction&&(a.x>this.crown.x?a.direction=-1:a.direction=1,0==a.velocity.y&&(a.velocity.x=a.direction)),a.isBg||a.render(this.ctx),a.renderAfterBaseRender&&a.renderAfterBaseRender(this.ctx)}}}e||this.startGameOver("crushed");for(let t=0;t<this.entities.length;t++)0==this.entities[t].depth&&this.entities[t].render(this.ctx);for(let t=0;t<this.entities.length;t++)1==this.entities[t].depth&&this.entities[t].render(this.ctx);this.ctx.fillStyle="#000000",this.ctx.fillText("NEXT WAVE IN: "+(this.timeUntilNextWaveTick/60).toFixed(0)+" SECONDS",16,16)}}class x extends d{constructor(t){super({key:"SceneMainMenu"}),this.game=t,this.textures=this.game.textures,this.game=t,this.canvas=this.game.canvas,this.ctx=this.game.ctx}update(){this.game.KEY_ENTER_PRESSED&&this.game.setScene("SCENE_MAIN")}render(t){t.fillStyle="#333",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.textures.TITLE,0,.5*this.canvas.height-.5*this.canvas.width,this.game.canvas.width,this.game.canvas.width)}}class m extends d{constructor(t,e){super({key:"SceneGameOver"}),this.game=t,this.textures=this.game.textures,this.canvas=this.game.canvas,this.ctx=this.game.ctx,this.ending=e.ending}update(){this.game.KEY_ENTER_PRESSED&&this.game.setScene("SCENE_MAIN")}render(t){t.fillStyle="#222",t.fillRect(0,0,this.canvas.width,this.canvas.height);let e="",i=null;"stolen"==this.ending?(i=this.textures.STOLEN_BAG,e="THE CROWN HAS BEEN STOLEN! THE KINGDOM HAS FELL."):"crushed"==this.ending&&(i=this.textures.CROWN_CRUSHED,e="THE CROWN HAS BEEN CRUSHED! THE KINGDOM HAS FELL."),t.drawImage(i,this.canvas.width/2-128,this.canvas.height/2-128,256,256),this.game.fillText(e,this.canvas.width/2,.75*this.canvas.height,{align:"center"})}}class u{constructor(){console.log("STARTING GAME"),this.scenes={SCENE_MAIN_MENU:x,SCENE_MAIN:g,SCENE_GAME_OVER:m},this.currentScene=[],this.canvas=document.querySelector("canvas"),this.canvas.width=640,this.canvas.height=960,console.log("MAP SIZE: ",this.mapWidth,this.mapHeight),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.textures={TITLE:"title",ARROW_GUI:"arrow-gui",CLOUD0:"cloud0",GRASS:"grass",DIRT:"dirt",BRICK0:"brick0",BRICK1:"brick1",CROWN:"crown",RUBY:"ruby",EMERALD:"emerald",SAPPHIRE:"sapphire",TOPAZ:"topaz",KNIGHT_HEAD:"knight-head",KNIGHT_CHEST:"knight-chest",KNIGHT_PANTS:"knight-pants",ARCHER_HEAD:"archer-head",ARCHER_CHEST:"archer-chest",ARCHER_PANTS:"archer-pants",BOW:"bow",PUFF:"puff",STOLEN_BAG:"stolen-bag",CROWN_CRUSHED:"crown-crushed"},this.bgTextures={},this.loadTextures(),this.lastKeys=[],this.keys=[],this.KEY_UP=!1,this.KEY_DOWN=!1,this.KEY_LEFT=!1,this.KEY_RIGHT=!1,this.KEY_SPACE=!1,this.KEY_SHIFT=!1,this.KEY_ENTER_PRESSED=!1,window.addEventListener("keyup",(t=>{delete this.keys[t.code.replace("Key","")]})),window.addEventListener("keydown",(t=>{this.keys[t.code.replace("Key","")]=!0})),this.loop(),this.setScene("SCENE_MAIN_MENU"),console.log("STARTUP COMPLETE")}loadTextures(){console.log("LOADING TEXTURES");for(let[t,e]of Object.entries(this.textures)){let i=new Image;i.id=t,i.src="images/"+e+".webp",this.textures[t]=i,i.onload=()=>{let e=document.createElement("canvas");e.width=i.width,e.height=i.height;let s=e.getContext("2d");s.drawImage(this.textures[t],0,0),document.body.appendChild(e),console.log("OFFSCREEN CANVAS: ",e);for(var h=s.getImageData(0,0,i.width,i.height),a=h.data,l=0;l<a.length;l+=4)a[l]=.5*a[l],a[l+1]=.5*a[l+1],a[l+2]=.5*a[l+2];s.putImageData(h,0,0),e.id=t,this.bgTextures[t]=e,e.style.display="none",document.querySelector("#canvases").appendChild(e)}}console.log("LOADED TEXTURES: ",this.textures)}setScene(t,e={}){this.currentScene.length=0;let i=new this.scenes[t](this,e);this.currentScene.push(i)}fillText(t,e,i,s={}){s.fontSize="20px",s.borderColor="#000000",s.color="#ffffff",s.style="bold";let h={x:0,y:0};if("center"==s.align){let e=this.ctx.measureText(t);h.x=-e.width/2}for(let a=-2;a<4;a++)for(let l=-2;l<4;l++)0!=a&&0!=l&&(this.ctx.fillStyle=s.borderColor,this.ctx.font=s.style+" "+s.fontSize+" sans-serif",this.ctx.fillText(t,e+a+h.x,i+l+h.y));this.ctx.fillStyle=s.color,this.ctx.fillText(t,e+h.x,i+h.y)}update(){for(const[t,e]of Object.entries(this.keys))this.lastKeys[t]=this.keys[t];this.KEY_UP=!!this.keys.W,this.KEY_DOWN=!!this.keys.S,this.KEY_LEFT=!!this.keys.A,this.KEY_RIGHT=!!this.keys.D,console.log(this.keys.Enter,this.lastKeys.Enter),this.KEY_ENTER_PRESSED=!0===this.keys.Enter&&!0===this.lastKeys.Enter,this.KEY_SPACE=this.keys.Space,this.KEY_SHIFT=void 0!==this.keys.ShiftLeft&&this.keys.ShiftLeft||void 0!==this.keys.ShiftRight&&this.keys.ShiftRight,this.currentScene[0]&&this.currentScene[0].update(),this.lastKeys.length=0}render(t){t.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentScene[0]&&this.currentScene[0].render(t)}loop(){this.update(),this.render(this.ctx),this.frame++,window.requestAnimationFrame(this.loop.bind(this))}}function p(t,e){return Math.random()*(e-t)+t}function y(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}function E(t,e,i){var s=[];for(let h=0;h<t;h++){let t=[];for(let s=0;s<e;s++)t.push(i);s.push(t)}return s}let T=null;window.addEventListener("DOMContentLoaded",(()=>{T=new u}));