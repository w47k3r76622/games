<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><title>Glitch Rabbit</title><meta name=author content=xenohunter><style>body{margin:0;padding:70px;background:#223}canvas{width:1200px;height:576px;display:block;margin:0 auto}#mask{position:relative;width:1200px;height:576px;margin:-576px auto 0;background:#000;opacity:0;transition:opacity .5s}#mask.on{opacity:1}</style></head><body><canvas width=1200 height=576></canvas><div id=mask class=on></div></body><script>var PIXEL_SIZE=16,GAME_H=432,CAMERA_W=1200,START_X=50,IMAGE_TYPE="image/gif",SPRITES={HERO:{sprite:"HgAFAKECAPYHB////wAAAAAAACH5BAEKAAIALAAAAAAeAAUAAAIfVCx4mueYogm02oupbBRYX4FduEjZiTYeVDLmAk9VAQA7",frames:"still stepLeft stepRight jump punched dead".split(" "),w:5,h:5},BIRD:{sprite:"CAAEAKECAAAAADEAK////////yH5BAEKAAMALAAAAAAIAAQAAAILnA93wSEBHByNsgIAOw==",frames:["0","1"],w:4,h:4},MOUSE:{sprite:"CAADAMIEAAAAAAEBAepMTHx8fP///////////////yH5BAEKAAQALAAAAAAIAAMAAAMLSDS6CoOJCGOIIwEAOw==",frames:["0",
    "1"],w:4,h:3},FIRE:{sprite:"DwADAMICAC8iErxhB/+DCv/ICv30BP////+DCv+DCiH5BAEKAAcALAAAAAAPAAMAAAMTeCeq0/AM8hZhCihByp3eAwRaAgA7",frames:["0","1","dead"],w:5,h:3},STONE:{sprite:"CAAIAKECAE5MSV5bV////////yH5BAEKAAIALAAAAAAIAAgAAAINhBFxl9aLFJxvpcrkKgA7",frames:["0"],w:8,h:8},CACTUS:{sprite:"AwAFAMIFAFJTDCd8HkibQFCxJVu8Qf///////////yH5BAEKAAcALAAAAAADAAUAAAMJCBIxSgEMsUYCADs=",frames:["0"],w:3,h:5},BIG_CACTUS:{sprite:"BQAKAMIBAFJTDCd8HkibQFCxJeqV7Sd8Hid8Hid8HiH5BAEKAAcALAAAAAAFAAoAAAMVGBIwvYIwJ0ZkwTZSgxrMVoGOt1gJADs=",
    frames:["0"],w:5,h:10},BAT:{sprite:"BgACAKECAAAAADEnNv///////yH5BAEKAAIALAAAAAAGAAIAAAIFjAwiaVEAOw==",frames:["0","1"],w:3,h:2},HYDRA:{sprite:"FQAHAKEDAAAAAHk+PvQfH////yH5BAEKAAMALAAAAAAVAAcAAAIk1I4Cp+gD4gFGwveWvRzF1SyMRmrc56BDAElsK04b7Knw9i0FADs=",frames:["0","1","dead"],w:7,h:7},SHOT:{sprite:"DAADAMIEAMvIvdLRzvTz8f///wAAAAAAAAAAAAAAACH5BAEKAAQALAAAAAAMAAMAAAMQCARBIUQMMpUjEdfVXpxDAgA7",frames:["0","1","2","3"],w:3,h:3},BALL:{sprite:"AQABAIABAM/Nzf///yH5BAEKAAEALAAAAAABAAEAAAICRAEAOw==",frames:["0"],
    w:1,h:1},POWERUP_GP:{sprite:"BAACAKEAAAAAAP///wAAAAAAACH5BAEKAAIALAAAAAAEAAIAAAIERGJgBQA7",frames:["0","1"],w:2,h:2},POWERUP_SU:{sprite:"BAACAKEBAAAAAPkWFvkWFvkWFiH5BAEKAAIALAAAAAAEAAIAAAIERGJgBQA7",frames:["0","1"],w:2,h:2},POWERUP_DD:{sprite:"BAACAKEAAAAAABah+QAAAAAAACH5BAEKAAIALAAAAAAEAAIAAAIERGJgBQA7",frames:["0","1"],w:2,h:2}},WHOLE_NOTE=1920,NOTES={C3:130.81,E3:164.81,F3:174.61,G3:196,A3:220,C4:261.63,D4:293.66,E4:329.63,F4:349.23,F4S:369.99,G4:392,A4:440,C5:523.35,D5:587.33},MUSIC={T0:{oType:"triangle",
    notes:["A3",1,"A3",1,"G3",1,"G3",1,"F3",1,"F3",1,"E3",1,"C3",1]},T1:{oType:"sawtooth",notes:["A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"A4",8,"A4",16,0,16,"A4",8,0,8,"G4",8,0,8,"A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"G4",8,"G4",16,0,16,"G4",8,0,8,"F4",8,0,8,"A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"F4",8,"F4",16,0,16,"F4",8,0,8,"E4",8,0,8,"A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"E4",8,"E4",16,0,16,"E4",8,0,8,"C4",8,0,8]}},COLOR_WHITE=
        "#f9d4c1",COLOR_RED="#f65555",COLOR_BLUE="#1499ff",WIN_MESSAGES=["YOU WIN!","DONE!","YOU ROCK!","GOOD JOB!"],LOSE_MESSAGES=["NOT TODAY","MAYBE, NEXT TIME","YOU WERE NEAR","YOU LOSE"],LAND=[[65,26,50],[100,44,38],[40,77,66]],SAND=[[236,193,89],[203,193,135],[239,222,128]],DARK_SAND=[[196,143,59],[163,133,95],[179,182,88]],SKY=[[93,139,228],[98,144,233],[103,149,238],[108,154,243]],NIGHT_SKY=[[41,2,100],[47,5,107],[37,3,93],[0,2,96]];
function extend(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c}function random(a,b){return Math.floor(Math.random()*(b-a+1))+a}function on(a,b,c){on.keys[a]={listeners:[b,c],isPressed:!1}}on.keys={};function off(){on.keys={}}window.addEventListener("keydown",function(a){a.code in on.keys&&!on.keys[a.code].isPressed&&(on.keys[a.code].listeners[0]&&on.keys[a.code].listeners[0](),on.keys[a.code].isPressed=!0)});
window.addEventListener("keyup",function(a){a.code in on.keys&&(on.keys[a.code].listeners[1]&&on.keys[a.code].listeners[1](),on.keys[a.code].isPressed=!1)});function haveCollision(a,b){var c=a.y<=b.y&&a.y+a.h>=b.y,d=a.y>=b.y&&a.y<=b.y+b.h,e=a.x<=b.x&&a.x+a.w>=b.x,f=a.x>=b.x&&a.x<=b.x+b.w;return c&&e||c&&f||d&&e||d&&f}var getUniqueID=function(){var a=0;return function(){return++a}}();function createCanvas(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;return c}
function disableCanvasSmoothness(a){a.mozImageSmoothingEnabled=!1;a.msImageSmoothingEnabled=!1;a.imageSmoothingEnabled=!1}function loadImages(a,b){function c(){var e=d.pop(),f=a[e].sprite,g=new Image;g.onload=function(){a[e].sprite=this;d.length?c():b()};g.src="data:"+IMAGE_TYPE+";base64,R0lGODlh"+f}var d=Object.keys(a);c()}function iterateImageData(a,b){function c(a,b,c){d[f]=a;d[f+1]=b;d[f+2]=c}var d=a.data,e=d.length,f;for(f=0;f<e;f+=4)b(d[f],d[f+1],d[f+2],c)}
function Timers(){this.timers={};this.idCounter=0}Timers.prototype.setTimeout=function(a,b,c,d){var e=this;"function"==typeof a?(d=c,c=b,b=a,a=e.idCounter++):e.clearTimeout(e.timers[a]);e.timers[a]={timerID:setTimeout(function(){b();delete e.timers[a]},c),triggerBeforeClear:d,callback:b};return a};Timers.prototype.clearTimeout=function(a){var b=this.timers[a];b&&(b.triggerBeforeClear&&b.callback(),clearTimeout(b.timerID),delete this.timers[a])};
Timers.prototype.nullifyTimers=function(){Object.keys(this.timers).forEach(this.clearTimeout.bind(this));this.timers={};this.idCounter=0};function Texture(a,b,c){this.colors=c;this.canvas=createCanvas(a,b);this.ctx=this.canvas.getContext("2d");disableCanvasSmoothness(this.ctx);this.imageData=this.ctx.createImageData(a,b)}
Texture.prototype.generate=function(a){var b=this.imageData.data,c,d;a=a||PIXEL_SIZE;for(d=0;d<b.length;d+=4)c=this.colors[random(0,this.colors.length-1)],b[d]=c[0],b[d+1]=c[1],b[d+2]=c[2],b[d+3]=255;this.ctx.putImageData(this.imageData,0,0);this.ctx.save();this.ctx.scale(a,a);this.ctx.drawImage(this.canvas,0,0);this.ctx.restore();return this.ctx.createPattern(this.canvas,"repeat")};
function Animation(a){var b=a.frames.length,c=a.w*PIXEL_SIZE,d=a.h*PIXEL_SIZE,e,f,g,h;e=createCanvas(c*b,d).getContext("2d");disableCanvasSmoothness(e);e.scale(PIXEL_SIZE,PIXEL_SIZE);e.drawImage(a.sprite,0,0);for(this.frames={};b--;)f=createCanvas(c,d),g=f.getContext("2d"),h=e.getImageData(c*b,0,c,d),g.putImageData(h,0,0),this.frames[a.frames[b]]=new Image,this.frames[a.frames[b]].src=f.toDataURL(IMAGE_TYPE),g.clearRect(0,0,c,d),g.scale(-1,1),g.drawImage(this.frames[a.frames[b]],-c,0),this.frames[a.frames[b]+
"R"]=new Image,this.frames[a.frames[b]+"R"].src=f.toDataURL(IMAGE_TYPE)}Animation.prototype.getFrame=function(a,b){return this.frames[a+(b?"R":"")]};function Glitch(a,b,c,d,e){this.update(a,b,c,d,e);this.id=getUniqueID();level.glitches&&(level.glitches[this.id]=this)}Glitch.prototype.update=function(a,b,c,d,e){this.x=a;this.y=b;this.w=c;this.h=d;this.intensity=e||this.intensity||1};Glitch.prototype.remove=function(){delete level.glitches[this.id]};
Glitch.distort=function(a,b,c){var d=a.width,e=a.height,f=createCanvas(d+2*b,e+2*b),g=f.getContext("2d"),h,k,l;for(g.putImageData(a,b,b);c--;)a=random(b,b+10),h=random(b,b+10),k=random(16,d+32),l=random(8,e/2+8),a=g.getImageData(a,h,k,l),a=Glitch.shift(a),g.putImageData(a,random(b/2,d/2+b/2),random(b,1.2*e));return f};Glitch.shift=function(a){switch(random(0,3)){case 0:iterateImageData(a,function(a,c,d,e){e(a-100,c-100,d-100)});break;case 1:iterateImageData(a,function(a,c,d,e){e(a+100,c+100,d+100)})}return a};
function Shot(a,b,c,d,e,f,g,h){b=SPRITES[b];this.id=getUniqueID();this.emitter=a;this.dir=e;this.w=b.w*PIXEL_SIZE;this.h=b.h*PIXEL_SIZE;this.x=this.startX=c+.5*PIXEL_SIZE*this.dir-(0>this.dir?this.w:0);this.y=d+1*PIXEL_SIZE;this.speed=f||random(12,15);this.range=g||random(400,1E3);this.power=h||random(15,30);this.animation=new Animation(b);this.lastFrameNumber=b.frames.length-1;this.creationTime=currentTime;level.attacks&&(level.attacks[this.id]=this)}
Shot.prototype.tick=function(){var a=this,b=a.emitter==hero;a.x+=a.speed*a.dir;b?level.iterateUnits(hero.id,!0,function(b){if(haveCollision(b,a))return delete level.attacks[a.id],b.hit(a.power),0}):haveCollision(hero,a)&&(delete level.attacks[a.id],hero.hit(a.power));Math.abs(a.startX-a.x)>=a.range&&level.attacks[a.id]&&delete level.attacks[a.id]};
Shot.prototype.getAnimationFrame=function(){var a;a=Math.floor((currentTime-this.creationTime)/100);return this.animation.getFrame(a<=this.lastFrameNumber?a:this.lastFrameNumber)};function Beam(a){this.id=getUniqueID();this.w=1E3;this.power=a;this.glitch=new Glitch(this.x,this.y,1E3,PIXEL_SIZE,1);this.stepsLeft=2;this.update();level.attacks[this.id]=this}
Beam.prototype.update=function(){0>this.stepsLeft?(hero.speed=hero.defaultSpeed,this.glitch.remove(),delete level.attacks[this.id]):(hero.speed=4,gameTimers.setTimeout(this.update.bind(this),800),this.stepsLeft--)};
Beam.prototype.tick=function(){var a=this;a.h=(5-2*a.stepsLeft)*PIXEL_SIZE;a.x=hero.x+(0>hero.dir?-a.w:hero.w);a.y=hero.y+a.stepsLeft*PIXEL_SIZE;a.glitch.update(a.x,a.y,a.w,a.h,3-a.stepsLeft);level.iterateUnits(hero.id,!0,function(b){haveCollision(b,a)&&(b.hp<=a.power?b.bump(a,10*hero.dir,-5):b.hit(a.power))})};
function Shrapnel(a,b,c){var d=SPRITES.BALL;this.id=getUniqueID();this.dir=c;this.w=d.w*PIXEL_SIZE;this.h=d.h*PIXEL_SIZE;this.x=a+.5*PIXEL_SIZE*this.dir-(0>this.dir?this.w:0);this.y=b-2*PIXEL_SIZE;this.ay=-random(10,18);this.speed=random(4,10);this.power=random(3,6);this.animation=new Animation(d);level.attacks[this.id]=this}
Shrapnel.prototype.tick=function(){this.x+=this.speed*this.dir;this.y+this.h+this.ay<GAME_H?this.y+=++this.ay:delete level.attacks[this.id];haveCollision(hero,this)&&(delete level.attacks[this.id],hero.hit(this.power))};Shrapnel.prototype.getAnimationFrame=function(){return this.animation.getFrame(0)};function powerupGlitchPlus(a){a.glitchUp(random(10,20))}function powerupSpeedUp(a){a.speed=Math.floor(1.6*a.defaultSpeed);gameTimers.setTimeout("powerupSU",function(){a.speed=a.defaultSpeed},7E3)}
function powerupDoubleDamage(a){a.damageFactor=2;gameTimers.setTimeout("powerupDD",function(){a.damageFactor=1},7E3)}function Powerup(a,b){var c;this.id=getUniqueID();this.creationTime=currentTime;c=Powerup.EFFECTS[random(0,Powerup.EFFECTS.length-1)];this.effect=c[0];c=c[1];this.animation=new Animation(c);this.x=a;this.y=b;this.w=c.w*PIXEL_SIZE;this.h=c.h*PIXEL_SIZE;this.hp=3;this.gp=0;level.units[this.id]=this}Powerup.prototype.tick=function(){5E3<=currentTime-this.creationTime&&this.absorb()};
Powerup.prototype.hit=function(){this.hp--;this.hp||this.absorb()};Powerup.prototype.bump=function(a){this.absorb(a)};Powerup.prototype.absorb=function(a){var b=this;a==hero&&b.effect(a);gameTimers.setTimeout(function(){delete level.units[b.id]},0)};Powerup.prototype.getAnimationFrame=function(){return this.animation.getFrame(isOdd?0:1)};Powerup.EFFECTS=[[powerupGlitchPlus,SPRITES.POWERUP_GP],[powerupSpeedUp,SPRITES.POWERUP_SU],[powerupDoubleDamage,SPRITES.POWERUP_DD]];function Unit(){}
Unit.prototype.applyBorders=function(a){this.x=this.x+this.ax>0-a?this.x+this.w+this.ax<level.w+a?this.x+this.ax:level.w-this.w+a:0-a};Unit.prototype.applyFriction=function(){this.isLanded&&!this.isRunning&&(0>this.ax?this.ax++:0<this.ax&&this.ax--)};Unit.prototype.applyGravity=function(){this.y+this.h+this.ay<GAME_H?this.y+=++this.ay:(this.y=GAME_H-this.h,this.ay=0)};Unit.prototype.getLandingState=function(){this.isLanded=this.y+this.h==GAME_H};
Unit.prototype.jump=function(a){this.isLanded&&(this.ay-=a)};Unit.prototype.clearTimers=function(){var a=this;a.timers&&Object.keys(a.timers).forEach(function(b){gameTimers.clearTimeout(a.timers[b])})};
function Hero(a){var b=SPRITES.HERO;this.x=a;this.y=200;this.w=b.w*PIXEL_SIZE;this.h=b.h*PIXEL_SIZE;this.ax=0;this.ay=-9;this.speed=this.defaultSpeed=10;this.damageFactor=this.dir=1;off();on("ArrowRight",this.run.bind(this),this.stop.bind(this));on("ArrowLeft",this.run.bind(this,!0),this.stop.bind(this,!0));on("ArrowUp",this.jump.bind(this,24));on("KeyZ",this.attack.bind(this,"shot",1));on("KeyX",this.attack.bind(this,"beam",15));on("KeyC",this.attack.bind(this,"xxxx",15));this.animation=new Animation(b);
    this.timers={};this.glitchAmount=this.maxGlitchAmount=25;this.oneThird=this.maxGlitchAmount/3;this.glitch=new Glitch(this.x,this.y,this.w,this.h,this.getGlitchIntensity());this.glitchUp();this.glitchTrail()}extend(Hero,Unit);Hero.prototype.tick=function(){this.applyBorders(0);this.applyFriction();this.applyGravity();this.getLandingState()};Hero.prototype.ownTick=function(){var a=this;level.iterateUnits(a.id,!0,function(b){haveCollision(a,b)&&(a.hit(b.gp),b.bump(a,a.ax,-12))})};
Hero.prototype.glitchUp=function(a){gameTimers.clearTimeout(this.timers.glitch);this.glitchAmount+=a||1;this.glitchAmount>this.maxGlitchAmount?this.glitchAmount=this.maxGlitchAmount:0>this.glitchAmount&&(this.glitchAmount=0);0==this.glitchAmount?this.kill():(this.timers.glitch=gameTimers.setTimeout(this.glitchUp.bind(this),800),this.pushedWithForce=a)};
Hero.prototype.glitchTrail=function(){this.glitch.update(this.x,this.y,this.w,this.h,this.getGlitchIntensity());this.timers.trail=gameTimers.setTimeout(this.glitchTrail.bind(this),70)};Hero.prototype.getGlitchIntensity=function(){return Math.ceil(this.glitchAmount/this.oneThird)};
Hero.prototype.run=function(a,b){var c=a?-1:1;if(b||!this.isRunning||this.dir!=c)gameTimers.clearTimeout(this.timers.run),this.isRunning=!0,this.dir=c,this.ax=a?-this.speed:this.speed,this.timers.run=gameTimers.setTimeout(this.run.bind(this,a,!0),50)};Hero.prototype.stop=function(a){this.dir==(a?-1:1)&&(gameTimers.clearTimeout(this.timers.run),this.isRunning=!1)};
Hero.prototype.attack=function(a,b){var c=this.x+(0>this.dir?0:this.w);this.glitchAmount<=b||(this.glitchAmount-=b,"shot"==a?new Shot(this,"SHOT",c,this.y,this.dir,null,1E3,10*this.damageFactor):"beam"==a&&new Beam(5*this.damageFactor))};Hero.prototype.hit=function(a){this.glitchUp(-a)};Hero.prototype.bump=function(a,b,c){gameTimers.clearTimeout(this.timers.run);gameTimers.setTimeout(this.stop.bind(this),300);this.ax=b||-this.ax;this.ay=c||-5};
Hero.prototype.kill=function(){this.dead=!0;this.ax=0;this.glitch.remove();this.clearTimers();off();level.lose()};Hero.prototype.getAnimationFrame=function(){var a=0>this.dir;return this.dead?this.animation.getFrame("dead"):this.pushedWithForce?(this.pushedWithForce--,this.animation.getFrame("punched",a)):this.isLanded?this.isRunning?this.animation.getFrame(isOdd?"stepLeft":"stepRight",a):this.animation.getFrame("still",a):this.animation.getFrame("jump",a)};function Enemy(){}extend(Enemy,Unit);
Enemy.prototype.tick=function(){this.applyBorders(this.w);this.applyGravity();this.glitch&&this.glitch.update(this.x,this.y,this.w,this.h);this.x<=-this.w&&!this.dead&&this.kill()};Enemy.prototype.hit=function(a){this.hp-=a;0>=this.hp&&this.kill()};Enemy.prototype.bump=function(a,b,c){this.dead=!0;this.clearTimers();this.ax=b;this.ay=c;gameTimers.setTimeout(this.kill.bind(this),500)};
Enemy.prototype.kill=function(){var a=this;a.glitch=new Glitch(a.x,a.y,a.w,a.h,3);a.dead=!0;a.clearTimers();a.ax=0;a.ay=0;gameTimers.setTimeout(function(){a.glitch.remove();delete level.units[a.id];18>random(0,100)&&new Powerup(a.x+1*PIXEL_SIZE,a.y+a.h-2*PIXEL_SIZE);a.killToWin&&level.stepToWin()},500)};Enemy.prototype.setCommons=function(a){this.w=a.w*PIXEL_SIZE;this.h=a.h*PIXEL_SIZE;this.animation=new Animation(a)};
function Bird(a){var b=SPRITES.BIRD;this.hp=10;this.gp=4;this.setCommons(b);this.x=a;this.y=this.startY=random(50,GAME_H-250);this.ax=0;this.ay=random(-5,5);this.speed=random(4,6);this.timers={};this.shoot()}extend(Bird,Enemy);Bird.prototype.ownTick=function(){this.ax=-this.speed;this.ay+=this.y-30>this.startY?-6:1};
Bird.prototype.shoot=function(){new Shrapnel(this.x,this.y,-1);new Shrapnel(this.x,this.y,-1);new Shrapnel(this.x,this.y,-1);this.timers.shoot=gameTimers.setTimeout(this.shoot.bind(this),2E3)};Bird.prototype.getAnimationFrame=function(){return this.animation.getFrame(isOdd?0:1)};function Mouse(a){var b=SPRITES.MOUSE;this.hp=10;this.gp=2;this.setCommons(b);this.x=a;this.y=GAME_H-this.w;this.ay=this.ax=0;this.speed=5}extend(Mouse,Enemy);
Mouse.prototype.ownTick=function(){this.ax=-this.speed;500>=this.x-hero.x+hero.w&&(this.speed=15)};Mouse.prototype.getAnimationFrame=function(){return this.animation.getFrame(15>this.speed?0:1)};function Fire(a){var b=SPRITES.FIRE;this.hp=1;this.gp=3;this.setCommons(b);this.x=a;this.y=GAME_H-this.h;this.ay=this.ax=0}extend(Fire,Enemy);Fire.prototype.bump=function(a){a==hero&&hero.bump(this);this.kill()};
Fire.prototype.getAnimationFrame=function(){return this.dead?this.animation.getFrame("dead"):this.animation.getFrame(isOdd?0:1)};function Stone(a){var b=SPRITES.STONE;this.gp=this.hp=1;this.setCommons(b);this.x=a;this.y=GAME_H-this.h;this.ay=this.ax=0;this.isReversed=random(0,1);this.hitCounter=0}extend(Stone,Enemy);Stone.prototype.hit=function(){this.hitCounter++;0==this.hitCounter%5?level.addUnit(new Mouse(this.x)):11<=this.hitCounter&&this.kill()};Stone.prototype.bump=function(a){a==hero&&a.bump(this)};
Stone.prototype.getAnimationFrame=function(){return this.animation.getFrame(0,this.isReversed)};function Cactus(a){var b=SPRITES.CACTUS;this.hp=30;this.gp=8;this.setCommons(b);this.x=a;this.y=GAME_H-this.h;this.ay=this.ax=0}extend(Cactus,Enemy);Cactus.prototype.hit=function(a){new Shot(this,"BALL",this.x,this.y,-1,a+5,800,4);new Shot(this,"BALL",this.x+this.w,this.y,1,a+5,800,4);this.hp-=a;0>=this.hp&&this.kill()};Cactus.prototype.bump=function(){this.kill()};Cactus.prototype.getAnimationFrame=function(){return this.animation.getFrame(0)};
function BigCactus(a){var b=SPRITES.BIG_CACTUS;this.hp=300;this.gp=15;this.setCommons(b);this.x=a;this.y=GAME_H-this.h;this.ay=this.ax=0;this.timers={};this.shoot()}extend(BigCactus,Enemy);BigCactus.prototype.shoot=function(a){var b=random(0,1)?-1:1,c=random(0,5)*PIXEL_SIZE;new Shot(this,a?"BALL":"SHOT",this.x+(0>b?0:this.w),this.y+c,b,random(6,14),random(700,1300),3);a||(this.timers.shoot=gameTimers.setTimeout(this.shoot.bind(this),800))};
BigCactus.prototype.hit=function(a){this.shoot(!0);this.hp-=a;0>=this.hp&&this.kill()};BigCactus.prototype.bump=function(){this.hp-=75;0>=this.hp&&this.kill()};BigCactus.prototype.getAnimationFrame=function(){return this.animation.getFrame(0)};function Bat(a){var b=SPRITES.BAT;this.hp=30;this.gp=1;this.setCommons(b);this.x=a;this.y=random(50,GAME_H-250);this.ax=0;this.ay=random(-2,2);this.vDir=this.dir=1;this.speed=5;this.retreatCoef=1;this.timers={};this.hunt()}extend(Bat,Enemy);
Bat.prototype.ownTick=function(){this.ax=this.speed*this.dir;120>=this.y?this.vDir=this.retreatCoef=1:this.y>=GAME_H-70&&(this.vDir=-1);this.ay=4*this.vDir*this.retreatCoef};Bat.prototype.hunt=function(){var a=Math.abs(this.x-hero.x);600>a?(this.speed=8,1==this.retreatCoef&&(this.vDir=1)):800>a?(this.speed=5,this.dir*=random(0,1)?-1:1):(this.speed=5,this.dir=-(a/(this.x-hero.x)));this.timers.hunt=gameTimers.setTimeout(this.hunt.bind(this),150)};
Bat.prototype.bump=function(){this.y-=18;this.vDir=-1;this.retreatCoef=4};Bat.prototype.getAnimationFrame=function(){return this.dead?this.animation.getFrame(0):this.animation.getFrame(Math.floor(currentTime/300)%2?0:1)};function Hydra(a){var b=SPRITES.HYDRA;this.hp=500;this.gp=8;this.setCommons(b);this.x=a;this.y=GAME_H-this.h;this.ay=this.ax=0;this.dir=-1;this.timers={};this.attack();this.attacksCount=0}extend(Hydra,Enemy);
Hydra.prototype.ownTick=function(){this.getLandingState();this.isLanded&&(this.dir=this.x>hero.x?-1:1,0<this.ax&&this.isLanded?this.ax--:0>this.ax&&this.isLanded&&this.ax++)};Hydra.prototype.attack=function(){this.attacksCount++;4<=this.attacksCount?(this.dance(),this.attacksCount=0):this.shoot();this.timers.attack=gameTimers.setTimeout(this.attack.bind(this),2E3)};
Hydra.prototype.shoot=function(){var a=this.x+(0>this.dir?0:this.w);new Shot(this,"BALL",a,this.y,this.dir,10,1E3,1);new Shot(this,"BALL",a,this.y,this.dir,8,1E3,2);new Shot(this,"BALL",a,this.y,this.dir,6,1E3,3);new Shrapnel(this.x,this.y,-1);new Shrapnel(this.x,this.y,-1);new Shrapnel(this.x,this.y,1);new Shrapnel(this.x,this.y,1)};Hydra.prototype.dance=function(){this.ax=20*this.dir;this.jump(9);this.dir*=-1};Hydra.prototype.bump=function(a){a==hero&&a.bump(this,2*-a.ax,-15);this.hit(100)};
Hydra.prototype.getAnimationFrame=function(){return this.dead?this.animation.getFrame("dead",0<this.dir):this.animation.getFrame(Math.floor(currentTime/1E3)%2?0:1,0<this.dir)};function Camera(){this.canvas=document.querySelector("canvas");this.ctx=this.canvas.getContext("2d");this.y=this.x=0;this.w=CAMERA_W;this.H=576;this.h=GAME_H;this.heightDiff=this.H-this.h;this.textureWidth=8*this.heightDiff;this.parallaxFactor=4;this.mask=document.querySelector("#mask")}
Camera.prototype.fade=function(){self.mask.className="on"};Camera.prototype.unfade=function(){self.mask.className=""};
Camera.prototype.clear=function(){this.x+START_X+50>this.focus.x&&0<this.x?(this.x=this.focus.x-START_X-50,this.x=0>this.x?0:this.x):this.x+START_X+200<this.focus.x&&this.x+this.w<level.w&&(this.x=this.focus.x-START_X-200,this.x=this.x+this.w>level.w?level.w-this.w:this.x);this.ctx.fillStyle=level.sky;this.ctx.save();this.ctx.translate(-this.x%this.textureWidth/this.parallaxFactor,0);this.ctx.fillRect(0,0,this.w+this.textureWidth/this.parallaxFactor,this.h);this.ctx.restore();this.ctx.fillStyle=level.land;
    this.ctx.save();this.ctx.translate(-this.x%this.textureWidth,0);this.ctx.fillRect(0,this.h,this.w+this.textureWidth,this.H);this.ctx.restore()};Camera.prototype.draw=function(a){this.isInBounds(a)&&(a.getAnimationFrame?this.ctx.drawImage(a.getAnimationFrame(),a.x-this.x,a.y-this.y):(this.ctx.fillStyle=a.color||"#000",this.ctx.fillRect(a.x-this.x,a.y-this.y,a.w,a.h)))};
Camera.prototype.drawAttacks=function(){var a=this;Object.keys(level.attacks).forEach(function(b){b=level.attacks[b];a.isInBounds(b)&&b.getAnimationFrame&&a.ctx.drawImage(b.getAnimationFrame(),b.x-a.x,b.y-a.y,b.w,b.h)})};
Camera.prototype.drawGlitches=function(){if(!isOdd&&!random(0,1)){var a=this;Object.keys(level.glitches).forEach(function(b){b=level.glitches[b];var c,d;a.isInBounds(b)&&(c=a.ctx.getImageData(b.x-a.x,b.y-a.y,b.w,b.h),d=12*b.intensity,a.ctx.drawImage(Glitch.distort(c,d,b.intensity),b.x-a.x-d,b.y-a.y-d))})}};
Camera.prototype.drawText=function(a){var b=a.shake?random(-a.shake,a.shake):0,c=a.shake?random(-a.shake,a.shake):0;this.ctx.font=a.font;this.ctx.textAlign=a.center?"center":"left";this.ctx.shadowColor="#000";this.ctx.shadowBlur=2;this.ctx.lineWidth=3;this.ctx.strokeText(a.text,a.x+b+1,a.y+c+1);this.ctx.shadowBlur=0;this.ctx.fillStyle=a.color;this.ctx.fillText(a.text,a.x+b-1,a.y+c-1)};
Camera.prototype.postEffects=function(){var a,b,c,d;level.texts.forEach(this.drawText.bind(this));hero&&(a=hero.glitchAmount,b=255-10*a,c=9*a,d=40,15>a&&(b+=10*(15-a),c-=5*(15-a),d-=15-a),this.drawText({text:"G "+a,font:"italic bold 46px Verdana",color:"rgb("+(0>b?0:255<b?255:b)+", "+(0>c?0:255<c?255:c)+", "+d+")",x:40,y:60,shake:6>a?2:10>a?1:0}))};Camera.prototype.isInBounds=function(a){return a.x<this.x+this.w&&a.y<this.y+this.h&&a.x+a.w>this.x&&a.y+a.h>this.y};
Camera.prototype.focusOn=function(a){this.focus=a};Camera.prototype.reset=function(){this.x=0};
function Level(a,b,c){this.meta=Level.LEVELS[a];this.w=this.meta.width;this.land=(new Texture(camera.textureWidth,camera.heightDiff,this.meta.land)).generate();this.sky=(new Texture(camera.textureWidth/camera.parallaxFactor,camera.h,this.meta.sky)).generate(8);this.units={};this.attacks={};this.glitches={};this.ambushesPointer=this.heroFarthestX=0;this.winSteps=this.meta.ambushes.reduce(function(a,b){return b[5]&&"number"==typeof b[4]?a+b[2]:b[5]?a+b[4].length:a},0);this.winCallback=b;this.loseCallback=
        c;this.textsCopy=this.meta.texts.slice(0);this.texts=[]}Level.prototype.update=function(a){var b=this.meta.ambushes,c=b.length,d=this.ambushesPointer,e,f,g,h;a>this.heroFarthestX&&(this.heroFarthestX=a);for(;d<c;)if(e=b[d],a=e[0],h=e[5],a<=this.heroFarthestX){f=e[1];g=random(e[2],e[3]);e=e[4];"number"==typeof e&&(e=Level.createSpreadArray(g,0,e));for(g=0;g<e.length;g++)level.addUnit(new f(a+CAMERA_W+e[g]),h);++d}else break;this.ambushesPointer=d};
Level.prototype.updateText=function(){var a=this.textsCopy,b,c;for(c=this.texts.length;c--;)b=this.texts[c],(b.upToX<=camera.x||b.upToTime&&b.upToTime<currentTime)&&this.texts.splice(c,1);for(c=0;c<a.length;)if(b=a[c],camera.x>=b[0])this.texts.push(Level.applyTextDefaults(b[2],b[1])),++c;else break;this.textsCopy=this.textsCopy.slice(c)};Level.prototype.stepToWin=function(){this.winSteps--;!this.winSteps&&this.win()};
Level.prototype.win=function(){var a;this.isLost||(a=this.meta.last?"YOUR GLITCH JOURNEY IS DONE!":WIN_MESSAGES[random(0,WIN_MESSAGES.length-1)],this.isLost=!1,this.textsCopy.unshift([camera.x-CAMERA_W,camera.x+CAMERA_W,{text:a,font:"italic bold 56px Verdana",color:COLOR_RED,x:CAMERA_W/2,y:250,center:!0}]),gameTimers.setTimeout(this.winCallback,this.meta.last?3E3:1800))};
Level.prototype.lose=function(){!1!==this.isLost&&!0!==this.isLost&&(this.isLost=!0,this.textsCopy.unshift([camera.x-CAMERA_W,camera.x+CAMERA_W,{text:LOSE_MESSAGES[random(0,LOSE_MESSAGES.length-1)],font:"italic bold 56px Verdana",color:COLOR_WHITE,x:CAMERA_W/2,y:250,center:!0}]),gameTimers.setTimeout(this.loseCallback,2E3))};Level.prototype.addUnit=function(a,b){a.id=getUniqueID();a.killToWin=b;this.units[a.id]=a};
Level.prototype.iterateUnits=function(a,b,c){var d=Object.keys(this.units),e,f;for(f=0;f<d.length&&(e=d[f],a&&e==a||b&&this.units[e].dead||0!=c(this.units[e]));f++);};Level.prototype.iterateAttacks=function(){Object.keys(this.attacks).forEach(function(a){this.attacks[a].tick()},this)};Level.createSpreadArray=function(a,b,c){for(var d=[];a--;)d.push(random(b,c));return d};
Level.applyTextDefaults=function(a,b){var c={};c.text=a.text;c.font=a.font||"italic bold 30px Verdana";c.color=a.color||COLOR_WHITE;c.center=a.center||!1;c.shake=a.shake||0;c.x=a.x||50;c.y=a.y||GAME_H+80;c.upToX=b;c.upToTime=a.duration?currentTime+1E3*a.duration:0;return c};
Level.LEVELS={0:{width:8E3,land:LAND,sky:SKY,ambushes:[[0,Fire,1,1,0],[700,Fire,5,5,[0,100,200,300,400]],[6200,Fire,1,1,0,!0]],texts:[[0,500,{text:"USE ARROWS TO MOVE AND JUMP",duration:5}],[500,1E3,{text:"PRESS Z FOR A COMMON ATTACK",duration:5}],[1E3,1600,{text:"PRESS X FOR A GLITCH BEAM",duration:5}],[1600,2200,{text:"EACH ATTACK SPENDS YOUR GLITCH",duration:5}],[2200,2800,{text:"GLITCH LEVEL IS DISPLAYED IN THE TOP LEFT",duration:5}],[2800,3400,{text:"COLORED BLOCKS WILL POWER-UP YOU",duration:5}],
    [3400,4E3,{text:"WHITE WILL GIVE YOU GLITCH",duration:5}],[4E3,4600,{text:"RED WILL IMPROVE YOUR SPEED",duration:5}],[4600,5200,{text:"AND BLUE WILL DOUBLE YOUR DAMAGE",duration:5}],[5200,5800,{text:"REMEMBER, GLITCH IS YOUR LIFE",duration:5}],[5800,6400,{text:"IF IT ENDS, YOU'LL DIE",duration:5}],[6400,7E3,{text:"AND, UNLIKE THAT FIRE, YOUR GLITCH MUST LIVE",duration:8}]]},1:{width:7E3,land:LAND,sky:SKY,ambushes:[[-1200,Fire,6,6,[700,2E3,2800,3800,4E3,6200]],[0,Stone,2,2,[1800,4E3]],[1400,Bird,2,
    3,100],[2E3,Mouse,3,4,600],[2200,Bird,3,3,[1E3,1100,2600]],[2800,Mouse,3,3,[300,400,500]],[3200,Bird,2,3,700],[3400,Mouse,4,4,[0,100,200,300]],[3800,Bat,3,5,500,!0]],texts:[[0,500,{text:"BY THE WAY, MY NAME IS NICH",duration:5,color:COLOR_BLUE}],[500,1E3,{text:"NICH THE GLITCH RABBIT",duration:5,color:COLOR_BLUE}],[1100,1500,{text:"O-OH, BEWARE!",duration:5,color:COLOR_BLUE}]]},2:{width:7E3,land:SAND,sky:SKY,ambushes:[[600,Cactus,3,6,3600],[700,Fire,4,4,[0,100,200,300]],[1E3,Bird,2,3,600],[1500,Mouse,
    2,4,1400],[1500,Stone,1,1,0],[1900,Fire,1,1,0],[2200,Bird,3,4,[0,200,400,600]],[2600,Mouse,4,4,[200,300,400,500]],[3200,BigCactus,1,1,1600,!0]],texts:[[0,500,{text:"I HEARD THAT CACTUS NEEDLES ARE DANGEROUS",duration:5,color:COLOR_BLUE}],[500,1E3,{text:"DON'T LET THEM HURT YOU",duration:5,color:COLOR_BLUE}]]},3:{last:!0,width:7E3,land:DARK_SAND,sky:NIGHT_SKY,ambushes:[[500,Fire,1,1,0],[800,Cactus,3,6,3600],[1E3,Mouse,3,3,[0,200,400]],[1500,Stone,1,1,0],[1800,Bird,2,3,600],[2400,Fire,1,1,100],[2500,
    Mouse,3,3,[0,200,400]],[2800,Bird,3,4,[0,200,400,600]],[3200,Bat,4,4,[200,300,400,500]],[3700,Hydra,1,1,1200,!0]],texts:[[0,500,{text:"IT'S GETTING LATE, YOU NEED TO MAKE A...",duration:5,color:COLOR_BLUE}],[500,1E3,{text:"LOOK, FIRE!",duration:5,color:COLOR_BLUE}]]}};
function Menu(a){var b=CAMERA_W/2;this.land=(new Texture(camera.textureWidth,camera.heightDiff,LAND)).generate();this.sky=(new Texture(camera.textureWidth/camera.parallaxFactor,camera.h,SKY)).generate(8);this.w=CAMERA_W;this.units={1:new Fire(random(250,820)),2:new Cactus(100)};this.textsCopy=[[0,1,{text:"PRESS Z TO PLAY",font:"italic bold 56px Verdana",color:COLOR_RED,x:b,y:190,shake:1,center:!0}],[0,1,{text:"PRESS X TO LAUNCH TUTORIAL",font:"italic bold 22px Verdana",color:COLOR_RED,x:b,y:240,center:!0}],
    [0,1,{text:"Z and X to ATTACK",x:b-b/2,y:310,center:!0}],[0,1,{text:"ARROWS to MOVE",x:b+b/2,y:310,center:!0}],[0,1,{text:"Q to toggle MUSIC",x:b,y:85,center:!0}]];this.texts=[];off();on("KeyZ",a.bind(null,1));on("KeyX",a.bind(null,0))}extend(Menu,Level);
function Music(){var a=this,b;a.context=new AudioContext;b=a.context.createGain();b.gain.value=.05;b.connect(a.context.destination);a.dest=b;a.tracks=[];a.timers=new Timers;a.start(MUSIC);window.addEventListener("keydown",function(b){"KeyQ"===b.code&&(a.isPlaying?a.end():a.start(MUSIC))})}Music.prototype.start=function(a){var b=this;b.tracks=[];Object.keys(a).forEach(function(c){b.tracks.push(new Track(b.context,b.dest,a[c],b.timers))});b.tracks.forEach(function(a){a.play()});b.isPlaying=!0};
Music.prototype.end=function(){this.tracks.forEach(function(a){a.stop()});this.isPlaying=!1};function Track(a,b,c,d){this.ctx=a;this.dest=b;this.track=c;this.pos=0;this.timers=d}Track.prototype.play=function(){var a=this.track.notes,b,c;this.pos==a.length&&(this.pos=0);b=a[this.pos];c=WHOLE_NOTE/a[this.pos+1];b&&this.playNote(a[this.pos],c);this.pos+=2;this.timers.setTimeout(this.play.bind(this),c)};
Track.prototype.playNote=function(a,b){var c=this.ctx.createOscillator();c.frequency.value=NOTES[a]/2;c.type=this.track.oType||"sine";c.connect(this.dest);c.start();this.timers.setTimeout(c.stop.bind(c),b-20,!0)};Track.prototype.stop=function(){this.timers.nullifyTimers()};var camera,level,hero,RAFID,music,currentTime,isOdd,gameTimers=new Timers,levelCount=Object.keys(Level.LEVELS).length-1,delay=700;
loadImages(SPRITES,function(){function a(){currentTime=Date.now();isOdd=100>currentTime%200;camera.clear();level.update(hero.x);level.iterateUnits(!1,!1,function(a){a.tick();!a.dead&&a.ownTick&&a.ownTick();camera.draw(a)});level.iterateAttacks();camera.drawAttacks();camera.drawGlitches();level.updateText();camera.postEffects();RAFID=window.requestAnimationFrame(a)}function b(){currentTime=Date.now();isOdd=100>currentTime%200;camera.clear();level.iterateUnits(!1,!1,function(a){a.tick();camera.draw(a)});
    level.updateText();camera.postEffects();RAFID=window.requestAnimationFrame(b)}function c(b){RAFID&&window.cancelAnimationFrame(RAFID);gameTimers.nullifyTimers();camera.reset();camera.unfade();level=new Level(b,function(){b<levelCount?(camera.fade(),gameTimers.setTimeout(c.bind(null,b+1),delay)):(camera.fade(),gameTimers.setTimeout(d,delay))},function(){camera.fade();gameTimers.setTimeout(d,delay)});hero=new Hero(START_X);level.addUnit(hero);camera.focusOn(hero);window.requestAnimationFrame(a)}function d(){RAFID&&
window.cancelAnimationFrame(RAFID);gameTimers.nullifyTimers();camera.reset();camera.unfade();level=new Menu(function(a){camera.fade();gameTimers.setTimeout(function(){c(a);camera.unfade()},delay)});camera.focusOn(level.units[1]);hero=null;window.requestAnimationFrame(b)}camera=new Camera;music=new Music;d()});</script></html>
