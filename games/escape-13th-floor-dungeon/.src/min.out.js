(()=>{function rotatePoint(point,angle){let sin=Math.sin(angle);let cos=Math.cos(angle);return{x:point.x*cos-point.y*sin,y:point.x*sin+point.y*cos}}function clamp(min,max,value){return Math.min(Math.max(min,value),max)}function collides(obj1,obj2){let rect1=getWorldRect(obj1);let rect2=getWorldRect(obj2);if(obj1.radius&&rect1.width!=rect1.height||obj2.radius&&rect2.width!=rect2.height){return false}[rect1,rect2]=[rect1,rect2].map(rect=>{if((rect==rect1?obj1:obj2).radius){rect.radius=rect.width/2;rect.x+=rect.radius;rect.y+=rect.radius}return rect});if(obj1.radius&&obj2.radius){return Math.hypot(rect1.x-rect2.x,rect1.y-rect2.y)<rect1.radius+rect2.radius}if(obj1.radius||obj2.radius){return circleRectCollision(obj1.radius?rect1:rect2,obj1.radius?obj2:obj1)}return rect1.x<rect2.x+rect2.width&&rect1.x+rect1.width>rect2.x&&rect1.y<rect2.y+rect2.height&&rect1.y+rect1.height>rect2.y}function getWorldRect(obj){let{x=0,y=0,width,height,radius}=obj.world||obj;if(obj.mapwidth){width=obj.mapwidth;height=obj.mapheight}if(radius){width=radius.x*2;height=radius.y*2}if(obj.anchor){x-=width*obj.anchor.x;y-=height*obj.anchor.y}if(width<0){x+=width;width*=-1}if(height<0){y+=height;height*=-1}return{x:x,y:y,width:width,height:height}}var noop=()=>{};var srOnlyStyle="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);";var focusParams={preventScroll:true};function addToDom(node,canvas2){let container=canvas2.parentNode;node.setAttribute("data-kontra","");if(container){let target=[...container.querySelectorAll(":scope > [data-kontra]")].pop()||canvas2;target.after(node)}else if(canvas2.nodeName=="CANVAS"){document.body.append(node)}else{canvas2.append(node)}}function removeFromArray(array,item){let index=array.indexOf(item);if(index!=-1){array.splice(index,1);return true}}function circleRectCollision(circle,rect){let{x,y,width,height}=getWorldRect(rect);do{x-=rect.sx||0;y-=rect.sy||0}while(rect=rect.parent);let dx=circle.x-Math.max(x,Math.min(circle.x,x+width));let dy=circle.y-Math.max(y,Math.min(circle.y,y+height));return dx*dx+dy*dy<circle.radius*circle.radius}var callbacks$2={};function on(event,callback){callbacks$2[event]=callbacks$2[event]||[];callbacks$2[event].push(callback)}function emit(event,...args){(callbacks$2[event]||[]).map(fn=>fn(...args))}var canvasEl;var context;var handler$1={get(target,key){if(key=="_proxy")return true;return noop}};function getCanvas(){return canvasEl}function getContext(){return context}function init$1(canvas2,{contextless=false}={}){canvasEl=document.getElementById(canvas2)||canvas2||document.querySelector("canvas");if(contextless){canvasEl=canvasEl||new Proxy({},handler$1)}if(!canvasEl){throw Error("You must provide a canvas element for the game")}context=canvasEl.getContext("2d")||new Proxy({},handler$1);context.imageSmoothingEnabled=false;emit("init");return{canvas:canvasEl,context:context}}var Vector=class _Vector{constructor(x=0,y=0,vec={}){if(x.x!=void 0){this.x=x.x;this.y=x.y}else{this.x=x;this.y=y}if(vec._c){this.clamp(vec._a,vec._b,vec._d,vec._e);this.x=x;this.y=y}}set(vec){this.x=vec.x;this.y=vec.y}add(vec){return new _Vector(this.x+vec.x,this.y+vec.y,this)}subtract(vec){return new _Vector(this.x-vec.x,this.y-vec.y,this)}scale(value){return new _Vector(this.x*value,this.y*value)}normalize(length=this.length()||1){return new _Vector(this.x/length,this.y/length)}dot(vec){return this.x*vec.x+this.y*vec.y}length(){return Math.hypot(this.x,this.y)}distance(vec){return Math.hypot(this.x-vec.x,this.y-vec.y)}angle(vec){return Math.acos(this.dot(vec)/(this.length()*vec.length()))}direction(){return Math.atan2(this.y,this.x)}clamp(xMin,yMin,xMax,yMax){this._c=true;this._a=xMin;this._b=yMin;this._d=xMax;this._e=yMax}get x(){return this._x}get y(){return this._y}set x(value){this._x=this._c?clamp(this._a,this._d,value):value}set y(value){this._y=this._c?clamp(this._b,this._e,value):value}};function factory$a(){return new Vector(...arguments)}var Updatable=class{constructor(properties){return this.init(properties)}init(properties={}){this.position=factory$a();this.velocity=factory$a();this.acceleration=factory$a();this.ttl=Infinity;Object.assign(this,properties)}update(dt){this.advance(dt)}advance(dt){let acceleration=this.acceleration;if(dt){acceleration=acceleration.scale(dt)}this.velocity=this.velocity.add(acceleration);let velocity=this.velocity;if(dt){velocity=velocity.scale(dt)}this.position=this.position.add(velocity);this._pc();this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(value){this.velocity.x=value}set dy(value){this.velocity.y=value}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(value){this.acceleration.x=value}set ddy(value){this.acceleration.y=value}isAlive(){return this.ttl>0}_pc(){}};var GameObject=class extends Updatable{init({width=0,height=0,context:context3=getContext(),render=this.draw,update=this.advance,children=[],anchor={x:0,y:0},opacity=1,rotation=0,drotation=0,ddrotation=0,scaleX=1,scaleY=1,...props}={}){this._c=[];super.init({width:width,height:height,context:context3,anchor:anchor,opacity:opacity,rotation:rotation,drotation:drotation,ddrotation:ddrotation,scaleX:scaleX,scaleY:scaleY,...props});this._di=true;this._uw();this.addChild(children);this._rf=render;this._uf=update;on("init",()=>{this.context??=getContext()})}update(dt){this._uf(dt);this.children.map(child=>child.update&&child.update(dt))}render(){let context3=this.context;context3.save();if(this.x||this.y){context3.translate(this.x,this.y)}if(this.rotation){context3.rotate(this.rotation)}if(this.scaleX!=1||this.scaleY!=1){context3.scale(this.scaleX,this.scaleY)}let width=this.width;let height=this.height;if(this.radius){width=height=this.radius*2}let anchorX=-width*this.anchor.x;let anchorY=-height*this.anchor.y;if(anchorX||anchorY){context3.translate(anchorX,anchorY)}this.context.globalAlpha=this.opacity;this._rf();if(anchorX||anchorY){context3.translate(-anchorX,-anchorY)}let children=this.children;children.map(child=>child.render&&child.render());context3.restore()}draw(){}_pc(){this._uw();this.children.map(child=>child._pc())}get x(){return this.position.x}get y(){return this.position.y}set x(value){this.position.x=value;this._pc()}set y(value){this.position.y=value;this._pc()}get width(){return this._w}set width(value){this._w=value;this._pc()}get height(){return this._h}set height(value){this._h=value;this._pc()}_uw(){if(!this._di)return;let{_wx=0,_wy=0,_wo=1,_wrot=0,_wsx=1,_wsy=1}=this.parent||{};this._wx=this.x;this._wy=this.y;this._ww=this.width;this._wh=this.height;if(this.radius){this._wrx=this.radius;this._wry=this.radius}this._wo=_wo*this.opacity;this._wsx=_wsx*this.scaleX;this._wsy=_wsy*this.scaleY;this._wx=this._wx*_wsx;this._wy=this._wy*_wsy;this._ww=this.width*this._wsx;this._wh=this.height*this._wsy;if(this.radius){this._wrx=this.radius*this._wsx;this._wry=this.radius*this._wsy}this._wrot=_wrot+this.rotation;let{x,y}=rotatePoint({x:this._wx,y:this._wy},_wrot);this._wx=x;this._wy=y;this._wx+=_wx;this._wy+=_wy}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,radius:this.radius?{x:this._wrx,y:this._wry}:void 0,opacity:this._wo,rotation:this._wrot,scaleX:this._wsx,scaleY:this._wsy}}set children(value){this.removeChild(this._c);this.addChild(value)}get children(){return this._c}addChild(...objects){objects.flat().map(child=>{this.children.push(child);child.parent=this;child._pc=child._pc||noop;child._pc()})}removeChild(...objects){objects.flat().map(child=>{if(removeFromArray(this.children,child)){child.parent=null;child._pc()}})}get radius(){return this._r}set radius(value){this._r=value;this._pc()}get opacity(){return this._opa}set opacity(value){this._opa=clamp(0,1,value);this._pc()}get rotation(){return this._rot}set rotation(value){this._rot=value;this._pc()}advance(dt){super.advance(dt);this.drotation+=this.ddrotation;this.rotation+=this.drotation}setScale(x,y=x){this.scaleX=x;this.scaleY=y}get scaleX(){return this._scx}set scaleX(value){this._scx=value;this._pc()}get scaleY(){return this._scy}set scaleY(value){this._scy=value;this._pc()}};var Sprite=class extends GameObject{init({image,width=image?image.width:void 0,height=image?image.height:void 0,...props}={}){super.init({image:image,width:width,height:height,...props})}get animations(){return this._a}set animations(value){let prop,firstAnimation;this._a={};for(prop in value){this._a[prop]=value[prop].clone();firstAnimation=firstAnimation||this._a[prop]}this.currentAnimation=firstAnimation;this.width=this.width||firstAnimation.width;this.height=this.height||firstAnimation.height}playAnimation(name){this.currentAnimation?.stop();this.currentAnimation=this.animations[name];this.currentAnimation.start()}advance(dt){super.advance(dt);this.currentAnimation?.update(dt)}draw(){if(this.image){this.context.drawImage(this.image,0,0,this.image.width,this.image.height)}if(this.currentAnimation){this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context})}if(this.color){this.context.fillStyle=this.color;if(this.radius){this.context.beginPath();this.context.arc(this.radius,this.radius,this.radius,0,Math.PI*2);this.context.fill();return}this.context.fillRect(0,0,this.width,this.height)}}};function factory$8(){return new Sprite(...arguments)}var fontSizeRegex=/(\d+)(\w+)/;function parseFont(font){if(!font)return{computed:0};let match=font.match(fontSizeRegex);let size=+match[1];let unit=match[2];let computed=size;return{size:size,unit:unit,computed:computed}}var Text=class extends GameObject{init({text="",textAlign="",lineHeight=1,font=getContext()?.font,...props}={}){text=""+text;super.init({text:text,textAlign:textAlign,lineHeight:lineHeight,font:font,...props});if(this.context){this._p()}on("init",()=>{this.font??=getContext().font;this._p()})}get width(){return this._w}set width(value){this._d=true;this._w=value;this._fw=value}get text(){return this._t}set text(value){this._d=true;this._t=""+value}get font(){return this._f}set font(value){this._d=true;this._f=value;this._fs=parseFont(value).computed}get lineHeight(){return this._lh}set lineHeight(value){this._d=true;this._lh=value}render(){if(this._d){this._p()}super.render()}_p(){this._s=[];this._d=false;let context3=this.context;let text=[this.text];context3.font=this.font;text=this.text.split("\n");if(this._fw){text.map(t=>{let parts=t.split(" ");let str=parts.shift();let nextStr=str;parts.map(part=>{nextStr+=" "+part;if(context3.measureText(nextStr).width>this._fw){this._s.push(str);nextStr=part}str=nextStr});this._s.push(nextStr)})}if(!this._s.length&&this.text.includes("\n")){let width=0;text.map(str=>{this._s.push(str);width=Math.max(width,context3.measureText(str).width)});this._w=this._fw||width}if(!this._s.length){this._s.push(this.text);this._w=this._fw||context3.measureText(this.text).width}this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight;this._uw()}draw(){let alignX=0;let textAlign=this.textAlign;let context3=this.context;textAlign=this.textAlign||(context3.canvas.dir=="rtl"?"right":"left");alignX=textAlign=="right"?this.width:textAlign=="center"?this.width/2|0:0;this._s.map((str,index)=>{context3.textBaseline="top";context3.textAlign=textAlign;context3.fillStyle=this.color;context3.font=this.font;if(this.strokeColor){context3.strokeStyle=this.strokeColor;context3.lineWidth=this.lineWidth??1;context3.strokeText(str,alignX,this._fs*this.lineHeight*index)}context3.fillText(str,alignX,this._fs*this.lineHeight*index)})}};function factory$7(){return new Text(...arguments)}var pointers=new WeakMap;var callbacks$1={};var pressedButtons={};var pointerMap={0:"left",1:"middle",2:"right"};function getCurrentObject(pointer2){let renderedObjects=pointer2._lf.length?pointer2._lf:pointer2._cf;for(let i=renderedObjects.length-1;i>=0;i--){let object=renderedObjects[i];let collides2=object.collidesWithPointer?object.collidesWithPointer(pointer2):circleRectCollision(pointer2,object);if(collides2){return object}}}function getPropValue(style,value){return parseFloat(style.getPropertyValue(value))||0}function getCanvasOffset(pointer2){let{canvas:canvas2,_s}=pointer2;let rect=canvas2.getBoundingClientRect();let transform=_s.transform!="none"?_s.transform.replace("matrix(","").split(","):[1,1,1,1];let transformScaleX=parseFloat(transform[0]);let transformScaleY=parseFloat(transform[3]);let borderWidth=(getPropValue(_s,"border-left-width")+getPropValue(_s,"border-right-width"))*transformScaleX;let borderHeight=(getPropValue(_s,"border-top-width")+getPropValue(_s,"border-bottom-width"))*transformScaleY;let paddingWidth=(getPropValue(_s,"padding-left")+getPropValue(_s,"padding-right"))*transformScaleX;let paddingHeight=(getPropValue(_s,"padding-top")+getPropValue(_s,"padding-bottom"))*transformScaleY;return{scaleX:(rect.width-borderWidth-paddingWidth)/canvas2.width,scaleY:(rect.height-borderHeight-paddingHeight)/canvas2.height,offsetX:rect.left+(getPropValue(_s,"border-left-width")+getPropValue(_s,"padding-left"))*transformScaleX,offsetY:rect.top+(getPropValue(_s,"border-top-width")+getPropValue(_s,"padding-top"))*transformScaleY}}function pointerDownHandler(evt){let button=evt.button!=null?pointerMap[evt.button]:"left";pressedButtons[button]=true;pointerHandler(evt,"onDown")}function pointerUpHandler(evt){let button=evt.button!=null?pointerMap[evt.button]:"left";pressedButtons[button]=false;pointerHandler(evt,"onUp")}function mouseMoveHandler(evt){pointerHandler(evt,"onOver")}function blurEventHandler$2(evt){let pointer2=pointers.get(evt.target);pointer2._oo=null;pressedButtons={}}function callCallback(pointer2,eventName,evt){let object=getCurrentObject(pointer2);if(object&&object[eventName]){object[eventName](evt)}if(callbacks$1[eventName]){callbacks$1[eventName](evt,object)}if(eventName=="onOver"){if(object!=pointer2._oo&&pointer2._oo&&pointer2._oo.onOut){pointer2._oo.onOut(evt)}pointer2._oo=object}}function pointerHandler(evt,eventName){evt.preventDefault();let canvas2=evt.target;let pointer2=pointers.get(canvas2);let{scaleX,scaleY,offsetX,offsetY}=getCanvasOffset(pointer2);let isTouchEvent=evt.type.includes("touch");if(isTouchEvent){Array.from(evt.touches).map(({clientX,clientY,identifier})=>{let touch=pointer2.touches[identifier];if(!touch){touch=pointer2.touches[identifier]={start:{x:(clientX-offsetX)/scaleX,y:(clientY-offsetY)/scaleY}};pointer2.touches.length++}touch.changed=false});Array.from(evt.changedTouches).map(({clientX,clientY,identifier})=>{let touch=pointer2.touches[identifier];touch.changed=true;touch.x=pointer2.x=(clientX-offsetX)/scaleX;touch.y=pointer2.y=(clientY-offsetY)/scaleY;callCallback(pointer2,eventName,evt);emit("touchChanged",evt,pointer2.touches);if(eventName=="onUp"){delete pointer2.touches[identifier];pointer2.touches.length--;if(!pointer2.touches.length){emit("touchEnd")}}})}else{pointer2.x=(evt.clientX-offsetX)/scaleX;pointer2.y=(evt.clientY-offsetY)/scaleY;callCallback(pointer2,eventName,evt)}}function initPointer({radius=5,canvas:canvas2=getCanvas()}={}){let pointer2=pointers.get(canvas2);if(!pointer2){let style=window.getComputedStyle(canvas2);pointer2={x:0,y:0,radius:radius,touches:{length:0},canvas:canvas2,_cf:[],_lf:[],_o:[],_oo:null,_s:style};pointers.set(canvas2,pointer2)}canvas2.addEventListener("mousedown",pointerDownHandler);canvas2.addEventListener("touchstart",pointerDownHandler);canvas2.addEventListener("mouseup",pointerUpHandler);canvas2.addEventListener("touchend",pointerUpHandler);canvas2.addEventListener("touchcancel",pointerUpHandler);canvas2.addEventListener("blur",blurEventHandler$2);canvas2.addEventListener("mousemove",mouseMoveHandler);canvas2.addEventListener("touchmove",mouseMoveHandler);if(!pointer2._t){pointer2._t=true;on("tick",()=>{pointer2._lf.length=0;pointer2._cf.map(object=>{pointer2._lf.push(object)});pointer2._cf.length=0})}return pointer2}function track(...objects){objects.flat().map(object=>{let canvas2=object.context?object.context.canvas:getCanvas();let pointer2=pointers.get(canvas2);if(!pointer2){throw new ReferenceError("Pointer events not initialized for the objects canvas")}if(!object.__r){object.__r=object.render;object.render=function(){pointer2._cf.push(this);this.__r()};pointer2._o.push(object)}})}function pointerPressed(button){return!!pressedButtons[button]}var Button=class extends Sprite{init({padX=0,padY=0,text,disabled=false,container,onDown,onUp,...props}={}){super.init({padX:padX,padY:padY,...props});this.textNode=factory$7({...text,context:this.context});if(!this.width){this.width=this.textNode.width;this.height=this.textNode.height}track(this);this.addChild(this.textNode);this._od=onDown||noop;this._ou=onUp||noop;let button=this._dn=document.createElement("button");button.style=srOnlyStyle;button.textContent=this.text;if(disabled){this.disable()}button.addEventListener("focus",()=>this.focus());button.addEventListener("blur",()=>this.blur());button.addEventListener("keydown",evt=>this._kd(evt));button.addEventListener("keyup",evt=>this._ku(evt));addToDom(button,container??this.context.canvas);this._uw();this._p()}get text(){return this.textNode.text}set text(value){this._d=true;this.textNode.text=value}get node(){return this._dn}destroy(){this._dn.remove()}_p(){if(this.text!=this._dn.textContent){this._dn.textContent=this.text}this.textNode._p();let width=this.textNode.width+this.padX*2;let height=this.textNode.height+this.padY*2;this.width=Math.max(width,this.width);this.height=Math.max(height,this.height);this._uw()}render(){if(this._d){this._p()}super.render()}enable(){this.disabled=this._dn.disabled=false;this.onEnable()}disable(){this.disabled=this._dn.disabled=true;this.onDisable()}focus(){if(!this.disabled){this.focused=true;if(document.activeElement!=this._dn)this._dn.focus(focusParams);this.onFocus()}}blur(){this.focused=false;if(document.activeElement==this._dn)this._dn.blur();this.onBlur()}onOver(){if(!this.disabled){this.hovered=true}}onOut(){this.hovered=false}onEnable(){}onDisable(){}onFocus(){}onBlur(){}onDown(){if(!this.disabled){this.pressed=true;this._od()}}onUp(){if(!this.disabled){this.pressed=false;this._ou()}}_kd(evt){if(evt.code=="Enter"||evt.code=="Space"){this.onDown()}}_ku(evt){if(evt.code=="Enter"||evt.code=="Space"){this.onUp()}}};function factory$6(){return new Button(...arguments)}function clear(context3){let canvas2=context3.canvas;context3.clearRect(0,0,canvas2.width,canvas2.height)}function GameLoop({fps=60,clearCanvas=true,update=noop,render,context:context3=getContext(),blur=false}={}){if(!render){throw Error("You must provide a render() function")}let accumulator=0;let delta=1e3/fps;let step=1/fps;let clearFn=clearCanvas?clear:noop;let last,rAF,now,dt,loop;let focused=true;if(!blur){window.addEventListener("focus",()=>{focused=true});window.addEventListener("blur",()=>{focused=false})}on("init",()=>{loop.context??=getContext()});function frame(){rAF=requestAnimationFrame(frame);if(!focused)return;now=performance.now();dt=now-last;last=now;if(dt>1e3){return}accumulator+=dt;while(accumulator>=delta){emit("tick");loop.update(step);accumulator-=delta}clearFn(loop.context);loop.render()}loop={update:update,render:render,isStopped:true,context:context3,start(){if(this.isStopped){last=performance.now();this.isStopped=false;requestAnimationFrame(frame)}},stop(){this.isStopped=true;cancelAnimationFrame(rAF)},_frame:frame,set _last(value){last=value}};return loop}var images={arrowUp:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAACXBIWXMAAAbJAAAGyQGh53xXAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAJ1JREFUGNONkD0KwmAQRN9ugiTgFWwliKUSolVO4hmsbGy8STyDF7DLj2iZe4hgZb610RDBoNsNvJlhVsyMX6ddIaBxUa2mdT3oheZluQbLhtfb9sP8rpvleeSJXoAQeDhzy1OSVG1Sejz6nmj2AgB8T3S/yPOwhe5BsAHiboVB1KjuACQuiokZZyD4MsyZ09Q3J2PUDv37m5H886cnsN8yl97LyDoAAAAASUVORK5CYII=",arrowDown:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAACXBIWXMAAAbJAAAGyQGh53xXAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAJpJREFUGNONkLEOAVEQRc9MNiH8y5b73jb+Qq8XpcYH8AEapU4j8QNaYlel16uUgsi+UZCNTVaY+uTce0fMjF8XuW2eoqHzDVDIItPQFmQCSB1kQldz79cgs1qNsNg5t1SAW6s5BI5VBSdEBu9IOMTxJWA9oPjQ9LMkOZcQwN77jQnTVwrzLE1W5brK1BBGherjfm2MK9X++dMTkT8s5B1wNg4AAAAASUVORK5CYII="};var colors=["rgb(255,77,77)","rgb(238,209,115)","rgb(136,255,77)","rgb(190,77,255)","rgb(77,255,154)","rgb(222,255,77)","rgb(168,102,0)","rgb(148,201,255)"];var imageSizes={door:{width:45,height:122},elevatorFrame:{width:95,height:137},doorBlink:{width:45,height:122},doorBlink2:{width:100,height:100},doorJam:{width:91,height:5},floorShadow:{width:102,height:46},indicator:{width:19,height:6}};var elevatorDoor=onDown=>(x,y)=>{return factory$8({x:x,y:y,width:imageSizes.door.width,height:imageSizes.door.height,color:"rgb(70,203,204)",onDown:onDown})};var elevatorDoorLeft=(x,y)=>elevatorDoor()(x+2,y+10);var elevatorDoorRight=(x,y)=>elevatorDoor()(x+imageSizes.door.width+3,y+10);var wallSprite=(canvasSize2,{x,y}={x:0,y:0})=>(color="rgb(34,89,131)")=>{return factory$8({x:x,y:y,width:canvasSize2.width,height:2*canvasSize2.height/3,color:color})};var elevatorFrame=(x,y)=>{return factory$8({x:x,y:y,width:imageSizes.elevatorFrame.width,height:imageSizes.elevatorFrame.height,color:"rgb(52,125,158)"})};var floorSprite=(canvasSize2,{x,y}={x:0,y:0})=>{return factory$8({x:x,y:y*canvasSize2.height/3,width:canvasSize2.width,height:canvasSize2.height/3,color:"rgb(1,16,49)"})};var stairCaseDoor=(track2,clickHandler)=>(x,y)=>{const door=elevatorFrame(x,y);const leftDoor=elevatorDoor(clickHandler)(x+2,y+3);const rightDoor=elevatorDoor(clickHandler)(x+imageSizes.door.width+3,y+3);track2(leftDoor);track2(rightDoor);leftDoor.color="rgb(0,0,0)";rightDoor.color="rgb(0,0,0)";leftDoor.width=leftDoor.width+4;leftDoor.height=leftDoor.height+12;rightDoor.height=rightDoor.height+12;return{group:[door,leftDoor,rightDoor],update(){door.update();leftDoor.update();rightDoor.update()},render(){door.render();leftDoor.render();rightDoor.render()}}};var createStaticBackground=(canvasSize2,color,xyCoords)=>{const backGroundWall=wallSprite(canvasSize2,xyCoords)(color);const backGroundFloor=floorSprite(canvasSize2,xyCoords);return{group:[backGroundWall,backGroundFloor],update(){backGroundWall.update();backGroundFloor.update()},render(){backGroundWall.render();backGroundFloor.render()}}};var wallText=(x,y,text,color="rgb(255, 255, 255)",size=40)=>{const textSprite=factory$7({text:text,font:`${size}px Arial`,color:color,x:x,y:y});textSprite.x=textSprite.x-textSprite.width/2;textSprite.y=textSprite.y-textSprite.height/2;return textSprite};var elevatorButton=context3=>(x,y)=>{const buttonSprite=factory$8({x:x,y:y,width:25,height:40});buttonSprite.render=function(){context3.fillStyle="rgba(52,125,158)";context3.fillRect(this.x,this.y,this.width,this.height);context3.strokeStyle="rgb(54,199,200)";context3.lineWidth=1;context3.strokeRect(this.x+2,this.y+2,this.width-4,this.height-4);context3.stroke()};return buttonSprite};var triangleUp=(context3,state)=>(x,y)=>{const triangleSprite=factory$8({x:x,y:y,width:25,height:25,image:new Image});triangleSprite.image.src=images.arrowUp;return triangleSprite};var triangleDown=(context3,state)=>(x,y)=>{const triangleSprite=factory$8({x:x,y:y,width:25,height:25,image:new Image});triangleSprite.image.src=images.arrowDown;return triangleSprite};var floorIndicator=(context3,state)=>(x,y)=>{const indicatorSprite=factory$8({x:x,y:y,width:30,height:15});const textSprite=factory$7({text:"",font:`11px Arial`,color:"rgb(255,0,0)",x:x,y:y});indicatorSprite.render=function(){context3.fillStyle="rgba(0, 0, 0)";context3.fillRect(this.x,this.y,this.width,this.height);context3.stroke();textSprite.render()};indicatorSprite.update=function(){textSprite.text=state.currentFloor;textSprite.x=indicatorSprite.x+indicatorSprite.width/2-textSprite.width/2;textSprite.y=indicatorSprite.y+3;textSprite.update()};return indicatorSprite};var elevator=(track2,context3,handler,state,pointer2,yAxisShift,gameContext,floorNumber,gameElementsState2)=>(x,y)=>{const frame=elevatorFrame(x,y);const elevatorButtonSprite=elevatorButton(context3)(frame.x+frame.width+2,frame.y+frame.height/2-20);const triangleUpSprite=triangleUp(context3,state)(elevatorButtonSprite.x+8,elevatorButtonSprite.y+7);const triangleDownSprite=triangleDown(context3,state)(elevatorButtonSprite.x+8,elevatorButtonSprite.y+25);const leftDoor=elevatorDoorLeft(x,y);const rightDoor=elevatorDoorRight(x,y);track2(triangleUpSprite,triangleDownSprite,frame);frame.onDown=()=>{if(state.isOpen&&!state.isClosing&&gameContext.activeFloor===state.currentFloor){state.isShowingFloorSelector=true}};const group=[frame,leftDoor,rightDoor,elevatorButtonSprite,triangleDownSprite,triangleUpSprite,floorIndicator(context3,state)(frame.x+frame.width/2-15,frame.y-6)];return{group:group,update(diffTime){group.map(sprite=>sprite.update());const distanceTopArrow=Math.sqrt((triangleUpSprite.x-(pointer2.x-15))**2+(triangleUpSprite.y-(pointer2.y-15)-yAxisShift)**2);const distanceBottomArrow=Math.sqrt((triangleDownSprite.x-(pointer2.x-15))**2+(triangleDownSprite.y-(pointer2.y-15)-yAxisShift)**2);const isItemPlaced=Object.values(gameElementsState2).find(({picked,placedToHole,elevatorPlaced})=>picked&&placedToHole&&elevatorPlaced===state.id);const shouldOpenDoors=state.stopFloors?.[isItemPlaced?.type]?.includes(gameContext.activeFloor)||state.stopFloors.default.includes(gameContext.activeFloor)||state.stopFloors.unblockedFloors.includes(gameContext.activeFloor);if((distanceTopArrow<15||distanceBottomArrow<15)&&pointerPressed("left")&&!state.isOpen&&!state.isClosing&&!state.isMoving){state.targetFloor=gameContext.activeFloor;state.isMoving=state.targetFloor!==state.currentFloor;state.isMovingUp=state.targetFloor>state.currentFloor;state.isMovingDown=state.targetFloor<state.currentFloor;state.shouldOpen=shouldOpenDoors;state.isShowingFloorSelector=false}if(state.isOpening&&state.currentFloor===floorNumber){if(leftDoor.x>x-leftDoor.width+13){leftDoor.x=leftDoor.x-.5}if(rightDoor.x<x+frame.width-13){rightDoor.x=rightDoor.x+.5}if(!(leftDoor.x>x-leftDoor.width+13)&&!(rightDoor.x<x+frame.width-13)){state.isOpening=false;state.isOpen=true;state.shouldOpen=false;state.autoClose=30}}if(state.isClosing&&state.currentFloor===floorNumber){if(leftDoor.x<frame.x+2){leftDoor.x=leftDoor.x+.6}if(rightDoor.x>frame.x+frame.width/2+1){rightDoor.x=rightDoor.x-.6}if(leftDoor.x>frame.x+2&&rightDoor.x<=frame.x+frame.width/2+1){state.isClosing=false;state.isOpen=false;state.isMoving=state.targetFloor!==state.currentFloor;state.isMovingUp=state.targetFloor>state.currentFloor;state.isMovingDown=state.targetFloor<state.currentFloor;state.isShowingFloorSelector=false;state.autoClose=null}}if(state.autoClose!==null&&state.isOpen&&!state.isClosing&&!state.isShowingFloorSelector){state.autoClose=state.autoClose-diffTime}if(state.autoClose<=0&&state.autoClose!==null){state.autoClose=null;state.isClosing=true;state.shouldOpen=false}},render(){group.map(sprite=>sprite.render())}}};var closedDoorStairCase=(track2,onDown)=>(x,y)=>{const doorSprite=factory$8({x:x,y:y,width:imageSizes.door.width*2,height:imageSizes.door.height,color:"rgb(105,66,0)",onDown:onDown});track2(doorSprite);return doorSprite};var artefactSprite=(itemState,context3,type,color)=>{const sprite=factory$8({type:type,x:itemState.x,y:itemState.y,width:30,height:30,radius:30,color:color});sprite.render=function(){if(type==="key"){context3.fillStyle="#FFD700";context3.fillRect(this.x+4,this.y+14,8,18);context3.beginPath();context3.arc(this.x+8,this.y+12,6,0,Math.PI*2);context3.fill();context3.fillStyle="#DAA520";context3.beginPath();context3.arc(this.x+8,this.y+12,3,0,Math.PI*2);context3.fill();context3.strokeStyle="black";context3.lineWidth=1;context3.stroke()}else if(type==="lock"){context3.fillStyle="rgb(25,210,255)";context3.fillRect(this.x,this.y+8,this.width,this.height-10);context3.beginPath();context3.moveTo(this.x+this.width/4,this.y+8);context3.lineTo(this.x+this.width/4,this.y-8);context3.lineTo(this.x+3*this.width/4,this.y-8);context3.lineTo(this.x+3*this.width/4,this.y+8);context3.strokeStyle="black";context3.lineWidth=5;context3.stroke()}else{context3.fillStyle=this.color;context3.beginPath();context3.moveTo(this.x+this.width/2,this.y);context3.lineTo(this.x,this.y+this.height/3);context3.lineTo(this.x+this.width/4,this.y+this.height);context3.lineTo(this.x+3*this.width/4,this.y+this.height);context3.lineTo(this.x+this.width,this.y+this.height/3);context3.closePath();context3.fill()}};if(type!=="lock"){sprite.update=function(){if(itemState.isDragging){this.x=itemState.x;this.y=itemState.y}else{if(itemState.isPicked){this.x=itemState.x;this.y=itemState.y}if(!itemState.isPicked){this.x=itemState.x;this.y=(itemState.currentFloor-1)*600+itemState.y}}}}return sprite};var diamonds=(itemState,context3,track2)=>["yellow-gem","diamond","red-gem","yellow-diamond","orange-diamond","emerald","red-diamond","green-diamond","key","lock"].map((id,i)=>{const color=`rgba(${Math.floor(Math.random()*255)}, ${Math.floor(Math.random()*255)}, ${Math.floor(Math.random()*255)})`;const artefact=artefactSprite(itemState[id],context3,id,colors[i]);track2(artefact);return{item:artefact,type:id}});var elevatorFloorSelector=(context3,state,gameContext,canvasSize2,gameElementsState2,slotCoordinates)=>()=>{const shadowDrop=factory$8({x:0,y:0,width:canvasSize2.width,height:canvasSize2.height,color:"rgba(0,0,0,0.55)"});const dashboardPlate=factory$8({x:shadowDrop.width/2-150,y:shadowDrop.height/2-250,width:300,height:500,color:"rgba(52,125,158)"});const buttons=[1,2,3,4,5,6,7,8,9,10,11,12,13].map(floorNumber=>{let button=factory$6({id:floorNumber,isEnabled:false,x:dashboardPlate.x+68+(floorNumber-1)%3*85,y:dashboardPlate.y+80+Math.floor((floorNumber-1)/3)*55,width:70,height:30,anchor:{x:.5,y:.5},color:"rgb(0,104,148)",text:{text:floorNumber,color:"white",font:"20px Arial, sans-serif",anchor:{x:.5,y:.5}},onDown(){this.y+=3},onUp(){this.y-=3;if(this.isEnabled){const activeState=Object.values(state).find(({isShowingFloorSelector})=>isShowingFloorSelector);if(activeState.currentFloor!==floorNumber){activeState.isShowingFloorSelector=false;activeState.targetFloor=floorNumber;activeState.isClosing=true;activeState.isMovingUser=true;activeState.shouldOpen=true;activeState.autClose=null}}}});return button});const exitButton=factory$6({x:dashboardPlate.x+dashboardPlate.width/2,y:dashboardPlate.y+dashboardPlate.height-40,width:90,height:40,anchor:{x:.5,y:.5},color:"rgb(255,175,51)",text:{text:"EXIT",color:"black",font:"20px Arial, sans-serif",anchor:{x:.5,y:.5}},onDown(){this.y+=3;Object.values(gameElementsState2).filter(({picked})=>picked).forEach(({type,slotNumber,x,y,...rest})=>{gameElementsState2[type]={slotNumber:slotNumber,x:slotCoordinates[`slot${slotNumber}`].x0+9,y:slotCoordinates[`slot${slotNumber}`].y0+9,...rest,picked:true,isDragging:false,placedToHole:false,elevatorPlaced:null}})},onUp(){this.y-=3;const activeState=Object.values(state).find(({isShowingFloorSelector})=>isShowingFloorSelector);activeState.isShowingFloorSelector=false;activeState.autoClose=30}});buttons.push(exitButton);const itemHole=factory$6({x:dashboardPlate.x+dashboardPlate.width/2-50,y:dashboardPlate.y+dashboardPlate.height-180,width:100,height:100,radius:30,color:"rgb(255,255,198)"});itemHole.render=function(){context3.fillStyle=this.color;context3.beginPath();context3.arc(this.x+this.width/2,this.y+this.height/2,this.radius,0,Math.PI*2);context3.fill();context3.globalCompositeOperation="destination-out";context3.beginPath();context3.arc(this.x+this.width/2,this.y+this.height/2,this.radius-5,0,Math.PI*2);context3.fill();context3.globalCompositeOperation="source-over"};const spriteGroup=[shadowDrop,dashboardPlate,...buttons,itemHole];return{group:spriteGroup,update:()=>{const activatedElevatorState=Object.values(state).find(({isShowingFloorSelector})=>isShowingFloorSelector);activatedElevatorState?.stopFloors?.default?.forEach(allowedFloor=>{const buttonToEnable=buttons.find(({id})=>id===allowedFloor);buttonToEnable.isEnabled=true;buttonToEnable.color="rgb(37,148,0)"});activatedElevatorState?.stopFloors?.unblockedFloors?.forEach(allowedFloor=>{const buttonToEnable=buttons.find(({id})=>id===allowedFloor);if(buttonToEnable){buttonToEnable.color="rgb(37,148,0)";buttonToEnable.isEnabled=true}});spriteGroup.map(sprite=>sprite.update())},render:()=>{spriteGroup.map(sprite=>sprite.render())}}};var floorColor={floor1:"rgb(161, 234, 255)",floor2:"rgb(149, 223, 250)",floor3:"rgb(137, 212, 245)",floor4:"rgb(126, 201, 240)",floor5:"rgb(114, 191, 234)",floor6:"rgb(102, 180, 229)",floor7:"rgb(90, 169, 224)",floor8:"rgb(78, 158, 219)",floor9:"rgb(67, 147, 214)",floor10:"rgb(55, 136, 208)",floor11:"rgb(43, 126, 203)",floor12:"rgb(39, 107, 168)",floor13:"rgb(34, 89, 131)"};var initFloor=(canvasSize2,floorAnkerPoints,color,textOnTheWall,floorNumber,renderContext2,elevatorsState2,pointer2,gameContext,gameElementsState2,stairCaseDoorByFloor,cameraPosition2,floorCameraPoints2)=>()=>{const floorStartX=0;const floorStartY=floorAnkerPoints.y;const elevatorCoordinates={left:{x:canvasSize2.width/8*2,y:floorStartY+canvasSize2.height/2-20},middle:{x:canvasSize2.width/8*3.5,y:floorStartY+canvasSize2.height/2-20},right:{x:canvasSize2.width/8*5,y:floorStartY+canvasSize2.height/2-20}};let rightStairCaseDoor;let leftStairCaseDoor;let floorText;let arrowUp;let arrowDown;const background=createStaticBackground(canvasSize2,color,{x:floorStartX,y:floorStartY});const wallFloorNumber=wallText(canvasSize2.width/2,floorStartY+canvasSize2.height/4,textOnTheWall);const rightStairCaseDoorHandler=()=>{if(gameContext.activeFloor===13){return}if(stairCaseDoorByFloor["down"].includes(gameContext.activeFloor)){gameContext.activeFloor=gameContext.activeFloor+1;cameraPosition2.targetY=floorCameraPoints2[`floor${gameContext.activeFloor}`].y}};const leftStairCaseDoorHandler=()=>{if(gameContext.activeFloor===1){return}if(stairCaseDoorByFloor["up"].includes(gameContext.activeFloor)){gameContext.activeFloor=gameContext.activeFloor-1;cameraPosition2.targetY=floorCameraPoints2[`floor${gameContext.activeFloor}`].y}};if(stairCaseDoorByFloor["up"].includes(floorNumber)){leftStairCaseDoor=stairCaseDoor(track,leftStairCaseDoorHandler)(canvasSize2.width/15,floorStartY+canvasSize2.height/2-20);arrowDown=wallText(canvasSize2.width/15+45*2/2+5,floorStartY+canvasSize2.height/2-20+122/2,"UP","rgb(255,0,0)",20)}else{leftStairCaseDoor=closedDoorStairCase(track,leftStairCaseDoorHandler)(canvasSize2.width/15,floorStartY+canvasSize2.height/2-20)}if(stairCaseDoorByFloor["down"].includes(floorNumber)){rightStairCaseDoor=stairCaseDoor(track,rightStairCaseDoorHandler)(canvasSize2.width/8*6.5,floorStartY+canvasSize2.height/2-20);arrowUp=wallText(canvasSize2.width/8*6.5+45*2/2+5,floorStartY+canvasSize2.height/2+122/2,"DOWN","rgb(255,0,0)",20)}else{rightStairCaseDoor=closedDoorStairCase(track,rightStairCaseDoorHandler)(canvasSize2.width/8*6.5,floorStartY+canvasSize2.height/2-20)}if(floorNumber===1){floorText=wallText(canvasSize2.width/2,floorStartY+5*canvasSize2.height/6,"Key is on the floor 13")}const elevatorGroups=[elevator(track,renderContext2,{},elevatorsState2.left,pointer2,floorStartY,gameContext,floorNumber,gameElementsState2)(elevatorCoordinates.left.x,elevatorCoordinates.left.y),elevator(track,renderContext2,{},elevatorsState2.middle,pointer2,floorStartY,gameContext,floorNumber,gameElementsState2)(elevatorCoordinates.middle.x,elevatorCoordinates.middle.y),elevator(track,renderContext2,{},elevatorsState2.right,pointer2,floorStartY,gameContext,floorNumber,gameElementsState2)(elevatorCoordinates.right.x,elevatorCoordinates.right.y)];return{update(dt){elevatorGroups.map(elevator2=>elevator2.update(dt));leftStairCaseDoor?.update();rightStairCaseDoor?.update();arrowUp?.update();floorText?.update();arrowDown?.update()},render(){background.render();wallFloorNumber.render();leftStairCaseDoor?.render();elevatorGroups.map(elevator2=>elevator2.render());rightStairCaseDoor?.render();floorText?.render();arrowUp?.render();arrowDown?.render()}}};var createSlotsBox=context3=>(x,y)=>{const slotBoxItem=factory$8({x:x,y:y,width:200,height:95});slotBoxItem.render=function(){context3.fillStyle="rgba(237,161,5,0.13)";context3.fillRect(this.x,this.y,this.width,this.height);context3.strokeStyle="rgb(182,116,8)";context3.lineWidth=2;context3.strokeRect(this.x,this.y,this.width,this.height);context3.beginPath();context3.moveTo(this.x,this.y+this.height/2);context3.lineTo(this.x+this.width,this.y+this.height/2);context3.moveTo(this.x+50,this.y);context3.lineTo(this.x+50,this.y+this.height);context3.moveTo(this.x+100,this.y);context3.lineTo(this.x+100,this.y+this.height);context3.moveTo(this.x+150,this.y);context3.lineTo(this.x+150,this.y+this.height);context3.stroke()};track(slotBoxItem);return slotBoxItem};var{canvas,context:context2}=init$1();var pointer=initPointer({radius:10});var renderContext=canvas.getContext("2d");var canvasSize={width:800,height:600};var floorCameraPoints={floor1:{y:0},floor2:{y:canvasSize.height},floor3:{y:2*canvasSize.height},floor4:{y:3*canvasSize.height},floor5:{y:4*canvasSize.height},floor6:{y:5*canvasSize.height},floor7:{y:6*canvasSize.height},floor8:{y:7*canvasSize.height},floor9:{y:8*canvasSize.height},floor10:{y:9*canvasSize.height},floor11:{y:10*canvasSize.height},floor12:{y:11*canvasSize.height},floor13:{y:12*canvasSize.height}};var cameraPosition={y:floorCameraPoints.floor1.y,x:0,dy:4,targetY:floorCameraPoints.floor1.y,isMoving:false};var artefactId={yellowGem:"yellow-gem",diamond:"diamond",redGem:"red-gem",yellowDiamond:"yellow-diamond",orangeDiamond:"orange-diamond",emerald:"emerald",redDiamond:"red-diamond",greenDiamond:"green-diamond",key:"key",lock:"lock"};var defaultProps={isOpen:false,isOpening:true,isClosing:false,isMoving:false,isMovingUp:false,isMovingDown:false,shouldOpen:false,isShowingFloorSelector:false,isMovingUser:false,shouldWaitForCameraUpdate:false};var elevatorsState={left:{id:1,item:elevatorFrame(canvasSize.width/8*2,floorCameraPoints.floor5.y+canvasSize.height/2-20),dy:8,targetFloor:1,currentFloor:1,stopFloors:{default:[1],unblockedFloors:[],[artefactId.yellowGem]:[6],[artefactId.redGem]:[12],[artefactId.orangeDiamond]:[7]},...defaultProps},middle:{id:2,item:elevatorFrame(canvasSize.width/8*3.5,floorCameraPoints.floor8.y+canvasSize.height/2-20),currentFloor:8,targetFloor:8,dy:10,stopFloors:{default:[1],unblockedFloors:[],[artefactId.diamond]:[3,5,8],[artefactId.greenDiamond]:[10]},...defaultProps},right:{id:3,item:elevatorFrame(canvasSize.width/8*5,floorCameraPoints.floor12.y+canvasSize.height/2-20),currentFloor:12,targetFloor:12,dy:15,stopFloors:{default:[1],unblockedFloors:[],[artefactId.yellowDiamond]:[4],[artefactId.yellowGem]:[1],[artefactId.emerald]:[9],[artefactId.redDiamond]:[13]},...defaultProps}};var defaultArtefactProps={isPicked:false,isUsed:false,slotNumber:null,isDragging:false,placedToHole:false,elevatorPlaced:null,x:400,y:450};var gameElementsState={[artefactId.yellowGem]:{type:artefactId.yellowGem,id:1,currentFloor:2,...defaultArtefactProps},[artefactId.diamond]:{type:artefactId.diamond,id:2,currentFloor:6,...defaultArtefactProps},[artefactId.redGem]:{type:artefactId.redGem,id:3,currentFloor:9,...defaultArtefactProps},[artefactId.yellowDiamond]:{type:artefactId.yellowDiamond,id:4,currentFloor:11,...defaultArtefactProps},[artefactId.orangeDiamond]:{type:artefactId.orangeDiamond,id:5,currentFloor:3,...defaultArtefactProps},[artefactId.emerald]:{type:artefactId.emerald,id:6,currentFloor:7,...defaultArtefactProps},[artefactId.redDiamond]:{type:artefactId.redDiamond,id:7,currentFloor:10,...defaultArtefactProps},[artefactId.greenDiamond]:{type:artefactId.greenDiamond,id:8,currentFloor:12,...defaultArtefactProps},[artefactId.key]:{type:artefactId.key,id:9,currentFloor:13,...defaultArtefactProps},[artefactId.lock]:{type:artefactId.lock,id:10,currentFloor:1,...defaultArtefactProps,x:110,y:350}};var gameArtefactsStates=diamonds(gameElementsState,context2,track);function launchRound(){const gameContext={activeFloor:1,isGameCompleted:false,isGameOver:false,timeLeft:60*13};let draggingElementId=null;const slotBoxState={items:[]};const floorPointsSwitcher={floor1:floorCameraPoints.floor1.y+canvasSize.height/2-20,floor2:floorCameraPoints.floor2.y+canvasSize.height/2-20,floor3:floorCameraPoints.floor3.y+canvasSize.height/2-20,floor4:floorCameraPoints.floor4.y+canvasSize.height/2-20,floor5:floorCameraPoints.floor5.y+canvasSize.height/2-20,floor6:floorCameraPoints.floor6.y+canvasSize.height/2-20,floor7:floorCameraPoints.floor7.y+canvasSize.height/2-20,floor8:floorCameraPoints.floor8.y+canvasSize.height/2-20,floor9:floorCameraPoints.floor9.y+canvasSize.height/2-20,floor10:floorCameraPoints.floor10.y+canvasSize.height/2-20,floor11:floorCameraPoints.floor11.y+canvasSize.height/2-20,floor12:floorCameraPoints.floor12.y+canvasSize.height/2-20,floor13:floorCameraPoints.floor13.y+canvasSize.height/2-20};const stairCaseDoorByFloor={down:[1,4,11],up:[2,5,12]};const floorStages=[1,2,3,4,5,6,7,8,9,10,11,12,13].map(floorNumber=>{return initFloor(canvasSize,{y:floorCameraPoints[`floor${floorNumber}`].y},floorColor[`floor${floorNumber}`],`FLOOR ${floorNumber}`,floorNumber,renderContext,elevatorsState,pointer,gameContext,gameElementsState,stairCaseDoorByFloor,cameraPosition,floorCameraPoints)()});const itemSlots=createSlotsBox(renderContext)(5,500);const slotCoordinates={slot1:{x0:itemSlots.x,x1:itemSlots.x+50,y0:itemSlots.y,y1:itemSlots.y+50},slot2:{x0:itemSlots.x+50,x1:itemSlots.x+100,y0:itemSlots.y,y1:itemSlots.y+50},slot3:{x0:itemSlots.x+100,x1:itemSlots.x+150,y0:itemSlots.y,y1:itemSlots.y+50},slot4:{x0:itemSlots.x+150,x1:itemSlots.x+200,y0:itemSlots.y,y1:itemSlots.y+50},slot5:{x0:itemSlots.x,x1:itemSlots.x+50,y0:itemSlots.y+50,y1:itemSlots.y+100},slot6:{x0:itemSlots.x+50,x1:itemSlots.x+100,y0:itemSlots.y+50,y1:itemSlots.y+100},slot7:{x0:itemSlots.x+100,x1:itemSlots.x+150,y0:itemSlots.y+50,y1:itemSlots.y+100},slot8:{x0:itemSlots.x+150,x1:itemSlots.x+200,y0:itemSlots.y+50,y1:itemSlots.y+100}};const floorDashboardInElevator=elevatorFloorSelector(context2,elevatorsState,gameContext,canvasSize,gameElementsState,slotCoordinates)();const timLeftDisplay=wallText(680,10,`Time left: 13.00`,"rgb(255,175,51)",20);timLeftDisplay.update=function(){const minutes=Math.floor(gameContext.timeLeft/60);const seconds=Math.floor(gameContext.timeLeft-minutes*60);this.text=`Time left: ${minutes}.${seconds}`};const greenColor="rgb(0,255,0)";const gameOverText=wallText(canvasSize.width/2,canvasSize.height/2,"Game Over","rgb(255,0,0)",50);const gameCompletedText=wallText(canvasSize.width/2,canvasSize.height/2,"Game Completed",greenColor,50);const congratulationsText=wallText(canvasSize.width/2,canvasSize.height/2+50,"Congratulations!",greenColor,40);const youManagedToEscape=wallText(canvasSize.width/2,canvasSize.height/2+100,"You managed to escape!",greenColor,40);const credits=wallText(canvasSize.width/2,canvasSize.height/2+150,"Created by: @hostmepanda",greenColor,20);const forJS13K=wallText(canvasSize.width/2,canvasSize.height/2+180,"For JS13K 2024 https://js13kgames.com/",greenColor,20);const imagesUsedByFreePik=wallText(canvasSize.width/2,canvasSize.height/2+210,"Images used by Freepik",greenColor,20);const webSiteFreePik=wallText(canvasSize.width/2,canvasSize.height/2+240,"http://www.freepik.com",greenColor,20);const hostMePanda=wallText(canvasSize.width/2,canvasSize.height/2+270,"https://github.com/hostmepanda",greenColor,20);let timerPassed=0;let loop=GameLoop({update(timeDiff){timLeftDisplay.update();timerPassed+=timeDiff;floorStages.forEach(floor=>{floor.update(timeDiff,gameContext)});itemSlots.update();const key=gameArtefactsStates.find(({type})=>type===artefactId.key).item;const lock=gameArtefactsStates.find(({type})=>type===artefactId.lock).item;if(collides(key,lock)){if(!pointerPressed("left")){gameContext.isGameCompleted=true}}Object.values(elevatorsState).forEach(state=>{if(state.isMoving){if(state.isMovingUser){state.item.y=state.item.y+(state.isMovingUp?cameraPosition.dy:-cameraPosition.dy)}else{state.item.y=state.item.y+(state.isMovingUp?state.dy:-state.dy)}}if(state.item.y<=floorPointsSwitcher.floor1+5){state.currentFloor=1}else if(state.item.y<=floorPointsSwitcher.floor2-5&&state.item.y>=floorPointsSwitcher.floor1+5){state.currentFloor=2}else if(state.item.y<=floorPointsSwitcher.floor3-5&&state.item.y>=floorPointsSwitcher.floor2+5){state.currentFloor=3}else if(state.item.y<=floorPointsSwitcher.floor4-5&&state.item.y>=floorPointsSwitcher.floor3+5){state.currentFloor=4}else if(state.item.y<=floorPointsSwitcher.floor5-5&&state.item.y>=floorPointsSwitcher.floor4+5){state.currentFloor=5}else if(state.item.y<=floorPointsSwitcher.floor6-5&&state.item.y>=floorPointsSwitcher.floor5+5){state.currentFloor=6}else if(state.item.y<=floorPointsSwitcher.floor7-5&&state.item.y>=floorPointsSwitcher.floor6+5){state.currentFloor=7}else if(state.item.y<=floorPointsSwitcher.floor8-5&&state.item.y>=floorPointsSwitcher.floor7+5){state.currentFloor=8}else if(state.item.y<=floorPointsSwitcher.floor9-5&&state.item.y>=floorPointsSwitcher.floor8+5){state.currentFloor=9}else if(state.item.y<=floorPointsSwitcher.floor10-5&&state.item.y>=floorPointsSwitcher.floor9+5){state.currentFloor=10}else if(state.item.y<=floorPointsSwitcher.floor11-5&&state.item.y>=floorPointsSwitcher.floor10+5){state.currentFloor=11}else if(state.item.y<=floorPointsSwitcher.floor12-5&&state.item.y>=floorPointsSwitcher.floor11+5){state.currentFloor=12}else if(state.item.y<=floorPointsSwitcher.floor13-5&&state.item.y>=floorPointsSwitcher.floor12+5){state.currentFloor=13}if(state.currentFloor===state.targetFloor){state.isMoving=false;state.isMovingUp=false;state.isMovingDown=false;state.item.y=floorPointsSwitcher[`floor${state.currentFloor}`];if(state.isMovingUser){gameContext.activeFloor=state.currentFloor}if(state.isMovingUser&&cameraPosition.targetY===cameraPosition.y){state.shouldWaitForCameraUpdate=false}if(!state.shouldWaitForCameraUpdate){state.isOpening=state.shouldOpen;state.isMovingUser=false}}state.item.update()});const dashboardFloorSelectorOpenedState=Object.values(elevatorsState).find(({isShowingFloorSelector})=>isShowingFloorSelector);gameArtefactsStates.forEach(({item,isPicked,currentFloor})=>{const absolutionItemY=gameElementsState[item.type].isPicked?item.y:item.y-(gameContext.activeFloor-1)*canvasSize.height;const distance=Math.sqrt((item.x-(pointer.x-15))**2+(item.y-(gameElementsState[item.type].isPicked?pointer.y-15:pointer.y-15+(gameContext.activeFloor-1)*canvasSize.height))**2);const isColliding=itemSlots.x<=item.x&&item.x<=itemSlots.x+itemSlots.width&&itemSlots.y<=absolutionItemY&&absolutionItemY<=itemSlots.y+itemSlots.height;if(distance<=pointer.radius){if(pointerPressed("left")&&draggingElementId!==item.id){gameElementsState[item.type].isDragging=true;draggingElementId=item.id;gameElementsState[item.type].isPicked=dashboardFloorSelectorOpenedState?true:false;slotBoxState.items=slotBoxState.items.filter(slot=>slot!==item.type)}}if(gameElementsState[item.type].isDragging&&!pointerPressed("left")){gameElementsState[item.type].isDragging=false;draggingElementId=false;gameElementsState[item.type].y=pointer.y-15;if(dashboardFloorSelectorOpenedState){if(collides(item,floorDashboardInElevator.group.at(-1))){gameElementsState[item.type].placedToHole=true;gameElementsState[item.type].elevatorPlaced=dashboardFloorSelectorOpenedState.id;if(dashboardFloorSelectorOpenedState.stopFloors[item.type]?.length>0){const unblockedFloorsSet=new Set([...dashboardFloorSelectorOpenedState.stopFloors.unblockedFloors]);unblockedFloorsSet.add(dashboardFloorSelectorOpenedState.stopFloors[item.type]);dashboardFloorSelectorOpenedState.stopFloors.unblockedFloors=Array.from(unblockedFloorsSet.values()).flat(2)}}}if(!slotBoxState.items.find(({type})=>type===item.type)){slotBoxState.items.push(item.type)}gameElementsState[item.type].slotNumber=slotBoxState.items.length;gameElementsState[item.type].isPicked=true;if(!isColliding&&!dashboardFloorSelectorOpenedState){gameElementsState[item.type].currentFloor=gameContext.activeFloor;gameElementsState[item.type].slotNumber=null;gameElementsState[item.type].isPicked=false;slotBoxState.items=slotBoxState.items.filter(type=>type!==item.type)}}if(gameElementsState[item.type].isDragging){gameElementsState[item.type].placedToHole=false;gameElementsState[item.type].elavalorPlaced=null;gameElementsState[item.type].x=pointer.x-15;gameElementsState[item.type].y=pointer.y-15+(gameContext.activeFloor-1)*canvasSize.height}if(gameElementsState[item.type].placedToHole&&!gameElementsState[item.type].isDragging){const holeElement=floorDashboardInElevator.group.at(-1);gameElementsState[item.type].x=holeElement.x+holeElement.width/2-item.width/2+9;gameElementsState[item.type].y=holeElement.y+holeElement.height/2-item.height/2+9}if(!dashboardFloorSelectorOpenedState){gameElementsState[item.type].placedToHole=false;gameElementsState[item.type].elevatorPlaced=null}item.update()});slotBoxState.items.forEach(type=>{const itemConfig=gameElementsState[type];if(itemConfig.slotNumber===null){return}itemConfig.x=slotCoordinates[`slot${itemConfig.slotNumber}`].x0+9;itemConfig.y=slotCoordinates[`slot${itemConfig.slotNumber}`].y0+9});floorDashboardInElevator.update();const movingUserElevator=Object.values(elevatorsState).find(({isMovingUser,isMoving})=>isMovingUser&&isMoving);if(movingUserElevator){cameraPosition.dy=4;cameraPosition.targetY=floorCameraPoints[`floor${movingUserElevator.targetFloor}`].y;movingUserElevator.shouldWaitForCameraUpdate=true}if(cameraPosition.targetY!==cameraPosition.y){cameraPosition.isMoving=true;cameraPosition.y=cameraPosition.targetY>cameraPosition.y?cameraPosition.y+cameraPosition.dy:cameraPosition.y-cameraPosition.dy}else{cameraPosition.isMoving=false;cameraPosition.dy=8;cameraPosition.y=cameraPosition.targetY}gameContext.timeLeft=gameContext.timeLeft-timeDiff;if(gameContext.timeLeft<0){gameContext.isGameOver=true}},render(){if(gameContext.isGameOver){gameOverText.render();credits.render();forJS13K.render();imagesUsedByFreePik.render();webSiteFreePik.render();hostMePanda.render();return}if(gameContext.isGameCompleted){gameCompletedText.render();congratulationsText.render();youManagedToEscape.render();credits.render();forJS13K.render();imagesUsedByFreePik.render();webSiteFreePik.render();hostMePanda.render();return}const dashboardFloorSelectorOpenedState=Object.values(elevatorsState).find(({isShowingFloorSelector})=>isShowingFloorSelector);Object.entries(gameElementsState).filter(([,{isPicked}])=>isPicked).forEach(([type])=>{gameArtefactsStates.filter(({type:spriteType})=>type===spriteType).forEach(({item})=>item.render())});renderContext.save();renderContext.translate(0,-cameraPosition.y);floorStages.forEach(floor=>{floor.render()});if(!dashboardFloorSelectorOpenedState){Object.entries(gameElementsState).filter(([,{isPicked}])=>!isPicked).forEach(([type])=>{gameArtefactsStates.filter(({type:spriteType})=>type===spriteType).forEach(({item})=>item.render())})}renderContext.restore();if(dashboardFloorSelectorOpenedState){const pickedArtefacts=Object.entries(gameElementsState).filter(([,{isPicked}])=>isPicked).map(([type])=>{return gameArtefactsStates.filter(({type:spriteType})=>type===spriteType).map(({item})=>item)}).flat(2);[...floorDashboardInElevator.group,itemSlots,...pickedArtefacts].forEach(sprite=>sprite.render())}if(!dashboardFloorSelectorOpenedState){itemSlots.render()}timLeftDisplay.render()}});loop.start()}launchRound()})();