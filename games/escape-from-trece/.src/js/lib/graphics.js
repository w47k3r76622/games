const graphics={scaleFactor:1,resizeContainer:function(t,e,n){const i=e.width/t.width,a=e.height/t.height;this.scaleFactor=Math.min(a,i),n.style.width=`${Math.floor(t.width*this.scaleFactor)}px`;let o=t.height*this.scaleFactor;n.style.height=`${Math.floor(o)}px`,n.style.top=(e.height-parseInt(n.style.height))/2+"px",n.style.left=(e.width-parseInt(n.style.width))/2+"px",console.log(`Window ${window.innerWidth} x ${window.innerHeight}`),console.log(`Canvas buffer ${t.width} x ${t.height}`),console.log(`Canvas css ${n.style.width} x ${n.style.height}`),console.log(`Density ${window.devicePixelRatio}`),console.log(`Scale ${this.scaleFactor}`)},draw:function(t,e,n){t.sort(mathUtils.zCompare);for(let i=t.length-1;i>=0;i--){let a=t[i];a instanceof Sprite?this.drawSprite(a,e,n):a instanceof Label&&this.drawLabel(a,e,n)}},drawSprite:function(t,e,n){let i=t.x-t.canvas.width/2,a=t.y-t.canvas.height/2;e.drawImage(t.canvas,Math.floor(i),Math.floor(a)),n&&this.debug(t.x,t.y,t.canvas.width,t.canvas.height,e)},drawLabel:function(t,e,n){e.save(),e.textBaseline="middle",e.textAlign="center";let i=t.x,a=t.y;if(e.fillStyle=t.color,e.font=`${t.style} ${t.size}px ${t.font}`,e.fillText(t.content,Math.floor(i),Math.floor(a)),n){const n=this.measureLabel(t,e),o=n.actualBoundingBoxRight+n.actualBoundingBoxLeft,s=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent;this.debug(i,a,o,s,e)}},hit:function(t,e,n){for(let i=0;i<t.length;i++){let a=t[i];if(a.hit)if(a instanceof Sprite){if(this.insideSprite(a,e))return a}else if(a instanceof Label&&this.insideLabel(a,e,n))return a}return null},insideSprite:function(t,e){const n=e.target.getBoundingClientRect();let i=(e.clientX-n.left)/this.scaleFactor,a=(e.clientY-n.top)/this.scaleFactor;const o=t.canvas.width/2,s=t.canvas.height/2;return i>=t.x-o&&i<=t.x+o&&a>=t.y-s&&a<=t.y+s},insideLabel:function(t,e,n){const i=e.target.getBoundingClientRect(),a=(e.clientX-i.left)/this.scaleFactor,o=(e.clientY-i.top)/this.scaleFactor,s=this.measureLabel(t,n),l=(s.actualBoundingBoxRight+s.actualBoundingBoxLeft)/2,h=(s.actualBoundingBoxAscent+s.actualBoundingBoxDescent)/2;return a>=t.x-l&&a<=t.x+l&&o>=t.y-h&&o<=t.y+h},loadBitmap:async function(t){console.log("Will load "+t);const e=await fetch(t),n=await e.blob();return window.createImageBitmap(n)},transform:function(t,e,n,i){const a=mathUtils.degreesToRadians(n),o=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),l=t/i.width,h=e/i.height,c=i.width*l*o+i.height*h*s,r=i.width*l*s+i.height*h*o,d=new OffscreenCanvas(Math.round(c),Math.round(r)),g=d.getContext("2d",{alpha:!0,willReadFrequently:!0,imageSmoothingEnabled:!1});return g.setTransform(1,0,0,1,0,0),g.translate(d.width/2,d.height/2),g.rotate(a),g.scale(l,h),g.drawImage(i,-i.width/2,-i.height/2),d},debug:function(t,e,n,i,a){a.lineWidth=1,a.strokeStyle="yellow",a.strokeRect(t-n/2-1,e-i/2-1,n+1,i+1)},strokeLine:function(t,e,n,i,a,o){o.beginPath(),o.moveTo(t,e),o.lineTo(n,i),o.strokeStyle=a,o.stroke()},scaleWidth:function(t,e,n){const i=t/n.width;return this.transform(n.width*i,n.height*i,e,n)},scaleHeight:function(t,e,n){const i=t/n.height;return this.transform(n.width*i,n.height*i,e,n)},measureLabel:function(t,e){return e.textBaseline="actualBoundingBoxAscent",e.textAlign="center",e.font=`${t.style} ${t.size}px ${t.font}`,e.measureText(t.content)},alignLeft:function(t,e,n){let i=this.measureLabel(t,n),a=i.actualBoundingBoxRight+i.actualBoundingBoxLeft;t.x=e+.5*a},collision:function(t,e){const n=t.canvas.width,i=t.canvas.height,a=e.canvas.width,o=e.canvas.height,s=t.x-n/2,l=t.x+n/2,h=t.y-i/2,c=t.y+i/2,r=e.x-a/2,d=e.x+a/2,g=e.y-o/2,u=e.y+o/2;return!(l<r||s>d||c<g||h>u)}};
