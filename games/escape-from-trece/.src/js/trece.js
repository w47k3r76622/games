const game={steps:[],stepsCount:109,dy:13,size:{width:1e3,height:1600},stepSize:{width:100,height:24},playerSize:{width:100,height:96},dx:0,player:new Sprite(0,0,.5,!1,null),playerStep:100,countdownTime:0,inGame:!1,floorLabels:[],gameOverLabel:new Label(500,560,0,!1,"GAME OVER","black","bold",60,"Arial"),winLabel:new Label(500,560,0,!1,"YOU WIN!","black","bold",60,"Arial"),homeButton:new Label(500,850,0,!0,"HOME","black","normal",60,"Arial"),tryAgainButton:new Label(500,950,0,!0,"TRY AGAIN","black","normal",60,"Arial"),playButton:new Label(500,1300,0,!0,"PLAY","white","normal",60,"Arial"),countdownLabel:new Label(500,800,0,!1,"","white","normal",130,"Arial"),scoreBackground:new Sprite(500,800,.4,!1,null),directionSteps:[10,19,28,37,46,55,64,73,82,91,100,109],showingCountdown:!1,showingScore:!1,objects:[],audiosLoaded:!1,tapAudio:null,hitAudio:null,debug:!1,stepOnCanvas:null,introTexts:[],upButton:new Sprite(900,1280,.5,!0,null),downButton:new Sprite(900,1500,.5,!0,null),upArrow:new Label(900,1280,0,!1,"↑","black","bold",72,"Arial"),downArrow:new Label(900,1500,0,!1,"↓","black","bold",72,"Arial"),lives:[],totalLives:4,enemies:[],enemyCanvas:null,liveCanvas:null,upPressed:!1,downPressed:!1,init:async function(t,i){this.canvas=t,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.ctx=i,this.tapAudio=await sound.loadAudio("./snd/tap.opus"),this.hitAudio=await sound.loadAudio("./snd/hit.opus"),this.upButton.canvas=graphics.transform(180,180,0,await graphics.loadBitmap("./img/up.png")),this.downButton.canvas=graphics.transform(180,180,0,await graphics.loadBitmap("./img/down.png")),this.player.canvas=graphics.transform(36,96,0,await graphics.loadBitmap("./img/front.png")),this.stepOnCanvas=graphics.transform(this.stepSize.width,this.stepSize.height,0,await graphics.loadBitmap("./img/step-on.png")),this.scoreBackground.canvas=graphics.transform(600,600,0,await graphics.loadBitmap("./img/up.png")),this.liveCanvas=graphics.transform(32,32,0,await graphics.loadBitmap("./img/live.png")),this.enemyCanvas=graphics.transform(32,32,0,await graphics.loadBitmap("./img/enemy.png")),this.dx=.8*this.stepSize.width;let s=.5*this.stepSize.width,e=1600-.5*this.stepSize.height,o=1;for(let t=1;t<=this.stepsCount;t++)this.steps.push(new Sprite(s,e,2,!1,null)),this.isDirectionStep(t)&&(o*=-1,this.floorLabels.push(new Label(20,e-52,2,!1,String(this.directionSteps.indexOf(t)+2).padStart(2,"0"),"white","normal",32,"Arial"))),s+=this.dx*o,e-=this.dy;this.floorLabels.push(new Label(20,this.steps[9].y+52,2,!1,"01","white","normal",32,"Arial")),this.objects.push(this.playButton);const n=["Strange things happen","on 13th floor","and now the elevator is broken.","","Run!","","But be careful with the ...","","Use the on-screen buttons","or keyboard arrow up and down","to get to the ground floor."];let h=400,a=new Label(500,250,0,!1,"ESCAPE FROM TRECE","white","bold",60,"Arial");this.objects.push(a),this.introTexts.push(a);for(let t=0;t<n.length;t++)a=new Label(0,0,0,!1,n[t],"white","italic",48,"Arial"),graphics.alignLeft(a,130,this.ctx),a.y=h,this.introTexts.push(a),this.objects.push(a),h+=48;this.previous=performance.now()},update:function(t){if(this.showingCountdown){this.countdownTime-=t;const i=Math.round(this.countdownTime/1e3);this.countdownLabel.content=0==i?"GO!":String(i),this.countdownTime<=0&&(this.showingCountdown=!1,this.elapsedTime=0,this.inGame=!0,this.remove(this.objects,this.countdownLabel))}if(this.inGame){for(let i of this.enemies)if(i.y+=i.velocity*t,i.y>1700&&(i.y=-100,this.initEnemy(i)),i.isActive&&graphics.collision(this.player,i)){sound.playAudio(this.hitAudio);let t=this.lives.pop();this.remove(this.objects,t),i.isActive=!1}0==this.lives.length&&this.end()}},onKeyDown:function(t){this.inGame&&("arrowdown"!=t||this.downPressed?"arrowup"!=t||this.upPressed||(this.goUp(),this.upPressed=!0):(this.goDown(),this.downPressed=!0),this.setPlayerPosition(),1==this.playerStep&&this.end())},onKeyUp:function(t){this.inGame&&("arrowdown"==t?this.downPressed=!1:"arrowup"==t&&(this.upPressed=!1))},onPointerDown:function(t){const i=graphics.hit(this.objects,t,this.ctx);i&&(i==this.playButton?this.start():i==this.homeButton?this.home():i==this.tryAgainButton?this.start():this.inGame&&(i==this.downButton?this.goDown():i==this.upButton&&this.goUp(),this.setPlayerPosition(),1==this.playerStep&&this.end()))},onPointerUp:function(t){},clear:function(){this.ctx.fillStyle="#383428",this.ctx.fillRect(0,0,this.size.width,this.size.height)},resize:function(){graphics.resizeContainer(this.size,{width:window.innerWidth,height:window.innerHeight},this.canvas)},setPlayerPosition:function(){const t=this.steps[this.playerStep-1];this.player.x=t.x,this.player.y=t.y-.5*this.stepSize.height-.5*this.playerSize.height},isDirectionStep:function(t){return-1!=this.directionSteps.indexOf(t)},start:function(){this.inGame=!1,this.showingCountdown=!0,this.showingScore=!1,this.countdownTime=3e3,this.playerStep=this.stepsCount,this.objects=[],this.lives=[],this.enemies=[];for(let t of this.steps)t.canvas=this.stepOnCanvas,this.objects.push(t);this.setPlayerPosition();for(let t of this.floorLabels)this.objects.push(t);let t=130;for(let i=0;i<this.totalLives;i++){let i=new Sprite(920,t,.5,!0,this.liveCanvas);this.lives.push(i),this.objects.push(i),t+=48}this.objects.push(this.player),this.objects.push(this.countdownLabel),this.objects.push(this.upButton),this.objects.push(this.downButton),this.objects.push(this.upArrow),this.objects.push(this.downArrow);for(let t=1;t<9;t++)for(let i=0;i<2;i++){let i=new Sprite(this.steps[t].x,random.nextDouble(-100,-1500),.25,!1,this.enemyCanvas);this.initEnemy(i),this.enemies.push(i),this.objects.push(i)}},home:function(){this.objects=[],this.objects.push(this.playButton);for(let t of this.introTexts)this.objects.push(t)},end:function(){this.inGame=!1,this.showingScore=!0,this.objects.push(this.tryAgainButton),this.objects.push(this.homeButton),this.objects.push(this.scoreBackground),this.remove(this.objects,this.upButton),this.remove(this.objects,this.downButton),this.remove(this.objects,this.downArrow),this.remove(this.objects,this.upArrow);for(let t of this.enemies)this.remove(this.objects,t);0==this.lives.length?this.objects.push(this.gameOverLabel):this.objects.push(this.winLabel)},remove:function(t,i){let s=t.findIndex((t=>t==i));-1!==s&&t.splice(s,1)},initEnemy:function(t){t.velocity=random.nextDouble(.2,.4),t.isActive=!0},goDown:function(){this.playerStep-1>=0&&(sound.playAudio(this.tapAudio),this.playerStep--)},goUp:function(){this.playerStep+1<=this.stepsCount&&(sound.playAudio(this.tapAudio),this.playerStep++)}};
