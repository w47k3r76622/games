function Animation(e){this.onStart=e.onStart||blankFunction,this.onFrame=e.onFrame||blankFunction,this.onStop=e.onStop||blankFunction,this.running=!1,this.frame=0}var reqAnimFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame,blankFunction=function(){};Animation.prototype={},Animation.prototype.start=function(){this.running=!0,this.onStart(),this.go()},Animation.prototype.go=function(){if(this.running){this.frame+=1;var e=this;reqAnimFrame(function(){e.go()}),this.onFrame(this.frame)}},Animation.prototype.stop=function(){this.running=!1,this.onStop()},Animation.prototype.pause=function(){this.running=!1},Animation.prototype.resume=function(){this.running=!0,this.go()},Game.prototype.updateMines=function(e){for(var n=0;n<this.mines.length;n++){var i=this.mines[n];if(!i.hidden){var t=i.getWord(),a=distance(e.coords,i.coords);a<t.distance?g.actions["mine-level-up"](n):a>t.levelDownDistance?g.actions["mine-level-down"](n):g.views.updateMine(n,i.interpolateSize(a,i.level))}}},window.g=window.g||{},g.glitch={},g.glitch.chars=[];for(var i=768;879>=i;i++)g.glitch.chars.push(String.fromCharCode(i));g.glitch.transform=function(e,n){var i=e.split("").map(function(e){for(var i=0;n>i;i++)e+=choice(g.glitch.chars);return e});return i.join("")};var choice=function(e){var n=randInt(e.length);return e[n]};window.$=function(e){var n="string"==typeof e?document.getElementById(e):e;return n?(n.text=function(e){return n.textContent=e,this},n.html=function(e){return n.innerHTML=e,this},n.css=function(e){for(var i in e)n.style[i]=e[i];return this},n.attrs=function(e){for(var i in e)n.setAttribute(i,e[i]);return this},n.hide=function(){return n.css({display:"none"}),this},n.show=function(){return n.css({display:""}),this},n.bind=function(e,i){return n.addEventListener("click",i),this},n.removeClass=function(e){return n.className=n.className.replace(e,"").replace("  "," "),this},n.addClass=function(e){return n.className.match(e)||(n.className=n.className+" "+e),this},n):n},window.randomWords=!1,function(){function e(e){g.game=new Game(JSON.parse(e.game)),g.me=g.game.getPlayer(e.name),g.views.showGame()}function n(){setupSocket(t),t.bind("connect",function(){}),t.bind("disconnect",function(){}),t.bind("error",function(e){console.log("Error:",e),$("error").text(e)});for(var e in g.listeners)t.bind(e,g.listeners[e])}function i(){g.bbox=document.body.getBoundingClientRect(),g.frame=xy(0,0),g.views.showIntro(),t=io({upgrade:!1,transports:["websocket"]});for(var e in o)$(e).bind("click",o[e]);n()}window.g=window.g||{},g.me=null,g.game=null,g.errors={};var t,a={startSignal:"new_game",name:"",code:""},r=function(e){a[e]=$("input-"+e).value};g.actions={"mine-level-up":function(e){var n=g.game.mines[e];n.canPlayerTrigger(g.me)&&(n.levelUp(g.me),n.getWord().singlePlayerOnly||t.emit("mine_level_up",{code:g.game.code,name:g.me.name,mine_index:e}),g.views.updateMine(e),g.views.bounce($("mine-"+e)))},"mine-level-down":function(e){var n=g.game.mines[e];n.canPlayerTrigger(g.me)&&(n.levelDown(g.me),n.getWord().singlePlayerOnly||t.emit("mine_level_down",{code:g.game.code,name:g.me.name,mine_index:e}),g.views.updateMine(e))},"player-move-start":function(e){e.code=g.game.code,t.emit("player-move-start",e)},"player-move-stop":function(e){e.code=g.game.code,t.emit("player-move-stop",e)},"player-update-coords":function(){t.emit("player-update-coords",{code:g.game.code,name:g.me.name,coords:g.me.coords})},"player-meet":function(e){t.emit("player-meet",{code:g.game.code,name:g.me.name,name2:e.name})},"player-snap":function(e){var n=getWireId(g.me.name,e.name);g.views.removeWire(n),t.emit("player-snap",{code:g.game.code,name:g.me.name,name2:e.name})}},g.listeners={tick:function(){g.actions["player-update-coords"]()},player_joined:function(n){if(n.name===a.name)e(n),g.views.renderGame();else{var i=new Player(n.data);i.game=g.game,g.game.players.push(i),g.views.renderSidebar(),g.views.renderPlayer(i)}},update_mine:function(e){var n=e["new"];n&&(g.game.mines[e.mine_index]=new Mine(e.mine));var i=g.game.mines[e.mine_index];i.index=e.mine_index;var t=i.level!==e.mine.level,a=!!i.hidden&&i.hidden!==e.mine.hidden,r="number"==typeof e.delay?e.delay:a?randFloat(1e3):0;i.hidden=1,setTimeout(function(){g.game.mines[e.mine_index].updateFromData(e.mine),g.views[n?"renderMine":"updateMine"](e.mine_index),(t||a)&&g.views.bounce($("mine-"+e.mine_index))},r)},"player-move-start":function(e){e.name!==g.me.name&&g.game.getPlayer(e.name).startMove(e.move_id,e.dir)},"player-move-stop":function(e){e.name!==g.me.name&&g.game.getPlayer(e.name).stopMove(e.move_id)},"player-update-coords":function(e){if(e.name!==g.me.name){var n=g.game.getPlayer(e.name),i=(distance(e.coords,n.coords),V.subtract(e.coords,n.coords)),t=V.scale(i,.02);g.errors[n.name]=t}},"player-update":function(e){var n=g.game.getPlayer(e.name);e.player.coords=n.coords;var i=n.coords.x;n.updateFromData(e.player),n.name===g.me.name&&g.views.moveFrame(n.coords.x-i),n.game=g.game,g.views.updatePlayer(n)},"wire-add":function(e){g.views.wires[e.wire_id]=" "},"wire-remove":function(e){var n=getWireId(e.player1,e.player2),i=g.game.getPlayer(e.player1),t=g.game.getPlayer(e.player2);i.removeWire(t),t.removeWire(i),g.views.removeWire(n)},"mine-powerup":function(e){var n=g.game.mines[e.mine_index];n.powered=e.powered,g.views.poweredMines[n.id]=!0,g.views.updateMine(e.mine_index)},checkpoint:function(e){g.me.checkpoint=e.coords},die:function(e){var n=g.game.getPlayer(e.name);n.updateFromData(e.player),n.game=this.game,g.views.updatePlayer(n)},"game-over":function(e){g.views.showGameOver(e)}};var o={"game-new":function(){g.views.showStartGame()},"game-join":function(){a.startSignal="join_game",g.views.showStartGame(!0)},start:function(){["name","code"].forEach(r),t.emit(a.startSignal,a)}};window.addEventListener("load",i,!1)}();var keyboardMovements={37:xy(-1,0),39:xy(1,0),38:xy(0,-1),40:xy(0,1)};window.addEventListener("keydown",function(e){var n=e.which;n in keyboardMovements&&(e.preventDefault(),g.me.startMove(n,keyboardMovements[n]))}),window.addEventListener("keyup",function(e){var n=e.which;n in keyboardMovements&&(e.preventDefault(),g.me.stopMove(n))});var d0=200;Mine.prototype.interpolateSize=function(e,n){var i=this.getWord(n);if(n>=this.words.length-1)return i.size;var t=0===n?{distance:i.distance+d0}:this.getWord(n-1),a=this.getWord(n+1),r=(t.distance-e)/(t.distance-i.distance);return Math.max(i.size,i.size+(a.size-i.size)*r)},Player.prototype.isMe=function(){return this.name===g.me.name},Player.prototype.move=function(e){var n=this.name in g.errors?g.errors[this.name]:xy(0,0);this.coords.x+=e.x*Settings.velocity+(n.x||0),this.coords.y+=e.y*Settings.velocity+(n.y||0),this.name===g.me.name&&this.checkMargin(),this.checkWires(),g.game.updateMines(g.me),g.views.updatePlayer(this)},Player.prototype.checkMargin=function(){var e=Math.max(0,this.coords.x-(g.frame.x+g.bbox.width*(1-Settings.marginR))),n=Math.min(0,this.coords.x-(g.frame.x+g.bbox.width*Settings.marginL)),i=e||n;0!==i&&g.views.moveFrame(i)},Player.prototype.checkWires=function(){var e=this;e.name===g.me.name&&g.game.eachPlayer(function(n){if(n.name!==e.name){var i=distance(n.coords,e.coords);return void(e.hasWireTo(n)?i>Settings.wireFar&&g.actions["player-snap"](n,!0):i<Settings.wireNear&&g.actions["player-meet"](n));var i}})},Player.prototype.removeWire=function(e){this.hasWireTo(e)&&this.wires.splice(this.wires.indexOf(e.name),1)},Player.prototype.startMove=function(e,n){if(this.moves=this.moves||{},!(e in this.moves)){var i=this,t=new Animation({onStart:function(){i.move(n)},onFrame:function(){i.move(n)}});this.moves[e]=t,t.start(),this.isMe()&&g.actions["player-move-start"]({name:this.name,move_id:this.name+"-move-"+e,dir:n})}},Player.prototype.stopMove=function(e){e in this.moves&&(this.moves[e].stop(),this.isMe()&&g.actions["player-move-stop"]({name:this.name,move_id:this.name+"-move-"+e,final_coords:this.coords}),delete this.moves[e],g.actions["player-update-coords"]())},window.g=window.g||{},g.views={},g.views.showIntro=function(){$("sidebar").hide(),$("intro").show()},g.views.showStartGame=function(e){$("game-new").hide(),$("game-join").hide(),$("start").show(),$("input-name").show().focus(),e&&$("input-code").show().focus()},g.views.showGame=function(){$("intro").hide(),$("gameplay").show(),$("sidebar").show()},g.views.renderGame=function(){g.views.renderSidebar();for(var e=0;e<g.game.mines.length;e++)g.views.renderMine(e);g.game.eachPlayer(function(e){g.views.renderPlayer(e)})},g.views.renderSidebar=function(){$("code").text("game "+g.game.code),$("players").html(""),g.game.eachPlayer(g.views.renderSidebarPlayer)},g.views.renderSidebarPlayer=function(e){var n=($("players"),$($("player-sidebar-template").cloneNode(!0)));n.html(n.innerHTML.replace(/\$name/g,e.name)).show(),n.id="",$("players").appendChild(n)},g.views.updateSidebarPlayer=function(e){$("pi-glitches-"+e.name).text("Glitches: "+e.glitchLevel),$("pi-oxy-"+e.name).css({width:Math.ceil(100*e.oxygen)+"%"})},g.views.moveFrame=function(e){g.frame.x+=e;var n={left:"-"+g.frame.x+"px"};$("gameplay").css(n),$("wires").css(n)},g.views.poweredMines={},g.views.renderMine=function(e){var n=$(document.createElement("div"));n.addClass("mine"),n.id="mine-"+e,$("gameplay").appendChild(n),g.views.updateMine(e)},g.views.updateMine=function(e,n){var i=$("mine-"+e),t=g.game.mines[e],a=t.getWord();if(i&&(t.hidden?i.hide():i.show(),!t.hidden)){(t.wirable||t.lvl0border&&0===t.level)&&i.addClass("wirable"),g.views.poweredMines[t.id]?i.addClass("powered"):i.removeClass("powered");var n=n||a.size,r=a.text.split("\n").map(function(e){return g.glitch.transform(e,a.glitchLevel)});i.html(r.join("<br/>")).css({left:t.coords.x+"px",top:t.coords.y+"px",color:a.color||"white",fontWeight:8>=n?200:800}),i.bouncing||i.css({fontSize:n+"px"}),t.wires.forEach(function(e){var n=getWireId(t.id,e);n in g.views.wires&&g.views.addWire(n,t.coords,g.game.getMineById(e).coords)})}},g.views.bounce=function(e){if(!e.bouncing){var n=parseInt(e.style.fontSize);e.bouncing=!0,e.className.match(/bounce/)||(e.addClass("bounce").css({fontSize:1.5*n+"px"}),setTimeout(function(){e.css({fontSize:n+"px"}),setTimeout(function(){e.removeClass("bounce"),e.bouncing=!1},200)},100))}},g.views.renderPlayer=function(e){e=e||g.me;var n=$(document.createElement("div"));n.addClass("player").id="player-"+e.name,$("gameplay").appendChild(n),g.views.updatePlayer(e)},g.views.updatePlayer=function(e){e=e||g.me;var n=g.glitch.transform("@"+e.name,e.glitchLevel);$("player-"+e.name).show().text(n).css({left:e.coords.x+"px",top:e.coords.y+"px"}),e.wires.forEach(function(n){var i=getWireId(e.name,n);g.views.addWire(i,e.coords,g.game.getPlayer(n).coords)}),g.views.updateSidebarPlayer(e)},g.views.showGameOver=function(e){var n=g.glitch.transform("game over",10);$("game-overlay").css({opacity:1}),$("game-msg").html("- "+n+" -<br />"+e.reason)},g.views.wires={},g.views.addWire=function(e,n,i){if(e in g.views.wires){var t=i.x-n.x,a=i.y-n.y;if(0>t&&0>a||0>t&&a>0&&a>Math.abs(t)||t>0&&0>a&&t>Math.abs(a)){var r=i;i=n,n=r}var o=V.subtract(i,n),s=absMin(o.x,o.y),m=xy(s*sign(o.x),s*sign(o.y)),c=V.subtract(o,m);c.x/=2,c.y/=2;var d=[n];0!==t&&0!==a&&(d.push(V.add(n,c)),d.push(V.add(d[1],m))),d.push(i);var l=g.views.makeLine(e,d,"#ABE3A1");return g.views.wires[e]=l,g.views.renderWires(),l=l.replace("NaN","0")}},g.views.makeLine=function(e,n,i){function t(e,n){return'<path d="'+a+'" stroke-width="'+n.toString()+'" stroke="'+i+'" opacity="'+e.toString()+'" fill="transparent"></path>'}var a="M"+n.map(function(e){return e.x+" "+e.y}).join(" L "),r=t(.1,8);return r+=t(.3,4),r+=t(.5,2),r+=t(.6,1)},g.views.removeWire=function(e){delete g.views.wires[e],g.views.renderWires()},g.views.renderWires=function(){$("wires").html("").html(Object.keys(g.views.wires).map(function(e){return g.views.wires[e]}).join(""))};
