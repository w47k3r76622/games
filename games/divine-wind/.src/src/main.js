const canvas=document.getElementById("renderCanvas"),engine=new BABYLON.Engine(canvas,!0),pather=new MazePather,mazes=[];for(let i=3;i<3+LEVELS;i++){let e=new Maze(i,0,BOTTOM_CENTER,TOP_CENTER);do e.scrambleOffsets();while(pather.solve(e).length>0);mazes.push(e)}const gameState={currentLevel:0,scene:void 0,xr:void 0,graphicalMaze:void 0,shipManager:void 0,timer:LEVEL_TIME,timestamp:new Date,timing:!1,cooling:!1,lost:!1,startLevelTimer:function(){this.timer=LEVEL_TIME,this.timestamp=new Date,this.timing=!0},endLevelTimer:function(){this.timing=!1},startCooldownTimer:function(){this.cooling=!0,this.timer=LEVEL_COOLDOWN},endCooldownTimer:function(){this.cooling=!1},endLevel:function(){this.endLevelTimer(),this.lost||(this.currentLevel===mazes.length-1&&(this.xr.baseExperience.exitXRAsync(),document.getElementById("screenText").innerText="You have defended Japan!"),this.currentLevel++,gameState.graphicalMaze.destroy(),this.startCooldownTimer(),this.shipManager.blowWaveAway())},startNextLevel:function(){this.startLevelTimer(),gameState.graphicalMaze=new GraphicalMaze(mazes[gameState.currentLevel],this.scene),gameState.graphicalMaze.origin.position.y=1,this.shipManager.startWave(LEVEL_TIME,SHIP_SPEED,(1+this.currentLevel)*10)},decrementTimer:function(){let e=this.timestamp;this.timestamp=new Date;let t=(this.timestamp-e)/1e3;this.timing?(this.timer-=t,this.timer<=0&&(this.endLevelTimer(),this.lost=!0,this.xr.baseExperience.exitXRAsync(),document.getElementById("screenText").innerText="The Mongols succeed...")):this.cooling&&(this.timer-=t,this.timer<=0&&(this.endCooldownTimer(),this.startNextLevel()))}},createScene=async function(){let e=new BABYLON.Scene(engine);e.clearColor=new BABYLON.Color3(180/256,217/256,239/256),e.fogMode=BABYLON.Scene.FOGMODE_EXP,e.fogColor=new BABYLON.Color3(.9,.9,.85),e.fogDensity=.02;let t=new BABYLON.UniversalCamera("camera1",new BABYLON.Vector3(0,0,-.5),e);t.setTarget(BABYLON.Vector3.Zero()),t.attachControl(canvas,!0);let a=new BABYLON.HemisphericLight("light",new BABYLON.Vector3(0,1,0),e);a.intensity=.7;let n=BABYLON.MeshBuilder.CreateGround("sea",{width:100,height:100}),r=new BABYLON.StandardMaterial("seaMat");r.diffuseColor=new BABYLON.Color3(0,0,1),n.material=r,n.position.y=-.001,n.position.z=50;let s=BABYLON.MeshBuilder.CreateGround("ground",{width:100,height:100}),o=new BABYLON.StandardMaterial("groundMat");o.diffuseColor=new BABYLON.Color3(0,1,0),s.material=o,s.position.y=.01,s.position.z=-50,gameState.scene=e,gameState.shipManager=new ShipManager(e,100,50),e.registerBeforeRender(()=>{gameState.decrementTimer()});let l=await e.createDefaultXRExperienceAsync({pointerSelectionOptions:{preferredHandedness:"right",disableSwitchOnClick:!0}});gameState.xr=l,l.baseExperience.onStateChangedObservable.add(t=>{t===BABYLON.WebXRState.IN_XR&&(document.getElementById("screenText").innerText="",gameState.startLevelTimer(),gameState.shipManager.startWave(LEVEL_TIME,SHIP_SPEED,(1+gameState.currentLevel)*10),gameState.graphicalMaze=new GraphicalMaze(mazes[gameState.currentLevel],e),gameState.graphicalMaze.origin.position.y=1)});let g=new BABYLON.Ray(new BABYLON.Vector3,new BABYLON.Vector3);return l.input.onControllerAddedObservable.add(t=>{"left"!==t.inputSource.handedness&&e.onPointerObservable.add(a=>{t.getWorldPointerRayToRef(g);let n=e.pickWithRay(g,e=>e===gameState.graphicalMaze.pickingPlane);switch(a.type){case BABYLON.PointerEventTypes.POINTERDOWN:if(n.hit){let r=BABYLON.Vector3.Distance(n.pickedPoint,gameState.graphicalMaze.origin.position);gameState.graphicalMaze.initRotateLayer(r,n.pickedPoint)}break;case BABYLON.PointerEventTypes.POINTERMOVE:if(gameState.graphicalMaze.isSolved&&t.pointer.position.z>gameState.graphicalMaze.origin.position.z&&(gameState.endLevel(),pather.drawnPath.dispose()),n.hit){if(gameState.graphicalMaze.rotating)gameState.graphicalMaze.rotateLayer(n.pickedPoint);else{let s=BABYLON.Vector3.Distance(n.pickedPoint,gameState.graphicalMaze.origin.position);gameState.graphicalMaze.highlightLayer(s)}}else gameState.graphicalMaze.unhightlightLayers(),gameState.graphicalMaze.endRotateLayer();break;case BABYLON.PointerEventTypes.POINTERUP:if(gameState.cooling)return;gameState.graphicalMaze.endRotateLayer(),gameState.graphicalMaze.unhightlightLayers(),mazes[gameState.currentLevel].setOffsets(gameState.graphicalMaze.offsets()),pather.solveAndShow(mazes[gameState.currentLevel]),pather.solution.length>0&&gameState.graphicalMaze.solved()}})}),e},scene=createScene();engine.runRenderLoop(async function(){(await scene).render()}),window.addEventListener("resize",function(){engine.resize()});