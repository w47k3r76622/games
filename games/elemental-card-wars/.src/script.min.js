/*! elementalcardward 2014-09-09 */
function GameMat(){this.trumps=new Trumps,this.adjusttrumps=function(a){this.trumps.set_trump_value(a.suit,this.trumps.get_trump_value(a.suit)+a.trump)},this.applyabilities=function(){},this.comparecards=function(a,b){this.trumps.sorttrumps();var c,d,e=this.trumps.get_trump_value(a.suit),f=this.trumps.get_trump_value(b.suit),g=a.value,h=b.value;e>f?(c="player",d="opponent"):f>e?(c="opponent",d="player"):g>h?(c="player",d="opponent"):h>g?(c="opponent",d="player"):(c="tie",d="tie"),"player"==c&&(playr.points[a.suit]+=this.trumps.get_trump_value(a.suit)>0?1+this.trumps.get_trump_index(a.suit):1),"opponent"==c&&(oppt.points[b.suit]+=this.trumps.get_trump_value(b.suit)>0?1+this.trumps.get_trump_index(b.suit):1),"tie"==c&&(oppt.points[b.suit]++,playr.points[a.suit]++);var i=this.trumps.checkburnout();if(i.length>0)for(var j=i.length-1;j>=0;j--)i[j]==a.suit,i[j]==b.suit},this.render=function(){this.trumps.render(),this.render_points(oppt.points,"opponent-sidebar"),this.render_points(playr.points,"player-sidebar")},this.render_points=function(a,b){var c=document.getElementById(b);emptynode(c);for(var d=suits.length-1;d>=0;d--){var e=addnode("div","",c,"pointcontainer");addnode("span","",e,"trump t-"+suits[d]),addnode("span",a[suits[d]],e,"points")}}}function Trumps(){this.trumps=[{suit:"A",value:1},{suit:"E",value:1},{suit:"W",value:1},{suit:"F",value:1}],this.sorttrumps=function(){this.trumps.sort(function(a,b){return a.value<b.value?-1:a.value>b.value?1:0})},this.get_trump_value=function(a){for(var b=this.trumps.length-1;b>=0;b--)if(this.trumps[b].suit==a)return this.trumps[b].value;return null},this.set_trump_value=function(a,b){for(var c=this.trumps.length-1;c>=0;c--)if(this.trumps[c].suit==a&&this.trumps[c].value>0){this.trumps[c].value=b;break}},this.get_trump_index=function(a){for(var b=this.trumps.length-1;b>=0;b--)if(this.trumps[b].suit==a)return b;return null},this.render=function(){this.sorttrumps(),emptynode(_trumps);for(var a=this.trumps.length-1;a>=0;a--)multinode(_trumps,"t-"+this.trumps[a].suit,this.trumps[a].value)},this.checkburnout=function(){for(var a=[],b=this.trumps.length-1;b>=0;b--)this.trumps[b].value>_trump_limit&&(a.push(this.trumps[b].suit),this.trumps[b].value=0);return a},this.num_burned_out=function(){return this.trumps.filter(function(a){return 0==a.value}).length}}function Deck(a,b,c,d){this.drawdeck=[],this.discard=[],this.hand=[],this._e=a,this.show=b,this._hand_e=null,this._discard_e=document.getElementById(c),this._play_e=document.getElementById(d),this._draw_e=null,this.draw=function(a){for(var b=a-this.hand.length,c=b-1;c>=0;c--)this.drawdeck.length>0&&this.hand.push(this.drawdeck.splice(rand(this.drawdeck.length-1,0),1)[0]);this.render()},this.reshuffle=function(){this.discard.forEach(function(a){this.drawdeck.push(a)},this),this.discard=[]},this.discardFromHand=function(a){var b=this.hand.indexOf(a);b>=0&&(this.hand[b].remove_clickable(),this.discard.push(this.hand.splice(b,1)[0])),this.render()},this.discardFromDraw=function(){this.discard.push(this.drawdeck.splice(rand(this.drawdeck.length-1,0),1)[0]),this.render()},this.render=function(){null==this._hand_e&&(this._hand_e=addnode("div","",this._e,"hand")),null==this._draw_e&&(this._draw_e=addnode("div","",this._e,"draw")),emptynode(this._discard_e),this.discard.length>0&&this.discard[this.discard.length-1].render(this._discard_e),emptynode(this._play_e),null!=this.choosencard&&this.choosencard.render(this._play_e),emptynode(this._hand_e),this.hand.forEach(function(a){a.render(this._hand_e,this.show)},this),this._draw_e.textContent=this.drawdeck.length},this.make_hand_clickable=function(){this.hand.forEach(function(a){a.make_clickable()},this)},this.remove_hand_clickable=function(){this.hand.forEach(function(a){a.remove_clickable()},this)},this.play_card=function(a){var b=this.hand.indexOf(a);0>b||b>this.hand.length||(a.remove_clickable(),this.choosencard=this.hand.splice(b,1)[0],this.render())},this.discard_played=function(){this.discard.push(this.choosencard),this.choosencard=null,this.render()}}function Card(a,b){this.suit=a,this.value=b,this.deck=null,this.show=!0,this.trump=this.value<trump_dist[a].three?3:this.value<trump_dist[a].two?2:this.value<trump_dist[a].one?1:0,this._e=null,this.render=function(a,b){if(void 0==b&&(b=!0),b?this.show||(this._e=null):this.show=!1,null==this._e){var c=b?this.suit+"-card "+this.suit+"-"+this.value:"card-back";this._e=addnode("div","",a,"card "+c),b&&(addnode("span",this.convertedvalue(),this._e,"cardvalue"+this.convertedvalue_style()),addnode("span","",this._e,"suit s-"+this.suit),multinode(this._e,"trump",this.trump))}else a.appendChild(this._e);return this._e},this.convertedvalue=function(){switch(this.value){case 13:return"K";case 12:return"Q";case 11:return"J";default:return this.value}},this.convertedvalue_style=function(){switch(this.value){case 13:return"K";case 12:return"Q";case 11:return"J";default:return""}},this.handleEvent=function(a){switch(a.type){case"click":this.deck.play_card(this),next_gamestep()}},this.make_clickable=function(){this._e.className+=" clickable",this._e.addEventListener("click",this,!1)},this.remove_clickable=function(){this._e.className=this._e.className.replace(" clickable",""),this._e.removeEventListener("click",this,!1)}}function next_gamestep(){"E"==game_state?(game_state="D",(player_deck.drawdeck.length+player_deck.hand.length==0||opponent_deck.drawdeck.length+opponent_deck.hand.length==0)&&endgame(),player_deck.draw(3),opponent_deck.draw(3),game_state="P",player_deck.make_hand_clickable()):"P"==game_state?(player_deck.remove_hand_clickable(),game_state="O",oppt.chooseCard(),setTimeout(next_gamestep,1e3)):"O"==game_state?(game_state="T",game_mat.adjusttrumps(player_deck.choosencard),game_mat.adjusttrumps(opponent_deck.choosencard),setTimeout(next_gamestep,1e3)):"T"==game_state&&(game_state="B",game_mat.applyabilities(player_deck.choosencard,opponent_deck.choosencard),game_mat.comparecards(player_deck.choosencard,opponent_deck.choosencard),player_deck.discard_played(),opponent_deck.discard_played(),game_state="E",setTimeout(next_gamestep,1e3)),"Z"!=game_state&&(game_mat.render(),4==game_mat.trumps.num_burned_out()&&endgame())}function Opponent(a){this.deck=a,this.points={};for(var b=suits.length-1;b>=0;b--)this.points[suits[b]]=0;this.chooseCard=function(){this.deck.play_card(this.deck.hand[0])},this.score=function(){for(var a=0,b=suits.length-1;b>=0;b--){var c=this.points[suits[b]];(0==a||a>c)&&(a=c)}return a}}function Player(a){this.points={},this.deck=a,this.points={};for(var b=suits.length-1;b>=0;b--)this.points[suits[b]]=0;this.score=function(){for(var a=0,b=suits.length-1;b>=0;b--){var c=this.points[suits[b]];(0==a||a>c)&&(a=c)}return a}}function addnode(a,b,c,d){var e=document.createElement(a);return e.textContent=b,void 0!==d&&(e.className=d),void 0!==c&&c.appendChild(e),e}function multinode(a,b,c){var d=a.querySelector("div."+b);if(0==c&&null!==d)a.removeChild(d);else if(c>0){null===d&&(d=addnode("div","",a,b+" multi")),emptynode(d);for(var e=c-1;e>=0;e--)addnode("span","",d,b)}}function emptynode(b){if(null!==b)for(;a=b.firstChild;)b.removeChild(a)}function updateattr(a,b,c){var d=document.createAttribute(b);d.nodeValue=c,a.attributes.setNamedItem(d)}function getattr(a,b){return a.attributes.getNamedItem(b).textContent}function addlistener(a,b,c){document.getElementById(a).addEventListener(b,c)}function rand(a,b){return void 0==b&&(b=0),Math.floor(Math.random()*a)+b}function pop(a){a.target.parentNode.removeChild(a.target)}function setup(){player_deck=new Deck(document.getElementById("player"),!0,"player-discard","player-play"),opponent_deck=new Deck(document.getElementById("opponent"),!1,"opponent-discard","opponent-play");for(var a=[],b=suits.length-1;b>=0;b--)for(var c=12;c>=0;c--)a.push(new Card(suits[b],c+1));for(var d=a.length,e=d-1;e>=0;e--){var f=this.player_deck;e%2==0&&(f=this.opponent_deck);var g=a.splice(rand(a-1,0),1)[0];g.deck=f,f.drawdeck.push(g)}oppt=new Opponent(opponent_deck),playr=new Player(player_deck),game_state="E",game_mat=new GameMat,next_gamestep(),addlistener("intro","click",pop)}function endgame(){game_state="Z",player_score=playr.score(),opponent_score=oppt.score(),player_deck.remove_hand_clickable(),opponent_deck.remove_hand_clickable();var a=addnode("div","",document.getElementById("wrap"),"infobox"),b=addnode("div","",a,"results"),c=addnode("div","",a,"results");addnode("h2","End Game",a),addnode("h3","Player:",b),addnode("div","",b).id="player_score",game_mat.render_points(playr.points,"player_score"),addnode("span","Score:"+player_score,b),addnode("h3","Opponent",c),addnode("div","",c).id="opponent_score",game_mat.render_points(oppt.points,"opponent_score"),addnode("span","Score:"+opponent_score,c);var d="Player Wins.";opponent_score>player_score&&(d="Opponent Wins."),addnode("h2",d,a)}var _trumps=document.getElementById("trumps"),_trump_limit=7,suits=["A","E","W","F"],trump_dist={F:{one:12,two:8,three:4},W:{one:9,two:4,three:2},A:{one:9,two:4,three:2},E:{one:12,two:2,three:0}};