let e,t,l,s,r=[];const a={GRASS:0,WATER:1,SAND:2,DEEPWATER:3,FOREST:4,HILLS:5,MOUNTAIN:6,SNOW:7},h={GRAZING:0,WANDERING:1,SLEEPING:2,FLEEING:3,AGRESSIVE:4},i={tiles:[],width:0,height:0},n={x:0,y:0,w:20,h:20,b:4},o=(e,t)=>Math.floor(Math.random()*t)+e,y=e=>e[o(0,e.length)],c=(e,t,l)=>(1-l)*e+l*t,x=(e,t,l,s,r,a)=>e<=r&&r<=e+l&&t<=a&&a<=t+s,f=(e,t,l=0)=>{const s=[];for(let r=0;r<t;r++)s.push(Array(e).fill(l));return s},S=e=>{let t=Math.random(),l=Math.random();return l<t&&([t,l]=[l,t]),[Math.floor(l*e*Math.cos(2*Math.PI*t/l)),Math.floor(l*e*Math.sin(2*Math.PI*t/l))]},d=(e,t)=>[[e,t-1,"N"],[e+1,t-1,"NE"],[e+1,t,"E"],[e+1,t+1,"SE"],[e,t+1,"S"],[e-1,t+1,"SW"],[e-1,t,"W"],[e-1,t-1,"NW"]],g=(e,t)=>{const l={N:[[-1,-1],[0,-1],[1,-1]],NE:[[0,-1],[1,-1],[1,0]],E:[[1,-1],[1,0],[1,1]],SE:[[1,0],[1,1],[0,1]],S:[[1,1],[0,1],[-1,1]],SW:[[0,1],[-1,1],[-1,0]],W:[[-1,1],[-1,0],[-1,-1]],NW:[[-1,0],[-1,-1],[0,-1]]};i.width=e,i.height=t,i.tiles=f(e,t,a.DEEPWATER);const s=f(e,t,-.3),[r,h]=[Math.floor(e/2),Math.floor(t/2)],n=[];for(let t=0;t<o(6,8);t++){const[t,l]=S(e/3.5);n.push((([e,t],l)=>({eruptions:o(l,2*l),x:e,y:t}))([r+t,h+l],o(32,64)))}for(const{x:r,y:a,eruptions:h}of n){s[a][r]=100;for(let i=0;i<h;i++){let h=Math.random(.6,4),i=y(d(r,a)),[n,o,c]=i;for(;h>0;){s[o][n]+=h;const r=((e,t,s,r,a)=>l[s].map(([l,s])=>{const[h,i]=[e+l,t+s];return[h<0?0:h>=r?r-1:h,i<0?0:i>=a?a-1:i]}))(n,o,c,e,t);r.forEach(([e,t])=>s[t][e]+=.2);const a=y(r);n=a[0],o=a[1],h-=.1}}}const x=((e,t)=>{const l=e[0].length,s=e.length,r=f(l,s),a=1<<t,h=1/a;for(let t=0;t<l;t++){let i=t/a*a,n=(i+a)%l,o=(t-i)*h;for(let l=0;l<s;l++){let y=l/a*a,x=(y+a)%s,f=(l-y)*h,S=c(e[y][i],e[y][n],o),d=c(e[x][i],e[x][n],o);r[l][t]=c(S,d,f)}}return r})(s,64);for(let e=0;e<x.length;e++)for(let t=0;t<x[0].length;t++){const l=x[e][t];switch(!0){case l>-.3&&l<=0:i.tiles[e][t]=a.WATER;break;case l>0&&l<=.3:i.tiles[e][t]=a.SAND;break;case l>.3&&l<=2:i.tiles[e][t]=a.GRASS;break;case l>2&&l<=5:i.tiles[e][t]=a.FOREST;break;case l>5&&l<=10:i.tiles[e][t]=a.HILLS;break;case l>10&&l<=15:i.tiles[e][t]=a.MOUNTAIN;break;case l>15:i.tiles[e][t]=a.SNOW}}},w=()=>{const e=[];for(let t=0;t<i.width;t++)for(let l=0;l<i.height;l++)i.tiles[l][t]===a.SAND&&e.push({x:t,y:l});const t=y(e);return t.t=[a.SAND,a.GRASS,a.FOREST,a.HILLS,a.MOUNTAIN],t.hunger=.01,t},N=(e,t)=>{n.x=Math.floor(e-n.w/2),n.y=Math.floor(t-n.h/2),n.x+n.w>i.width&&(n.x-=n.x+n.w-i.width),n.x<0&&(n.x=0),n.y<0&&(n.y=0),n.y+n.h>i.height&&(n.y-=n.y+n.h-i.height)},A=e=>(t,l)=>{const s=i.tiles[l][t];return e.t.includes(s)},E=(e,t,l)=>({x:e,y:t,sprite:"\ud83d\udc11",state:l,hunger:.1,t:[a.SAND,a.GRASS,a.FOREST,a.HILLS],update:l=>{let s,r;const n=E(e,t,l.state);if(n.hunger=1.02*l.hunger,n.hunger>.7&&n.state===h.WANDERING?n.state=h.GRAZING:n.hunger<=.1&&n.state===h.GRAZING&&(n.state=h.WANDERING),n.state===h.WANDERING)s=l.x+y([-1,0,1]),r=l.y+y([-1,0,1]);else if(n.state===h.GRAZING){const e=d(l.x,l.y).map(([e,t])=>[e,t,i.tiles[t][e]]).filter(e=>e[2]===a.GRASS);if(e.length>0){const t=y(e);s=t[0],r=t[1]}else s=l.x+y([-1,0,1]),r=l.y+y([-1,0,1])}return A(n)(s,r)&&(n.x=s,n.y=r,i.tiles[r][s]===a.GRASS&&n.state===h.GRAZING&&(n.hunger-=.1)),n}});document.addEventListener("keydown",e=>{const t=A(l);switch(e.key){case"w":l.y>0&&t(l.x,l.y-1)&&(l.y-=1);break;case"q":l.y>0&&l.x>0&&t(l.x-1,l.y-1)&&(l.x--,l.y--);break;case"s":l.y<i.height-1&&t(l.x,l.y+1)&&(l.y+=1);break;case"e":l.y>0&&l.x<i.width&&t(l.x+1,l.y-1)&&(l.x++,l.y--);break;case"a":l.x>0&&t(l.x-1,l.y)&&(l.x-=1);break;case"d":l.x<i.width-1&&t(l.x+1,l.y)&&(l.x+=1);break;case"z":l.x>0&&l.y<i.height-1&&t(l.x-1,l.y+1)&&(l.x--,l.y++);break;case"c":l.x<i.width-1&&l.y<i.height-1&&t(l.x+1,l.y+1)&&(l.x++,l.y++)}l.y<n.y+n.b&&n.y>0&&n.y--,l.y>n.y+n.h-n.b-1&&n.y+n.h<i.height&&n.y++,l.x<n.x+n.b&&n.x>0&&n.x--,l.x>n.x+n.w-n.b-1&&n.x+n.w<i.width&&n.x++,["w","q","e","s","a","d","z","c"].includes(e.key)&&(r=r.map(e=>e.update(e)))});const R=(e,l)=>{for(let s=0;s<n.w;s++)for(let r=0;r<n.h;r++){switch(i.tiles[r+n.y][s+n.x]){case a.GRASS:t.fillStyle="forestgreen";break;case a.WATER:t.fillStyle="deepskyblue";break;case a.SAND:t.fillStyle="Beige";break;case a.DEEPWATER:t.fillStyle="dodgerblue";break;case a.FOREST:t.fillStyle="green";break;case a.HILLS:t.fillStyle="grey";break;case a.MOUNTAIN:t.fillStyle="darkgrey";break;case a.SNOW:t.fillStyle="Azure"}t.fillRect(20*s+e,20*r+l,20,20)}},u=((...e)=>({widgets:e}))(((e,s)=>({x:e,y:s,render:()=>{R(e,s),t.font="16px serif",t.fillText("\ud83e\udd13",20*(l.x-n.x)+e,20*(l.y-n.y)+s+17);for(const l of r)x(n.x,n.y,n.w-1,n.h-1,l.x,l.y)&&t.fillText(l.sprite,20*(l.x-n.x)+e,20*(l.y-n.y)+s+17)}}))(20,20),((e,s,r,a)=>({x:e,y:s,w:r,h:a,render:()=>{t.font="16px serif",t.strokeStyle="#fff",t.fillStyle="#fff",t.strokeRect(e,s,r,a),t.fillText(`X: ${l.x}, Y: ${l.y}`,e+10,s+26)}}))(40+20*n.w,20,200,20*n.h)),b=e=>{},k=()=>{t.fillStyle="#000",t.fillRect(0,0,window.innerWidth,window.innerHeight),s.widgets.forEach(e=>e.render())};(()=>{(e=document.getElementById("stage")).width=window.innerWidth,e.height=window.innerHeight,t=e.getContext("2d"),g(80,80),l=w(),N(l.x,l.y);const n=[];for(let e=0;e<i.tiles[0].length;e++)for(let t=0;t<i.tiles.length;t++)i.tiles[t][e]===a.GRASS&&n.push([e,t]);let o=0;switch(!0){case n.length<10:o=3;break;case n.length<20:o=4;break;case n.length<25:o=5;break;case n.length>25:o=7}for(let e=0;e<o;e++){const[e,t]=y(n);r.push(E(e,t,h.WANDERING))}s=u})();let G=+new Date;const I=e=>{{window.requestAnimationFrame(I,e);let t=e-G;t<160&&b(),k(),G=e}};I(G);