function run(){if(ctx.clearRect(0,0,canvasW,canvasH),ctx.fillStyle="#000000",ctx.fillRect(0,0,canvasW,canvasH),ctx.font="8px Monospace",ctx.fillStyle="#FFF",ctx.fillText("Made by: Infernet89",5,600),drawPlayField(),0==level){for(ctx.drawImage(title,0,0,title.height,title.width),i=0;9>i;i++)fieldStatus[i]=rand(0,movePossibilities.length);ctx.font="40px Courier",ctx.fillStyle="#666666",ctx.fillRect(340,520,120,80),ctx.fillStyle="#0000FF",ctx.fillText("PLAY",350,570),ctx.fillRect(350,580,90,1),dragging&&mousex>340&&460>mousex&&mousey>520&&600>mousey&&(dragging=!1,level=1,startGame())}else{if(checkEndingCondition()&&isGameOn){if(isGameOn=!1,isCircleWinner==isCrossWinner){var e=fieldStatus;nDraw++,systemStability-=2,activeRules=rand(0,3),precalculateEverything(),fieldStatus=e}else 3>activeRules?isPlayer1Circle&&isCircleWinner?(nWins++,systemStability-=5):!isPlayer1Circle&&isCrossWinner?(nWins++,systemStability-=5):isPlayer1Circle&&isCrossWinner?(nLost++,systemStability+=10):!isPlayer1Circle&&isCircleWinner&&(nLost++,systemStability+=10):3==activeRules&&(isPlayer1Turn?(nLost++,systemStability+=10):(nWins++,systemStability-=5));systemStability>100&&(systemStability=100)}if(drawHud(),!endGame)if(isPlayer1Turn&&dragging){var t=translateCoordInFieldIndex(mousex,mousey);0>t||0!=fieldStatus[t]?3==activeRules&&mousex>130&&170>mousex&&mousey>520&&560>mousey&&(isPlayer1Circle=!isPlayer1Circle,dragging=!1):(fieldStatus[t]=isPlayer1Circle?2:1,2==activeRules&&(-1!=[1,4,3].indexOf(t)&&(fieldStatus[0]=flipMark(fieldStatus[0])),-1!=[0,3,4,5,2].indexOf(t)&&(fieldStatus[1]=flipMark(fieldStatus[1])),-1!=[1,4,5].indexOf(t)&&(fieldStatus[2]=flipMark(fieldStatus[2])),-1!=[0,1,4,7,6].indexOf(t)&&(fieldStatus[3]=flipMark(fieldStatus[3])),-1!=[0,1,2,3,5,6,7,8].indexOf(t)&&(fieldStatus[4]=flipMark(fieldStatus[4])),-1!=[2,1,4,7,8].indexOf(t)&&(fieldStatus[5]=flipMark(fieldStatus[5])),-1!=[3,4,7].indexOf(t)&&(fieldStatus[6]=flipMark(fieldStatus[6])),-1!=[6,3,4,5,8].indexOf(t)&&(fieldStatus[7]=flipMark(fieldStatus[7])),-1!=[7,4,5].indexOf(t)&&(fieldStatus[8]=flipMark(fieldStatus[8]))),dragging=!1,isPlayer1Turn=!1,isHumanTurn=!1)}else if(!isPlayer1Turn){if(--IAdelay>0)return void drawThinking();IAdelay=20,moveIA(),isPlayer1Turn=!0,isHumanTurn=!0}}}function flipMark(e){return 1==e?2:2==e?1:e}function checkEndingCondition(){if(endGame=!1,isCircleWinner=!1,isCrossWinner=!1,activeRules>3||(0!=fieldStatus[0]&&(fieldStatus[0]==fieldStatus[1]&&fieldStatus[0]==fieldStatus[2]||fieldStatus[0]==fieldStatus[3]&&fieldStatus[0]==fieldStatus[6]||fieldStatus[0]==fieldStatus[4]&&fieldStatus[0]==fieldStatus[8])&&(2==fieldStatus[0]?isCircleWinner=!0:1==fieldStatus[0]&&(isCrossWinner=!0),endGame=!0),0!=fieldStatus[8]&&(fieldStatus[8]==fieldStatus[5]&&fieldStatus[8]==fieldStatus[2]||fieldStatus[8]==fieldStatus[7]&&fieldStatus[8]==fieldStatus[6])&&(2==fieldStatus[8]?isCircleWinner=!0:1==fieldStatus[8]&&(isCrossWinner=!0),endGame=!0),0!=fieldStatus[4]&&(fieldStatus[4]==fieldStatus[1]&&fieldStatus[4]==fieldStatus[7]||fieldStatus[4]==fieldStatus[3]&&fieldStatus[4]==fieldStatus[5]||fieldStatus[4]==fieldStatus[6]&&fieldStatus[4]==fieldStatus[2])&&(2==fieldStatus[4]?isCircleWinner=!0:1==fieldStatus[4]&&(isCrossWinner=!0),endGame=!0),-1==fieldStatus.indexOf(0)&&(endGame=!0)),endGame&&1==activeRules){var e=isCircleWinner;isCircleWinner=isCrossWinner,isCrossWinner=e}return endGame&&3==activeRules&&(isHumanTurn?isPlayer1Winner=isCrossWinner||isCircleWinner:isEnemyWinner=isCrossWinner||isCircleWinner),isCircleWinner==isCrossWinner?(isPlayer1Winner=isCircleWinner,isEnemyWinner=isCrossWinner):isCircleWinner?(isPlayer1Winner=isPlayer1Circle,isEnemyWinner=!isPlayer1Circle):isCrossWinner&&(isPlayer1Winner=!isPlayer1Circle,isEnemyWinner=isPlayer1Circle),endGame}function drawHud(){ctx.fillStyle="#FFF",ctx.font="30px Verdana",ctx.fillText("RULES",50,280),ctx.font="14px Verdana";var e=0;for(i=0;i<rules[activeRules].length;i++)ctx.fillText(rules[activeRules][i],10,330+e),e+=20;ctx.font="30px Verdana",ctx.fillText("You are ",10,550),isPlayer1Circle?drawCircle(150,540,15,"#0F0"):drawCross(150,540,15,"#F00"),endGame?ctx.fillText("Game ended",320,50):isPlayer1Turn?ctx.fillText("Your turn",320,50):ctx.fillText("Enemy turn",320,50),ctx.font="35px Verdana",isPlayer1Winner&&isEnemyWinner?ctx.fillText("Draw!",350,180):isPlayer1Winner?ctx.fillText("You won!",320,180):isEnemyWinner?ctx.fillText("You lost!",320,180):endGame&&ctx.fillText("Draw!",350,180),ctx.font="13px Monospace",ctx.fillText("Wins: "+nWins,600,540),ctx.fillText("Lost: "+nLost,600,555),ctx.fillText("Draw: "+nDraw,600,570),ctx.fillText("System Stability: "+systemStability+"%",550,15),endGame&&(ctx.font="40px Courier",ctx.fillStyle="#666666",ctx.fillRect(330,520,160,80),ctx.fillStyle="#0000FF",ctx.fillText("REPLAY",340,570),ctx.fillRect(340,580,140,1),dragging&&mousex>330&&490>mousex&&mousey>520&&600>mousey&&(dragging=!1,level=1,startGame()))}function startGame(){isPlayer1Turn=flipCoin(),isHumanTurn=isPlayer1Turn,isPlayer1Circle=flipCoin(),fieldStatus=[0,0,0,0,0,0,0,0,0],isPlayer1Winner=!1,isEnemyWinner=!1,isCircleWinner=!1,isCrossWinner=!1,endGame=!1,isGameOn=!0}function flipCoin(){return rand(0,1)?!1:!0}function IntTofieldStatus(e){var i,t=movePossibilities.length,s=[];for(i=8;i>=0;i--)s[i]=e%t,e-=s[i],e/=t;return s}function fieldStatusToInt(e){var i=0,t=0,s=movePossibilities.length;for(t=0;t<e.length;t++)i*=s,i+=e[t];return i}function translateCoordInFieldIndex(){var e=-1;return mousex>250&&350>mousex?e=0:mousex>350&&450>mousex?e=1:mousex>450&&550>mousex&&(e=2),-1==e?-1:(mousey>200&&300>mousey?e=e:mousey>300&&400>mousey?e+=3:mousey>400&&500>mousey?e+=6:e=-1,e)}function drawPlayField(){ctx.beginPath(),ctx.moveTo(250,300),ctx.lineTo(550,300),ctx.moveTo(250,400),ctx.lineTo(550,400),ctx.moveTo(350,200),ctx.lineTo(350,500),ctx.moveTo(450,200),ctx.lineTo(450,500),ctx.closePath(),ctx.strokeStyle="#FFF",ctx.lineWidth=2,ctx.stroke();var e,i,t;for(i=300,t=250,e=0;9>e;e++)2==fieldStatus[e]?drawCircle(i,t,25,"#0F0"):4==fieldStatus[e]?drawCircle(i,t,25,"#F00"):1==fieldStatus[e]?drawCross(i,t,25,"#F00"):3==fieldStatus[e]&&drawCross(i,t,25,"#0F0"),i+=100,i>500&&(t+=100,i=300)}function drawCross(e,i,t,s){ctx.beginPath(),ctx.moveTo(e-t,i-t),ctx.lineTo(e+t,i+t),ctx.moveTo(e+t,i-t),ctx.lineTo(e-t,i+t),ctx.closePath(),ctx.strokeStyle=s,ctx.lineWidth=5,ctx.stroke()}function drawCircle(e,i,t,s){ctx.moveTo(e,i),ctx.beginPath(),ctx.arc(e,i,t,0,2*Math.PI,!1),ctx.closePath(),ctx.strokeStyle=s,ctx.lineWidth=5,ctx.stroke()}function precalculateEverything(){drawStatuses=[],circleWinnerStatuses=[],crossWinnerStatuses=[];var e,i=Math.pow(movePossibilities.length,9);for(e=0;i>e;e++)graphCross[e]=allMoves(e,1),graphCircle[e]=allMoves(e,2),fieldStatus=IntTofieldStatus(e),checkEndingCondition()&&(isCrossWinner==isCircleWinner?drawStatuses.push(e):isCrossWinner?crossWinnerStatuses.push(e):isCircleWinner&&circleWinnerStatuses.push(e))}function drawThinking(){var e;ctx.clearRect(0,0,100,100),ctx.font="15px Verdana",ctx.fillStyle="#000000",ctx.fillRect(0,0,200,200),e=IAdelay%3==0?"Thinking...":IAdelay%2==0?"Thinking..":"Thinking.",ctx.fillStyle="#FFF",ctx.fillText(e,10,20)}function moveIA(){var e=fieldStatusToInt(fieldStatus);if(rand(0,100)>systemStability){var i;return i=2>=activeRules&&isPlayer1Circle?graphCross[e][rand(0,graphCross[e].length-1)]:graphCircle[e][rand(0,graphCircle[e].length-1)],void(fieldStatus=IntTofieldStatus(i))}if(-1!=[0,13122,6561,4374,2187,1458,729,486,243,162,81,54,18,27,9,6,3,2,1].indexOf(e)&&3==activeRules)return 0==e&&(fieldStatus=IntTofieldStatus(81)),13122==e&&(fieldStatus=IntTofieldStatus(15309)),6561==e&&(fieldStatus=IntTofieldStatus(6588)),4374==e&&(fieldStatus=IntTofieldStatus(10935)),2187==e&&(fieldStatus=IntTofieldStatus(2196)),1458==e&&(fieldStatus=IntTofieldStatus(8019)),729==e&&(fieldStatus=IntTofieldStatus(972)),486==e&&(fieldStatus=IntTofieldStatus(7047)),243==e&&(fieldStatus=IntTofieldStatus(972)),162==e&&(fieldStatus=IntTofieldStatus(2349)),81==e&&(fieldStatus=IntTofieldStatus(4455)),54==e&&(fieldStatus=IntTofieldStatus(2241)),18==e&&(fieldStatus=IntTofieldStatus(6579)),27==e&&(fieldStatus=IntTofieldStatus(6588)),9==e&&(fieldStatus=IntTofieldStatus(2196)),6==e&&(fieldStatus=IntTofieldStatus(2193)),3==e&&(fieldStatus=IntTofieldStatus(6564)),2==e&&(fieldStatus=IntTofieldStatus(6563)),void(1==e&&(fieldStatus=IntTofieldStatus(2188)));var t,s,a=-99999999,n=0;if(2>=activeRules&&isPlayer1Circle)for(t=0;t<graphCross[e].length;t++)s=evalBestMove(graphCross[e][t],1,1),s>a?(a=s,n=graphCross[e][t]):s==a&&flipCoin()&&(n=graphCross[e][t]);else if(2<activeRules||isPlayer1Circle){if(3==activeRules){for(t=0;t<graphCross[e].length;t++)s=evalBestMove(graphCross[e][t],1,1),s>a?(a=s,n=graphCross[e][t]):s==a&&flipCoin()&&(n=graphCross[e][t]);for(t=0;t<graphCircle[e].length;t++)s=evalBestMove(graphCircle[e][t],1,1),s>a?(a=s,n=graphCircle[e][t]):s==a&&flipCoin()&&(n=graphCircle[e][t])}}else for(t=0;t<graphCircle[e].length;t++)s=evalBestMove(graphCircle[e][t],0,1),s>a?(a=s,n=graphCircle[e][t]):s==a&&flipCoin()&&(n=graphCircle[e][t]);0!=n&&(fieldStatus=IntTofieldStatus(n))}function evalBestMove(e,i,t){if(t+=1,-1!=drawStatuses.indexOf(e))return 0;if(3==activeRules&&(-1!=crossWinnerStatuses.indexOf(e)||-1!=circleWinnerStatuses.indexOf(e)))return 0==i?-2e3:1e3;if(isPlayer1Circle&&-1!=crossWinnerStatuses.indexOf(e))return 1e3;if(isPlayer1Circle||-1==crossWinnerStatuses.indexOf(e)){if(isPlayer1Circle||-1==circleWinnerStatuses.indexOf(e)){if(isPlayer1Circle&&-1!=circleWinnerStatuses.indexOf(e))return-2e3;var s,a,n=9999999,l=-99999999;if(3==activeRules){for(s=0;s<graphCross[e].length;s++)a=evalBestMove(graphCross[e][s],1-i,t),n>a&&(n=a),a>l&&(l=a);for(s=0;s<graphCircle[e].length;s++)a=evalBestMove(graphCircle[e][s],1-i,t),n>a&&(n=a),a>l&&(l=a)}else if(2<activeRules||0!=i){if(2>=activeRules&&1==i)for(s=0;s<graphCircle[e].length;s++)a=evalBestMove(graphCircle[e][s],0,t),n>a&&(n=a),a>l&&(l=a)}else for(s=0;s<graphCross[e].length;s++)a=evalBestMove(graphCross[e][s],1,t),n>a&&(n=a),a>l&&(l=a);return 3==activeRules?1==i?n/t:l/t:isPlayer1Circle&&1==i?n/t:isPlayer1Circle||0!=i?l/t:n/t}return 1e3}return-2e3}function allMoves(e,i){var t,s=[],a=IntTofieldStatus(e);if(3>=activeRules)for(t=0;9>t;t++)0==a[t]&&(a[t]=i,2==activeRules&&(-1!=[1,4,3].indexOf(t)&&(a[0]=flipMark(a[0])),-1!=[0,3,4,5,2].indexOf(t)&&(a[1]=flipMark(a[1])),-1!=[1,4,5].indexOf(t)&&(a[2]=flipMark(a[2])),-1!=[0,1,4,7,6].indexOf(t)&&(a[3]=flipMark(a[3])),-1!=[0,1,2,3,5,6,7,8].indexOf(t)&&(a[4]=flipMark(a[4])),-1!=[2,1,4,7,8].indexOf(t)&&(a[5]=flipMark(a[5])),-1!=[3,4,7].indexOf(t)&&(a[6]=flipMark(a[6])),-1!=[6,3,4,5,8].indexOf(t)&&(a[7]=flipMark(a[7])),-1!=[7,4,5].indexOf(t)&&(a[8]=flipMark(a[8]))),s.push(fieldStatusToInt(a)),2==activeRules&&(-1!=[1,4,3].indexOf(t)&&(a[0]=flipMark(a[0])),-1!=[0,3,4,5,2].indexOf(t)&&(a[1]=flipMark(a[1])),-1!=[1,4,5].indexOf(t)&&(a[2]=flipMark(a[2])),-1!=[0,1,4,7,6].indexOf(t)&&(a[3]=flipMark(a[3])),-1!=[0,1,2,3,5,6,7,8].indexOf(t)&&(a[4]=flipMark(a[4])),-1!=[2,1,4,7,8].indexOf(t)&&(a[5]=flipMark(a[5])),-1!=[3,4,7].indexOf(t)&&(a[6]=flipMark(a[6])),-1!=[6,3,4,5,8].indexOf(t)&&(a[7]=flipMark(a[7])),-1!=[7,4,5].indexOf(t)&&(a[8]=flipMark(a[8]))),a[t]=0);return s}function rand(e,i){return e>i?rand(i,e):(i+=1,Math.floor(Math.random()*(i-e)+e))}function mossoTap(e){e.preventDefault(),dragging=!0;canvas.getBoundingClientRect();mousex=e.targetTouches[0].pageX,mousey=e.targetTouches[0].pageY}function cliccatoTap(e){e.preventDefault();canvas.getBoundingClientRect();mousex=e.targetTouches[0].pageX,mousey=e.targetTouches[0].pageY}function rilasciatoTap(e){e.preventDefault(),dragging=!1,mousey=-100,mousex=-100}function cliccatoMouse(e){dragging=!0;var i=canvas.getBoundingClientRect();mousex=(e.clientX-i.left)/(i.right-i.left)*canvasW,mousey=(e.clientY-i.top)/(i.bottom-i.top)*canvasH}function mossoMouse(e){var i=canvas.getBoundingClientRect();mousex=(e.clientX-i.left)/(i.right-i.left)*canvasW,mousey=(e.clientY-i.top)/(i.bottom-i.top)*canvasH}function rilasciatoMouse(){dragging=!1}var DEBUG=0,TO_RADIANS=Math.PI/180,canvas,canvasW,canvasH,ctx,activeTask,level=0,fieldStatus=[0,0,0,0,0,0,0,0,0],player1Turn=!0,movePossibilities=["","rX","gO"],rules=[["The player who succeeds in","placing three of their marks","in a horizontal, vertical,","or diagonal row wins."],["The player who places","three of their marks","in a horizontal, vertical,","or diagonal row LOSE."],["The player who succeeds in","placing three of their marks","in a horizontal, vertical,","or diagonal row wins. BUT","whenever a mark is placed","all touching marks FLIPS."],["The player who succeeds in","placing three of their marks","in a horizontal, vertical,","or diagonal row wins. You","can choose wich mark play by","clicking on it."],["","",""]],activeRules=0,isPlayer1Circle=!0,isPlayer1Turn=!0,endGame=!1,isPlayer1Winner=!1,isEnemyWinner=!1,isCircleWinner=!1,isCrossWinner=!1,isHumanTurn=!1,circleWinnerStatuses=[],crossWinnerStatuses=[],drawStatuses=[],graphCross=[],graphCircle=[],IAdelay=50,nWins=0,nLost=0,nDraw=0,isGameOn=!1,systemStability=100,mousex=-100,mousey=-100,dragging=!1;canvas=document.getElementById("g"),ctx=canvas.getContext("2d"),canvasW=canvas.width=window.innerWidth,canvasH=canvas.height=window.innerHeight,window.navigator.pointerEnabled?(canvas.addEventListener("pointermove",mossoMouse,!1),canvas.addEventListener("pointerup",rilasciatoTap,!1)):(canvas.addEventListener("touchmove",mossoTap),canvas.addEventListener("touchstart",cliccatoTap),canvas.addEventListener("touchend",rilasciatoTap)),canvas.addEventListener("mousemove",mossoMouse),canvas.addEventListener("mousedown",cliccatoMouse),canvas.addEventListener("mouseup",rilasciatoMouse),activeTask=setInterval(run,33),precalculateEverything();var title=new Image;title.src="title.png",title.onload=function(){this.height=730,this.width=135};