window.performance&&window.performance.now?getTimestamp=function(){return window.performance.now()}:window.performance&&window.performance.webkitNow?getTimestamp=function(){return window.performance.webkitNow()}:getTimestamp=function(){return(new Date).getTime()};var t=new function(){var f=0,a=50,i=30,y=16,d=16,v=y*a,b=y*i,m=32,x=7,u=["#00aa00","#4444dd","#aaaa00","#aa00aa"],c=["#008800","#333388","#888800","#880088"],p=0,g=0,w=0,A=200,l=0,F=null,T=null,S=[],s=0,o=0,h=null,Y=null,R=null,n=null,X=null,k=null,E=null,D=[],M=[],V=[],W=[],C=0,q=0,J=0,B=0,O=0,L=0,I=0,P=0,j=[],N=[],G=1,r=function(e,t,a,i,n,r,l,s,o){this.actorType=2,this.x=e*y,this.y=t*d,this.sX=.04*n,this.sY=.04*r,this.type=a,this.direction=i,this.flash=0,this.flashEmitterOn=1,this.flashEmitterLastTime=0,this.flashEmitterOnTime=1e3,this.flashEmitterOffTime=1e3,this.points=[],this.angle=0,this.width=void 0!==l?l:y,this.height=void 0!==s?s:d,this.minY=void 0!==o?o:-1},U=function(e,t,a,i){this.x=e,this.y=t,this.type=a,this.orientation=i,this.state=0},z=function(){this.actorType=0,this.x=0,this.y=0,this.state=0,this.stateTimer=0,this.height=32,this.width=32,this.sX=0,this.maxSX=1,this.lastDirection=0,this.lastAction=0,this.lastActionTime=0,this.sY=0,this.maxSY=1,this.jumpStartY=0,this.baseFrame=0,this.frameCount=0,this.currentFrame=0,this.frameTime=0,this.actionTime=0,this.gravityForce=0,this.hFriction=.2,this.hForce=1,this.canTriggerAction=1,this.dashSx=0,this.dashSy=0,this.canDash=0,this.dashCounter=0,this.canWallRun=1,this.inWallRun=0,this.wallRunTime=0,this.inJump=0,this.canJump=1,this.tileLeft=0,this.tileRight=0,this.tileBelow=0,this.tileAbove=0,this.touchingExit=0},H=function(){!function(){for(var e=0;e<i;e++){j[e]=[];for(var t=0;t<a;t++)j[e][t]=0==e||0==t||29==e||49==t?1:0}M=[],V=[]}(),N=[],p=getTimestamp(),w=g=0,E.state=1,E.onEmitter=!1,E.inDash=0,E.inWallJump=0,E.canDash=1,E.sX=0,E.sY=0,E.canWallRun=1,E.inWallRun=0,E.wallRunTime=0,E.uhOhCounter=0,C=0,f>=K.length&&(f=0),K[f](),playSound(1)},K=[];K[0]=function(){s=45,o=21,E.x=32,E.y=270;for(var e=0;e<i;e++)for(var t=0;t<a;t++)22!=e&&12!=e||(j[e][t]=1),((t+3)%5||t<5||44<t)&&16==e&&(j[e][t]=1);M.push(new r(7,14,2,2,1,0)),M.push(new r(14,14,2,2,1,0)),M.push(new r(21,14,2,2,1,0)),M.push(new r(28,14,2,2,-1,0)),M.push(new r(35,14,2,2,-1,0)),M.push(new r(42,14,2,2,-1,0))};K[1]=function(){s=45,o=5,E.x=32,E.y=240;for(var e=0;e<i;e++)for(var t=0;t<a;t++)(44<t&&t<49&&18==e||6==e&&5<t&&Math.floor((t-3)/3)%3)&&(j[e][t]=x),(t<13||36<t)&&t<42&&13==e&&(j[e][t]=1),((Math.floor((t+7)/3)%5||t<8||41<t)&&22==e||15==e&&t%2&&12<t&&t<37||6==e&&38<t)&&(j[e][t]=1);M.push(new r(1,23,2,0,0,0)),M.push(new r(48,23,2,4,0,0)),M.push(new r(23,13,2,2,1,0,4*y)),M.push(new r(12,14,2,0,0,0)),M.push(new r(37,14,2,4,0,0))},K[2]=function(){s=45,o=6,E.x=32,E.y=290;for(var e=0;e<i;e++)for(var t=0;t<a;t++)(22==e&&(t<12||19<t&&t<30||37<t)||18==e&&t<44&&(t<18||31<t)||11==e&&5<t||7==e&&1<t&&(t<11||31<t))&&(j[e][t]=1);M.push(new r(1,7,2,2,0,0)),M.push(new r(12,22,2,0,0,0)),M.push(new r(19,22,2,4,0,0)),M.push(new r(18,18,2,0,0,0)),M.push(new r(31,18,2,4,0,0)),M.push(new r(30,22,2,0,0,0)),M.push(new r(37,22,2,4,0,0)),M.push(new r(24,7,2,0,0,0,2)),M.push(new r(18,7,2,4,0,0,2))},K[3]=function(){C=0,s=45,o=6,E.x=32,E.y=410;for(var e=0;e<i;e++)for(var t=0;t<a;t++)(25==e&&30<t&&t<35||20==e&&20<t&&t<25||15==e&&10<t&&t<15||11==e&&21==t)&&(j[e][t]=3),(10==e&&20<t&&t<27||10==e&&36<t&&t<41)&&(j[e][t]=4),(7==e&&42<t&&t<49||21==e&&t<44&&36<t||16==e&&28<t&&t<34)&&(j[e][t]=6),20==e&&43<t&&t<49&&(j[e][t]=5),10==e&&0<t&&t<5&&(j[e][t]=1);V.push(new U(9,28,3,0)),V.push(new U(2,9,4,0)),V.push(new U(38,9,5,0)),V.push(new U(45,19,6,0)),M.push(new r(43,14,2,6,0,0)),M.push(new r(43,18,2,2,0,0)),M.push(new r(30,25,2,4,0,0)),M.push(new r(20,20,2,4,0,0)),M.push(new r(10,15,2,4,0,0)),M.push(new r(26,11,2,4,0,0))},K[4]=function(){C=4,s=45,o=6,E.x=32,E.y=390;for(var e=0;e<i;e++)for(var t=0;t<a;t++)(21==e&&t<43||42==t&&21<e&&e<25||12==t&&21<e&&e<25||44<t&&t<47&&17==e)&&(j[e][t]=1),(24==e&&t<42&&12<t||46<t&&17==e&&t<49)&&(j[e][t]=3),(14==e&&5<t&&t<49||6==t&&11<e&&e<15)&&(j[e][t]=4),(14==e&&5<t&&Math.floor((t-1)/6)%2||42==t&&11<e&&e<16)&&(j[e][t]=1),(7==e&&42<t&&t<49||6==e&&36==t)&&(j[e][t]=6),5==e&&0<t&&t<40&&(j[e][t]=5);V.push(new U(9,28,3,0)),V.push(new U(45,28,3,0)),V.push(new U(9,20,4,0)),V.push(new U(45,13,5,0)),V.push(new U(3,4,6,0)),M.push(new r(15,22,2,2,1,0)),M.push(new r(40,22,2,2,-1,0)),M.push(new r(15,12,2,2,2,0)),M.push(new r(28,12,2,2,-2,0)),M.push(new r(20,12,2,0,-2,0)),M.push(new r(31,12,2,4,-2,0)),M.push(new r(40,12,2,2,-2,0)),M.push(new r(43,15,2,2,-2,0)),M.push(new r(40,6,2,4,0,0))},K[5]=function(){E.x=32,E.y=390,C=6,s=45,o=28;for(var e=0;e<i;e++)for(var t=0;t<a;t++)(23==e&&(t<22||27<t)||18==e&&3<t&&t<43||43==t&&3<e&&e<14||37==t&&5<e&&e<15&&13!=e||31==t&&3<e&&e<18&&6!=e||25==t&&0<e&&e<15&&13!=e)&&(j[e][t]=1),41==t&&23<e&&e<29&&(j[e][t]=6),(0<t&&t<25&&1==e||1==t&&1<e&&e<14||24==t&&1<e&&e<14)&&(j[e][t]=2),14==e&&0<t&&t<25&&(j[e][t]=6),18==e&&0<t&&t<4&&(j[e][t]=6);V.push(new U(24,17,3,0)),M.push(new r(22,23,2,0,0,0)),M[M.length-1].flash=1,M.push(new r(27,23,2,0,0,0)),M[M.length-1].flash=1,M.push(new r(43,18,2,6,0,0)),M.push(new r(37,5,2,6,0,0)),M.push(new r(31,6,2,0,0,0)),M[M.length-1].flash=1,M.push(new r(37,13,2,4,0,0)),M[M.length-1].flash=1,M.push(new r(25,13,2,0,0,0)),M[M.length-1].flash=1,M.push(new r(12,8,1,1.5,0,0)),M[M.length-1].flash=1},K[6]=function(){E.x=32,E.y=390,s=45,o=6;for(var e=C=0;e<i;e++)for(var t=0;t<a;t++)(11==e&&t<11||e<12&&11==t||7==e&&42<t||27==e&&t<5)&&(j[e][t]=1),(8==e&&40<t&&t<49||18==e&&0<t&&t<5||36<t&&t<43&&21==e)&&(j[e][t]=6),(8<t&&t<15&&22==e||36<t&&t<43&&25==e||36<t&&t<43&&9==e)&&(j[e][t]=3),(8<t&&t<15&&18==e||18==t&&5==e||36<t&&t<43&&17==e)&&(j[e][t]=5),(20<t&&t<29&&23==e||36<t&&t<43&&13==e||31==t&&5==e)&&(j[e][t]=4);V.push(new U(5,10,3,0)),V.push(new U(10,5,4,2)),V.push(new U(5,1,5,3)),V.push(new U(1,5,6,1)),M.push(new r(5.5,5.5,1,12,0,0)),M.push(new r(1,29,2,0,0,0)),M.push(new r(18,1,2,2,0,0)),M.push(new r(31,1,2,2,0,0))},K[7]=function(){C=6,E.x=32,E.y=390,s=4,o=22;for(var e=0;e<i;e++)for(var t=0;t<a;t++)(23==e&&t%2&&t<47||12==e&&!((t+1)%3))&&0<t&&t<49&&(j[e][t]=2),23==e&&t<10&&(j[e][t]=1),(0<t&&t<10&&24==e||9==t&&13<e&&24<e&&e<29)&&(j[e][t]=6);V.push(new U(6,28,3,0)),M.push(new r(5,4,2,3,1,0)),M.push(new r(28,6,2,1,-1,0)),M.push(new r(10,8,2,1,-1,0)),M.push(new r(18,10,2,3,1,0))},K[8]=function(){C=6,E.x=32,E.y=390,s=45,o=5;for(var e=0;e<i;e++)for(var t=0;t<a;t++)6==e&&42<t&&(j[e][t]=1),(21==e&&30<t&&t<49||14==e&&8<t&&t<24||7==e&&30<t&&t<49)&&(j[e][t]=x);M.push(new r(1,8,2,0,0,0)),M[M.length-1].flash=1,M[M.length-1].flashEmitterOnTime=400,M[M.length-1].flashEmitterOffTime=400,M.push(new r(49,15,2,4,0,0)),M[M.length-1].flash=1,M[M.length-1].flashEmitterOnTime=800,M[M.length-1].flashEmitterOffTime=800,M.push(new r(1,22,2,0,0,0)),M[M.length-1].flash=1,M[M.length-1].flashEmitterOnTime=1e3,M[M.length-1].flashEmitterOffTime=1e3,M.push(new r(42,1,2,2,0,0)),M[M.length-1].flash=1,M[M.length-1].flashEmitterOnTime=300,M[M.length-1].flashEmitterOffTime=300},K[9]=function(){C=6,E.x=32,E.y=390,s=45,o=5;for(var e=0;e<i;e++)for(var t=0;t<a;t++)6==e&&42<t&&(j[e][t]=1),6==e&&0<t&&t<5&&(j[e][t]=3),(8==e&&22<t&&t<49||22==e&&22<t&&t<49||9==t&&0<e&&e<20)&&(j[e][t]=2),(35<t&&20==e&&t<49||9<t&&t<14&&15==e)&&(j[e][t]=5),(0<t&&t<10&&24==e||9==t&&13<e&&24<e&&e<29||9<t&&t<23&&8==e)&&(j[e][t]=6);V.push(new U(6,28,3,0)),V.push(new U(46,21,6,0)),V.push(new U(2,5,5,0)),V.push(new U(45,28,4,0)),M.push(new r(24,15,1,-1,0,0)),M[M.length-1].flash=1,M[M.length-1].flashEmitterOnTime=400,M[M.length-1].flashEmitterOffTime=400,M.push(new r(15,5,1,1,0,0)),M[M.length-1].flash=1,M[M.length-1].flashEmitterOnTime=400,M[M.length-1].flashEmitterOffTime=400},K[10]=function(){C=4,s=45,o=5;for(var e=0;e<i;e++)for(var t=0;t<a;t++)6==e&&42<t&&(j[e][t]=1);E.x=32,E.y=390,M.push(new r(5,28,2,2,1,1,3*y,d,80)),M.push(new r(9,28,2,2,-1,1,3*y,d,80))};var Q=function(e){switch(null==k&&initSound(),e.keyCode){case 37:J=1,e.preventDefault();break;case 39:B=1,e.preventDefault();break;case 38:O=1,e.preventDefault();break;case 40:L=1,e.preventDefault();break;case 90:case 67:I=1,e.preventDefault();break;case 88:P=1,e.preventDefault()}},Z=function(e){switch(e.keyCode){case 37:J=0;break;case 39:B=0;break;case 38:O=0;break;case 40:L=0;break;case 90:case 67:I=0;break;case 88:P=0}},$=function(e,t){if(0==E.state){if(E.stateTimer+=t,!(500<E.stateTimer))return;H()}if(2==E.state){if(E.stateTimer+=t,!(600<E.stateTimer))return;f++,H()}var a=4*y+y/2,i=E.baseFrame+E.currentFrame;i<S.length&&(E.bounds=S[i],ee(E,!0),ee(E,!0));var n=0,r=0;if(E.onEmitter=!1,50<=E.tileBelow&&E.tileBelow<100){var l=E.tileBelow-50;if((E.onEmitter=l)<M.length){var s=M[l];E.y>s.y-m+E.bounds[1]&&(E.y=s.y-m+E.bounds[1]),n=s.sX,0<s.sY&&(r=s.sY)}}E.maxSX=.28;var o=E.lastAction;if(L&&E.touchingExit)return playSound(10),E.state=2,void(E.stateTimer=0);E.inDash||E.inWallJump||(E.tileBelow?(0<E.sY&&(E.sY=0),E.hFriction=.005,E.hForce=.003,E.canDash=1,E.dashCounter=0,E.canWallRun=1,E.wallRunTime=0,E.inWallJump=0):(E.gravityForce=.0025,E.maxSY=.3,9==E.lastAction?0<=E.lastDirection?E.baseFrame=3:E.baseFrame=14:(0<=E.lastDirection?E.baseFrame=5:E.baseFrame=16,o=10),E.frameCount=1,0<E.sY&&(E.tileLeft?(o=8,E.baseFrame=17,E.frameCount=1,E.gravityForce=.001,E.maxSY=.2):E.tileRight&&(o=7,E.baseFrame=6,E.frameCount=1,E.gravityForce=.001,E.maxSY=.2)),E.sY+=E.gravityForce*t,E.sY>E.maxSY&&(E.sY=E.maxSY),E.hFriction=.001,E.hForce=.0027)),E.tileBelow&&(E.wallRunTime=0,E.inWallJump=0,E.canWallRun=1),J||B||E.inDash||E.inWallJump||(E.tileBelow||(5==E.lastAction&&(E.x+=2),6==E.lastAction&&(E.x-=2)),0<E.sX&&(E.sX-=E.hFriction*t,E.sX<0&&(E.sX=0)),E.sX<0&&(E.sX+=E.hFriction*t,0<E.sX&&(E.sX=0)),E.tileBelow&&(o=1,0<=E.lastDirection?1!=E.baseFrame&&(E.baseFrame=0,E.frameCount=1):12!=E.baseFrame&&(E.baseFrame=11,E.frameCount=1))),P?E.canTriggerAction&&(E.canTriggerAction=0,E.canDash&&(playSound(4),E.canDash=0,E.inDash=1,W=[],E.dashSy=0,E.dashSx=0,E.frameCount=1,O?(E.tileAbove||(E.sY=-.9,E.baseFrame=21),J&&(E.sX=-.9,E.baseFrame=20),B&&(E.sX=.9,E.baseFrame=9)):J?(E.sX=-.9,E.sY=0,E.baseFrame=19):B?(E.sX=.9,E.sY=0,E.baseFrame=8):E.lastDirection<0?(E.sX=-.9,E.sY=0,E.baseFrame=19):(E.sX=.9,E.sY=0,E.baseFrame=8),E.dashStartX=E.x,E.dashStartY=E.y,console.log("action key!"))):E.canTriggerAction=!0,!J||E.inDash||E.inWallJump||(!E.tileBelow&&E.tileLeft?E.sY<0&&E.canWallRun?(E.sY=-.3*(600-E.wallRunTime)/600,E.inWallRun=1,o=6,E.baseFrame=35,E.frameCount=3):(o=8,E.baseFrame=17,E.frameCount=1,E.inWallRun=0):(E.sX-=E.hForce*t,E.sX<-E.maxSX&&(E.sX=-E.maxSX),E.tileBelow&&(o=4,E.baseFrame=13,E.frameCount=3))),!B||E.inDash||E.inWallJump||(!E.tileBelow&&E.tileRight?E.sY<0&&E.canWallRun?(E.sY=-.3*(600-E.wallRunTime)/600,E.inWallRun=1,o=5,E.baseFrame=24,E.frameCount=3):(o=7,E.baseFrame=6,E.frameCount=1,E.inWallRun=0):(E.sX+=E.hForce*t,E.sX>E.maxSX&&(E.sX=E.maxSX),E.tileBelow&&(o=3,E.baseFrame=2,E.frameCount=3))),E.inWallJump||E.inDash||(I?E.tileAbove?E.inJump&&(E.inJump=!1,o=10):E.inJump?(E.sY=-.35,E.y+E.sY*t<E.jumpStartY-88&&(E.sY=0,E.y=E.jumpStartY-88,E.inJump=!1),o=9,0<=E.lastDirection?E.baseFrame=3:E.baseFrame=14,E.frameCount=1):E.canJump&&(E.tileBelow?(playSound(3),E.inJump=1,E.canJump=0,E.sY=-.35,E.jumpStartY=E.y,o=-9,0<=E.lastDirection?E.baseFrame=3:E.baseFrame=14,E.frameCount=1):E.tileRight?(playSound(3),E.inJump=1,E.inWallJump=1,E.canJump=0,E.sY=-.35,E.sX=-.38,E.jumpStartY=E.y,E.dashStartX=E.x,E.dashStartY=E.y,E.baseFrame=14,E.frameCount=1):E.tileLeft&&(console.log("wall jump!"),E.inJump=1,playSound(3),E.inWallJump=1,E.canJump=0,E.sY=-.35,E.sX=.38,E.jumpStartY=E.y,E.dashStartX=E.x,E.dashStartY=E.y,E.baseFrame=3,E.frameCount=1)):(E.inJump=0,E.canJump=1)),E.tileBelow||E.inDash||E.inWallJump||(9==E.lastAction||9==o?0<E.sX?(E.baseFrame=3,E.frameCount=1):E.sX<0&&(E.baseFrame=14,E.frameCount=1):0<E.sX?(E.baseFrame=5,E.frameCount=1):E.sX<0&&(E.baseFrame=16,E.frameCount=1)),0!=E.sX&&(E.lastDirection=E.sX),(E.tileLeft&&E.sX<0||E.tileRight&&0<E.sX)&&(E.sX=0,E.inDash=0,E.inWallJump=0),E.tileAbove&&E.sY<0&&(E.sY=0,E.inDash=0,E.inWallJump=0),E.x+=(E.sX+n)*t,E.y+=(E.sY+r)*t,E.inWallRun&&(E.wallRunTime+=t,600<E.wallRunTime&&(E.canWallRun=!1));var h=128;E.inWallJump&&(h=a),(E.inDash||E.inWallJump)&&(W.push([E.x,E.y]),E.dashStartX>E.x&&h<E.dashStartX-E.x&&(E.inDash=0,E.inWallJump=0,E.x=E.dashStartX-h,E.sX<0&&(E.sX=-E.maxSX)),E.dashStartX<E.x&&h<E.x-E.dashStartX&&(E.inDash=0,E.inWallJump=0,E.x=E.dashStartX+h,0<E.sX&&(E.sX=E.maxSX)),E.dashStartY>E.y&&h<E.dashStartY-E.y&&(E.inDash=0,E.inWallJump=0,E.y=E.dashStartY-h,E.sY<0&&(E.sY=-E.maxSY)),E.dashStartY<E.y&&h<E.y-E.dashStartY&&(E.inDash=0,E.inWallJump=0,E.y=E.dashStartX+h,0<E.sY&&(E.sY=E.maxSY))),o!=E.lastAction?(E.frameTime=0,E.currentFrame=0,E.lastAction=o,E.lastActionTime=e):(E.lastActionTime,1==o&&(3e3<e-E.lastActionTime&&(11==E.baseFrame?.3<Math.random()&&(E.baseFrame=12):0==E.baseFrame&&.3<Math.random()&&(E.baseFrame=1),E.lastActionTime=e),280<e-E.lastActionTime&&(12==E.baseFrame?(E.lastActionTime=e,E.baseFrame=11):1==E.baseFrame&&(E.lastActionTime=e,E.baseFrame=0)))),E.frameTime+=t,25<E.frameTime&&(E.frameTime=0,E.currentFrame++,E.currentFrame>=E.frameCount&&(E.currentFrame=0)),(i=E.baseFrame+E.currentFrame)<S.length&&(E.bounds=S[i],ee(E,!1),ee(E,!1)),E.tileAbove&&E.tileBelow&&(E.tileLeft||E.tileRight)?(E.uhOhCounter++,10<E.uhOhCounter&&(E.state=0,E.stateTimer=0,playSound(2))):E.uhOhCounter=0},_=(x=7,function(e,t){for(var a=0;a<N.length;a++)if(N[a][0]===e&&N[a][1]==t)return;var i=getTimestamp();N.push([e,t,i]),j[t][e]=8}),ee=function(e){var t=e.bounds,a=Math.floor(e.x)+t[0],i=Math.floor(e.x)+t[2],n=Math.floor(e.y)+t[1],r=Math.floor(e.y)+t[3];e.tileAbove=0,e.tileBelow=0,e.tileLeft=0;var l,s=e.tileRight=0,o=0;if((o=n-1)<0)e.tileAbove=1;else for(s=a+1;s<i;s++)if(0<(f=F[o*v+s])&&(f<10||50<=f&&f<A&&2!=e.actorType)){e.tileAbove=f;break}if(e.tileAbove){var h=!1;for(o=n;o<r;o++){for(s=a+1;s<i;s++){var f;if(h=!0,0<(f=F[o*v+s])&&(f<10||50<=f&&f<A&&2!=e.actorType)){h=!1;break}}if(h){e.y+t[1]<o&&(e.y=o-t[1]);break}}}if(b<=(o=r+1))e.tileBelow=1;else for(s=a+1;s<i;s++)if(0<(g=F[o*v+s])&&(g<30||50<=g&&g<A&&2!=e.actorType)){if((e.tileBelow=g)==x){var m=Math.floor(s/y),u=Math.floor(o/d);!1===m&&!1===u||_(m,u)}if(10<e.tileBelow&&e.tileBelow<30){var c=Math.floor(s/y),p=Math.floor(o/d);0<c&&c<49&&0<p&&p<29&&(0<F[(p+1)*d*v+c*y]?C!=e.tileBelow-10&&(l=e.tileBelow-10,C!=l&&(C=l,playSound(C-3+6))):e.tileBelow=0)}}if(e.tileBelow)for(h=!1,o=r;n<o;o--){for(s=a+1;s<i;s++){var g;if(h=!0,0<(g=F[o*v+s])&&(g<30||50<=g&&g<A&&2!=e.actorType)){h=!1;break}}if(h){e.y+t[3]>o&&(e.y=o-t[3]);break}}if(n=Math.floor(e.y)+t[1],r=Math.floor(e.y)+t[3],(s=a-1)<0)e.tileLeft=1;else for(o=n+1;o<r;o++)if(0<(w=F[o*v+s])&&(w<10||50<=w&&w<A&&2!=e.actorType)){e.tileLeft=w;break}if(e.tileLeft)for(h=!1,s=a;s<i;s++){for(o=n+1;o<r;o++){var w;if(h=!0,0<(w=F[o*v+s])&&(w<10||50<=w&&w<A&&2!=e.actorType)){h=!1;break}}if(h){e.x+t[0]<s&&(e.x=s-t[0]);break}}if(v<=(s=i+1))e.tileRight=1;else for(o=n+1;o<r;o++)if(0<(T=F[o*v+s])&&(T<10||50<=T&&T<A&&2!=e.actorType)){e.tileRight=T;break}if(e.tileRight)for(h=!1,s=i;a<s;s--){for(o=n+1;o<r;o++){var T;if(h=!0,0<(T=F[o*v+s])&&(T<10||50<=T&&T<A&&2!=e.actorType)){h=!1;break}}if(h){e.x+t[2]>s&&(e.x=s-t[2]);break}}},te=function(e,t,a,i,n,r){for(var l=0;l<m;l++)for(var s=0,o=0;o<m;o++){var h=4*(t+o+e.width*(a+l));1==r&&(s=i+m-1-o+e.width*(n+l)),2==r&&(s=i+o+e.width*(n+m-1-l)),3==r&&(s=i+l+e.width*(n+m-1-o)),s*=4;for(var f=0;f<4;f++)e.data[s+f]=e.data[h+f]}},ae=function(e,t,a){for(var i=m,n=0,r=m,l=0,s=0;s<m;s++)for(var o=0;o<m;o++){var h=4*(t+o+e.width*(a+s));0<e.data[h+3]&&(n<o&&(n=o),l<s&&(l=s),o<i&&(i=o),s<r&&(r=s))}return[i,r,n,l]};midiToFreq=function(e){return 440*Math.pow(2,(e-69)/12)};var ie=[],ne=0,re=[];createPinkNoise=function(){var e,t,a,i,n,r,l;e=t=a=i=n=r=l=0;for(var s=0;s<ne;s++){var o=2*Math.random()-1;e=.99886*e+.0555179*o,t=.99332*t+.0750759*o,a=.969*a+.153852*o,i=.8665*i+.3104856*o,n=.55*n+.5329522*o,r=-.7616*r-.016898*o,re[s]=e+t+a+i+n+r+l+.5362*o,re[s]*=.11,l=.115926*o}};createNoiseBuffer=function(){for(var e=2*k.sampleRate,t=(ie=k.createBuffer(1,e,k.sampleRate)).getChannelData(0),a=0;a<e;a++)t[a]=2*Math.random()-1},initSound=function(){k=new AudioContext,ne=20*k.sampleRate,createPinkNoise(),createNoiseBuffer()},playSound=function(e){if(null!=k){var t=k.currentTime,a=1/16,i=a,n=k.createGain(),r=null,l=null;switch(4!=e?((r=k.createOscillator()).type="square",r.connect(n)):(r=k.createBufferSource(),(l=k.createBiquadFilter()).connect(n),r.connect(l)),n.connect(k.destination),e){case 1:a=1/16,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(55),t),r.frequency.setValueAtTime(midiToFreq(59),t+a),r.frequency.setValueAtTime(midiToFreq(62),t+2*a),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.3,k.currentTime+1/64),n.gain.linearRampToValueAtTime(0,k.currentTime+3*a),i=4*a;break;case 2:a=1/12,r.type="sawtooth",r.frequency.setValueAtTime(midiToFreq(56),t),r.frequency.linearRampToValueAtTime(midiToFreq(49),t+a),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.03,k.currentTime+a),n.gain.linearRampToValueAtTime(0,k.currentTime+2*a),i=2*a;break;case 3:a=1/12,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(55),t),r.frequency.setValueAtTime(midiToFreq(62),t+a),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.2,k.currentTime+1/64),n.gain.linearRampToValueAtTime(0,k.currentTime+2*a),i=2*a;break;case 4:r.buffer=ie,l.type="lowpass",l.frequency.setValueAtTime(440,t),l.frequency.linearRampToValueAtTime(440,t+2*a),n.gain.linearRampToValueAtTime(1,k.currentTime+1/64),n.gain.linearRampToValueAtTime(0,k.currentTime+2*a),i=2*a;break;case 5:break;case 6:a=.25,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(43),t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.2,k.currentTime+1/32),n.gain.linearRampToValueAtTime(0,k.currentTime+a),i=a;break;case 7:a=.25,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(47),t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.2,k.currentTime+1/32),n.gain.linearRampToValueAtTime(0,k.currentTime+a),i=a;break;case 8:a=.25,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(50),t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.2,k.currentTime+1/32),n.gain.linearRampToValueAtTime(0,k.currentTime+a),i=a;break;case 9:a=.25,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(54),t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.2,k.currentTime+1/32),n.gain.linearRampToValueAtTime(0,k.currentTime+a),i=a;break;case 10:a=1/12,r.type="triangle",r.frequency.setValueAtTime(midiToFreq(55),t),r.frequency.setValueAtTime(midiToFreq(62),t+a),r.frequency.setValueAtTime(midiToFreq(67),t+2*a),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.3,k.currentTime+1/64),n.gain.linearRampToValueAtTime(0,k.currentTime+6*a),i=6*a}r.start(k.currentTime),r.stop(k.currentTime+i)}},this.init=function(){var e=document;e.onkeydown=Q,e.onkeyup=Z,h=e.getElementById("screen"),G=1,h.style.width=v+"px",h.style.height=b+"px",h.width=v*G,h.height=b*G,Y=h.getContext("2d"),F=new Uint8Array(v*b),X=e.createElement("canvas"),function(){X.height=d,X.width=40*y;for(var e=X.getContext("2d"),t=0;t<d;t++)for(var a=0;a<y;a++){var i=x*y+a;e.fillStyle="#aaaaaa",(Math.floor(a/2)+Math.floor(t/2))%2&&e.fillRect(i,t,1,1),i=8*y+a,(Math.floor(a/4)+Math.floor(t/4))%2&&e.fillRect(i,t,1,1)}for(var n=0;n<u.length;n++){var r=n+3;e.fillStyle=u[n],e.fillRect(r*y,0,y,d),e.beginPath(),e.lineWidth=1,e.setLineDash([2,2]),e.strokeStyle=c[n],e.rect(r*y+.5,.5,y-1,15),e.stroke(),r=n+3+20,e.beginPath(),e.lineWidth=1,e.setLineDash([2,2]),e.strokeStyle=c[n],e.rect(r*y+.5,.5,y-1,15),e.stroke()}e.setLineDash([])}(),(R=e.createElement("canvas")).width=3200,R.height=100,n=R.getContext("2d");var t=new Image;t.onload=function(){n.drawImage(t,0,0),function(){T=n.getImageData(0,0,R.width,R.height);var e=11,t=e*m,a=0;for(a=0;a<11;a++)te(T,a*m,0,t,0,1),t+=m,e++;for(a=0;a<11;a++)te(T,a*m,0,t,0,3),t+=m,e++;for(a=0;a<11;a++)te(T,a*m+704,0,t,0,1),t+=m,e++;for(a=0;a<22;a++)te(T,a*m,0,t,0,2),t+=m,e++;for(a=0;a<e;a++)S[a]=ae(T,a*m,0);for(a=0;a<T.data.length;a+=4)0==T.data[a]&&0==T.data[a+1]&&0==T.data[a+2]&&(T.data[a+3]=0);n.putImageData(T,0,0)}(),q=getTimestamp(),f=0,l=1,(E=new z).actorType=1,D.push(E),H()},t.src="sprites.png"};var le=function(e){for(var t=0;t<M.length;t++){var a=M[t];if(1==a.type?a.angle+=e*a.direction/6e3:2==a.type&&(a.angle=Math.PI/4*a.direction),a.bounds=[0,0,a.width,a.height],0!=a.sX||0!=a.sY){a.x+=a.sX*e,a.y+=a.sY*e;var i=a.x,n=a.y;if(ee(a),0==a.sX&&(a.x=i),0==a.sY&&(a.y=n),a.y<a.minY)a.sY=-a.sY;else if(0<a.sX&&0<a.tileRight&&a.tileRight<20||a.sX<0&&0<a.tileLeft&&a.tileLeft<20)a.sX=-a.sX;else if(0<a.sY&&0<a.tileBelow&&a.tileBelow<20||a.sY<0&&0<a.tileAbove&&a.tileAbove<20)a.sY=-a.sY;else for(var r=0;r<M.length;r++)t!=r&&(0<a.sX?a.x+a.width>=M[r].x&&a.x<M[r].x&&(a.y>=M[r].y&&a.y<=M[r].y+M[r].height||a.y+a.height>=M[r].y&&a.y+a.height<=M[r].y+M[r].height)&&(a.sX=-a.sX):a.sX<0&&a.x<=M[r].x+M[r].width&&a.x+a.width>M[r].x+M[r].width&&(a.y>=M[r].y&&a.y<=M[r].y+M[r].height||a.y+a.height>=M[r].y&&a.y+a.height<=M[r].y+M[r].height)&&(a.sX=-a.sX),0<a.sY?a.y+a.height>=M[r].y&&a.y<M[r].y&&(a.x>=M[r].x&&a.x<=M[r].x+M[r].width||a.x+a.width>=M[r].x&&a.x+a.width<=M[r].x+M[r].width)&&(a.sY=-a.sY):a.sY<0&&a.y<=M[r].y+M[r].height&&a.y+a.height>M[r].y+M[r].height&&(a.x>=M[r].x&&a.x<=M[r].x+M[r].width||a.x+a.width>=M[r].x&&a.x+a.width<=M[r].x+M[r].width)&&(a.sY=-a.sY))}if(a.y<d&&(a.y=18),a.y+a.height>b-d&&(a.y=b-d-a.height),a.x<y&&(a.x=y=2),a.x+a.width>v-y&&(a.x=v-y-a.width),a.points=[],1e3!=C){var l=a.x+a.width/2,s=a.y+a.height/2;a.points.push([l,s]);for(var o=a.angle,h=se(l,s,o,a),f=0;!1!==h&&(a.points.push(h),2==h[2]?(o=h[3]?-o:-o+Math.PI,h=se(h[0],h[1],o,a)):h=!1,!(30<++f)););}}},se=function(e,t,a,i){for(var n=Math.cos(a),r=Math.sin(a),l=e+y*n*1.5,s=t+y*r*1.5,o=l,h=s,f=0;f<1e3;){if(l=Math.floor(e+n*f+y*n),s=Math.floor(t+r*f+y*r),l<0||v<=l||s<0||b<=s)return[l,s,1,0,0];var m=F[s*v+l];if(10<m&&m<20&&(C=m-10),0<m&&(m<10||50<=m&&m<A)){var u=0,c=0;return 0<n&&0<l&&2==F[s*v+l-1]&&(u=1),n<0&&l<v-1&&2==F[s*v+l+1]&&(u=1),0<r&&0<s&&2==F[(s-1)*v+l]&&(c=1),r<0&&s<b-1&&2==F[(s+1)*v+l]&&(c=1),[o,h,m,u,c]}o=l,h=s,i.flash&&!i.flashEmitterOn||(F[s*v+l]=A),f++}},oe=function(){Y.lineWidth=2,Y.strokeStyle="#ff0000",Y.beginPath();for(var e=!1,t=0;t<M.length;t++)if((i=M[t]).flash&&(e=!0),(i.flashEmitterOn||!i.flash)&&0<i.points.length){Y.moveTo(i.points[0][0],i.points[0][1]);for(var a=1;a<i.points.length;a++)Y.lineTo(i.points[a][0],i.points[a][1])}if(Y.stroke(),e){for(Y.lineWidth=2,Y.setLineDash([4,4]),Y.strokeStyle="#777777",Y.beginPath(),t=0;t<M.length;t++){var i;if(!(i=M[t]).flashEmitterOn&&i.flash&&0<i.points.length)for(Y.moveTo(i.points[0][0],i.points[0][1]),a=1;a<i.points.length;a++)Y.lineTo(i.points[a][0],i.points[a][1])}Y.stroke(),Y.setLineDash([])}},he=function(e){for(var t=0;t<j.length;t++)for(var a=0;a<j[0].length;a++){var i=j[t][a],n=1;if(e||(1==i&&(Y.fillStyle="#0c0c0c",Y.fillRect(a*y,t*d,y,d)),2==i&&(Y.fillStyle="#aaaaaa",Y.fillRect(a*y,t*d,y,d)),i==x&&Y.drawImage(X,x*y,0,y,d,a*y,t*d,y,d),8==i&&Y.drawImage(X,8*y,0,y,d,a*y,t*d,y,d)),3<=i&&i<=6&&C!=i&&(n=0),e||3<=i&&i<=6&&(C==i?(Y.fillStyle=u[i-3],Y.fillRect(a*y,t*d,y,d)):Y.drawImage(X,(i+20)*y,0,y,d,a*y,t*d,y,d)),e){n||(i=0);for(var r=t*d*v+a*y,l=0;l<d;l++)for(var s=0;s<y;s++)F[r+l*v+s]=i}}Y.setLineDash([])};this.update=function(){var e=getTimestamp(),t=(e-q)/1;if(q=e,l){Y.fillStyle="#2b2b2b",Y.fillRect(0,0,h.width,h.height);for(var a=0;a<M.length;a++)(i=M[a]).flash&&(i.flashEmitterOn&&e-i.flashEmitterLastTime>i.flashEmitterOnTime&&(i.flashEmitterOn=0,i.flashEmitterLastTime=e),!i.flashEmitterOn&&e-i.flashEmitterLastTime>i.flashEmitterOffTime&&(i.flashEmitterOn=1,i.flashEmitterLastTime=e));if(he(!0),0==f?function(e){var t=[[32,34,11,7],[50,34,42,7],[98,34,17,7],[122,34,23,7],[153,34,22,7],[182,34,17,7],[206,34,17,7],[230,34,17,7],[254,34,29,7]],a=[[32,46,83,7]];800<e-p&&(p=e,g=(g+1)%t.length,w=(w+1)%a.length),Y.imageSmoothingEnabled=!1;var i=t[g][0],n=t[g][1],r=t[g][2],l=t[g][3],s=48,o=16*r,h=16*l,f=Math.floor((v-o)/2);Y.drawImage(R,i,n,r,l,f,s,o,h),i=a[w][0],n=a[w][1],r=a[w][2],l=a[w][3],o=8*r,s=b-32-4-(h=8*l),f=Math.floor((v-o)/2),Y.globalAlpha=.5,Y.drawImage(R,i,n,r,l,f,s,o,h),Y.globalAlpha=1,Y.imageSmoothingEnabled=!0}(e):1==f?function(e){var t=[[122,46,53,7]];E.y<180&&E.x<180&&(t=[[290,34,53,7]]),800<e-p&&(p=e,g=(g+1)%t.length),Y.imageSmoothingEnabled=!1;var a=t[g][0],i=t[g][1],n=t[g][2],r=t[g][3],l=8*n,s=8*r,o=b-32-4-s,h=Math.floor((v-l)/2);Y.globalAlpha=.5,Y.drawImage(R,a,i,n,r,h,o,l,s),Y.globalAlpha=1,Y.imageSmoothingEnabled=!0}(e):2==f?function(e){var t=[[182,46,54,7]];800<e-p&&(p=e,g=(g+1)%t.length),Y.imageSmoothingEnabled=!1;var a=t[g][0],i=t[g][1],n=t[g][2],r=t[g][3],l=8*n,s=8*r,o=b-32-4-s,h=Math.floor((v-l)/2);Y.globalAlpha=.5,Y.drawImage(R,a,i,n,r,h,o,l,s),Y.globalAlpha=1,Y.imageSmoothingEnabled=!0}(e):f==K.length-1&&function(e){var t=[[242,46,23,7],[272,46,27,7]];800<e-p&&(p=e,g=(g+1)%t.length),Y.imageSmoothingEnabled=!1;var a=t[g][0],i=t[g][1],n=t[g][2],r=t[g][3],l=26*n,s=26*r,o=Math.floor((v-l)/2);Y.globalAlpha=.5,Y.drawImage(R,a,i,n,r,o,160,l,s),Y.imageSmoothingEnabled=!0,Y.globalAlpha=1}(e),function(){var e=s*y,t=o*d+d,a=2*y;Y.fillStyle="#cccccc",Y.fillRect(e-3,t-45-3,a+6,48),Y.fillStyle="#222222",Y.fillRect(e+1,t-45+1,a-2,44),Y.fillStyle="#efefef",Y.fillRect(e+7-3,t-45-16-1-1,25,13),E.touchingExit?Y.fillStyle="#00ff00":Y.fillStyle="#009900",Y.fillRect(e+7-2,t-45-16-1,23,11),Y.drawImage(R,0,34,21,11,e+7-1,t-45-16-2,21,11);for(var i=t-45+1;i<t-45+1+45-1;i++)for(var n=e+1;n<e+1+a-2;n++)F[i*v+n]=30}(),function(){for(var e=0,t=0,a=0,i=0,n=0;n<V.length;n++){var r=V[n].x*y,l=V[n].y*d;Y.fillStyle="#eeeeee";var s=22,o=8;switch(Y.fillStyle=u[V[n].type-3],V[n].type==C&&(o=3),V[n].orientation){case 0:t=(e=r+4)+s,a=l+d-o,i=l+d;break;case 2:e=r+y-o,t=r+y,i=(a=l+4)+s;break;case 1:t=(e=r)+o,i=(a=l+4)+s;break;case 3:t=(e=r+4)+s,i=(a=l)+o}if(Y.fillRect(e,a,t-e,i-a),V[n].type!=C)for(var h=a;h<i;h++)for(var f=e;f<t;f++)F[h*v+f]=10+V[n].type;switch(s=30,o=2,Y.fillStyle=c[V[n].type-3],V[n].orientation){case 0:t=(e=r)+s,a=l+d-o,i=l+d;break;case 3:t=(e=r)+s,i=(a=l)+o;break;case 1:t=(e=r)+o,i=(a=l)+s;break;case 2:e=r+y-o,t=r+y,i=(a=l)+s}Y.fillRect(e,a,t-e,i-a)}}(),function(){for(var e=0;e<M.length;e++)for(var t=Math.floor(M[e].y)*v+Math.floor(M[e].x),a=0;a<M[e].height;a++)for(var i=0;i<M[e].width;i++)F[t+a*v+i]=50+e;for(oe(),Y.fillStyle="#eeeeee",e=0;e<M.length;e++)Y.fillRect(M[e].x,M[e].y,M[e].width,M[e].height)}(),1==E.state){for(var i,n=t;30<n;)le(30),n-=30;0<n&&le(n),!1!==E.onEmitter&&0<(i=M[E.onEmitter]).sY&&(E.y=i.y-m+E.bounds[1])}he(!1);var r=10;for(E.inDash&&(r=2);r<t;)$(e,r),t-=r;0<t&&$(e,t),function(e){for(var t=N.length-1;0<=t;t--){var a=N[t][0],i=N[t][1];8==j[i][a]&&280<e-N[t][2]?(N[t][2]=e,j[i][a]=0):0==j[i][a]&&1120<e-N[t][2]&&(j[i][a]=x,N.splice(t,1))}}(e),function(){if(T)for(var e=0;e<D.length;e++){var t=D[e],a=t.baseFrame+t.currentFrame,i=Math.floor(t.x)+Math.floor(t.y)*v;t.touchingExit=!1;for(var n=0;n<m;n++)for(var r=0;r<m;r++){var l=4*(a*m+r+n*T.width),s=i+r+n*v;0==T.data[l]&&0==T.data[l+1]&&0==T.data[l+2]||0==T.data[l+3]||(F[s]===A&&(t.state=0,t.stateTimer=0,playSound(2)),30==F[s]&&E.tileBelow&&(t.touchingExit=1))}if(Math.floor(t.x),Math.floor(t.y),Y.drawImage(R,a*m,0,m,m,Math.floor(t.x)*G,Math.floor(t.y)*G,m*G,m*G),1==t.actorType&&E.inDash){for(var o=.6,h=W.length-2;0<=h&&(Y.globalAlpha=o,Y.drawImage(R,a*m,0,m,m,Math.floor(W[h][0])*G,Math.floor(W[h][1])*G,m*G,m*G),!((o-=.07)<=0));h-=2);Y.globalAlpha=1}}}()}}};t.init(),function e(){t.update(),requestAnimationFrame(e)}();