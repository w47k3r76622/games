<!doctype html><title>XIII</title><style>body,html{width:100%;height:100%;margin:0;padding:0;overflow:hidden}</style><canvas id=C style=background:#000></canvas><div id=DIV style="padding:10px;position:fixed;width:100%;top:0;left:0;font:24px monospace;color:#fff">Find the Caravan and stop it before it reaches Acre. Right Mouse to aim, Left to shoot. WSAD to move.</div><script src=microgl.js></script><script>var vs=`\nIN mat4 model;\nIN mat4 viewp;\nIN vec3 ceye;\nIN float time;\nIN vec4 color;\nIN float mat;\n#ifdef INST\nin vec4 offs;\n#endif\n#ifdef SKIN\nin float B;\nIN mat4 bones[6];\nIN float bw;\n#endif\nout vec3 wpos;\nout vec4 vcol;\nvec3 ROTY(vec3 v,float a){vec2 t=vec2(sin(a),cos(a));return vec3(t.y*v.x-t.x*v.z,v.y,t.x*v.x+t.y*v.z);}\nfloat PI=${PI};\nvoid main(){\nwpos=pos;\nvcol=color;\nfloat id=float(gl_InstanceID);\nif(mat==2.0)wpos.z=sin(wpos.x*8.0+time*5.0)*(wpos.x)*.05;\nif(mat==8.0)wpos.xz=NORM(wpos.xz)*.3;\n#ifdef SKIN\nwpos=mix(wpos,(bones[int(B)]*vec4(wpos,1.0)).xyz,bw);\n#endif    \n#ifdef INST\nif(mat==7.0)wpos*=.1;\nwpos=ROTY(wpos,offs.w*PI*2.0);\nwpos+=offs.xyz;\nwpos.y-=length(ceye-wpos)*.0001;\n#endif\nwpos=(model*vec4(wpos,1.0)).xyz;\nif(mat==4.0)wpos.y=.02;\ngl_Position=viewp*vec4(wpos,1.0);\n}\n`,fs="\nin vec3 wpos;\nin vec4 vcol;\nIN vec3 ceye;\nvec3 scolor=vec3(.7,.6,.4);\nvec3 fcolor=vec3(.8,.5,.2);\nIN float time;\nIN float mat;\nvoid main(){\nvec3 N=NORM(cross(dFdx(wpos),dFdy(wpos)));\nvec3 L=NORM(vec3(.2,.7,-.8));\nvec4 C=(dot(N,L)*0.5+0.5)*vcol;\nif(mat==3.0&&wpos.x>75.0)C.xyz=mix(C.xyz,vec3(.3,.5,.6),min(1.0,(wpos.x-75.0)*.1));\nif(mat==3.0&&abs(wpos.x+sin(wpos.z/17.0))<2.0)C.xyz*=.9;\nif(mat==9.0&&N.y>0.2)C.xyz=vec3(.6,.1,.0);\nC.xyz+=max(0.0,-N.y)*fcolor*.25;\nfloat dist=distance(ceye,wpos);\nC.xyz=mix(C.xyz,scolor,clamp(pow(dist/200.0,0.5),0.0,1.0));\nfragColor=C;\n}\n",i=0,j=0;ARP.p=ARP.push,ARP.m=ARP.map,ARP.c=ARP.concat,ARP.rand=function(){return this[0|RAND(this.length)]},INPUT(C),INIT(C),sh=PROGRAM(vs,fs),sh_inst=PROGRAM(vs,fs,["INST"]),sh_skin=PROGRAM(vs,fs,["SKIN"]),sh_ui=PROGRAM("IN vec4 rect;void main(){vec4 p=vec4(pos,1.0);p.xy=p.xy*rect.zw-vec2(1.0)+rect.zw+rect.xy*2.0;gl_Position=p;}","IN vec4 color;void main(){fragColor=color;}"),meshes.plane=PLANE(),NSIN=o=>SIN(2*o*PI),SIM=(o,e,s)=>{l=o.length/3;for(var r=0,a=e.length;r<a;r+=3)e.p(e[r]+l,e[r+2]+l,e[r+1]+l);o.p(...o.m(((o,e)=>o*s[e%3])))},FETCH=(o,e)=>fetch(o).then((o=>o.arrayBuffer())).then(e),LOAD=(o,e,s,r,a)=>FETCH(o+".xbin",(i=>{for(var t,l=new Int8Array(i),n=new UINT8(i),f=[],p=n[0],c=1;c<=3*p;c+=3)f.p(l[c]/127,n[c+2]/255,l[c+1]/127);t=Array.from(n.subarray(3*p+2)),e&&SIM(f,t,[-1,1,1]),s&&SIM(f,t,[1,-1,1]),r&&SIM(f,t,[1,1,-1]);var D=meshes[o]=MESH({pos:f,tris:t});a&&a(D,o)})),SKIN=(o,e)=>{for(var s=[],r=o.pos.d,a=0;a<r.length;a+=3)s.p(e(r[a],r[a+1],r[a+2],a));o.B=BUFFER(s,1)},LOAD("arm"),LOAD("tower",1,0,1),LOAD("house",1,0,1),LOAD("torso",1),LOAD("leg",1),LOAD("head",1),LOAD("horse",1,0,0,(o=>{SKIN(o,((o,e,s,r,a=0)=>{if(s>=.2&&e>.55)1;else if(e<.33)return o>0?s>0?2:3:s>0?4:5}))}));var f={pos:[],tris:[]};for(i=0,j=0;i<20;++i)j=2*i,f.pos.p(-i/8,.2-.01*i,0,-i/8,.01*i-.2,0),19!=i&&f.tris.p(j,j+1,j+2,j+1,j+2,j+3);meshes.flag=MESH(f);var fcolor=[.8,.5,.2,1],scolor=[.7,.6,.4,1],ftex=0,fbo=0,NOW=0,PREV=0,GTIME=0,STIME=5,BTS=[],bulletbuf=BUFFER(V3(3072),3),bulletbuf2=BUFFER(V3(4096),4);SHOOT=(o,e,s,r=20,a=10)=>{BTS.length<1023&&BTS.p({id:o,pos:e,vel:V3(s).SCALE(r),t:a,pos2:V3(e)})};var PTS=[];for(NEWPT=(o,e,s=10)=>PTS.p({pos:o,vel:e,t:s}),rrocks=[],i=0;i<200;++i)rrocks.p(RAND(50,-25),0,RAND(50,-25),RAND());rocks=BUFFER(rrocks,4);var R=M4(),T=M4();ROTBONE=(o,e,s,r=[1,0,0],a)=>(TMAT4(o,e),RMAT4(R,s,r),MULTMAT4(o,o,R),TMAT4(T,[-e[0],-e[1],-e[2]]),MULTMAT4(o,o,T),a&&MULTMAT4(o,a,o),o);var ws=[[[0,.5,-.1],0,.02],[[0,.57,.2],.25,.06],[[0,.32,.15],0,.18],[[0,.28,-.25],.25,.18],[[0,.32,.15],.25,.18],[[0,.28,-.25],0,.18]];COMPUTEBONES=(o,e,s)=>{for(i=0;i<6;++i)w=ws[i],ROTBONE(o[i],w[0],NSIN(e+w[1])*s*w[2])};var frames=[];for(j=0;j<64;++j){f={p:j/64,data:new F32(96),bones:[]};for(i=0;i<6;++i)f.bones.p(f.data.subarray(16*i,16*(i+1)));COMPUTEBONES(f.bones,f.p,4),frames.p(f)}var objs=[],men=[],lid=0,Clife=1,Cpos=[0,.5,-200];for(NEWMAN=(o,e,s=0,r=0)=>{var a={type:o,lean:0,arrows:20,off:[RAND(50,-25),0,RAND(50,-25)],color:[.5,.5,.5,1],rdy:1,id:lid++,pos:e,ang:s,speed:r,phase:RAND(),vel:V3(),life:1,pos2:ADD([],e,[0,1.5,0])};return men.p(a),a},i=-8;i<=8;++i)ABS(i)<7&&NEWMAN(0,[80+(i?0:-2),0,i-RAND(.5)-300],PI/2,0),NEWMAN(1,[i-RAND(.5),0,(i?0:2)-5+Cpos[2]],PI,0);var PLY=men[10],pidx=0;for(ADDOBJ=(o,e)=>objs[objs.p({mesh:o,unif:e})-1],i=-15;i<=15;++i)ist=!i,ADDOBJ("tower",{mat:1,color:fcolor,model:TRS(0,[5*i,0,0],[0,ist?PI/2:0,0],ist?[8,6.5,8]:[8,5,4])}),i%2==0&&(ADDOBJ("tower",{mat:1,color:fcolor,model:TRS(0,[5*i,ist?6:5,0],0,ist?4.5:3)}),ADDOBJ("flag",{mat:2,prim:5,color:[1,.3,.1,1],model:TRS(0,[5*i,ist?12:9.5,0],[0,-PI/2,0],2)}));ADDOBJ("house",{mat:0,color:[.4,.2,.1,1],model:TRS(0,[0,0,0],0,3)});var house=ADDOBJ("house",{mat:9,color:[.4,.5,.2,1],model:M4()}),PMODEL=M4(),FLATM4=SMAT4(M4(),[1,.02,1]),HMODEL=M4(),AMODEL=M4(),BMODEL=M4(),armcol=[.3,.3,.3,1],armleft=TRS(0,[-.1,.77,-.02],[-4,0,-.1],[-.4,.4,.4]),armright=TRS(0,[.1,.77,-.02],[-4,0,.1],.4),shadowc=[.2,.1,0,1],camA=PLY.ang+PI,camY=.2,camZ=4,camF=0,eye=V3(),camS=.01;CAM_EYE.set([180,5,-250]),loop=()=>{requestAnimationFrame(loop),NOW=TIME();var o=MIN(.1,NOW-PREV),e=PLY.life&&2&MOUSE.buttons;PREV=NOW;var s=C.width=BODY.offsetWidth,r=C.height=BODY.offsetHeight;fbo&&fbo.w==s>>1||((ftex=TEX(s>>1,r>>1)).param(0,NEAREST),fbo=FBO(ftex)),e&&(o*=.2),GTIME+=o,STIME-=o,INIT(C),fbo.bind(1),CLEAR(scolor,1),camF=[0,SIN(camY-(e?.2:0)),COS(camY-(e?.2:0))],ROTY(camF,camF,camA),ADD(eye,PLY.pos,camF,camZ);var a=[PLY.pos[0],1,PLY.pos[2]];PLY.aim=0,e&&(PLY.aim=1,ADD(eye,PLY.pos,[0,1.2,0]),ADD(a,eye,camF,-1)),LERPV3(eye,CAM_EYE,eye,.05),eye[1]=MAX(.1,eye[1]),CAMERA(eye,a,UP,e?40:60,s/r,.1,1e3),GLSET(ZTEST),GLSET(CULL,0),GLSET(BLEND,0),BLENDFUNC("A");var t="head";for(DRAW("plane",sh,{mat:3,color:fcolor,model:TRS(HMODEL,[eye[0],0,eye[2]],0,300)}),DRAW("house",sh_inst,{mat:0,color:fcolor,model:TRS(0,[0,0,100],0,3)},4,200,{offs:rocks}),j=-2;j<=2;++j){var l=50*ROUND(j+PLY.pos[2]/50);for(i=-2;i<=2;++i){var n=50*ROUND(i+PLY.pos[0]/50);n>50||(DRAW(t,sh_inst,{mat:0,color:[.6,.4,.2,1],model:TRS(0,[n,-.4,l],0,[1,.6,1])},4,200,{offs:rocks}),DRAW(t,sh_inst,{color:[.4,.3,.2,1],model:TRS(0,[n,-.65,l],[0,90,0],.8)},4,200,{offs:rocks}))}}sh.uniforms({time:GTIME}),objs.forEach(((o,e)=>DRAW(meshes[o.mesh],sh,o.unif,o.prim))),DRAWMAN=o=>{var e=DIST(o.pos,CAM_EYE);if(!(e>150)){var s=o.type,r=CLAMP(o.speed/3,0,1),a=o.phase;if(TRS(PMODEL,[o.pos[0],(o.life?o.pos[1]+.04*ABS(NSIN(a/2))-.02:-.3)-.02*MAX(0,o.pos[0]-75),o.pos[2]],[0,-o.ang,0],[s?1.2:1,1,1]),s<3){var i=frames[(64*a|0)%64];DRAW("horse",sh_skin,{mat:0,bw:r,bones:i.data,color:s?[.1,.1,.1,1]:[.4,.2,.1,1],model:PMODEL}),DRAW("horse",sh_skin,{mat:4,bw:r,bones:i.data,color:shadowc,model:PMODEL})}o.life<=0&&TRS(PMODEL,o.pos,[PI/2,1.04*PI,PI/2],1),MULTMAT4(HMODEL,PMODEL,TRS(HMODEL,[0,.16,-.1],0,.9)),ROTBONE(AMODEL,[0,.5,0],o.life*NSIN(a)*.2-.5,[1,0,0],HMODEL),DRAW("leg",sh,{mat:0,color:armcol,model:AMODEL}),APPLYTRANS(PMODEL,PMODEL,[0,.1,-.1]),ROTBONE(HMODEL,[0,.5,0],.4*o.lean,[0,0,1],PMODEL),DRAW("torso",sh,{mat:0,color:o.color,model:HMODEL}),e<80&&(TRS(AMODEL,[0,.82,0],[.1*NSIN(a+.5),0,0],.2,HMODEL),DRAW("head",sh,{mat:0==s?0:8,color:s?[.8,.1,.1,1]:[.1,.4,.7,1],model:AMODEL}),o.life>0&&(MULTMAT4(AMODEL,HMODEL,armleft),DRAW("arm",sh,{mat:0,color:armcol,model:AMODEL})))}},men.forEach(DRAWMAN);var f=bulletbuf;for(GLSET(BLEND),BTS.length&&(BTS.forEach(((o,e)=>{f.d.set(o.pos,6*e),f.d.set(o.pos2,6*e+3)})),f.update(),t={0:2*BTS.length,pos:f},DRAW(t,0,{color:[1,1,1,1],model:IDM4},1),DRAW(t,0,{psize:2},0),DRAW(t,0,{color:[0,0,0,.2],model:FLATM4},1)),PTS.length&&(PTS.forEach(((o,e)=>f.d.set(o.pos,3*e))),f.update(),t={0:PTS.length,pos:f},DEPTHW(0),DRAW(t,0,{color:[.4,.3,.2,.02],model:IDM4,psize:40},0),DEPTHW(1)),GLSET(BLEND,0),GLSET(ZTEST,0),fbo.bind(0),ftex.toVP(),e&&PLY.rdy&&DRAW(QUAD,sh_ui,{color:[1,1,1,1],rect:[.5,.5,.003,.003]}),DRAW(QUAD,sh_ui,{color:[.8,.4,.2,1],rect:[0,0,Clife,.01]}),i=0;i<PLY.arrows;++i)DRAW(QUAD,sh_ui,{color:PLY.rdy>=1?[.9,.9,.9,1]:[0,0,0,1],rect:[.02+.015*i,.02,.005,.09]});camS=.01,DOC.pointerLockElement&&(camA-=MOUSE.delta[0]*-camS*.4,camY=CLAMP(camY+MOUSE.delta[1]*camS,-PI/4,PI/4),camZ=CLAMP(camZ+.01*MOUSE.wheel,1,10));var p=PLY.ang;1==PLY.life&&(PLY.lean*=.95,KEYS.W&&(PLY.speed+=1.5*o),KEYS.S&&(PLY.speed*=.992),KEYS.A&&(PLY.ang-=o*MAX(.25,.1*PLY.speed)),KEYS.D&&(PLY.ang+=o*MAX(.25,.1*PLY.speed)),KEYS.E&&(PLY.lean=1),KEYS.Q&&(PLY.lean=-1));var c=[[],[],[],[]];men.forEach((o=>{o.life>0&&c[o.type].p(o)})),!c[1].length&&Clife<=0&&(DIV.innerText="YOU CONQUERED ACRE"),(!c[0].length||Cpos[2]>0)&&(DIV.innerText="GAME LOST"),KEYSP.Space&&c[0].length&&(PLY=c[0].rand()),camA+=PLY.ang-p,PLY.rdy>=1&&PLY.arrows&&1==PLY.life&&3==MOUSE.buttons&&3!=MOUSE.prevb&&(SHOOT(PLY,V3(CAM_EYE),CAM_FRONT.MUL(30).ADD(PLY.vel),1),PLY.rdy=0,PLY.arrows--),BTS.forEach(((e,s)=>{e.t>0&&e.pos2.set(e.pos),e.t-=o,ADD(e.vel,e.vel,[0,-.5,0],o),ADD(e.pos,e.pos,e.vel,o),ADD(e.vel,e.vel,e.vel,.2*-o),e.pos[1]<0&&(e.vel.fill(0),e.t=MIN(0,e.t)),e.t>0&&men.forEach((o=>{e.id!=o&&DIST(o.pos2,e.pos)<.5&&(o.life=0,e.t=-10)})),e.t>0&&DIST(e.pos,Cpos)<3&&e.id&&(Clife-=.2,e.t=-10),e.t<0&&e.vel.fill(0)})),BTS=BTS.filter((o=>o.t>-5)),PTS.forEach(((e,s)=>{e.t-=o,ADD(e.pos,e.pos,e.vel,o),ADD(e.vel,e.vel,e.vel,.8*-o)})),PTS=PTS.filter((o=>o.t>0)),men.forEach((s=>{var r=s.type,a=s.pos;if(s.life<=0)s.speed*=.99;else{s.phase+=o*MIN(1.5,.6*s.speed),s.ang=s.ang%(2*PI),r<3&&ROTY(s.vel,[0,0,s.speed],s.ang),ADD(a,a,s.vel,o),r<2&&(!s.trg||s.trg.life<=0)&&(s.trg=c[r?0:1].filter((o=>o.life>0)).rand());var i=s.trg?DIST(s.pos,s.trg.pos):-1;if(i>40&&(s.trg=0),s!=PLY&&r<2){var t=s.trg?s.trg.pos2:ADD(V3(),r?Cpos:PLY.pos,s.off),l=ATAN2(s.pos[0]-t[0],t[2]-s.pos[2])%(2*PI);l<0&&(l+=2*PI),s.ang=LERP(s.ang,ABS(s.ang-l)>PI?l-2*PI:l,.01),s.speed=3,RAND()<.002&&s.trg&&i<30&&s.arrows&&1==s.rdy&&(SHOOT(s,V3(s.pos2),NORM(V3(),SUB(V3(),t,s.pos2).ADD([0,.5,0]))),s.arrows-=1,s.rdy=0)}e&&s==PLY||(s.speed=MIN(8,.997*s.speed)),a[2]=MIN(a[2],-5),ADD(s.pos2,a,[0,.5,0]),s.rdy=MIN(1,s.rdy+.25*o),DIST(CAM_EYE,a)<50&&s.speed>2&&RAND()>.9&&a[0]<75&&PTS.length<1023&&NEWPT(V3(a),V3(s.vel).ADD([RAND()-.5,RAND(),RAND()-.5]),4)}})),Clife>0&&(Cpos[2]+=o*Clife),TRS(house.unif.model,[0,Clife>0?.2:-.1,Cpos[2]],0,[1.5,1.5,3]),STIME<0&&((t=c[0].rand())&&!t.type&&DIST(Cpos,t.pos)<40&&SHOOT(0,V3(Cpos),NORM(V3(),SUB(V3(),t.pos2,Cpos)).ADD([0,.01,0])),STIME=2),END()},loop(),ONMOUSE=o=>{"mousedown"==o.type&&C.requestPointerLock()}</script>
