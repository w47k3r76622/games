!function(){"use strict";for(var e=(e,r)=>{var t=0;return r.map(r=>{e[t++]=r.x,e[t++]=r.y,e[t++]=r.z}),e},r=e=>{var r=[],t=[];return e.faces.map(i=>{r.push(e.vertices[i.a],e.vertices[i.b],e.vertices[i.c]);var{vertexColors:n}=i;if(3===n.length)t.push(...n);else{var{color:a}=i;t.push(a,a,a)}}),{vertices:r,colors:t}},t=(e,t)=>i(e,r(t)),i=(r,t)=>{var i=new Float32Array(3*t.vertices.length);r.attrs.position=e(i,t.vertices);var n=new Float32Array(3*t.colors.length);return r.attrs.color=e(n,t.colors),r},n=(e=0,r=0,t=0)=>({x:e,y:r,z:t}),a=(e,r,t,i)=>(e.x=r,e.y=t,e.z=i,e),o=(e,r)=>(e.x=r,e.y=r,e.z=r,e),s=e=>n(e.x,e.y,e.z),v=(e,r)=>(e.x+=r.x,e.y+=r.y,e.z+=r.z,e),l=(e,r,t)=>(e.x=r.x+t.x,e.y=r.y+t.y,e.z=r.z+t.z,e),d=(e,r,t)=>(e.x+=r.x*t,e.y+=r.y*t,e.z+=r.z*t,e),m=(e,r)=>(e.x-=r.x,e.y-=r.y,e.z-=r.z,e),p=(e,r,t)=>(e.x=r.x-t.x,e.y=r.y-t.y,e.z=r.z-t.z,e),h=(e,r)=>(e.x*=r.x,e.y*=r.y,e.z*=r.z,e),g=(e,r)=>(e.x*=r,e.y*=r,e.z*=r,e),y=(e,r)=>{var{x:t,y:i,z:n}=e;return e.x=r[0]*t+r[4]*i+r[8]*n,e.y=r[1]*t+r[5]*i+r[9]*n,e.z=r[2]*t+r[6]*i+r[10]*n,b(e)},u=(e,r)=>g(e,1/r),x=(e,r)=>(e.x=Math.min(e.x,r.x),e.y=Math.min(e.y,r.y),e.z=Math.min(e.z,r.z),e),f=(e,r)=>(e.x=Math.max(e.x,r.x),e.y=Math.max(e.y,r.y),e.z=Math.max(e.z,r.z),e),z=(e,r,t)=>{var i=r.x,n=r.y,a=r.z,o=t.x,c=t.y,s=t.z;return e.x=n*s-a*c,e.y=a*o-i*s,e.z=i*c-n*o,e},_=(e,r)=>e.x*r.x+e.y*r.y+e.z*r.z,L=e=>Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z),b=e=>u(e,L(e)||1),w=(e,r)=>{var{x:t,y:i,z:n}=e;return e.x=r[0]*t+r[4]*i+r[8]*n+r[12],e.y=r[1]*t+r[5]*i+r[9]*n+r[13],e.z=r[2]*t+r[6]*i+r[10]*n+r[14],e},M=(e,r)=>{var{x:t,y:i,z:n}=e,a=r.x,o=r.y,c=r.z,s=r.w,v=s*t+o*n-c*i,l=s*i+c*t-a*n,d=s*n+a*i-o*t,m=-a*t-o*i-c*n;return e.x=v*s+m*-a+l*-c-d*-o,e.y=l*s+m*-o+d*-a-v*-c,e.z=d*s+m*-c+v*-o-l*-a,e},C=(e,r)=>Math.sqrt(P(e,r)),P=(e,r)=>{var t=e.x-r.x,i=e.y-r.y,n=e.z-r.z;return t*t+i*i+n*n},D=(e,r)=>(e.x=r[12],e.y=r[13],e.z=r[14],e),R=(e,r)=>(e.x=r[0],e.y=r[1],e.z=r[2],e),F=(n(1,0,0),n(0,1,0)),A=(n(0,0,1),()=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])),I=(e,r)=>{var{x:t,y:i,z:n,w:a}=r,o=t+t,c=i+i,s=n+n,v=t*o,l=t*c,d=t*s,m=i*c,p=i*s,h=n*s,g=a*o,y=a*c,u=a*s;return e[0]=1-(m+h),e[4]=l-u,e[8]=d+y,e[1]=l+u,e[5]=1-(v+h),e[9]=p-g,e[2]=d-y,e[6]=p+g,e[10]=1-(v+m),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},E=(()=>{var e=n(),r=n(),t=n();return(i,n,a,o)=>(b(p(t,n,a)),L(t)||(t.z=1),b(z(e,o,t)),L(e)||(t.z+=1e-4,b(z(e,o,t))),z(r,t,e),i[0]=e.x,i[4]=r.x,i[8]=t.x,i[1]=e.y,i[5]=r.y,i[9]=t.y,i[2]=e.z,i[6]=r.z,i[10]=t.z,i)})(),O=e=>(e.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e),j=(e,r)=>(e.set(r),e),B=(e,r,t)=>{var i=r[0],n=r[4],a=r[8],o=r[12],c=r[1],s=r[5],v=r[9],l=r[13],d=r[2],m=r[6],p=r[10],h=r[14],g=r[3],y=r[7],u=r[11],x=r[15],f=t[0],z=t[4],_=t[8],L=t[12],b=t[1],w=t[5],M=t[9],C=t[13],P=t[2],D=t[6],R=t[10],F=t[14],A=t[3],I=t[7],E=t[11],O=t[15];return e[0]=i*f+n*b+a*P+o*A,e[4]=i*z+n*w+a*D+o*I,e[8]=i*_+n*M+a*R+o*E,e[12]=i*L+n*C+a*F+o*O,e[1]=c*f+s*b+v*P+l*A,e[5]=c*z+s*w+v*D+l*I,e[9]=c*_+s*M+v*R+l*E,e[13]=c*L+s*C+v*F+l*O,e[2]=d*f+m*b+p*P+h*A,e[6]=d*z+m*w+p*D+h*I,e[10]=d*_+m*M+p*R+h*E,e[14]=d*L+m*C+p*F+h*O,e[3]=g*f+y*b+u*P+x*A,e[7]=g*z+y*w+u*D+x*I,e[11]=g*_+y*M+u*R+x*E,e[15]=g*L+y*C+u*F+x*O,e},S=(e,r)=>(e[12]=r.x,e[13]=r.y,e[14]=r.z,e),T=(e,r)=>{var t=r[0],i=r[1],n=r[2],a=r[3],o=r[4],c=r[5],s=r[6],v=r[7],l=r[8],d=r[9],m=r[10],p=r[11],h=r[12],g=r[13],y=r[14],u=r[15],x=d*y*v-g*m*v+g*s*p-c*y*p-d*s*u+c*m*u,f=h*m*v-l*y*v-h*s*p+o*y*p+l*s*u-o*m*u,z=l*g*v-h*d*v+h*c*p-o*g*p-l*c*u+o*d*u,_=h*d*s-l*g*s-h*c*m+o*g*m+l*c*y-o*d*y,L=t*x+i*f+n*z+a*_;if(0===L)return O(e);var b=1/L;return e[0]=x*b,e[1]=(g*m*a-d*y*a-g*n*p+i*y*p+d*n*u-i*m*u)*b,e[2]=(c*y*a-g*s*a+g*n*v-i*y*v-c*n*u+i*s*u)*b,e[3]=(d*s*a-c*m*a-d*n*v+i*m*v+c*n*p-i*s*p)*b,e[4]=f*b,e[5]=(l*y*a-h*m*a+h*n*p-t*y*p-l*n*u+t*m*u)*b,e[6]=(h*s*a-o*y*a-h*n*v+t*y*v+o*n*u-t*s*u)*b,e[7]=(o*m*a-l*s*a+l*n*v-t*m*v-o*n*p+t*s*p)*b,e[8]=z*b,e[9]=(h*d*a-l*g*a-h*i*p+t*g*p+l*i*u-t*d*u)*b,e[10]=(o*g*a-h*c*a+h*i*v-t*g*v-o*i*u+t*c*u)*b,e[11]=(l*c*a-o*d*a-l*i*v+t*d*v+o*i*p-t*c*p)*b,e[12]=_*b,e[13]=(l*g*n-h*d*n+h*i*m-t*g*m-l*i*y+t*d*y)*b,e[14]=(h*c*n-o*g*n-h*i*s+t*g*s+o*i*y-t*c*y)*b,e[15]=(o*d*n-l*c*n+l*i*s-t*d*s-o*i*m+t*c*m)*b,e},V=(e,r)=>{var{x:t,y:i,z:n}=r;return e[0]*=t,e[4]*=i,e[8]*=n,e[1]*=t,e[5]*=i,e[9]*=n,e[2]*=t,e[6]*=i,e[10]*=n,e[3]*=t,e[7]*=i,e[11]*=n,e},W=(e,r,t,i)=>(I(e,t),V(e,i),S(e,r),e),k=(e=0,r=0,t=0,i=1)=>({x:e,y:r,z:t,w:i}),q=(e,r,t,i,n)=>(e.x=r,e.y=t,e.z=i,e.w=n,e),H=(e,r)=>{var t=e.x,i=e.y,n=e.z,a=e.w,o=r.x,c=r.y,s=r.z,v=r.w;return e.x=t*v+a*o+i*s-n*c,e.y=i*v+a*c+n*o-t*s,e.z=n*v+a*s+t*c-i*o,e.w=a*v-t*o-i*c-n*s,e},N=(e,r,t)=>{var i=t/2,n=Math.sin(i);return e.x=r.x*n,e.y=r.y*n,e.z=r.z*n,e.w=Math.cos(i),e},G=(e,r)=>{var t,i=r[0],n=r[4],a=r[8],o=r[1],c=r[5],s=r[9],v=r[2],l=r[6],d=r[10],m=i+c+d;return m>0?(t=.5/Math.sqrt(m+1),e.w=.25/t,e.x=(l-s)*t,e.y=(a-v)*t,e.z=(o-n)*t):i>c&&i>d?(t=2*Math.sqrt(1+i-c-d),e.w=(l-s)/t,e.x=.25*t,e.y=(n+o)/t,e.z=(a+v)/t):c>d?(t=2*Math.sqrt(1+c-i-d),e.w=(a-v)/t,e.x=(n+o)/t,e.y=.25*t,e.z=(s+l)/t):(t=2*Math.sqrt(1+d-i-c),e.w=(o-n)/t,e.x=(a+v)/t,e.y=(s+l)/t,e.z=.25*t),e},U=e=>Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w),K=e=>{var r=U(e);return r?(r=1/r,e.x=e.x*r,e.y=e.y*r,e.z=e.z*r,e.w=e.w*r):(e.x=0,e.y=0,e.z=0,e.w=1),e},Y=()=>({parent:void 0,children:[],components:[],position:n(),quaternion:k(),scale:n(1,1,1),matrix:A(),matrixWorld:A(),modelViewMatrix:A(),visible:!0}),X=(()=>{var e=A();return(r,t)=>{E(e,t,r.position,F),G(r.quaternion,e)}})(),$=(e,r)=>(r.parent=e,e.children.push(r),e),J=(e,r)=>{var t=e.children.indexOf(r);t>=0&&e.children.splice(t,1)},Q=((()=>{var e=k()})(),(()=>{var e=n();return(r,t,i)=>(M(Object.assign(e,t),r.quaternion),v(r.position,g(e,i)),r)})()),Z=(e,r)=>{r(e),e.children.map(e=>Z(e,r))},ee=e=>{W(e.matrix,e.position,e.quaternion,e.scale)},re=e=>{ee(e),e.parent?B(e.matrixWorld,e.parent.matrixWorld,e.matrix):j(e.matrixWorld,e.matrix),e.children.map(re)},te=Math.PI/180,ie=(()=>{var e=A();return(r,t)=>{E(e,r.position,t,r.up),G(r.quaternion,e)}})(),ne=e=>{var{near:r,far:t}=e,i=r*Math.tan(.5*e.fov*te),n=-i,a=n*e.aspect,o=i*e.aspect,c=2*r/(o-a),s=2*r/(i-n),v=(o+a)/(o-a),l=(i+n)/(i-n),d=-(t+r)/(t-r),m=-2*t*r/(t-r);e.projectionMatrix.set([c,0,0,0,0,s,0,0,v,l,d,-1,0,0,m,0])},ae=k(),oe=k(),ce=e=>Object.assign({parent:void 0,update(){}},e),se=(e,...r)=>(r.map(r=>{ve(e,r)||(r.parent=e,e.components.push(r))}),e),ve=(e,r)=>e.components.includes(r),le=(e,r)=>e.components.find(r),de=(e,r)=>e.components.filter(r),me=(e,...r)=>{e.components.map(e=>e.update(e,...r))},pe=[0],he=[1],ge=[2],ye=[3],ue=[4],xe=[5],fe=[6],ze=[7],_e=[].concat(pe,he),Le=[].concat(ge,ye),be=[].concat(ue,xe),we=[].concat(fe,ze),Me=[].concat(pe,ge),Ce=[].concat(he,ye),Pe=[].concat(ue,fe),De=[].concat(xe,ze),Re=[].concat(pe,xe),Fe=[].concat(he,ue),Ae=[].concat(ge,ze),Ie=[].concat(ye,fe),Ee=[].concat(_e,Le),Oe=[].concat(be,we),je={px_py_pz:pe,px_py_nz:he,px_ny_pz:ge,px_ny_nz:ye,nx_py_nz:ue,nx_py_pz:xe,nx_ny_nz:fe,nx_ny_pz:ze,px_py:_e,px_ny:Le,nx_py:be,nx_ny:we,px_pz:Me,px_nz:Ce,nx_nz:Pe,nx_pz:De,py_pz:Re,py_nz:Fe,ny_pz:Ae,ny_nz:Ie,px:Ee,nx:Oe,py:[].concat(_e,be),ny:[].concat(Le,we),pz:[].concat(Me,De),nz:[].concat(Ce,Pe),all:[].concat(Ee,Oe)},Be=(...e)=>e.reduceRight((e,r)=>(...t)=>e(r(...t))),Se=e=>(...r)=>t=>e(t,...r),Te=e=>e[Math.floor(Math.random()*e.length)],Ve=(e,r,t)=>{e.a===r&&(e.vertexColors[0]=t),e.b===r&&(e.vertexColors[1]=t),e.c===r&&(e.vertexColors[2]=t)},We=Se((e,r)=>(Object.keys(r).map(t=>{var i=R(n(),r[t]),a=je[t];e.faces.map(e=>a.map(r=>Ve(e,r,i)))}),e)),ke=(Se((e,r)=>{var t=R(n(),r);return e.faces.map(e=>{for(var r=0;r<3;r++)void 0===e.vertexColors[r]&&(e.vertexColors[r]=t)}),e}),(e,r,t)=>({a:e,b:r,c:t,color:n(1,1,1),vertexColors:[]})),qe=e=>({a:e.a,b:e.b,c:e.c,color:s(e.color),vertexColors:e.vertexColors.map(s)}),He=(e,r,t)=>{var i,a=e.vertices.length;for(i=0;i<r.length;i+=3)e.vertices.push(n(r[i],r[i+1],r[i+2]));for(i=0;i<t.length;i+=3)e.faces.push(ke(a+t[i],a+t[i+1],a+t[i+2]));return e},Ne=(()=>{var e=n();return(r,t,i,n)=>(a(e,t,i,n),r.vertices.map(r=>v(r,e)),r)})(),Ge=(()=>{var e=n();return(r,t,i,n)=>(a(e,t,i,n),r.vertices.map(r=>h(r,e)),r)})(),Ue=(e,r)=>{var t=e.vertices.length;return e.vertices.push(...r.vertices.map(s)),e.faces.push(...r.faces.map(e=>{var r=qe(e);return r.a+=t,r.b+=t,r.c+=t,r})),e},Ke=e=>{var r={vertices:[],faces:[]};return r.vertices=e.vertices.map(s),r.faces=e.faces.map(qe),r},Ye=Se(Ne),Xe=Se(Ge),$e=(e,r,t)=>{var i=e/2,n=r/2,a=t/2;return He({vertices:[],faces:[]},[i,n,a,i,n,-a,i,-n,a,i,-n,-a,-i,n,-a,-i,n,a,-i,-n,-a,-i,-n,a],[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4])},Je=(e,r,t=n())=>(a(t,0,0,0),r.map(r=>v(t,e.vertices[r])),u(t,r.length),t),Qe=(()=>{var e=n();return(r,t)=>(Je(r,je[t],e),Ne(r,-e.x,-e.y,-e.z))})(),Ze=(()=>{var e=n(),r=n(),t=n();return(i,n,a,o)=>{var c=je[n],s=je[o];return Je(i,c,e),Je(a,s,r),p(t,r,e),Ne(i,t.x,t.y,t.z)}})(),er=Se(Qe),rr=(Se(Ze),(()=>{var e=n();return(r,t=n())=>(i,n)=>(Object.keys(n).map(a=>{var c=n[a],s=je[a];if(Array.isArray(c))R(e,c);else if("object"==typeof c)Object.assign(e,t,c);else{if("number"!=typeof c)return;o(e,c)}s.map(t=>r(i.vertices[t],e))}),i)})()),tr=(Se(rr(v)),Se(rr(h,n(1,1,1)))),ir=(()=>{var e=n();return(r,t=n())=>i=>(n,a)=>(Object.keys(a).map(o=>{var{[o]:c=t[i]}=a,s=je[o];Object.assign(e,t),e[i]=c,s.map(t=>r(n.vertices[t],e))}),n)})()(v),nr=(Se(ir("x")),Se(ir("y"))),ar=(Se(ir("z")),e=>(r,t)=>(Object.keys(t).map(i=>{var n=t[i];je[i].map(t=>e(r.vertices[t],n))}),r)),or=(Se(ar(R)),Se(ar((e,r)=>(e.x=r,e))),Se(ar((e,r)=>(e.y=r,e))),Se(ar((e,r)=>(e.z=r,e))),(e=n(),r=1)=>Object.assign(Y(),{color:e,intensity:r,target:Y()})),cr=()=>{var e={};return document.addEventListener("keydown",r=>e[r.code]=!0),document.addEventListener("keyup",r=>e[r.code]=!1),e},sr=(e,r)=>e+Math.random()*(r-e),vr=()=>({color:n(1,1,1),specular:n(1/15,1/15,1/15),shininess:30,emissive:n()}),lr=(e,r)=>Object.assign(Y(),{geometry:e,material:r}),dr=(e=n(1/0,1/0,1/0),r=n(-1/0,-1/0,-1/0))=>({min:e,max:r}),mr=(e,r)=>(Object.assign(e.min,r.min),Object.assign(e.max,r.max),e),pr=e=>(e.min.x=e.min.y=e.min.z=1/0,e.max.x=e.max.y=e.max.z-=1/0,e),hr=(e,r)=>(x(e.min,r),f(e.max,r),e),gr=(()=>{var e=n();return(r,t)=>(re(t),pr(r),Z(t,t=>{var{geometry:i}=t;i&&i.vertices.map(i=>{Object.assign(e,i),w(e,t.matrixWorld),hr(r,e)})}),r)})(),yr=(e,r)=>!(e.max.x<r.min.x||e.min.x>r.max.x||e.max.y<r.min.y||e.min.y>r.max.y||e.max.z<r.min.z||e.min.z>r.max.z),ur=(e,r)=>(v(e.min,r),v(e.max,r),e),xr=(e=n(),r=n())=>({origin:e,direction:r}),fr=(e,r)=>(Object.assign(e.origin,r.origin),Object.assign(e.direction,r.direction),e),zr=(e,r,t=n())=>v(g(Object.assign(t,e.direction),r),e.origin),Lr=(e,r,t)=>{var{origin:i,direction:n}=e,a=(r.min.x-i.x)/n.x,o=(r.max.x-i.x)/n.x;a>o&&([a,o]=[o,a]);var c=(r.min.y-i.y)/n.y,s=(r.max.y-i.y)/n.y;if(c>s&&([c,s]=[s,c]),!(a>s||c>o)){var v=c>a||a!==a?c:a,l=s<o||o!==o?s:o,d=(r.min.z-i.z)/n.z,m=(r.max.z-i.z)/n.z;if(d>m&&([d,m]=[m,d]),!(v>m||d>l||(v=d>v||v!==v?d:v,(l=m<l||l!==l?m:l)<0)))return zr(e,v>=0?v:l,t)}},br=(()=>{var e=n(),r=n(),t=n(),i=n(),a=n();return(n,o,c,s)=>{p(r,c,o),p(t,s,o),z(i,n.direction,t);var v=_(r,i);if(v){p(e,n.origin,o);var l=_(e,i);if(!(0>l||l>v)){z(a,e,r);var d=_(n.direction,a);if(!(0>d||l+d>v))return _(t,a)/v}}}})(),wr=(()=>{var e=A(),r=xr(),t=n(),i=n(),a=(e,r,t,n,a,o)=>{var c=br(r,t,n,a);if(c)return zr(r,c,o),Object.assign(i,o),w(i,e.matrixWorld),{t:c,object:e,distance:C(r.origin,i),point:s(i)}};return(i,n)=>{var o=[];T(e,n.matrixWorld),Mr(fr(r,i),e);var{vertices:c,faces:s}=n.geometry;return s.map((e,i)=>{var s=c[e.a],v=c[e.b],l=c[e.c],d=a(n,r,s,v,l,t);d&&(d.face=e,d.faceIndex=i,o.push(d))}),o}})(),Mr=(e,r)=>(w(e.origin,r),y(e.direction,r),e),Cr=(e,r)=>[].concat(...r.map(r=>wr(e,r))).sort((e,r)=>e.distance-r.distance),Pr=1,Dr=2,Rr=(e,r)=>ce({physics:r,shape:1,boundingBox:gr(dr(),e),velocity:n(),update(e,r){d(e.parent.position,e.velocity,r)}}),Fr=(e,r)=>se(e,Rr(e,r)),Ar=e=>e.physics,Ir=e=>{var r=[];return Z(e,e=>{r.push(...de(e,Ar))}),r},Er=(()=>{var e=n(),r=xr();return{[1](r,t,i,n){var o=n.max.x-i.min.x,c=i.max.x-n.min.x,s=n.max.y-i.min.y,l=i.max.y-n.min.y,d=n.max.z-i.min.z,p=i.max.z-n.min.z,h=0;o>0&&c>0&&(h=o<c?o:-c);var y=0;s>0&&l>0&&(y=s<l?s:-l);var u=0;d>0&&p>0&&(u=d<p?d:-p);var x=Math.abs(h),f=Math.abs(y),z=Math.abs(u);x<f&&x<z?a(e,h,0,0):f<z?a(e,0,y,0):a(e,0,0,u);var _=r.parent,L=t.parent;r.physics===Pr?m(L.position,e):t.physics===Pr?v(_.position,e):(g(e,.5),v(_.position,e),m(L.position,e))},[1|Dr](e,t,i,n){e.shape===Dr&&([e,t]=[t,e],[i,n]=[n,i]);var o=i,c=e.parent,s=t.parent;Object.assign(r.origin,c.position),a(r.direction,0,-1,0);var v=wr(r,s);if(v.length){v.sort((e,r)=>e.distance-r.distance);var l=v[0].point,d=o.min.y-l.y;d<=0&&(c.position.y-=d)}}}})(),Or=(()=>{var e=dr(),r=dr();return t=>{for(var i=[],n=0;n<t.length;n++)for(var a=t[n],o=n+1;o<t.length;o++){var c=t[o];if(a.physics===Pr&&c.physics===Pr)return;var s=a.parent,v=c.parent;if(ur(mr(e,a.boundingBox),s.position),ur(mr(r,c.boundingBox),v.position),yr(e,r)){var l=Er[a.shape|c.shape](a,c,e,r);l&&i.push(l)}}return i}})(),jr=1,Br=2,Sr=()=>{var e=Be(er("ny"),Xe(-1,1,1),nr({all:1})),r=e($e(.5,256,.5)),t=vr();a(t.emissive,1,1,1);var i=lr(r,t),o=e($e(.75,256,.75)),c=vr();a(c.emissive,1,.25,.25);var s=lr(o,c),v=er("nz")($e(.1,.1,1)),d=vr();a(d.emissive,1,.5,.5);var m=lr(v,d),h=[.8,1,.8],y=Be(tr({ny:[0,1,0]}),er("py"))($e(...h)),u=Ue(Be(tr({pz:[0,0,1]}),er("nz"))($e(.6,.6,1.5)),Be(tr({nz:[0,0,1]}),er("pz"))($e(.6,.6,1))),x=Ne(Ke(u),-h[0],0,0),f=Ne(Ke(u),h[0],0,0),z=Ue(Be(tr({py:[0,1,0]}),er("ny"))($e(...h)),Ke(y));Ne(y,0,h[1],0),Ne(z,0,-h[1],0);var _=[y,x,f,z].reduce(Ue),w=vr();a(w.color,.5,.5,.5),a(w.specular,1,1,1),a(w.emissive,.5,0,.1);var M=Fr(lr(_,w),2);$(M,i),$(M,s),$(M,m);var D,R,F=xr(),A=2*Math.random()*Math.PI,I=Math.PI,E=I,O=n(),j=n(),B=dr(),S=jr;return se(M,ce({update(e,r,t){var{player:i,walls:n}=t;if(S===jr)A+=E*r%(2*Math.PI);else if(S===Br){var o=p(j,i.position,M.position);A=Math.atan2(o.z,o.x)}Object.assign(F.origin,M.position),a(F.direction,Math.cos(A),0,Math.sin(A)),l(O,F.origin,F.direction),X(M,O);var c,s=Cr(F,n).filter(e=>e.t>0);s.length&&(c=s[0].distance);var v=!1;mr(B,le(i,Ar).boundingBox),ur(B,i.position);var d=Lr(F,B);if(d){var h=C(d,M.position);h<c&&(v=!0,X(M,Object.assign(O,i.position,{y:M.position.y})),c=h)}m.scale.z=c,v?(E=0,S=Br,_o.classList.add("e"),i.meta.hits++,setTimeout(()=>_o.classList.remove("e"),300)):(E=I,S=jr);var y=le(M,Ar),u=y.velocity;if(S===jr){var{nodes:x,navMesh:f}=t,z=()=>{var e,r,t=1/0;return x.map(i=>{(r=P(M.position,i))<t&&(t=r,e=i)}),e};D||(D=z());var _=1/0;if(R&&(p(j,R,M.position),j.y=0,_=L(j)),!R||_<5){do{var w=f[x.indexOf(D)];R=x[Te(w)]}while(R===D);D=R}u=p(y.velocity,R,M.position)}else S===Br&&(u=p(y.velocity,i.position,M.position));u.y=0,g(b(u),10)}}))},Tr=.5*(Math.sqrt(3)-1),Vr=(3-Math.sqrt(3))/6,Wr=new Uint8Array(512),kr=new Uint8Array(512),qr=0;qr<512;qr++){var Hr=512*Math.random();Wr[qr]=Hr[255&qr],kr[qr]=Wr[qr]%12}var Nr=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),Gr=(e,r)=>{var t,i,n=0,a=0,o=0,c=(e+r)*Tr,s=Math.floor(e+c),v=Math.floor(r+c),l=(s+v)*Vr,d=e-(s-l),m=r-(v-l);d>m?(t=1,i=0):(t=0,i=1);var p=d-t+Vr,h=m-i+Vr,g=d-1+2*Vr,y=m-1+2*Vr,u=255&s,x=255&v,f=.5-d*d-m*m;if(f>=0){var z=3*kr[u+Wr[x]];n=(f*=f)*f*(Nr[z]*d+Nr[z+1]*m)}var _=.5-p*p-h*h;if(_>=0){var L=3*kr[u+t+Wr[x+i]];a=(_*=_)*_*(Nr[L]*p+Nr[L+1]*h)}var b=.5-g*g-y*y;if(b>=0){var w=3*kr[u+1+Wr[x+1]];o=(b*=b)*b*(Nr[w]*g+Nr[w+1]*y)}return 70*(n+a+o)},Ur=(e,r)=>{for(var t=1/16,i=.5,n=0,a=0;a<8;a++)n+=i*Gr(e*t,r*t),t*=2,i*=.5;return n},Kr=(e,r=n(1,1,1))=>{var t=[];return e.map((i,n)=>i.map((a,o)=>{n<e.length-1&&o<i.length-1&&t.push(Be(Ye(r.x*(o+.5),0,r.z*(n+.5)),nr({nx_py_nz:r.y*a,px_py_nz:r.y*i[o+1],nx_py_pz:r.y*e[n+1][o],px_py_pz:r.y*e[n+1][o+1]}))($e(r.x,r.y,r.z)))})),t},Yr=(e,r)=>e.map(e=>e.split("").map(e=>r.indexOf(e))),Xr=(e,r)=>{for(var t=[],i=0;i<r;i++){t[i]=[];for(var n=0;n<e;n++)t[i][n]=Ur(i,n)}return t},$r=(e,r,t)=>{r.player=t,r.player.meta={hits:0};var i=[.11,.12,.15];e.clearColor(...i,1),a(r.fogColor,...i),r.fogFar=128;var o=Y();$(r,o),a(t.position,78,5,0),ie(t,n(0,24,0));var c=Rr(lr($e(2,4,2)),2);se(t,c);var s=Y();$(s,t),$(o,s);var v=cr(),l=n(),d=100,m=e=>{var r=0,i=0;(v.KeyW||v.ArrowUp)&&i--,(v.KeyS||v.ArrowDown)&&i++,(v.KeyA||v.ArrowLeft)&&r--,(v.KeyD||v.ArrowRight)&&r++,(r||i)&&(b(a(l,r,0,i)),Q(t,l,6*e),t.position.y=Math.min(t.position.y,8))};se(o,ce({update(r,i,n){if(m(i),n.physics=Or(Ir(o)),t.position.y-=16*i,_h.textContent=Math.round(d),n.player.meta.hits>0&&(d-=20*i),n.player.meta.hits=0,d<=0){J(n,o);var a=()=>{$r(e,n,t),_r.classList.add("_n"),document.removeEventListener("click",a)};_r.classList.remove("_n"),document.exitPointerLock(),document.addEventListener("click",a)}}}));var p=vr();a(p.color,.25,.28,.325),p.shininess=10;var h=Xr(64,64),g=lr(Kr(h,n(156/63,1.5,180/63)).reduce(Ue),p),y=Rr(g,Pr);y.shape=Dr,a(g.position,-78,1,-84),se(g,y),$(o,g);var u=Jr(6);u.map(e=>$(o,e)),r.walls=u;var x=Qr(6),f=Zr(x,u);r.nodes=x,r.navMesh=f;for(var z=0;z<6;z++){var _=Sr();Object.assign(_.position,Te(x),{y:3}),$(o,_)}var L=Kr(Yr([" 110000","0102253","0003464"," 032000"],"0123456"),n(7.5,8,10)).reduce(Ue);Ye(-22.5,3,-15)(L),$(o,lr(L,p));var w=n(.5,.5,.55),M=or(n(.2,.3,.4),4);a(M.position,128,48,0);var C=[M];return C.map(e=>$(o,e)),{ambient:w,directional:C}},Jr=e=>{var r=e,t=er("ny"),i=er("ny_pz"),n=er("ny_nz"),a=$e(e,r,30*e),o=$e(28*e,r,e),c=Be(n,Ye(0,0,16*e))(Ke(o)),s=Be(i,Ye(0,0,-14*e))(Ke(o)),v=Be(er("px_ny"),Ye(-13*e,0,e))(Ke(a)),l=Be(er("nx_ny"),Ye(13*e,0,e))(Ke(a)),d=t=>{var a=(r,i)=>Ye(r*e*t,0,i*e),o=()=>sr(r,1.2*r);return[Be(i,a(10,-10))($e(4*e,o(),3*e)),Be(i,a(4.5,-10))($e(5*e,o(),3*e)),Be(i,a(10,-7))($e(4*e,o(),2*e)),Be(i,a(6,-1))($e(2*e,o(),8*e)),Be(i,a(3.5,-4))($e(3*e,o(),2*e)),Be(i,a(10.5,-1))($e(5*e,o(),5*e)),Be(n,a(9.5,1))($e(5*e,o(),5*e)),Be(n,a(6,1))($e(2*e,o(),5*e)),Be(n,a(11,7))($e(2*e,o(),2*e)),Be(n,a(9,7))($e(2*e,o(),5*e)),Be(n,a(4.5,7))($e(5*e,o(),2*e)),Be(n,a(12,10))($e(2*e,o(),2*e)),Be(n,a(6,10))($e(2*e,o(),3*e)),Be(n,a(7,13))($e(10*e,o(),2*e))]},m=[Be(t,Ye(0,0,-12*e))($e(2*e,r,4*e)),Be(t,Ye(0,0,-8*e))($e(8*e,r,2*e)),Be(t,Ye(0,0,-5.5*e))($e(2*e,r,3*e)),t($e(8*e,r,6*e)),Be(t,Ye(0,0,5*e))($e(8*e,r,2*e)),Be(t,Ye(0,0,7.5*e))($e(2*e,r,3*e)),Be(t,Ye(0,0,11*e))($e(8*e,r,2*e)),Be(t,Ye(0,0,13.5*e))($e(2*e,r,3*e))],p=We({py:[.5,.5,.55],ny:[.2,.2,.25]});return[c,s,v,l,...d(-1),...d(1),...m].map(e=>Fr(lr(p(e),vr()),Pr))},Qr=e=>{var r=r=>[[12.5,-13.5],[7.5,-13.5],[1.5,-13.5],[12.5,-9.5],[7.5,-9.5],[4.5,-9.5],[1.5,-9.5],[12.5,-6.5],[7.5,-6.5],[4.5,-6.5],[1.5,-6.5],[4.5,-3.5],[1.5,-3.5],[12.5,0],[7.5,0],[4.5,0],[4.5,3.5],[12.5,6.5],[7.5,6.5],[4.5,6.5],[1.5,6.5],[12.5,9.5],[10.5,9.5],[7.5,9.5],[4.5,9.5],[1.5,9.5],[12.5,12.5],[10.5,12.5],[7.5,12.5],[4.5,12.5],[1.5,12.5],[12.5,15.5],[1.5,15.5]].map(([t,i])=>n(t*e*r,0,i*e));return[...r(-1),...r(1)]},Zr=(e,r)=>{var t,i=[];for(t=0;t<e.length;t++)i[t]=[];var n=xr();for(t=0;t<e.length;t++){Object.assign(n.origin,e[t]);for(var a=t+1;a<e.length;a++){p(n.direction,e[a],e[t]);var o=L(n.direction),c=Cr(n,r).filter(e=>e.t>0);(!c.length||o<c[0].distance)&&(i[t].push(a),i[a].push(t))}}return i},et=(e,r)=>{var t=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),t},rt=(e,r,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(r),e.vertexAttribPointer(r,i,e.FLOAT,!1,0,0)},tt=(e,r,t)=>{e.uniform1f(r,t)},it=(e,r,t)=>{e.uniformMatrix4fv(r,!1,t)},nt=(e,r,t)=>{e.uniform3f(r,t.x,t.y,t.z)},at=c.getContext("webgl");at.enable(at.DEPTH_TEST),at.enable(at.CULL_FACE),at.getExtension("OES_standard_derivatives");var ot=!0,ct=Y();ct.fogColor=n(1,1,1),ct.fogNear=1,ct.fogFar=1e3;var st=((e=60,r=1,t=.1,i=2e3)=>{var n=Object.assign(Y(),{fov:e,near:t,far:i,aspect:r,up:s(F),matrixWorldInverse:A(),projectionMatrix:A()});return ne(n),n})();((e,r)=>{"pointerLockElement"in document?(document.addEventListener("pointerlockchange",()=>{e.enabled=r===document.pointerLockElement}),document.addEventListener("click",()=>r.requestPointerLock())):e.enabled=!0})((e=>{var r={object:e,turnRate:Math.PI/4,sensitivity:.002,enabled:!1,onMouseMove(t){if(r.enabled){var{movementX:i,movementY:n}=t,a=-n*r.sensitivity,o=-i*r.sensitivity;K(q(ae,a,0,0,1)),K(q(oe,0,o,0,1)),H(e.quaternion,ae),H(oe,e.quaternion),Object.assign(e.quaternion,oe)}}};return document.addEventListener("mousemove",r.onMouseMove),r})(st),c);var vt=$r(at,ct,st),lt=((e,r,t)=>{var i=e.createProgram(),n=(r,t)=>{var n=e.createShader(r);e.shaderSource(n,t),e.compileShader(n),e.attachShader(i,n)};return n(e.VERTEX_SHADER,r),n(e.FRAGMENT_SHADER,t),e.linkProgram(i),i})(at,"precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;varying vec3 vViewPosition;attribute vec3 color;varying vec3 vColor;void main(){vColor.xyz=color.xyz;vec4 mvPosition=modelViewMatrix*vec4(position,1.0);gl_Position=projectionMatrix*mvPosition;vViewPosition=-mvPosition.xyz;}","#extension GL_OES_standard_derivatives : enable\nprecision highp float;precision highp int;\n#define RECIPROCAL_PI 0.31830988618\n#define saturate(a)clamp(a,0.0,1.0)\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;struct IncidentLight{vec3 color;vec3 direction;};struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;};varying vec3 vColor;uniform vec3 fogColor;uniform float fogNear;uniform float fogFar;vec3 BRDF_Diffuse_Lambert(const in vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}vec3 F_Schlick(const in vec3 specularColor,const in float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_BlinnPhong_Implicit(){return 0.25;}float D_BlinnPhong(const in float shininess,const in float dotNH){return RECIPROCAL_PI*(shininess*0.5+1.0)*pow(dotNH,shininess);}vec3 BRDF_Specular_BlinnPhong(const in IncidentLight incidentLight,const in GeometricContext geometry,const in vec3 specularColor,const in float shininess){vec3 halfDir=normalize(incidentLight.direction+geometry.viewDir);float dotNH=saturate(dot(geometry.normal,halfDir));float dotLH=saturate(dot(incidentLight.direction,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_BlinnPhong_Implicit();float D=D_BlinnPhong(shininess,dotNH);return F*(G*D);}uniform vec3 ambientLightColor;vec3 getAmbientLightIrradiance(const in vec3 ambientLightColor){vec3 irradiance=ambientLightColor;return irradiance;}struct DirectionalLight{vec3 direction;vec3 color;};uniform DirectionalLight directionalLights[NUM_DIR_LIGHTS];void getDirectionalDirectLightIrradiance(const in DirectionalLight directionalLight,const in GeometricContext geometry,out IncidentLight directLight){directLight.color=directionalLight.color;directLight.direction=directionalLight.direction;}varying vec3 vViewPosition;struct BlinnPhongMaterial{vec3 diffuseColor;vec3 specularColor;float specularShininess;};void RE_Direct_BlinnPhong(const in IncidentLight directLight,const in GeometricContext geometry,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;reflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);reflectedLight.directSpecular+=irradiance*BRDF_Specular_BlinnPhong(directLight,geometry,material.specularColor,material.specularShininess);}void RE_IndirectDiffuse_BlinnPhong(const in vec3 irradiance,const in GeometricContext geometry,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}void main(){vec3 diffuseColor=diffuse;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));diffuseColor*=vColor;vec3 fdx=vec3(dFdx(vViewPosition.x),dFdx(vViewPosition.y),dFdx(vViewPosition.z));vec3 fdy=vec3(dFdy(vViewPosition.x),dFdy(vViewPosition.y),dFdy(vViewPosition.z));vec3 normal=normalize(cross(fdx,fdy));BlinnPhongMaterial material;material.diffuseColor=diffuseColor;material.specularColor=specular;material.specularShininess=shininess;GeometricContext geometry;geometry.position=-vViewPosition;geometry.normal=normal;geometry.viewDir=normalize(vViewPosition);IncidentLight directLight;DirectionalLight directionalLight;for(int i=0;i<NUM_DIR_LIGHTS;i++){directionalLight=directionalLights[i];getDirectionalDirectLightIrradiance(directionalLight,geometry,directLight);RE_Direct_BlinnPhong(directLight,geometry,material,reflectedLight);}vec3 irradiance=getAmbientLightIrradiance(ambientLightColor);RE_IndirectDiffuse_BlinnPhong(irradiance,geometry,material,reflectedLight);vec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissive;float depth=gl_FragCoord.z/gl_FragCoord.w;float fogFactor=smoothstep(fogNear,fogFar,depth);gl_FragColor=vec4(mix(outgoingLight,fogColor,fogFactor),1.0);}".replace(/NUM_DIR_LIGHTS/g,vt.directional.length));at.useProgram(lt);var dt,mt=((e,r)=>{for(var t={},i=e.getProgramParameter(r,e.ACTIVE_ATTRIBUTES),n=0;n<i;n++){var a=e.getActiveAttrib(r,n),{name:o}=a;t[o]=e.getAttribLocation(r,o)}return t})(at,lt),pt=((e,r)=>{for(var t={},i=e.getProgramParameter(r,e.ACTIVE_UNIFORMS),n=0;n<i;n++){var a=e.getActiveUniform(r,n),{name:o}=a;t[o]=e.getUniformLocation(r,o)}return t})(at,lt),ht=0,gt=()=>{var e=.001*(performance.now()||0);dt||(dt=e);var r=Math.min(e-dt,.1);for(ht+=r,dt=e;ht>=1/60;)Z(ct,e=>{me(e,1/60,ct)}),ht-=1/60},yt=new WeakMap,ut=(e,r,t,i)=>{var n=yt.get(t);n||(n={},yt.set(t,n));var a=n[e];a||(a=et(at,t.attrs[e]),n[e]=a),rt(at,r,a,i)},xt=new WeakMap,ft=e=>{var{geometry:r,material:i}=e;nt(at,pt.fogColor,ct.fogColor),tt(at,pt.fogNear,ct.fogNear),tt(at,pt.fogFar,ct.fogFar),nt(at,pt.diffuse,i.color),nt(at,pt.specular,i.specular),tt(at,pt.shininess,i.shininess),nt(at,pt.emissive,i.emissive),B(e.modelViewMatrix,st.matrixWorldInverse,e.matrixWorld),it(at,pt.modelViewMatrix,e.modelViewMatrix),it(at,pt.projectionMatrix,st.projectionMatrix);var n=xt.get(r);n||(n=t({attrs:{}},r),xt.set(r,n)),ut("position",mt.position,n,3),ut("color",mt.color,n,3),at.drawArrays(at.TRIANGLES,0,n.attrs.position.length/3)},zt=n(),_t=n(),Lt=()=>{re(ct),T(st.matrixWorldInverse,st.matrixWorld),at.clear(at.COLOR_BUFFER_BIT|at.DEPTH_BUFFER_BIT),nt(at,pt.ambientLightColor,vt.ambient),vt.directional.map((e,r)=>{var t=D(_t,e.matrixWorld);D(zt,e.target.matrixWorld),y(m(t,zt),st.matrixWorldInverse);var i=g(Object.assign(zt,e.color),e.intensity);nt(at,pt[`directionalLights[${r}].direction`],t),nt(at,pt[`directionalLights[${r}].color`],i)}),Z(ct,e=>{e.visible&&e.geometry&&e.material&&ft(e)})},bt=()=>{gt(),Lt(),ot&&requestAnimationFrame(bt)},wt=(e,r)=>{c.width=e,c.height=r,at.viewport(0,0,e,r),st.aspect=e/r,ne(st)};wt(window.innerWidth,window.innerHeight),bt(),window.addEventListener("resize",()=>{wt(window.innerWidth,window.innerHeight),Lt()}),document.addEventListener("keypress",e=>{"KeyP"===e.code&&(ot=!ot)&&bt()})}();