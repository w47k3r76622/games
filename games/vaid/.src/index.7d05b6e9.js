class t{constructor(t){this.game=t,this.ctx=this.game.context}draw(){this.game.context.strokeStyle="#0F0",this.game.debug&&this.width&&this.height&&(this.game.context.beginPath(),this.game.context.rect(this.pos.x-this.width/2,this.pos.y-this.height/2,this.width,this.height),this.game.context.stroke()),this.game.debug&&this.radius&&(this.game.context.beginPath(),this.game.context.arc(this.pos.x,this.pos.y,this.radius,0,2*Math.PI),this.game.context.stroke()),this.game.debug&&this.pickupRadius&&(this.game.context.beginPath(),this.game.context.arc(this.pos.x,this.pos.y,this.pickupRadius,0,2*Math.PI),this.game.context.stroke())}}class i{constructor(t,i){this.x=t,this.y=i}add(t,i){this.x+=t,this.y+=i}remove(t,i){this.x-=t,this.y-=i}scale(t,i){this.x*=t,this.y*=i}scaleRound(t,i){this.x*=t,this.y*=t,Math.abs(this.x)<i&&(this.x=0),Math.abs(this.y)<i&&(this.y=0)}divide(t){this.x=this.x/t,this.y=this.y/t}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){this.divide(this.magnitude())}static randomVector(t,s){const e=new i(2*Math.random()-1,2*Math.random()-1);return e.normalize(),e.scale(t,s),e}}class s{constructor(t,i){this.goal=t,this.cb=i,this.ticks=0}update(t){this.ticks+=t,this.ticks>this.goal&&(this.cb(),this.removeable=!0)}}class e extends t{constructor(t){super(t),this.cooldown=5e3,this.canFire=!0}fire(t){if(!this.canFire)return;this.game.hud.toggleBomb(),this.bombing=!0,this.canFire=!1,this.game.camera.shake(300),this.game.sounds.sfx(4),this.game.timers.push(new s(this.cooldown,(()=>{this.canFire=!0,this.bombing=!1,this.game.hud.toggleBomb()}))),this.pos=new i(t.pos.x,t.pos.y),this.bombArea=this.game.world.bomb(this);this.game.enemies.filter((t=>t.pos.x>this.bombArea.x&&t.pos.x<this.bombArea.x+this.bombArea.w&&t.pos.y>this.bombArea.y&&t.pos.y<this.bombArea.y+this.bombArea.h)).forEach((t=>{t.hit()}))}update(){}draw(){if(this.bombing&&this.bombArea.counter<100){let t=2*this.bombArea.counter;this.game.context.beginPath(),this.game.context.fillStyle=`rgba(255,232,8,${.9-this.bombArea.counter/100})`,this.game.context.arc(this.bombArea.startX,this.bombArea.startY,t,0,2*Math.PI),this.game.context.fill(),this.game.context.beginPath(),this.game.context.fillStyle=`rgba(255,154,0,${.7-this.bombArea.counter/100})`,this.game.context.arc(this.bombArea.startX,this.bombArea.startY,t/2,0,2*Math.PI),this.game.context.fill(),this.game.context.beginPath(),this.game.context.fillStyle=`rgba(255,0,0,${.5-this.bombArea.counter/100})`,this.game.context.arc(this.bombArea.startX,this.bombArea.startY,t/3,0,2*Math.PI),this.game.context.fill(),this.bombArea.counter+=5,t>this.bombArea.w/1.5&&(this.bombing=!1)}}}class h extends t{constructor(t,s,e){super(t),this.pos=s,this.vel=e,this.originalPos=new i(s.x,s.y),this.shadowPos=new i(s.x-10*this.vel.x,s.y-10*this.vel.y),this.life=0,this.angle=Math.atan(e.y/e.x)-Math.PI/2}hit(){const t=new i(2*Math.random()-1,2*Math.random()-1);t.normalize(),t.scale(2,2),this.life<=0&&(this.removeable=!0),this.life--}update(){this.pos.add(this.vel.x,this.vel.y),this.shadowPos.add(this.vel.x,this.vel.y),this.game.camera.outsideViewport(this.pos.x,this.pos.y)&&(this.removeable=!0)}draw(){super.draw(),this.game.context.save(),this.game.context.shadowBlur=20,this.game.context.shadowColor=this.color;const t=this.game.context.createLinearGradient(0|this.shadowPos.x,0|this.shadowPos.y,0|this.pos.x,0|this.pos.y);t.addColorStop("0","rgba(255,255,255,0)"),t.addColorStop("1","rgba(255,255,255,1)"),this.game.context.strokeStyle=t,this.game.context.beginPath(),this.game.context.moveTo(this.shadowPos.x,this.shadowPos.y),this.game.context.lineTo(this.pos.x,this.pos.y),this.game.context.closePath(),this.game.context.stroke(),this.game.context.restore(),this.game.context.save(),this.game.context.translate(this.pos.x,this.pos.y),this.game.context.rotate(this.angle),this.game.context.beginPath(),this.game.context.shadowBlur=20,this.game.context.shadowColor=this.color,this.game.context.fillStyle=this.color,this.game.context.ellipse(0,0,this.radius,4*this.radius,0,0,2*Math.PI),this.game.context.arc(0,0,this.radius,0,2*Math.PI),this.game.context.fill(),this.game.context.restore()}}class o extends h{constructor(t,i,s,e){super(t,i,s),this.color="#FEF1BA",this.radius=8,this.life=e}}class a extends h{constructor(t,i,s,e){super(t,i,s),this.color="#FF0000",this.radius=4,e||(this.life=0)}}class n extends t{constructor(t){super(t),this.pos=new i(0,0),this.bulletsFired=1,this.cooldown=600,this.canFire=!0,this.canBomb=!0,this.bulletLife=0,document.addEventListener("mousemove",(t=>{this.pos.x=t.clientX,this.pos.y=t.clientY}))}fire(t){if(!this.canFire)return;this.game.timers.push(new s(this.cooldown,(()=>{this.canFire=!0}))),this.canFire=!1;const e=this.game.camera.screenToWorld(this.pos.x,this.pos.y);let h={};this.mouseAim?(h=new i(e.x,e.y),h.remove(t.pos.x,t.pos.y),h.normalize(),h.scale(12,12)):h=new i(12*Math.cos(t.angle),12*Math.sin(t.angle)),this.game.bullets.push(new o(this.game,new i(t.pos.x,t.pos.y),h,this.bulletLife)),this.bulletsFired>1&&this.game.bullets.push(new o(this.game,new i(t.pos.x,t.pos.y),new i(-1*h.x,-1*h.y),this.bulletLife)),this.bulletsFired>2&&this.game.bullets.push(new o(this.game,new i(t.pos.x,t.pos.y),new i(h.y,-1*h.x),this.bulletLife)),this.bulletsFired>3&&this.game.bullets.push(new o(this.game,new i(t.pos.x,t.pos.y),new i(-1*h.y,h.x),this.bulletLife))}bomb(t){this.canBomb&&(this.bomb.pos=t.pos,this.game.world.bomb(t))}update(){this.canBomb&&this.bomb.pos&&this.game.context.strokeRect(this.bomb.pos.x*this.game.world.tileWidth,this.bomb.pos.x*this.game.world.tileWidth,this.bomb.size*this.game.world.tileWidth,this.bomb.size*this.game.world.tileWidth)}draw(){}}class r extends t{constructor(t,i,s){super(t),this.pos=i,this.vel=s,this.vel.scale(-2*Math.random()+4*Math.random(),-2*Math.random()+4*Math.random()),this.width=2,this.height=2,this.alpha=1}update(){this.width+=.4,this.height+=.4,this.vel.scale(.2,.2),this.alpha-=.03,this.pos.add(this.vel.x,this.vel.y),(this.width<0||this.height<0||this.alpha<0)&&(this.removeable=!0)}draw(){this.game.context.beginPath(),this.game.context.fillStyle=`rgba(255,255,255,${this.alpha})`,this.game.context.fillRect(this.pos.x-this.width/2,this.pos.y-this.height/2,this.width,this.height)}}class l extends t{constructor(t,s){super(t),this.angle=0,this.left=!1,this.pos=new i(200,200),this.vel=new i(0,0),this.gun=new n(t),this.bomb=new e(t),this.width=30,this.height=20,this.maxVelMagnitude=1,this.pickupRadius=100,this.life=s??10,this.radius=20,this.invulCooldown=5e3,this.invulPeriod=2e3,this.canInvulv=!0,this.isInvul=!1}handleKey(t,i){65===t&&(this.left=i),87===t&&(this.up=i),68===t&&(this.right=i),32===t&&(this.shooting=i),81===t&&(this.bombing=i),70===t&&(this.invul=i)}reset(){}hit(){this.isInvul||(this.life--,this.life<=0&&this.game.endGame())}update(){this.left&&(this.angle-=.05),this.right&&(this.angle+=.05),this.up&&(this.vel.add(Math.cos(this.angle),Math.sin(this.angle)),this.game.particles.push(new r(this.game,new i(this.pos.x,this.pos.y),new i(-this.vel.x,-this.vel.y)))),this.game.world.collidesShip(this),this.vel.magnitude()>this.maxVelMagnitude&&(this.vel.normalize(),this.vel.scale(this.maxVelMagnitude,this.maxVelMagnitude)),this.invul&&this.canInvulv&&!this.isInvul&&(this.game.hud.toggleShield(),this.isInvul=!0,this.canInvulv=!1,this.game.timers.push(new s(this.invulPeriod,(()=>this.isInvul=!1))),this.game.timers.push(new s(this.invulCooldown,(()=>{this.canInvulv=!0,this.game.hud.toggleShield()})))),this.shooting&&this.gun.fire(this),this.bombing&&this.bomb.fire(this),this.vel.scaleRound(.93,.1),this.pos.add(this.vel.x,this.vel.y),this.game.particles.forEach((t=>t.update())),this.gun.update()}draw(){this.drawLifeCircle(),this.game.context.save(),this.game.context.translate(this.pos.x>>0,this.pos.y>>0),this.game.context.rotate(this.angle),this.game.context.strokeStyle="#FFF",this.game.context.fillStyle="#FFF",this.game.context.lineWidth=1,this.game.context.beginPath(),this.game.context.moveTo(-this.width/2,-this.height/2),this.game.context.lineTo(this.width/2,0),this.game.context.lineTo(-this.width/2,this.height/2),this.game.context.closePath(),this.game.context.stroke(),this.game.context.fill(),this.game.context.restore(),super.draw(),this.gun.draw(this.pos),this.bomb.draw(this.pos)}drawLifeCircle(){this.game.context.save(),this.game.context.shadowBlur=20,this.game.context.shadowColor="#ffffff",this.isInvul?(this.game.context.fillStyle="#fcfbfe",this.game.context.beginPath(),this.game.context.arc(this.pos.x,this.pos.y,30,0,2*Math.PI,!1),this.game.context.arc(this.pos.x,this.pos.y,30-this.life,0,2*Math.PI,!0),this.game.context.fill()):(this.game.context.fillStyle=`rgba(0,255,255,${.8*this.life/5})`,this.game.context.beginPath(),this.game.context.arc(this.pos.x,this.pos.y,30,0,2*Math.PI,!1),this.game.context.arc(this.pos.x,this.pos.y,30-this.life,0,2*Math.PI,!0),this.game.context.fill()),this.game.context.restore()}}class d{constructor(t,i,s){this.game=i,s=s||{},this.distance=1e3,this.lookAt=[0,0],this.context=t,this.shaking=!1,this.fieldOfView=s.fieldOfView||Math.PI/4,this.viewport={left:0,right:0,top:0,bottom:0,width:0,height:0,scale:[1,1]},this.updateViewport()}begin(){this.context.save(),this.applyScale(),this.applyTranslation()}end(){this.context.restore()}applyScale(){this.context.scale(this.viewport.scale[0],this.viewport.scale[1])}applyTranslation(){this.shaking?this.context.translate(-this.viewport.left+10*Math.random()|0,-this.viewport.top+10*Math.random()|0):this.context.translate(-this.viewport.left,-this.viewport.top)}updateViewport(){this.aspectRatio=this.context.canvas.width/this.context.canvas.height,this.viewport.width=this.distance*Math.tan(this.fieldOfView),this.viewport.height=this.viewport.width/this.aspectRatio,this.viewport.left=this.lookAt[0]-this.viewport.width/2,this.viewport.top=this.lookAt[1]-this.viewport.height/2,this.viewport.right=this.viewport.left+this.viewport.width,this.viewport.bottom=this.viewport.top+this.viewport.height,this.viewport.scale[0]=this.context.canvas.width/this.viewport.width,this.viewport.scale[1]=this.context.canvas.height/this.viewport.height}zoomTo(t){this.distance=t,this.updateViewport()}shake(t){this.shaking||(this.shaking=!0,this.game.timers.push(new s(t,(()=>this.shaking=!1))))}moveTo(t,i){this.viewport.worldWidth<this.viewport.width?t=this.viewport.worldWidth/2:t<this.viewport.width/2?t=this.viewport.width/2:t>this.viewport.worldWidth-this.viewport.width/2&&(t=this.viewport.worldWidth-this.viewport.width/2),this.viewport.worldHeight<this.viewport.height?i=this.viewport.worldHeight/2:i<this.viewport.height/2?i=this.viewport.height/2:i>this.viewport.worldHeight-this.viewport.height/2&&(i=this.viewport.worldHeight-this.viewport.height/2),this.lookAt[0]=t,this.lookAt[1]=i,this.updateViewport()}setWorldSize(t,i){this.viewport.worldWidth=t,this.viewport.worldHeight=i,this.updateViewport()}screenToWorld(t,i,s){return(s=s||{}).x=t/this.viewport.scale[0]+this.viewport.left,s.y=i/this.viewport.scale[1]+this.viewport.top,s}worldToScreen(t,i,s){return(s=s||{}).x=(t-this.viewport.left)*this.viewport.scale[0],s.y=(i-this.viewport.top)*this.viewport.scale[1],s}outsideViewport(t,i){return t<this.viewport.left||t>this.viewport.right||i<this.viewport.top||i>this.viewport.bottom}}class p extends t{constructor(t,i){super(t),this.pos=i,this.radius=15,this.game.context.font=(this.game.world.tileWidth/2|0)+"px Arial";const s=this.game.context.measureText("🌒");this.textMeasure={width:s.width/2,height:(s.actualBoundingBoxAscent+s.actualBoundingBoxDescent)/2},this.alpha=1,this.isHit=!1}hit(){const t=new i(this.game.ship.pos.x-this.pos.x,this.game.ship.pos.y-this.pos.y);t.normalize(),t.scale(10,10),this.vel=t,this.isHit=!0}update(){this.isHit&&(this.pos.add(this.vel.x,this.vel.y),this.alpha-=.1,this.alpha<=0&&(this.game.hud.increaseMineral(),this.removeable=!0))}draw(){this.game.context.fillStyle=`rgba(255,255,255,${this.alpha}`,this.game.context.fillText("🌒",this.pos.x-this.textMeasure.width,this.pos.y+this.textMeasure.height)}}class c extends t{constructor(t,s,e,h,o){super(t),this.pos=s,this.vel=new i(2*Math.random()-1,2*Math.random()-1),this.vel.scale(Math.random(),Math.random()),this.width=5+Math.round(Math.random()*(o??5)),this.height=5+Math.round(Math.random()*(o??5)),this.alpha=h??1,this.color=`${255*Math.random()|0},${255*Math.random()|0},${255*Math.random()|0}`}update(){this.width+=.4,this.height+=.4,this.alpha-=.02,this.pos.add(this.vel.x,this.vel.y),(this.width<0||this.height<0||this.alpha<0)&&(this.removeable=!0)}draw(){this.game.context.save(),this.game.context.translate(this.pos.x,this.pos.y),this.game.context.rotate(Math.random()),this.game.context.fillStyle=`rgba(${this.color},${this.alpha})`,this.game.context.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.game.context.restore()}}class m extends t{constructor(t){super(t)}hit(){this.removeable=!0;for(let t=0;t<20;t++)this.game.particles.push(new c(this.game,new i(this.pos.x,this.pos.y),this.color));this.game.items.push(new p(this.game,new i(this.pos.x,this.pos.y)))}update(t){this.first&&(this.first=!1,this.game.timers.push(new s(this.coolDown,(()=>{this.canFire=!0}))))}draw(){this.game.context.save(),this.game.context.shadowBlur=20,this.game.context.shadowColor="#ffffff",this.game.context.beginPath(),this.game.context.fillStyle=this.color,this.game.context.arc(this.pos.x,this.pos.y,this.radius,0,2*Math.PI,!1),this.game.context.arc(this.pos.x,this.pos.y,this.radius-5,0,2*Math.PI,!0),this.game.context.fill(),this.game.context.beginPath(),this.game.context.fillStyle="#f3f3f3",this.game.context.arc(this.pos.x,this.pos.y,5,0,2*Math.PI,!0),this.game.context.fill(),this.game.context.restore()}}class g extends m{constructor(t,s,e){super(t),this.game=t,this.pos=new i(s,e),this.width=30,this.height=30,this.radius=15,this.coolDown=2e3+(5e3*Math.random()|0),this.canFire=!1,this.color="#c6849b",this.first=!0,this.angle=0}update(t){if(super.update(),this.canFire){this.canFire=!1,this.game.timers.push(new s(this.coolDown,(()=>this.canFire=!0)));const t=new i(-1+Math.random(2),-1+Math.random(2));t.normalize(),t.scale(2,2),this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),t))}this.angle+=.05}draw(){this.game.context.save(),this.game.context.shadowBlur=20,this.game.context.shadowColor="#000",this.game.context.translate(0|this.pos.x,0|this.pos.y),this.game.context.rotate(this.angle),this.game.context.fillStyle=this.color,this.game.context.beginPath(),this.game.context.moveTo(-this.width/2,this.height/2),this.game.context.lineTo(0,-this.height/2),this.game.context.lineTo(this.width/2,this.height/2),this.game.context.closePath(),this.game.context.fill(),this.game.context.restore()}}class u extends m{constructor(t,s,e){super(t),this.game=t,this.pos=new i(s,e),this.width=30,this.height=30,this.radius=20,this.coolDown=4e3+(5e3*Math.random()|0),this.canFire=!1,this.color="#fbe0c2",this.first=!0}update(){super.update(),this.canFire&&(this.canFire=!1,this.game.timers.push(new s(this.coolDown,(()=>this.canFire=!0))),this.game.timers.push(new s(100,(()=>this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),i.randomVector(2,2)))))),this.game.timers.push(new s(300,(()=>this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),i.randomVector(2,2)))))),this.game.timers.push(new s(500,(()=>this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),i.randomVector(2,2)))))),this.game.timers.push(new s(700,(()=>this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),i.randomVector(2,2)))))))}draw(){this.game.context.save(),this.game.context.shadowBlur=20,this.game.context.shadowColor="#fff",this.game.context.translate(0|this.pos.x,0|this.pos.y),this.game.context.fillStyle=this.color,this.game.context.beginPath(),this.game.context.moveTo(-this.width/2,-this.height/2),this.game.context.lineTo(0,+this.height/2),this.game.context.lineTo(this.width/2,-this.height/2),this.game.context.closePath(),this.game.context.fill(),this.game.context.restore()}}class w extends m{constructor(t,s,e){super(t),this.game=t,this.pos=new i(s,e),this.width=15,this.height=15,this.radius=15,this.coolDown=2e3+(5e3*Math.random()|0),this.canFire=!1,this.color="#94D0FF",this.first=!0}update(t){if(super.update(t),this.canFire){this.canFire=!1,this.game.timers.push(new s(this.coolDown,(()=>this.canFire=!0)));const t=new i(this.game.ship.pos.x-this.pos.x,this.game.ship.pos.y-this.pos.y);t.normalize(),t.scale(2,2),this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),t))}}}class x extends m{constructor(t,s,e){super(t),this.game=t,this.pos=new i(s,e),this.vel=new i(2*Math.random()-1,2*Math.random()-1),this.vel.normalize(),this.width=15,this.height=15,this.radius=15,this.coolDown=2e3+(5e3*Math.random()|0),this.canFire=!1,this.color="#ba1e68",this.first=!0,this.maxVelMagnitude=2}update(t){if(super.update(),this.canFire&&Math.random()>.98){this.canFire=!1,this.game.timers.push(new s(this.coolDown,(()=>this.canFire=!0)));const t=new i(this.game.ship.pos.x-this.pos.x,this.game.ship.pos.y-this.pos.y);t.normalize(),t.scale(3,3),this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),t))}this.game.world.collidesShip(this,!0),this.vel.magnitude()>this.maxVelMagnitude&&(this.vel.normalize(),this.vel.scaleRound(this.maxVelMagnitude,0)),this.pos.add(this.vel.x,this.vel.y)}}class b{constructor(t){this.game=t,this.visible=!1,this.menuContainer=document.getElementById("menu"),this.powerupsElement=document.getElementById("powerups"),this.powerupsDesc=document.getElementById("powerupdesc"),this.powerupcost=document.getElementById("powerupcost"),this.spent=0,this.reset(),this.setBase()}handleKey(t,i){}toggle(){return this.visible=!this.visible,this.visible?(this.upgradeCost(),this.powerupsElement.innerHTML=this.powerups.map(((t,i)=>`<div data-tooltip="${t.d}" class="powerup${t.a?" active":""}" data-i="${i}">${t.i}</div>`)).join(""),document.querySelectorAll(".powerup").forEach((t=>{t.addEventListener("click",(()=>{t.classList.contains("active")||this.game.hud.mineral>=this.nextCost&&(t.classList.toggle("active"),this.powerups[t.dataset.i].a=t.classList.contains("active"),this.spent+=this.nextCost,this.game.hud.increaseMineral(-this.nextCost),this.upgradeCost())})),t.addEventListener("mouseenter",(()=>{this.powerupsDesc.innerHTML=t.dataset.tooltip,this.powerupsDesc.style.visibility="visible"})),t.addEventListener("mouseleave",(()=>{this.powerupsDesc.style.visibility="hidden"}))}))):(this.setBase(),document.querySelectorAll(".powerup.active").forEach((t=>{this.powerups[t.dataset.i].f(this.powerUpsSettings)}))),this.menuContainer.style.display=this.visible?"flex":"none",this.visible}upgradeCost(){const t=this.powerups.filter((t=>t.a)).length;this.nextCost=Math.ceil(t*t*.1)+1,this.powerupcost.innerHTML=`Next ${this.nextCost} 🌒 (inv ${this.game.hud.mineral} 🌒)`}reset(){this.powerups=[],this.powerups.push(...Array(5).fill().map((t=>({i:"💨",d:"+max speed",a:!1,f:t=>t.s.maxVelocity+=.4})))),this.powerups.push(...Array(5).fill().map((t=>({i:"💣",d:"+bomb area",a:!1,f:t=>t.b.size+=1})))),this.powerups.push(...Array(5).fill().map((t=>({i:"💣",d:"-bomb cooldown",a:!1,f:t=>t.b.cooldown-=500})))),this.powerups.push(...Array(4).fill().map((t=>({i:"🔫",d:"+bullets fired",a:!1,f:t=>t.g.bullets+=1})))),this.powerups.push(...Array(5).fill().map((t=>({i:"🔫",d:"-gun cooldown",a:!1,f:t=>t.g.cooldown-=50})))),this.powerups.push(...Array(3).fill().map((t=>({i:"🔫",d:"+bullet piercing",a:!1,f:t=>t.g.bulletLife+=1})))),this.powerups.push(...Array(5).fill().map((t=>({i:"🧲",d:"+pickup radius",a:!1,f:t=>t.s.pickupRadius+=20})))),this.powerups.push(...Array(5).fill().map((t=>({i:"🛡️",d:"+shield duration",a:!1,f:t=>t.s.shieldDuration+=100})))),this.powerups.push(...Array(5).fill().map((t=>({i:"🛡️",d:"+shield cooldown",a:!1,f:t=>t.s.shieldCooldown-=500})))),this.powerups.push(...Array(2).fill().map((t=>({i:"💖",d:"Restore one life on teleport",a:!1,f:t=>t.s.teleportLife+=1})))),this.powerups.push({i:"🔫",d:"+aim with mouse",a:!1,f:t=>t.g.mouseAim=!0})}setBase(){this.powerUpsSettings={s:{maxVelocity:2,pickupRadius:50,shieldDuration:2e3,shieldCooldown:5e3,teleportLife:0},b:{size:1,cooldown:5e3},g:{cooldown:400,mouseAim:!1,bullets:1,bulletLife:0}}}}class f{constructor(t){this.game=t}update(){this.game.bullets.revFor((t=>{this.game.world.collides(t)&&t.hit(),this.game.enemies.revFor((i=>{this.collides(t,i)&&(t.hit(),i.hit())}))})),this.game.enemyBullets.revFor((t=>{this.game.world.collides(t)&&t.hit(),this.collides(t,this.game.ship)&&(t.hit(),this.game.ship.hit())})),this.game.enemies.revFor((t=>{this.collides(this.game.ship,t)&&(this.game.ship.hit(),t.hit())})),this.game.items.revFor((t=>{this.collides(t,{pos:this.game.ship.pos,radius:this.game.ship.pickupRadius})&&t.hit()}))}collides(t,s){var e=t.pos.x-s.pos.x,h=t.pos.y-s.pos.y;return new i(e,h).magnitude()<t.radius+s.radius}}const v={chanceToStartAlive:.4,deathLimit:3,birthLimit:4,numberOfSteps:10,worldWidth:15,worldHeight:15,generateMap:function(t,i){t&&(this.worldWidth=t),i&&(this.worldHeight=i);var s=[[]];this.initialiseMap(s);for(var e=0;e<this.numberOfSteps;e++)s=this.step(s);return s},initialiseMap:function(t){for(var i=0;i<this.worldWidth;i++){t[i]=[];for(var s=0;s<this.worldHeight;s++)t[i][s]=0}for(i=0;i<this.worldWidth;i++)for(s=0;s<this.worldHeight;s++)Math.random()<this.chanceToStartAlive&&(t[i][s]=1);return t},step:function(t){for(var i=[[]],s=0;s<t.length;s++){i[s]=[];for(var e=0;e<t[0].length;e++)if(0===s||0===e||s===t.length-1||e===t[0].length-1)i[s][e]=2;else{var h=this.countAliveNeighbours(t,s,e);t[s][e]>0?h<this.deathLimit?i[s][e]=0:i[s][e]=1:h>this.birthLimit?i[s][e]=1:i[s][e]=0}}return i},countAliveNeighbours:function(t,i,s){for(var e=0,h=-1;h<2;h++)for(var o=-1;o<2;o++){var a=h+i,n=o+s;0===h&&0===o||(a<0||n<0||a>=t.length||n>=t[0].length||1===t[a][n])&&(e+=1)}return e}};class y extends t{constructor(t,s,e,h,o){super(t),this.pos=s,this.vel=new i(2*Math.random()-1,2*Math.random()-1),this.vel.normalize(),this.vel.scale(.1,.1),this.width=Math.round(Math.random()*(o??75)),this.height=Math.round(Math.random()*(o??75)),this.alpha=h??1,this.color=`${e.r},${e.g},${e.b}`}update(){this.width-=.4,this.height-=.4,this.alpha-=.03,this.pos.add(this.vel.x,this.vel.y),(this.width<0||this.height<0||this.alpha<0)&&(this.removeable=!0)}draw(){this.game.context.fillStyle=`rgba(${this.color},${this.alpha})`,this.game.context.fillRect(this.pos.x-this.width/2,this.pos.y-this.height/2,this.width,this.height)}}class M{constructor(t){this.game=t,this.bgCanvas=document.getElementById("canvasBg"),this.bgContext=this.bgCanvas.getContext("2d"),this.worldCanvas=document.createElement("canvas"),this.context=this.worldCanvas.getContext("2d"),this.bgCanvas.width=this.game.canvas.width,this.bgCanvas.height=this.game.canvas.height}getEmptyPos(){return this.emptyPositions.random(!0)}generateBossWorld(){const t=[[]];for(let i=0;i<15;i++){t[i]=[];for(let s=0;s<15;s++)t[i][s]=0===i||0===s||14===i||14===s?2:0}return t}generateNew(t,i,s){this.portalPos=null,this.updateCounter=0,this.deg=360*Math.random()|0,this.currentMap=s?this.generateBossWorld():v.generateMap(t,i),this.tileWidth=50,this.worldCanvas.width=this.currentMap.length*this.tileWidth,this.worldCanvas.height=this.currentMap[0].length*this.tileWidth,this.context.clearRect(0,0,this.worldCanvas.width,this.worldCanvas.height),this.emptyPositions=[];const e=100+100*Math.random()|0,h=100+100*Math.random()|0,o=100+100*Math.random()|0;this.baseColor={r:e,g:h,b:o},this.context.strokeStyle="rgba(0,255, 255, 1)",this.context.strokeRect(this.tileWidth,this.tileWidth,this.tileWidth*(this.currentMap.length-2),this.tileWidth*(this.currentMap[0].length-2));for(let t=0;t<this.currentMap.length;t++)for(let i=0;i<this.currentMap[t].length;i++)if(this.currentMap[t][i]){let s=20*Math.random()|0;if(2===this.currentMap[t][i]);else if(1===this.currentMap[t][i]){const a=t*this.tileWidth,n=i*this.tileWidth;this.context.fillStyle=`rgba(${e-s},${h-s},${o-s})`,this.context.fillRect(a,n,this.tileWidth,this.tileWidth);for(let t=0;t<30;t++){let t=20*Math.random()|0;this.context.save(),this.context.translate(a+this.tileWidth/2,n+this.tileWidth/2),this.context.rotate(6*Math.random()),this.context.fillStyle=`rgba(${e-t},${h-t},${o-t}, 0.8)`;let i=Math.random()*this.tileWidth+5,s=Math.random()*this.tileWidth+5;this.context.fillRect(-i/2-4+8*Math.random(),-s/2-4+8*Math.random(),i,s),this.context.restore(),Math.random()>.95&&(this.context.clearRect(a+Math.random()*this.tileWidth,n,8*Math.random(),8*Math.random()),this.context.clearRect(a+Math.random()*this.tileWidth,n+this.tileWidth-5,8*Math.random(),8*Math.random()),this.context.clearRect(a,n+Math.random()*this.tileWidth,8*Math.random(),8*Math.random()),this.context.clearRect(a+this.tileWidth-5,n+Math.random()*this.tileWidth,8*Math.random(),8*Math.random()))}}}else this.emptyPositions.push({x:t*this.tileWidth+this.tileWidth/2,y:i*this.tileWidth+this.tileWidth/2,xPos:t,yPos:i});this.starColors=["255,255,255","57,190,255","170, 172, 217","255,255,0"],this.bgCanvas.style.backgroundImage=`linear-gradient(${360*Math.random()|0}deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 36%, rgba(${e},${h},${o},${.5+.1*Math.random()}) 52%, rgba(0,0,0,0) 65%, rgba(61,114,255,0) 100%), linear-gradient(black, rgba(${40*Math.random()|0},${40*Math.random()|0},${40*Math.random()|0},1))`,this.width=this.currentMap.length*this.tileWidth,this.height=this.currentMap[0].length*this.tileWidth,this.bgContext.clearRect(0,0,this.bgCanvas.width,this.bgCanvas.height);for(let t=0;t<250;t++){this.bgContext.save(),this.bgContext.translate(this.bgCanvas.width/2,this.bgCanvas.height/2),this.bgContext.rotate(Math.PI*Math.random());let t=1+3*Math.random();this.bgContext.fillStyle=`rgba(${this.starColors.random()},${.8-.4*Math.random()})`,this.bgContext.fillRect(Math.random()*this.bgCanvas.width|0,Math.random()*this.bgCanvas.height|0,t,t),this.bgContext.font=(8+200*Math.random()|0)+"px Arial",Math.random()>.97&&(this.bgContext.fillStyle=`rgba(255,255,255,${.15*Math.random()})`,this.bgContext.fillText("✨",Math.random()*this.bgCanvas.width|0,Math.random()*this.bgCanvas.height)),Math.random()>.94&&(this.bgContext.fillStyle=`rgba(255,255,255,${.1*Math.random()})`,this.bgContext.fillText("🌑",Math.random()*this.bgCanvas.width|0,Math.random()*this.bgCanvas.height)),this.bgContext.restore()}s||this.addPortal()}addPortal(){this.portalPos=this.getEmptyPos(),this.currentMap[this.portalPos.xPos][this.portalPos.yPos]=3}update(){this.game.zoomDone&&(this.bgCanvas.style.filter=`blur(${0|Math.abs(this.game.ship.vel.x)}px)`)}getCurrent(t,i){try{return this.currentMap[t][i]}catch(t){return 0}}collides(t){const s=Math.floor(t.pos.x/this.tileWidth),e=Math.floor(t.pos.y/this.tileWidth),h=this.getCurrent(s,e);if(h){if(4===this.currentMap[s][e])return!1;if(2===this.currentMap[s][e]||3===this.currentMap[s][e])return t.removeable=!0,!1;1===this.currentMap[s][e]&&(this.clearTile(s,e),this.explodeTile(s,e,new i(t.pos.x,t.pos.y)),this.game.sounds.sfx(1))}return h}bomb(t){const s=Math.floor(t.pos.x/this.tileWidth),e=Math.floor(t.pos.y/this.tileWidth),h=Math.floor(t.size/2);for(var o=-h;o<=h;o++)for(var a=-h;a<=h;a++){1===this.getCurrent(s+o,e+a)&&(this.clearTile(s+o,e+a),this.explodeTile(s+o,e+a,new i((s+o)*this.tileWidth+this.tileWidth/2,(e+a)*this.tileWidth+this.tileWidth/2)))}return{startX:s*this.tileWidth+this.tileWidth/2,startY:e*this.tileWidth+this.tileWidth/2,x:(s-h)*this.tileWidth,y:(e-h)*this.tileWidth,w:this.tileWidth*t.size,h:this.tileWidth*t.size,counter:0}}clearTile(t,i){this.currentMap[t][i]=0;for(let s=-1;s<=1;s++)for(let e=-1;e<=1;e++)0===this.getCurrent(t+s,i+e)&&this.context.clearRect((t+s)*this.tileWidth,(i+e)*this.tileWidth,this.tileWidth,this.tileWidth);this.context.clearRect(t*this.tileWidth,i*this.tileWidth,this.tileWidth,this.tileWidth)}explodeTile(t,s,e){Math.random()>.85&&this.game.items.push(new p(this.game,new i(t*this.tileWidth+this.tileWidth/2,s*this.tileWidth+this.tileWidth/2)));for(let t=0;t<10;t++)this.game.particles.push(new y(this.game,new i(e.x,e.y),this.baseColor))}collidesShip(t,i){const s=t.pos.x+2*t.vel.x,e=t.pos.y+2*t.vel.y,h=Math.floor(s/this.tileWidth),o=Math.floor(e/this.tileWidth),a=this.getCurrent(h,o);if(a){if(this.shipCollidesPos=h+","+o,!i&&3===a)return this.game.queueRestart=!0,!1;const s=t.pos.y-(o*this.tileWidth+this.tileWidth/2),e=t.pos.x-(h*this.tileWidth+this.tileWidth/2);Math.abs(e)>Math.abs(s)?(t.vel.x=3*-t.vel.x,t.vel.y=3*t.vel.y,t.angle=e>=0?Math.atan(t.vel.y/t.vel.x):Math.atan(t.vel.y/t.vel.x)-Math.PI):(t.vel.x=3*t.vel.x,t.vel.y=3*-t.vel.y,t.angle=Math.atan(t.vel.y/t.vel.x),t.vel.x<0&&(t.angle=t.angle-Math.PI))}}draw(){this.updateCounter++,this.updateCounter>5?(this.context.strokeStyle=`rgba(40, ${100+150*Math.random()}, 255, 1)`,this.context.strokeRect(this.tileWidth,this.tileWidth,this.tileWidth*(this.currentMap.length-2),this.tileWidth*(this.currentMap[0].length-2)),this.updateCounter=0):this.portalPos&&this.updateCounter%2==0&&this.game.particles.push(new y(this.game,new i(this.portalPos.x,this.portalPos.y),{r:30*Math.random()|0,g:100+150*Math.random()|0,b:255},.3+Math.random(),75+25*Math.random()|0)),this.game.context.drawImage(this.worldCanvas,0,0)}}class C{constructor(t){this.game=t,this.worldElement=document.getElementById("world"),this.worldListElement=document.getElementById("worldlist"),this.mineral=0,this.spentMineral=0,this.title=document.getElementById("title"),this.titleText=document.getElementById("titleText"),this.bomb=document.getElementById("hudBomb"),this.shield=document.getElementById("hudShield"),this.worldList=[]}increaseMineral(t){t?this.mineral+=t:this.mineral++}drawTitle(t){this.showing=!0,this.title.style.display="flex",this.titleText.innerHTML=t,this.game.titleVisible=!0,this.bomb.style.display="none",this.shield.style.display="none"}hideTitle(){this.showing=!1,this.title.style.display="none",this.game.titleVisible=!1,this.bomb.style.display="block",this.shield.style.display="block"}addWorld(t,i){this.worldList.push({world:t,color:i})}toggleBomb(){this.bomb.classList.toggle("active")}toggleShield(){this.shield.classList.toggle("active")}reset(){this.bomb.classList.add("active"),this.shield.classList.add("active")}}var P=function(){var t,i,s,e,h,o=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*2**((t-128)/12)},n=function(t,i,s){var e,h,o,n,l,d,p=r[t.i[0]],c=t.i[1],m=t.i[3]/32,g=r[t.i[4]],u=t.i[5],w=t.i[8]/32,x=t.i[9],b=t.i[10]*t.i[10]*4,f=t.i[11]*t.i[11]*4,v=t.i[12]*t.i[12]*4,y=1/v,M=-t.i[13]/16,C=t.i[14],P=s*2**(2-t.i[15]),W=new Int32Array(b+f+v),A=0,L=0;for(e=0,h=0;e<b+f+v;e++,h++)h>=0&&(h-=P,l=a(i+(15&(C=C>>8|(255&C)<<4))+t.i[2]-128),d=a(i+(15&C)+t.i[6]-128)*(1+8e-4*t.i[7])),o=1,e<b?o=e/b:e>=b+f&&(o=(1-(o=(e-b-f)*y))*3**(M*o)),n=p(A+=l*o**m)*c,n+=g(L+=d*o**w)*u,x&&(n+=(2*Math.random()-1)*x),W[e]=80*n*o|0;return W},r=[o,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var i=t%1*4;return i<2?i-1:3-i}];this.init=function(o){t=o,i=o.endPattern,s=0,e=o.rowLen*o.patternLen*(i+1)*2,h=new Int32Array(e)},this.generate=function(){var a,l,d,p,c,m,g,u,w,x,b,f,v,y,M=new Int32Array(e),C=t.songData[s],P=t.rowLen,W=t.patternLen,A=0,L=0,S=!1,B=[];for(d=0;d<=i;++d)for(g=C.p[d],p=0;p<W;++p){var F=g?C.c[g-1].f[p]:0;F&&(C.i[F-1]=C.c[g-1].f[p+W]||0,F<17&&(B=[]));var I=r[C.i[16]],T=C.i[17]/512,$=2**(C.i[18]-9)/P,k=C.i[19],R=C.i[20],E=135.82764118168*C.i[21]/44100,D=1-C.i[22]/255,z=1e-5*C.i[23],V=C.i[24]/32,H=C.i[25]/512,U=6.283184*2**(C.i[26]-9)/P,Z=C.i[27]/255,q=C.i[28]*P&-2;for(b=(d*W+p)*P,c=0;c<4;++c)if(m=g?C.c[g-1].n[p+c*W]:0){B[m]||(B[m]=n(C,m,P));var N=B[m];for(l=0,a=2*b;l<N.length;l++,a+=2)M[a]+=N[l]}for(l=0;l<P;l++)(x=M[u=2*(b+l)])||S?(f=E,k&&(f*=I($*u)*T+.5),L+=(f=1.5*Math.sin(f))*(v=D*(x-L)-(A+=f*L)),x=3==R?L:1==R?v:A,z&&(x=(x*=z)<1?x>-1?o(.25*x):-1:1,x/=z),S=(x*=V)*x>1e-5,y=x*(1-(w=Math.sin(U*u)*H+.5)),x*=w):y=0,u>=q&&(y+=M[u-q+1]*Z,x+=M[u-q]*Z),M[u]=0|y,M[u+1]=0|x,h[u]+=0|y,h[u+1]+=0|x}return++s/t.numChannels},this.createAudioBuffer=function(t){for(var i=t.createBuffer(2,e/2,44100),s=0;s<2;s++)for(var o=i.getChannelData(s),a=s;a<e;a+=2)o[a>>1]=h[a]/65536;return i},this.createWave=function(){var t=44+2*e-8,i=t-36,s=new Uint8Array(44+2*e);s.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&i,i>>8&255,i>>16&255,i>>24&255]);for(var o=0,a=44;o<e;++o){var n=h[o];n=n<-32767?-32767:n>32767?32767:n,s[a++]=255&n,s[a++]=n>>8&255}return s},this.getData=function(t,i){for(var s=2*Math.floor(44100*t),e=new Array(i),o=0;o<2*i;o+=1){var a=s+o;e[o]=t>0&&a<h.length?h[a]/32768:0}return e}},W={songData:[{i:[0,91,128,0,2,119,128,1,0,0,21,44,61,9,0,0,0,72,3,1,2,35,153,1,53,91,2,32,2],p:[,,,,1,2,3,4,5,6,7,4,5,6,7,4,5,6,7,4,5,6,7,4,5,6,7,4,5,6,7,4],c:[{n:[142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,152,142,138,135,150],f:[22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,,,,,,,,,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3]},{n:[143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,154,143,140,135,150],f:[22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,9,9,9,9,12,12,12,12,17,17,17,17]},{n:[142,139,135,154,142,139,135,154,142,139,135,154,142,139,134,154,142,139,135,154,142,139,135,154,142,139,135,152,142,139,135,151],f:[22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,21,21,21,21,22,22,22,22,23,23,23,23,24,24,24,24,25,25,25,25,26,26,26,26,27,27,27,27,28,28,28,28]},{n:[145,140,137,157,145,140,137,157,145,140,137,157,145,140,137,157,145,140,137,157,145,140,137,157,145,140,137,155,145,140,137,154],f:[]},{n:[142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,154,142,138,135,152,142,138,135,150],f:[]},{n:[143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,155,143,140,135,154,143,140,135,150],f:[]},{n:[142,139,135,154,142,139,135,154,142,139,135,154,142,139,134,154,142,139,135,154,142,139,135,154,142,139,135,152,142,139,135,151],f:[]}]},{i:[3,194,128,0,2,198,128,6,0,0,12,12,33,0,0,0,0,168,4,1,3,17,92,7,32,59,3,67,2],p:[1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4],c:[{n:[111,,,111,123,,135,123,,111,135,123,111,,111,123,111,,,111,123,,135,123,,111,135,123,111,,111,123],f:[]},{n:[111,,,111,123,,135,123,,111,135,123,111,,111,123,111,,,111,123,,135,123,,111,135,123,111,,111,123],f:[]},{n:[111,,,111,123,,135,123,,111,135,123,111,,111,123,111,,,111,123,,135,123,,111,135,123,111,,111,123],f:[]},{n:[109,,,109,121,,133,121,,109,133,121,109,,109,121,109,,,109,121,,133,121,,109,133,121,109,,109,121],f:[]}]},{i:[2,100,128,0,2,140,128,3,0,0,32,28,104,17,0,0,0,51,4,1,3,48,132,0,47,25,6,44,6],p:[,,,,,,,,5,,,,5,,,,1,2,3,4,1,2,3,4],c:[{n:[135,,,,,,,,,,138,137,142,,,,,,,,140,,,,135,,,138,,,137],f:[11,12,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,5,28]},{n:[135,,,,,,142,,,,140,,142,,,,138,,,,,,137,,,,,,138],f:[]},{n:[135,,,,,,135,,137,,,139,,,137,,,,139,,142,,,,140,,,142,,,147],f:[]},{n:[140,,,,,,,,145,,143,,145,143,142,,140,,,,,,145,,,,,,138,,137],f:[]},{n:[135],f:[11,12,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,167,77]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[0,255,116,79,0,255,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[,,,2,1,1,1,1,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c:[{n:[135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,135,,,,135],f:[]},{n:[135,,,,,,135,,,,,,135,,,,135,,,,,,135,,,,,,135],f:[]}]},{i:[0,221,128,64,0,210,128,0,64,255,4,6,73,79,0,0,0,64,7,1,3,195,15,0,32,20,0,24,6],p:[,,,2,1,1,1,1,1,1,1,3,1,1,1,1,2,1,1,1,1,1,1,3,1,1,1,1,1,1,1,3],c:[{n:[,,,,135,,,,,,,,135,,,,,,,,135,,,,,135,,,135],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,135,,,135,,135,135],f:[]},{n:[,,,,135,,,,,,,,135,,,,,,,,135,,,,,135,,,135,,135,135],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,192,128,0,3,192,140,1,0,179,45,85,124,9,0,0,0,0,0,0,3,12,136,0,32,59,2,24,8],p:[,,,,1,2,3,4,1,2,3,4,1,2,3,4],c:[{n:[142,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135],f:[11,,,,,,,,,,,,,,,,,,,,,,,,,,,,11,,,,72,,,,,,,,,,,,,,,,,,,,,,,,,,,,45]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,137,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,138],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,,,139,,,,,,,,,,,,,,,,,,,,,,,,142],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,138,,,,,,,,,,,,,,,,,,,,,,143],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,81,4,10,47,55,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],p:[,,,,,,,,,,,,,,,,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c:[{n:[147,,,147,,147,147,,147,,,147,,,147,,147,,,147,,147,147,,147,,,147,,,147],f:[]}]},{i:[0,0,128,0,0,0,128,0,0,125,0,1,59,0,0,0,0,0,0,0,1,193,171,0,29,39,3,88,3],p:[,,,,,,,,,,,,,,,,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c:[{n:[,,,,,,,,,,,,,,159,,,,,,,,,,,,,,,,159],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,,,,,,,,,,,,,,,,,,,,,,,1,,1,,1,,1],c:[{n:[111,,,,,,,,,,111,123,111],f:[]}]}],rowLen:6241,patternLen:32,endPattern:31,numChannels:12},A={songData:[{i:[3,128,128,0,0,87,140,18,0,0,107,115,138,0,0,0,0,136,5,1,2,8,60,6,32,116,5,85,8],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,12,0,0,32,147,6,121,6],p:[1,2],c:[{n:[138,,,,,,,,,,137,,,,138,,143],f:[]},{n:[,125,137,,,,,,,,140,,,,,,144,,,,152,,,,144],f:[]}]}],rowLen:7692,patternLen:32,endPattern:1,numChannels:2},L={songData:[{i:[3,214,135,170,0,130,98,66,53,136,7,16,12,15,0,0,0,231,6,1,3,8,35,2,32,24,2,51,2],p:[1],c:[{n:[111],f:[]}]}],rowLen:5513,patternLen:1,endPattern:0,numChannels:1},S={songData:[{i:[2,138,116,0,0,138,128,4,0,116,47,48,162,63,124,6,0,99,6,1,3,64,160,4,48,147,4,121,4],p:[1],c:[{n:[123],f:[]}]}],rowLen:5513,patternLen:16,endPattern:0,numChannels:1},B={songData:[{i:[3,156,106,57,3,92,106,0,64,0,5,7,101,0,38,1,2,0,0,0,2,255,0,2,32,83,5,25,1],p:[1],c:[{n:[159],f:[]}]}],rowLen:5513,patternLen:8,endPattern:0,numChannels:1};class F{constructor(t){this.game=t,this.player=new P,this.soundsLoading=[W,L,S,A,B],this.sounds=[],this.currentlyLoadingIndex=0,this.startedLoading=!1}load(t){if(this.game.debug)t();else if(this.startedLoading||(this.player.init(this.soundsLoading[this.currentlyLoadingIndex]),this.startedLoading=!0),this.player.generate()<1)setTimeout((()=>this.load(t)),200);else{const i=this.player.createWave(),s=document.createElement("audio");s.src=URL.createObjectURL(new Blob([i],{type:"audio/wav"})),this.sounds.push(s),this.currentlyLoadingIndex++,this.currentlyLoadingIndex<this.soundsLoading.length?(this.player.init(this.soundsLoading[this.currentlyLoadingIndex]),this.load(t)):(this.sounds[0].loop=!0,this.sounds[0].volume=0,this.sounds[3].loop=!0,this.sounds[3].volume=0,t())}}playSong(t){this.game.debug||(this.sounds[t].loop=!0,this.sounds[t].volume=0,this.sounds[t].play())}sfx(t){this.game.debug||this.sounds[t].play()}fade(t,i){this.game.debug||(this.intervalID&&clearInterval(this.intervalID),this.sounds[t].play(),this.intervalID=setInterval((()=>{if(this.sounds[t].volume<.5){let s=this.sounds[t].volume+.05;if(s>.5&&(s=.5),this.sounds[t].volume=s.toFixed(2),this.sounds[i].volume>0){let t=.5-s;t<0&&(t=0),this.sounds[i].volume=t.toFixed(2)}}else clearInterval(this.intervalID),this.intervalID=void 0}),300))}}class I extends t{constructor(t,s){super(t),this.pos=new i(100,100),this.vel=new i(0,0),this.radius=40,this.maxLife=10+5*(s-3),this.life=this.maxLife,this.coolDown=5e3,this.first=!0,this.bullets=0,this.ctx.font="26px Arial";const e=this.ctx.measureText("👁️");this.textMeasure={width:e.width/2,height:(e.actualBoundingBoxAscent+e.actualBoundingBoxDescent)/2},this.invul=!1}hit(){this.invul||(this.life-=1)}update(){if(this.lifeRatio=this.life/this.maxLife,this.first&&(this.first=!1,this.game.timers.push(new s(this.coolDown,(()=>{this.canFire=!0})))),this.ip)this.ip.c<100?(this.pos.add(this.ip.vel.x,this.ip.vel.y),this.ip.c++):this.ip.c<200?this.ip.b||(this.ip.b={pos:{x:Math.random()>.5?50:375,y:Math.random()>.5?50:375}},this.game.timers.push(new s(3e3,(()=>{this.ip.b.bomb=!0}))),this.game.timers.push(new s(4e3,(()=>{this.ip.b=void 0,this.ip.c+=this.i2?25:50})))):this.ip.c>=200&&(this.ip=void 0,this.invul=!1);else{if(this.canFire){this.canFire=!1,this.game.timers.push(new s(this.coolDown,(()=>this.canFire=!0)));const t=new i(this.game.ship.pos.x-this.pos.x,this.game.ship.pos.y-this.pos.y);t.normalize(),t.scale(3,3),this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),t));for(let t=0;t<this.bullets;t++)this.game.enemyBullets.push(new a(this.game,new i(this.pos.x,this.pos.y),i.randomVector(3,3)))}if(!this.i1&&this.lifeRatio<.75){this.invul=!0,this.i1=!0;const t=new i(375-this.pos.x,375-this.pos.y);t.scale(.01,.01),this.ip={vel:t,c:0},this.moving=!0,this.vel=new i(Math.random(),Math.random()),this.vel.scale(2,2),this.maxVelMagnitude=2}if(!this.i2&&this.lifeRatio<.45){this.invul=!0,this.i2=!0;const t=new i(375-this.pos.x,375-this.pos.y);t.scale(.01,.01),this.ip={vel:t,c:0}}if(this.bullets<2&&this.lifeRatio<.5&&(this.bullets=2),this.bullets<4&&this.lifeRatio<.25&&(this.bullets=4),this.moving&&(this.game.world.collidesShip(this,!0),this.vel.magnitude()>this.maxVelMagnitude&&(this.vel.normalize(),this.vel.scaleRound(this.maxVelMagnitude,0)),this.pos.add(this.vel.x,this.vel.y)),this.bombing,this.life<=0){this.removeable=!0,this.game.world.addPortal();for(var t=0;t<10;t++)this.game.items.push(new p(this.game,new i(this.pos.x+30*Math.random()|0,this.pos.y+30*Math.random()|0)));this.game.camera.shake(500)}}}draw(){if(this.ctx.save(),this.ctx.shadowBlur=100,this.ctx.shadowColor="#ffffff",this.ctx.beginPath(),this.ctx.fillStyle=this.invul?"#fff":"#000",this.ctx.arc(this.pos.x,this.pos.y,this.radius,0,2*Math.PI,!1),this.ctx.arc(this.pos.x,this.pos.y,this.radius-5,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.beginPath(),this.ctx.fillStyle="rgba(159,69,176,0.7)",this.ctx.arc(this.pos.x,this.pos.y,5+30*this.lifeRatio,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.font="26px Arial",this.ctx.fillText("👁️",this.pos.x-this.textMeasure.width,this.pos.y+this.textMeasure.height),this.ctx.restore(),this.ip&&this.ip.b)if(this.ip.b.bomb){if(!this.ip.b.bombing){this.ip.b.bombing=!0,this.game.camera.shake(500);const t=this.game.ship.pos.x,i=this.game.ship.pos.y,s=this.ip.b.pos.x,e=this.ip.b.pos.y;t>s&&t<s+325&&i>e&&i<e+325&&(this.game.ship.hit(),this.game.ship.hit())}}else this.ctx.fillStyle="rgba(0,0,0,0.6)",this.ctx.fillRect(this.ip.b.pos.x,this.ip.b.pos.y,325,325),this.ctx.strokeStyle=`rgba(40, ${100+150*Math.random()}, 255, 1)`,this.ctx.strokeRect(this.ip.b.pos.x,this.ip.b.pos.y,325,325)}}class T{constructor(){this.canvas=document.getElementById("canvas"),this.context=document.getElementById("canvas").getContext("2d"),window.onresize=this.onresize,window.onresize(),window.onkeydown=t=>{this.handleKey(t,!0)},window.onkeyup=t=>{this.handleKey(t,!1)},this.levelsCompleted=0,this.camera=new d(this.context,this),this.collision=new f(this),this.hud=new C(this),this.powerup=new b(this),this.running=!0,this.debug=!1,this.world=new M(this),this.sounds=new F(this),this.hud.drawTitle("Loading"),this.loading=!0,this.sounds.load((()=>{this.loading=!1,this.startLevel({title:!0})}))}onresize(){if(!this.canvas)return;const t=this.canvas.clientWidth,i=this.canvas.clientHeight;this.canvas.width=t,this.canvas.height=i}startLevel(t){this.context.clearRect(0,0,canvas.width,canvas.height),this.sounds.fade(3,0),this.running=!1,this.queueRestart=!1,this.ship=new l(this,this.ship?this.ship.life:10),this.bullets=[],this.enemyBullets=[],this.enemies=[],this.particles=[],this.items=[],this.timers=[],this.zoomDone=!1,this.boss=this.levelsCompleted>0&&this.levelsCompleted%4==0,this.world.generateNew(15+2*this.levelsCompleted*Math.random()|0,15+2*this.levelsCompleted*Math.random()|0,this.boss);const i=`${Math.random().toString(26).substring(2,8)}-${Math.random().toString(36).substring(3,4)}-${Math.random().toString(9).substring(2,5)}`.toUpperCase();this.hud.addWorld(i,`rgba(${this.world.baseColor.r},${this.world.baseColor.g},${this.world.baseColor.b},1)`),t.title?this.hud.drawTitle("Move forward with [W], turn with [A] and [D].<br> Fire gun with [SPACEBAR], bomb with [Q] and use shield with [F]<br>Collect minerals and use [TAB] to buy powerups.<br><br>[SPACEBAR] to begin."):t.death?this.hud.drawTitle(`That was not you purpose.<br>Half of resources lost.<br>Memory reset.<br><br>Next system is <span style="font-weight: bold; color: rgba(${this.world.baseColor.r},${this.world.baseColor.g},${this.world.baseColor.b},1)">${i}</span><br><br>[SPACEBAR] to begin.`):this.hud.drawTitle(`Survival. Find your purpose.<br><br>Next system is <span style="font-weight: bold; color: rgba(${this.world.baseColor.r},${this.world.baseColor.g},${this.world.baseColor.b},1)">${i}</span><br><br>[SPACEBAR] to begin.`),this.boss;const s=this.boss?{x:500,y:500}:this.world.getEmptyPos();if(this.boss)this.enemies.push(new I(this,this.levelsCompleted));else{let t=(h=this.world.emptyPositions.length,o=this.levelsCompleted,h<200?2+o:h<300?5+o:h<450?8+o:h<500?12+o:h<600?15+o:22+o);for(var e=0;e<t;e++){let t=this.world.getEmptyPos();Math.random()>.95-this.levelsCompleted/100?this.enemies.push(new x(this,t.x,t.y)):Math.random()>.85-this.levelsCompleted/100?this.enemies.push(new u(this,t.x,t.y)):Math.random()>.6?this.enemies.push(new g(this,t.x,t.y)):this.enemies.push(new w(this,t.x,t.y))}}var h,o;this.ship.pos.x=s.x,this.ship.pos.y=s.y,this.camera.shaking=!1,this.camera.setWorldSize(this.world.width,this.world.height),this.targetZoom=1e3+.4*(this.canvas.width-1200),this.currentZoom=3e4,this.camera.zoomTo(this.currentZoom),this.world.bgCanvas.style.filter=`blur(${this.currentZoom/this.targetZoom|0}px)`,this.updateFromPowerups(),this.camera.moveTo(this.ship.pos.x,this.ship.pos.y),this.camera.begin(),this.world.draw(),this.camera.end()}startPlaying(){this.loading||(this.sounds.fade(0,3),this.hud.reset(),this.hud.hideTitle(),this.running=!0,window.requestAnimationFrame((t=>this.draw(t))))}updateFromPowerups(){this.ship.maxVelMagnitude=this.powerup.powerUpsSettings.s.maxVelocity,this.ship.pickupRadius=this.powerup.powerUpsSettings.s.pickupRadius,this.ship.bomb.size=this.powerup.powerUpsSettings.b.size,this.ship.bomb.cooldown=this.powerup.powerUpsSettings.b.cooldown,this.ship.gun.bulletsFired=this.powerup.powerUpsSettings.g.bullets,this.ship.gun.mouseAim=this.powerup.powerUpsSettings.g.mouseAim,this.ship.gun.bulletLife=this.powerup.powerUpsSettings.g.bulletLife,this.ship.gun.cooldown=this.powerup.powerUpsSettings.g.cooldown,this.ship.invulCooldown=this.powerup.powerUpsSettings.s.shieldCooldown,this.ship.invulPeriod=this.powerup.powerUpsSettings.s.shieldDuration,this.ship.life+=this.powerup.powerUpsSettings.s.teleportLife,this.ship.life>10&&(this.ship.life=10)}endGame(){this.running=!1,this.levelsCompleted=0,this.hud.mineral=(this.hud.mineral+this.powerup.spent)/2|0,this.ship.life=5,this.powerup.setBase(),this.powerup.reset(),this.startLevel({death:!0})}draw(t){if(this.startTime||(this.startTime=t),this.runningTime=t-this.startTime,this.startTime=t,this.queueRestart)return this.sounds.sfx(2),this.levelsCompleted++,void this.startLevel({});this.running&&(this.zoomDone||(this.currentZoom-=1e3,this.world.bgCanvas.style.filter=`blur(${this.currentZoom/this.targetZoom|0}px)`,this.currentZoom<this.targetZoom&&(this.currentZoom=this.targetZoom,this.zoomDone=!0),this.camera.zoomTo(this.currentZoom)),this.zoomDone&&(this.ship.update(),this.timers.forEach((t=>t.update(this.runningTime))),this.enemies.forEach((t=>t.update())),this.camera.moveTo(this.ship.pos.x,this.ship.pos.y),this.bullets.forEach((t=>{t.update()})),this.enemyBullets.forEach((t=>{t.update()})),this.collision.update(),this.particles.forEach((t=>t.update())),this.items.forEach((t=>{t.update()})),this.particles=this.particles.filter((t=>!t.removeable)),this.bullets=this.bullets.filter((t=>!t.removeable)),this.enemyBullets=this.enemyBullets.filter((t=>!t.removeable)),this.enemies=this.enemies.filter((t=>!t.removeable)),this.items=this.items.filter((t=>!t.removeable)),this.timers=this.timers.filter((t=>!t.removeable))),this.context.clearRect(0,0,canvas.width,canvas.height),this.world.update(),this.camera.begin(),this.world.draw(),this.enemies.revFor((t=>t.draw())),this.ship.draw(),this.bullets.forEach((t=>{t.draw()})),this.enemyBullets.forEach((t=>{t.draw()})),this.items.forEach((t=>{t.draw()})),this.particles.forEach((t=>t.draw())),this.camera.end(),window.requestAnimationFrame((t=>this.draw(t))))}handleKey(t,i){if([9,32,65,87,68,81,70].indexOf(t.keyCode)>-1){if(t.preventDefault(),this.hud.showing)return void(32===t.keyCode&&i&&this.startPlaying());9===t.keyCode&&i&&(this.running=!1,this.running=!this.powerup.toggle(),this.running?(this.startTime=null,this.updateFromPowerups(),window.requestAnimationFrame((t=>this.draw(t)))):this.pauseTime=window.performance.now()),this.ship.handleKey(t.keyCode,i)}}}window.onload=function(){Array.prototype.revFor=function(t){for(let i=this.length-1;i>=0;i--)t(this[i])},Array.prototype.random=function(t){const i=Math.floor(Math.random()*this.length),s=this[i];return t&&this.splice(i,1),s},new T};