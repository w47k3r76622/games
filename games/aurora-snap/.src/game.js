window.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("game");t.width=640,t.height=480;const s=t.getContext("2d");let a=document.querySelector(".shutter-outer"),n=document.querySelector(".game-end"),e=document.querySelector(".gallery"),o=document.querySelector(".gallery-heading"),h=document.querySelector(".clock");document.querySelector(".game-end .results-categories");const r=Math.ceil(t.height/8),i=Math.ceil(t.width/8),c=t.width/2,M=t.height/2;let l=0,u=!1,d=0;function g(t,s){return s*Math.round(t/s)}function m(t,s,a=0){function n(t){return t*t*(3-2*t)}function e(t,s,a){return t+a*(s-t)}function o(t,s,a){const n=t+57*s+131*a;return 43758.5453*Math.sin(n)-Math.floor(43758.5453*Math.sin(n))}const h=Math.floor(t),r=h+1,i=Math.floor(s),c=i+1,M=n(t-h),l=n(s-i),u=e(o(h,i,a),o(r,i,a),M),d=e(o(h,c,a),o(r,c,a),M);return e(u,d,l)}const p=new class{constructor(){this.seed=25565*Math.random(),this.t=[],this.o=[],this.h=!1,this.i=document.createElement("canvas"),this.i.width=t.width,this.i.height=t.height,this.M=this.i.getContext("2d"),this.l={r:100,g:150,b:255},this.u=.1;for(let s=0;s<5e3;s++){const s=2*Math.random()*Math.PI,a=Math.random()*(t.width/2-50),n=c+Math.cos(s)*(a+300),e=M+Math.sin(s)*(a+300),o=Math.hypot(n-c,e-M),h=t.height/2*(o/(t.width/2)),r=Math.min(20,2+o/(t.width/2)*10),i=c+Math.cos(s)*(a+h),l=M+Math.sin(s)*(a+h);Math.hypot(n-c,e-M)<t.width/4&&Math.hypot(i-c,l-M)<t.width/4||this.o.push({x1:n,y1:e,x2:i,y2:l,width:r})}this.m(),this.p()}$(t,a,n){s.fillStyle=n,s.fillRect(t,a,8,8)}C(){const a=(n=this.l,e={r:0,g:0,b:0},o=this.u*(l/100),{r:Math.round(n.r+(e.r-n.r)*o),g:Math.round(n.g+(e.g-n.g)*o),b:Math.round(n.b+(e.b-n.b)*o)});var n,e,o;s.globalAlpha=1,s.fillStyle=`rgb(${a.r},${a.g},${a.b})`,s.fillRect(0,0,t.width,t.height),s.globalAlpha=1}v(){for(let a=0;a<4;a++){let n=.05*a,e=1e-4+.75*Math.pow(a+1,2)*.01;for(let o=0;o<i;o++)for(let h=0;h<r;h++){let r=m((.5*o+l*e)/(3+a),(.5*h+l*e+n)/(3+a),this.seed),i=255*Math.pow(r,1.5),c=Math.min(1.2*i,200),M=Math.min(.6*i+40*Math.sin(.05*(l+n)),180),g=Math.min(.2*i+30*Math.cos(.005*(l+n)),150),p=m((.2*o+l*e)/500,(.2*h+l*e+n)/500),f=.3*Math.pow(r,2)+1/(a+1)*.1-p;if(f=Math.max(0,Math.min(f,1)),u){let s=d/50;t.style.border="4px solid rgba("+255*s+","+255*s+","+255*s+", 1)",c=Math.min(c*(1+.2*s),255),M=Math.min(M*(1+.2*s),255),g=Math.min(g*(1+.2*s),255),f=Math.min(f*(1+.4*s),1)}s.fillStyle=`rgba(${Math.round(g)}, ${Math.round(c)}, ${Math.round(M)}, ${f})`,s.fillRect(8*o,8*h,8,8)}}}m(){this.M.clearRect(0,0,this.i.width,this.i.height);const a={r:15,g:15,b:30};function n(t,s,a){return{r:Math.round(t.r+(s.r-t.r)*a),g:Math.round(t.g+(s.g-t.g)*a),b:Math.round(t.b+(s.b-t.b)*a)}}const e=n({r:250,g:120,b:0},a,Math.min(1,l/1e3)),o=t.width/2,h=t.height/2;function r(t,s){const a=Math.hypot(t-o,s-h),n=Math.hypot(o,h);return Math.min(1,a/n)}for(let t=0;t<this.o.length;t++){let s=this.o[t];const o=s.x2-s.x1,h=s.y2-s.y1,i=Math.sqrt(o*o+h*h),c=Math.ceil(i/8);for(let t=0;t<c;t++){const i=t/c,M=s.x1+o*i,l=s.y1+h*i,u=g(M-s.width/2,8),d=g(l-s.width/2,8),m=n(e,a,r(M,l));this.M.fillStyle=`rgb(${m.r}, ${m.g}, ${m.b})`,this.M.fillRect(u,d,8,8)}}s.drawImage(this.i,0,0)}k(){if(this.h)return;const t=(20+.25*l/60)%24*60,s=new Date;s.setHours(Math.floor(t/60)),s.setMinutes(t%60),s.setSeconds(0);const a=s.getHours(),n=s.getMinutes(),e=s.getSeconds(),o=a>=12?"PM":"AM",r=a%12||12;h.innerHTML=`${r}:${n<10?`0${n}`:n}:${e<10?`0${e}`:e} ${o}`,8==r&&"AM"==o&&this.D()}P(){u=!0,d=0}S(t){const s=t.width,a=t.height,n=t.data;let e=0;for(let t=1;t<a-1;t++)for(let a=1;a<s-1;a++){const o=4*(t*s+a),h=-n[o-4*s-4]-2*n[o-4]-n[o+4*s-4]+n[o-4*s+4]+2*n[o+4]+n[o+4*s+4],r=-n[o-4*s-4]-2*n[o-4*s]-n[o-4*s+4]+n[o+4*s-4]+2*n[o+4*s]+n[o+4*s+4];e+=h*h+r*r}return e}A(t){const s=t.data;let a=0;for(let t=0;t<s.length;t+=4){const n=(s[t]+s[t+1]+s[t+2])/3;a+=n*n}return Math.sqrt(a/(s.length/4))}F(t){const s=t.data;let a=0,n=0,e=0,o=0;for(let t=0;t<s.length;t+=4){const h=s[t]/255,r=s[t+1]/255,i=s[t+2]/255,c=Math.max(h,r,i),M=c-Math.min(h,r,i);let l=0;l=0===M?0:c===h?(r-i)/M%6:c===r?(i-h)/M+2:(h-r)/M+4,l=(60*l+360)%360,a+=l,n+=0===c?0:M/c,e+=c,o++}return[a/o,n/o,e/o]}G(t){return t<=500?0:t<=1e3?1:t<=1500?2:3}I(t){return t<=50?0:t<=100?1:t<=150?2:3}T(t){const[s,a,n]=t;return a<.2?0:a<.5?1:a<.8?2:3}async j(t){const s={q:[],B:[],L:[]};try{await Promise.all(t.map(function(t){return new Promise(((a,n)=>{const e=document.createElement("canvas"),o=e.getContext("2d"),h=new Image;h.onload=function(){e.width=h.width,e.height=h.height,o.drawImage(h,0,0);const t=o.getImageData(0,0,e.width,e.height),n=this.S(t),r=this.A(t),i=this.F(t),c=this.G(n),M=this.I(r),l=this.T(i);s.q.push(c),s.B.push(M),s.L.push(l),e.remove(),a({q:c,B:M,L:l})}.bind(this),h.onerror=function(){e.remove(),n(new Error(`Failed to load image: ${t}`))},h.src=t}))}.bind(this)));return{O:s.q.reduce(((t,s)=>t+s),0)/s.q.length,H:s.B.reduce(((t,s)=>t+s),0)/s.B.length,J:s.L.reduce(((t,s)=>t+s),0)/s.L.length}}catch(t){throw t}}D(){this.h=!0,t&&t.remove(),a.style.display="none",n.style.display="block",(async()=>{let t=await this.j(this.t),s=document.createElement("p");s.innerHTML='<span class="cat">Sharpness:</span> '+t.O.toFixed(2),n.appendChild(s);let a=document.createElement("p");a.innerHTML='<span class="cat">Contrast:</span> '+t.H.toFixed(2),n.appendChild(a);let e=document.createElement("p");e.innerHTML="<span>Color Distribution:</span> "+t.J.toFixed(2),n.appendChild(e)})()}p(){if(u&&(d++,d>=50)){t.style.border="4px solid rgba(0, 0, 0, 0)",t.toDataURL("image/png");let s=document.createElement("canvas"),a=s.getContext("2d");a.imageSmoothingEnabled=!1,a.mozImageSmoothingEnabled=!1,s.width=t.width/4,s.height=t.height/4,a.drawImage(t,0,0,s.width,s.height);let n=s.toDataURL("image/png"),h=document.createElement("img");h.src=n;const r=(10*Math.random()-5).toFixed(2),i=parseFloat(r)%360;h.style.transform=`rotate(${i}deg)`,h.classList.add("photo"),e.querySelectorAll("p").length>0&&(e.innerHTML=""),e.appendChild(h),this.t.push(n),o.innerHTML="Gallery ("+this.t.length+" / 13 taken)",u=!1,13===this.t.length&&this.D()}s.clearRect(0,0,t.width,t.height),this.C(),this.v(),this.m(),this.k(),l++,requestAnimationFrame((()=>this.p()))}};document.getElementById("snapshotButton").addEventListener("click",(()=>{p.P()}))}));