(function(){"use strict";function t(t,e){this.x=t,this.y=e}function e(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s,this.x2=t+i,this.y2=e+s}function i(e,i,s){this.level=e,this.pos=i,this.move=t.zero(),this.r=s,this.rot=0,this.disposed=!1}function s(t,e,s,n,o){i.call(this,t,e,2),this.move=s,this.sender=n,this.attackPoints=o}function n(){i.apply(this,arguments),this.health=100}function o(t,e){n.call(this,t,e,10)}function r(t,e){o.call(this,t,e),this.reloadCount=0,this.following=!1,this.bfsReloadCount=0}function l(t,e){n.call(this,t,e,10),this.reloadCount=0,this.rangedAttackPoints=20}function h(t,i,s,n){this.objs=[],this.type=n,this.level=t,this.i=i,this.j=s,this.rect=new e(i*t.cellWidth,s*t.cellWidth,t.cellWidth,t.cellWidth)}function a(t,e,i,s,n){var o,r,a,c=[];if(t%2===0||e%2===0)throw"Gimme odd numbers";for(this.cellWidth=i,this.numCellRows=t,this.numCellCols=e,a=0;t>a;a++){for(o=[],r=0;e>r;r++)o.push(new h(this,r,a,S));c.push(o)}for(a=0;t>a;a++)c[a][0].type=L,c[a][e-1].type=L;for(r=0;e>r;r++)c[0][r].type=L,c[t-1][r].type=L;this.cells=c,this.bullets=[],this.enemies=[],this.onLevelExit=s,this.onGameOver=n,this.player=new l(this,c[1][1].getCenterPoint()),this.generate()}function c(){var t=function(t){se++,c(),ie.player.health=t.player.health,t.remove()},e=function(t){se=1,c(),t.remove()};ie=new a(33,31,40,t,e)}function u(){p.requestAnimationFrame(u),d()}function d(){N.drawImage(Z,0,0),ie.render(J),J.fillStyle="red",J.font="20px Arial",J.fillText("HP "+ie.player.health,30,30),J.fillText("Level "+se,700,30)}function f(){setInterval(function(){ie.tick()},16)}var p=this,v=Math.sqrt(2),y=Math.PI/180,m=function(t){return y*t};t.zero=function(){return new this(0,0)},t.getSquaredDistance=function(t,e){return t.sub(e).getSquaredLength()},t.direction=function(t){var e=Math.cos(t),i=Math.sin(t);return new this(e,i)};var g=t.prototype;g.clone=function(){return new this.constructor(this.x,this.y)},g._addCoords=function(t,e){return this.x+=t,this.y+=e,this},g._add=function(t){return this._addCoords(t.x,t.y)},g._sub=function(t){return this._addCoords(-t.x,-t.y)},g._scalarMul=function(t){return this.x*=t,this.y*=t,this},g._normalize=function(){return this._scalarMul(1/this.getLength())},g.reset=function(){return this.x=0,this.y=0,this},g.add=function(t){return this.clone()._add(t)},g.sub=function(t){return this.clone()._sub(t)},g.scalarMul=function(t){return this.clone()._scalarMul(t)},g.neg=function(){return new this.constructor(-this.x,-this.y)},g.dot=function(t){return this.x*t.x+this.y*t.y},g.getSquaredLength=function(){return this.dot(this)},g.getLength=function(){return Math.sqrt(this.getSquaredLength())},g.isZero=function(){return 0===this.x&&0===this.y},g.toString=function(){return"("+this.x+", "+this.y+")"};var C=e.prototype;C.collidesWithPoint=function(t){return this.x<=t.x&&t.x<=this.x+this.width&&this.y<=t.y&&t.y<=this.y+this.height},C._loadCollisionVector=function(t,e){return t.x=e.x<this.x?e.x-this.x:this.x2<e.x?e.x-this.x2:0,t.y=e.y<this.y?e.y-this.y:this.y2<e.y?e.y-this.y2:0,t};var b=i.prototype;b.color="rgb(255,255,255)",b.wallCollisionSlide=!1,b.render=function(t){var e=this.pos,i=this.r;t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fillStyle=this.color,t.fill(),t.closePath()},b.advance=function(){this.pos._add(this.move)},b.react=function(){},b.collidesWithObj=function(e){var i=e.r+this.r,s=i*i;return t.getSquaredDistance(e.pos,this.pos)<s},b.attack=function(t,e){this.level.attack(this,t,e)},b.decreaseHealth=function(){},b._markDisposed=function(){this.disposed=!0};var w=s.prototype=Object.create(i.prototype);w.color="rgb(255,255,0)",w.react=function(){var t,e=[this.level.player].concat(this.level.enemies);for(t=0;t<e.length;t++)this.collidesWithObj(e[t])&&(this.sender.attack(e[t],this.attackPoints),this.move.reset());this.move.isZero()&&this._markDisposed()};var x=n.prototype=Object.create(i.prototype);x.wallCollisionSlide=!0,x.decreaseHealth=function(t){this.health<=t?(this.health=0,this._markDisposed()):this.health-=t};var _=o.prototype=Object.create(n.prototype);_.color="rgb(0,0,255)";var j=r.prototype=Object.create(o.prototype);j.react=function(){var t,e,i,s,n,o,r,l,h=this.level.player,a=this.level,c=a.mapObjToCell(h),u=a.mapObjToCell(this),d=Math.abs(u.i-c.i),f=Math.abs(u.j-c.j),p=.5;if(this.move._scalarMul(.8),this.collidesWithObj(h)&&0===this.reloadCount&&(this.attack(h,3),this.reloadCount=10),this.following?(d>10||f>10)&&(this.following=!1):5>d&&5>f&&(this.following=!0),1>=d&&1>=f)this.move._add(h.pos.sub(this.pos)._normalize()._scalarMul(p));else if(this.following){for(0===this.bfsReloadCount?(t=this._bfsdistances=a.cellBFS(c,u),this.bfsReloadCount=1e4+10*Math.random()|0):t=this._bfsdistances,t=a.cellBFS(c,u),e=u.getAdjacentCells().filter(function(e){return"undefined"!=typeof t[e.getHashKey()]}),s=u,n=t[s.getHashKey()],i=0;i<e.length;++i)o=e[i],t[o.getHashKey()]<n&&(s=o,n=t[o.getHashKey()]);r=s.i-u.i,l=s.j-u.j,this.move._addCoords(r*p,l*p)}this.reloadCount>0&&--this.reloadCount,this.bfsReloadCount>0&&--this.bfsReloadCount};var k=l.prototype=Object.create(n.prototype);k.color="rgb(255,0,0)",k.react=function(e,i){var n,o,r,l,h=4,a=t.zero();e[H]&&a._addCoords(0,-h),e[A]&&a._addCoords(0,h),e[P]&&a._addCoords(-h,0),e[W]&&a._addCoords(h,0);var c=t.direction(m(this.rot+270));e[R]&&a._add(c.scalarMul(h)),e[q]&&a._sub(c.scalarMul(h)),e[z]&&(this.rot-=5),e[K]&&(this.rot+=5),a.getSquaredLength()===2*h*h&&a._scalarMul(1/v),this.move._scalarMul(.5),this.move._add(a),(e[I]||i)&&0===this.reloadCount&&(l=i?i.clone()._addCoords(-Q/2,-U/2)._normalize():this.move.clone()._normalize(),o=this.pos.add(l.scalarMul(1.5*this.r)),r=l.scalarMul(15),n=new s(this.level,o,r,this,this.rangedAttackPoints),this.level.bullets.push(n),this.reloadCount=10),this.reloadCount>0&&--this.reloadCount};var M=h.prototype;M.render=function(t){var e=this.level.cellWidth,i=this.i,s=this.j;ee[this.type]?t.drawImage(ee[this.type],i*e,s*e):(t.fillStyle="rgb(0,0,0)",t.fillRect(i*e,s*e,e,e))},M.getHashKey=function(){return this.i+"x"+this.j},M.getCenterPoint=function(){var e=this.level.cellWidth;return new t(e*(this.i+.5),e*(this.j+.5))},M.getAdjacentCells=function(){var t=this.i,e=this.j,i=this.level.cells;return[i[e-1][t],i[e][t-1],i[e+1][t],i[e][t+1]]};var O,L="wall",S="empty",E="exit",H="move-up",A="move-down",P="move-left",W="move-right",I="fire",R="move-forward",q="move-backward",z="turn-left",K="turn-right",B=1;O=2===B?{37:z,38:R,39:K,40:q,65:I}:{37:P,38:H,39:W,40:A,87:H,83:A,65:P,68:W,13:I};var T={},F=null,D=t.zero(),G=!1,V=!1,X=a.prototype;X.generate=function(){var t,e,i,s,n=this.cells,o=this.numCellRows/2|0,l=this.numCellCols/2|0,h=o/2|0,a=l/2|0,c=function(t){return Math.random()*t|0};for(i=0;h*a>i;i++)t=4*c(a-1)+4,e=4*c(h-1)+4,n[e][t].type=L;for(i=0;o*l*.5>i;i++)t=2*c(l-1)+2,e=2*c(o-1)+2,n[e][t].type=L;for(i=0;o*l*2>i;i++)t=2*c(l)+1,e=2*c(o-1)+2,n[e][t-1].type===L&&n[e][t+1].type===L&&(n[e][t].type=L,this.areCellsConnected()||(n[e][t].type=S));for(i=0;o*l*2>i;i++)t=2*c(l-1)+2,e=2*c(o)+1,n[e-1][t].type===L&&n[e+1][t].type===L&&(n[e][t].type=L,this.areCellsConnected()||(n[e][t].type=S));var u=n[1][1],d=this.cellBFS(u),f=0,p=u;this.eachCell(function(t){d[t.getHashKey()]>f&&(f=d[t.getHashKey()],p=t)}),p.type=E;var v=30;for(i=0;v>i;i++)t=2*c(l)+1,e=2*c(o)+1,(1!==t||1!==e)&&(s=new r(this,n[e][t].getCenterPoint()),this.enemies.push(s))},X.remove=function(){delete this.player,delete this.bullets,delete this.cells,delete this.onLevelExit,delete this.onGameOver},X.cellBFS=function(t,e){var i,s,n=(this.cells,{}),o={},r=[],l=function(t){return t.getAdjacentCells().filter(function(t){return t&&t.type!==L})},h=function(t){return l(t[0]).map(function(e){return[e,t[1]+1]})};for(r.push([t,0]);r.length>0;)if(i=r.shift(),s=i[0].getHashKey(),!n[s]){if(o[s]=i[1],n[s]=!0,i[1]===e)break;Array.prototype.push.apply(r,h(i))}return o},X.eachCell=function(t){var e,i;for(i=0;i<this.numCellRows;i++)for(e=0;e<this.numCellCols;e++)t(this.cells[i][e])},X.getAllCells=function(){var t=[];return this.eachCell(function(e){t.push(e)}),t},X.areCellsConnected=function(){var t=this.cellBFS(this.cells[1][1]);return this.getAllCells().filter(function(t){return t.type!=L}).every(function(e){return"undefined"!=typeof t[e.getHashKey()]})},X.render=function(t){var e,i;for(t.fillStyle="#000",t.fillRect(0,0,Q,U),t.save(),t.translate(Q/2,U/2),t.rotate(m(-this.player.rot)),t.translate(0|-this.player.pos.x,0|-this.player.pos.y),i=0;i<this.numCellRows;i++)for(e=0;e<this.numCellCols;e++)this.cells[i][e].render(t);for(this.player.render(t),e=0;e<this.bullets.length;e++)this.bullets[e].render(t);for(e=0;e<this.enemies.length;e++)this.enemies[e].render(t);t.restore()},X.mapObjToCell=function(t){var e=t.pos.x/this.cellWidth|0,i=t.pos.y/this.cellWidth|0;return this.cells[i][e]},X.checkObjCollisions=function(e){var i,s,n,o,r,l=t.zero(),h=e.r*e.r;for(o=e.pos.add(e.move),s=0;s<this.numCellRows;s++)for(i=0;i<this.numCellCols;i++)if(n=this.cells[s][i],(n.type===L||n.type===E)&&(n.rect._loadCollisionVector(l,o),r=l.getSquaredLength(),h>=r)){if(n.type===E&&e===this.player)return void(this.levelExitHappened=!0);if(e.wallCollisionSlide){if(r>0){l._scalarMul(e.move.dot(l)/r),e.move._sub(l),o=e.pos.add(e.move);continue}return void e.move.reset()}return void e.move.reset()}},X.checkCollisions=function(){var t,e=[this.player].concat(this.bullets,this.enemies);for(t=0;t<e.length;t++)this.checkObjCollisions(e[t])},X.react=function(){var t,e=[].concat(this.bullets,this.enemies);for(F=V&&G?D:null,this.player.react(T,F),t=0;t<e.length;t++)e[t].react()},X.advance=function(){var t,e=[this.player].concat(this.bullets,this.enemies);for(t=0;t<e.length;t++)e[t].advance()},X.disposeObjectsInArray=function(t){var e;for(e=0;e<t.length;e++)t[e].disposed&&(t.splice(e,1),--e)},X.disposeObjects=function(){this.disposeObjectsInArray(this.bullets),this.disposeObjectsInArray(this.enemies)},X.tick=function(){return this.react(),this.checkCollisions(),this.advance(),this.disposeObjects(),this.player.health<=0?void this.onGameOver(this):this.levelExitHappened?void this.onLevelExit(this):void 0},X.attack=function(t,e,i){e.decreaseHealth(i)};var Y=document.getElementById("canvas"),Z=p.document.createElement("canvas"),J=Z.getContext("2d"),N=Y.getContext("2d"),Q=800,U=600;Z.width=Q,Z.height=U;var $,te,ee={};$=new Image,$.src="img/wall.gif",te=new Image,te.src="img/exit.gif",ee[L]=$,ee[E]=te;var ie=null,se=1;window.addEventListener("keyup",function(t){var e=t.which||t.keyCode;O[e]&&(T[O[e]]=!1)},!1),window.addEventListener("keydown",function(t){var e=t.which||t.keyCode;O[e]&&(T[O[e]]=!0)},!1);var ne=document.getElementById("canvas-container");ne.addEventListener("mousedown",function(t){D.x=t.clientX-ne.offsetLeft,D.y=t.clientY-ne.offsetTop,G=!0},!1),ne.addEventListener("mousemove",function(t){D.x=t.clientX-ne.offsetLeft,D.y=t.clientY-ne.offsetTop},!1),ne.addEventListener("mouseup",function(){G=!1},!1),ne.addEventListener("mouseenter",function(){V=!0},!1),ne.addEventListener("mouseleave",function(){V=!1,G=!1},!1),c(),f(),u(),p.Vector=t}).call(this);