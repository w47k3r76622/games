"use strict";let users=new Set;function startGame(e,n){let o=Math.floor(Math.random()*2)==0;o?new Game(e,n).start():new Game(n,e).start();storage.get('games',0).then(e=>{storage.set('games',e+1)})}function findOpponent(e){for(let n of users)e!==n&&n.opponent===null&&startGame(e,n)}function startGameWithBasicAI(e){startGame(e,new BasicAI)}function startGameWithBetterAI(e){startGame(e,new BetterAI)}function removeUser(e){users.delete(e)}class Game{constructor(e,n){this.user1=e;this.user2=n;this.user1.playerNo=PLAYER_1;this.user2.playerNo=PLAYER_2;this.turn=Math.floor(Math.random()*2);this.gameboard=new RectGameBoard(8,6,!1);this.gameboard.createBoard()}start(){this.user1.start(this,this.user2);this.user2.start(this,this.user1)}ended(){return this.gameboard.isBoardFilled()||this.user1.passed&&this.user2.passed}doTurn(){this.turn=(this.turn+1)%NUM_PLAYERS}score(){let e=this.gameboard.getScores();e[this.user1.playerNo]>e[this.user2.playerNo]?(this.user1.win(),this.user2.lose()):e[this.user1.playerNo]<e[this.user2.playerNo]?(this.user2.win(),this.user1.lose()):(this.user1.draw(),this.user2.draw())}}class User{constructor(e){this.socket=e;this.playerNo=null;this.game=null;this.opponent=null;this.passed=!1}start(e,n){this.game=e;this.opponent=n;this.socket.emit("start",this.game.gameboard,this.playerNo)}end(){this.game=null;this.opponent=null;this.socket.emit("end")}wait(){this.socket.emit("wait",this.game.gameboard,this.game.gameboard.getScores())}turn(){this.socket.emit("turn",this.game.gameboard,this.game.gameboard.getScores(),this.game.gameboard.getValidMoves(this.playerNo))}win(){this.socket.emit("win",this.opponent.guess)}lose(){this.socket.emit("lose",this.opponent.guess)}draw(){this.socket.emit("draw",this.opponent.guess)}}class BasicAI extends User{constructor(){super(null);this.playerNo=null;this.game=null;this.opponent=null;this.passed=!1}start(e,n){this.game=e;this.opponent=n}end(){this.game=null;this.opponent=null}wait(){}turn(){let e=this;if(e.game.ended()){e.game.score();return}let[n,o]=alphabeta(e.game.gameboard.copy(),1,-Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!0,e.playerNo);setTimeout(function(){o!==void 0?(e.game.gameboard.doMove(o.r,o.c,e.playerNo),e.passed=!1):(e.passed=!0);e.opponent.turn();e.wait();e.game.doTurn();e.game.ended()&&e.game.score()},1e3)}win(){}lose(){}draw(){}}class BetterAI extends User{constructor(){super(null);this.playerNo=null;this.game=null;this.opponent=null;this.passed=!1}start(e,n){this.game=e;this.opponent=n}end(){this.game=null;this.opponent=null}wait(){}turn(){let e=this;if(e.game.ended()){e.game.score();return}let[n,o]=alphabeta(e.game.gameboard.copy(),3,-Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!0,e.playerNo);setTimeout(function(){o!==void 0?(e.game.gameboard.doMove(o.r,o.c,e.playerNo),e.passed=!1):(e.passed=!0);e.opponent.turn();e.wait();e.game.doTurn();e.game.ended()&&e.game.score()},1e3)}win(){}lose(){}draw(){}}function alphabeta(e,n,o,t,a,r){if(n===0||e.isBoardFilled()){let n=e.getScores();return[n[r]-n[(r+1)%NUM_PLAYERS],void 0]}let s=o,u=t;if(a){let o=e.getValidMoves(r);if(o.length>0){let t=-Number.MAX_SAFE_INTEGER,a=void 0;for(let p of o){let o=e.copy();o.doMove(p.r,p.c,r);let[d,c]=alphabeta(o,n-1,s,u,!1,r);d>t&&(t=d,a=p);s=Math.max(s,t);if(s>=u)break}return[t,a]}else{return[alphabeta(e,n-1,s,u,!1,r),void 0]}}else{let o=(r+1)%NUM_PLAYERS,t=e.getValidMoves(o);if(t.length>0){let a=Number.MAX_SAFE_INTEGER,p=void 0;for(let d of t){let t=e.copy();t.doMove(d.r,d.c,o);let[c,l]=alphabeta(t,n-1,s,u,!0,r);c<a&&(a=c,p=d);u=Math.min(u,a);if(s>=u)break}return[a,p]}else{return[alphabeta(e,n-1,s,u,!0,r),void 0]}}}module.exports={io:e=>{let n=new User(e);e.on("find-human",()=>{console.log("Find Human: "+e.id),users.add(n),findOpponent(n),n.opponent&&(n.game.turn===n.playerNo?(n.opponent.wait(),n.turn()):(n.opponent.turn(),n.wait()))});e.on("start-basic-ai",()=>{console.log("Start basic AI: "+e.id),removeUser(n),startGameWithBasicAI(n),n.opponent&&(n.game.turn===n.playerNo?(n.opponent.wait(),n.turn()):(n.opponent.turn(),n.wait()))});e.on("start-better-ai",()=>{console.log("Start Better AI: "+e.id),removeUser(n),startGameWithBetterAI(n),n.opponent&&(n.game.turn===n.playerNo?(n.opponent.wait(),n.turn()):(n.opponent.turn(),n.wait()))});e.on("disconnect",()=>{console.log("Disconnected: "+e.id),removeUser(n),n.opponent&&n.opponent.end()});e.on("move",o=>{console.log("Move: "+e.id),n.game.turn===n.playerNo&&(n.game.gameboard.doMove(o.r,o.c,n.playerNo)&&(n.passed=!1,n.wait(),n.opponent.turn(),n.game.doTurn()),n.game.ended()&&n.game.score())});e.on("pass",()=>{console.log("Pass: "+e.id),n.game.turn===n.playerNo&&(n.passed=!0,n.wait(),n.opponent.turn(),n.game.doTurn(),n.game.ended()&&n.game.score())});console.log("Connected: "+e.id)},stat:(e,n)=>{storage.get('games',0).then(e=>{n.send(`<h1>Games played: ${e}</h1>`)})}}