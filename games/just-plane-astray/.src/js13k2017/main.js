(async()=>{function e(e,t,n,r,i,a){var o=2*i/(t-e),l=2*i/(r-n),s=(t+e)/(t-e),u=(r+n)/(r-n),f=-(a+i)/(a-i),c=-2*a*i/(a-i);return $M([[o,0,s,0],[0,l,u,0],[0,0,f,c],[0,0,-1,0]])}function t(e,t,n,r,i,a,o,l,s){var u=$V([e,t,n]),f=$V([r,i,a]),c=$V([o,l,s]),h=u.subtract(f).toUnitVector(),d=c.cross(h).toUnitVector(),A=h.cross(d).toUnitVector(),m=$M([[d.e(1),d.e(2),d.e(3),0],[A.e(1),A.e(2),A.e(3),0],[h.e(1),h.e(2),h.e(3),0],[0,0,0,1]]),R=$M([[1,0,0,-e],[0,1,0,-t],[0,0,1,-n],[0,0,0,1]]);return m.x(R)}function n(){M=Matrix.I(4)}function r(e){M=M.x(e)}function i(e){r(Matrix.Translation($V([e[0],e[1],e[2]])).ensure4x4())}function a(e){e?(U.push(e.dup()),M=e.dup()):U.push(M.dup())}function o(){M=U.pop()}function l(e,t){r(Matrix.Rotation(e,$V([t[0],t[1],t[2]])).ensure4x4())}function s(e,c,h,A,m,R){let T=Vector.k.rotate(V,Line.X).rotate(C,Line.Y);O=T.x(-.005).reflectionIn(Plane.YZ).add($);let p=Math.atan2(G.e(3),G.e(1));if(X=-(C-Math.PI/2-p),k||(V*=.95),G=G.add(O),Math.hypot(G.e(1),G.e(2),G.e(3))>.3&&(G=G.toUnitVector().x(.3)),(P=P.add(G)).add(J.x(-1)).len()<20)return void u();if(P.e(2)<0&&Math.hypot(P.e(1),P.e(3))>100)return void f();(P.e(1)<-1500||P.e(1)>1500||P.e(3)<-1500||P.e(3)>1500)&&(P=P.x(.95),P=P.rotate(Math.PI,Line.Y)),(null==q||P.subtract(q).len()>100)&&(j=Array(50).fill(0).map(e=>[P.e(1)+500*Math.random()-250,P.e(3)+500*Math.random()-250]),q=P.dup()),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),d.useProgram(E),n();let[F,x,g]=P.elements;x<-.5&&(P.setElements([F,-.5,g]),x=-.5,G=G.reflectionIn(Plane.XZ));let[b,M,U]=P.add(T.x(10).reflectionIn(Plane.YZ)).elements;r(t(b,M+3,U,P.e(1),P.e(2),P.e(3),0,1,0));for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++)a(),i([0,-3,0]),r(Matrix.Diagonal([20,1,20,1])),Z(R),o();a(),i([0,-2,0]),S(Q),o(),a(),i([F,-1.95,g]),l(-C,[0,1,0]),r(Matrix.Diagonal([1,0,1,1])),l(X,[0,0,1]),l(V+Math.PI/16,[1,0,0]),Z(c),o(),a(),i([F,x,g]),l(-C,[0,1,0]),l(X,[0,0,1]),l(V+Math.PI/16,[1,0,0]),Z(e),o(),a(),d.useProgram(v),d.bindBuffer(d.ARRAY_BUFFER,h.verticesBuffer),d.vertexAttribPointer(B,3,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,h.textureBuffer),d.vertexAttribPointer(_,2,d.FLOAT,!1,0,0),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,h.texture),d.uniform1i(y,0),j.forEach(([e,t])=>{a(),i([e,4.5,t]),l(Math.PI,[1,0,0]),r(.25),z(h),o()}),a(),l(Math.PI,[1,0,0]),d.uniform1i(y,1),d.activeTexture(d.TEXTURE1),d.bindTexture(d.TEXTURE_2D,A.texture),i([0,-17,0]),r(.1),z(A),o(),a(),l(Math.PI,[1,0,0]),d.uniform1i(y,2),d.activeTexture(d.TEXTURE2),d.bindTexture(d.TEXTURE_2D,m.texture),i(J.elements),r(1/8),z(m),o(),requestAnimationFrame(s.bind(this,e,c,h,A,m,R))}function u(){document.body.style.backgroundColor="#ebb200",h.style.opacity=0,setTimeout(()=>{document.querySelectorAll("svg").forEach(e=>{e.style.width=h.width,e.style.display="block"}),document.querySelectorAll(".lose").forEach(e=>e.style.display="none"),ee(K)},2e3)}function f(){document.body.style.backgroundColor="#000080",h.style.opacity=0,setTimeout(()=>{document.querySelectorAll("svg").forEach(e=>{e.style.width=h.width,e.style.display="block"}),document.getElementById("win").style.display="none",ee(K)},2e3)}Array.prototype.flatten=function(){return this.reduce((e,t)=>e.concat(t),[])},Matrix.Translation=(e=>{if(2==e.elements.length){let t=Matrix.I(3);return[t.elements[2][0],t.elements[2][1]]=[e.elements[0],e.elements[1]],t}if(3==e.elements.length){let t=Matrix.I(4);return[t.elements[0][3],t.elements[1][3],t.elements[2][3]]=[e.elements[0],e.elements[1],e.elements[2]],t}}),Matrix.prototype.flatten=function(){var e=[];if(0==this.elements.length)return[];for(var t=0;t<this.elements[0].length;t++)for(var n=0;n<this.elements.length;n++)e.push(this.elements[n][t]);return e};var c=e=>{for(var t=[],n=[],r=[],i={verts:[],norms:[],textures:[],hashindices:[],indices:[],index:0},a=e.split("\n"),o=/^v\s/,l=/^vn\s/,s=/^vt\s/,u=/^f\s/,f=/\s+/,c=0;c<a.length;c++){var h=a[c].trim(),d=h.split(f);if(d.shift(),o.test(h))t.push.apply(t,d);else if(l.test(h))n.push.apply(n,d);else if(s.test(h))r.push.apply(r,d);else if(u.test(h))for(var A=!1,m=0,R=d.length;m<R;m++){if(3!==m||A||(m=2,A=!0),d[m]in i.hashindices)i.indices.push(i.hashindices[d[m]]);else{var E=d[m].split("/");i.verts.push(+t[3*(E[0]-1)+0]),i.verts.push(+t[3*(E[0]-1)+1]),i.verts.push(+t[3*(E[0]-1)+2]),r.length&&(i.textures.push(+r[2*(E[1]-1)+0]),i.textures.push(+r[2*(E[1]-1)+1])),i.norms.push(+n[3*(E[2]-1)+0]),i.norms.push(+n[3*(E[2]-1)+1]),i.norms.push(+n[3*(E[2]-1)+2]),i.hashindices[d[m]]=i.index,i.indices.push(i.index),i.index+=1}3===m&&A&&i.indices.push(i.hashindices[d[0]])}}return{vertices:i.verts,vertexNormals:i.norms,textures:i.textures,indices:i.indices}};let h=document.getElementById("c");[h.width,h.height]=[window.innerWidth,window.innerHeight];let d=h.getContext("webgl");d.clearColor(.39,.81,.95,1),d.clearDepth(1),d.enable(d.BLEND),d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA),d.enable(d.DEPTH_TEST),d.depthFunc(d.LEQUAL);let A=`\nattribute vec3 avp;\nuniform mat4 mvm;\nuniform mat4 pm;\n`,m=(`\nvarying lowp vec4 v;\nvoid main(void) {\n  gl_FragColor = v;\n}\n`,`\n${A}\nattribute vec2 tc;\nvarying highp vec2 v;\nvoid main(void) {\n  mat4 i = mvm;\n  i[0][0] = 1.0;\n  i[0][1] = 0.0;\n  i[0][2] = 0.0;\n  i[1][0] = 0.0;\n  i[1][1] = -1.0;\n  i[1][2] = 0.0;\n  i[2][0] = 0.0;\n  i[2][1] = 0.0;\n  i[2][2] = 1.0;\n  gl_Position = pm * i * vec4(avp, 1.0);\n  v = tc;\n}\n`),R=(`\nvarying highp vec2 v;\nuniform sampler2D uS;\nvoid main(void) {\n  gl_FragColor = texture2D(uS, v);\n  if (gl_FragColor.a < 0.4) discard;\n}\n`,(e,t)=>{let n=d.createShader(d.VERTEX_SHADER),r=d.createShader(d.FRAGMENT_SHADER),i=d.createProgram();return d.shaderSource(n,e),d.compileShader(n),d.shaderSource(r,t),d.compileShader(r),d.attachShader(i,n),d.attachShader(i,r),d.linkProgram(i),i}),E=R(`\n${A}\nattribute vec4 c;\nvarying lowp vec4 v;\nvoid main(void) {\n  gl_Position = pm * mvm * vec4(avp, 1.0);\n  v = c;\n}\n`,"\nvarying lowp vec4 v;\nvoid main(void) {\n  gl_FragColor = v;\n}\n"),v=R(m,"\nvarying highp vec2 v;\nuniform sampler2D uS;\nvoid main(void) {\n  gl_FragColor = texture2D(uS, v);\n  if (gl_FragColor.a < 0.4) discard;\n}\n"),T=d.getUniformLocation(E,"mvm"),p=d.getUniformLocation(E,"pm"),F=d.getAttribLocation(E,"avp");d.enableVertexAttribArray(F);let x=d.getAttribLocation(E,"c");d.enableVertexAttribArray(x);let B=d.getAttribLocation(v,"avp");d.enableVertexAttribArray(B);let _=d.getAttribLocation(v,"tc");d.enableVertexAttribArray(_);let g=d.getUniformLocation(v,"mvm"),b=d.getUniformLocation(v,"pm"),y=d.getUniformLocation(v,"uS");Matrix.prototype.ensure4x4=function(){if(4==this.elements.length&&4==this.elements[0].length)return this;if(this.elements.length>4||this.elements[0].length>4)return null;for(t=0;t<this.elements.length;t++)for(var e=this.elements[t].length;e<4;e++)t==e?this.elements[t].push(1):this.elements[t].push(0);for(var t=this.elements.length;t<4;t++)0==t?this.elements.push([1,0,0,0]):1==t?this.elements.push([0,1,0,0]):2==t?this.elements.push([0,0,1,0]):3==t&&this.elements.push([0,0,0,1]);return this};let M;const U=[];let D=function(t,n,r,i){var a=r*Math.tan(t*Math.PI/360),o=-a;return e(o*n,a*n,o,a,r,i)}(120,h.width/h.height,.1,1e3);const I=Array(2).fill(0).map(e=>[1,1,1,1,.7,.7,.7,1,1,1,1,1]).flatten(),w=async(e,t)=>{const n=await fetch(e).then(e=>e.text()),r=c(n),i=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,i),d.bufferData(d.ARRAY_BUFFER,new Float32Array(r.vertices),d.STATIC_DRAW);const a=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,a),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t),d.STATIC_DRAW);const o=d.createBuffer();return d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,o),d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(r.indices),d.STATIC_DRAW),{vertexBuffer:i,indexBuffer:o,colorBuffer:a,indices:r.indices}};let S=e=>{d.bindBuffer(d.ARRAY_BUFFER,e.vertexBuffer),d.vertexAttribPointer(F,3,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,e.colorBuffer),d.vertexAttribPointer(x,4,d.FLOAT,!1,0,0),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,e.indexBuffer),d.uniformMatrix4fv(p,!1,new Float32Array(D.flatten())),d.uniformMatrix4fv(T,!1,new Float32Array(M.flatten())),d.drawElements(d.TRIANGLE_FAN,e.indices.length+1,d.UNSIGNED_SHORT,0)};const L=async(e,t)=>{const n=new Image;n.width=256,n.height=512;const r=new Promise(async t=>{n.src=e,n.onload=(()=>{t(n)})});let i=await Promise.all([fetch("texplane.obj").then(e=>e.text()),r]);const a=c(i[0]),o=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,o),d.bufferData(d.ARRAY_BUFFER,new Float32Array(a.vertices),d.STATIC_DRAW);const l=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,l),d.bufferData(d.ARRAY_BUFFER,new Float32Array(a.textures),d.STATIC_DRAW);const s=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,s),d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),d.STATIC_DRAW);const u=d.createTexture();return d.activeTexture(t),d.bindTexture(d.TEXTURE_2D,u),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,i[1]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.bindTexture(d.TEXTURE_2D,null),{verticesBuffer:o,textureBuffer:l,indexBuffer:s,texture:u,indices:a.indices}};let P,[Y,N]=[null,null],C=0,V=0,X=0,$=$V([0,-.001,0]),O=$V([0,0,0]),G=$V([0,0,-.02]);{let e=Math.random()*Math.PI*2,t=900*Math.random()+500;P=$V([Math.cos(e)*t,30,Math.sin(e)*t])}let[H,W]=[0,0];h.addEventListener("touchmove",e=>{e.preventDefault();let t=e.touches[0],[n,r]=[t.clientX,t.clientY];if(null===Y)return void([Y,N]=[n,r]);let i=r-N;C+=(n-Y)/h.width*4,V+=i/h.height*4,[Y,N]=[n,r],W=n});let k=!1;h.addEventListener("touchstart",e=>{e.preventDefault();let t=e.touches[0],[n,r]=[t.clientX,t.clientY];k=!0,H=n}),h.addEventListener("touchend",e=>{e.preventDefault(),k=!1,[Y,N]=[null,null]}),Vector.prototype.len=function(){return Math.hypot.apply(this,this.elements)};let j=[],q=null,Z=e=>{d.bindBuffer(d.ARRAY_BUFFER,e.vertexBuffer),d.vertexAttribPointer(F,3,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,e.colorBuffer),d.vertexAttribPointer(x,4,d.FLOAT,!1,0,0),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,e.indexBuffer),d.uniformMatrix4fv(p,!1,new Float32Array(D.flatten())),d.uniformMatrix4fv(T,!1,new Float32Array(M.flatten())),d.drawElements(d.TRIANGLES,e.indices.length,d.UNSIGNED_SHORT,0)};const Q=(()=>{let e=Math.floor(20*Math.random())+3,t=Array(e).fill(0).map((t,n)=>[150*Math.cos(2*n*Math.PI/e)*Math.max(Math.random(),.5),0,150*Math.sin(2*n*Math.PI/e)*Math.max(Math.random(),.5)]);t.unshift([0,0,0]);const n=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,n),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t.flatten()),d.STATIC_DRAW);const r=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,r),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t.map((e,t)=>0==t?[0,.4,0,1]:[.8,.5,0,1]).flatten()),d.STATIC_DRAW);const i=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,i);let a=Array(t.length).fill(0).map((e,t)=>t);return a.push(1),d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),d.STATIC_DRAW),{vertexBuffer:n,colorBuffer:r,indexBuffer:i,indices:t}})();let z=e=>{d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,e.indexBuffer),d.uniformMatrix4fv(b,!1,new Float32Array(D.flatten())),d.uniformMatrix4fv(g,!1,new Float32Array(M.flatten())),d.drawElements(d.TRIANGLES,e.indices.length,d.UNSIGNED_SHORT,0)};const J=$V([20,-13,0]);let K;Promise.all([w("pplane.obj",I),w("pplane.obj",I.map((e,t)=>t%4==3?.8:0)),L("wave.png",d.TEXTURE0),L("tree.png",d.TEXTURE1),L("sos.svg",d.TEXTURE2),w("groundplane.obj",Array(4).fill([0,0,.5,1]).flatten())]).then(([e,t,n,r,i,a])=>{K=new Date,s(e,t,n,r,i,a)});let ee=e=>document.getElementById("res").innerText=`time: ${Math.round((new Date-e)/1e3)-2}s`})();