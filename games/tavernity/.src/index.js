let e="p-l",t="p-r",r="p-w",l="p-b",i="pd-l",s="pd-r",a="f-l",o="f-r",n="pd-w",m=m=>{let f,c=m.getPlayer(),d=m.getAdjItem([c.x,c.y]),g=m.getAdjTile;if("sw"===c.itemLeft?.name)return f=g([c.x,c.y],[v]),f?{type:n}:{type:"sw"};if("buck"===c.itemLeft?.name)return f=g([c.x,c.y],[T]),f?{type:l}:{type:"d-b"};if(f=g([c.x,c.y],[x]))return{type:"r",tile:f};if(!(!d||c.itemLeft&&c.itemRight)){let[r,,[l,i]]=d;if("mugF"===d[0].name)for(let[e,t]of Ae([l,i])){let r=m.getPatronAt(e,t);if("wfd"===r?.getState())return}return{type:c.itemLeft?t:e,item:r}}return c.itemLeft||c.itemRight||!(f=g([c.x,c.y],[v]))?c.itemLeft||c.itemRight||!(f=g([c.x,c.y],[T]))?"mugE"===c.itemLeft?.name&&g([c.x,c.y],h)?{type:a,item:c.itemLeft}:"mugE"===c.itemRight?.name&&g([c.x,c.y],h)?{type:o,item:c.itemRight}:c.itemRight&&!["sword"].includes(c.itemRight.name)&&(f=g([c.x,c.y],u))&&!m.getItemAt(f[1],f[2])?{type:s,tile:f,item:c.itemRight}:c.itemLeft&&!["sword"].includes(c.itemLeft.name)&&(f=g([c.x,c.y],u))&&!m.getItemAt(f[1],f[2])?{type:i,tile:f,item:c.itemLeft}:void 0:{type:l,tile:f}:{type:r,tile:f}},f=()=>{let e={x:0,y:0,scale:1,vx:0,vy:0,remv:!1,getPos:()=>[e.x,e.y],update:()=>{},draw:()=>{}};return e},c={},d={},g=e=>{let t=c[e];if(!t)throw Error("No anim: "+e);let[,r,...l]=t.split(" "),i=parseInt(r);return function([e,t,r]){let l,i,s,a,o=e||!1,n=[];n=[],l=!1,i=0,s=0,a=0,r.forEach((({n:e,d:t,offsetX:r,offsetY:l,opacity:s})=>{n.push({n:e||"",timestampBegin:i,timestampEnd:i+(t??0),d:t??0,durationUpToNow:i,offsetX:r||0,offsetY:l||0,opacity:s}),i+=t??0}));let m={reset(){l=!1,s=0,m.start()},start(){a=ge()},update(){let e=ge();if(s===n.length-1&&o&&e-a>i){let t=a+i;m.reset(),m.start(),e-t<i&&(a=t)}s=(e=>{let t=0,r=s,l=n.length-1;for(;r<=l;){let i=r+Math.floor((l-r)/2);t=i;let{timestampEnd:s,timestampBegin:o}=n[i],m=(s||0)+a;if(e<m&&e>(o||0)+a)return i;e>=m?r=i+1:l=i-1}return t})(e),o||e-a>=i&&(l=!0)},getSprite:()=>n[s]?.n};return m}([!0,e,l.map((e=>({n:e,d:i})))])},p=[12,14,27,28,29,39],u=[19,20,21,22],h=[18],w=20,y=19,v=13,T=24,x=14,A=["",'"Hey, barkeep!\nFill a mug and set it down\nhere in front of me."',"Looks like it's busy today.\nPatrons are overflowing to the side room.","In Case of Fire:\nFETCH BUCKET OF WATER\nFROM WELL OUTSIDE","We need more tables!\nOpen up the other side room!","We're attracting moles now!\nGrab a weapon when you see 'em!\nThat's why we have a weapons rack!","Business is booming!\nWe have a whole new taproom now!","A bigger tavern always\nattracts more moles.","We need to expand again!\nTheres even more space\nin the back.","A bouncer would be nice\nto remove of all these moles!","We can squeeze a few more\n in the private taproom."],b=[4,2,6,5,1,3],L=e=>b.indexOf(e)+1,_=e=>p.includes(e),k=e=>26===e,P={font:"monospace",color:"#fff",size:14,align:"center",strokeColor:"black"},M=1,E=e=>{M=e},S=(e,t,r,l,i)=>{l=l||1,i=i||W();let s="string"==typeof e?$(e):e;if(!s)throw Error(`No sprite: "${e}"`);let[a,o,n,m,f]=s;i.drawImage(a,o,n,m,f,t,r,m*l,f*l)},D=(e,t,r,l,i,s,a)=>{(a=a||W())[s?"strokeStyle":"fillStyle"]=i,a[s?"strokeRect":"fillRect"](e,t,r,l)},O=(e,t,r,l,i)=>{let{font:s,size:a,color:o,align:n,strokeColor:m}={...P,...l||{}};(i=i||W()).font=`${a}px ${s}`,i.textAlign=n,i.textBaseline="middle",m&&(i.strokeStyle=m,i.lineWidth=4,i.strokeText(e,t,r)),i.fillStyle=o,i.fillText(e,t,r)},R=null,C=null,I=null,z=e=>{let[t,r,l]=j(e.width,e.height);return r.translate(l,0),r.scale(-1,1),r.drawImage(e,0,0),t},F=e=>{let[,,,t,r]=e,[l,i]=j(t,r);return S(e,0,0,1,i),l},j=(e,t)=>{let r=document.createElement("canvas");r.width=e,r.height=t;let l=r.getContext("2d");return l.imageSmoothingEnabled=!1,[r,l,e,t]},B=()=>{if(R)return R;{let[e,t]=j(576,576);return e.id="canv",t.lineWidth=2,window.canvasDiv.appendChild(e),R=e,e}},W=()=>B().getContext("2d"),$=e=>I[e],N=(e,[t,r,l])=>_(ue(e,t,l))&&-1===ue(e,r,l),U=(e,t)=>{let r=[];for(let l=0;l<e**2;l++)r.push(t);return r},V=(e,t,r)=>{let[l,i]=e,[,s,a]=t;N(e,t)&&(s[l+i*a]=r,Ae([l,i]).forEach((e=>{V(e,t,r)})))},H=(e,t)=>{let r=t[1]||[],l=t[2];if(0===r.length)for(let e=0;e<l**2;e++)r.push(-1);for(let r=0;r<l**2;r++){let i=[r%l,Math.floor(r/l)];if(N(i,t))return V(i,t,e),!0}return!1},q=(e,t,r,l)=>{let i=U(r,0),s=(l,i,a,o=!0)=>{var n;-1===ue(l,e,r)&&(a.push([l[0]+l[1]*r,i]),o&&(n=t[l[0]+l[1]*r],[13,17,18,18,20,21,22].concat(p).includes(n))&&Ae(l,!0).forEach((e=>{s(e,i,a,!1)})))},a=[];for(let t=0;t<r;t++)for(let o=0;o<r;o++){let n=t*r+o;e[n]===l&&(i[n]=l,Ae([o,t],!0).forEach((e=>{s(e,l,a)})))}for(let[e,t]of a)i[e]=t;return i},Y=(e,t)=>{let r=1,l=U(t,-1),i=[e,l,t];for(;H(r,i);)r++;let s=[];for(let i=1;i<r;i++)s.push(q(l,e,t,i));return s},G=()=>window.game;window.addEventListener("load",(()=>{X()}));let X=async()=>{K()},K=async()=>{await(async e=>{B();let t={},r={};await Promise.all([["sprite","res/sprite.png",16,16]].map((([e,l,i,s],a)=>new Promise((a=>{let o=new Image;o.onload=()=>{t[e]=o,((e,t,r,l,i)=>{let s=(t,r,l,i,s,a)=>{let[o,n]=j(s,a);return n.drawImage(r,l,i,s,a,0,0,s,a),e[t]=[o,0,0,s,a]},a=t.width/l,o=t.height/i;for(let e=0;e<o;e++)for(let r=0;r<a;r++){let o="s_"+(e*a+r),n=s(o,t,r*l,e*i,l,i);s(o+"_f",z(F(n)),0,0,l,i)}})(r,o,0,i,s),a()},o.src=l}))))),C=t,I=r})(),(()=>{let e=(e,t)=>{c[e]=t},t=[["mole",["s_9","s_10"]],["p_walk",["s_3"]],["p_wait",["s_3","s_4"]],["p2_wait",["s_5","s_6"]],["p_angry",["s_7","s_8"]],["part_+1",["s_39"]],["water",["s_40"]],["bloodf",["s_36"]],["blood",["s_35"]]];for(let[r,l]of t)e(r+"_l","t 300 "+l.join(" ")),e(r+"_r","t 300 "+l.map((e=>e+"_f")).join(" "));e("fire","t 150 s_14 s_15")})(),d.item=[,0,976,,,0,2,.15,-.4,,-547,.01,,,9.8,.1,,,.06,.03],d.itemPlace=[,0,104,,.15,.03,2,.38,,-61,,,.15,,,,,,.02,.36],d.doorOpen=[1.75,,151,.03,.01,.19,2,1.33,-9,,,,,.1,,,,.19,.01],d.doorClose=[1.24,,339,.12,.05,0,1,.42,-24,.1,,,.08,,-19,.6,,,,.79],d.fill=[1.09,,0,.19,,.02,,2.31,92,-25,927,,,,-1.4,.9,,.5,.09],d.moleDead=[2.1,,1360,.06,.09,.2,2,1.63,,,,,,.9,-.4,.1,.03,.57,,.01],d.moleAlert=[,,169,,.13,,2,2.18,.1,-7,,,.11,.6,,,,,.18,.05],d.plusOne=[1.12,,73,.02,.18,.06,2,.87,,,-190,.11,,,,,,.82,.01,.29],d.drawSword=[,,455,,.09,.01,2,2.31,,,-758,.01,.02,,,,,,.2,.59],d.swingSword=[,,232,.07,.02,0,4,.27,29,75,,,,.1,,,,,,.02],d.patronAngry=[1.29,,322,.03,.17,0,,.55,,-89,-843,.15,.09,.3,-234,,.02,,.09],d.dumpBucket=[1.99,,246,,.07,.03,4,.66,47,32,,,,,-.4,,.25,,.13,.83],d.hitS=[1.04,,772,,.07,.06,2,.31,90,-15,590,.02,,,,.3,,.47,.03],d.fire=[1.06,,1028,.11,.14,.03,4,.15,-4.8,,-690,.18,,.1,,.4,.07,.99,.15],d.dc=[,,80,.04,.03,.2,4,.34,-.3,,,,,,-9.9,,,,.18],d.levelDone=[1.04,,3,.06,.09,.09,1,.84,,14,,,,,5.2,,,.43,.13],d.levelScreen=[1.85,,123,.15,.15,.01,2,1.15,,-54,,,.26,,.3,,.06,.7,.03,.04],d.startLevel=[1.05,,0,.01,.17,.17,1,1.56,,73,225,.01,.09,,-.1,,,.43],d.timerTick=[,,1091,.18,.02,.17,4,.91,,-42,,,,,167,,,,.02];let f=+localStorage.getItem("js13k_tavernity_w");!isNaN(f)&&f>0&&(B().style.width=f+"px"),J(function(f,c,d){let g=me(re.tiles,re.width,re.spawns),p=ce(),u=te(),h=new we(1e3),v=new we(3e3),T=!1,x=!1,b="",L=0,_=0,k=document.getElementById("key-info").children[0],P="",M=window.player=ne(),E=!0,R=!1,C=!1,I=!1;new we(2e3),window.addEventListener("keydown",(e=>{" "===e.key&&setTimeout((()=>{E?(Te("itemPlace"),F(),$()):R?(Te("itemPlace"),j()):C?(Te("startLevel"),N()):I&&(Te("itemPlace"),U())}),1)}));let z=()=>Y.patrons.reduce(((e,t)=>["wfd","fs","r"].includes(t.getState())?e+1:e),0),F=()=>{Y.setup(),E=!1},j=()=>{R=!1,T=!1,u.incLevel(),$()},$=()=>{q(),Y.update(1),b=A[Y.levelOrch.getTotalLevel()]??"...",C=!0},N=()=>{q(),C=!1,T=!1},U=()=>{I=!1,E=!0,Y.setup()},V=e=>{for(let t=0;t<e.length;t++){let r=e[t];r.update(),r.remv&&(e.splice(t,1),t--)}},H=e=>{for(let t=0;t<e.length;t++){let r=e[t];Y.room.isTileVisible(r.x,r.y)&&r.draw()}},q=()=>{Y.patrons=[],Y.particles=[],Y.fParticles=[],Y.tileOrch=de(g,u.level);let e=u.getTotalLevel();if(0===Y.items.length)for(let[e,t]of[[5,11],[5,12],[8,10],[4,15],[21,9],[21,10],[17,13],[15,3],[21,3]])Y.items.push(ee("mugE",e,t));1===e&&Y.patrons.push(ae("person",11,14)),M.x=10,M.y=12,p.start(u.level,e),Y.room&&Y.room.reset(u.level),M.reset(),L=0},Y={cx:0,cy:0,scale:4,room:g,tileOrch:de(g,1),levelOrch:u,items:[],patrons:[],particles:[],fParticles:[],setup(){u.reset(),Y.items=[],q(),M.itemLeft=void 0,M.itemRight=void 0,T=!1},isPaused:()=>E||R||C||I,setAdjTableOnFire(e){let t=Y.getAdjTile(e,[y,w]);if(t&&15!==t[0]){let[,e,r]=t;Y.room.setTileAt(e,r,15);let l=Y.getItemAt(e,r);Te("fire"),l&&"mugF"===l.name&&(l.name="mugE")}},getPlayer:()=>M,getItemAt:(e,t)=>Y.items.find((r=>r.x===e&&r.y===t)),getPatronAt:(e,t)=>Y.patrons.find((r=>r.x===e&&r.y===t)),getAdjTile([e,t],r){for(let l of r)for(let[r,i]of Ae([e,t]).concat([[e,t]])){let e=Y.room.getTileAt(r,i);if(e&&e[0]===l)return e}},getAdjItem([e,t]){let r,l,i=0,s=Ae([e,t]).concat([[e,t]]);for(let e of Y.items)for(let[t,a]of s)e.x===t&&e.y===a&&(r&&r.name!==e.name||(i++,r=e,l=[t,a]));if(r&&l)return[r,i,l]},update(e){if(Y.isPaused())return;p.update(),g.update(),V(Y.patrons),M.update(),V(Y.particles),V(Y.fParticles),V(Y.items);let t=B();Y.cx=16*M.x*Y.scale-t.width/2+8*Y.scale,Y.cy=16*M.y*Y.scale-t.height/2+8*Y.scale,u.isLevelComplete(Y,p)&&!R&&(T?v.isDone()&&(T=!1,R||(k.style.opacity="0",R=!0,M.x=0,M.y=0,Te("levelScreen"),u.addCrateBonus())):(Te("levelDone"),T=!0,v.start())),z()>0&&p.lvlTimer.isDone()&&(I=!0,k.style.opacity="0",_=u.getScore()[2])},draw(){let f=W(),c=!1;if(E&&((()=>{h.isDone()&&(x=!x,h.start());let e=W(),{width:t,height:r}=e.canvas,l=Y.scale;D(0,0,t,r,"#000");let i=(e,t,r)=>{for(let l=0;l<9;l++)r?S("s_24",e,16*l*t,t):S("s_24",16*l*t,e,t)};i(0,l),i(r-16*l,l),i(0,Y.scale,!0),i(t-16*l,l,!0),k.style.opacity="0";for(let e=0;e<7;e++)for(let t=0;t<7;t++)S("s_11",16*l+16*t*l,16*l+16*e*l,l);S("s_17",t/2-16*l/2,r/2-16*l/2,l),S("s_18",t/2-16*l/2-16*l,r/2-16*l/2,l),S(x?"s_29":"s_30",t/2-16*l/2-16*l,r/2-16*l/2,l),S("s_18",t/2-16*l/2+16*l,r/2-16*l/2,l),S(x?"s_30":"s_29",t/2-16*l/2+16*l,r/2-16*l/2,l),O("TAVERNITY",t/2,r/2-32*l,{size:42,align:"center"}),O('"Serve me quick, barkeep,\nbefore I get angry."',t/2,r/2-16*l,{size:16,align:"center"}),O("Last Score: "+_,t/2,r/2+16*l,{size:24,align:"center"}),O("Press (SPACE) to start.",t/2,r/2+32*l+16,{size:24,align:"center"})})(),c=!0),R&&((()=>{let e=W(),{width:t,height:r}=e.canvas,l=Y.scale;D(0,0,t,r,"#000");let[i,s,a]=u.getScore(),o={size:24,align:"center"};O(`Level ${u.getTotalLevel()} Complete`,t/2,r/2-32*l,{size:42,align:"center"}),O("Round Score: "+i,t/2,r/2+12*l,{size:24,align:"center"}),O("Crate Bonus: "+s,t/2,r/2+24*l,o),O("Total Score: "+a,t/2,r/2+36*l,o)})(),c=!0),I&&((()=>{let e=W(),{width:t,height:r}=e.canvas,[,,l]=u.getScore(),i=Y.scale;D(0,0,t,r,"#000"),O("GAME OVER",t/2,r/2-32*i,{size:42,align:"center"}),O("Total Score: "+l,t/2,r/2+36*i,{size:24,align:"center"})})(),c=!0),c)return;f.save(),f.translate(-Y.cx,-Y.cy),f.scale(Y.scale,Y.scale),Y.room.draw(),H(Y.fParticles),H(Y.items),H(Y.patrons),M.draw(),H(Y.particles);let d=m(Y);if(d){let{type:m,item:f}=d,c="",g="(SPACE)";switch(m){case e:case t:c=`Pick up ${Q(f.name)} ${g}`;break;case r:c="Pick up Sword "+g;break;case l:c="Pick up Water "+g;break;case i:case s:c=`Place ${Q(f.name)} ${g}`;break;case a:case o:c="Fill Mug "+g;break;case n:c="Put away Sword "+g;break;case"r":c="Repair "+g}P===c&&""!==P||(k.style.opacity=""===c?"0":"1",k.innerHTML=c,P=c)}else k.style.opacity="0",P="";f.restore(),(()=>{let e=W(),{width:t}=e.canvas,r=z();if(O(""+(p.getRemaining()+r),64,32,{size:24,align:"left"}),D(4,4,48,52,"rgba(255, 255, 255, 0.5)"),S("s_3",4,4,3),T)O("Level ending soon...",t/2,128,{size:24,align:"center"});else if(!(C||p.isDone()&&0===r)){let e=Math.floor((1-p.lvlTimer.pct())*p.getMaxTime()/1e3);O("Time: "+Math.floor(e),t-(e<=10?16:24),16,{size:e<=10?32:24,align:"right"}),L!==e&&(L=e,e<=10&&Te("timerTick"))}})(),C&&(()=>{let e=b.split("\n"),t=e.length,r=W(),{width:l,height:i}=r.canvas,s=Y.scale,a=1===t?0:-(12*s+16*t)/2;D(0,i/2+a-16,l,12*t*s+16,"#000");for(let r=0;r<t;r++)O(e[r],l/2,i/2+12*r*s+16+a,{size:24,align:"center"})})()}};return window.game=Y,Y.setup(),Y}())},J=e=>{let t=performance.now(),r=pe(22,16,30,1,2),l=()=>{(()=>{let e=B();D(0,0,e.width,e.height,"grey")})(),e.draw(),requestAnimationFrame(l)};setInterval((()=>{let l=performance.now(),i=l-t;t=l,i>4&&(i=4);let s=i;i-=s;let a=s*r/10;E(a),e.update(a)}),22),l()};window.vol=e=>{be(.3*+e.value/100)};let Q=e=>({mugE:"Mug",mugF:"Mug",sw:"Sword",buck:"Bucket"}[e]??"Item"),Z=e=>(()=>{switch(e){case"mugE":return"s_30";case"mugF":return"s_29";case"sw":return"s_31";case"buck":return"s_34"}})()??"s_0",ee=(e,t,r)=>{let l={...f(),name:e,x:t,y:r,draw(){if(l.remv)return;let e=Z(l.name);S(e,16*l.x,16*l.y)},drawAt(e,t,r){let i=Z(l.name);S(i+(r?"_f":""),e,t)}};return l},te=()=>{let e=0,t=0,r=0,l=0,i=()=>{let e=G().room;return e.tiles.reduce(((t,r)=>17===r[0]&&e.getTileLevel(r)<=l?t+1:t),0)},s={level:1,reset(){e=0,t=0,s.level=1,r=0,l=1},incScore(){t++,e++},incLevel(){let e=s.level;0===r&&e>=2&&e<=6||s.level>6?r++:(r=0,s.level++),l++,t=0},addCrateBonus(){e+=i()},getScore:()=>[t,i(),e],getTotalLevel:()=>l,isLevelComplete:(e,t)=>t.isDone()&&!e.patrons.find((e=>"person"===e.type))};return s},re={tiles:[0,0,0,28,28,29,29,28,28,28,25,25,25,25,25,25,25,25,25,25,25,0,0,0,0,0,0,0,0,0,0,0,0,28,28,29,29,28,23,28,25,13,12,17,17,17,17,25,18,18,25,0,0,0,0,0,0,0,0,0,0,0,0,28,28,29,29,28,24,28,25,12,12,12,12,12,12,12,12,12,25,25,25,0,0,0,0,0,0,0,0,0,0,28,28,29,29,28,28,28,25,12,19,12,12,19,19,12,12,12,12,22,25,0,0,0,0,0,0,0,0,0,0,28,28,29,29,29,29,29,39,12,12,12,12,12,12,12,12,12,12,22,25,0,0,0,0,0,0,0,0,0,0,28,28,28,28,28,28,28,25,12,12,12,12,12,12,12,20,12,12,22,25,0,25,25,25,0,0,0,0,0,0,25,25,25,25,25,25,25,25,12,12,12,20,12,25,25,25,25,25,25,25,25,25,18,25,25,25,25,0,0,0,0,0,25,25,25,25,25,17,12,12,12,25,25,25,12,12,12,25,25,18,18,25,12,12,12,17,25,0,0,0,0,0,25,13,12,17,25,17,12,12,12,25,17,12,12,20,12,25,17,12,12,25,12,19,12,12,25,0,0,0,0,0,25,12,12,22,25,25,25,25,26,25,25,12,12,12,12,25,22,12,12,25,12,12,12,12,25,25,25,25,25,25,25,12,12,22,25,18,18,25,12,12,26,12,12,12,20,25,22,12,12,25,12,12,20,12,25,25,12,12,19,25,22,12,12,12,12,12,12,12,12,12,25,25,25,25,25,25,12,12,12,25,26,25,25,25,25,25,19,12,12,25,22,12,12,12,12,12,12,12,12,12,26,12,12,12,12,12,12,12,12,12,12,25,25,0,0,25,19,12,12,25,25,25,12,12,19,19,19,19,12,12,25,12,19,19,12,19,19,12,12,12,12,13,25,0,0,25,12,12,12,12,12,26,12,12,12,12,12,12,12,12,25,12,12,12,12,12,12,12,12,12,12,13,25,0,0,25,12,20,12,21,21,25,17,12,12,12,12,12,12,17,25,12,12,12,12,12,12,12,12,12,12,25,25,0,0,25,25,25,25,25,25,25,25,25,25,39,39,25,25,25,25,25,25,25,25,25,25,25,39,39,25,25,25,25,0,0,0,0,0,0,0,28,28,28,28,29,29,28,28,28,28,23,28,28,28,28,28,28,29,29,28,28,28,28,0,0,0,0,0,0,0,28,28,28,28,29,29,28,28,24,23,23,23,23,23,28,24,28,29,29,28,28,28,28,0,0,0,0,0,0,0,28,28,28,28,29,29,28,28,23,28,23,28,28,23,23,23,28,29,29,28,28,28,28,0,0,0,0,0,0,0,28,28,28,28,29,29,28,28,28,28,23,28,28,28,28,28,28,29,29,28,28,28,28,0,0,0,0,0,0,0,29,29,29,29,29,29,29,29,29,28,23,28,29,29,29,29,29,29,29,29,29,29,29,0,0,0,0,0,0,0,28,28,28,28,28,28,28,28,29,28,23,28,29,28,28,28,28,28,28,28,28,28,28,0,0,0,0,0,0,0,28,28,28,28,28,28,28,28,29,28,23,28,29,28,28,28,28,28,28,28,28,28,28],spawns:[[5,0],[6,0],[28,21],[18,23],[14,23],[6,21]],width:30,height:30},le=(e,t,r,l)=>{let i=g(e),s=new we(t);s.start(),i.start();let a=f(),o={...a,x:r,y:l,update(){a.update(),s.isDone()&&(o.remv=!0)},draw(){i.update(),S(i.getSprite(),16*o.x,16*o.y)}};return o},ie=([e,t])=>`${e},${t}`,se=(e,t,r,l,i,s)=>{1===ue(e,r,l)&&!i[ie(e)]&&(s.push({p:e,parent:t}),i[ie(e)]=!0)},ae=(e,t,r)=>{let l,i,s=f(),a=new we("person"===e?150:300),o=new we(1e3),n=!1,m=new we(2e4),c=new we(3e3),d=new we(1e3),p=new we(2e3),u=new we(100),h="fs",v="fc",T={},A=e=>(T[e+="_l"]||(T[e]=g(e)),T[e]),b=e=>{if("person"===e)switch(h){case"fs":case"d":case"l":return A("p_walk");case"r":return A("p_angry");case"wfd":return m.pct()<.5?A("p_wait"):A("p2_wait");case"wfc":case"n":return A("p_wait")}else if("mole"===e)return A("mole");return A("mole")},L=e=>{h=e,"wfd"===e&&m.start(),"wfc"===e&&u.start(),"r"===e&&Te("patronAngry"),"l"===e&&G().tileOrch.restoreTile(D,"Table"),b("person").reset()},P=e=>{let t=G();v=e,"dc"!==e&&"dt"!==e||p.start(),"fc"===e&&(t.tileOrch.restoreTile(D,"Crate"),t.tileOrch.isTileAvailable("Crate")||P("ft")),"ft"===e&&(t.tileOrch.restoreTile(D,"MoleTable"),t.tileOrch.isTileAvailable("MoleTable")||P("lv")),"lv"===e&&(t.tileOrch.restoreTile(D,"Crate"),t.tileOrch.restoreTile(D,"MoleTable")),b("mole").reset()},M=(e,t)=>{let r=G(),l=e.slice(1),i=((e,t,r,l)=>{let i=[],s=[{p:e}],a={[ie(e)]:!0},o=1e3;for(;s.length;){let e=s.shift();if(!e)return[];if(he(e.p,t)){i.unshift(t);let r=e.parent;for(;r;)r.parent&&i.unshift(r.p),r=r.parent;break}for(let t of Ae(e.p))se(t,e,r,l,a,s);if(o--,o<=0)break}return i})(D.getPos(),l,((e,t)=>{let r=[],l=([e,r])=>t.find((t=>t.x===e&&t.y===r));for(let[t,s,a]of e.tiles)!_(i=t)&&!k(i)||l([s,a])?r.push(0):r.push(1);var i;return r})(r.room,r.patrons.concat([r.getPlayer()])),r.room.w),s=i[0];if(he(s,D.getPos()))t();else if(s){let[e,t]=i[0],r=D.getPos();D.x=e,D.y=t,oe(D,r,(e=>{let t=G();Te("doorOpen"),t.room.setTileAt(D.x,D.y,e+1)}))}else if(n){if(o.isDone()){n=!1;for(let[e,t]of Ae(D.getPos())){let l=r.room.getTileAt(e,t);_(l[0])&&(D.x=e,D.y=t)}}}else n=!0,o.start()},E=e=>{let t=G();if(a.isDone()){if("person"===e)switch(h){case"fs":{let e=t.tileOrch.getAvailTile(D,"Table");e&&M(e,(()=>{L("wfd")}));break}case"l":{let e=t.tileOrch.getAvailTile(D,"Exit");e&&M(e,(()=>{D.remv=!0}))}}else if("mole"===e)switch(Math.random()>.9&&Te("moleAlert"),v){case"fc":{let e=t.tileOrch.getAvailTile(D,"Crate");e&&M(e,(()=>{P("dc")}));break}case"ft":{let e=t.tileOrch.getAvailTile(D,"MoleTable");e&&M(e,(()=>{P("dt")}));break}case"lv":{let e=t.tileOrch.getAvailTile(D,"Exit");e&&M(e,(()=>{D.remv=!0}))}}a.start()}},D={...s,type:e,x:t,y:r,getState:()=>"person"===e?h:v,setPersonState(e){L(e)},getPos:()=>[D.x,D.y],update(){"person"===e?(()=>{let e=G();if(E("person"),"wfd"===h||"r"===h){m.isDone()&&"r"!==h?(L("r"),d.start()):"r"===h&&d.isDone()&&Math.random()>.95&&(e.setAdjTableOnFire(D.getPos()),d.start());let t=e.getAdjItem(D.getPos()),r=t?.[0];"mugF"!==r?.name||r?.remv||(r.remv=!0,l=r,i=t?.[2],L("d"),c.start())}else"d"===h?c.isDone()&&l&&i&&(L("wfc"),l.remv=!1,l.x=i[0],l.y=i[1],l.name="mugE",e.items.push(l),l=void 0):"wfc"===h&&u.isDone()&&(e.room.isTileVisible(D.x,D.y)&&Te("plusOne"),e.levelOrch.incScore(),e.particles.push(le("part_+1_l",300,D.x,D.y)),L("l"))})():"mole"===e&&(()=>{let e=G();if(E("mole"),"dc"===v&&p.isDone()){let t=e.getAdjTile(D.getPos(),[17]);t&&(Te("dc"),t[0]=x,P("fc"))}if("dt"===v&&p.isDone()){let t=e.getAdjTile(D.getPos(),[y,w,21,22]);t&&(Te("dc"),t[0]=x,P("fc"))}})()},draw(){let t=b(e);t.update();let r=t.getSprite();S(r,16*D.x,16*D.y),"d"===h&&l&&l.drawAt(16*D.x+2,16*D.y+2)}};return D},oe=(e,[t,r],l)=>{let i=G(),s=i.room.getTileAt(t,r)?.[0],a=i.room.getTileAt(e.x,e.y)?.[0],o=i.getPatronAt(e.x,e.y);(e=>!_(e))(a)||o&&o!==e?(k(a)&&l(a),e.x=t,e.y=r):k(s-1)&&(Te("doorClose"),i.getPatronAt(t,r)||i.room.setTileAt(t,r,s-1))},ne=()=>{let c=new we(300),d=new we(80),g=new we(150),p=!1,u=e=>{e.remv=!0,void 0===T.itemLeft?(Te("item"),T.itemLeft=e):void 0===T.itemRight&&(Te("item"),T.itemRight=e)},h=e=>{let t=ee(e,T.x,T.y);t.remv=!0,Te("drawSword"),T.itemLeft=t,T.itemRight=t},w=(e,t)=>{let r=G(),l="item"+e,i=T[l];Te("itemPlace"),i.remv=!1,i.x=t[1],i.y=t[2],r.items.push(i),T[l]=void 0},y=e=>{Te("fill"),e.name="mugF"},v=e=>e.reduce(((e,t)=>e||ve(t)),!1);window.addEventListener("keydown",(f=>{let c=G();if(!c.isPaused()&&" "===f.key){let f=m(c);if(!f)return;let{type:d,tile:p,item:v}=f,A={[e]:()=>{u(v)},[t]:()=>{u(v)},[r]:()=>{h("sw")},[l]:()=>{h("buck")},[i]:()=>{w("Left",p)},[s]:()=>{"mugF"===T.itemLeft?.name?(w("Left",p),T.itemLeft=T.itemRight,T.itemRight=void 0):w("Right",p)},[a]:()=>{y(T.itemLeft)},[o]:()=>{y(T.itemRight)},sw:()=>{(()=>{let e=G();if(g.isDone()){g.start(),Te("swingSword");for(let[t,r]of Ae([T.x,T.y])){let l=e.getPatronAt(t,r);if("r"===l?.getState()||"mole"===l?.type){e.room.getTileAt(t,r)[0]!==x&&e.fParticles.push(le("bloodf_l",1/0,t,r)),e.particles.push(le("blood_l",300,t,r)),l.remv=!0,Te("hitS"),setTimeout((()=>{Te("moleDead")}),300);break}}}})()},[n]:()=>{T.itemLeft=T.itemRight=void 0,Te("itemPlace")},"d-b":()=>{(()=>{T.itemLeft=void 0,T.itemRight=void 0,Te("dumpBucket");let e=G();for(let[t,r]of Ae([T.x,T.y],!0)){let[l]=e.room.getTileAt(t,r);if(15===l){e.room.setTileAt(t,r,x);for(let[l,i]of Ae([t,r])){let t=e.getPatronAt(l,i);"r"===t?.getState()&&t.setPersonState("wfd")}}e.particles.push(le("water_l",300,t,r))}})()},r:()=>{(e=>{let t=G(),[,r,l]=e,i=t.room.getTileAt(r,l,!0),[s]=i;e[0]=s,Te("fill")})(p)}};A[d]?.()}})),window.addEventListener("keyup",(e=>{p=!1,c.complete()}));let T=Object.assign(f(),{dir:"l",x:0,y:0,itemLeft:void 0,itemRight:void 0,ctrlEnabled:!0,reset(){},update(){(()=>{if(T.ctrlEnabled&&c.isDone()&&d.isDone()){let{x:e,y:t}=T,r=!1;v(["ArrowUp","8","7","9","Home","PageUp"])&&(T.y--,r=!0),v(["ArrowDown","2","1","3","End","PageDown"])&&(T.y++,r=!0),v(["ArrowLeft","7","4","1","Home","End"])&&(T.x--,r=!0),v(["ArrowRight","9","6","3","PageUp","PageDown"])&&(T.x++,r=!0),r&&oe(T,[e,t],(e=>{let t=G();Te("doorOpen"),t.room.setTileAt(T.x,T.y,e+1),c.start(),p=!0})),T.x===e&&T.y===t||(p?d.start():(c.start(),d.start(),p=!0))}})()},draw(){let e=0;T.itemLeft&&e++,T.itemRight&&e++;let t=void 0!==T.itemLeft&&T.itemLeft===T.itemRight;if(t&&(e--,g.isDone()||e--),S("s_"+e,16*T.x,16*T.y),t){let e=-4;g.isDone()||(e=2),T.itemLeft.drawAt(16*T.x-6,16*T.y+e,!0)}else T.itemLeft&&T.itemLeft.drawAt(16*T.x-8,16*T.y-5,!0),T.itemRight&&T.itemRight.drawAt(16*T.x+8,16*T.y-5)}});return T},me=(e,t,r=[])=>{let l=new we(100),i=!1,s=[],a=e.map(((e,r)=>[e,r%t,Math.floor(r/t)])),o={...f(),w:t,h:t,spawns:r,visMaps:Y(e,t),tiles:a,reset:e=>{let t=a.map((e=>[...e]));for(let r=0;r<t.length;r++){let l=t[r],i=o.getTileLevel(l,!0);26===l[0]&&i>e&&l[0]--}o.tiles=t},getTileAt:(e,r,l)=>(l?a:o.tiles)[r*t+e]??[0],setTileAt:(e,r,l)=>{let i=o.tiles[r*t+e];i&&(i[0]=l)},getTileLevel:(e,r)=>{let[l,i,s]=e;if(0===l)return 0;let a=0;for(let e of o.visMaps){let l=e[s*t+i];if(l){let e=L(l);if(e>a&&(a=e,!r))return a}}return a},isTileVisible:(e,r)=>s.reduce(((l,i)=>l||ue([e,r],o.visMaps[i],t)>0),!1),update:()=>{s=(()=>{let e=G().getPlayer().getPos(),r=[];for(let l=0;l<o.visMaps.length;l++)ue(e,o.visMaps[l],t)>0&&r.push(l);return r})(),l.isDone()&&(l.start(),i=!i)},draw:()=>{for(let e=0;e<t;e++)for(let r=0;r<t;r++){let[l]=o.tiles[r+e*t]??[0],a=o.isTileVisible(r,e,s);l&&a?(15===l&&(l+=i?1:0),S("s_"+(l-1),16*r,16*e)):D(16*r,16*e,16,16,"#000")}}};return o},fe=1e5,ce=()=>{let e=new we(1),t=new we(1),r=!1,l=1,i=0,s=0,a=0,o=0,n=0,m=e=>{let t,r,i=G(),s=(()=>{let e=G();return e.room.tiles.filter((t=>{for(let r of e.room.spawns)if(he(r,t.slice(1))&&e.room.getTileLevel(t)<=l)return!0}))})(),a=xe(s);do{if(t=a[1],r=a[2],!i.getPatronAt(t,r))break;s.indexOf(a)>-1&&s.splice(s.indexOf(a),1),a=xe(s)}while(a&&s.length>0);if(!a)return!1;if("person"===e&&!i.tileOrch.isTileAvailable("Table"))return!1;let o=ae(e,t,r);return i.patrons.push(o),!0},f={lvlTimer:new we(fe+n),start:(m,c)=>{r=!0,e.ms=5e3+5e3*Math.random(),e.start(),c>5&&(n+=1e3),f.lvlTimer.ms=fe+n,f.lvlTimer.start(),i=0,s=5+Math.floor(1.75*c),o=(()=>{switch(!0){case[5,7].includes(c):return 1;case[9].includes(c):return 2;case c>9:return 3;default:return 0}})(),t.ms=(fe+n-1e4)/2/(o+1),t.start(),a=0,l=m},stop(){r=!1},isDone:()=>i>=s,getRemaining:()=>s-i,getMaxTime:()=>f.lvlTimer.ms,update(){r&&(this.isDone()||(e.isDone()&&(e.ms=1+Math.random()*Math.min(7e3,((fe+n)/1.5-5e3)*(1-f.lvlTimer.pct())/2),e.start(),m("person")&&i++),t.isDone()&&a<o&&(t.start(),m("mole")&&(Te("moleAlert"),a++))))}};return f},de=(e,t)=>{let r=(e,t)=>t.includes(e),l=e.tiles.filter((r=>{let[l,i,s]=r;if(e.getTileLevel(r)<=t&&_(l)){let[t]=e.getTileAt(i,s-1),[r]=e.getTileAt(i-1,s),[l]=e.getTileAt(i+1,s);if(t===y||r===w||l===w)return!0}})).map((e=>[e,void 0])),i=e.tiles.filter((r=>{for(let l of e.spawns)if(he(l,r.slice(1))&&e.getTileLevel(r)<=t)return!0})).map((e=>[e,void 0])),s=(r=[])=>e.tiles.filter((r=>{let[l,i,s]=r;if(e.getTileLevel(r)<=t&&_(l)){let[t]=e.getTileAt(i-1,s),[r]=e.getTileAt(i+1,s);if(17===t||17===r)return!0}})).map((e=>{let t=r.find((t=>t[0]===e))?.[1];return[e,t]})),a=(l=[])=>e.tiles.filter((l=>{let[i,s,a]=l;if(e.getTileLevel(l)<=t&&_(i)){let[t]=e.getTileAt(s,a+1),[l]=e.getTileAt(s,a-1),[i]=e.getTileAt(s-1,a),[o]=e.getTileAt(s+1,a);if(r(t,[w,y,21,22])||r(l,[w,21,22])||r(i,[y,21,22])||r(o,[y,21,22]))return!0}})).map((e=>{let t=l.find((t=>t[0]===e))?.[1];return[e,t]})),o=s(),n=a(),m=e=>({Table:l,Exit:i,Crate:o,MoleTable:n}[e]??[]);return{restoreTile:(e,t)=>{let r=m(t).find((t=>t[1]===e));r&&("Crate"===t&&(o=s(o)),"MoleTable"===t&&(n=a(n)),r[1]=void 0)},getAvailTile:(e,t)=>{let r=m(t).find((t=>t[1]===e));if(r)return r[0];let l=m(t).filter((e=>void 0===e[1]||"Exit"===t)),i=xe(l);return i?(i[1]=e,i[0]):void 0},isTileAvailable:e=>{let t=m(e).filter((t=>void 0===t[1]||"Exit"===e));return t?.length>0}}},ge=()=>window.performance.now(),pe=(e,t,r,l,i)=>l+(e-t)*(i-l)/(r-t),ue=([e,t],r,l)=>e<0||e>=l||t<0||t>=l?-1/0:r[e+t*l],he=(e,t)=>e?.[0]===t?.[0]&&e?.[1]===t?.[1];class we{ms;s=-999;constructor(e){this.ms=e}start(){this.s=ge()}stop(){this.s=0}pct(){let e=ge()-this.s;return e>this.ms?e=this.ms:e<0&&(e=-1),Math.min(1,e/this.ms)}complete(){this.s=-999}isDone(){return ge()-this.s>=this.ms}}let ye={};window.addEventListener("keydown",(e=>{ye[e.key]=!0;let t=B(),r=parseInt(t.style.width);isNaN(r)&&(r=t.width),"+"===e.key&&(r+=100,t.style.width=r+"px"),"-"===e.key&&(r-=100,t.style.width=r+"px"),localStorage.setItem("js13k_tavernity_w",r+"")})),window.addEventListener("keyup",(e=>{ye[e.key]=!1}));let ve=e=>ye[e],Te=e=>{let t=(e=>{let t=d[e];if(!t)throw Error("No sound: "+e);return t})(e);Le(t)},xe=e=>e[Math.floor(Se()*e.length)],Ae=([e,t],r)=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]]?.concat(r?[[e-1,t-1],[e-1,t+1],[e+1,t-1],[e+1,t+1]]:[]),be=e=>{ke=e},Le=e=>{_e(...e)},_e=(...e)=>Ee(De(...e)),ke=.1,Pe=44100,Me=new(window.AudioContext||webkitAudioContext),Ee=(...e)=>{let t=Me.createBuffer(e.length,e[0].length,Pe),r=Me.createBufferSource();return e.map(((e,r)=>t.getChannelData(r).set(e))),r.buffer=t,r.connect(Me.destination),r.start(),r},Se=Math.random,De=(e=1,t=.05,r=220,l=0,i=0,s=.1,a=0,o=1,n=0,m=0,f=0,c=0,d=0,g=0,p=0,u=0,h=0,w=1,y=0,v=0)=>{let T,x,A=2*Math.PI,b=n*=500*A/Pe/Pe,L=r*=(1+2*t*Se()-t)*A/Pe,_=[],k=0,P=0,M=0,E=1,S=0,D=0,O=0;for(m*=500*A/Pe**3,p*=A/Pe,f*=A/Pe,c*=Pe,d=d*Pe|0,x=(l=l*Pe+9)+(y*=Pe)+(i*=Pe)+(s*=Pe)+(h*=Pe)|0;M<x;_[M++]=O)++D%(100*u|0)||(O=a?a>1?a>2?a>3?Math.sin((k%A)**3):Math.max(Math.min(Math.tan(k),1),-1):1-(2*k/A%2+2)%2:1-4*Math.abs(Math.round(k/A)-k/A):Math.sin(k),O=(d?1-v+v*Math.sin(A*M/d):1)*(O>0?1:-1)*Math.abs(O)**o*e*ke*(M<l?M/l:M<l+y?1-(M-l)/y*(1-w):M<l+y+i?w:M<x-h?(x-M-h)/s*w:0),O=h?O/2+(h>M?0:(M<x-h?1:(x-M)/h)*_[M-h|0]/2):O),T=(r+=n+=m)*Math.cos(p*P++),k+=T-T*g*(1-1e9*(Math.sin(M)+1)%2),E&&++E>c&&(r+=f,L+=f,E=0),!d||++S%d||(r=L,n=b,E=E||1);return _};