(()=>{var e={709:()=>{CanvasRenderingContext2D.prototype.roundRect=function(e,t,i,s,h){return i<2*h&&(h=i/2),s<2*h&&(h=s/2),this.beginPath(),this.moveTo(e+h,t),this.arcTo(e+i,t,e+i,t+s,h),this.arcTo(e+i,t+s,e,t+s,h),this.arcTo(e,t+s,e,t,h),this.arcTo(e,t,e+i,t,h),this.closePath(),this}},348:()=>{Array.prototype.shuffle=function(){let e,t=this.length;for(;0!=t;)e=Math.floor(Math.random()*t),t--,[this[t],this[e]]=[this[e],this[t]];return this}}},t={};function i(s){var h=t[s];if(void 0!==h)return h.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,i),a.exports}(()=>{"use strict";class e extends Error{}class t{constructor(){this.states={},this.currentState=null}registerState(e,t){this.states[e]=t}setCurrentState(e){this.currentState=e}getState(t){try{return this.states[t]}catch(i){throw new e(`The state ${t} is not registered`)}}getCurrentState(){return this.getState(this.currentState)}getAllStates(){return Object.values(this.states)}transitionTo(e){let t=this.getCurrentState(),i=this.getState(e);t.leave(i),i.enter(t),this.setCurrentState(e)}}class s{constructor(e,t){this.x=e,this.y=t}clone(e){return this.x=e.x,this.y=e.y,this}scale(e,t){return this.x*=e,this.y*=t,this}difference(e){return new s(this.x-e.x,this.y-e.y)}equals(e){return this.x==e.x&&this.y==e.y}offset(e){return this.x+=e.x,this.y+=e.y,this}angleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}vectorTo(e){let t=this.angleTo(e);return new s(Math.cos(t),Math.sin(t))}distanceTo(e){return Math.hypot(e.y-this.y,e.x-this.x)}roundTo(e,t,i){let s=this.difference(e);Math.abs(s.x)<=t&&(this.x=e.x),Math.abs(s.y)<=i&&(this.y=e.y)}}class h{constructor(){this.position=new s(0,0),this.targetPosition=new s(0,0),this.angle=0,this.scale=new s(1,1),this.canvasBounds=null,this.speed=2}update(e){if(!this.targetPosition.equals(this.position)){let e=this.position.vectorTo(this.targetPosition);e.scale(this.speed,this.speed),this.position.offset(e),this.position.roundTo(this.targetPosition,this.speed,this.speed)}}drawAtCamera(e,t,i){this.canvasBounds=t.bounds,e.save(),e.translate(-this.position.x,-this.position.y),i(e,t),e.restore()}draw(e,t,i){this.canvasBounds=t.bounds,e.save(),e.translate(-this.position.x+Math.round(this.canvasBounds.width/2),-this.position.y+Math.round(this.canvasBounds.height/2)),e.scale(this.scale.x,this.scale.y),i(e,t),e.restore()}screenToWorld(e){let t=new s(e.x,e.y);return t.x+=this.position.x-Math.round(this.canvasBounds.width/2),t.y+=this.position.y-Math.round(this.canvasBounds.height/2),t.scale(1/this.scale.x,1/this.scale.y),t}worldToScreen(e){let t=new s(e.x,e.y);return t.scale(this.scale.x,this.scale.y),t.x+=-this.position.x+Math.round(this.canvasBounds.width/2),t.y+=-this.position.y+Math.round(this.canvasBounds.height/2),t}}class a{constructor(){this.clear()}add(e){return e.setId(this.tweenIdIndex++),this.activeTweens.push(e),e.getId()}remove(e){this.activeTweens.splice(this.activeTweens.findIndex((t=>t==e)),1)}cancel(e){let t=this.activeTweens.findIndex((t=>t.getId()==e));-1!=t&&this.activeTweens.splice(t,1)}update(){let e=[];for(let t=0;t<this.activeTweens.length;t++){let i=this.activeTweens[t];i.update(),i.isComplete()&&e.push(i)}for(let t=0;t<e.length;t++){let i=e[t];i.onFinish(),this.remove(i)}}clear(){this.activeTweens=[],this.tweenIdIndex=0}}class n{constructor(e,t,i,s=o.Linear.EaseNone,h=(()=>{})){this.objectToTween=e,this.startProperties={},this.targetProperties=t,this.saveInitialValues(this.startProperties,e,t),this.startTime=(new Date).getTime(),this.endTime=this.startTime+i,this.easing=s,this.onFinish=h,this.id=-1}saveInitialValues(e,t,i){for(let s in i){let h=t[s];"object"!=typeof h?e[s]=h:(e[s]={},this.saveInitialValues(e[s],t[s],i[s]))}}update(){let e=(new Date).getTime()-this.startTime,t=this.endTime-this.startTime,i=Math.min(1,e/t),s=this.easing(i);this.updateProperties(this.objectToTween,this.startProperties,this.targetProperties,s)}updateProperties(e,t,i,s){for(let h in t){let a=t[h];if("object"==typeof a){this.updateProperties(e[h],t[h],i[h],s);continue}let n=i[h]-a;e[h]=a+n*s}}setId(e){this.id=e}getId(){return this.id}isComplete(){return this.endTime<=(new Date).getTime()}}class o{}o.Linear={},o.Linear.EaseNone=e=>e,o.Quadratic={},o.Quadratic.EaseIn=e=>e*e,o.Quadratic.EaseOut=e=>-e*(e-2),o.Quadratic.EaseInOut=e=>(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1),o.Elastic={},o.Elastic.EaseIn=e=>{var t,i=.1,s=.4;return 0==e?0:1==e?1:(s||(s=.3),!i||i<1?(i=1,t=s/4):t=s/(2*Math.PI)*Math.asin(1/i),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/s))},o.Elastic.EaseOut=e=>{var t,i=.1,s=.4;return 0==e?0:1==e?1:(s||(s=.3),!i||i<1?(i=1,t=s/4):t=s/(2*Math.PI)*Math.asin(1/i),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/s)+1)},o.Elastic.EaseInOut=e=>{var t,i=.1,s=.4;return 0==e?0:1==e?1:(s||(s=.3),!i||i<1?(i=1,t=s/4):t=s/(2*Math.PI)*Math.asin(1/i),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/s)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/s)*.5+1)};class l{constructor(e,t,i,h,a){this.center=new s(e,t),this.element=document.createElement("button"),this.element.innerText=h,this.element.className=a,this.viewer=i,this.canvasBounds=null,this.clickHandler=()=>{}}attach(){this.viewer.appendChild(this.element)}draw(e,t){this.canvasBounds=t.bounds}update(e){let t=this.element.getBoundingClientRect();this.element.style.left=this.center.x-t.width/2+"px",this.element.style.top=this.center.y-t.height/2+"px"}setPosition(e,t){this.center.x=e,this.center.y=t}onClick(e){this.element.removeEventListener("click",this.clickHandler),this.clickHandler=e,this.element.addEventListener("click",this.clickHandler)}remove(){this.element.removeEventListener("click",this.clickHandler),this.viewer.removeChild(this.element)}}let r={Colors:{black:"rgb(57, 56, 61)",darkred:"crimson",darkgreen:"rgb(102, 184, 136)",umber:"rgb(107, 96, 84)",lilac:"rgb(188, 156, 176)",ivory:"rgb(245, 251, 239)",tangerine:"rgb(235, 148, 134)",spacecadet:"rgb(23, 24, 59)",seagreen:"seagreen",grassgreen:"#167a04",dirtbrown:"#823c0a",darkbrown:"#201B15"},Fonts:{Header:"Georgia",Text:"Arial"},Game:{TileSize:{width:64,height:64,spacing:2}}};class d{constructor(){this.prefix="merchantsofdeath"}_get(){return JSON.parse(localStorage.getItem(`${this.prefix}-savedata`)||"{}")}_set(e){localStorage.setItem(`${this.prefix}-savedata`,JSON.stringify(e))}setKey(e,t){let i=this._get();i[e]=t,this._set(i)}appendKey(e,t){let i=this._get();i[e]||(i[e]=[]),i[e].push(t),this._set(i)}incrementKey(e,t){let i=this._get();i[e]||(i[e]=0),i[e]+=t,this._set(i)}getKey(e){return this._get()[e]}delete(){localStorage.removeItem(`${this.prefix}-savedata`)}}var c={Bone:function(e,t){let i=t.width,s=t.height;e.fillStyle="white",e.beginPath(),e.arc(2*i/8,7*s/8,i/16,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(1*i/8,6*s/8,i/16,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(7*i/8,2*s/8,i/16,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(6*i/8,1*s/8,i/16,0,2*Math.PI),e.fill(),e.beginPath(),e.moveTo(2*i/8-2,7*s/8),e.lineTo(7*i/8-2,2*s/8),e.lineTo(6*i/8+2,1*s/8),e.lineTo(1*i/8+2,6*s/8),e.closePath(),e.fill()},DashHead:function(e,t){e.fillStyle="#272935",e.beginPath(),e.moveTo(-5,-27),e.lineTo(30,-23),e.lineTo(10,23),e.lineTo(3,20),e.closePath(),e.fill(),e.fillStyle="#31333F",e.beginPath(),e.arc(0,0,25,0,2*Math.PI),e.fill(),e.fillStyle="black",e.beginPath(),e.ellipse(12,-8,4,8,0,0,2*Math.PI),e.fill(),e.fillStyle="white",e.beginPath(),e.arc(13,-9,2,0,2*Math.PI),e.fill(),e.fillStyle="#31333F",e.beginPath(),e.moveTo(0,-9),e.lineTo(20,-7),e.lineTo(35,-2),e.arc(35,8,10,-Math.PI/2,Math.PI/2),e.lineTo(0,20),e.closePath(),e.fill(),e.fillStyle="black",e.beginPath(),e.arc(35,8,10,-Math.PI/2,0),e.lineTo(35,5),e.closePath(),e.fill(),e.beginPath(),e.ellipse(-4,-8,4,8,0,0,2*Math.PI),e.fill(),e.fillStyle="white",e.beginPath(),e.arc(-3,-8,2,0,2*Math.PI),e.fill(),e.fillStyle="#BC6439",e.beginPath(),e.moveTo(20,9),e.lineTo(40,10),e.arc(35,8,10,Math.PI/8,Math.PI/2),e.lineTo(4,20),e.closePath(),e.fill(),e.fillStyle="#3A3C4A",e.beginPath(),e.moveTo(-35,-24),e.lineTo(0,-27),e.lineTo(-20,23),e.lineTo(-27,20),e.closePath(),e.fill()},DogHead1:function(e,t){e.fillStyle="#AC5429",e.beginPath(),e.moveTo(-5,-27),e.lineTo(30,-23),e.lineTo(10,23),e.lineTo(3,20),e.closePath(),e.fill(),e.fillStyle="#BC6439",e.beginPath(),e.arc(0,0,25,0,2*Math.PI),e.fill(),e.fillStyle="black",e.beginPath(),e.ellipse(12,-8,4,8,0,0,2*Math.PI),e.fill(),e.fillStyle="white",e.beginPath(),e.arc(13,-9,2,0,2*Math.PI),e.fill(),e.fillStyle="#BC6439",e.beginPath(),e.moveTo(0,-9),e.lineTo(10,-7),e.lineTo(25,-2),e.arc(25,8,10,-Math.PI/2,Math.PI/2),e.lineTo(3,25),e.closePath(),e.fill(),e.fillStyle="black",e.beginPath(),e.arc(25,8,10,-Math.PI/2,0),e.lineTo(25,5),e.closePath(),e.fill(),e.beginPath(),e.ellipse(-4,-8,4,8,0,0,2*Math.PI),e.fill(),e.fillStyle="white",e.beginPath(),e.arc(-3,-8,2,0,2*Math.PI),e.fill(),e.fillStyle="#CC7449",e.beginPath(),e.moveTo(-35,-24),e.lineTo(0,-27),e.lineTo(-20,23),e.lineTo(-27,20),e.closePath(),e.fill()},DogHead2:function(e,t){e.fillStyle="rgb(91, 80, 68)",e.beginPath(),e.moveTo(-5,-27),e.lineTo(30,-23),e.lineTo(10,23),e.lineTo(3,20),e.closePath(),e.fill(),e.fillStyle="rgb(245, 251, 239)",e.beginPath(),e.arc(0,0,25,0,2*Math.PI),e.fill(),e.fillStyle="black",e.beginPath(),e.ellipse(12,-8,4,8,0,0,2*Math.PI),e.fill(),e.fillStyle="white",e.beginPath(),e.arc(13,-9,2,0,2*Math.PI),e.fill(),e.fillStyle="rgb(245, 251, 239)",e.beginPath(),e.moveTo(0,-9),e.lineTo(10,-7),e.lineTo(25,-2),e.arc(25,8,10,-Math.PI/2,Math.PI/2),e.lineTo(3,25),e.closePath(),e.fill(),e.fillStyle="rgb(107, 96, 84)",e.beginPath(),e.arc(7,0,4,0,2*Math.PI),e.fill(),e.fillStyle="rgb(107, 96, 84)",e.beginPath(),e.arc(7,20,8,3*Math.PI/4,Math.PI/12),e.fill(),e.fillStyle="black",e.beginPath(),e.arc(25,8,10,-Math.PI/2,0),e.lineTo(25,5),e.closePath(),e.fill(),e.beginPath(),e.ellipse(-4,-8,4,8,0,0,2*Math.PI),e.fill(),e.fillStyle="white",e.beginPath(),e.arc(-3,-8,2,0,2*Math.PI),e.fill(),e.fillStyle="rgb(123, 112, 100)",e.beginPath(),e.moveTo(-35,-24),e.lineTo(0,-27),e.lineTo(-20,23),e.lineTo(-27,20),e.closePath(),e.fill()},DirtBlock:function(e,t){let i=t.width,s=t.height;e.fillStyle="#823c0a",e.roundRect(0,0,i,s,8),e.fill(),e.strokeStyle="#82540a",e.roundRect(0,0,i-2,s-2,8),e.stroke(),e.fillStyle="#82540a",e.roundRect(3*i/8,2*s/8,2*i/8,1*s/8,8),e.fill(),e.fillStyle="#82540a",e.roundRect(4*i/8+1,3*s/8+1,2*i/8,1*s/8,8),e.fill()},GrassBlock:function(e,t){let i=t.width,s=t.height;c.DirtBlock(e,{width:i,height:s}),e.fillStyle="#167a04",e.roundRect(0,0,i,s/6,8),e.fill(),e.fillStyle="#517a04",e.beginPath(),e.moveTo(5*i/8,0),e.lineTo(7*i/8,0),e.lineTo(6*i/8,s/6),e.closePath(),e.fill(),e.beginPath(),e.moveTo(1*i/8,0),e.lineTo(3*i/8,0),e.lineTo(2*i/8,s/6),e.closePath(),e.fill(),e.beginPath(),e.moveTo(3*i/8,s/6),e.lineTo(5*i/8,s/6),e.lineTo(4*i/8,0),e.closePath(),e.fill(),e.strokeStyle="#517a04",e.roundRect(0,0,i,s/6,8),e.stroke()},DirtBoneBlock:function(e,t){let i=t.width,s=t.height;c.DirtBlock(e,{width:i,height:s}),c.Bone(e,{width:i,height:s})},Cameo:function(e,t){let i=t.width;var s=e.createLinearGradient(0,0,0,150);s.addColorStop(0,"#573815"),s.addColorStop(1,"#261e15"),e.fillStyle=s,e.beginPath(),e.ellipse(0,0,i,1.25*i,0,0,2*Math.PI),e.fill(),e.fillStyle="#494949",e.beginPath(),e.ellipse(0,0,.9*i,1.25*i*.9,0,0,2*Math.PI),e.fill(),e.save(),e.scale(2,2),c.DashHead(e,{}),e.restore()},DigPlayer:function(e,t){e.fillStyle="#3A3C4A",e.beginPath(),e.arc(-6,0,8,Math.PI,3*Math.PI/2),e.lineTo(6,-8),e.arc(6,0,8,3*Math.PI/2,2*Math.PI),e.lineTo(18,28),e.lineTo(-18,28),e.closePath(),e.fill(),e.save(),e.translate(0,-16),e.scale(.7,.7),c.DashHead(e,t),e.restore()},Skull:function(e,t){let i=t.width,s=t.height;e.fillStyle="white",e.beginPath(),e.arc(0,0,i/3,0,2*Math.PI),e.fill(),e.beginPath(),e.roundRect(-i/12,s/8,i/3,s/3,2),e.fill(),e.fillStyle="black",e.beginPath(),e.arc(0,0,6,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i/4,0,6,0,2*Math.PI),e.fill(),e.strokeStyle="black",e.beginPath(),e.moveTo(0,.3*s),e.lineTo(0,.45*s),e.stroke(),e.beginPath(),e.moveTo(.1*i,.3*s),e.lineTo(.1*i,.45*s),e.stroke(),e.beginPath(),e.moveTo(.2*i,.3*s),e.lineTo(.2*i,.45*s),e.stroke(),e.beginPath(),e.moveTo(.13*i,.1*s),e.lineTo(.18*i,.2*s),e.lineTo(.08*i,.2*s),e.closePath(),e.stroke()},DirtSkullBlock:function(e,t){let i=t.width,s=t.height;c.DirtBlock(e,{width:i,height:s}),e.save(),e.translate(i/2,s/2),c.Skull(e,{width:i,height:s}),e.restore()},Shovel:function(e,t){let i=t.width,s=t.height;e.fillStyle="#823c0a",e.strokeStyle="#823c0a",e.lineCap="round",e.lineWidth=4,e.beginPath(),e.moveTo(1/8*i,7/8*s),e.lineTo(.5*i,.5*s),e.stroke(),e.fillStyle="gray",e.beginPath(),e.moveTo(7/8*i,3/8*s),e.lineTo(5/8*i,5/8*s),e.lineTo(3/8*i,3/8*s),e.lineTo(5/8*i,1/8*s),e.arc(5/8*i,3/8*s,2/8*i,-Math.PI/2,0),e.closePath(),e.fill()},Tombstone:function(e,t){let i=t.width,s=t.height;e.fillStyle="gray",e.beginPath(),e.moveTo(6/8*i,3/8*s),e.lineTo(6/8*i,7/8*s),e.lineTo(2/8*i,7/8*s),e.lineTo(2/8*i,3/8*s),e.arc(.5*i,3/8*s,2/8*i,-Math.PI,0),e.closePath(),e.fill(),e.fillStyle="black",e.font="14px sans-serif",e.textAlign="center",e.fillText("xxx",.5*i,.5*s)},Diamond:function(e,t){let i=t.width,s=t.height;e.fillStyle="#B4FFFD",e.beginPath(),e.moveTo(2/8*i,3/8*s),e.lineTo(3/8*i,1/8*s),e.lineTo(.5*i,3/8*s),e.fill(),e.fillStyle="white",e.beginPath(),e.moveTo(3/8*i,1/8*s),e.lineTo(4.5/8*i,1/8*s),e.lineTo(.5*i,3/8*s),e.fill(),e.fillStyle="#4898B8",e.beginPath(),e.moveTo(4.5/8*i,1/8*s),e.lineTo(5/8*i,3/8*s),e.lineTo(.5*i,3/8*s),e.fill(),e.fillStyle="#B4FFFD",e.beginPath(),e.moveTo(4.5/8*i,1/8*s),e.lineTo(6/8*i,1/8*s),e.lineTo(5/8*i,3/8*s),e.fill(),e.fillStyle="#61CAFB",e.beginPath(),e.moveTo(6/8*i,1/8*s),e.lineTo(7/8*i,3/8*s),e.lineTo(5/8*i,3/8*s),e.fill(),e.fillStyle="#B4FFFD",e.beginPath(),e.moveTo(5/8*i,3/8*s),e.lineTo(7/8*i,3/8*s),e.lineTo(4.5/8*i,6/8*s),e.fill(),e.fillStyle="#61CAFB",e.beginPath(),e.moveTo(5/8*i,3/8*s),e.lineTo(4.5/8*i,6/8*s),e.lineTo(.5*i,3/8*s),e.fill(),e.fillStyle="#4898B8",e.beginPath(),e.moveTo(.5*i,3/8*s),e.lineTo(4.5/8*i,6/8*s),e.lineTo(2/8*i,3/8*s),e.fill()},DirtDiamondBlock:function(e,t){let i=t.width,s=t.height;c.DirtBlock(e,{width:i,height:s}),e.save(),e.translate(-1/12*i,s/6),c.Diamond(e,{width:i,height:.8*s}),e.restore()}};class g{constructor(e){this.stateMachine=e.stateMachine,this.canvasBounds=null,this.camera=new h,this.camera.scale=new s(1,1),this.tweenManager=new a,this.registeredEvents={},this.playerPosition=new s(0,0),this.playButton=new l(50,50,e.element,"begin"),this.wasChanged=!1,this.save=new d,this.deleteSaveButton=new l(50,50,e.element,"delete save","skipbutton")}init(e){this.canvasBounds=e.bounds}draw(e,t){let i=this.canvasBounds.width/500;e.fillStyle=r.Colors.ivory,e.font=`600 ${Math.min(Math.floor(48*i),48)}px ${r.Fonts.Header}`,e.textAlign="center",this.camera.draw(e,t,(()=>{e.save(),e.translate(0,-150),this.drawCameo(e),e.restore(),e.fillText("Merchant",0,-40),e.fillText("🔸 of 🔸",0,0),e.fillText("DEATH",0,40)})),this.playButton.setPosition(.5*this.canvasBounds.width,this.canvasBounds.height*(3/4)),this.playButton.draw(e,t),this.deleteSaveButton.setPosition(.5*this.canvasBounds.width,this.canvasBounds.height*(3/4)+100),this.deleteSaveButton.draw(e,t)}drawPlayer(e){e.fillStyle=r.Colors.black,e.beginPath(),e.arc(-10,-8,8,Math.PI,3*Math.PI/2),e.lineTo(10,-16),e.arc(10,-8,8,3*Math.PI/2,2*Math.PI),e.lineTo(24,28),e.lineTo(-24,28),e.closePath(),e.fill()}drawDashHead(e){e.save(),e.translate(0,-16),e.scale(.7,.7),c.DashHead(e,{}),e.restore()}drawCameo(e){c.Cameo(e,{width:128})}update(e){this.playButton.update(e),this.deleteSaveButton.update(e),this.camera.targetPosition.y=8*Math.sin((new Date).getTime()/500),this.camera.update(e),this.tweenManager.update()}enter(){this.registeredEvents.resize=this.onResize.bind(this),this.registeredEvents.keyup=this.onKeyUp.bind(this);for(let e in this.registeredEvents)window.addEventListener(e,this.registeredEvents[e]);this.playButton.attach(),this.playButton.onClick(this.goToGame.bind(this)),this.deleteSaveButton.attach(),this.deleteSaveButton.onClick(this.deleteSave.bind(this))}leave(){for(let e in this.registeredEvents)window.removeEventListener(e,this.registeredEvents[e]);this.registeredEvents={},this.tweenManager.clear(),this.playButton.remove(),this.deleteSaveButton.remove()}onResize(){}onKeyUp(e){if("Enter"===e.code)this.goToGame()}goToGame(){this.stateMachine.transitionTo("storyupdate")}deleteSave(){confirm("Are you sure you want to delete your save data?")&&(this.save.delete(),alert("Save data deleted"))}mute(){console.log("mute")}}class u{constructor(){this.margin={left:8,right:8},this.padding={top:4,left:8,bottom:4,right:8},this.fontSize=24}draw(e,t,i){let s=i.width,h=0;t.split("\n").forEach((t=>{for(;this.textIsTooLong(e,t,s);){let i=this.getShortTextIndex(e,t,s),a=t.substr(0,i).trim();t=t.substr(i),this.drawTextLine(e,a,h),h++}this.drawTextLine(e,t.trim(),h),h++}))}drawTextLine(e,t,i){let s=e.measureText(t),h=Math.max(Math.ceil(this.fontSize),s.actualBoundingBoxAscent+s.actualBoundingBoxDescent);e.fillText(t,this.padding.left,this.padding.top+i*h)}getShortTextIndex(e,t,i){let s=0;for(;this.textIsTooLong(e,t,i);){s++;let e=t.split(" ");if(e.pop(),t=e.join(" "),s>50)throw new Error(`Text won't fit in ${i}`)}return t.length}textIsTooLong(e,t,i){let s=e.measureText(t),h=i-(this.padding.left+this.padding.right+this.margin.left+this.margin.right);return s.width>h}}class m{constructor(e){this.stateMachine=e.stateMachine,this.camera=new h,this.camera.scale=new s(1,1),this.textWrapper=new u,this.continueButton=new l(50,50,e.element,"continue"),this.stageIndex=0,this.storyStages=[{header:"Introduction",text:"You are a gentleman merchant, grave-robbing and selling disreputable goods to the upper class.\n            \n            After spending your nights gathering materials, sell them to your discerning patrons at high prices.\n            \n            You seek the legendary blue diamond, buried with one of the world's elite."},{header:"The First Day",text:"Your first night was successful!\n            \n            You brought your goods to market and are gaining quite the notorious reputation."},{header:"The Pauper's Grounds",text:"Your reputation grows as fast as your coin-purse.\n            \n            Keep your eyes on the prize and purchase access to better graveyards.\n            "},{header:"Shady Oaks",text:"Your reputation grows as fast as your coin-purse.\n            \n            Keep your eyes on the prize and purchase access to better graveyards.\n            "},{header:"Peaceful Glen",text:"Your reputation grows as fast as your coin-purse.\n            \n            Keep your eyes on the prize and purchase access to better graveyards.\n            "},{header:"Guilded Repose",text:"Your reputation grows as fast as your coin-purse.\n            \n            This burial ground is rumored to contain the blue diamond! Good luck!\n            "}],this.save=new d}init(e){this.canvasBounds=e.bounds}draw(e,t){let i=this.canvasBounds.width/500;this.camera.draw(e,t,(()=>{e.fillStyle=r.Colors.ivory;let t=Math.min(Math.floor(48*i),48);e.font=`${t}px ${r.Fonts.Header}`,e.textAlign="center",e.save(),e.translate(0,-this.canvasBounds.height/2+t),e.fillText(this.storyStages[this.stageIndex].header,0,0),e.restore(),e.fillStyle=r.Colors.ivory,e.font=`${Math.min(Math.floor(20*i),20)}px ${r.Fonts.Header}`,e.save(),e.translate(0,-this.canvasBounds.height/2+200),e.textAlign="center",this.textWrapper.draw(e,this.storyStages[this.stageIndex].text,{width:Math.min(this.canvasBounds.width,600)}),e.restore(),e.save(),e.translate(-55,100),c.Diamond(e,{width:100,height:80}),e.restore(),e.save(),e.translate(0,-this.canvasBounds.height/2+100),c.DashHead(e,{}),e.restore(),e.save(),e.translate(-Math.min(this.canvasBounds.width/4,200),-this.canvasBounds.height/2+90),c.Skull(e,{width:80,height:80}),e.restore(),e.save(),e.translate(Math.min(this.canvasBounds.width/4,200)-50,-this.canvasBounds.height/2+60),c.Bone(e,{width:80,height:80}),e.restore()})),this.continueButton.setPosition(.5*this.canvasBounds.width,this.canvasBounds.height*(7/8)),this.continueButton.draw(e,t)}update(e){this.camera.update(e),this.continueButton.update(e),this.stageIndex>this.storyStages.length-1&&(this.stageIndex=0)}enter(){this.registeredEvents={},this.registeredEvents.resize=this.onResize.bind(this),this.registeredEvents.keydown=this.onKeyDown.bind(this),this.registeredEvents.keyup=this.onKeyUp.bind(this),this.registeredEvents.touchstart=this.onTouchStart.bind(this),this.registeredEvents.touchmove=this.onTouchMove.bind(this),this.registeredEvents.touchend=this.onTouchEnd.bind(this),this.registeredEvents.mousedown=this.onMouseDown.bind(this),this.registeredEvents.mousemove=this.onMouseMove.bind(this),this.registeredEvents.mouseup=this.onMouseUp.bind(this);for(let e in this.registeredEvents)window.addEventListener(e,this.registeredEvents[e]);this.continueButton.attach(),this.continueButton.onClick(this.goToGame.bind(this)),this.stageIndex=null==this.save.getKey("story-stage")?0:this.save.getKey("story-stage"),1==this.save.getKey("graveyard-1")&&2==this.save.getKey("story-stage")&&(this.stageIndex=3),1==this.save.getKey("graveyard-2")&&3==this.save.getKey("story-stage")&&(this.stageIndex=4),1==this.save.getKey("graveyard-3")&&4==this.save.getKey("story-stage")&&(this.stageIndex=5)}leave(){for(let e in this.registeredEvents)window.removeEventListener(e,this.registeredEvents[e]);this.continueButton.remove()}goToGame(){this.save.setKey("story-stage",this.stageIndex),1==this.save.getKey("story-stage")&&this.save.setKey("story-stage",2),this.stateMachine.transitionTo("dig")}onResize(){}onKeyDown(e){}onKeyUp(e){if("Enter"===e.code)this.goToGame()}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}}class v{constructor(e,t,i,s){this.picture=e,this.text=t,this.value=i,this.cost=s,this.locked=!0,this.hovered=!1,this.upgraded=!1,this.save=new d,this.save.getKey(this.value)&&(this.upgraded=!0,this.locked=!1)}update(e){}draw(e,t){let i=t.bounds.width/500;if(e.lineWidth=4,e.fillStyle=r.Colors.lilac,e.strokeStyle=r.Colors.lilac,this.locked&&(e.fillStyle=r.Colors.umber,e.strokeStyle=r.Colors.umber),!this.locked&&this.hovered&&(e.fillStyle=r.Colors.lilac,e.strokeStyle=r.Colors.seagreen),this.upgraded&&(e.fillStyle=r.Colors.seagreen,e.strokeStyle=r.Colors.seagreen),e.beginPath(),e.roundRect(0,0,r.Game.TileSize.width,r.Game.TileSize.height,8),e.fill(),e.stroke(),this.picture(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.fillStyle=r.Colors.black,!this.locked&&this.hovered&&(e.fillStyle=r.Colors.seagreen),this.upgraded&&(e.fillStyle=r.Colors.ivory),e.font=`${Math.min(Math.floor(48*i),48)}px ${r.Fonts.Header}`,e.textAlign="center",e.fillText(this.text,r.Game.TileSize.width/2,r.Game.TileSize.height-4),!this.upgraded){let t=this.save.getKey("money");e.fillStyle=r.Colors.darkgreen,this.cost>t&&(e.fillStyle=r.Colors.darkred),e.font=`${Math.min(Math.floor(18*i),18)}px ${r.Fonts.Header}`,e.textAlign="center",e.fillText(`$${this.cost}`,r.Game.TileSize.width/2,20)}}purchaseUpgrade(){if(this.upgraded)return!1;return this.save.getKey("money")>=this.cost&&(this.save.incrementKey("money",-this.cost),this.upgraded=!0,this.save.setKey(this.value,!0),!0)}}class f{constructor(e){this.stateMachine=e.stateMachine,this.camera=new h,this.camera.scale=new s(1,1),this.continueButton=new l(50,50,e.element,"continue","ContinueButton"),this.save=new d,this.upgrades=[]}init(e){this.canvasBounds=e.bounds}draw(e,t){let i=this.canvasBounds.width/500,s=Math.min(Math.floor(48*i),48);this.camera.draw(e,t,(()=>{e.fillStyle="gray",e.beginPath(),e.rect(-this.canvasBounds.width/2,-this.canvasBounds.height/2,this.canvasBounds.width,128),e.fill(),e.fillStyle=r.Colors.ivory,e.font=`${s}px ${r.Fonts.Header}`,e.textAlign="center",e.fillText("Upgrade",0,-this.canvasBounds.height/2+s+24),e.save(),e.translate(-r.Game.TileSize.width/2,-this.canvasBounds.height/2+128+r.Game.TileSize.height-r.Game.TileSize.height/2),this.upgrades.forEach(((i,s)=>{e.save(),e.translate(s*this.canvasBounds.width/this.upgrades.length-this.canvasBounds.width/this.upgrades.length,24),this.drawUpgradeRow(e,t,i),e.restore()})),e.fillStyle=r.Colors.darkgreen,e.textAlign="right",e.fillText(`$${this.getDollars()}`,this.canvasBounds.width/2-48,-48),e.restore()})),this.continueButton.setPosition(this.canvasBounds.width/2,Math.max(this.canvasBounds.height*(7/8),5*this.incrementRow()+128)),this.continueButton.draw(e,t)}getDollars(){return this.save.getKey("money")}incrementRow(){return Math.max(this.canvasBounds.height/7,r.Game.TileSize.width+4*r.Game.TileSize.spacing)}drawUpgradeRow(e,t,i){e.textAlign="center",e.fillStyle=r.Colors.ivory;let s=this.canvasBounds.width/500,h=Math.min(Math.floor(24*s),24);e.font=`${h}px ${r.Fonts.Header}`,e.fillText(i.header,r.Game.TileSize.width/2,-h),e.strokeStyle=r.Colors.ivory,e.lineWidth=4,e.save(),e.translate(r.Game.TileSize.width/2,r.Game.TileSize.height/2);for(let t=0;t<i.length-1;t++)e.beginPath(),e.moveTo(0,this.incrementRow()*t),e.lineTo(0,this.incrementRow()*(t+1)),e.stroke();e.restore(),i.buttons.forEach(((i,s)=>{e.save(),e.translate(0,this.incrementRow()*s),i.draw(e,t),e.restore()}))}update(e){this.camera.update(e),this.continueButton.update(e)}enter(){this.registeredEvents={},this.registeredEvents.resize=this.onResize.bind(this),this.registeredEvents.keydown=this.onKeyDown.bind(this),this.registeredEvents.keyup=this.onKeyUp.bind(this),this.registeredEvents.touchstart=this.onTouchStart.bind(this),this.registeredEvents.touchmove=this.onTouchMove.bind(this),this.registeredEvents.touchend=this.onTouchEnd.bind(this),this.registeredEvents.mousedown=this.onMouseDown.bind(this),this.registeredEvents.mousemove=this.onMouseMove.bind(this),this.registeredEvents.mouseup=this.onMouseUp.bind(this);for(let e in this.registeredEvents)window.addEventListener(e,this.registeredEvents[e]);this.continueButton.attach(),this.continueButton.onClick((()=>{this.stateMachine.transitionTo("storyupdate")})),this.upgrades=[{header:"shovel speed",buttons:[new v(c.Shovel,"I","shovel-1",10),new v(c.Shovel,"II","shovel-2",50),new v(c.Shovel,"III","shovel-3",100)]},{header:"bone rarity",buttons:[new v(c.Bone,"I","bone-1",50),new v(c.Bone,"II","bone-2",100),new v(c.Bone,"III","bone-3",200)]},{header:"new area",buttons:[new v(c.Tombstone,"I","graveyard-1",100),new v(c.Tombstone,"II","graveyard-2",200),new v(c.Tombstone,"III","graveyard-3",400)]}],this.upgrades.forEach((e=>{e.buttons.forEach(((t,i)=>{0==i&&(t.locked=!1),i>0&&e.buttons[i-1].upgraded&&(t.locked=!1)}))}))}leave(){for(let e in this.registeredEvents)window.removeEventListener(e,this.registeredEvents[e]);this.continueButton.remove()}onResize(){}onKeyDown(e){}onKeyUp(e){if("Enter"===e.code)this.stateMachine.transitionTo("dig")}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onMouseDown(e){}onMouseMove(e){let t=this.camera.screenToWorld(new s(e.clientX,e.clientY));t.offset(new s(0,this.canvasBounds.height/2-152-r.Game.TileSize.height)),document.body.style.cursor="default",this.upgrades.forEach(((e,i)=>{e.buttons.forEach(((e,s)=>{e.hovered=!1;let h=i*this.canvasBounds.width/this.upgrades.length-this.canvasBounds.width/this.upgrades.length-r.Game.TileSize.width/2;if(t.x>h&&t.x<h+r.Game.TileSize.width){let i=this.incrementRow()*s-r.Game.TileSize.height/2;t.y>i&&t.y<i+r.Game.TileSize.height&&(document.body.style.cursor="pointer",e.hovered=!0)}}))}))}onMouseUp(e){this.upgrades.forEach(((e,t)=>{e.buttons.forEach(((t,i)=>{t.hovered&&t.purchaseUpgrade()&&e.buttons[i+1]&&(e.buttons[i+1].locked=!1)}))}))}}i(709);class y{constructor(e){this.stateMachine=e.stateMachine,this.camera=new h,this.camera.scale=new s(1,1),this.time=0,this.skyColor=[{r:14,g:85,b:119},{r:6,g:12,b:39},{r:6,g:12,b:39},{r:6,g:12,b:39},{r:36,g:41,b:67},{r:228,g:166,b:70}],this.lightOffset=0,this.playerPosition=new s(0,0),this.camera.speed=8,this.touchStart=new s(0,0),this.touchEnd=new s(0,0),this.touchDuration=0,this.level=[],this.levelSize={width:20,height:10,bones:12,skulls:3,time:24e3},this.actions=[],this.hasMoved=!1,this.tweenManager=new a,this.save=new d}init(e){this.canvasBounds=e.bounds}enter(){this.registeredEvents={},this.registeredEvents.resize=this.onResize.bind(this),this.registeredEvents.keydown=this.onKeyDown.bind(this),this.registeredEvents.keyup=this.onKeyUp.bind(this),this.registeredEvents.mousedown=this.onMouseDown.bind(this),this.registeredEvents.mousemove=this.onMouseMove.bind(this),this.registeredEvents.mouseup=this.onMouseUp.bind(this);for(let e in this.registeredEvents)window.addEventListener(e,this.registeredEvents[e]);this.time=0,this.lightOffset=0,this.level=this.generateLevel(),this.playerPosition.y=1,this.playerPosition.x=0,this.camera.targetPosition.x=0,this.camera.targetPosition.y=0,this.camera.position.x=0,this.camera.position.y=0,this.level.find((e=>e[0]==this.playerPosition.x&&e[1]==this.playerPosition.y))[3]=0,this.completePosition=new s(0,-1e3),this.completeText="Daybreak!",this.isComplete=!1,this.digStrength=1,1==this.save.getKey("shovel-1")&&(this.digStrength=1.5),this.save.getKey("shovel-2")&&(this.digStrength=2),this.save.getKey("shovel-3")&&(this.digStrength=3),this.stones=[];for(let e=0;e<this.levelSize.width/5;e++)this.stones.push(Math.floor(this.levelSize.width*Math.random()));this.actions=[]}leave(){for(let e in this.registeredEvents)window.removeEventListener(e,this.registeredEvents[e])}draw(e,t){this.canvasBounds=t.bounds,e.fillStyle=r.Colors.dirtbrown,e.fillRect(0,0,this.canvasBounds.width,this.canvasBounds.height),this.camera.draw(e,t,(()=>{e.fillStyle=this.computeSkyColor(),e.fillRect(-this.levelSize.width*(r.Game.TileSize.width+r.Game.TileSize.spacing)*2,-this.canvasBounds.height/2-(r.Game.TileSize.height+r.Game.TileSize.spacing)/2,this.levelSize.width*(r.Game.TileSize.width+r.Game.TileSize.spacing)*6,this.canvasBounds.height/2),e.fillStyle=r.Colors.dirtbrown,e.fillRect(-this.canvasBounds.width,0,this.levelSize.width*(r.Game.TileSize.width+r.Game.TileSize.spacing)*4,this.canvasBounds.height/2),this.stones.forEach((t=>{e.save(),e.translate(t*(r.Game.TileSize.width+r.Game.TileSize.spacing)-(r.Game.TileSize.width+r.Game.TileSize.spacing)/2,-1.35*(r.Game.TileSize.height+r.Game.TileSize.spacing)),c.Tombstone(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.restore()})),e.fillStyle=r.Colors.grassgreen,e.roundRect(-this.levelSize.width*(r.Game.TileSize.width+r.Game.TileSize.spacing)*2,-(r.Game.TileSize.height+r.Game.TileSize.spacing)/2,this.levelSize.width*(r.Game.TileSize.width+r.Game.TileSize.spacing)*6,10,8),e.fill();for(let t=0;t<this.level.length;t++){let i=this.level[t];this.drawTile(e,i)}this.drawPlayer(e)})),e.strokeStyle=r.Colors.ivory,e.lineWidth=2,e.beginPath(),e.rect(2,2,this.canvasBounds.width-4,8),e.stroke(),e.fillStyle=r.Colors.ivory,e.beginPath(),e.rect(0,2,(this.canvasBounds.width-4)*(this.time/(this.levelSize.time-this.levelSize.time/this.skyColor.length)),8),e.fill();let i=this.canvasBounds.width/500,s=0;for(let t=0;t<this.getNumberOfGatheredSkulls();t++)e.save(),e.scale(.4,.4),e.translate(t*(r.Game.TileSize.width+r.Game.TileSize.spacing)+r.Game.TileSize.width/2+16,32+r.Game.TileSize.height/2),c.Skull(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.restore(),s++;for(let t=0;t<this.getNumberOfGatheredBones();t++)e.save(),e.scale(.4,.4),e.translate(16+(t+s)*(r.Game.TileSize.width+r.Game.TileSize.spacing),32),c.Bone(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.restore();e.font=`${Math.min(Math.floor(48*i),48)}px ${r.Fonts.Header}`,e.textAlign="center";let h=e.measureText(this.completeText);e.fillStyle=r.Colors.umber,e.save(),e.translate(this.canvasBounds.width/2,this.canvasBounds.height/2),e.beginPath(),e.roundRect(this.completePosition.x-(h.width+64)/2,this.completePosition.y-Math.min(Math.floor(48*i),48)-16,h.width+64,Math.min(Math.floor(64*i),64)+32,8),e.fill(),e.fillStyle=r.Colors.ivory,e.fillText(this.completeText,this.completePosition.x,this.completePosition.y),e.restore()}drawPlayer(e){e.fillStyle=r.Colors.ivory,e.save(),e.translate(this.playerPosition.x*(r.Game.TileSize.width+r.Game.TileSize.spacing),this.playerPosition.y*(r.Game.TileSize.height+r.Game.TileSize.spacing)),c.DigPlayer(e,{}),e.restore()}computeSkyColor(){let e=this.time/(this.levelSize.time/this.skyColor.length)-this.lightOffset;return`rgb(${e*(this.skyColor[this.lightOffset+1].r-this.skyColor[this.lightOffset+0].r)+this.skyColor[this.lightOffset+0].r}, ${e*(this.skyColor[this.lightOffset+1].g-this.skyColor[this.lightOffset+0].g)+this.skyColor[this.lightOffset+0].g}, ${e*(this.skyColor[this.lightOffset+1].b-this.skyColor[this.lightOffset+0].b)+this.skyColor[this.lightOffset+0].b})`}drawTile(e,t){let i=r.Game.TileSize.width,s=r.Game.TileSize.height,h=r.Game.TileSize.spacing,a=t[0],n=t[1],o=t[2],l=t[3],d=t[4];if(e.save(),e.translate(a*i-i/2+a*h,n*s-s/2+n*h),0==l)return e.fillStyle="black",e.roundRect(-2,-2,i+2,s+2,10),e.fill(),void e.restore();switch(o){case"dirt":c.DirtBlock(e,{width:i,height:s});break;case"grass":c.GrassBlock(e,{width:i,height:s});break;case"dirt-bones":c.DirtBoneBlock(e,{width:i,height:s});break;case"dirt-skull":c.DirtSkullBlock(e,{width:i,height:s});break;case"dirt-diamond":c.DirtDiamondBlock(e,{width:i,height:s})}l<d&&(e.fillStyle=r.Colors.ivory,e.strokeStyle=r.Colors.ivory,e.lineWidth=2,e.beginPath(),e.rect(4,s/8,i-8,6),e.stroke(),e.beginPath(),e.rect(4,s/8,i*(l/d)-8,6),e.fill()),e.restore()}update(e){if(!this.isComplete){if(this.time>=this.levelSize.time-this.levelSize.time/this.skyColor.length?(this.isComplete=!0,this.completeText="Daybreak!",this.tweenManager.add(new n(this.completePosition,{y:0},2e3,o.Elastic.EaseOut,(()=>{this.sceneComplete()})))):(this.time+=e,this.lightOffset=Math.min(this.skyColor.length-2,Math.floor(this.time/(this.levelSize.time/this.skyColor.length)))),this.actions.length>0){switch(this.actions.shift()){case"up":this.digOrMoveY(-1);break;case"down":this.digOrMoveY(1);break;case"left":this.digOrMoveX(-1);break;case"right":this.digOrMoveX(1)}}this.levelSize.diamonds>0&&this.getNumberOfGatheredDiamonds()==this.levelSize.diamonds&&(this.isComplete=!0,this.completeText="Success!",this.tweenManager.add(new n(this.completePosition,{y:0},2e3,o.Elastic.EaseOut,(()=>{this.sceneComplete()})))),this.getNumberOfGatheredBones()==this.levelSize.bones&&this.getNumberOfGatheredSkulls()==this.levelSize.skulls&&(this.isComplete=!0,this.completeText="Looted!",this.tweenManager.add(new n(this.completePosition,{y:0},2e3,o.Elastic.EaseOut,(()=>{this.sceneComplete()}))))}this.camera.update(e),this.tweenManager.update()}sceneComplete(){this.save.incrementKey("bones",this.getNumberOfGatheredBones()),this.save.incrementKey("skulls",this.getNumberOfGatheredSkulls()),this.save.incrementKey("diamonds",this.getNumberOfGatheredDiamonds()),this.save.getKey("diamonds")>0?this.stateMachine.transitionTo("credits"):this.stateMachine.transitionTo("shop")}getNumberOfGatheredBones(){return this.level.filter((e=>"dirt-bones"==e[2]&&0==e[3])).length}getNumberOfGatheredSkulls(){return this.level.filter((e=>"dirt-skull"==e[2]&&0==e[3])).length}getNumberOfGatheredDiamonds(){return this.level.filter((e=>"dirt-diamond"==e[2]&&0==e[3])).length}moveX(e){let t=r.Game.TileSize.width+r.Game.TileSize.spacing;this.playerPosition.x+=e,this.playerPosition.x<0&&(this.playerPosition.x=0),this.playerPosition.x>=this.levelSize.width-1&&(this.playerPosition.x=this.levelSize.width-1),this.playerPosition.x*t>this.camera.targetPosition.x+this.canvasBounds.width/4&&(this.camera.targetPosition.x+=t*e),this.playerPosition.x*t<this.camera.targetPosition.x+-this.canvasBounds.width/4&&(this.camera.targetPosition.x+=t*e)}digOrMoveX(e){let t=this.playerPosition.x+e,i=this.playerPosition.y,s=this.level.find((e=>e[0]==t&&e[1]==i));s&&(s[3]>0&&(s[3]=Math.max(0,s[3]-this.digStrength),0==s[3]&&(this.playSound(this.digSound2),["dirt","grass"].includes(s[2])||this.playSound(this.gatherSound))),s[3]<=0&&this.moveX(e))}moveY(e){let t=r.Game.TileSize.height+r.Game.TileSize.spacing;this.playerPosition.y+=e,this.playerPosition.y<0&&(this.playerPosition.y=0),this.playerPosition.y>=this.levelSize.height-1&&(this.playerPosition.y=this.levelSize.height-1),this.playerPosition.y*t>this.camera.targetPosition.y+this.canvasBounds.height/4&&(this.camera.targetPosition.y+=t*e),this.playerPosition.y*t<this.camera.targetPosition.y+-this.canvasBounds.height/4&&(this.camera.targetPosition.y+=t*e)}digOrMoveY(e){let t=this.playerPosition.x,i=this.playerPosition.y+e,s=this.level.find((e=>e[0]==t&&e[1]==i));s&&(s[3]>0&&(s[3]=Math.max(0,s[3]-this.digStrength),0==s[3]&&(this.playSound(this.digSound2),["dirt","grass"].includes(s[2])||this.playSound(this.gatherSound))),s[3]<=0&&this.moveY(e))}generateLevel(){this.levelSize={width:10,height:6,bones:8,skulls:1,diamonds:0,time:24e3},this.save.getKey("graveyard-1")&&(this.levelSize={width:20,height:10,bones:12,skulls:3,diamonds:0,time:24e3}),this.save.getKey("graveyard-2")&&(this.levelSize={width:40,height:15,bones:24,skulls:8,diamonds:0,time:24e3}),this.save.getKey("graveyard-3")&&(this.levelSize={width:20,height:50,bones:36,skulls:16,diamonds:1,time:24e3});let e=[];for(let t=0;t<this.levelSize.height;t++)for(let i=0;i<this.levelSize.width;i++)0==t?e.push([i,t,"grass",4,4]):e.push([i,t,"dirt",3,3]);this.save.getKey("bone-3")?(this.levelSize.bones=Math.ceil(2*this.levelSize.bones),this.levelSize.skulls=Math.ceil(2*this.levelSize.skulls)):this.save.getKey("bone-2")?(this.levelSize.bones=Math.ceil(1.5*this.levelSize.bones),this.levelSize.skulls=Math.ceil(1.5*this.levelSize.skulls)):this.save.getKey("bone-1")&&(this.levelSize.bones=Math.ceil(1.2*this.levelSize.bones),this.levelSize.skulls=Math.ceil(1.2*this.levelSize.skulls));for(let t=0;t<this.levelSize.bones;t++){let t=this.getRandomIndex(e,(e=>0!=e[1]&&"dirt-bones"!=e[2]));t[2]="dirt-bones",t[3]=4,t[4]=4}for(let t=0;t<this.levelSize.skulls;t++){let t=this.getRandomIndex(e,(e=>0!=e[1]&&"dirt-bones"!=e[2]&&"dirt-skull"!=e[2]));t[2]="dirt-skull",t[3]=8,t[4]=8}for(let t=0;t<this.levelSize.diamonds;t++){let t=this.getRandomIndex(e,(e=>0!=e[1]&&"dirt-bones"!=e[2]&&"dirt-skull"!=e[2]&&"dirt-diamond"!=e[2]));t[2]="dirt-diamond",t[3]=16,t[4]=16}return e}getRandomIndex(e,t){let i=e[Math.floor(e.length*Math.random())],s=10;for(;!t(i);){if(s--,s<=0)throw new Error("unable to get item that meets conditions");i=e[Math.floor(e.length*Math.random())]}return i}onResize(){this.camera.targetPosition.x=this.playerPosition.x*(r.Game.TileSize.width+r.Game.TileSize.spacing),this.camera.targetPosition.y=this.playerPosition.y*(r.Game.TileSize.height+r.Game.TileSize.spacing)}onKeyDown(e){if(this.hasMoved)return;let t=[];t[e.code]=!0,(t.KeyW||t.ArrowUp||t.KeyZ)&&(this.actions.push("up"),this.hasMoved=!0),(t.KeyS||t.ArrowDown)&&(this.actions.push("down"),this.hasMoved=!0),(t.KeyA||t.ArrowLeft||t.KeyQ)&&(this.actions.push("left"),this.hasMoved=!0),(t.KeyD||t.ArrowRight)&&(this.actions.push("right"),this.hasMoved=!0)}onKeyUp(e){this.hasMoved=!1}onMouseDown(e){if(this.hasMoved)return;this.hasMoved=!0;let t=this.camera.screenToWorld(new s(e.clientX,e.clientY)).difference((new s).clone(this.playerPosition).scale(r.Game.TileSize.width+r.Game.TileSize.spacing,r.Game.TileSize.height+r.Game.TileSize.spacing));if(Math.abs(t.x)>Math.abs(t.y)){Math.sign(t.x)>0?this.actions.push("right"):this.actions.push("left")}else{Math.sign(t.y)>0?this.actions.push("down"):this.actions.push("up")}}onMouseMove(e){}onMouseUp(e){this.hasMoved=!1}digSound1(e,t){return e>5e3?null:(200&Math.pow(e+1e3*Math.sin(.01*e),.25)?1:-1)*Math.pow(t(e,5e3),1)}digSound2(e,t){return e>5e3?null:(2*Math.random()-1)*t(e,5e3)}gatherSound(e,t){var i=16e3;if(e>i)return null;var s=Math.pow(t(e,i),2.1);return(e<2285.714285714286?e+10*Math.sin(-e/900)&16:13&e)?s:-s}playSound(e){let t=(e,t)=>(t-e)/t,i=new AudioContext,s=i.createBuffer(1,96e3,48e3),h=s.getChannelData(0);for(let i=96e3;i--;)h[i]=e(i,t);let a=i.createBufferSource();a.buffer=s,a.connect(i.destination),a.start()}}class w{constructor(e,t,i,s){this.tweenManager=e,this.position=i,this.alpha=0,this.text=t,this.isCompleted=!1,setTimeout((()=>{this.alpha=1,this.tweenManager.add(new n(this,{position:{y:this.position.y-60},alpha:0},1e3,o.Linear.EaseNone,(()=>{this.isCompleted=!0})))}),s)}draw(e,t){e.fillStyle=r.Colors.darkgreen.replace(")",`,${this.alpha})`),e.font="36px Arial",e.textAlign="center",e.save(),e.translate(this.position.x,this.position.y),e.fillText(this.text,0,0),e.restore()}update(e){}}i(348);class p{constructor(){this.textWrapper=new u,this.init()}init(){this.generateRequest()}generateRequest(){switch(this.availableItems=["bones","skulls","bones","bones","bones"],this.item=this.availableItems.shuffle().pop(),this.item){case"bones":this.generateBonesRequest();break;case"skulls":this.generateSkullsRequest()}}generateBonesRequest(){this.amount=Math.floor(4*Math.random())+3,this.rate=Math.floor((500*Math.random()+100)/100);let e=[`I need ${this.amount} bones so I can bury them for my family. My family loves bones!`,`Do you think I could get ${this.amount} bones?`,`I only need ${this.amount}; do you have any extra bones I can have?`,`I really need some fresh bones! I need ${this.amount} immediately!`];this.message=e.shuffle()[0];let t=[c.DogHead1,c.DogHead2];this.customerPicture=t.shuffle().pop()}generateSkullsRequest(){this.amount=Math.floor(4*Math.random())+1,this.rate=Math.floor((5e3*Math.random()+1e3)/100);let e=[`Did you see those skulls? I must get my hands on ${this.amount} of them!`,`I only wish for ${this.amount} skulls.`,`Do you take cash? I heard you have ${this.amount} skulls for sale...`,`Skulls are tres chique right now. Give me ${this.amount} immediately!`];this.message=e.shuffle()[0];let t=[c.DogHead1,c.DogHead2];this.customerPicture=t.shuffle().pop()}update(e,t){this.canvasBounds=t,this.cardHeight=Math.max(this.canvasBounds.height/6,100),this.fontScale=this.canvasBounds.width/500,this.screenWidth=this.canvasBounds.width}draw(e,t){let i=Math.min(Math.floor(24*this.fontScale),24);e.strokeStyle=r.Colors.black,e.lineWidth=1,e.fillStyle=r.Colors.umber,e.beginPath(),e.roundRect(8,0,this.screenWidth-16,this.cardHeight,8),e.fill(),e.fillStyle=r.Colors.seagreen,this.hovered&&(e.fillStyle=r.Colors.ivory),e.beginPath(),e.arc(this.screenWidth-(16+this.cardHeight/4),2*this.cardHeight/4,this.cardHeight/4,0,2*Math.PI),e.fill(),e.font=`${i}px ${r.Fonts.Header}`,e.textAlign="center",e.fillStyle=r.Colors.ivory,this.hovered&&(e.fillStyle=r.Colors.seagreen),e.fillText("$"+this.amount*this.rate,this.screenWidth-(16+this.cardHeight/4),this.cardHeight/4*2+i/4),e.fillStyle=r.Colors.umber,e.beginPath(),e.roundRect(16,8,9*this.cardHeight/12,this.cardHeight-16,8),e.fill(),e.save(),e.translate(16+9*this.cardHeight/12/2,(this.cardHeight-16)/2),this.customerPicture(e,{}),e.restore(),e.fillStyle=r.Colors.ivory,e.font=`${i}px ${r.Fonts.Header}`,e.textAlign="left",e.save(),e.translate(32+9*this.cardHeight/12,8+i),this.textWrapper.draw(e,this.message,{width:this.screenWidth-(16+this.cardHeight/4)-32-9*this.cardHeight/12}),e.restore()}mouseMove(e,t){let i=new s(e.clientX,e.clientY);this.hovered=!1,i.distanceTo(new s(this.screenWidth-(16+this.cardHeight/4),2*this.cardHeight/4+t))<this.cardHeight/4&&(this.hovered=!0,document.body.style.cursor="pointer")}onClick(e){this.hovered&&e(this.item,this.rate,this.amount)}}class S{constructor(e){this.scaledCanvas=e.scaledCanvas,this.stateMachine=e.stateMachine,this.camera=new h,this.camera.scale=new s(1,1),this.tweenManager=new a,this.textPops=[],this.closeShopButton=new l(50,50,e.element,"close shop","close-shop"),this.scrollStart=new s(0,0),this.scrollEnd=new s(0,0),this.scrollOffset=new s(0,128),this.save=new d,this.shopCards=[];for(let e=0;e<Math.floor(16*Math.random())+5;e++)this.shopCards.push(new p);this.cardHeight=100}init(e){this.canvasBounds=e.bounds}draw(e,t){let i=this.canvasBounds.width/500,s=Math.min(Math.floor(48*i),48);e.save(),this.cardHeight=Math.max(this.canvasBounds.height/6,100),e.translate(0,this.scrollOffset.y+(this.scrollEnd.y-this.scrollStart.y));for(let t=0;t<this.shopCards.length;t++){let s=this.shopCards[t];e.save(),e.translate(0,this.getListRowOffset(this.cardHeight,t)),s.draw(e,{cardHeight:this.cardHeight,screenWidth:this.canvasBounds.width,fontScale:i}),e.restore()}e.restore(),e.fillStyle="gray",e.beginPath(),e.rect(0,0,this.canvasBounds.width,128),e.fill(),e.fillStyle=r.Colors.ivory,e.font=`${s}px ${r.Fonts.Header}`,e.textAlign="center",e.fillText("Bone Market",this.canvasBounds.width/2,s+24),e.save(),e.translate(16,100);let h=0;if(this.getNumberOfGatheredSkulls()>8)e.save(),e.scale(.4,.4),e.translate(r.Game.TileSize.width/2,r.Game.TileSize.height/2),c.Skull(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.fillStyle=r.Colors.ivory,e.fillText(`x${this.getNumberOfGatheredSkulls()}`,2*r.Game.TileSize.width-r.Game.TileSize.width/2,r.Game.TileSize.height/2),e.restore(),h+=3;else for(let t=0;t<this.getNumberOfGatheredSkulls();t++)e.save(),e.scale(.4,.4),e.translate(t*(r.Game.TileSize.width+r.Game.TileSize.spacing)+r.Game.TileSize.width/2,r.Game.TileSize.height/2),c.Skull(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.restore(),h++;if(this.getNumberOfGatheredBones()>8)e.save(),e.scale(.4,.4),e.translate(h*(r.Game.TileSize.width+r.Game.TileSize.spacing),0),c.Bone(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.fillStyle=r.Colors.ivory,e.fillText(`x${this.getNumberOfGatheredBones()}`,2*r.Game.TileSize.width,r.Game.TileSize.height),e.restore();else for(let t=0;t<this.getNumberOfGatheredBones();t++)e.save(),e.scale(.4,.4),e.translate((t+h)*(r.Game.TileSize.width+r.Game.TileSize.spacing),0),c.Bone(e,{width:r.Game.TileSize.width,height:r.Game.TileSize.height}),e.restore();e.fillStyle=r.Colors.darkgreen,e.textAlign="right",e.font=`${Math.min(Math.floor(24*i),48)}px ${r.Fonts.Header}`,e.fillText(`$${this.getDollars()}`,this.canvasBounds.width-48,0),e.restore(),this.camera.draw(e,t,(()=>{e.font=`${Math.min(Math.floor(48*i),48)}px ${r.Fonts.Header}`,e.textAlign="center";let s=e.measureText(this.completeText);e.fillStyle=r.Colors.umber,e.beginPath(),e.roundRect(this.completePosition.x-s.width/2,this.completePosition.y-Math.min(Math.floor(48*i),48),s.width,Math.min(Math.floor(64*i),64),8),e.fill(),e.fillStyle=r.Colors.ivory,e.fillText(this.completeText,this.completePosition.x,this.completePosition.y),this.textPops.forEach((i=>{i.draw(e,t)}))})),this.closeShopButton.setPosition(this.canvasBounds.width*(6/8),this.canvasBounds.height*(7/8)),this.closeShopButton.draw(e,t)}getListRowOffset(e,t){return t*e+8*t+24}getNumberOfGatheredBones(){return this.save.getKey("bones")}getNumberOfGatheredSkulls(){return this.save.getKey("skulls")}getDollars(){let e=this.save.getKey("money");return null==e&&(this.save.setKey("money",0),e=0),e}update(e){this.camera.update(e),this.closeShopButton.update(e),this.tweenManager.update();for(let t=0;t<this.shopCards.length;t++){this.shopCards[t].update(e,this.canvasBounds)}if(0==this.shopCards.length||0==this.shopCards.filter((e=>"bones"==e.item&&e.amount<=this.getNumberOfGatheredBones())).length&&0==this.shopCards.filter((e=>"skulls"==e.item&&e.amount<=this.getNumberOfGatheredSkulls())).length){if(this.isComplete)return;this.isComplete=!0,this.completeText="Sold Out!",this.tweenManager.add(new n(this.completePosition,{y:0},2e3,o.Elastic.EaseOut,(()=>{this.stateMachine.transitionTo("upgrade")})))}}enter(){this.registeredEvents={},this.registeredEvents.resize=this.onResize.bind(this),this.registeredEvents.keydown=this.onKeyDown.bind(this),this.registeredEvents.keyup=this.onKeyUp.bind(this),this.registeredEvents.touchstart=this.onTouchStart.bind(this),this.registeredEvents.touchmove=this.onTouchMove.bind(this),this.registeredEvents.touchend=this.onTouchEnd.bind(this),this.registeredEvents.mousedown=this.onMouseDown.bind(this),this.registeredEvents.mousemove=this.onMouseMove.bind(this),this.registeredEvents.mouseup=this.onMouseUp.bind(this),this.registeredEvents.wheel=this.onMouseWheel.bind(this);for(let e in this.registeredEvents)window.addEventListener(e,this.registeredEvents[e]);this.closeShopButton.attach(),this.closeShopButton.onClick((()=>{this.stateMachine.transitionTo("upgrade")})),this.scrollStart=new s(0,0),this.scrollEnd=new s(0,0),this.scrollOffset=new s(0,128),this.save=new d,this.shopCards=[];for(let e=0;e<Math.floor(16*Math.random())+5;e++)this.shopCards.push(new p);this.completePosition=new s(0,-1e3),this.completeText="Sold Out!",this.isComplete=!1}leave(){for(let e in this.registeredEvents)window.removeEventListener(e,this.registeredEvents[e]);this.closeShopButton.remove(),this.textPops=[]}onResize(){}onKeyDown(e){}onKeyUp(e){if("Enter"===e.code)this.stateMachine.transitionTo("upgrade")}onTouchStart(e){this.scrollStart=new s(e.touches[0].clientX,e.touches[0].clientY),this.scrollEnd=new s(e.touches[0].clientX,e.touches[0].clientY),this.isScrolling=!0}onTouchMove(e){this.isScrolling&&(this.scrollEnd.x=e.touches[0].clientX,this.scrollEnd.y=e.touches[0].clientY)}onTouchEnd(e){this.isScrolling=!1,this.scrollOffset.x+=this.scrollEnd.x-this.scrollStart.x,this.scrollOffset.y+=this.scrollEnd.y-this.scrollStart.y,this.scrollOffset.y=this.getScrollLimits(),this.scrollStart.x=0,this.scrollStart.y=0,this.scrollEnd.x=0,this.scrollEnd.y=0}getScrollLimits(){return Math.min(Math.max(this.scrollOffset.y,-this.cardHeight*(this.shopCards.length+1)+this.canvasBounds.height-128),128)}onMouseDown(e){this.scrollStart=new s(e.clientX,e.clientY),this.scrollEnd=new s(e.clientX,e.clientY),this.isScrolling=!0}onMouseMove(e){document.body.style.cursor="default";for(let t=0;t<this.shopCards.length;t++){let i=this.shopCards[t],s=this.scrollOffset.y+this.getListRowOffset(this.cardHeight,t);i.mouseMove(e,s)}this.isScrolling&&(this.scrollEnd.x=e.clientX,this.scrollEnd.y=e.clientY)}onMouseUp(e){this.isScrolling=!1,this.scrollOffset.x+=this.scrollEnd.x-this.scrollStart.x,this.scrollOffset.y+=this.scrollEnd.y-this.scrollStart.y,this.scrollOffset.y=this.getScrollLimits(),this.scrollStart.x=0,this.scrollStart.y=0,this.scrollEnd.x=0,this.scrollEnd.y=0;let t=[];for(let e=0;e<this.shopCards.length;e++){let i=this.shopCards[e];i.onClick(((e,h,a)=>{switch(e){case"bones":if(this.getNumberOfGatheredBones()<a){let e=new w(this.tweenManager,"No Sale",new s(0,0),0);return void this.textPops.push(e)}this.save.incrementKey("bones",-a);break;case"skulls":if(this.getNumberOfGatheredSkulls()<a){let e=new w(this.tweenManager,"No Sale",new s(0,0),0);return void this.textPops.push(e)}this.save.incrementKey("skulls",-a)}this.save.incrementKey("money",h*a);let n=new w(this.tweenManager,"$"+h*a,new s(0,0),0);this.textPops.push(n),t.push(i),0==this.save.getKey("story-stage")&&this.save.setKey("story-stage",1)}))}this.shopCards=this.shopCards.filter((e=>!t.includes(e)))}onMouseWheel(e){this.scrollOffset.y+=e.wheelDeltaY,this.scrollOffset.y=this.getScrollLimits()}}class T{constructor(e){this.stateMachine=e.stateMachine,this.camera=new h,this.camera.scale=new s(1,1),this.textWrapper=new u,this.headerFontSize=48,this.normalFontSize=24,this.debounce=50}init(e){this.canvasBounds=e.bounds}draw(e,t){this.camera.draw(e,t,(()=>{e.fillStyle=r.Colors.ivory,e.font=`${this.headerFontSize}px ${r.Fonts.Header}`,e.textAlign="center",this.textWrapper.fontSize=this.headerFontSize,this.textWrapper.draw(e,"You Found\n\t\t\tThe Diamond!",{width:this.canvasBounds.width}),e.save(),e.translate(0,2*this.headerFontSize),this.textWrapper.fontSize=this.normalFontSize,e.font=`${this.normalFontSize}px ${r.Fonts.Header}`,this.textWrapper.draw(e,"Developed By\n\t\t\t\n\t\t\tMidas\n\t\t\tand\n\t\t\tNusha\n\n\n\t\t\tThanks for Playing!\n\n\t\t\tjs13k Games 2022 Entry\n\t\t\t",{width:this.canvasBounds.width}),e.restore(),e.save(),e.translate(-r.Game.TileSize.width/2,400),c.Diamond(e,{width:r.Game.TileSize.width,height:.8*r.Game.TileSize.height}),e.restore()}))}update(e){this.debounce>0&&this.debounce--,this.camera.targetPosition.y=this.canvasBounds.height/2-100;let t=this.canvasBounds.width/500;this.headerFontSize=Math.min(Math.floor(48*t),48),this.normalFontSize=Math.min(Math.floor(24*t),24),this.camera.update(e),!this.ending&&this.camera.position.equals(this.camera.targetPosition)&&(this.ending=!0,this.endWait=setTimeout((()=>{this.stateMachine.transitionTo("mainmenu")}),8e3))}enter(){this.registeredEvents={},this.registeredEvents.keyup=this.onKeyUp.bind(this),this.registeredEvents.mouseup=this.onMouseUp.bind(this);for(let e in this.registeredEvents)window.addEventListener(e,this.registeredEvents[e]);this.debounce=50,this.camera.targetPosition.y=500,this.camera.position.y=-500}leave(){for(let e in this.registeredEvents)window.removeEventListener(e,this.registeredEvents[e]);clearTimeout(this.endWait)}onKeyUp(e){this.debounce>0||this.stateMachine.transitionTo("mainmenu")}onMouseUp(e){this.debounce>0||this.stateMachine.transitionTo("mainmenu")}}class b{constructor(e){this.element=e,this.stateMachine=new t,this.stateMachine.registerState("mainmenu",new g(this)),this.stateMachine.registerState("storyupdate",new m(this)),this.stateMachine.registerState("dig",new y(this)),this.stateMachine.registerState("upgrade",new f(this)),this.stateMachine.registerState("shop",new S(this)),this.stateMachine.registerState("credits",new T(this))}async init(e){this.stateMachine.getAllStates().forEach((t=>{t.init(e)})),this.stateMachine.setCurrentState("mainmenu"),this.scaledCanvas=e,this.stateMachine.getCurrentState().enter()}draw(e,t){this.stateMachine.getCurrentState().draw(e,t)}update(e){this.stateMachine.getCurrentState().update(e)}}class M{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}pointWithin(e){return e.x>this.x&&e.x<this.x+this.width&&e.y>this.y&&e.y<this.y+this.height}get center(){return new s(this.x+this.width/2,this.y+this.height/2)}}class x{constructor(e){this.canvas=null,this.context=null,this.container=e,this.bounds=new M}clearFrame(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}init(){this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.context=this.canvas.getContext("2d");let e=this.getPixelRatio();this.bounds=new M(0,0,this.canvas.width/e,this.canvas.height/e),window.addEventListener("resize",this.onResize),this.onResize()}setImageSmoothing(e){this.context.imageSmoothingEnabled=e}getPixelRatio(){return(window.devicePixelRatio||1)/(this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1)}onResize=()=>{let e=this.getPixelRatio(),t=this.canvas.getBoundingClientRect();this.bounds.x=t.x,this.bounds.y=t.y,this.bounds.width=t.width,this.bounds.height=t.height,this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.context.scale(e,e)};getContext(){return this.context}get pixelWidth(){return this.canvas.width}get pixelHeight(){return this.canvas.height}get center(){return this.bounds.center}getBounds(){return this.bounds}}class P{constructor(){this.context=null}init(e,t){this.scaledCanvas=new x(e),this.scaledCanvas.init(),this.scaledCanvas.setImageSmoothing(!1),this.context=this.scaledCanvas.getContext(),this.setScene(t)}animate(){this.scaledCanvas.clearFrame();let e=this.getCanvas();this.scene.draw(e.getContext(),e),requestAnimationFrame(this.animate.bind(this))}setScene(e){this.scene=e}start(){this.animate()}getCanvas(){return this.scaledCanvas}}document.body.style.backgroundColor="black",document.addEventListener("DOMContentLoaded",(()=>{let e=document.getElementById("viewer"),t=new P,i=new b(e);t.init(e,i),i.init(t.scaledCanvas).then((()=>{t.start(),setInterval((()=>{i.update(1e3/60)}),Math.floor(1e3/60))}))}))})()})();