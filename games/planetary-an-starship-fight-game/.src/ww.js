(()=>{importScripts("shared.js");log;let e,t,r,n,o,i=[],l=[],s=[],a=[],f=1040,u=1200,I=1e-4,c=30,d=sqrt(98),v=(e,t)=>postMessage([e,t]);function y(e,t,r){e.ey+=t,e.ey<=0&&(r&&m(e,-.1),e.ey=0,e.fOn=e.re=0),e.ey>100&&(e.ey=100)}function m(e,t){e.life&&(e.life+=t,e.life<0&&h(e),e.life>100&&(e.life=100))}function h(e){x(e),e.velX=e.velY=e.roI=e.life=0,e.land=-1,e.reborn>0&&(setTimeout(()=>{let t=PI2*rnd();e.x=14e3*cos(t),e.y=14e3*sin(t)},6e3),setTimeout(()=>{e.life=e.ey=100,e.reborn--,e.misTot<3&&(e.misTot=3)},7e3))}function x(e){let t=mkID(),n=r[e.land];e={...e,id:t,radius:0,src:e.id||e.userID},n&&E(n,e),s.push(e),setTimeout(()=>s=s.filter(e=>e.id!=t),5e3)}function E(e,t){t.velX=-sin(e.a)*T(e.d),t.velY=+cos(e.a)*T(e.d)}v("started"),onmessage=({data:[t,u]})=>{if("init"==t){e=u.nP;let t=-9e4*rnd();r=u.planets.map(e=>{let r=T(e.d)/e.d;return{...e,aInc:r,roI:.001+.001*rnd(),a:e.a+r*t}}),n=[{a:0,d:0,radius:f},...r],Y(),setInterval(k,17),setInterval(()=>v("update",{players:i,planets:r,boxes:l,booms:s,missiles:a}),upDalay)}if("updadeUsers"==t&&(i=u,i.forEach(e=>i[e.userID]=e)),"startGame"==t){o=u;let e=(e,t,r)=>{let n=PI2/15;l.push({id:mkID(),x:cos(e*n)*t,y:sin(e*n)*t,velX:cos((e+5)*n)*r,velY:sin((e+5)*n)*r})};for(let t=0;t<15;t++)e(t,2e4,2);let t=0;setInterval(()=>{e(t++,22e3,1),15==t&&(t=0)},15e3)}let I=i[u[0]],c=u[1];"fOn"==t&&(I.fOn=c),"re"==t&&(I.re=c),"rotJet"==t&&(I.rotJet=0,c<0&&I.roI>-.1&&(I.rotJet=c),c>0&&I.roI<.1&&(I.rotJet=c)),"misOn"==t&&(I.misOn=c)};let X=Date.now();function Y(){if(o)return i.forEach(e=>e.fOn=0);setTimeout(Y,100);let t=(Date.now()-X)/9e4;i.forEach((r,n)=>{r.rot=t+n*(PI2/e),r.fOn=1,r.velX=2*cos(r.rot),r.velY=2*sin(r.rot),r.x=1e4*+sin(r.rot),r.y=1e4*-cos(r.rot),r.ey=100})}function P(e,t){let r=e.x-t.x,n=e.y-t.y,o=sqrt(r**2+n**2);return[o,-r/o,-n/o]}function p(e){return P(e,{x:0,y:0})}function D(e,t=1){return{x:cos(e)*t,y:sin(e)*t}}function b(e,t){if(e.land>-1)return;let[n,o,i]=p(e),l=144/n**1.5;e.velX+=l*o,e.velY+=l*i;for(let s,a=0;s=r[a];a++){if([n,o,i]=P(e,s),n<s.radius+c){if(!t)return 1;O(e,s,a,n,o,i)}l=s.radius**2.5*I/n**2,e.velX+=l*o,e.velY+=l*i}}function O(e,t,r,n,o,i){if(e.land=r,J(e.velX,e.velY)>d/2)h(e);else{let r=Math.acos(-o),l=Math.asin(-i);e.a=l>0?r:PI2-r;let s=t.radius+c-n;e.x+=-o*s,e.y+=-i*s}}function T(e){return sqrt(144/e**1.5*e)}function J(e,t){return sqrt(e**2+t**2)}function M(e){let t=e.velX+cos(e.rot)/50,r=e.velY+sin(e.rot)/50,n=J(e.velX,e.velY),o=J(t,r);o>n&&(o>d?(t/=o/d,r/=o/d):o>d/2&&(t=(t+e.velX)/2,r=(r+e.velY)/2)),e.velX=t,e.velY=r}function g(){return i.filter(e=>e.life)}let q=0;function k(){if(q++,t)return;let e=i.filter(e=>e.life||e.reborn);o&&1==e.length&&(t=e[0].userID,v("winner",t)),g().forEach(e=>{let t=p(e)[0];y(e,.05-t/4e5,!0),t<u&&m(e,(t-u)/200),b(e,!0),e.rotJet<0&&(e.roI>-.1?e.roI-=.001:e.rotJet=0),e.rotJet>0&&(e.roI<.1?e.roI+=.001:e.rotJet=0),-.001<e.roI&&e.roI<.001&&(e.roI=0),e.rot+=e.roI;let n=r[e.land];if(e.re&&(y(e,-.02),e.velX*=.99,e.velY*=.99,e.roI*=.94),e.fOn&&(y(e,-.05),n&&E(n,e),e.land=-1,M(e),e.roI*=.99),e.land>-1){m(e,.02);let{x:t,y:r}=D(e.a,n.radius+c);e.x=n.x+t,e.y=n.y+r,e.rot=e.a,e.a+=n.roI,e.roI=e.velX=e.velY=0}else e.x+=e.velX,e.y+=e.velY;if(e.misTot>0)if(e.misOn||0<e.misEn&&e.misEn<10)e.misEn<100&&(e.ey>.1?(e.ey-=.1,e.misEn+=.3):e.misEn>.01&&(e.misEn-=.01));else if(e.misEn){e.misTot--;let t={...e,id:mkID(),src:e.userID};a.push(t),n&&E(n,t),t.ey=e.misEn,t.velX+=2*cos(t.rot),t.velY+=2*sin(t.rot),e.misEn=0,t.id,e.userID}l.forEach(t=>{P(e,t)[0]<60&&(e.misTot+=2,l=l.filter(e=>e.id!=t.id))})}),r.forEach(e=>{e.a+=e.aInc,e.rot+=e.roI;let t=D(e.a,e.d);e.x=t.x,e.y=t.y}),s.forEach(e=>{e.x+=e.velX,e.y+=e.velY,e.radius++}),l.forEach(e=>{(b(e)||p(e)[0]<f)&&(x(e),l=l.filter(t=>t.id!=e.id)),e.x+=e.velX,e.y+=e.velY}),a.forEach(e=>{q%2&&function(e){let{x:t,y:r,velX:o,velY:i,rot:l}=e,[[s,a,f],u]=g().filter(t=>t.userID!=e.userID).map(t=>[P(e,t),t]).sort((e,t)=>e[0][0]-t[0][0])[0]||[[]];if(!u)return;let I=Math.atan2(i,o),c=Math.atan2(f,a),d=j(I,c),v=i/o,y=r-v*t,m=(u.x,u.y,e.rot+(d>0?.1:-.1)),h=abs(j(l,c));abs(d)<PI/2&&h<.5*PI&&(e.rot=m);let x=sin(-l)*a+cos(-l)*f<0;e.rot+=x?-.03:.03,n.forEach((t,r)=>{let[n,o,i]=P(e,t),l=Math.atan2(i,o),a=j(I,l);abs(a)<PI/2&&n<3e3&&n<s&&abs(v*t.x+y-t.y)<1.5*t.radius&&(e.rot=l-(a>0?PI:-PI)/2)}),s<90&&P({x:t+o,y:r+i},u)[0]>s&&w(e)}(e),p(e)[0]<f&&w(e),n.forEach(t=>{P(e,t)[0]<t.radius&&w(e)}),M(e),e.x+=e.velX,e.y+=e.velY,e.ey-=.02,e.ey<0&&w(e)})}function w(e){x(e),a=a.filter(t=>t.id!=e.id),g().forEach(t=>{let r=1-P(e,t)[0]/90;r>0&&(t.roI=rnd()<.5?-.15:.15,m(t,80*-r))})}function j(e,t){let r=(t-e+PI)%PI2-PI,n=-(e-t+PI)%PI2+PI;return abs(r)<abs(n)?r:n}})();
