for(var maze,player,w=window.innerWidth,h=window.innerHeight,difficulty=6,lastFrame=Date.now(),audioContext=new window.AudioContext,oscillators=[],gains=[],timeouts=[],i=0;i<4;i++)oscillators.push(audioContext.createOscillator()),gains.push(audioContext.createGain()),oscillators[i].connect(gains[i]),oscillators[i].start(),timeouts.push(null);function playWave(e){timeouts[i]&&(window.clearTimeout(timeouts[i]),timeouts[i]=null);var a=audioContext.currentTime;gains[e].gain.setValueAtTime(1,a),gains[e].gain.exponentialRampToValueAtTime(.001,a+.5),gains[e].connect(audioContext.destination),timeouts[i]=window.setTimeout(function(){gains[e].disconnect()},500)}function animate(){var e=Date.now();e-lastFrame>16&&(paintMaze(),lastFrame=e),window.requestAnimationFrame(animate)}function generateMaze(e,a){maze=[];for(var t=0;t<e.x;t++){maze.push([]);for(var o=0;o<e.y;o++)maze[t].push({x:-1,y:-1})}var l={x:Math.floor(Math.random()*e.x),y:Math.floor(Math.random()*e.y)};maze[l.x][l.y].control="goal";var r,n=l;for(t=0;t<a;t++)if(r={x:Math.floor(Math.random()*e.x),y:Math.floor(Math.random()*e.y)},maze[r.x][r.y].control)t--;else{var i=[];if(maze[r.x-1]&&maze[r.x-1][r.y]&&!maze[r.x-1][r.y].control&&i.push({x:r.x-1,y:r.y}),maze[r.x]&&maze[r.x][r.y-1]&&!maze[r.x][r.y-1].control&&i.push({x:r.x,y:r.y-1}),maze[r.x+1]&&maze[r.x+1][r.y]&&!maze[r.x+1][r.y].control&&i.push({x:r.x+1,y:r.y}),maze[r.x]&&maze[r.x][r.y+1]&&!maze[r.x][r.y+1].control&&i.push({x:r.x,y:r.y+1}),i.length>0){var y=Math.floor(Math.random()*i.length);maze[r.x][r.y].control="path",maze[r.x][r.y].x=n.x,maze[r.x][r.y].y=n.y,maze[i[y].x][i[y].y].control="path",maze[i[y].x][i[y].y].x=Math.floor(Math.random()*e.x),maze[i[y].x][i[y].y].y=Math.floor(Math.random()*e.y),n=i[y]}else t--}player=n;for(t=0;t<maze.length;t++)for(o=0;o<maze[0].length;o++)maze[t][o].control||(maze[t][o].x=Math.floor(Math.random()*e.x),maze[t][o].y=Math.floor(Math.random()*e.y),Math.random()<.3&&(maze[t][o].control="404"))}function paintSquare(e,a,t,o,l,r){e.beginPath(),e.moveTo(a+r,t+l/2),e.lineTo(a+o/2,t+r),e.lineTo(a+o-r,t+l/2),e.lineTo(a+o/2,t+l-r),e.lineTo(a+r,t+l/2),e.stroke()}function paintGoal(e,a,t,o,l,r){var n=Date.now()%767;n>=384&&(n=767-n),n=Math.floor(.67*n),e.fillStyle="rgba("+n+","+n+",0,0.5)",e.beginPath(),e.moveTo(a+6*r,t+l/2),e.lineTo(a+o/2,t+3*r),e.lineTo(a+o-6*r,t+l/2),e.lineTo(a+o/2,t+l-3*r),e.lineTo(a+6*r,t+l/2),e.fill()}function paintPlayer(e,a,t,o,l,r){var n=Date.now()%511;n>=256&&(n=511-n),e.fillStyle="rgba("+n+","+n+",0,0.5)",e.beginPath(),e.moveTo(a+r,t+.75*l),e.lineTo(a+o/2,t+l/2+r),e.lineTo(a+o-r,t+.75*l),e.lineTo(a+o/2,t+l-r),e.fill(),e.fillStyle="rgba("+n+",0,0,0.5)",e.moveTo(a+r,t+.75*l),e.lineTo(a+o/2,t+r),e.lineTo(a+o/2,t+l-r),e.fill(),e.fillStyle="rgba("+n+",0,"+n+",0.5)",e.moveTo(a+o-r,t+.75*l),e.lineTo(a+o/2,t+r),e.lineTo(a+o/2,t+l-r),e.fill(),e.fillStyle=lg}function paintPrep(e){w/(2*(maze.length+maze[0].length+2))>h/(maze.length+maze[0].length+2)?(step=h/(maze.length+maze[0].length+2),x_pad=(w-2*(maze.length+maze[0].length+2)*step)/2,y_pad=0):(step=w/(2*(maze.length+maze[0].length+2)),x_pad=0,y_pad=(h-(maze.length+maze[0].length+2)*step)/2),border=step/10,g=e.getContext("2d"),g.font=1.5*step+"px sans-serif",g.textAlign="center",g.textBaseline="middle",g.lineWidth=border,lg=g.createLinearGradient(x_pad,y_pad,w-x_pad,h-y_pad),lg.addColorStop(0,"#FFFFFF"),lg.addColorStop(.05,"#FFFF00"),lg.addColorStop(.11,"#00FF00"),lg.addColorStop(.16,"#00FFFF"),lg.addColorStop(.22,"#0000FF"),lg.addColorStop(.27,"#606060"),lg.addColorStop(.33,"#FFFFFF"),lg.addColorStop(.38,"#FFFF00"),lg.addColorStop(.44,"#00FF00"),lg.addColorStop(.49,"#00FFFF"),lg.addColorStop(.55,"#0000FF"),lg.addColorStop(.6,"#606060"),lg.addColorStop(.66,"#FFFFFF"),lg.addColorStop(.71,"#FFFF00"),lg.addColorStop(.77,"#00FF00"),lg.addColorStop(.82,"#00FFFF"),lg.addColorStop(.88,"#0000FF"),lg.addColorStop(.93,"#606060"),lg.addColorStop(.99,"#FFFFFF"),g.strokeStyle=lg,g.fillStyle=lg}function paintMaze(){var e,a;g.clearRect(0,0,w,h);for(var t=0;t<maze.length;t++)e=(2.3+2*t)*step+x_pad,a=(3.4+t+maze[0].length)*step+y_pad,g.fillText(t,e,a);e=x_pad+.25*step;for(var o=0;o<maze[0].length;o++)e=(2.1+2*o)*step+x_pad,a=(maze[0].length-o+1.1)*step+y_pad,g.fillText(o,e,a);for(t=0;t<maze.length;t++)for(o=0;o<maze[0].length;o++)e=(2.1+2*t+2*o)*step+x_pad,a=(1.1+t+(maze[0].length-o))*step+y_pad,"goal"===maze[t][o].control?(g.lineWidth=2*border,g.strokeStyle="#FFFF00",g.fillStyle="#FFFF00",paintSquare(g,e,a,4*step,2*step,border),g.lineWidth=border,paintGoal(g,e,a,4*step,2*step,border),g.fillStyle=lg,g.strokeStyle=lg):"BL"===maze[t][o].control?(g.strokeStyle="#2F2F2F",g.fillStyle="#2F2F2F",paintSquare(g,e,a,4*step,2*step,border),g.fillText(404,e+2*step,a+1.1*step),g.fillStyle=lg,g.strokeStyle=lg):(paintSquare(g,e,a,4*step,2*step,border),g.fillText(maze[t][o].x+""+maze[t][o].y,e+2*step,a+1.1*step));e=(2.1+2*player.x+2*player.y)*step+x_pad,a=(1.1+player.x+(maze[0].length-player.y))*step+y_pad,paintPlayer(g,e,a-2*step,4*step,4*step,border)}function restart(){window.setTimeout(function(){generateMaze({x:difficulty,y:difficulty},difficulty)},500)}function keyup(e){audioContext.resume();var a=!1;if(65===e.keyCode||37===e.keyCode?maze[player.x][player.y-1]&&("404"===maze[player.x][player.y-1].control||"BL"===maze[player.x][player.y-1].control?(maze[player.x][player.y-1].control="BL",playWave(3)):(player.y-=1,a=!0)):68===e.keyCode||39===e.keyCode?maze[player.x][player.y+1]&&("404"===maze[player.x][player.y+1].control||"BL"===maze[player.x][player.y+1].control?(maze[player.x][player.y+1].control="BL",playWave(3)):(player.y+=1,a=!0)):87===e.keyCode||38===e.keyCode?maze[player.x-1]&&("404"===maze[player.x-1][player.y].control||"BL"===maze[player.x-1][player.y].control?(maze[player.x-1][player.y].control="BL",playWave(3)):(player.x-=1,a=!0)):83===e.keyCode||40===e.keyCode?maze[player.x+1]&&("404"===maze[player.x+1][player.y].control||"BL"===maze[player.x+1][player.y].control?(maze[player.x+1][player.y].control="BL",playWave(3)):(player.x+=1,a=!0)):82===e.keyCode?(playWave(0),restart()):(e.keyCode>=51&&e.keyCode<=57||e.keyCode>=99&&e.keyCode<=105)&&(difficulty=e.keyCode%48,playWave(0),window.setTimeout(function(){generateMaze({x:difficulty,y:difficulty},difficulty),paintPrep(canvas)},500)),a){var t;if("goal"===(t=maze[player.x][player.y]).control)return playWave(1),void restart();if(player.x=t.x,player.y=t.y,"goal"===(t=maze[player.x][player.y]).control)return playWave(1),void restart();playWave(2)}}function resize(){w=window.innerWidth,h=window.innerHeight,canvas.width=w,canvas.height=h,paintPrep(canvas)}oscillators[0].type="sine",oscillators[1].type="square",oscillators[2].type="triangle",oscillators[3].type="sawtooth",window.onload=function(){canvas=document.getElementById("MVLM_canvas"),canvas.width=w,canvas.height=h,generateMaze({x:difficulty,y:difficulty},difficulty),paintPrep(canvas),document.onkeyup=keyup,window.onresize=resize,window.requestAnimationFrame(animate)};
