var e={A:[[,1],[1,,1],[1,,1],[1,1,1],[1,,1]],B:[[1,1],[1,,1],[1,1,1],[1,,1],[1,1]],C:[[1,1,1],[1],[1],[1],[1,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1,1],[1,,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[1,1,1],[,,1],[,,1],[1,,1],[1,1,1]],K:[[1,,,1],[1,,1],[1,1],[1,,1],[1,,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,1,1,1,1],[1,,1,,1],[1,,1,,1],[1,,,,1],[1,,,,1]],N:[[1,,,1],[1,1,,1],[1,,1,1],[1,,,1],[1,,,1]],O:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],P:[[1,1,1],[1,,1],[1,1,1],[1],[1]],Q:[[0,1,1],[1,,,1],[1,,,1],[1,,1,1],[1,1,1,1]],R:[[1,1],[1,,1],[1,,1],[1,1],[1,,1]],S:[[1,1,1],[1],[1,1,1],[,,1],[1,1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[1,1,1]],V:[[1,,,,1],[1,,,,1],[,1,,1],[,1,,1],[,,1]],W:[[1,,,,1],[1,,,,1],[1,,,,1],[1,,1,,1],[1,1,1,1,1]],X:[[1,,,,1],[,1,,1],[,,1],[,1,,1],[1,,,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1,1,1],[,,,1],[,,1],[,1],[1,1,1,1,1]],0:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],1:[[0,1,0],[1,1,0],[0,1,0],[0,1,0],[1,1,1]],2:[[1,1,1],[0,0,1],[1,1,1],[1,0,0],[1,1,1]],3:[[1,1,1],[0,0,1],[1,1,1],[0,0,1],[1,1,1]],4:[[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1]],5:[[1,1,1],[1,0,0],[1,1,1],[0,0,1],[1,1,1]],6:[[1,1,1],[1,0,0],[1,1,1],[1,0,1],[1,1,1]],7:[[1,1,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],8:[[1,1,1],[1,0,1],[1,1,1],[1,0,1],[1,1,1]],9:[[1,1,1],[1,0,1],[1,1,1],[0,0,1],[1,1,1]]," ":[[,,],[,,],[,,],[,,],[,,]],".":[[,,],[,,],[,,],[,,],[0,1,0]],"<":[[0,0,1],[0,1,0],[1,0,0],[0,1,0],[0,0,1]],0:[[1,1,1],[1,0,1],[1,0,1],[1,0,1],[1,1,1]],2:[[1,1,1],[0,0,1],[0,1,1],[1,0,0],[1,1,1]],3:[[1,1,1],[0,0,1],[1,1,0],[0,0,1],[1,1,1]]};let t=451;function n(e){e.imageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1}function l(e,t,i={}){i.appendDOM=null!=i.appendDOM&&i.appendDOM;let n=document.createElement("canvas");return n.width=e,n.height=t,i.appendDOM&&document.body.appendChild(n),n}function r(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function s(e,t,i){return"#"+((1<<24)+(e<<16)+(t<<8)+i).toString(16).slice(1)}function a(e,t,i){let n=t.getImageData(0,0,e.w,e.h),l=n.data;for(let e=0;e<l.length;e+=4)for(let t=0;t<i.length;t++){let n=i[t],s=r(n[0]),a=r(n[1]);l[e]==s.r&&l[e+1]==s.g&&l[e+2]==s.b&&(l[e]=a.r,l[e+1]=a.g,l[e+2]=a.b)}t.putImageData(n,0,0)}function h(e,t){for(var i=0,n=Number.MAX_VALUE,l=0;l<t.length;l++){var s=r(e),a=r(t[l]),h=0;h+=(s.r-a.r)*(s.r-a.r),h+=(s.g-a.g)*(s.g-a.g),(h+=(s.b-a.b)*(s.b-a.b))<n&&(i=l,n=h)}return i}function o(e,t,i){for(var n=0,l=e.length,a=0;a<l;a+=4){if(e[a+3]>0){var o=r(t[h(s(e[a],e[a+1],e[a+2]),t)]);e[a]==o.r&&e[a+1]==o&&e[a+2]==o.b||(e[a]=o.r,e[a+1]=o.g,e[a+2]=o.b,i||(e[a+3]=255),n++)}}return{data:e,amountReplaces:n}}function d(e,t,i,n){var l=e-i,r=t-n;return Math.hypot(l,r)}function g(e){return e*Math.PI/180}function y(t,i,n,l,r,s="#fff"){var a=[];l=l.toUpperCase();for(var h=0;h<l.length;h++){var o=e[l.charAt(h)];o&&a.push(o)}t.fillStyle=s;var d=i;for(h=0;h<a.length;h++){o=a[h];for(var g=n,y=0,m=0;m<o.length;m++){for(var p=o[m],f=0;f<p.length;f++)p[f]&&t.fillRect(d+f*r,g,r,r);y=Math.max(y,p.length*r),g+=r}d+=r+y}}function m(e,t,i){for(let n=0;n<1;n++)e.beginPath(),e.moveTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y),e.lineTo(t[2].x,t[2].y),e.closePath(),e.fillStyle=i,e.fill()}function p(e,t,i,n,l,r=null,s=null,a=1){for(let h=0;h<1;h++)e.beginPath(),e.ellipse(t,i,n,l,0,0,2*Math.PI,!1),null!=r&&(e.fillStyle=r,e.fill()),null!=s&&(e.strokeStyle=s,e.lineWidth=a,e.stroke())}function f(e,t,i,n,l=null,r=null,s=1){for(let a=0;a<1;a++)p(e,t,i,n,n,l,r,s)}function c(e,t,i,n,l,r=null,s=null,a=1){for(let h=0;h<1;h++)null!=r&&(e.fillStyle=r,e.fillRect(t,i,n,l)),null!=s&&(e.strokeStyle=s,e.lineWidth=a,e.strokeRect(0,0,n,l))}function x(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function w(e,t){return Math.random()*(t-e)+e}let _=function(){let e={};function t(e,t,i){this.x=e,this.y=t,this.z=i}t.prototype.dot2=function(e,t){return this.x*e+this.y*t},g3=[new t(1,1,0),new t(-1,1,0),new t(1,-1,0),new t(-1,-1,0),new t(1,0,1),new t(-1,0,1),new t(1,0,-1),new t(-1,0,-1),new t(0,1,1),new t(0,-1,1),new t(0,1,-1),new t(0,-1,-1)];let n=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];function l(e){return e*e*e*(e*(6*e-15)+10)}function r(e,t,i){return(1-i)*e+i*t}return perm=new Array(512),gP=new Array(512),e.seed=function(e){for(e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8),i=0;i<256;i++)v=0,1&i?v=n[i]^255&e:v=n[i]^e>>8&255,perm[i]=perm[i+256]=v,gP[i]=gP[i+256]=g3[v%12]},e.seed(0),e.perlin2=function(e,t){return X=Math.floor(e),Y=Math.floor(t),e-=X,t-=Y,X&=255,Y&=255,n00=gP[X+perm[Y]].dot2(e,t),n01=gP[X+perm[Y+1]].dot2(e,t-1),n10=gP[X+1+perm[Y]].dot2(e-1,t),n11=gP[X+1+perm[Y+1]].dot2(e-1,t-1),u=l(e),r(r(n00,n10,u),r(n01,n11,u),l(t))},e}();function b(e){return e instanceof Object&&e.constructor===Object}function R(e,t,i){return e<t?t:e>i?i:e}function D(e){return e.x<-64||e.x>288||e.y<-64||e.y>352}function T(e,t){e.origin=null!=e.origin?e.origin:{x:0,y:0},t.origin=null!=t.origin?t.origin:{x:0,y:0};let i=e.x-e.origin.x,n=e.y-e.origin.y,l=t.x-t.origin.x,r=t.y-t.origin.y;return i<l+t.dw&&i+e.dw>l&&n<r+t.dh&&n+e.dh>r}function S(e,t){-1!=e.hp&&(e.hp-t.power>0?(e.hp-=t.power,e.showHit=!0):(e.hp>0&&e.onDestroy&&e.onDestroy(),e.hp=0,e.destr=!0))}function G(e,t){return[Math.atan2(e[1]-t[1],e[0]-t[0]),(e[0]-t[0])**2+(e[1]-t[1])**2]}function k(e){let t=[e.reduce((e,t)=>e+t[0],0)/e.length,e.reduce((e,t)=>e+t[1],0)/e.length];for(let i of e)i.push(...G(i,t));e.sort((e,t)=>e[2]-t[2]||e[3]-t[3]);for(let t of e)t.length-=2}function M(e,t,i,n){e.fillStyle=n,e.fillRect(t,i,1,1)}function I(e){console.log("starting dyntex",e);let t=l(e.w,e.h,{appendDOM:!0}),i=t.getContext("2d");n(i),null!=e.bg&&(i.fillStyle=e.bg,i.fillRect(0,0,t.width,t.height)),e.render&&(console.log("rendering..."),e.render(i));let r=[];for(const t in e.hues)r.push(e.hues[t]);console.log(r);let s=o(i.getImageData(0,0,t.width,t.height).data,r,!1);console.log("RECOLOR",s);var h=new ImageData(s.data,t.width,t.height);return i.putImageData(h,0,0),e.palshift&&(console.log("palshifting..."),a(e,i,e.palshift)),console.log("finished dyntex"),{canv:t}}_.seed(t);class C{constructor(e){if(this.type=e.type,this.depth=null!=e.depth?e.depth:0,this.plyr=e.plyr,this.img=e.img,this.x=e.x,this.y=e.y,this.canCull=null==e.canCull||e.canCull,this.perceivedHeight=null!=e.perceivedHeight?e.perceivedHeight:32,this.frame=e.frame,this.showHitDelay=10,this.showHitTick=0,this.showHit=!1,this.imgs=e.imgs,this.vis=!0,this.isPlaying=null!=this.img&&!!this.img.anim,this.animDelay=e.animDelay,this.animTick=e.animTick,this.scaleX=null!=e.scaleX?e.scaleX:1,this.scaleY=null!=e.scaleY?e.scaleY:1,null!=e.scale&&(this.scaleX=e.scale,this.scaleY=e.scale),this.angle=0,this.groundProj=null!=e.groundProj&&e.groundProj,this.speed=e.speed,this.velX=null!=e.velX?e.velX:0,this.velY=null!=e.velY?e.velY:0,this.points=void 0!==e.points?e.points:0,this.life=null!=e.life?e.life:-1,this.hpInit=null!=e.hp?e.hp:-1,this.hp=this.hpInit,this.power=null!=e.power?e.power:0,this.isFriendly=null==e.isFriendly||e.isFriendly,this.destr=!1,this.w=0,this.h=0,this.dyntex=null,null!=this.img){if(null!=this.img.dynrender){if(this.img.dynrender&&(this.dyntex=this.img.dyntexes[x(0,this.img.dyntexes.length-1)],this.w=this.dyntex.canv.width,this.h=this.dyntex.canv.height,this.dyntex.shadCanv=null,null!=this.img.dynrender.hs&&this.img.dynrender.hs)){this.dyntex.shadCanv=l(this.img.dynrender.w,this.img.dynrender.h);let e=this.dyntex.shadCanv.getContext("2d"),t=this.dyntex.canv.getContext("2d").getImageData(0,0,this.img.dynrender.w,this.img.dynrender.h),i=t.data;for(let e=0;e<i.length;e+=4){i[e+3]>0&&(i[e]=0,i[e+1]=0,i[e+2]=0)}e.putImageData(t,0,0)}}else this.w=this.img.el.width,this.h=this.img.el.height;this.img.anim&&(this.w=this.img.fw,this.h=this.img.fh)}this.dw=this.w*this.scaleX,this.dh=this.h*this.scaleY,this.origin=null!=e.origin?e.origin:{x:0,y:0},this.shadow=null,null!=this.dyntex&&null!=this.dyntex.shadCanv&&(this.shadow=W({img:{fw:this.img.fw,fh:this.img.fh,anim:this.img.anim,el:this.dyntex.shadCanv},x:this.x,y:this.y,animTick:this.animTick,animDelay:this.animDelay,origin:{x:this.w/2,y:this.h/2},scaleX:.4*this.scaleX,scaleY:.4*this.scaleY}))}baseUpdate(){this.x+=this.velX,this.y+=this.velY,this.perceivedHeight<0&&(this.perceivedHeight=0),null!=this.shadow&&(this.shadow.x=this.x,this.shadow.y=this.y-1.5*this.perceivedHeight,this.shadow.angle=this.angle),this.showHit&&(this.showHitTick<this.showHitDelay?this.showHitTick++:(this.vis=!0,this.showHit=!1,this.showHitTick=0)),-1!=this.life&&(this.life>0?this.life--:this.destr=!0)}update(){this.baseUpdate()}baseRender(e){if(this.baseUpdate(),this.shadow&&this.shadow.update(),this.update&&this.update(),this.showHit&&(this.vis=!1),this.vis&&(this.shadow&&this.shadow.render(e),this.img)){e.translate(Math.round(this.x),Math.round(this.y)),e.scale(this.scaleX,this.scaleY),e.rotate(g(this.angle));let t=this.img.el;null!=this.img.dynrender&&this.img.dynrender&&(t=this.dyntex.canv),this.img.anim?(this.isPlaying&&(this.animTick<this.animDelay?this.animTick++:(this.frame<this.img.frames-1?this.frame++:this.frame=0,this.animTick=0)),e.drawImage(t,this.frame*this.img.fw,0,this.img.fw,this.img.fh,-this.origin.x,-this.origin.y,this.w,this.h)):e.drawImage(t,-this.origin.x,-this.origin.y,this.w,this.h),e.setTransform(1,0,0,1,0,0)}}render(e){this.baseRender(e)}}class L extends C{constructor(e){super(e),e.type="player"}}class P extends C{constructor(e){super(e)}}class E extends C{constructor(e){super(e),this.origin={x:8,y:8},this.hasCharged=!1}update(){this.angle+=10,this.y>this.plyr.y-64&&(this.velY=3,this.hasCharged||(this.x<this.plyr.x?this.velX=5:this.x>this.plyr.x&&(this.velX=-5),this.hasCharged=!0))}}class H extends C{constructor(e){super(e),this.maxChaseSpeed=3,this.chaseSpeed=.5}update(){if(d(this.x,this.y,this.plyr.x,this.plyr.y)<128){this.isPlaying=!0,this.chaseSpeed<this.maxChaseSpeed&&(this.chaseSpeed+=.01);let e=this.plyr.x-this.x,t=this.plyr.y-this.y,i=Math.atan2(t,e),n=this.chaseSpeed*Math.cos(i),l=this.chaseSpeed*Math.sin(i);this.velX<n?this.velX+=.05:this.velX-=.05,this.velY<l?this.velY+=.05:this.velY-=.05}}}class K extends C{constructor(e){super(e),this.canShoot=!0}}class O extends C{constructor(e){super(e),this.buildings=[]}}class A extends C{constructor(e){super(e),this.state="move_forward",this.canSpawnGun=!1,this.hasSpawnedGun=!1,this.buildings=[]}update(){switch(this.state){case"move_forward":this.y<72?this.velY=.15:(this.velY=0,this.canSpawnGun=!0)}}}function W(e){return new C(e)}window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("c");e.width=224,e.height=288,console.log("test",e);let t=e.getContext("2d");n(t);let i=l(224,96);i.id="ctrl";let r=i.getContext("2d");n(t);let s=null,a=null,h=10,o=0,g=0,p=[451,981,463,928,126,521],u=[],b=[],v=[],Y=[],G=null,k=null,C=null,N=null,X=0,B=3,j=B,U=3,F=3,J=1,z=U,V=z,q=0,Q=10,Z=1,$=Z,ee=0,te=30,ie=!1,ne=0,le={x:x(0,e.width),y:x(128,200)},re=!1,se=10,ae=!1,he=10,oe=[],de=[],ge=!0,ye=!1,me=!1,pe=0,fe=0,ce=0,ue=["PLAY","HIGH SCORES"],xe=0,we=["BACK","CLEAR SCORES"],_e=0,be=["BACK","CLEAR SCORES"],ve=0,Ye={pu_fireball:{life:300,callbacks:{pickup:()=>{z=F}}},pu_missile:{life:200,callbacks:{pickup:()=>{z=J}}}},Re={},De={W:"KeyW",S:"KeyS",A:"KeyA",D:"KeyD",PFIRE:"Space",SFIRE:"ShiftLeft"};function Te(e){b.length=0,v.length=0,Y.length=0,G=null,k=null,C=null,N=null,X=0,B=3,F=1,J=1,V=z=U=3,q=0,Q=10,$=Z=1,ee=0,te=30,ie=!1,ne=0,oe.length=0,de.length=0,pe=0,ce=0,xe=0;for(let e=0;e<u.length;e++)clearTimeout(u[e]),u.splice(e,1),e--;switch(Se(),e.type){case"soft":ye=!1,me=!1;break;case"hard":fe=0,j=B,o=0,ge=!0,ye=!1,me=!1}}function Se(){for(let e=0;e<14;e++)for(let t=-1;t<18;t++)ke(e,t,e,t);(G=new L({x:.5*e.width,y:.5*e.height,origin:{x:8,y:8},img:a.plyr,hp:1,animDelay:7})).onDestroy=(()=>{if(1==g){let e=JSON.parse(localStorage.getItem("stella_proelium"));if((e=null!=e&&null!=e?e:{}).highscores=null!=e.highscores?e.highscores:[],e.highscores.push(X),e.highscores.sort((e,t)=>t-e),localStorage.setItem("stella_proelium",JSON.stringify(e)),j>0){j--;let e=setTimeout(function(){Te({type:"soft"})}.bind(this),3e3);u.push(e)}else{let e=setTimeout(function(){g=0,Te({type:"very hard"})}.bind(this),3e3);u.push(e)}}else{let e=setTimeout(function(){Te({type:"soft"})}.bind(this),3e3);u.push(e)}}),(k=W({x:G.x,y:G.y-48,origin:{x:8,y:8},frame:0,img:a.crosshair})).isPlaying=!1,C=W({x:16,y:e.height-40,img:a.pslot})}function Ge(){if(ie&&(ne>0?ne--:(delete N,N=null,z=U,ie=!1)),1==re&&(se>0?se--:(re=!1,se=x(10,60))),1==ae&&(he>0?he--:(ae=!1,he=10)),G.hp>0){let t=2;if(1==g){let e=((Re[De.A]?-1:0)+(Re[De.D]?1:0))*t,i=((Re[De.W]?-1:0)+(Re[De.S]?1:0))*t;G.x+=e,G.y+=i}if(G.x=R(G.x,0,e.width-8),G.y=R(G.y,0,e.height-8),k.x=G.x,k.y=G.y-48,1!=g){let t=le.x-G.x,i=le.y-G.y,n=Math.atan2(i,t);G.velX=.5*Math.cos(n),G.velY=.5*Math.sin(n),d(G.x,G.y,le.x,le.y)<8&&(le={x:x(0,e.width-16),y:x(128,200)})}if(V>0&&(Re[De.PFIRE]||re)&&q>=Q){let e=!0;if(null!=N&&"pu_fireball"==N.img.name){for(let e=-1;e<=1;e++){let t=1.5*e,i=W({img:a.fireball,x:G.x-8,y:G.y,velX:t,velY:-2,power:3,animTick:0,animDelay:15});de.push(i)}V-=3,e=!1}if(e){let e=W({img:a.plzr,x:G.x-2,y:G.y,scale:2,velY:-3,power:1});de.push(e),V--}q=0}if(q++,$>0&&(Re[De.SFIRE]||ae)&&ee>=te){let e=W({img:a.bomb,x:G.x-2,y:G.y,scale:2,velY:-.75,groundProj:!0,power:1});de.push(e),$--,ee=0}ee++}else k.vis=!1;if(k.frame=$>0?0:1,pe%64==0){for(let e=0;e<14;e++)ke(e,-2,e,fe);h-=.1,--fe<-100&&0==o&&(o=1),fe<-200&&1==o&&(o=2),fe<-210&&2==o&&(ge=!1,ye=!0),console.log(ye,me,fe)}if(ge){let t=120;if(1==o?t+=100:2==o&&(t+=200),pe%t==0){let t=x(0,e.width-16),i=0==o?"drone":"drone_armored",n="drone"==i?1:3;for(let e=0;e<x(1,3);e++){let e=new H({plyr:G,type:i,x:t+x(-8,8),y:-32-x(-8,8),img:a[i],frame:0,hp:n,power:1,points:10});e.isPlaying=!1,e.velY=x(.5,1),e.velX=w(-.5,.5),oe.push(e)}}if(fe<-30&&pe%300==0){let t=new E({plyr:G,type:"spinner",x:x(0,e.width),y:-32,img:a.spinner,hp:1,power:1,points:50});t.angle+=1,t.velY=x(1.5,3),oe.push(t)}}if(ye&&!me){switch(o){case 2:{let t=new A({plyr:G,type:"big_baddie",x:e.width/2,y:-144,origin:{x:56,y:72},img:a.big_baddie,hp:300,power:1,points:5e3,canCull:!1});t.onDestroy=(()=>{let e=JSON.parse(localStorage.getItem("stella_proelium"));(e=null!=e&&null!=e?e:{}).highscores=null!=e.highscores?e.highscores:[],e.highscores.push(X),e.highscores.sort((e,t)=>t-e),localStorage.setItem("stella_proelium",JSON.stringify(e)),g=0,Te({type:"hard"})}),oe.push(t);break}}ye=!1,me=!0}for(let e=0;e<b.length;e++)b[e].y+=.25;(ce+=.25)%.25==1&&(ce=0),pe++}function ke(e,t,i,n){_.seed(p[o]);let l=_.perlin2(i/h,n/h);switch(o){case 0:{let i=0;l<-.01&&l>-.15?i=1:l<=-.15&&l>-.35?i=2:l<=-.3&&(i=3);let n=null;if(l>-.4?(n=W({img:a.gpl,x:16*e,y:16*t,frame:i})).isPlaying=!1:(n=W({img:a.water,x:16*e,y:16*t,frame:i,animTick:x(0,60),animDelay:120})).isPlaying=!0,b.push(n),l<=-(.15+2e-6*fe)&&l>=-.151&&ge)if(x(0,100)>50){gaa=new K({plyr:G,type:"gaa",x:16*e,y:16*t,img:a.gaa,animTick:0,animDelay:7,depth:1,hp:1,points:75}),b.push(gaa);for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++)if(0!=i&&0!=n){let l=W({plyr:G,type:"garmor",x:16*e+16*i,y:16*t+16*n,img:a.garmor,depth:1,hp:1,points:150});b.push(l)}}else{let i=new O({plyr:G,type:"gaa_large_hub",x:e,y:t,img:a.gaa_large_hub,animTick:0,animDelay:7,depth:0});b.push(i);let n=W({plyr:G,type:"gaa_large_dome",x:e+16,y:t+16,img:a.gaa_large_dome,depth:1,hp:1,points:1e3});n.onDestroy=(()=>{i.buildings.forEach(e=>{let t=W({img:a.crater,x:e.x,y:e.y,frame:x(0,3),animTick:0,animDelay:30});b.push(t);for(let t=0;t<100;t++){let t=["smoke","fire"],i=W({img:a[t[x(0,t.length-1)]],x:e.x+x(4,12),y:e.y+x(4,12),life:x(300,600)});v.push(i)}e.destr=!0})}),i.buildings.push(n),b.push(n);for(let n=-2;n<=2;n++)for(let l=-2;l<=2;l++)if((0==n&&0!=l||0==l&&0!=n)&&-1!=n&&1!=n&&-1!=l&&1!=l){let r=new K({plyr:G,type:"gaa",x:e+16+16*n,y:t+16+16*l,img:a.gaa,animTick:0,animDelay:3,depth:1,hp:1,points:75});i.buildings.push(r),b.push(r)}}break}case 1:{let i=0;l<-.01&&l>-.15?i=1:l<=-.15&&l>-.35?i=2:l<=-.3&&(i=3);let n=null;if(l>-.4?(n=W({img:a.molt,x:16*e,y:16*t,frame:i})).isPlaying=!1:n=W({img:a.lava,x:16*e,y:16*t,frame:i,animTick:x(0,96),animDelay:96}),b.push(n),l<=-(.15+2e-6*fe)&&l>=-.151&&ge)if(x(0,100)>50){gaa=new K({plyr:G,type:"gaa_armored",x:16*e,y:16*t,img:a.gaa_armored,animTick:0,animDelay:7,depth:1,hp:1,points:75}),b.push(gaa);for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++)if(0!=i&&0!=n){let l=W({plyr:G,type:"garmor_strong",x:16*e+16*i,y:16*t+16*n,img:a.garmor_strong,depth:1,hp:1,points:150});b.push(l)}}else{let i=new O({plyr:G,type:"gaa_large_hub_armored",x:e,y:t,img:a.gaa_large_hub_armored,animTick:0,animDelay:7,depth:0,hp:2});b.push(i);let n=W({plyr:G,type:"gaa_large_dome",x:e+16,y:t+16,img:a.gaa_large_dome,depth:1,hp:1,points:1e3});n.onDestroy=(()=>{i.buildings.forEach(e=>{let t=W({img:a.crater,x:e.x,y:e.y,frame:x(0,3),animTick:0,animDelay:30});b.push(t);for(let t=0;t<100;t++){let t=["smoke","fire"],i=W({img:a[t[x(0,t.length-1)]],x:e.x+x(4,12),y:e.y+x(4,12),life:x(300,600)});v.push(i)}e.destr=!0})}),i.buildings.push(n),b.push(n);for(let n=-2;n<=2;n++)for(let l=-2;l<=2;l++)if((0==n&&0!=l||0==l&&0!=n)&&-1!=n&&1!=n&&-1!=l&&1!=l){let r=new K({plyr:G,type:"gaa_armored",x:e+16+16*n,y:t+16+16*l,img:a.gaa_armored,animTick:0,animDelay:3,depth:1,hp:1,points:75});i.buildings.push(r),b.push(r)}}break}case 2:{let i=x(0,3),n=W({img:a.stars,x:16*e,y:16*t,frame:i,animTick:x(0,500),animDelay:500});n.isPlaying=!0,b.push(n);break}}}function Me(){Ge(),function(){t.clearRect(0,0,e.width,e.height),c(t,0,0,e.width,e.height,s.RD);for(let e=0;e<b.length;e++){let i=b[e];0==i.depth&&i.render(t)}for(let e=0;e<b.length;e++){let i=b[e];if(1==i.depth){if(("gaa"==i.type||"gaa_armored"==i.type)&&(0==i.frame&&(i.canShoot=!0),2==i.frame&&i.canShoot)){let e=W({img:a.gaa_bullet,x:i.x+8,y:i.y+8,animTick:0,animDelay:10,isFriendly:!1,power:1}),t=G.x-e.x,n=G.y-e.y,l=Math.atan2(n,t);e.velX=.5*Math.cos(l),e.velY=.5*Math.sin(l),de.push(e),i.canShoot=!1}i.render(t)}D(i)&&(i.destr=!0),i.destr&&(b.splice(e,1),e--)}for(let e=0;e<v.length;e++){let i=v[e];i.render(t),i.y-=i.speed,D(i)&&(i.destr=!0),i.destr&&(v.splice(e,1),e--)}for(let e=0;e<de.length;e++){let i=de[e];if(i.render(t),"bomb"==i.img.name)if(i.scaleX>.3)i.scaleX-=.03,i.scaleY-=.03,i.perceivedHeight-=1,i.x+=.006,i.velY+=.01;else{let e=[];for(let t=0;t<b.length;t++){let n=b[t],l={x:i.x-6,y:i.y-6,dw:12,dh:12};"stars"!=n.img.name&&T(l,n)&&1==n.depth&&(e.push(n),S(n,i),n.destr&&(X+=n.points))}for(let t=0;t<e.length;t++){let i=e[t],n=W({img:a.crater,x:i.x,y:i.y,frame:x(0,3),animTick:0,animDelay:30});b.push(n);for(let e=0;e<100;e++){let e=["smoke","fire"],t=W({img:a[e[x(0,e.length-1)]],x:i.x+x(4,12),y:i.y+x(4,12),life:x(300,600)});v.push(t)}}i.destr=!0}D(i)&&(i.destr=!0),i.destr&&("plzr"!=i.img.name&&"fireball"!=i.img.name||V++,"bomb"==i.img.name&&$++,de.splice(e,1),e--)}for(let n=0;n<Y.length;n++){let l=Y[n];l.render(t),T(G,l)&&(i=l.img.name,console.log("changing item to "+i),null!=Ye[i].callbacks&&null!=Ye[i].callbacks.pickup&&Ye[i].callbacks.pickup(),N=W({img:a[i],x:16,y:e.height-40,scale:1.5}),ie=!0,null!=Ye[i].life&&(ne=Ye[i].life),l.destr=!0),D(l)&&(l.destr=!0),l.destr&&(Y.splice(n,1),n--)}var i;k.render(t),G.render(t);for(let e=0;e<oe.length;e++){let i=oe[e];if(i.render(t),("gaa"==i.type||"gaa_armored"==i.type)&&(0==i.frame&&(i.canShoot=!0),2==i.frame&&i.canShoot)){let e=W({img:a.gaa_bullet,x:i.x+8,y:i.y+8,animTick:0,animDelay:10,isFriendly:!1,power:1}),t=G.x-e.x,n=G.y-e.y,l=Math.atan2(n,t);e.velX=.5*Math.cos(l),e.velY=.5*Math.sin(l),de.push(e),i.canShoot=!1}if("big_baddie"==i.type&&i.canSpawnGun&&!i.hasSpawnedGun){let e=i.x-24,t=i.y-24,n=new O({plyr:G,type:"gaa_large_hub_armored",x:e,y:t,img:a.gaa_large_hub_armored,animTick:0,animDelay:7,depth:0,hp:9999});oe.push(n);for(let i=-2;i<=2;i++)for(let l=-2;l<=2;l++)if((0==i&&0!=l||0==l&&0!=i)&&-1!=i&&1!=i&&-1!=l&&1!=l){let r=new K({plyr:G,type:"gaa_armored",x:e+16+16*i,y:t+16+16*l,img:a.gaa_armored,animTick:0,animDelay:3,depth:1,hp:9999,points:75});n.buildings.push(r),oe.push(r)}i.canSpawnGun=!1,i.hasSpawnedGun=!0}i.canCull&&D(i)&&(i.destr=!0);for(let e=0;e<de.length;e++){let t=de[e];if(t.isFriendly&&!t.groundProj&&T(t,i)){S(i,t);for(let e=0;e<50;e++){let e=["smoke","fire"],t=W({img:a[e[x(0,e.length-1)]],x:i.x+x(0,8),y:i.y+x(0,8),life:x(1,5)});v.push(t)}if(i.destr&&(i.points>0&&(X+=i.points),x(0,1e3)>970)){let e=new P({img:a.pu_fireball,x:i.x,y:i.y,animTick:0,animDelay:6});e.velY=.25,Y.push(e)}t.destr=!0}t.isFriendly||T(G,t)&&(S(G,t),t.destr=!0)}1!=g&&d(G.x,G.y,i.x,i.y)<64&&i.y<G.y&&(re=!0),T(G,i)&&S(G,i),i.destr&&(oe.splice(e,1),e--)}if(G.destr&&(G.vis=!1),0==g){y(t,8,8,"STELLA",9),y(t,12,64,"PROELIUM",6),y(t,20,106,"DEVELOPED BY JARED YORK",2),y(t,4,270,"MADE WITH <3 FOR JS13K 2021",2);for(let e=0;e<ue.length;e++){let i=ue[e];y(t,48,200+32*e,i,3),xe==e&&c(t,48,218+32*e,200,2,s.WHT)}}else if(1===g){if(N&&N.render(t),C.render(t),ie){let e=ne/Ye[N.img.name].life,i=s.GRN;e<.4?i=s.CLAY:e<.6&&(i=s.LIME),c(t,N.x,N.y-8,N.dw,8,s.BK),c(t,N.x+2,N.y-6,Math.round(e*(N.dw-4)),4,i)}for(let e=0;e<j;e++)t.drawImage(a.plyr.dyntexes[0].shadCanv,16*e+2+8,34),t.drawImage(a.plyr.dyntexes[0].canv,16*e+2+8,32);y(t,8,8,String(X),3)}else if(2==g){y(t,28,24,"HIGH SCORES",4);let e=JSON.parse(localStorage.getItem("stella_proelium"));if((e=null!=e&&null!=e?e:{}).highscores=void 0!==e.highscores?e.highscores:[],e.highscores.length>0)for(let i=0;i<e.highscores.length;i++)i<5&&y(t,28,64+20*i,i+1+". "+e.highscores[i],2);else y(t,45,64,"NO HIGH SCORES YET",2);for(let e=0;e<we.length;e++){let i=we[e];y(t,48,200+32*e,i,3),_e==e&&c(t,48,218+32*e,200,2,s.WHT)}}else if(3==g){y(t,28,24,"ARE YOU SURE",4);for(let e=0;e<be.length;e++){let i=be[e];y(t,48,200+32*e,i,3),ve==e&&c(t,48,218+32*e,200,2,s.WHT)}}}(),window.requestAnimationFrame(Me)}window.addEventListener("keydown",e=>{if(!Re[e.code])switch(e.code){case"Enter":if(0==g)0==xe?(g=1,Te({type:"hard"})):1==xe&&(g=2);else if(2==g)0==_e?g=0:1==_e&&(g=3);else if(3==g)if(0==ve)g=2;else if(1==ve){let e=JSON.parse(localStorage.getItem("stella_proelium"));(e=null!=e&&null!=e?e:{}).highscores=null!=e.highscores?e.highscores:[],e.highscores.length=0,console.log("saving ",e),localStorage.setItem("stella_proelium",JSON.stringify(e))}break;case"KeyW":0==g?xe-1>=0?xe--:xe=ue.length-1:2==g?_e-1>=0?_e--:_e=we.length-1:3==g&&(ve+1<be.length?ve++:ve=0);break;case"KeyS":0==g?xe+1<ue.length?xe++:xe=0:2==g?_e+1<we.length?_e++:_e=0:3==g&&(ve+1<be.length?ve++:ve=0)}Re[e.code]=!0}),window.addEventListener("keyup",e=>{Re[e.code]=!1}),function(){let e=function(){let e={hues:{BK:"#000000",WHT:"#ffffff",RD:"#883932",CYAN:"#67b6bd",MAG:"#8b3f96",GRN:"#55a049",PURP:"#40318d",LIME:"#bfce72",BWN:"#8b5429",DK_BWN:"#574200",CLAY:"#b86962",DK_GRY:"#505050",GRY:"#787878",LIME2:"#94e089",BLU:"#7869c4",LT_GRY:"#9f9f9f"}},t=e.hues,i=l(8*Object.keys(e.hues).length,8,{appendDOM:!0}).getContext("2d"),n=0;for(const t in e.hues)c(i,8*n,0,8,8,e.hues[t]),n++;let r={s16x16:{name:"s16x16",dynrender:{w:16,h:16,v:1,render:e=>{c(e,0,0,16,16,t.WHT)}}},plyr:{name:"plyr",dynrender:{w:16,h:16,v:1,hs:!0,ent:!0,render:e=>{m(e,[{x:8,y:1.6},{x:4,y:4},{x:8,y:8}],t.GRY),m(e,[{x:8,y:1.6},{x:12,y:4},{x:8,y:8}],t.LT_GRY),m(e,[{x:8,y:8},{x:0,y:12},{x:8,y:16}],t.GRY),m(e,[{x:8,y:8},{x:16,y:12},{x:8,y:16}],t.LT_GRY),m(e,[{x:8,y:0},{x:12,y:16},{x:4,y:16}],t.GRY),m(e,[{x:8,y:0},{x:12,y:16},{x:8.8,y:16}],t.LT_GRY),f(e,8,5.6,1.2,t.CYAN)}}},plzr:{name:"plzr",dynrender:{w:2,h:4,bg:t.CYAN,v:1,render:()=>{}}},fireball:{name:"fireball",frames:1,dynrender:{w:16,h:16,render:e=>{f(e,8,8,8,t.WHT,t.LIME,2)}}},bomb:{name:"bomb",dynrender:{w:2,h:4,bg:t.DK_GRY,v:1,hs:!0,render:()=>{}}},crosshair:{name:"crosshair",dynrender:{w:32,h:16,v:1,render:function(e){for(let i=0;i<2;i++)for(let n=16*i;n<16*i+16;n++)for(let l=0;l<16;l++){let r=16*i+8,s=!1;0==i&&(n%15!=0&&l%15!=0||(s=!0)),(n!=r-1&&n!=r||l%2!=0)&&(7!=l&&8!=l||7!=l&&8!=l||n%2!=0)||(s=!0),s&&M(e,n,l,t.WHT)}}},frames:2,anim:!0,fw:16,fh:16},crater:{name:"crater",dynrender:{w:64,h:16,v:5,render:function(e){for(let i=0;i<4;i++){f(e,2*(i+.5)*8,8,8,t.BK,t.DK_GRY,1);let n=0==i||1==i?t.DK_GRY:t.RD;f(e,2*(i+.5)*8,8,4,n)}for(let i=0;i<80;i++)x(0,100)>80&&M(e,x(0,64),x(0,16),t.CLAY)}},frames:4,anim:!0,fw:16,fh:16},gpl:{name:"gpl",dynrender:{w:64,h:16,bg:t.DK_BWN,v:5,render:function(e){for(let i=0;i<64;i++)for(let n=0;n<16;n++)if(i<16){for(let l=0;l<x(0,1);l++){let l=x(2,5),r=x(2,3),s=i>.5*l&&i<64-.5*l?i+x(.5*l,16-.5*l):.5*l,a=n>.5*r&&n<16-.5*r?n+x(.5*r,16-.5*r):.5*r;e.fillStyle=t.DK_BWN,e.beginPath(),e.ellipse(s-1,a+1,l,r,Math.PI/4,0,2*Math.PI),e.fill(),e.fillStyle=t.GRN,e.beginPath(),e.ellipse(s,a,l,r,Math.PI/4,0,2*Math.PI),e.fill()}i%2==0&&n%2==1&&M(e,i,n,t.DK_BWN),i%4==0&&n%4==1&&x(0,10)>3&&M(e,i,n,t.LIME)}else i>=16&&i<48?(M(e,i,n,t.GRN),1==x(0,500)&&M(e,i,n,t.LIME)):c(e,i,n,16,16,t.LIME)}},anim:!0,fw:16,fh:16},molt:{name:"molt",template:"gpl",dynrender:{palshift:[[t.DK_BWN,t.RD],[t.GRN,t.BK],[t.LIME,t.DK_GRY]]}},water:{name:"water",dynrender:{w:64,h:16,bg:t.PURP,v:1,render:function(e){for(let i=0;i<16;i++)M(e,x(0,64),x(0,16),t.CYAN)}},frames:4,anim:!0,fw:16,fh:16},lava:{name:"lava",template:"water",dynrender:{palshift:[[t.PURP,t.RD],[t.CYAN,t.LIME]]}},ice:{name:"ice",template:"water",dynrender:{palshift:[[t.PURP,t.CYAN]]}},stars:{name:"stars",template:"water",dynrender:{palshift:[[t.PURP,t.BK],[t.CYAN,t.LT_GRY]]}},drone:{name:"drone",dynrender:{w:32,h:16,v:1,hs:!0,ent:!0,render:function(e){for(let i=0;i<2;i++){f(e,2*(i+.5)*8,8,8,t.GRY,t.LT_GRY,1);let n=0==i?t.RD:t.CLAY,l=0==i?t.CLAY:t.LIME;f(e,2*(i+.5)*8,8,4,n),f(e,2*(i+.5)*8.8,7.2,.24,l)}}},anim:!0,frames:2,fw:16,fh:16},drone_armored:{name:"drone_armored",template:"drone",dynrender:{palshift:[[t.GRY,t.DK_GRY],[t.LT_GRY,t.GRY]]}},spinner:{name:"spinner",dynrender:{w:16,h:16,hs:!0,v:5,ent:!0,render:e=>{size=128;var i=Object.keys(t);let n=t[i[i.length*Math.random()<<0]];c(e,0,0,size,size,n)}}},garmor:{name:"garmor",dynrender:{w:16,h:16,v:1,bg:t.CYAN,ent:!0,render:e=>{m(e,[{x:0,y:0},{x:8,y:8},{x:0,y:16}],t.DK_GRY),m(e,[{x:16,y:0},{x:8,y:8},{x:16,y:16}],t.WHT)}}},garmor_strong:{name:"garmor_strong",template:"garmor",dynrender:{palshift:[[t.DK_GRY,t.BK],[t.GRY,t.BK],[t.CYAN,t.DK_GRY],[t.WHT,t.GRY]]}},gaa:{name:"gaa",anim:!0,fw:16,fh:16,frames:16,dynrender:{w:256,h:16,v:1,bg:t.CYAN,ent:!0,render:e=>{for(let i=0;i<16;i++)f(e,2*(i+.5)*8,8,8,t.WHT),i>0&&(f(e,2*(i+.5)*8,8,2*i,t.BK),f(e,2*(i+.5)*8,8,1*i,t.RD))}}},gaa_armored:{name:"gaa_armored",template:"gaa",dynrender:{palshift:[[t.WHT,t.DK_GRY],[t.GRY,t.BK],[t.CYAN,t.BK],[t.RD,t.PURP]]}},gaa_bullet:{name:"gaa_bullet",anim:!0,fw:8,fh:8,frames:2,dynrender:{w:16,h:8,bg:t.CYAN,render:e=>{for(let i=0;i<2;i++){let n=0==i?t.WHT:t.LIME;f(e,2*(i+.5)*4,4,4,n)}}}},gaa_large_hub:{name:"gaa_large_hub",dynrender:{w:48,h:48,render:e=>{c(e,16,0,16,48,t.LT_GRY),c(e,0,16,48,16,t.LT_GRY),f(e,24,24,24,t.DK_GRY,t.BK,2),f(e,24.48,24.48,20,t.LT_GRY,t.GRY,4),f(e,24.96,24.96,12,t.WHT)}}},gaa_large_hub_armored:{name:"gaa_large_hub_armored",template:"gaa_large_hub",dynrender:{palshift:[[t.DK_GRY,t.BK],[t.GRY,t.DK_GRY],[t.LT_GRY,t.GRY],[t.WHT,t.LT_GRY]]}},gaa_large_dome:{name:"gaa_large_dome",dynrender:{w:16,h:16,render:e=>{f(e,8,8,8,t.CYAN,t.DK_GRY,1),f(e,9,9,3,t.WHT,t.LT_GRY,1)}}},big_baddie:{name:"big_baddie",dynrender:{w:112,h:124,render:e=>{let i=112,n=124;m(e,[{x:0,y:16},{x:i,y:16},{x:56,y:n}],t.DK_GRY),c(e,28,0,16,16,t.BK),c(e,28,8,16,16,t.GRY),c(e,28,8,16,8,t.WHT),c(e,68,0,16,16,t.BK),c(e,68,8,16,16,t.LT_GRY),c(e,68,8,16,8,t.WHT),m(e,[{x:0,y:62},{x:56,y:0},{x:56,y:93}],t.GRY),m(e,[{x:i,y:62},{x:56,y:0},{x:56,y:93}],t.LT_GRY)}}},pu_fireball:{name:"pu_fireball",dynrender:{w:16,h:16,render:e=>{f(e,8,8,8,t.RD),f(e,8,8,16/3,t.CLAY),f(e,8,8,16/6,t.WHT)}}},pu_missile:{name:"pu_missile",dynrender:{w:16,h:16,render:e=>{c(e,4,8,4,16,t.LT_GRY)}}},smoke:{name:"smoke",template:"s16x16",dynrender:{palshift:[[t.WHT,t.GRY]]}},fire:{name:"fire",template:"s16x16",dynrender:{palshift:[[t.WHT,t.LIME]]}},pslot:{name:"pslot",dynrender:{w:24,h:24,render:e=>{c(e,0,0,24,24,null,t.WHT,4)}}}},s=["name"],a=0;for(const[e,i]of Object.entries(r)){let e=i;if(null!=e.template){let t=null;for(const[i,n]of Object.entries(r))n.name==e.template&&(t=Object.assign({},n));let i=e.dynrender;for(const[i,n]of Object.entries(t))s.includes(i)||(e[i]=n.valueOf());for(const[t,n]of Object.entries(i))e.dynrender[t]=n}e.dyntexes=[],e.dynrender.v=null!=e.dynrender.v?e.dynrender.v:1,e.dynrender.hues=Object.assign({},t);for(let t=0;t<e.dynrender.v;t++)console.log(e.name),e.dyntexes.push(I(e.dynrender));a++,console.log("finished iteration "+a+"/"+Object.entries(r).length),console.log("")}return e.imgs=r,e}();s=e.hues,a=e.imgs,Se(),c(r,0,0,i.width,i.height,s.LT_GRY),Me()}()});