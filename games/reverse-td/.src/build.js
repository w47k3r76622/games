function createCreep(t){var e=Object.create(createCreep.prototype);return e.set(t),e}function createSpawner(t){var e=Object.create(createSpawner.prototype);e.set(t),e.creep={};var i=spawnerBuildings.appendChild(document.createElement("div").setAttribute({"class":"spawner-container",id:"spawner-"+e.id}).setStyle({left:t.x+"px",top:t.y+"px"}).addEventListener("click",function(t){var i=t.target,r=i.classList,s=i.parentElement,a=s.querySelector(".spawner"),n=s.querySelectorAll(".spawner-upgrade"),o=s.querySelector(".sell");if(r.contains("cant-afford")||r.contains("completed"))return t.preventDefault(),void t.stopPropagation();if(r.contains("spawner"))s.classList.toggle("selected");else if(r.contains("spawner-upgrade")&&money>=(i.stats.cost||0)){var c,d,h,p;if(money-=i.stats.cost||0,income+=i.stats.incomeSec||0,forEach(i.stats,function(t,i){e.creep[i]=t}),i.stats.refund)money+=i.stats.refund,income--,n.forEach(function(t,e){t.show().setAttribute({"class":"spawner-upgrade "+spawnerStats[e].label}),t.stats=clone(spawnerStats[e])}),a.setAttribute({"class":"spawner",desc:"Choose a creep to send in the wave.",emp:""});else if(c=i.stats.upgrades){a.setAttribute({desc:"Upgrade",emp:i.stats.title}).classList.add(i.stats.label);var l=i.stats.cost;n.forEach(function(t,e){(d=c[e])?(t.stats=clone(d),t.stats.currLevel=0,t.stats.gLevels="(0/"+d.levels.length+")",forEach(d.levels[0],function(e,i){t.stats[i]=e})):e===n.length-1?(t.classList.add("sell"),t.stats={title:"Sell",desc:"Sell for 75% of the total cost",refund:Math.round(.75*l)}):t.hide()})}else(h=i.stats.levels)&&(p=++i.stats.currLevel,o.stats.refund+=Math.round(.75*i.stats.cost),i.stats.gLevels=i.stats.gLevels.replace(/\(./,"("+p),p>=h.length?(i.classList.add("completed"),i.stats.cost=0):forEach(h[p],function(t,e){i.stats[e]=t}))}i.blur(),a.focus()}));i.appendChild(document.createElement("button").setAttribute({"class":"spawner",desc:"Choose a creep to send in the wave."}));for(var r=0;r<spawnerStats.length;r++){var s=i.appendChild(document.createElement("button").setAttribute({"class":"spawner-upgrade "+spawnerStats[r].label,key:spawnerStats[r].gKey,keyCode:spawnerStats[r].keyCode}));s.stats=clone(spawnerStats[r])}return document.querySelectorAll("#spawner-"+e.id+" .spawner-upgrade").forEach(function(t){t.addEventListener("mouseenter focus",function(t){var e=t.target;card.classList.add("show"),gKey.hide(),forEach(e.stats,function(t,i){var r=window[i];r&&(r.innerHTML=r===gKey?"["+t+"]":spawnerStatRange[i]?spawnerStatRange[i][t]:t,"SPAN"===r.nodeName?r.parentElement.show():r.show()),"cost"===i&&e.classList.contains("completed")&&cost.parentElement.hide(),"upgrades"===i&&(cUpgrades.show(),cUpgrades.querySelectorAll("div").forEach(function(t){t.hide()}),t.forEach(function(t,e){window["upgrade-title-"+e].setInnerHTML(t.title).parentElement.show(),window["upgrade-desc-"+e].show().innerHTML=t.desc}))}),showCard(e)}),t.addEventListener("mouseleave blur",function(t){hideCard()})}),e}function makeOpaque(t,e){var i=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(i,function(t,e,i,r){return e+e+i+i+r+r});var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t),s=r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null;return"rgba("+s.r+","+s.g+","+s.b+","+e+")"}function createTower(t){var e=Object.create(createTower.prototype);forEach(towerStats[t.type],function(e,i){t[i]=e}),e.set(t);var i=2*t.range*gridSize;return e.towerDom=gTowers.appendChild(document.createElement("button").setAttribute({"class":"tower "+e.label+(t.isBuilding?" is-building":""),id:"tower-"+e.id}).setStyle({left:t.x+(gridSize-t.width)/2+"px",top:t.y+(gridSize-t.height)/2+"px"}).addEventListener("mouseenter focus",function(t){var i=t.target;gKey.hide(),forEach(i.stats,function(t,e){var i=window[e];i&&(i.innerHTML=i===gKey?"["+t+"]":towerStatRange[e]?towerStatRange[e][t]:t,"SPAN"===i.nodeName?i.parentElement.show():i.show())}),e.isBuilding?isBuilding.show():isBuilding.hide(),showCard(i)}).addEventListener("mouseleave blur",function(t){hideCard()}).addEventListener("click",function(t){t.target.classList.add("selected")})),e.towerDom.stats=towerStats[t.type],e.rangeDom=gTowers.appendChild(document.createElement("div").setAttribute({"class":"tower-range",id:"tower-range-"+e.id}).setStyle({width:i+"px",height:i+"px",left:t.x+(gridSize-t.width)/2-i/2+t.width/2+"px",top:t.y+(gridSize-t.height)/2-i/2+t.height/2+"px",zIndex:-1})),e.center={x:e.position.x+e.width/2|0,y:e.position.y+e.height/2|0},e.rateOfFire=1/e.fireRate,e.accumulator=0,e.prevTarget=null,e}function clone(t){var e={};return forEach(t,function(t,i){e[i]=t}),e}function dir(t,e){return t-e>0?1:0>t-e?-1:0}function distance(t,e){var i=e.position.x-t.center.x,r=e.position.y-t.center.y;return Math.sqrt(i*i+r*r)}function rand(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function forEach(t,e){for(var i in t)e(t[i],i)}function showCard(t){card.classList.add("show");var e=t.getBoundingClientRect(),i=card.getBoundingClientRect(),r=container.getBoundingClientRect(),s=e.top-r.top-i.height-10,a=e.left-r.left;0>s?(s=e.bottom-r.top+10,card.classList.add("top")):card.classList.remove("top"),a+card.offsetWidth>kontra.game.width?(a=e.right-r.left-card.offsetWidth-10,card.classList.add("right")):card.classList.remove("right"),card.setStyle({top:s+"px",left:a+"px"})}function hideCard(){card.classList.remove("show"),cardDivs.forEach(function(t){t.hide()})}function spawnWave(){groupCount++;for(var t=0,e=0;e<spawners.length;e++){for(var i=0;i<spawners[e].creep.spawns;i++)creeps.get(spawners[e].creep),creeps.objects[creeps.lastIndex].position.x-=(creeps.objects[creeps.lastIndex].width+2)*(t+i);t+=spawners[e].creep.spawns||0}}var gridSize=40,gridWidth=game.width/gridSize|0,gridHeight=game.height/gridSize|0;Node.prototype._addEventListener=Node.prototype.addEventListener,Node.prototype.addEventListener=function(t,e,i){var r=this;if("string"==typeof t)return t.split(" ").forEach(function(t){r._addEventListener(t,e,i)}),this},Element.prototype._setAttribute=Element.prototype.setAttribute,Element.prototype.setAttribute=function(t,e){if(2===arguments.length)this._setAttribute(t,e);else for(var i in t)t.hasOwnProperty(i)&&this._setAttribute(i,t[i]);return this},Element.prototype._getAttribute=Element.prototype.getAttribute,Element.prototype.getAttribute=function(t){var e=this._getAttribute(t);try{e=JSON.parse(e)}catch(i){}return e},Element.prototype.setInnerHTML=function(t){return this.innerHTML=t,this},Element.prototype.setStyle=function(t,e){if(2===arguments.length)this.style[t]=e;else for(var i in t)t.hasOwnProperty(i)&&(this.style[i]=t[i]);return this},Node.prototype.append=function(t){return this.appendChild(t),this},NodeList.prototype.forEach=HTMLCollection.prototype.forEach=Array.prototype.forEach,Element.prototype.show=function(t){return this.classList.remove("hide"),this},Element.prototype.hide=function(){return this.classList.add("hide"),this};var kontra=function(t,e){"use strict";return t.init=function(i){if(i=i||{},t.isString(i.canvas))this.canvas=e.getElementById(i.canvas);else if(t.isCanvas(i.canvas))this.canvas=i.canvas;else if(this.canvas=e.getElementsByTagName("canvas")[0],!this.canvas){var r=new ReferenceError("No canvas element found.");return void t.logError(r,"You must provide a canvas element for the game.")}this.context=this.canvas.getContext("2d"),this.game={width:this.canvas.width,height:this.canvas.height}},t.logError=function(t,e){console.error("Kontra: "+e+"\n	"+t.stack)},t.noop=function(){},t.isArray=Array.isArray,t.isString=function(t){return"string"==typeof t},t.isNumber=function(t){return"number"==typeof t},t.isImage=function(t){return t&&"img"===t.nodeName.toLowerCase()},t.isCanvas=function(t){return t&&"canvas"===t.nodeName.toLowerCase()},t}(kontra||{},document),kontra=function(t,e){"use strict";return t.timestamp=function(){return e.performance&&e.performance.now?function(){return e.performance.now()}:function(){return(new Date).getTime()}}(),t.gameLoop=function(e){var i=Object.create(t.gameLoop.prototype);return i.set(e),i},t.gameLoop.prototype={set:function(e){if(e=e||{},"function"!=typeof e.update||"function"!=typeof e.render){var i=new ReferenceError("Required functions not found");return void t.logError(i,"You must provide update() and render() functions to create a game loop.")}this.isStopped=!1,this._accumulator=0,this._delta=1e3/(e.fps||60),this.update=e.update,this.render=e.render},frame:function(){var e=this;if(e._rAF=requestAnimationFrame(e.frame.bind(e)),e._now=t.timestamp(),e._dt=e._now-e._last,e._last=e._now,!(e._dt>1e3)){for(e._accumulator+=e._dt;e._accumulator>=e._delta;)e.update(e._delta/1e3),e._accumulator-=e._delta;e.render()}},start:function(){this._last=t.timestamp(),this.isStopped=!1,requestAnimationFrame(this.frame.bind(this))},stop:function(){this.isStopped=!0,cancelAnimationFrame(this._rAF)}},t}(kontra||{},window),kontra=function(t,e,i){"use strict";return t.vector=function(e,i){var r=Object.create(t.vector.prototype);return r.set(e,i),r},t.vector.prototype={set:function(t,e){return this.x=t||0,this.y=e||0,this},add:function(t,e){this.x+=(t.x||0)*(e||1),this.y+=(t.y||0)*(e||1)},clamp:function(t,i,r,s){this.add=function(a,n){var o=this.x+(a.x||0)*(n||1),c=this.y+(a.y||0)*(n||1);this.x=e.min(e.max(o,t),r),this.y=e.min(e.max(c,i),s)}}},t.sprite=function(e){var i=Object.create(t.sprite.prototype);return i.set(e),i},t.sprite.prototype={advanceSprite:function(t){this.velocity.add(this.acceleration,t),this.position.add(this.velocity,t),this.timeToLive--},drawRect:function(){this.context.fillStyle=this.color,this.context.fillRect(this.position.x,this.position.y,this.width,this.height)},drawImage:function(){this.context.drawImage(this.image,this.position.x,this.position.y)},advanceAnimation:function(t){this.advanceSprite(t),this.currentAnimation.update(t)},drawAnimation:function(){this.currentAnimation.render({context:this.context,x:this.position.x,y:this.position.y})},playAnimation:function(t){this.currentAnimation=this.animations[t]},isAlive:function(){return this.timeToLive>0},set:function(e){e=e||{};var i=this;i.position=(i.position||t.vector()).set(e.x,e.y),i.velocity=(i.velocity||t.vector()).set(e.dx,e.dy),i.acceleration=(i.acceleration||t.vector()).set(e.ddx,e.ddy),i.timeToLive=e.timeToLive||0,i.context=e.context||t.context,t.isImage(e.image)||t.isCanvas(e.image)?(i.image=e.image,i.width=e.image.width,i.height=e.image.height,i.advance=i.advanceSprite,i.draw=i.drawImage):e.animations?(i.animations=e.animations,i.currentAnimation=e.animations[Object.keys(e.animations)[0]],i.width=i.currentAnimation.width,i.height=i.currentAnimation.height,i.advance=i.advanceAnimation,i.draw=i.drawAnimation):(i.color=e.color,i.width=e.width,i.height=e.height,i.advance=i.advanceSprite,i.draw=i.drawRect);var r=["x","y","dx","dy","ddx","ddy","timeToLive","context","image","animations","color","width","height"];for(var s in e)e.hasOwnProperty(s)&&-1===r.indexOf(s)&&(i[s]=e[s])},collidesWith:function(t){var e=t.x!==i?t.x:t.position.x,r=t.y!==i?t.y:t.position.y;return this.position.x<e+t.width&&this.position.x+this.width>e&&this.position.y<r+t.height&&this.position.y+this.height>r?!0:!1},update:function(t){this.advance(t)},render:function(){this.draw()}},t}(kontra||{},Math),kontra=function(t){"use strict";return t.pool=function(e){var i=Object.create(t.pool.prototype);return i.set(e),i},t.pool.prototype={set:function(e){e=e||{};var i,r;if("function"!=typeof e.create)return i=new SyntaxError("Required function not found."),void t.logError(i,"Parameter 'create' must be a function that returns an object.");if(this.create=e.create.bind(this,e.createProperties||{}),r=this.create(),!r||"function"!=typeof r.render||"function"!=typeof r.update||"function"!=typeof r.set||"function"!=typeof r.isAlive)return i=new SyntaxError("Create object required functions not found."),void t.logError(i,"Objects to be pooled must implement render(), update(), set() and isAlive() functions.");if(this.objects=[r],this.size=1,this.maxSize=e.maxSize||1/0,this.lastIndex=0,this.inUse=0,e.fill)for(;this.objects.length<this.maxSize;)this.objects.unshift(this.create())},get:function(t){t=t||{};var e=this;if(e.objects[0].isAlive()){if(e.size===e.maxSize)return;for(var i=0;i<e.size&&e.objects.length<e.maxSize;i++)e.objects.unshift(e.create());e.size=e.objects.length,e.lastIndex=e.size-1}var r=e.objects[0];r.set(t);for(var s=1;s<e.size;s++)e.objects[s-1]=e.objects[s];e.objects[e.lastIndex]=r,e.inUse++},getAliveObjects:function(){return this.objects.slice(this.objects.length-this.inUse)},clear:function(){this.inUse=0,this.size=1,this.lastIndex=0,this.objects.length=0,this.objects.push(this.create({}))},update:function(t){for(var e,i=this.lastIndex,r=Math.max(this.objects.length-this.inUse,0);i>=r;)if(e=this.objects[i],e.update(t),e.isAlive())i--;else{for(var s=i;s>0;s--)this.objects[s]=this.objects[s-1];this.objects[0]=e,this.inUse--,r++}},render:function(){for(var t=Math.max(this.objects.length-this.inUse,0),e=this.lastIndex;e>=t;e--)this.objects[e].render()}},t}(kontra||{});kontra.getAssetName=function(t){return t.replace(/\.[^/.]+$/,"")},kontra.images={},["footman.png","wizard.png","paladin.png"].forEach(function(t){var e=new Image,i=kontra.getAssetName(t);t="imgs/"+t,e.onload=function(){kontra.images[i]=kontra.images[t]=this,document.querySelectorAll("."+i).forEach(function(t){t.stats.image=e})},e.src=t}),createCreep.prototype=Object.create(kontra.sprite.prototype),createCreep.prototype.set=function(t){kontra.sprite.prototype.set.call(this,t),this.position.set((waypoints[0].c+.5)*gridSize,(waypoints[0].r+.5)*gridSize),this.velocity.set(dir(waypoints[1].c,waypoints[0].c),dir(waypoints[1].r,waypoints[0].r)),this.wp=1,this.wpX=(waypoints[1].c+.5)*gridSize,this.wpY=(waypoints[1].r+.5)*gridSize,this.center={},this.traveled=0,this.fullHealth=this.health,this.startCounting=!1,this.accumulator=0},createCreep.prototype.update=function(t){if(this.position.add({x:this.velocity.x*gameSpeed*this.speed,y:this.velocity.y*gameSpeed*this.speed}),this.center={x:this.position.x-this.width/2|0,y:this.position.y-this.height/2|0},this.healSec&&(this.accumulator+=t,this.accumulator>=1&&(this.health+=this.healSec,this.health=Math.min(this.fullHealth,this.health),this.accumulator-=1)),this.startCounting?this.traveled+=this.speed:this.startCounting=this.position.x>0&&this.position.x<kontra.game.width&&this.position.y>0&&this.position.y<kontra.game.height,this.velocity.x>0&&this.position.x>=this.wpX||this.velocity.x<0&&this.position.x<=this.wpX||this.velocity.y>0&&this.position.y>=this.wpY||this.velocity.y<0&&this.position.y<=this.wpY){if(this.wp++,!waypoints[this.wp])return this.timeToLive=0,this.reset(),lives--,void(money+=30);this.wpX=(waypoints[this.wp].c+.5)*gridSize,this.wpY=(waypoints[this.wp].r+.5)*gridSize,this.velocity.set(dir(waypoints[this.wp].c,waypoints[this.wp-1].c),dir(waypoints[this.wp].r,waypoints[this.wp-1].r))}},createCreep.prototype.render=function(){this.context.drawImage(this.image,this.center.x,this.center.y),this.aura&&(this.context.beginPath(),this.context.arc(this.center.x+this.width/2,this.center.y+this.height/2,this.aura*gridSize,0,2*Math.PI,!1),this.context.stroke()),this.context.fillStyle="red",this.context.fillRect(this.center.x,this.position.y-15,this.width,5),this.context.fillStyle="green",this.context.fillRect(this.center.x,this.position.y-15,this.health/this.fullHealth*this.width,5)},createCreep.prototype.damage=function(t,e){var i=Math.max(0,this.armor-(e.armorPiercing||0)),r=e.armorPiercing&&this.resistPiercing?this.resistPiercing:0,s=!1;this.dodge&&(s=Math.random()<=this.dodge/100),s||(this.health-=Math.max(0,t-i-r)),this.health<=0&&(this.timeToLive=0,this.reset())},createCreep.prototype.setProp=function(t,e){switch(t){case"health":this.health=e,this.fullHealth=e;break;default:this[t]=e}},createCreep.prototype.reset=function(){var t=this;forEach(this,function(e,i){"number"==typeof e&&(t[i]=0)})};var spawnerStats=[{armor:0,desc:"Basic soldier with no special abilities. Can spawn in large numbers.",title:"Footman",cost:60,incomeSec:1,spawns:1,speed:1.35,health:20,label:"footman",timeToLive:1/0,width:10,height:10,color:"blue",keyCode:"70",gKey:"F",upgrades:[{title:"Training Grounds",desc:"Send more Footman at once.",levels:[{cost:110,spawns:2},{cost:200,spawns:3}]},{title:"Improved Rations",desc:"Improve the health of Footman.",levels:[{cost:125,health:30},{cost:215,health:40},{cost:500,health:50}]}]},{armor:2,desc:"Armored creep that takes reduced damage.",title:"Paladin",cost:110,incomeSec:1,spawns:1,speed:1,health:40,label:"paladin",timeToLive:1/0,width:12,height:12,color:"darkgrey",keyCode:"65",gKey:"A",upgrades:[{title:"Steel Plating",desc:"Increase the armor of Paladins.",levels:[{cost:140,armor:4},{cost:240,armor:5}]},{title:"Holy Hands",desc:"Allow Paladins to heal themselves over time.",levels:[{cost:200,healSec:2},{cost:500,healSec:4}]}]},{armor:0,desc:"Power spell cater able to buff allies with spells.",title:"Wizard",cost:60,incomeSec:1,spawns:1,speed:1.35,health:15,label:"wizard",timeToLive:1/0,width:10,height:10,color:"purple",keyCode:"87",gKey:"W",upgrades:[{title:"Protection Aura",desc:"Reduce enemy spell damage around the Wizard.",levels:[{cost:100,magicResist:5,aura:1},{cost:300,magicResist:10,aura:1.25},{cost:600,magicResist:15,aura:1.5}]},{title:"Far Sight",desc:"Wizard is able to see the future and avoid an attack.",levels:[{cost:200,dodge:25},{cost:500,dodge:50}]}]}],spawnerStatRange={armor:{0:"None",1:"Low",2:"Low",3:"Medium",4:"Medium",5:"High"},speed:{1:"Slow",1.35:"Medium",2:"Fast",2.25:"Fast",2.5:"Very Fast",3:"Extremely Fast"},magicResist:{0:"None",5:"Low",10:"Medium",15:"High"}};createSpawner.prototype=Object.create(kontra.sprite.prototype);var towerStats={">":{title:"Arrow Tower",desc:"Basic tower that is effective against weak creeps.",label:"arrow",width:32,height:32,range:2.5,fireRate:2,damage:10,opacity:.5},"^":{title:"Bolt Tower",desc:"Upgraded tower that is more effective against creep.",label:"arrow",width:32,height:32,range:2.75,fireRate:2,damage:15,opacity:.5},"~":{title:"Mage Tower",desc:"Magic damage ignores a portion of a creeps armor.",label:"magic",width:32,height:32,range:2.25,fireRate:1.5,damage:15,armorPiercing:7.5,opacity:.2},"@":{title:"Cannon Tower",desc:"Slow firing tower that deals splash damage.",label:"cannon",width:32,height:32,range:3,fireRate:.34,aura:.5,damage:20,opacity:.3}},towerStatRange={fireRate:{1:"Very Slow",1.5:"Slow",2:"Medium",2.5:"Medium"},range:{2.25:"Medium",2.5:"Medium",2.75:"Far",3:"Very Far"}};createTower.prototype=Object.create(kontra.sprite.prototype),createTower.prototype.update=function(t){var e,i=0,r=creeps.getAliveObjects(),s=this;if(this.target=null,!this.isBuilding){for(var a,n=0;a=r[n];n++)e=distance(this,a),e<=this.range*gridSize&&a.traveled>i&&(i=a.traveled,this.target=a);if(this.accumulator+=t,this.accumulator>=this.rateOfFire)if(this.target){var o=[this.target];if(this.aura)for(n=0;a=creeps.objects[n];n++)e=distance(this.target,a),e<=this.aura*gridSize&&a!==this.target&&o.push(a);o.forEach(function(t){t.damage(s.damage,{armorPiercing:s.armorPiercing})}),this.accumulator-=this.rateOfFire}else this.accumulator-=t}},createTower.prototype.render=function(){},createTower.prototype.upgrade=function(t){this.isBuilding=!1,this.towerDom.classList.remove("is-building")},createTower.prototype.beginUpgrade=function(t){this.isBuilding=!0;var e=this;forEach(towerStats[t],function(t,i){e[i]=t});var i=2*this.range*gridSize;this.towerDom.stats=towerStats[t],this.rangeDom.setStyle({width:i+"px",height:i+"px",left:this.position.x-i/2+this.width/2+"px",top:this.position.y-i/2+this.height/2+"px"})},kontra.init({canvas:"game"});var level=["        o","        n###m","   c##d     #","   # >#  k##l","a##b  #  #","      #  #","      #  j####i","  f###e       #","  #           #","  g###########h",""," * * * * * *"],towerUpgrades={3:[{">":[8,4]}],5:[{">":[7,12]}],6:[{"~":[5,8]}],7:[{"^":[2,11]}],9:[{"@":[8,8]}],15:[{"@":[2,8]}]},context=kontra.context,waypointRegex=/[a-z]/,waypoints=[],towers=[],spawners=[],lives=20,staticContext=staticCanvas.getContext("2d"),money=110,income=0,wavesLeft=20,round=1,waveInProgress=!1,groupCount=0,gameSpeed=1,buildingTowers=[],upgradingTowers=[],cardDivs=card.querySelectorAll("div");cardDivs.forEach(function(t){t.hide()});for(var r=0;r<level.length;r++)for(var c=0;c<level[r].length;c++){var space=level[r][c];waypointRegex.test(space)&&(waypoints.push({i:space.charCodeAt()-97,r:r,c:c}),staticContext.fillStyle="#9b7653",staticContext.fillRect(c*gridSize,r*gridSize,gridSize,gridSize)),"#"===space?(staticContext.fillStyle="#9b7653",staticContext.fillRect(c*gridSize,r*gridSize,gridSize,gridSize)):"*"===space?spawners.push(createSpawner({id:spawners.length,x:c*gridSize,y:r*gridSize})):towerStats[space]&&towers.push(createTower({type:space,id:towers.length,x:c*gridSize,y:r*gridSize}))}waypoints.sort(function(t,e){return t.i-e.i}),0===waypoints[0].r?waypoints[0].r=-1:waypoints[0].r===gridHeight-1?waypoints[0].r=gridHeight:waypoints[0].c=0===waypoints[0].c?-1:gridWidth;var endWaypoint=waypoints[waypoints.length-1];0===endWaypoint.r?endWaypoint.r=-1:endWaypoint.r===gridHeight-1?endWaypoint.r=gridHeight:endWaypoint.c=0===endWaypoint.c?-1:gridWidth;var creeps=kontra.pool({create:createCreep}),purchases=spawnerBuildings.querySelectorAll(".spawner-upgrade"),accumulator=0,spawnAccumulator=0,loop=kontra.gameLoop({update:function(t){t*=gameSpeed,purchases.forEach(function(t){t.stats.cost>money?t.classList.add("cant-afford"):t.classList.remove("cant-afford")}),0!==creeps.getAliveObjects().length||waveInProgress?(accumulator+=t,spawnAccumulator+=t,accumulator>=1&&(money+=income,accumulator-=1),9>groupCount?spawnAccumulator>=2&&(spawnWave(),spawnAccumulator-=2):waveInProgress=!1):(sendWave.removeAttribute("disabled"),towerUpgrades[round]&&!towerUpgrades[round].isBuilt&&(upgradingTowers.forEach(function(t){t.upgrade()}),buildingTowers.forEach(function(t){t.upgrade(),towers.push(t)}),buildingTowers=[],upgradingTowers=[],towerUpgrades[round].isBuilt=!0),towerUpgrades[round+1]&&!towerUpgrades[round+1].isBuilding&&(towerUpgrades[round+1].forEach(function(t){for(var e,i=Object.keys(t)[0],r=t[i],s=!1,a=0;e=towers[a];a++)if(e.position.x===r[1]*gridSize&&e.position.y===r[0]*gridSize){s=!0,e.beginUpgrade(i),upgradingTowers.push(e);break}s||buildingTowers.push(createTower({type:i,id:towers.length,x:r[1]*gridSize,y:r[0]*gridSize,isBuilding:!0}))}),towerUpgrades[round+1].isBuilding=!0)),pLives.innerHTML=lives,pMoney.innerHTML=money,pIncome.innerHTML=income,pWaves.innerHTML=wavesLeft,creeps.update(t);for(var e,i=0;e=creeps.objects[i];i++)for(var r,s=i;r=creeps.objects[s];s++)if("spellcaster"===e.label||"spellcaster"===r.label){var a=distance(e,r);if(a<=e.aura*gridSize||a<=r.aura*gridSize){var n=Math.max(e.magicResist,r.magicResist);e.resistPiercing=n,r.resistPiercing=n}}else e.resistPiercing=0,r.resistPiercing=0;for(var o=0;o<towers.length;o++)towers[o].update(t)},render:function(){for(kontra.context.clearRect(0,0,kontra.canvas.width,kontra.canvas.height),creeps.render(),i=0;i<towers.length;i++)towers[i].render()}});loop.start(),document.querySelectorAll("[desc]").forEach(function(t){t.addEventListener("mouseenter focus",function(t){var e=t.target;title.show().innerHTML=e.getAttribute("desc"),e.getAttribute("key")?(gKey.show(),gKey.innerHTML="["+e.getAttribute("key")+"]"):e.getAttribute("emp")&&(gKey.show(),gKey.innerHTML=e.getAttribute("emp")),showCard(e)}),t.addEventListener("mouseleave blur",function(t){hideCard()})}),document.addEventListener("click keydown",function(t){if("click"===t.type&&(t.target.classList.contains("cant-afford")||t.target.classList.contains("completed")))return t.preventDefault(),void t.stopPropagation();if(("keydown"===t.type&&27===t.keyCode||"click"===t.type)&&t.target!==sendWave&&t.target.parentElement!==gSpeed){document.querySelectorAll(".selected").forEach(function(t){t.classList.remove("selected")});var e=document.activeElement;"keydown"===t.type&&e&&e.classList.contains("bldg-upgrade")&&e.parentNode.querySelector(".bldg").focus(),hideCard()}"keydown"===t.type&&document.querySelectorAll('[keyCode="'+t.keyCode+'"]').forEach(function(t){var e=window.getComputedStyle(t);"none"!==e.display&&"hidden"!==e.visibility&&t.click()})},!0),gSpeed.addEventListener("click",function(t){gameSpeed=parseInt(t.target.getAttribute("speed"));var e=[1,2,3].filter(function(t){return t>gameSpeed}).map(function(t){return'[speed="'+t+'"]'}).join(",");e&&gSpeed.querySelectorAll(e).forEach(function(t){t.classList.remove("current")}),e=[1,2,3].filter(function(t){return gameSpeed>=t}).map(function(t){return'[speed="'+t+'"]'}).join(","),e&&gSpeed.querySelectorAll(e).forEach(function(t){t.classList.add("current")})}),sendWave.addEventListener("click",function(t){!waveInProgress&&0===creeps.getAliveObjects().length&&wavesLeft>0&&(groupCount=0,spawnAccumulator=0,spawnWave(),creeps.getAliveObjects().length&&(waveInProgress=!0,wavesLeft--,round++,t.target.setAttribute("disabled",!0)))});