"use strict";
window.meta = {
	levels: [{"s":[6,4],"i":[[1,6,0],[1,4,1],[1,8,1],[1,3,2],[1,5,2],[2,6,2],[1,7,2],[1,9,2],[1,1,3],[1,2,3],[1,10,3],[1,11,3],[2,0,4],[2,12,4],[1,0,5],[1,12,5],[1,1,6],[1,2,6],[1,3,6],[2,4,6],[1,5,6],[1,7,6],[2,8,6],[1,9,6],[1,10,6],[1,11,6],[1,4,7],[2,6,7],[1,8,7],[1,6,8]]},{"s":[9,8],"i":[[2,9,1],[2,6,3],[1,9,3],[2,12,3],[1,8,4],[1,9,4],[1,10,4],[1,7,5],[1,8,5],[1,9,5],[1,10,5],[1,11,5],[2,3,6],[1,6,6],[1,7,6],[1,8,6],[1,9,6],[1,10,6],[1,11,6],[1,12,6],[2,14,6],[1,3,8],[2,5,8],[2,12,8],[1,14,8],[1,5,10],[1,12,10],[1,7,12],[2,9,12],[1,10,12],[1,2,13],[1,3,13],[1,4,13],[1,5,13],[1,6,13],[1,7,13],[1,10,13],[1,11,13],[1,12,13],[1,13,13],[1,14,13],[1,15,13]]},{"s":[4,3],"i":[[2,5,0],[1,1,1],[1,9,1],[1,0,2],[1,10,2],[1,1,3],[1,9,3],[1,2,5],[1,4,5],[1,6,5],[1,8,5],[1,3,6],[2,4,6],[1,5,6],[2,6,6],[1,7,6],[1,2,7],[2,3,7],[1,4,7],[1,6,7],[2,7,7],[1,8,7],[1,3,8],[1,5,8],[1,7,8]]},{"s":[14,9],"i":[[2,7,1],[2,30,2],[1,20,3],[2,5,4],[2,9,4],[1,28,4],[1,37,4],[1,42,4],[1,1,5],[1,28,5],[1,29,5],[1,31,5],[1,5,6],[1,9,6],[1,13,6],[1,15,6],[1,26,6],[1,29,6],[1,30,6],[1,31,6],[1,32,6],[2,37,6],[1,12,7],[1,14,7],[1,16,7],[1,26,7],[1,28,7],[1,29,7],[1,30,7],[1,31,7],[2,32,7],[1,37,7],[1,40,7],[1,7,8],[1,24,8],[1,26,8],[1,28,8],[1,29,8],[1,30,8],[1,31,8],[1,32,8],[1,33,8],[1,34,8],[1,24,9],[1,4,10],[1,9,10],[1,19,10],[1,22,10],[1,24,10],[1,35,10],[1,40,10],[1,4,11],[1,5,11],[1,8,11],[1,10,11],[1,18,11],[1,20,11],[1,0,13],[1,2,13],[1,3,13],[1,4,13],[1,5,13],[1,8,13],[1,10,13],[1,11,13],[1,12,13],[1,13,13],[1,14,13],[1,15,13],[1,16,13],[1,17,13],[1,18,13],[1,20,13],[1,21,13],[1,22,13],[1,23,13],[1,24,13],[1,25,13],[1,26,13],[1,27,13],[1,28,13],[1,29,13],[1,30,13],[1,31,13],[1,32,13],[1,33,13],[1,34,13],[1,35,13],[1,36,13],[1,37,13],[1,38,13],[1,42,13],[1,44,13],[1,16,15],[1,1,16],[1,2,16],[1,5,16],[1,6,16],[1,9,16],[1,10,16],[2,21,16],[2,40,16],[1,11,17],[1,13,17],[1,12,18],[1,18,18],[1,19,18]]},{"s":[5,2],"i":[[2,3,1],[1,3,2],[2,9,2],[1,16,2],[1,17,2],[1,10,3],[1,16,4],[1,17,4],[1,1,5],[1,4,5],[1,5,5],[1,4,6],[1,5,6],[2,10,6],[2,13,6],[2,1,7],[1,4,7],[2,5,7],[1,10,7],[1,11,7],[1,16,7],[1,17,7],[1,1,8],[1,4,8],[1,4,9],[1,5,9],[1,7,9],[2,12,9],[1,14,9],[2,2,10],[1,2,11],[1,12,11],[1,5,13],[1,6,13],[1,9,13],[1,10,13],[1,14,13],[1,15,13],[1,5,14],[2,6,14],[1,9,14],[2,10,14],[2,14,14],[1,15,14]]},{"s":[10,1],"i":[[2,7,2],[1,8,2],[1,12,2],[2,13,2],[1,7,3],[1,13,3],[1,8,4],[1,12,4],[1,7,5],[2,8,5],[2,12,5],[1,13,5],[1,8,6],[1,12,6],[1,7,7],[1,13,7],[2,7,8],[1,8,8],[1,12,8],[2,13,8],[1,16,9],[2,19,9],[2,3,10],[2,10,10],[1,15,10],[1,4,11],[1,16,11],[1,3,12],[1,5,12],[1,15,12],[1,4,13],[1,16,13],[1,18,13],[1,20,13],[1,1,14],[1,5,14],[1,6,14],[1,7,14],[2,10,14],[1,15,14],[1,5,15],[1,16,15],[1,18,15],[1,20,15],[1,6,16],[1,15,16],[1,5,17],[1,6,17],[1,7,17],[1,16,17],[1,18,17],[1,19,17],[1,20,17],[2,1,18],[1,7,18],[2,10,18],[1,15,18],[1,1,19],[1,6,19],[1,16,19],[1,17,19],[1,18,19],[1,19,19],[1,20,19],[1,2,20],[1,5,20],[1,6,20],[1,7,20],[1,15,20],[1,1,21],[1,6,21],[1,14,21],[1,17,21],[1,18,21],[1,19,21],[1,20,21],[1,2,22],[1,7,22],[1,13,22],[1,1,23],[1,5,23],[1,6,23],[1,7,23],[1,12,23],[1,13,23],[1,14,23],[1,15,23],[1,16,23],[1,17,23],[1,18,23],[1,19,23],[1,20,23]]}],
	dialogue: ["Man, what a simple world we live in, everything is always so black or white",
		"I know what will cheer you up, some coffee",
		"Man I love coffee. It makes me really hoppy, I mean happy, yea",
		"Dude, you gotta check out all the great coffee out there",
		"Just be careful because some it may trip you out",
		"You never know what may be in that stuff",
		"You know I only drink 100% fair trade organic arabica beans",
		"The other stuff just isn't worth it, but since none of the coffee is properly labeled, you're just going to have to drink all of it",
		"So, grab all the coffee you can. Just don't fall",
		"Man, I hate falling. So please, just don't do it bro",
		"Oh yea, and the collision detection is a bit wierd, I know how cliche, right",
		"Whatever you do, just keep jumping for that coffee, it's worth it"]
};


var Assets = function(){
	this.assets = {};
};

Assets.prototype = {
	get: function(id){
		return this.assets[id];
	},

	loadSound: function(id){
		this.assets[id] = new Audio();
		this.assets[id].src = id + ".mp3";
 	},

	loadImage: function(id){
		this.assets[id] = new Image();
		this.assets[id].src = id + ".png";
	},

	load: function(){
		this.loadImage("hipster");
		this.loadImage("coffee");
		this.loadImage("font");
		this.loadSound("pickup");
		this.loadSound("jump");
	}
}

window.assets = new Assets();

var Collider = function(scene){
	this.scene = scene;
}

Collider.prototype = {
	detectPickupItem: function(char){
		for (var i = 0; i < this.scene.pickupTokens.length; i++){
			var item = this.scene.pickupTokens[i];
			if (item && item.x < char.x + char.w &&
					   (item.x) + 13 > char.x &&
   						item.y < char.y + char.h &&
   						14 + item.y > char.y)
			{
				this.scene.pickupTokens[i] = null;
				return true;

			}
		}

		return false;
	},

	isOnBottomEdge: function(char){
		return (char.y >= this.scene.edgeBottom);
	},

	isOnPlatform: function(char){
		var charLeft = char.x + 1;
		var charRight = charLeft + (char.w - 2); 
		var charTop = char.y + 9;
		var charBottom = charTop + (char.h - 9); 
        for(var i =0; i < this.scene.blocks.length; i++){
        	var block = this.scene.blocks[i];
        	var x = (block.x* this.scene.blockSize);
        	var y = (block.y* this.scene.blockSize);        	
        	if ((charTop < y && charBottom >= y && charBottom < y + (this.scene.blockSize * .25)) && (charLeft < x + this.scene.blockSize && charRight > x )){
        		return true;
        	}
        }

        return false;
	}
}

var Scene = function(){
	this.blocks = [];
	this.pickupTokens = [];
	this.blockSize = 15;
	this.coffeeFrameAnim = 0;
	this.coffeeFrame = 0;
}

Scene.prototype = {

	build: function(scene){
		this.tokenCount = 0;
		this.blocks = [];
		this.pickupTokens = [];

		this.edgeBottom = 0;
		this.edgeRight = 0;
		this.spawn = {x: scene.s[0]* this.blockSize, y: scene.s[1]* this.blockSize}

		var items = scene.i;
		for (var i = 0; i < items.length; i++){
			var item = items[i];
			if (!item){continue;}
			var type = item[0];
			if (type === 1){
				this.blocks.push({x: item[1], y: item[2]});
				if (item[2]* this.blockSize > this.edgeBottom){
					this.edgeBottom = item[2]* this.blockSize;
				}
				if ((item[1]* this.blockSize) + this.blockSize > this.edgeRight){
					this.edgeRight = (item[1]* this.blockSize) + (this.blockSize* 3);
				}
			}
			else if (type === 2){
				this.pickupTokens.push({x: 2 + (item[1]* this.blockSize), y: 1 + (item[2]* this.blockSize)});
				this.tokenCount +=1;
			}
		}

		this.edgeBottom += this.blockSize;
	},

	render: function(ctx, blockColor, camX, camY){
 		var blockHeight = this.blockSize * .25;
 		ctx.fillStyle = blockColor;
        for(var i =0; i < this.blocks.length; i++){
        	var block = this.blocks[i];
        	var x = (block.x* this.blockSize) - camX;
        	if (x < this.blockSize || x >= 320 -(this.blockSize * 2)){continue;}
        	var y = (block.y* this.blockSize) - camY;        	
        	if (y < this.blockSize || y >= (240- this.blockSize* 2)){continue;}
	        ctx.fillRect(x + 1, y + 1, this.blockSize - 2, this.blockSize - 2);
        }

 		ctx.fillStyle = "#aaa";
        for(var i =0; i < this.blocks.length; i++){
        	var block = this.blocks[i];
        	var x = (block.x* this.blockSize) - camX;
        	if (x < this.blockSize || x >= 320 -(this.blockSize * 2)){continue;}
        	var y = (block.y* this.blockSize) - camY;        	
        	if (y < this.blockSize || y >= (240- this.blockSize* 2)){continue;}
	        ctx.fillRect(x+ 1, y, this.blockSize - 2, blockHeight);
        }

        var coffee = window.assets.get("coffee");
        for (var i = 0; i < this.pickupTokens.length; i++){
        	var item = this.pickupTokens[i];
        	if (!item){continue;}
        	var x = (item.x) - camX;
        	if (x < this.blockSize || x >= 320 -(this.blockSize * 2)){continue;}
        	var y = (item.y) - camY;        	
        	if (y < this.blockSize || y >= (240- this.blockSize* 2)){continue;}
        	ctx.drawImage(coffee, this.coffeeFrame * 13, 0, 13, 14, x, y, 13, 14)
        }
	},

	tick: function(ticks){
		this.coffeeFrameAnim += 1 * ticks;
		if (this.coffeeFrameAnim > 5){
			this.coffeeFrameAnim = 0;
			this.coffeeFrame = (this.coffeeFrame == 1) ? 0 : 1;
		}
	}
}

var Hipster = function(x, y){
	this.frames = {
		ok: 0,
		happy: 1,
		cool: 2,
		trippy: 3,
		scared: 4
	}
	this.frame = 0;
	this.frameDuration = 0;
	this.moving = "";
	this.x = x;
	this.y = y;
	this.targetY = this.y;
	this.w = 13;
	this.h = 15;
	this.jumpMultiplier = 1;
}

Hipster.prototype = {

	jump: function(){
		this.jumpMultiplier += .5;
		this.targetY = this.y - (this.h + this.jumpMultiplier);
		console.log(this.jumpMultiplier);
	},

	render: function(ctx, camX, camY){
		var frameX = this.frame * this.w;
        ctx.drawImage(window.assets.get("hipster"), frameX, 0, 
        	this.w, this.h, 
        	this.x - camX, this.y - camY, 
        	this.w, this.h);
	},

	tick: function(ticks, rightEdge){
		if (this.moving == "w"){
			this.x -=2 * ticks;		
			if (this.x < -this.w){this.x = -this.w;}	
		}
		else if (this.moving == "e"){
			this.x +=2 * ticks;			
			if (this.x + this.w > rightEdge){this.x = rightEdge - this.w;}
		}

		if (this.frameDuration > 0){
			this.frameDuration -= .1 * ticks;

			if (this.frameDuration <= 0){
				this.frame = 0;
				this.frameDuration = 0;
			}
		}

		if (this.targetY && this.targetY < this.y){
			this.y -= (2) * ticks;
			if (this.y <= this.targetY){
				this.targetY = null;
			}
		}
		else{
			this.y += 1.75 * ticks;
			if (this.jumpMultiplier >0){
				this.jumpMultiplier -=1 * ticks;
				if (this.jumpMultiplier < 0) {this.jumpMultiplier = 0;}
			}
		}

	}

}


var Sprite = function(){

}

var Input = function()
{

}

var Camera = function(){
	this.x = 0;
	this.y = 0;
}

Input.prototype = {
	bind: function(handler){
		window.onkeydown = function(e){
			handler(e.keyCode, true);
		}
		window.onkeyup = function(e){
			handler(e.keyCode, false);
		}
	}
}

var Dialogue = function(){
	this.index = 0;	
	this.words = window.meta.dialogue[this.index].split(" ");
	this.wordIndex = 0;
	this.wordTick = 0;
}

Dialogue.prototype = {
	advance: function(){
		if (this.wordIndex >= this.words.length - 1){
			if (this.index >= window.meta.dialogue.length-1){return true;}
			this.index +=1;
			this.words = window.meta.dialogue[this.index].split(" ");
			this.wordIndex = 0;
			return false;
		}
	},

	tick: function(ticks){
		this.wordTick += 1 *ticks;
		if (this.wordTick > 2){
			this.wordTick = 0;
			if (this.wordIndex < this.words.length - 1){
				this.wordIndex +=1;							
			}
		}
	},

	render: function(ctx){
        ctx.drawImage(window.assets.get("hipster"), 4 * 13, 0, 13, 15, 147, 20, 26, 30);
        ctx.font = "12px courier new, serif";
		ctx.fillStyle = "#fff";
		var wordX = 10;
		var wordY = 80;
		for (var i = 0; i <= this.wordIndex; i++){
			var m = ctx.measureText(this.words[i]);
			if (wordX + m.width >= 300){
				wordX = 10;
				wordY += 16;
				ctx.fillText(this.words[i], wordX, wordY);			
			}
			else{
				ctx.fillText(this.words[i], wordX, wordY);			
			}
			wordX += m.width + 2;
			if (wordX >= 300){
				wordX = 10;
				wordY += 16;
			}				
		}
	}
}

var Game = function(){
	this.input = new Input();
	this.dialogue = new Dialogue();
	this.input.bind(this.onKeyPress.bind(this));
	this.camera = new Camera();
	this.scene = new Scene();
	this.levelIndex = 0;
	this.collider = new Collider(this.scene);
	this.colors = ["#000", "#fff"];
	this.verticalFlip = false;
	this.mode = 0;
}

Game.prototype = {

	disableSmoothing: function(){
		var ctx = this.context;
		ctx.mozImageSmoothingEnabled = false;
		ctx.webkitImageSmoothingEnabled = false;
		ctx.msImageSmoothingEnabled = false;
		ctx.imageSmoothingEnabled = false;
	},

	prepareCanvasContext: function(){
		this.canvas = document.getElementById("gameCanvas");
		this.context = this.canvas.getContext('2d');
		this.disableSmoothing();
		this.context.font = "12px bold courier new";
		this.context.scale(2, 2);
	},

	nextLevel: function(){
		this.levelIndex = (this.levelIndex < window.meta.levels.length - 1) ? this.levelIndex + 1: 0;
		this.scene.build(window.meta.levels[this.levelIndex]);
		this.hipster.x = this.scene.spawn.x;
		this.hipster.y = this.scene.spawn.y;
		this.hipster.jumpMultiplier = 1;
		this.hipster.frame = 2;
		this.hipster.frameDuration = 2;
		this.verticalFlip = false;
	},

	init: function(){
		window.assets.load();
		this.prepareCanvasContext();
		this.scene.build(window.meta.levels[this.levelIndex]);
		this.whiteOnBlack = true;
		this.hipster = new Hipster(this.scene.spawn.x, this.scene.spawn.y);
		this.draw();
	},

	onKeyPress: function(keyCode, isDown){
		if (this.mode === 1){
			if (keyCode === 37){
				this.hipster.moving = isDown ? "w" : "";
			}
			else if (keyCode === 39){
				this.hipster.moving = isDown ? "e" : "";
			}
		}
		else{
			if (isDown && (keyCode === 32 || keyCode == 13) && this.dialogue.advance()){
				this.mode = 1;
			}
		}
	},

	tick: function(ticks){
		if (this.mode === 0){
			this.dialogue.tick(ticks);
			return;
		}
		this.hipster.tick(ticks, this.scene.edgeRight);
		if (this.collider.isOnPlatform(this.hipster)){
			window.assets.get("jump").play();
			this.hipster.frame = 1;
			this.hipster.frameDuration = 2;
			this.hipster.jump();
		}
		else if (this.collider.isOnBottomEdge(this.hipster)){
			this.hipster.y = 0;
			this.hipster.frame = 3;
			this.hipster.frameDuration = 2;
		}

		if (this.collider.detectPickupItem(this.hipster)){
			window.assets.get("pickup").play();
			this.hipster.frame = 2;
			this.hipster.frameDuration = 2;
			this.whiteOnBlack = !this.whiteOnBlack;
			this.colors.reverse();
			this.scene.tokenCount -=1;
			if (this.scene.tokenCount === 0){
				this.nextLevel();
			}
			else{
				if (!this.verticalFlip && Math.random() >= .6){
					this.verticalFlip = true;
					var _this = this;
					setTimeout(function(){
						if (_this.verticalFlip) {_this.verticalFlip = false;}
					}, 6000)					
				}
			}
		}

		this.camera.x = this.hipster.x - 160;
		this.camera.y = this.hipster.y - 120;
		this.scene.tick(ticks);
	},

	draw: function(){
        var now = new Date().getTime();
        var dt = now - (this.time || now);
        this.time = now;        
        this.tick(dt / 60);

		requestAnimationFrame(this.draw.bind(this));
		var ctx =this.context;
 		ctx.fillStyle = this.colors[0];
        ctx.fillRect (0, 0, 320, 240);

        if (this.mode === 0){
        	this.dialogue.render(ctx);
        }
        else{
	        if (this.verticalFlip){
		    	ctx.save();
		      	ctx.translate(0, 240);
				ctx.scale(1, -1);        	
	        }
			this.scene.render(ctx, this.colors[1], this.camera.x, this.camera.y);
	        this.hipster.render(ctx, this.camera.x, this.camera.y);
	        if (this.verticalFlip){
	        	ctx.restore();
			}

	        this.drawNumber(ctx, this.scene.tokenCount < 10 ? "0" + this.scene.tokenCount : this.scene.tokenCount, 10, 10, this.whiteOnBlack ? 0 : 1);
	        this.drawNumber(ctx, (1+this.levelIndex < 10 ? "0" + (1+this.levelIndex) : 1+this.levelIndex), 290, 10, this.whiteOnBlack ? 0 : 1);
        }       
	},

	drawNumber: function(ctx, number, x, y, pallete){
		var font = window.assets.get("font");
		var dstX = x;
		var srcY =  16 * pallete;
		var text = number.toString();
		for (var i = 0; i < text.length;i++){
			var srcX, chW;
			var ch = text.charAt(i);
			switch (ch){
				case '0':{
					srcX = 0;
					chW = 12;
					break;
				}
				case '1':{
					srcX = 14;
					chW = 7;
					break;
				}
				case '2':{
					srcX = 26;
					chW = 13;
					break;
				}
				case '3':{
					srcX = 42;
					chW = 13;
					break;
				}
				case '4':{
					srcX = 58;
					chW = 11;
					break;
				}
				case '5':{
					srcX = 74;
					chW = 13;
					break;
				}
				case '6':{
					srcX = 90;
					chW = 13;
					break;
				}
				case '7':{
					srcX = 106;
					chW = 13;
					break;
				}
				case '8':{
					srcX = 122;
					chW = 13;
					break;
				}
				case '9':{
					srcX = 138;
					chW = 13;
					break;
				}
			}

        	ctx.drawImage(font, srcX, srcY, chW, 16, dstX, y, chW, 16);
        	dstX += chW + 1;
		}

	}
}

window.game = new Game();
