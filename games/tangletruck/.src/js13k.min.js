var PLAYERID=0,numroads=1+Math.round(25*Math.random()),numturns=3+Math.round(50*Math.random()),grid=50+Math.round(200*Math.random()),straightaway=250+Math.round(400*Math.random()),trafficCount=404,mouseIsDown,gasPedalDown,brakePedalDown,mouseX,mouseY,mouseWorldX,mouseWorldY,camX,camY,sprites,gameCanvas,gameCTX,mapCanvas,mapCTX,collideCanvas,collideCTX,collisionData,x,y,u,v,num,music,framecount=0,STRESSTESTNUM=0,MAP_W=16E3,MAP_H=2E3,minimapW=MAP_W/30,minimapH=MAP_H/30,LOOP_ROADS=!1,USE_MUSIC=!1,LOOP_MUSIC=
!0,USE_MOTOR_SOUND=!0,MOTOR_SOUND_SPEED_SCALE=2,MINSPD=.1,MAXSPD=.5,PLAYER_MAXSPD=8,PLAYER_ACCEL=.005,PLAYER_BRAKES=-.025,PLAYER_COAST=-5E-4,SPR_W=20,SPR_H=8,NUM_VEHICLE_SPRITES=3,FWD=1,REV=-1,DEG2RAD=Math.PI/180,DEBUGTRUCKAI=!1,DEBUG_PLAYER=!0,BUILDING_RGBA="rgba(88,80,80,1)",waterRGBA="rgba(0,16,40,1)",numEnts=0,spr=[],ex=[],ey=[],xs=[],ys=[],rot=[],odo=[],spd=[],per=[],seg=[],rod=[],dir=[];document.addEventListener("contextmenu",function(a){return a.preventDefault()});
window.addEventListener("click",onclick);window.addEventListener("mouseup",onmouseup);window.addEventListener("mousedown",onmousedown);window.addEventListener("mousemove",onmove);window.addEventListener("resize",resize);window.addEventListener("load",onload);Array.prototype.randomItem=function(){return this[Math.floor(Math.random()*this.length)]};var menuActive=!0;
function drawMenu(){var a=Math.round(gameCanvas.width/2),e=Math.round(gameCanvas.height/2);gameCTX.fillStyle="rgba(0,0,0,0.5)";gameCTX.fillRect(a-256,e-128,512,256);gameCTX.strokeStyle="rgba(0,0,0,0.5)";gameCTX.lineWidth=10;gameCTX.strokeRect(a-256,e-128,512,256);camX=MAP_W/2-a;camY=MAP_H/2-e;camX-=Math.round(Math.cos((framecount+300)/444)*MAP_W/20);camY-=Math.round(Math.cos((framecount+300)/167)*MAP_H/20);gameCTX.textAlign="center";gameCTX.fillStyle="rgba(255,255,222,1)";gameCTX.font="64px Verdana";
gameCTX.strokeStyle="rgba(0,0,0,0.5)";gameCTX.lineWidth=10;gameCTX.strokeText("Tangletruck",a,e-128+70);gameCTX.fillText("Tangletruck",a,e-128+70);gameCTX.font="16px Verdana";gameCTX.fillText("Click to play!",a,e-10);gameCTX.fillText("Refresh your browser to generate a random city!",a,e+50);gameCTX.fillText("Warning: delivery address not found. Good luck!",a,e+30);gameCTX.fillText("Hint: the mouse buttons are the gas and brake.",a,e+70);gameCTX.fillText("Made for #js13k 2020 by @McFunkypants",a,e+
128-20)}function collides(a,e){return 0!=collisionData[4*(Math.floor(a)+Math.floor(e)*MAP_W)+3]}
function addEntity(a,e){ex[numEnts]=a;ey[numEnts]=e;xs[numEnts]=0;ys[numEnts]=0;rot[numEnts]=0;odo[numEnts]=0;spd[numEnts]=MINSPD+Math.random()*(MAXSPD-MINSPD);rod[numEnts]=Math.floor(Math.random()*(roads.length-1));per[numEnts]=Math.random();seg[numEnts]=Math.floor(Math.random()*(roads[rod[numEnts]].length-2));dir[numEnts]=.5>Math.random()?FWD:REV;var c=curves.randomItem().randomItem();c=getQuadraticBezierXYatPercent(c.startxy,c.ctrlxy,c.endxy,Math.random());ex[numEnts]=c.x;ey[numEnts]=c.y;xs[numEnts]=
8*Math.random()-4;ys[numEnts]=8*Math.random()-4;spr[numEnts]=numEnts%NUM_VEHICLE_SPRITES;numEnts++}function onclick(a){a.preventDefault()}function onmouseup(a){brakePedalDown=gasPedalDown=mouseIsDown=!1;a.preventDefault()}
function onmousedown(a){a.preventDefault();mouseX=a.clientX;mouseY=a.clientY;mouseIsDown=!0;1<a.which?(gasPedalDown=!1,brakePedalDown=!0):(gasPedalDown=!0,brakePedalDown=!1);mouseWorldX=Math.round(mouseX+camX);mouseWorldY=Math.round(mouseY+camY);console.log("click "+mouseX+","+mouseY);menuActive&&(menuActive=!1,console.log("menu clicked! starting game!"));collides(mouseX+camX,mouseY+camY)&&console.log("You clicked the road!");USE_MOTOR_SOUND&&!motorSound&&initEngineSound();USE_MUSIC&&!music&&(console.log("init music"),
music=document.getElementById("engineloop"),LOOP_MUSIC&&music.addEventListener("timeupdate",function(){this.currentTime>this.duration-.1&&(this.currentTime=.15,this.play())}),music.play())}function onmove(a){mouseX=a.clientX;mouseY=a.clientY;mouseWorldX=Math.round(mouseX+camX);mouseWorldY=Math.round(mouseY+camY)}
function update(){framecount++;var a=gameCanvas.width,e=gameCanvas.height;mouseWorldX=Math.round(mouseX+camX);mouseWorldY=Math.round(mouseY+camY);for(var c=0;c<numEnts;c++)if(c==PLAYERID){if(!menuActive){var d=ex[c];var f=ey[c];rot[c]=Math.atan2(mouseWorldY-ey[c],mouseWorldX-ex[c]);var g=Math.hypot(mouseWorldX-ex[c],mouseWorldY-ey[c]);spd[c]=gasPedalDown?Math.min(spd[c]+PLAYER_ACCEL,PLAYER_MAXSPD):brakePedalDown?Math.max(spd[c]+PLAYER_BRAKES,0):Math.max(spd[c]+PLAYER_COAST,0);motorSound&&motorSound.setSpeed(spd[c]*
MOTOR_SOUND_SPEED_SCALE);ex[c]+=spd[c]*Math.cos(rot[c]);ey[c]+=spd[c]*Math.sin(rot[c]);if(crashed=!collides(ex[c],ey[c]))collides(ex[c],f)?ey[c]=f:collides(d,ey[c])?ex[c]=d:(DEBUG_PLAYER&&console.log("boom!"),spd[c]=0,ex[c]=d,ey[c]=f);DEBUG_PLAYER&&console.log("Player pos:"+ex[c].toFixed(0)+","+ey[c].toFixed(0)+" rot:"+rot[c].toFixed(2)+" spd:"+spd[c].toFixed(2)+" mouse:"+mouseWorldX+","+mouseWorldY+" dist:"+g.toFixed(1));menuActive||(camX=ex[PLAYERID]-a/2,camY=ey[PLAYERID]-e/2)}}else{f=rod[c];g=
seg[c];(d=curves[f][g])&&d.startxy||console.log("missing curve for rod "+(f+1)+"/"+roads.length+" seg "+(g+1)+"/"+curves[f].length);var h=approxBezierLength(d.startxy,d.ctrlxy,d.endxy);if(isNaN(h)||!h)h=999.99;var m=1/h,n=m*spd[c]*dir[c];per[c]+=n;if(0>per[c]||1<=per[c])if(dir[c]==FWD&&(per[c]=0,seg[c]++),dir[c]==REV&&(per[c]=1,seg[c]--),0>seg[c]||seg[c]>curves[f].length-1)DEBUGTRUCKAI&&console.log("seg "+(seg[c]+1)+"/"+curves[f].length+" is past end of road "+(f+1)+"/"+roads.length),dir[c]==FWD?
(DEBUGTRUCKAI&&console.log("truck "+c+" REVERSING!"),dir[c]=REV,--seg[c]):(DEBUGTRUCKAI&&console.log("truck "+c+" FORWARDING!"),dir[c]=FWD,seg[c]+=1);DEBUGTRUCKAI&&console.log("truck "+(c+1)+" is "+per[c].toFixed(2)+"% of road "+(f+1)+"/"+roads.length+" curve "+(g+1)+"/"+curves[f].length+" length:"+h.toFixed(2)+" spd[i]"+spd[c].toFixed(2)+" percentPerPixel:"+m.toFixed(2)+" percentTravelled:"+n.toFixed(2));d||console.log("ERROR: missing curve! myroad:"+f+" segment:"+g);f=getQuadraticBezierXYatPercent(d.startxy,
d.ctrlxy,d.endxy,per[c]);d=getQuadraticBezierXYatPercent(d.startxy,d.ctrlxy,d.endxy,per[c]+.1);d=Math.atan2(d.y-f.y,d.x-f.x);rot[c]=d;d+=(dir[c]==FWD?90:-90)*DEG2RAD;f.x+=5*Math.cos(d);f.y+=5*Math.sin(d);ex[c]=f.x;ey[c]=f.y}}function approxBezierLength(a,e,c){var d=0,f=0;for(chunk=0;10>chunk;chunk++){var g=getQuadraticBezierXYatPercent(a,e,c,chunk/10);d&&(d=Math.hypot(d.x-g.x,d.y-g.y),f+=d);d=g}return f}
function render(){gameCTX.fillStyle=waterRGBA;gameCTX.fillRect(0,0,gameCanvas.width,gameCanvas.height);drawCachedMap();if(STRESSTESTNUM)for(var a=0;a<STRESSTESTNUM;a++)x=Math.round(Math.random()*gameCanvas.width),y=Math.round(Math.random()*gameCanvas.height),num=Math.floor(8*Math.random()),u=num*SPR_W,v=0,gameCTX.drawImage(sprites,u,v,SPR_W,SPR_H,x,y,SPR_W,SPR_H);for(a=0;a<numEnts;a++)u=spr[a]*SPR_W,v=0,gameCTX.setTransform(1,0,0,1,ex[a]-camX,ey[a]-camY),gameCTX.rotate(rot[a]),gameCTX.drawImage(sprites,
u,v,SPR_W,SPR_H,-SPR_W/2,-SPR_H/2,SPR_W,SPR_H);gameCTX.setTransform(1,0,0,1,0,0);drawMiniMap();menuActive&&drawMenu()}function animate(a){update(a);render(a);requestAnimationFrame(animate)}var roads=[],curves=[];
function generatemap(){console.log("generatemap! numroads:"+numroads);var a,e=0;for(a=0;a<numroads;a++){roads[a]=[];var c=Math.round(MAP_W/2);var d=Math.round(MAP_H/2);for(var f=0;f<numturns;f++){c+=(.5>Math.random()?1:-1)*(1+Math.round(4*Math.random())*grid);d+=(.5>Math.random()?1:-1)*(1+Math.round(4*Math.random())*grid);c>MAP_W-100&&(c=MAP_W-100);100>c&&(c=100);d>MAP_H-100&&(d=MAP_H-100);100>d&&(d=100);if(0==f||f==numturns-1)0==a%3?(c=c>MAP_W/2?-grid:MAP_W+grid,d=d>MAP_H/2?-grid:MAP_H+grid):1==
a%3?(c=c<MAP_W/2?-grid:MAP_W+grid,d=d<MAP_H/2?-grid:MAP_H+grid):(c=MAP_W/2,d=MAP_H/2);roads[a][f]={x:c,y:d};e++}curves[a]=drawcurve(roads[a],null,!0)}console.log("generated map with "+roads.length+" roads and "+e+" curves.")}function drawCachedMap(){gameCTX.drawImage(mapCanvas,camX,camY,gameCanvas.width,gameCanvas.height,0,0,gameCanvas.width,gameCanvas.height)}
function drawMiniMap(){gameCTX.fillStyle=waterRGBA;gameCTX.fillRect(0,gameCanvas.height-minimapH,gameCanvas.width,minimapH);gameCTX.drawImage(mapCanvas,0,gameCanvas.height-minimapH,gameCanvas.width,minimapH)}
function drawmap(){console.log("Rendering city map! Roads:"+roads.length);var a,e=roads.length;for(a=0;a<e;a++)mapCTX.beginPath(),drawcurve(roads[a]),mapCTX.setLineDash([]),mapCTX.lineWidth=450,mapCTX.strokeStyle="rgba(10,26,50,1)",mapCTX.stroke();for(a=0;a<e;a++)mapCTX.beginPath(),drawcurve(roads[a]),mapCTX.setLineDash([]),mapCTX.lineWidth=400,mapCTX.strokeStyle="rgba(70,80,70,1)",mapCTX.stroke();decorateRoadsides();for(a=0;a<e;a++)mapCTX.beginPath(),drawcurve(roads[a]),mapCTX.lineWidth=58,mapCTX.strokeStyle=
"rgba(100,90,90,1)",mapCTX.setLineDash([]),mapCTX.stroke(),mapCTX.lineWidth=54,mapCTX.strokeStyle="rgba(120,100,100,1)",mapCTX.setLineDash([20,2]),mapCTX.stroke();for(a=0;a<e;a++)mapCTX.setLineDash([]),mapCTX.beginPath(),drawcurve(roads[a]),mapCTX.strokeStyle="rgba(80,80,80,1)",mapCTX.lineWidth=24,mapCTX.stroke();for(a=0;a<e;a++)mapCTX.setLineDash([]),mapCTX.beginPath(),drawcurve(roads[a]),mapCTX.strokeStyle="rgba(25,25,30,1)",mapCTX.lineWidth=20,mapCTX.stroke(),collideCTX.beginPath(),drawcurve(roads[a],
collideCTX),collideCTX.strokeStyle="rgba(25,25,30,1)",collideCTX.lineWidth=20,collideCTX.stroke();for(a=0;a<e;a++)mapCTX.beginPath(),drawcurve(roads[a]),mapCTX.setLineDash([10,20]),mapCTX.strokeStyle="rgba(100,80,40,1)",mapCTX.lineWidth=2,mapCTX.stroke();collisionData=collideCTX.getImageData(0,0,MAP_W,MAP_H).data}
function decorateRoadsides(a,e,c,d,f){a=void 0===a?-1:a;e=void 0===e?25:e;c=void 0===c?10:c;d=void 0===d?64:d;for(f=0;f<curves.length;f++)for(var g=0;g<curves[f].length;g++){var h=curves[f][g],m=approxBezierLength(h.startxy,h.ctrlxy,h.endxy);if(!isNaN(m))for(var n=m/25,t=1/n,k,l,p,q,r=0;r<n;r++)k=r*t,l=getQuadraticBezierXYatPercent(h.startxy,h.ctrlxy,h.endxy,k),k=getQuadraticBezierXYatPercent(h.startxy,h.ctrlxy,h.endxy,k+.1),k=Math.atan2(l.y-k.y,l.x-k.x),k+=(r%2?90:-90)*DEG2RAD,l.x+=e*Math.cos(k),
l.y+=e*Math.sin(k),p=c+Math.random()*(d-c),q=c+Math.random()*(d-c),l.x+=Math.max(p,q)*Math.cos(k),l.y+=Math.max(p,q)*Math.sin(k),mapCTX.setTransform(1,0,0,1,l.x,l.y),mapCTX.rotate(k),-1==a?(m>c&&(mapCTX.fillStyle=BUILDING_RGBA),mapCTX.fillRect(-p/2,-q/2,p,q)):(mapCTX.globalAlpha=1,u=a*SPR_W,v=0,mapCTX.drawImage(sprites,u,v,SPR_W,SPR_H,-SPR_W/2,-SPR_H/2,SPR_W,SPR_H)),mapCTX.setTransform(1,0,0,1,0,0)}}
function generateTraffic(){console.log("generating traffic: "+trafficCount);for(var a=0;a<trafficCount;a++)addEntity(0,0)}function startgame(){console.log("initialized!");generatemap();drawmap();generateTraffic();animate()}function resize(){console.log("resizing canvas...");gameCanvas.width=window.innerWidth;gameCanvas.height=window.innerHeight}
function onload(){console.log("initializing...");gameCanvas=document.getElementById("gameCanvas");gameCTX=gameCanvas.getContext("2d");mapCanvas=document.createElement("canvas");mapCanvas.width=MAP_W;mapCanvas.height=MAP_H;mapCTX=mapCanvas.getContext("2d");collideCanvas=document.createElement("canvas");collideCanvas.width=MAP_W;collideCanvas.height=MAP_H;collideCTX=collideCanvas.getContext("2d");resize();sprites=new Image;sprites.onload=startgame;sprites.src="js13k.png"}
function drawcurve(a,e,c){e=void 0===e?mapCTX:e;c=void 0===c?!1:c;var d=[];if(a&&!(2>a.length)){if(2==a.length)return console.log("straighaway!"),c||(e.moveTo(a[0].x,a[0].y),e.lineTo(a[1].x,a[1].y)),d;c||e.moveTo(a[0].x,a[0].y);for(var f=1;f<a.length-1;f++){var g=(a[f].x+a[f+1].x)/2,h=(a[f].y+a[f+1].y)/2;c||e.quadraticCurveTo(g,h,a[f].x,a[f].y);d.push({startxy:{x:a[f-1].x,y:a[f-1].y},ctrlxy:{x:g,y:h},endxy:{x:a[f].x,y:a[f].y}})}LOOP_ROADS&&(g=(a[f].x+a[0].x)/2,h=(a[f].y+a[0].y)/2,c||e.quadraticCurveTo(g,
h,a[0].x,a[0].y),d.push({startxy:{x:a[f+1].x,y:a[f+1].y},ctrlxy:{x:g,y:h},endxy:{x:a[0].x,y:a[0].y}}));if(c)return d}}function roadcurves(a){for(var e=[],c=a.length,d=1;d<c;d++)e.push({startxy:{x:a[d-1].x,y:a[d-1].y},endxy:{x:a[d].x,y:a[d].y},ctrlxy:{x:(a[d].x+a[d+1].x)/2,y:(a[d].y+a[d+1].y)/2}});return e}function getQuadraticBezierXYatPercent(a,e,c,d){return{x:Math.pow(1-d,2)*a.x+2*(1-d)*d*e.x+Math.pow(d,2)*c.x,y:Math.pow(1-d,2)*a.y+2*(1-d)*d*e.y+Math.pow(d,2)*c.y}}
function quadraticBezierLength(a,e,c,d,f,g){c*=2;d*=2;f=a-c+f;g=e-d+g;c-=2*a;d-=2*e;a=e=4*(f*f+g*g);a+=b=4*(f*c+g*d);a+=f=c*c+d*d;a=2*Math.sqrt(a);c=2*e*(g=Math.sqrt(e));d=b/g;e=4*f*e-b*b;f=2*Math.sqrt(f);return(c*a+g*b*(a-f)+e*Math.log((2*g+d+a)/(d+f)))/(4*c)}
function quadraticBezierLength2(a,e,c){var d=a.x-2*e.x+c.x,f=a.y-2*e.y+c.y;c=2*e.x-2*a.x;e=2*e.y-2*a.y;a=4*(d*d+f*f);d=4*(d*c+f*e);c=c*c+e*e;f=2*Math.sqrt(a+d+c);e=Math.sqrt(a);var g=2*a*e,h=2*Math.sqrt(c),m=d/e;return(g*f+e*d*(f-h)+(4*c*a-d*d)*Math.log((2*e+m+f)/(m+h)))/(4*g)}var motorSound;
function initEngineSound(){console.log("init engine sound");var a=new (window.AudioContext||window.webkitAudioContext);motorSound=new MotorSound(a,new LinearGenerator);motorSound.setSpeed(.5);motorSound.setVolume(.2);motorSound.regenerate();motorSound.start()}
var MotorSound=function(a,e){this.currentFrame=0;this.context=a;this.speed=.6;this.isPlaying=!1;this.generator=e;this.scriptNode=a.createScriptProcessor(1024);this.scriptNode.onaudioprocess=this.process.bind(this);this.gainNode=a.createGain();this.gainNode.gain.value=.5;this.scriptNode.connect(this.gainNode);this.regenerate()};MotorSound.prototype.start=function(){this.gainNode.connect(this.context.destination)};MotorSound.prototype.stop=function(){this.gainNode.disconnect(this.context.destination)};
MotorSound.prototype.regenerate=function(){this.data=this.generator.generate()};MotorSound.prototype.setVolume=function(a){this.gainNode.gain.value=a};MotorSound.prototype.setGenerator=function(a){this.generator=a;this.regenerate()};MotorSound.prototype.setSpeed=function(a){this.speed=a};
MotorSound.prototype.process=function(a){a=a.outputBuffer.getChannelData(0);for(var e,c=0;c<a.length;++c)this.currentFrame+=this.speed,e=Math.floor(this.currentFrame)%this.data.length,a[c]=this.data[e];this.currentFrame%=this.data.length};var LinearGenerator=function(){this.dataLength=1024};LinearGenerator.prototype.pushLinear=function(a,e,c){var d=a.length-1,f=a.pop();c-=d;e=(e-f)/c;for(d=0;d<c;d++)a.push(f+e*d);return a};
LinearGenerator.prototype.generate=function(){var a=[];a.push(1);for(var e=.05;1>e;e+=Math.random()/8+.01){var c=Math.floor(e*this.dataLength);var d=2*Math.random()-1;this.pushLinear(a,d,c)}this.pushLinear(a,1,this.dataLength);return a};