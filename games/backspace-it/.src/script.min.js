zzfx_v=.5,zzfx_x=new AudioContext,zzfx=(t,e,s,i=1,n=.1,h=0,o=0,a=0,r=0)=>{let c=44100,l=Math.PI;s*=2*l/c,s*=1+e*(2*Math.random()-1),h*=1e3*l/c**2,n*=0|(i=0<i?c*(10<i?10:i)|0:1),a*=2*l/c,r*=l,e=[];for(var u=0,d=0,p=0;p<i;++p)e[p]=t*zzfx_v*Math.cos(u*s*Math.cos(d*a+r))*(p<n?p/n:1-(p-n)/(i-n)),u+=1+o*(2*Math.random()-1),d+=1+o*(2*Math.random()-1),s+=h;return t=zzfx_x.createBuffer(1,i,c),s=zzfx_x.createBufferSource(),t.getChannelData(0).set(e),s.buffer=t,s.connect(zzfx_x.destination),s.start(),s},function(){"use strict";function t(){return window.performance&&window.performance.now?window.performance.now():Date.now()}function e(t){return t.charAt(Math.floor(Math.random()*t.length))}function s(t,s){let i="";for(var n=0;n<t;n++)i+=e(s);return i}function i(t,e,s,i){s=s||1,i=i||e.sprite;const n=e.scale||1;t.setTransform(n/s,0,0,n/s,e.x/s,e.y/s),i.render(t,[e.w,e.h]),t.setTransform(1,0,0,1,0,0)}const n={},h=[];function o(t){if(n[t])return n[t];{const e=new Image;e.onload=function(){n[t]=e,a()&&h.forEach(function(t){t()})},n[t]=!1,e.src=t}}function a(){let t=!0;for(var e in n)n.hasOwnProperty(e)&&!n[e]&&(t=!1);return t}const r={load:function(t){t instanceof Array?t.forEach(function(t){o(t)}):o(t)},get:function(t){return n[t]},onReady:function(t){h.push(t)},isReady:a};function c(t,e,s,i,n,h,o){this.pos=e,this.size=s,this.speed="number"==typeof i?i:0,this.frames=n,this._index=0,this.url=t,this.dir=h||"horizontal",this.once=o}c.prototype={update:function(t){this._index+=this.speed*t},render:function(t,e){var s;if(e=e||this.size,this.speed>0){var i=this.frames.length,n=Math.floor(this._index);if(s=this.frames[n%i],this.once&&n>=i)return void(this.done=!0)}else s=0;var h=this.pos[0],o=this.pos[1];"vertical"==this.dir?o+=s*this.size[1]:h+=s*this.size[0],t.drawImage(r.get(this.url),h,o,this.size[0],this.size[1],0,0,e[0],e[1])}};const l={};function u(t,e,s,i,n,h){this.x=e,this.y=s,this.w=i,this.h=n,this.state=h,this.sprites=t}function d(t){this.canvas=t.canvas,this.scoreEl=t.scoreEl,this.levelEl=t.levelEl,this.bestScoreEl=t.bestScoreEl,this.luckyStringEl=t.luckyStringEl,this.backspaceButtonEl=t.backspaceButtonEl,this.escButtonEl=t.escButtonEl,this.ctx=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.canvasRect=this.canvas.getBoundingClientRect(),this.db="erwBckspcKyDb",this.tileSize=48,this.rows=8,this.cols=8,this.charList="ABCDEFGHIJKLMNOPQRSTUVWXYZ",this.specialChars="*+-/\\?",this.board=new Array(this.rows*this.cols),this.lastAdd=0,this.speed=.8,this.level=1,this.toNextLevel=10,this.score=0,this.scorePerTile=1,this.bestScore=0,this.specialcharSpawnRate=1/(this.rows*this.cols),this.luckyString=null,this.luckyStringFound=0,this.luckyStringBaseLength=3,this.lastTime,this.aId,this.cursorAt=[0,0],this.backspacePressed=!1,this.pauseButtonPressed=!1,this.scene="load",this.font={w:16,h:16,sprites:[],spritesSpecial:[]},this.startButton=new u([new c("button-sprite.png",[0,0],[64,32]),new c("button-sprite.png",[64,0],[64,32])],this.width/2-48,this.height/2-24,96,48,0),this.escButton=new u([new c("button-sprite.png",[0,96],[32,32]),new c("button-sprite.png",[32,96],[32,32])],this.width/2-64,this.height/2-24,48,48,0),this.exitButton=new u([new c("button-sprite.png",[0,32],[64,32]),new c("button-sprite.png",[64,32],[64,32])],this.width/2+16,this.height/2-24,96,48,0),this.shareButton=new u([new c("button-sprite.png",[0,64],[64,32]),new c("button-sprite.png",[64,64],[64,32])],this.width/2-112,this.height/2-24,96,48,0),this.gameOverText={w:192,h:48},this.gameOverText.x=this.width/2-this.gameOverText.w/2,this.gameOverText.y=96,this.gameOverText.sprite=new c("text.png",[0,0],[192,48]),this.pauseText={w:192,h:48},this.pauseText.x=this.width/2-this.pauseText.w/2,this.pauseText.y=96,this.pauseText.sprite=new c("text.png",[0,48],[192,48])}l.LEFT=37,l.RIGHT=39,l.UP=38,l.DOWN=40,l.BACKSPACE=8,l.ESC=27,l._keys={},l.listenForEvents=function(t){window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keyup",this._onKeyUp.bind(this)),t.forEach(function(t){this._keys[t]=!1}.bind(this))},l._onKeyDown=function(t){var e=t.keyCode;e in this._keys&&(t.preventDefault(),this._keys[e]=!0)},l._onKeyUp=function(t){var e=t.keyCode;e in this._keys&&(t.preventDefault(),this._keys[e]=!1)},l.isDown=function(t){if(!t in this._keys)throw new Error("Keycode "+t+" is not being listened to");return this._keys[t]},u.prototype={hover:function(t){return t[0]>this.x&&t[0]<this.x+this.w&&t[1]>this.y&&t[1]<this.y+this.h},sound:function(){zzfx(.5,.1,1549,.1,0,0,1.2,48.9,.17)},setState:function(t){1===t&&zzfx(.5,.1,1549,.1,0,0,1.2,48.9,.17),this.state=t},render:function(t){i(t,this,1,this.sprites[this.state])}},d.prototype={loadFontSprite:function(){for(let t=0;t<this.charList.length;t++)this.font.sprites.push(new c("font.png",[16*t,0],[16,16]));for(let t=0;t<this.specialChars.length;t++)this.font.spritesSpecial.push(new c("font.png",[16*t,16],[16,16]))},fillRandomTile:function(){const t=[];for(let e=this.board.length-1;e>=0;e--)this.board[e]||t.push(e);if(0===t.length)return;const s=Math.floor(Math.random()*t.length);let i=Math.random()<this.specialcharSpawnRate?this.specialChars:this.charList;this.board[t[s]]=e(i)},countEmptyTiles:function(){let t=0;for(let e=this.board.length-1;e>=0;e--)!this.board[e]&&t++;return t},getTileIndex:function(t,e){return e*this.cols+t},getTileValue:function(t,e){return this.board[this.getTileIndex(t,e)]},getTileCoordsFromPoint:function(t,e){return[~~(t/this.tileSize),~~(e/this.tileSize)]},getTileCoordsByIndex:function(t){return[t%this.cols,Math.floor(t/this.rows)]},clearRow:function(t){for(let e=0;e<this.cols;e++)this.board[this.getTileIndex(e,t)]&&(this.score+=this.scorePerTile,this.board[this.getTileIndex(e,t)]=null)},clearCol:function(t){for(let e=0;e<this.cols;e++)this.board[this.getTileIndex(t,e)]&&(this.score+=this.scorePerTile,this.board[this.getTileIndex(t,e)]=null)},clearSlash:function(t){const e=Math.max(0,t[0]+t[1]-(this.cols-1)),s=Math.min(t[0]+t[1],this.rows-1),i=[e,s],n=[s,e];for(;i[0]<=n[0]&&i[1]>=n[1];){const t=this.getTileIndex(i[0],i[1]);this.board[t]&&(this.board[t]=null,this.score+=this.scorePerTile),i[0]+=1,i[1]-=1}},clearBackSlash:function(t){const e=Math.max(0,t[0]-t[1]),s=Math.max(0,t[1]-t[0]),i=[e,s],n=[this.cols-1-s,this.rows-1-e];for(;i[0]<=n[0]&&i[1]<=n[1];){const t=this.getTileIndex(i[0],i[1]);this.board[t]&&(this.board[t]=null,this.score+=this.scorePerTile),i[0]+=1,i[1]+=1}},applySpecialEffect:function(t){let e=this.board[t];switch("?"===e&&(e=this.specialChars[Math.floor(Math.random()*(this.specialChars.length-1))]),e){case"-":this.clearRow(this.cursorAt[1]),zzfx(1,.1,615,.2,.39,1.7,2.9,0,.07);break;case"+":this.clearRow(this.cursorAt[1]),this.clearCol(this.cursorAt[0]),zzfx(1,.1,674,.2,.19,2.7,1,4.1,.71);break;case"/":this.clearSlash(this.cursorAt),zzfx(1,.1,1302,.3,.13,.1,4.1,23.6,.45);break;case"\\":this.clearBackSlash(this.cursorAt),zzfx(1,.1,958,.3,.63,9.2,2.7,70.2,.15);break;case"*":this.clearRow(this.cursorAt[1]),this.clearCol(this.cursorAt[0]),this.clearSlash(this.cursorAt),this.clearBackSlash(this.cursorAt),zzfx(1,.1,9,.8,.17,6.3,.9,8.3,.2);break;default:this.board[t]=null}},backspace:function(){const t=this.getTileIndex(this.cursorAt[0],this.cursorAt[1]);this.board[t]&&(this.applySpecialEffect(t),this.displayUpdatedValue(this.score+=this.scorePerTile,this.scoreEl),this.toNextLevel--,this.toNextLevel<=0&&(this.displayUpdatedValue(this.level++,this.levelEl),this.toNextLevel=10),zzfx(1,.1,1363,.3,0,.1,3.2,0,.85))},searchLuckyString:function(){let t=[],e=0;for(let i=0;i<this.board.length;i++){if(this.board[i]===this.luckyString[e]?(t.push(i),e++):(e=0,t=[]),t.length===this.luckyString.length){for(let e=0;e<t.length;e++)this.board[t[e]]=null;this.luckyStringFound++,this.displayUpdatedValue(this.score+=35*(this.luckyStringFound+1),this.scoreEl),this.displayUpdatedValue(this.luckyString=s(this.luckyStringBaseLength+this.luckyStringFound,this.charList),this.luckyStringEl),zzfx(1,.1,29,.9,.29,.3,0,13,.69)}}},displayUpdatedValue:function(t,e){e.innerHTML=t},update:function(t){switch(this.scene){case"load":this.loaded&&(this.scene="menu");break;case"menu":case"gameover":break;case"playing":if(0===this.countEmptyTiles())return this.scene="gameover",this.score>this.bestScore&&(this.displayUpdatedValue(this.bestScore=this.score,this.bestScoreEl),localStorage.setItem(this.db,this.bestScore)),void zzfx(1,.1,153,1.7,.13,.2,.7,4.2,.06);if(l.isDown(l.ESC))return this.pauseButtonPressed||(this.scene="pause"),void(this.pauseButtonPressed=!0);this.pauseButtonPressed=!1,this.lastAdd+=t,this.lastAdd>=this.speed-.05*this.level&&(this.fillRandomTile(),this.searchLuckyString(),this.lastAdd=0,zzfx(.8,.1,190,.05,.06,1.8,.5,0,.31)),l.isDown(l.BACKSPACE)?(this.backspacePressed||this.backspace(),this.backspacePressed=!0):this.backspacePressed=!1;break;case"pause":if(l.isDown(l.ESC))return this.pauseButtonPressed||(this.scene="playing"),void(this.pauseButtonPressed=!0);this.pauseButtonPressed=!1}},render:function(){this.ctx.clearRect(0,0,this.width,this.height);for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){let s=0,n=1,h="#000";t===this.cursorAt[0]&&e===this.cursorAt[1]&&(s=1,n=4,h="#f00");const o=this.getTileValue(t,e),a=t*this.tileSize,r=e*this.tileSize;if(o){const t={x:a+this.tileSize/2-this.font.w/2,y:r+this.tileSize/2-this.font.h/2,w:this.font.w,h:this.font.h};t.sprite=this.specialChars.indexOf(o)>-1?this.font.spritesSpecial[this.specialChars.indexOf(o)]:this.font.sprites[this.charList.indexOf(o)],i(this.ctx,t)}this.ctx.lineWidth=n,this.ctx.strokeStyle=h,this.ctx.strokeRect(a+s,r+s,this.tileSize-n,this.tileSize-n)}if("playing"!==this.scene){this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="#000",this.ctx.font="24px Arial";let t=!1;switch(this.scene){case"loading":t="Loading...";break;case"menu":this.startButton.render(this.ctx);break;case"gameover":this.shareButton.render(this.ctx),this.exitButton.render(this.ctx),i(this.ctx,this.gameOverText);break;case"pause":this.escButton.render(this.ctx),this.exitButton.render(this.ctx),i(this.ctx,this.pauseText)}t&&this.ctx.fillText(t,10,30)}},onMouseDown:function(t){const e=t.changedTouches&&t.changedTouche[0],s=e?e.clientX:t.clientX,i=e?e.clientY:t.clientY,n=s-this.canvasRect.left,h=i-this.canvasRect.top;switch(this.scene){case"menu":this.startButton.hover([n,h])&&this.startButton.setState(1);break;case"pause":this.escButton.hover([n,h])?this.escButton.setState(1):this.exitButton.hover([n,h])&&this.exitButton.setState(1);break;case"gameover":this.shareButton.hover([n,h])?this.shareButton.setState(1):this.exitButton.hover([n,h])&&this.exitButton.setState(1);break;case"playing":this.cursorAt=this.getTileCoordsFromPoint(n,h),zzfx(1.5,.05,1500,.02,.01,2.1,0,0,.31)}},onMouseUp:function(t){const i=t.changedTouches&&t.changedTouche[0],n=i?i.clientX:t.clientX,h=i?i.clientY:t.clientY,o=n-this.canvasRect.left,a=h-this.canvasRect.top;switch(this.startButton.setState(0),this.escButton.setState(0),this.exitButton.setState(0),this.shareButton.setState(0),this.scene){case"menu":if(this.startButton.hover([o,a])){this.luckyStringFound=0,this.displayUpdatedValue(this.level=1,this.levelEl),this.displayUpdatedValue(this.score=0,this.scoreEl);for(let t=this.board.length-1;t>=0;t--)this.board[t]=Math.random()>.15?null:e(this.charList);this.displayUpdatedValue(this.luckyString=s(this.luckyStringBaseLength,this.charList),this.luckyStringEl),this.scene="playing"}break;case"playing":break;case"pause":this.escButton.hover([o,a])?this.scene="playing":this.exitButton.hover([o,a])&&(this.scene="menu");break;case"gameover":this.exitButton.hover([o,a])?this.scene="menu":this.shareButton.hover([o,a])&&window.open("https://twitter.com/intent/tweet?text=I reached level "+this.level+" and scored "+this.score+' points on "Backspace".&hashtags=backspaceItGame,js13kGames&url='+location.href)}},onResize:function(t){this.canvasRect=this.canvas.getBoundingClientRect()},onVisibilityChange:function(t){"playing"===this.scene&&(document.hidden||document.webkitHidden||"blur"==t.type||"visible"!==document.visibilityState)&&(this.scene="pause")},handleEvent:function(t){switch(t.type){case"mousedown":this.onMouseDown(t);break;case"mouseup":this.onMouseUp(t);break;case"resize":this.onResize(t);break;case"visibilitychange":case"blur":case"focus":this.onVisibilityChange(t)}},listen:function(){l.listenForEvents([l.LEFT,l.RIGHT,l.UP,l.DOWN,l.BACKSPACE,l.ESC]),this.escButtonEl.addEventListener("click",function(){"playing"===this.scene?this.scene="pause":"pause"===this.scene&&(this.scene="playing")}.bind(this)),this.backspaceButtonEl.addEventListener("click",function(){"playing"===this.scene&&this.backspace()}.bind(this)),this.canvas.addEventListener("mousedown",this),this.canvas.addEventListener("mouseup",this),document.addEventListener("visibilitychange",this),window.addEventListener("blur",this),window.addEventListener("focus",this),window.addEventListener("resize",this)},load:function(t){r.load(t),r.onReady(function(){this.loaded=!0}.bind(this))},loop:function(){const e=t();let s=e-this.lastTime;s>999?s=1/60:s/=1e3,this.lastTime=e,this.update(s),this.render(),this.aId=window.requestAnimationFrame(this.loop.bind(this))},init:function(){this.loadFontSprite(),this.displayUpdatedValue(this.bestScore=localStorage.getItem(this.db)||0,this.bestScoreEl),this.lastTime=t(),this.listen(),this.loop()}},document.addEventListener("DOMContentLoaded",function(){const t=new d({canvas:document.getElementById("canvas"),levelEl:document.getElementById("display-level"),luckyStringEl:document.getElementById("display-luckystring"),scoreEl:document.getElementById("display-score"),bestScoreEl:document.getElementById("display-bestscore"),backspaceButtonEl:document.getElementById("backspace-button"),escButtonEl:document.getElementById("esc-button")});t.load(["button-sprite.png","font.png","text.png"]),t.init()})}();