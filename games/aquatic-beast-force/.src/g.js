function Bitmap(t,e,i,a){this.image=new Image,this.image.src=t,this.width=e,this.height=i,this.numberOfFrames=a||0,this.currentFrame=0}function Camera(t,e,i,a){this.ctx=t.getContext("2d"),this.scale=a,this.x=e,this.y=i,this.hud=new Bitmap("assets/hud.png",160,16,1),this.gameOver=new Bitmap("assets/game_over.png",160,32,1),this.numbers=new Bitmap("assets/font.png",4,6,10),this.ctx.imageSmoothingEnabled=!1}function Controls(){this.codes={37:"left",39:"right",38:"up",40:"down",32:"shoot"},this.states={left:!1,right:!1,up:!1,down:!1,shoot:!1},document.addEventListener("keydown",this.onKey.bind(this,!0),!1),document.addEventListener("keyup",this.onKey.bind(this,!1),!1)}function GameLoop(){this.frame=this.frame.bind(this),this.lastTime=0,this.callback=function(){}}function random(t){var e=1e4*Math.sin(t);return e-Math.floor(e)}function Player(t,e){this.x=t,this.y=e,this.rotation=0,this.bitmap=new Bitmap("assets/player.png",16,16,4),this.animationTimer=1/24,this.shootTimer=.25,this.shots=10,this.health=100,this.CIRCLE=2*Math.PI,this.type="player",this.shadow=new Shadow(t,e,new Bitmap("assets/shadow_player.png",16,16,2),this,3,3),this.createTiles(0,0),backgroundLayer.push(this.shadow)}function Shadow(t,e,i,a,s,o){this.x=t,this.y=e,this.rotation=0,this.bitmap=i,this.animationTimer=1/12,this.parent=a,this.dx=s,this.dy=o,this.type="shadow"}function Projectile(t,e,i,a){this.x=t,this.y=e,this.direction=i+3*Math.PI/2,this.bitmap=new Bitmap("assets/projectile.png",16,16,1),this.lifeTime=a?.15:.25,this.isHostile=a,this.type="projectile",entities.push(this)}function Enemy(t,e){this.x=t,this.y=e,this.rotation=0,this.bitmap=new Bitmap("assets/enemy.png",16,16,2),this.animationTimer=1/12,this.shootTimer=0,this.CIRCLE=2*Math.PI,this.type="enemy",this.shadow=new Shadow(t,e,new Bitmap("assets/shadow_enemy.png",16,16,1),this,1,1),backgroundLayer.push(this.shadow)}function placeRandomEnemy(){if(player.health>0){var t=2*Math.random()*Math.PI,e=player.x+100*Math.cos(t),i=player.y+100*Math.sin(t);entities.push(new Enemy(e,i))}}function resetGame(){backgroundLayer=[],entities=[],player=new Player(0,0),enemyTimer=0,healthTimer=0,gameOverTimer=.5,enemyCountdown=10,entities.push(player),placeRandomEnemy()}function loadSounds(){var t=new XMLHttpRequest;t.open("GET","assets/shoot.mp3",!0),t.responseType="arraybuffer",t.onload=function(){audioContext.decodeAudioData(t.response,function(t){shootSound=t},function(){})},t.send();var e=new XMLHttpRequest;e.open("GET","assets/explosion.mp3",!0),e.responseType="arraybuffer",e.onload=function(){audioContext.decodeAudioData(e.response,function(t){explosionSound=t},function(){})},e.send()}function playSound(t){try{var e=audioContext.createBufferSource();e.buffer=t,e.connect(audioContext.destination),e.start(0)}catch(i){}}Camera.prototype.render=function(t,e){this.reposition(),this.ctx.clearRect(0,0,canvas.width,canvas.height),this.ctx.translate(canvas.width/2,canvas.height/2);var i=this;t.forEach(function(t){i.draw(t.bitmap,t.x,t.y,t.rotation,t.fixed)}),e.forEach(function(t){i.draw(t.bitmap,t.x,t.y,t.rotation,t.fixed)}),this.ctx.translate(-canvas.width/2,-canvas.height/2),player.health<=0?this.draw(this.gameOver,80,72,0,!0):(this.draw(this.hud,80,136,0,!0),this.drawNum(player.shots.toString(),10,138),this.drawNum(player.health.toString(),116,138))},Camera.prototype.draw=function(t,e,i,a,s){this.ctx.save(),s?this.ctx.translate(e*this.scale,i*this.scale):this.ctx.translate((e-this.x)*this.scale,(i-this.y)*this.scale),this.ctx.rotate(a),this.ctx.drawImage(t.image,t.currentFrame*t.width,0,t.width,t.height,-t.width/2*this.scale,-t.height/2*this.scale,t.width*this.scale,t.height*this.scale),this.ctx.restore()},Camera.prototype.reposition=function(){this.x=player.x,this.y=player.y},Camera.prototype.drawNum=function(t,e,i){for(var a=0,s=0;s<t.length;s++)this.numbers.currentFrame=t[s],this.draw(this.numbers,e+4*a,i,0,!0),a++},Controls.prototype.onKey=function(t,e){var i=this.codes[e.keyCode];"undefined"!=typeof i&&(this.states[i]=t,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation())};var Explosion=function(t,e){this.x=t,this.y=e,this.bitmap=new Bitmap("assets/explosion.png",32,32,8),this.frameTimer=1/12,backgroundLayer.push(this),playSound(explosionSound)};Explosion.prototype.update=function(t,e){this.frameTimer<=0&&(this.frameTimer+=1/12,this.bitmap.currentFrame=this.bitmap.currentFrame+1,this.bitmap.currentFrame>8&&backgroundLayer.splice(backgroundLayer.indexOf(this),1)),this.frameTimer-=e},GameLoop.prototype.start=function(t){this.callback=t,requestAnimationFrame(this.frame)},GameLoop.prototype.frame=function(t){var e=(t-this.lastTime)/1e3;this.lastTime=t,.2>e&&this.callback(e),requestAnimationFrame(this.frame)},Player.prototype.update=function(t,e){(this.health<=0||this.shots<=0)&&(this.health=0,backgroundLayer.splice(backgroundLayer.indexOf(this.shadow),1),entities.splice(entities.indexOf(this),1)),t.left&&(this.rotation=(this.rotation-5*e)%this.CIRCLE),t.right&&(this.rotation=(this.rotation+5*e)%this.CIRCLE),t.up&&this.move(40*e),t.down&&this.move(-40*e),t.shoot&&this.shoot(e),this.animationTimer<=0&&(this.animationTimer+=1/24,this.bitmap.currentFrame=(this.bitmap.currentFrame+1)%this.bitmap.numberOfFrames),this.animationTimer-=e,this.shootTimer>0&&(this.shootTimer-=e)},Player.prototype.createTiles=function(t,e){t=16*Math.floor((t-80)/16),e=16*Math.floor((e-72)/16);for(var i=0;i<=canvas.width/camera.scale/16+1;i++)for(var a=0;a<=canvas.height/camera.scale/16+1;a++){var s=16*Math.floor((t+16*i)/16),o=16*Math.floor((e+16*a)/16);random(s)*random(o)>.5&&new GroundTile(s,o,Math.round(3*Math.random()))}},Player.prototype.move=function(t){var e=Math.cos(this.rotation+3*Math.PI/2)*t,i=Math.sin(this.rotation+3*Math.PI/2)*t;this.x+=e,this.y+=i,this.createTiles(this.x,this.y)},Player.prototype.shoot=function(){this.shootTimer<=0&&this.shots>0&&(this.shootTimer+=.25,new Projectile(this.x,this.y,this.rotation,!1),playSound(shootSound),this.shots--)},Shadow.prototype.update=function(t,e){this.x=this.parent.x+this.dx,this.y=this.parent.y+this.dy,this.rotation=this.parent.rotation,this.animationTimer<=0&&(this.animationTimer+=1/12,this.bitmap.currentFrame=(this.bitmap.currentFrame+1)%this.bitmap.numberOfFrames),this.animationTimer-=e,this.shootTimer>0&&(this.shootTimer-=e)},Projectile.prototype.update=function(t,e){this.lifeTime-=e;var i=this;entities.forEach(function(t){if("projectile"!=t.type&&Math.abs(t.x-i.x)<=8&&Math.abs(t.y-i.y)<=8){if(i.isHostile&&"player"==t.type)return player.health=player.health>10?player.health-10:0,void(i.lifeTime=0);i.isHostile||"enemy"!=t.type||(i.lifeTime=0,new Explosion(i.x,i.y,0),player.shots+=Math.round(7*Math.random()+3),player.shots=player.shots>99?99:player.shots,t.kill())}}),this.lifeTime<=0&&entities.splice(entities.indexOf(this),1);var a=5*Math.cos(this.direction),s=5*Math.sin(this.direction);this.x+=a,this.y+=s};var GroundTile=function(t,e,i){this.x=t,this.y=e,this.rotation=0,this.bitmap=new Bitmap("assets/ground.png",16,16,1),this.bitmap.currentFrame=i;var a=!1;backgroundLayer.forEach(function(i){return i.x==t&&i.y==e?void(a=!0):void 0}),a||backgroundLayer.unshift(this)};Enemy.prototype.update=function(t,e){if(player.health>0){var i=!1;this.rotation=Math.atan2(player.x-this.x,this.y-player.y),Math.abs(this.x-player.x)>10&&(i=!0,this.x+=Math.cos(this.rotation+3*Math.PI/2)*e*10),Math.abs(this.y-player.y)>10&&(i=!0,this.y+=Math.sin(this.rotation+3*Math.PI/2)*e*10);var a=Math.sqrt(Math.pow(player.x-this.x,2)+Math.pow(player.y-this.y,2));70>=a&&(this.shootTimer<=0&&(new Projectile(this.x,this.y,this.rotation,!0),this.shootTimer+=.5,playSound(shootSound)),this.shootTimer-=e),i&&(this.animationTimer<=0&&(this.animationTimer+=1/12,this.bitmap.currentFrame=(this.bitmap.currentFrame+1)%this.bitmap.numberOfFrames),this.animationTimer-=e)}},Enemy.prototype.kill=function(){entities.splice(entities.indexOf(this),1),backgroundLayer.splice(backgroundLayer.indexOf(this.shadow),1)};var canvas=document.getElementById("g"),controls=new Controls,camera=new Camera(canvas,0,0,3),backgroundLayer=[],entities=[],player=new Player(0,0),enemyTimer=0,healthTimer=0,gameOverTimer=.5,enemyCountdown=10,shootSound,explosionSound,audioContext;try{window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=new AudioContext;loadSounds()}catch(e){}entities.push(player),placeRandomEnemy();var loop=new GameLoop;loop.start(function(t){enemyTimer+=t,healthTimer+=t,Math.round(enemyTimer)>=enemyCountdown&&(placeRandomEnemy(),enemyTimer-=enemyCountdown,enemyCountdown>1&&enemyCountdown--),healthTimer>=1&&player.health>0&&(healthTimer--,player.health=player.health>=100?100:player.health+1),player.health<=0&&(controls.states.shoot&&0>=gameOverTimer&&resetGame(),gameOverTimer-=t),backgroundLayer.forEach(function(e){e.update&&e.update(controls.states,t)}),entities.forEach(function(e){e.update(controls.states,t)}),camera.render(backgroundLayer,entities)});