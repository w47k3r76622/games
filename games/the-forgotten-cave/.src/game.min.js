function clampLeft(a,b){return a<b?b:a}function clampRight(a,b){return a>b?b:a}function clamp(a,b,c){return a<b?b:a>c?c:a}function clamp01(a){return clamp(a,0,1)}function id(a){return document.getElementById(a)}function get(a){return document.createElement(a)}function sgn(a){return a?Math.abs(a)/a:1}function tileToWorldSpace(a){return a.mul(TILE_SIZE)}function worldSpaceToTile(a){a=a.mul(1/TILE_SIZE);return new Point(Math.floor(a.x),Math.floor(a.y))}
function Point(a,b){var c=this;c.x=a;c.y=b;c.mul=function(a){return new Point(c.x*a,c.y*a)};c.clamp=function(a,b){return new Point(clamp(c.x,a.x,b.x),clamp(c.y,a.y,b.y))};c.add=function(a){return new Point(c.x+a.x,c.y+a.y)};c.sub=function(a){return new Point(c.x-a.x,c.y-a.y)};c.flat=function(a){return new Point(c.x*a.x,c.y*a.y)};c.angle=function(){return Math.atan2(c.y,c.x)};c.clone=function(){return new Point(c.x,c.y)}}
function Entity(a){var b=this;b.id=Entity.id++;b._def=a;b.position=a.position;b.rotation=0;b.size=Point.from(window.LayersDef[a.gfx].size);b.halfSize=b.size.mul(.5);a.onInit&&a.onInit(b);b.Update=function(c){a.onUpdate(b,c)};b.Render=function(c){for(var d,e=0;e<c.length;e++)d=c[e],d.save(),d.translate(b.position.x+b.halfSize.x,b.position.y+b.halfSize.y),d.rotate(b.rotation*DEG_TO_RAD),d.translate(-b.halfSize.x,-b.halfSize.y),a.onRender(b,d,e),d.restore()}}
function Decoder(a){return a.replace(/\s*/g,"").split(/(\w\d*)/g).filter(Boolean).map(function(a){return Array((parseInt(a.substr(1))||1)+1).join(a[0])}).join("")}function Magnifier(a,b,c){var d=Array(c+1);return a.split(new RegExp("(.{"+b+"})","g")).map(function(a){return a=a.split("").map(function(a){return d.join(a)}).join(""),d.join(a)}).join("")}var DEG_TO_RAD=Math.PI/180,RAD_TO_DEG=1/DEG_TO_RAD;Point.zero=function(){return Point.from(0)};Point.one=function(){return Point.from(1)};
Point.left=function(){return new Point(1,0)};Point.down=function(){return new Point(0,1)};Point.from=function(a,b){return new Point(a,"undefined"==typeof b?a:b)};Entity.id=0;Entity["new"]=function(a,b,c){return(b=b||{}).__proto__=Entity.types[a],EntityManager.Add(new Entity(b),c)};
Entity.types={human:{gfx:"human",position:Point.zero(),onInit:function(a){a.speed=150;a.left=Point.left();a.down=Point.down();a.dir=Point.zero();a.injured=0;a.treasures=0;a.noMovement=!1;a.getBB=function(){return{x:a.position.x+16,y:a.position.y+16,w:TILE_SIZE-32,h:TILE_SIZE-32}}},onUpdate:function(a,b){if(!a.noMovement){var c,d=(a.speed-50*a.injured)*b;var e=c=0;var f=Point.zero(),g=Point.zero(),h=a.position;Keyboard.Keys[Keyboard.Key.Up]>=Keyboard.State.Pressed&&(f=f.sub(a.down.mul(d)),e||(e=1,
a.dir.y=0),--a.dir.y);Keyboard.Keys[Keyboard.Key.Down]>=Keyboard.State.Pressed&&(f=f.add(a.down.mul(d)),e||(e=1,a.dir.y=0),a.dir.y+=1);Keyboard.Keys[Keyboard.Key.Left]>=Keyboard.State.Pressed&&(g=g.sub(a.left.mul(d)),c||(c=1,a.dir.x=0),--a.dir.x);Keyboard.Keys[Keyboard.Key.Right]>=Keyboard.State.Pressed&&(g=g.add(a.left.mul(d)),c||(c=1,a.dir.x=0),a.dir.x+=1);Physics.CollidesWith("map",f.x+16+a.position.x,f.y+16+a.position.y,TILE_SIZE-32,TILE_SIZE-32)||(h=h.add(f));Physics.CollidesWith("map",g.x+16+
a.position.x,g.y+16+a.position.y,TILE_SIZE-32,TILE_SIZE-32)||(h=h.add(g));a.position=h;e!==c&&(e||(a.dir.y=0),c||(a.dir.x=0));a.rotation=a.dir.angle()*RAD_TO_DEG+90}},onRender:function(a,b,c){Layers[a._def.gfx][c]&&b.drawImage(Layers[a._def.gfx][c],0,0,a.size.x,a.size.y,0,0,a.size.x,a.size.y)}},crystal:{gfx:"crystal",position:Point.zero(),onInit:function(a){a.offset=0;a.offsetHelperAngle=0},onUpdate:function(a,b){a.rotation+=50*b;a.offsetHelperAngle+=100*b;a.offset=Math.round(Math.abs(3*Math.sin(a.offsetHelperAngle*
DEG_TO_RAD)));var c=PLAYER.getBB();!a.triggered&&Physics.Collide(c.x,c.y,c.w,c.h,a.position.x+16,a.position.y+16,TILE_SIZE-32,TILE_SIZE-32)&&(EntityManager.Remove(a),PLAYER.treasures++)},onRender:function(a,b,c){c-=a.offset;0>c||Layers[a._def.gfx][c]&&b.drawImage(Layers[a._def.gfx][c],0,0,a.size.x,a.size.y,0,0,a.size.x,a.size.y)}},trap:{gfx:"trap",position:Point.zero(),onInit:function(a){a.triggered=!1},onUpdate:function(a,b){var c=PLAYER.getBB();!a.triggered&&Physics.Collide(c.x,c.y,c.w,c.h,a.position.x+
16,a.position.y+16,TILE_SIZE-32,TILE_SIZE-32)&&(a.triggered=!0,PLAYER.injured++,3<=PLAYER.injured&&(PLAYER.noMovement=!0,id("gameOver").classList.add("show")))},onRender:function(a,b,c){!c&&b.drawImage(Layers[a._def.gfx][a.triggered?1:0],0,0,a.size.x,a.size.y,0,0,a.size.x,a.size.y)}},exit:{gfx:"exit",position:Point.zero(),onUpdate:function(a){var b=PLAYER.getBB();Physics.Collide(b.x,b.y,b.w,b.h,a.position.x+16,a.position.y+16,TILE_SIZE-32,TILE_SIZE-32)&&(PLAYER.noMovement=!0,id("gameWon").classList.add("show"),
id("trap-"+PLAYER.injured).style.display="block",id("treasure").innerText="You got "+PLAYER.treasures+" treasures")},onRender:function(a,b,c){Layers[a._def.gfx][c]&&b.drawImage(Layers[a._def.gfx][c],0,0,a.size.x,a.size.y,0,0,a.size.x,a.size.y)}}};
var GAME_WIDTH=innerWidth,GAME_HEIGHT=innerHeight,GAME_SIZE=new Point(GAME_WIDTH,GAME_HEIGHT),ONE_OVER_GAME_SIZE=new Point(1/GAME_WIDTH,1/GAME_HEIGHT),GFX_SCALE=4,BASE_TILE_SIZE=16,TILE_SIZE=BASE_TILE_SIZE*GFX_SCALE,HALF_TILE_SIZE=TILE_SIZE/2,LayersCount=15,DISTANCE_BETWEEN_LAYERS=7.5,PLAYER;Keyboard={State:{}};Keyboard.State.Up=0;Keyboard.State.Pressed=1;Keyboard.State.Down=2;Keyboard.Key={};Keyboard.Key.Up=87;Keyboard.Key.Left=65;Keyboard.Key.Down=83;Keyboard.Key.Right=68;Keyboard.Key.R=82;
Keyboard.Key.F=70;Keyboard.Keys={};Keyboard._keydown=function(a){a=a.which;Keyboard.Keys[a]||Keyboard.Keys[a]===Keyboard.State.Up||(Keyboard.Keys[a]=Keyboard.State.Up);Keyboard.Keys[a]===Keyboard.State.Pressed&&(Keyboard.Keys[a]=Keyboard.State.Down);Keyboard.Keys[a]===Keyboard.State.Up&&(Keyboard.Keys[a]=Keyboard.State.Pressed)};Keyboard._keyup=function(a){Keyboard.Keys[a.which]=Keyboard.State.Up};
Keyboard.init=function(){document.body.addEventListener("keydown",Keyboard._keydown);document.body.addEventListener("keyup",Keyboard._keyup)};var Mouse=new function(){var a=this;a.position=Point.zero();a.positionFromCenter=Point.zero();a.init=function(){Core.container.addEventListener("mousemove",a.onMouseMove)};a.onMouseMove=function(b){a.position.x=b.pageX;a.position.y=b.pageY;a.positionFromCenter.x=a.position.x-GAME_WIDTH/2;a.positionFromCenter.y=a.position.y-GAME_HEIGHT/2}},LayerToIndex="abcdefghijklmnopqrstuvwxyz";
window.LayersDef={floor:{gfx:"tiles",offset:0,size:TILE_SIZE,layers:1,layersDef:"a"},wallN:{gfx:"tiles",offset:2*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2"},wallS:{gfx:"tiles",offset:2*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:Math.PI},wallE:{gfx:"tiles",offset:2*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:Math.PI/2},wallW:{gfx:"tiles",offset:2*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",
rotation:3*Math.PI/2},wallCornerNW:{gfx:"tiles",offset:3*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2"},wallCornerSE:{gfx:"tiles",offset:3*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:Math.PI},wallCornerSW:{gfx:"tiles",offset:3*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:Math.PI/2},wallInnerCornerSW:{gfx:"tiles",offset:4*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:3*Math.PI/2},wallInnerCornerNW:{gfx:"tiles",
offset:4*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2"},wallInnerCornerSE:{gfx:"tiles",offset:4*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:Math.PI},wallInnerCornerNE:{gfx:"tiles",offset:4*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:Math.PI/2},wallCornerNE:{gfx:"tiles",offset:3*TILE_SIZE,size:TILE_SIZE,layers:10,layersDef:"af2 bg2 ch2 di2 ej2",rotation:3*Math.PI/2},columnHalf:{gfx:"tiles",offset:5*TILE_SIZE,size:TILE_SIZE,
layers:8,layersDef:"a2e bf c3g"},columnFull:{gfx:"tiles",offset:5*TILE_SIZE,size:TILE_SIZE,layers:8,layersDef:"a2e bf c5g d3h"},human:{gfx:"tiles",offset:6*TILE_SIZE,size:TILE_SIZE,layers:6,layersDef:"e4 f2 c4 d2 b2 a"},solidWall:{gfx:"tiles",offset:8*TILE_SIZE,size:TILE_SIZE,layers:1,layersDef:"a15"},trap:{gfx:"tiles",offset:TILE_SIZE,size:TILE_SIZE,layers:2,layersDef:"ab"},crystal:{gfx:"tiles",offset:7*TILE_SIZE,size:TILE_SIZE,layers:6,layersDef:"ad be cf be ad"},exit:{gfx:"tiles",offset:7*TILE_SIZE,
size:TILE_SIZE,layers:6,layersDef:"f"}};
var Layers={},LayersCreator=new function(){this.init=function(b){Object.keys(window.LayersDef).forEach(function(b){Layers[b]=a(window.LayersDef[b])});b()};var a=function(a){for(var b,d,e=[],f=0;f<a.layers;)d=(b=e[e.push(get("canvas"))-1]).getContext("2d"),b.width=a.size,b.height=a.size,b=a.size/2,a.rotation&&(d.save(),d.translate(b,b),d.rotate(a.rotation),d.translate(-b,-b)),d.drawImage(GFX[a.gfx].canvas,a.offset,a.size*f,a.size,a.size,0,0,a.size,a.size),a.rotation&&d.restore(),f++;return Array.prototype.map.call(Decoder(a.layersDef),
function(a){return e[LayerToIndex.indexOf(a)]})}},Camera=new function(){var a=this;a.position=new Point(GAME_WIDTH/2,GAME_HEIGHT/2);a.zoom=800;a.update=function(){a._entity&&(a.position.x=GAME_WIDTH/2-a._entity.position.x,a.position.y=GAME_HEIGHT/2-a._entity.position.y)};a._entity=null;a.follow=function(b){a._entity=b}};
window.GFX_COLOR_TABLE={a:"038|038|038|255",b:"000|000|000|000",c:"003|002|002|255",d:"006|005|004|255",e:"106|075|059|255",f:"127|127|127|255",g:"093|093|093|255",h:"059|059|059|255",i:"058|057|039|255",j:"074|181|101|255",k:"206|180|145|255",l:"173|170|131|255",m:"154|149|101|255",n:"106|075|059|254",o:"059|145|081|255",p:"059|046|039|255",q:"052|041|035|255",r:"046|036|030|255",s:"040|031|026|255",t:"034|026|022|255",u:"028|022|018|255",v:"091|159|173|255",w:"059|108|118|255",x:"009|007|006|255",
y:"015|012|010|255",z:"021|017|014|255",A:"027|021|018|255",B:"034|026|023|255",C:"040|031|027|255",D:"046|035|031|255",E:"052|040|035|255",F:"058|045|039|255",G:"046|036|031|255",H:"000|000|000|000",I:"255|255|255|019",J:"255|255|255|064",K:"255|255|255|090",L:"255|255|255|116",M:"255|255|255|001",N:"255|255|255|056",O:"255|255|255|123",P:"255|255|255|127",Q:"255|255|255|091",R:"255|255|255|055",S:"255|255|255|063",T:"255|255|255|089",U:"255|255|255|115"};
window.GFX={tiles:{w:9*BASE_TILE_SIZE,h:10*BASE_TILE_SIZE,s:GFX_SCALE,canvas:null,ctx:null,pack:"a16b16c32d4e12b48c16a16b16c32d4e12b7e3b38c16a16b16c32d4e12b5e9b34c16a16b5fb4fb5c32d4e12b5e10b33c16a16b6g4b6e16c4e27b5e11b33c16a16b3fbgbh2bgbfb3e16c4e26b5e11b8i4b22c16a16b4gb2h2b2gb4e16c4e25b6e11b7i6b21c16a16b4gb2h2b2gb4e16c4e25b6e11b7i6b12j2b7c16a16b4gb2h2b2gb4e16c4e26b4e12b7i6b12j2b7c16a16b4gb2h2b2gb4e16c4e26b4e11b9i4b22c16a16b3fbgbh2bgbfb3e16c4e26b4e11b35c16a16b6g4b6e16c4e25b6e9b36c16a16b5fb4fb5e16c4e23b10e7b36c16a16b16e16c4e22b15e3b36c16a16b16e10b3e3c4e20b56c16a16b16eb4e4b6ec4e17b59c16b32c32d4e11b97c32d4e11b97c32d4e11b97c32d4e11b8e5b75g2b7e16c4e27b8e6b73gf2gb6e16c4e27b7e7b9k4b60fbgfb6e16c4e27b6e8b8k6b12j2b45fgbfb6e16c4e26b8e6b9k6b11j4b44fbgfb6e16c4e26b8e5b10k6b11j4b44fgbfb6e16c4e24b9e6b11k4b13j2b45gf2gb6e16c4e24b9e6b76g2b7e16c4e22b14e2b86e10be5c4e18b106e2b2e5b4e3c4e18b106eb4e3b8c4e12b128c4e10b114c32d4e10b98c32d4e10b98c32d4e10b98c32d4e10b98e16c4e25b12eb86e16c4e23b13e3b11l4b13j2b55e16c4e22b13e4b8l3m4l3b9j4b54e16c4e22b13e3b8lmlm6lmlb7j6b53e16c4e23b12e3b8lmlm6lmlb7j6b53e16c4e23b13e2b9l10b9j4b54e16c4e23b44j2b55e6b3ne6c4e21b103e2b2eb6e5c4e21b103eb12e3c4e16b2e2b120c4e10b130c4e10b114c32d4e7b101c32d4e7b101c32d4e7b101c32d4e7b101e16c4e22b102e16c4e21b103e16c4e21b15e2b11l6b69e16c4e19b16e3b10lm6lb11o2b55e16c4e19b17e2b11l6b12o2b55e2b3e11c4e19b105e2b3e11c4e18b115e7c4e11be5b118e5c4e10b2e5b123c4e10b130c4e9b131c4e9b115c32d4e5b103c32d4e5b14p3b86c32d4e4b13p2q3p4b82c32d4e3b14pqr3q4pb81e16c4e19b13pqrs3r3qpb81e16c4e18b13pqrst3srqpb82e16c4e17b14pqrstutsrqpb6v2b4v2b11o2b55e16c4e16b15pqrstutsrqpb5vw2vb2vw2vb9o4b54e2b4e9bc4e11b19pqrst4srqpb5vw2vb2vw2vb9o4b61e5b4c4e8b22pqrs5rqpb7v2b4v2b11o2b71c4e6b24pq2r4srqpb99c4e7b24p2q4rqpb100c4e7b26p4q2pb100c4e6b31p3b100c4e4b136c4e4b120c39xyzABCDEFb96c39xyzABCDEFb96c39xyzABCDEFb96c39xyzABCDEFb7p5b84c38xyzABCDEFb8pq4pb83c37xyzABCDEFb8pqr3qpb26o2b55c36xyzABCDEFb8pqrs2rqpb7v8b10o4b54x16c15x6yzABCDEFb9pqr2qpb7vw8vb8o6b53y16c14xy6z3ABCDEFb8pqrqpb8vw8vb8o6b53z16c13xyz6A3B2CDEFb7pq2rqpb9v8b10o4b54u16c12xyzuA5B3C2DE2Fb7p3q2pb28o2b55t16c11xyzutB5C3D2EF2b11p2b86s16c10xyzutC6D3E2Fb101r16c9xyzutCGD5E3F2b102q10b3q3c8xyzutCGqE5F3b104pb4p4b6pc7xyzutCGqpF5b107c38xyzutsrqFb97c38xyzutsrqFb97c38xyzutsrqFb97c38xyzutsrqFb97c38xyzutsrqFb10pb86c37xy2zutsrqFb9pqpb85x16c14x7yz3utsrqFb8pq2pb85y16c13xy7zu4tsrqb9pqpb86z16c12xyz7ut4srq2b9pqpb86u16c11xyzu7ts4rqb12p2b86t16c10xyzut7sr4q2b100s16c9xyzutC2s5rq4b102r10br5c8xyzutCG2r5qb106q2b2q5b4q3c7xyzutCGq8b106pb4p3b8c6xyzutCGqp2b128c6xyzutCGqb114c37xyzutsrqFb98c37xyzutsrqFb98c37xyzutsrqFb98c36xyzutsrq2Fb98c35xyzutsrqF2b99x16c14x5yzutsrqFb101y16c13xy5zutsrqFb14p2b86z16c12xyz6utsrqFb13pqpb86u16c11xyzu6t3srqFb13p2b86t16c10xyzut6s2tsrqFb101s16c9xyzutC2s4r2srqF2b101r6b3r7c8xyzutCG2r4q2rqFb103q2b2qb6q5c7xyzutCGq6F2q2Fb103pb12p3c6xyzutCGqp2F4b2F2b120c5xyzutCGqpb130c5xyzutCGqpb114c36xyzutsrb101c36xyzutsrb101c35xyzu2tsrb101c34xyzut2sr2b101x16c16x2yzuts2rqb102y16c13x3y2zutsr2qb103z16c12xy3z2utsrq3b103u16c11xyz3u2tsrqFb105t16c10xyzu3t3srqFb105s2b3s11c9xyzut3s4rqFb105r2b3r11c8xyzutC3r4qFb115q7c7xyzutCG2bq4Fb118p5c6xyzutCGqb2F5b123c5xyzutCGqpb130c4xyzutCGqpb131c4xyzutCGqpb115c32dxyzutsrqb103x16c10x8yzutsrqb103y16c9xy8zutsrqb104z16c8xyz8utsrqb105u16c7xyzu9tsrqb105t16c6xyzut9srqb106s16c5xyzutC6s3rqb107r16c4xyzutCG6r3qb108q2b4q9bc3xyzutCGq6b119p5b4c2xyzutCGqp2b132cxyzutCGqpb134cxyzutsrqp2b133cxyzutsrqp2b133cxyzutCGqpb134cxyzutCGb136cxyzutCGb88"}};
window.GFX_unpackColorTable=function(){Object.keys(window.GFX_COLOR_TABLE).forEach(function(a){window.GFX_COLOR_TABLE[a]=window.GFX_COLOR_TABLE[a].split("|").map(function(a){return parseInt(a)})})};
window.GFX_unpackGFX=function(a){window.GFX_unpackColorTable();Object.keys(window.GFX).forEach(function(a){a=window.GFX[a];if(a.ctx=(a.canvas=get("canvas")).getContext("2d"),a.canvas.webkitImageSmoothingEnabled=!1,a.canvas.mozImageSmoothingEnabled=!1,a.canvas.imageSmoothingEnabled=!1,a.s=a.s||1,a.canvas.width=a.w*=a.s,a.canvas.height=a.h*=a.s,a.pack){var c=[];Array.prototype.forEach.call(Magnifier(Decoder(a.pack),a.w/a.s,a.s),function(a,b){c.push.apply(c,GFX_COLOR_TABLE[a])});try{a.ctx.putImageData(new ImageData(new Uint8ClampedArray(c),
a.w,a.h),0,0)}catch(e){for(var b=0;b<c.length;b+=4)a.ctx.beginPath(),a.ctx.fillStyle="rgba("+c[b]+", "+c[b+1]+", "+c[b+2]+", "+c[b+3]+")",a.ctx.fillRect(Math.floor(b/4%a.w),Math.floor(b/4/a.w),1,1)}}});a()};
var Physics=new function(){var a=this;a._colliders={};a.AddCollider=function(b,c,d,e,f){a._colliders[b]||(a._colliders[b]=[]);a._colliders[b].push({x:c,y:d,w:e,h:f})};a.CollidesWith=function(b,c,d,e,f){if(!a._colliders[b])return!1;b=a._colliders[b];for(var g=0;g<b.length;g++){var h=b[g];if(a.Collide(h.x,h.y,h.w,h.h,c,d,e,f))return!0}return!1};a.Collide=function(a,c,d,e,f,g,h,l){return a<f+h&&a+d>f&&c<g+l&&c+e>g}},Map=new function(){var a=this;a.rawMapData="ieeeeeeek#iekh...c...pem.gh.....d.....ghd......nfo.glfffo.nfj#lfjieekh.peekiekh..gh....gh.gh..gh..d.pm.gh..gh.......gh..glo.nffffjh..pem.g##iekh......g##h.gh.c..nfj##h.gh....peeeem.gh...........glffffffo...dg#######h..c.gieeeeeem....gh...........gh.....no....glfffffjlffffj".split("");
a.mapData=[];a.mapWidth=13;a.mapHeight=21;a.layers=[];var b={".":"air","#":"solidWall",b:"floor",c:"columnHalf",d:"columnFull",e:"wallN",f:"wallS",g:"wallE",h:"wallW",i:"wallCornerNW",j:"wallCornerSE",k:"wallCornerSW",l:"wallCornerNE",m:"wallInnerCornerNW",n:"wallInnerCornerSE",o:"wallInnerCornerSW",p:"wallInnerCornerNE"};a.init=function(){a.realWidth=a.mapWidth*TILE_SIZE;a.realHeight=a.mapHeight*TILE_SIZE;a.layerOffsetX=(GAME_WIDTH-a.realWidth)/2;a.layerOffsetY=(GAME_HEIGHT-a.realHeight)/2;a.layersHolder=
id("map");a.decodeMap();for(var c=LayersCount+1;c--;)a.renderLayer(c)};a.decodeMap=function(){a.mapData=a.rawMapData.map(function(a){return b[a]})};a.renderLayer=function(c){var d,e=get("img"),f=(d=get("canvas")).getContext("2d");e.style.transform="translateZ("+c*DISTANCE_BETWEEN_LAYERS+"px)";d.width=a.realWidth;d.height=a.realHeight;d.webkitImageSmoothingEnabled=!1;d.mozImageSmoothingEnabled=!1;d.imageSmoothingEnabled=!1;var g=!c;g||--c;a.mapData.forEach(function(d,e){d=g?"floor":d;var h=Math.floor(e%
a.mapWidth)*TILE_SIZE,k=Math.floor(e/a.mapWidth)*TILE_SIZE;c||g||d===b["."]||Physics.AddCollider("map",h,k,TILE_SIZE,TILE_SIZE);Layers[d]&&Layers[d][c]&&f.drawImage(Layers[d][c],h,k,TILE_SIZE,TILE_SIZE)});e.src=d.toDataURL();a.layersHolder.appendChild(e);a.layers[c]=e};a.update=function(c){c=Mouse.positionFromCenter.flat(ONE_OVER_GAME_SIZE.mul(2)).mul(-1);var b=Math.abs(c.x);b=b*(2-b)*sgn(c.x);var e=Math.abs(c.y);e=e*(2-e)*sgn(c.y);a.layersHolder.style.transform="translate3d("+(Camera.position.x+
30*b-HALF_TILE_SIZE)+"px, "+(Camera.position.y+30*e-HALF_TILE_SIZE)+"px, "+Camera.zoom+"px)"}},EntityManager=new function(){var a=this;a._entities=[];a._layersCtx=[];a.Add=function(b,c){return c=c||0,(a._entities[c]=a._entities[c]||[]).push(b),b};a.Remove=function(b){Object.keys(a._entities).map(function(b){return a._entities[b]}).forEach(function(a){var c=a.indexOf(b);-1!==c&&a.splice(c,1)})};a._loop=function(b){Object.keys(a._entities).forEach(function(c){for(var d=0;d<a._entities[c].length;d++)b(a._entities[c][d])})};
a.Update=function(b){a._loop(function(a){a.Update(b)})};a.Render=function(){for(var b=0;b<a._layersCtx.length;b++)a._layersCtx[b].clearRect(0,0,Map.realWidth,Map.realHeight);a._loop(function(b){b.Render(a._layersCtx)})};a.Init=function(b){for(var c,d=id("map"),e=0;e<LayersCount;e++)a._layersCtx.push((c=get("canvas")).getContext("2d")),c.style.transform="translateZ("+e*DISTANCE_BETWEEN_LAYERS+"px)",c.width=Map.realWidth,c.height=Map.realHeight,c.webkitImageSmoothingEnabled=!1,c.mozImageSmoothingEnabled=
!1,c.imageSmoothingEnabled=!1,d.appendChild(c);b()}};Camera.follow(PLAYER=Entity["new"]("human",{position:tileToWorldSpace(new Point(1,2))}));Entity["new"]("trap",{position:tileToWorldSpace(new Point(11,3))});Entity["new"]("trap",{position:tileToWorldSpace(new Point(7,8))});Entity["new"]("trap",{position:tileToWorldSpace(new Point(2,8))});Entity["new"]("crystal",{position:tileToWorldSpace(new Point(11,6))});Entity["new"]("crystal",{position:tileToWorldSpace(new Point(1,6))});
Entity["new"]("crystal",{position:tileToWorldSpace(new Point(2,6))});Entity["new"]("crystal",{position:tileToWorldSpace(new Point(11,11))});Entity["new"]("exit",{position:tileToWorldSpace(new Point(1,18))});Entity["new"]("exit",{position:tileToWorldSpace(new Point(1,19))});
var Core=new function(){var a=this;a.canvases={entities:{canvas:null,ctx:null},ui:{canvas:null,ctx:null}};a.container=null;a.init=function(){a.initCanvases();window.GFX_unpackGFX(function(){Keyboard.init();Mouse.init();LayersCreator.init(function(){Map.init();EntityManager.Init(function(){a.loop()})})})};a.initCanvases=function(){a.container=id("game");Object.keys(a.canvases).forEach(function(b){var c=get("canvas");c.id=b;c.webkitImageSmoothingEnabled=!1;c.mozImageSmoothingEnabled=!1;c.imageSmoothingEnabled=
!1;a.container.appendChild(c);a.canvases[b].ctx=(a.canvases[b].canvas=c).getContext("2d")});var b=function(){Object.keys(a.canvases).forEach(function(b){a.canvases[b].canvas.width=GAME_WIDTH;a.canvases[b].canvas.height=GAME_HEIGHT});a.container.style.width=GAME_WIDTH+"px";a.container.style.height=GAME_HEIGHT+"px"};b();window.addEventListener("resize",b)};a.lsts=null;a.loop=function(){window.requestAnimFrame(a.loop);var b=Date.now();a.lsts||(a.lsts=b);var c=(b-a.lsts)/1E3;a.lsts=b;a.update(c);a.render(c)};
a.update=function(a){EntityManager.Update(a);Camera.update();Map.update(a)};a.render=function(){Object.keys(a.canvases).forEach(function(b){a.canvases[b].ctx.clearRect(0,0,GAME_WIDTH,GAME_HEIGHT)});EntityManager.Render()}};window.addEventListener("load",function(){Core.init()});window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();