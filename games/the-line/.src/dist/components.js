AFRAME.registerComponent("programaticsound",{schema:{type:"string",default:"C"},playSound:function(){this.system.playSound(this.data)},playRandomSound:function(){this.system.playRandomSound()}}),AFRAME.registerComponent("movement",{schema:{target:{type:"vec3"},speed:{type:"number",default:7}},tick:function(t,e){var i=this.el,n=this.data.target,o=this.el.getAttribute("position"),a=new THREE.Vector3(n.x,n.y,n.z),s=a.clone().sub(o).normalize(),r=this.data.speed*e*.001;o.distanceTo(a)>r?this.el.object3D.position.add(s.multiplyScalar(r)):this.moving&&(i.emit("camerareachedtarget","reached"+this.targetId),this.moving=!1)},init:function(){this.targetId="none",this.moving=!1,this.el.addEventListener("teleporteractive",function(t){console.log(t.msg)})}}),AFRAME.registerComponent("teleporter",{schema:{current:{default:!1},targetId:{type:"string",default:"cameraWrapper"}},init:function(){this.system.registerMe(this.el);var s=this;this.active=!1;var t=document.createElement("a-animation");t.setAttribute("mixin","teleporter-anim"),this.el.appendChild(t),this.el.addEventListener("appeared",function(){s.active=!0}),this.el.addEventListener("click",function(){if(!s.data.current&&s.active){var t=s.el,e=s.system.getId(t);t.components.programaticsound.playRandomSound();var i=document.getElementById(s.data.targetId),n=t.getAttribute("position");n=t.object3D.getWorldPosition(n),AFRAME.utils.entity.setComponentProperty(i,"movement.target",n.x+" "+n.y+" "+n.z),i.components.movement.targetId=e,i.components.movement.moving=!0,AFRAME.utils.entity.setComponentProperty(t,"teleporter.current",!0);var o=document.createElement("a-animation");o.setAttribute("mixin","fade-away");var a=document.createElement("a-animation");a.setAttribute("mixin","scale-away"),t.appendChild(a),t.appendChild(o),t.emit("elementclicked",{id:e})}})}}),AFRAME.registerComponent("animator",{schema:{conditionAppear:{type:"string",default:"init"},conditionDisappear:{type:"string",default:"none"},conditionAnimate:{type:"string",default:"none"},animationMixins:{type:"string",default:"none"}},init:function(){var e=this;this.system.registerMe(this.el),"init"==this.data.conditionDisappear&&this.disappear(),"init"==this.data.conditionAppear&&this.appear(),this.el.addEventListener("elementclicked",function(t){e.system.animateNext(t.detail.id)}),this.el.addEventListener("camerareachedtarget",function(t){e.system.animateNext(t.detail)}),this.el.addEventListener("doorOpened",function(t){console.log("doorOpened"+t.detail),e.system.animateNext("doorOpened"+t.detail)})},appear:function(){var t=this.el,e=this.el.object3D.position,i=new THREE.Vector3(0,-3,0),n=e.clone().add(i),o=document.createElement("a-animation");t.getAttribute("text")?(o.setAttribute("mixin","fade-text"),o.setAttribute("from",0),o.setAttribute("to",1)):o.setAttribute("mixin","fade-in");var a=document.createElement("a-animation");a.setAttribute("mixin","show-up"),a.setAttribute("from",AFRAME.utils.coordinates.stringify(n)),a.setAttribute("to",AFRAME.utils.coordinates.stringify(e)),t.appendChild(a),t.appendChild(o),t.emit("appeared")},disappear:function(){var t=this.el,e=this.el.object3D.position,i=new THREE.Vector3(0,-3,0),n=e.clone().add(i),o=document.createElement("a-animation");t.getAttribute("text")?o.setAttribute("mixin","fade-text"):o.setAttribute("mixin","fade-away");var a=document.createElement("a-animation");a.setAttribute("mixin","show-up"),a.setAttribute("from",AFRAME.utils.coordinates.stringify(e)),a.setAttribute("to",AFRAME.utils.coordinates.stringify(n)),t.appendChild(a),t.appendChild(o),t.emit("disappeared")},animate:function(){var t=document.createElement("a-animation");t.setAttribute("mixin",this.data.animationMixins),this.el.appendChild(t)}}),AFRAME.registerComponent("door",{schema:{melody:{type:"string"}},init:function(){this.system.registerMe(this.el),this.colors=["violet","aquamarine","tomato","orange","greenyellow"],this.musicalNotes=["C","D","E","F","G","A","B","A#","G#"],this.tiles=[],this.level=0,this.playing=!1;var t=this,e=document.createElement("a-circle");e.setAttribute("rotation","0 0 180"),e.setAttribute("position","1 3 0"),e.setAttribute("radius","0.4"),e.setAttribute("src","#play"),e.addEventListener("click",function(){t.playMelody(2)}),this.el.appendChild(e),this.startButton=e;for(var i=0;i<3;i++)for(var n=0;n<3;n++){var o=document.createElement("a-plane");o.setAttribute("color",this.getRandomColor()),o.setAttribute("programaticsound",this.musicalNotes[3*i+n]),o.setAttribute("position",i+" "+n+" 0"),o.setAttribute("width","0.8"),o.setAttribute("height","0.8"),o.setAttribute("keytile",""),this.el.appendChild(o),this.tiles.push(o)}},getRandomColor:function(){return this.colors[Math.floor(Math.random()*this.colors.length)]},playMelody:function(t){if(this.startButton.setAttribute("color","white"),!this.playing){this.playing=!0;for(var i=this,n=this.data.melody.length-3+t,e=[],o=0;o<n;o++){var a=this.data.melody.charAt(o),s=this.musicalNotes.indexOf(a);e.push(this.tiles[s])}e.forEach(function(t,e){t.hasLoaded&&setTimeout(function(){t.components.keytile.playSound(),n-1<=e&&(i.playing=!1)},500*e)}),i.system.startListening(i.el,this.data.melody.slice(0,n))}},open:function(){this.startButton.setAttribute("color","chartreuse"),this.el.emit("doorOpened",this.system.getId(this.el)),document.querySelector("a-scene").systems.programaticsound.playRandomSound()},keepClosed:function(){this.startButton.setAttribute("color","red")}}),AFRAME.registerComponent("keytile",{schema:{},init:function(){var t=this;this.color=this.el.getAttribute("color"),this.el.setAttribute("color","white"),this.el.addEventListener("click",function(){t.playSound(),document.querySelector("a-scene").systems.door.registerNote(t.el.components.programaticsound.data)})},playSound:function(){this.el.components.programaticsound.playSound(),this.el.setAttribute("color",this.color);var t=this;setTimeout(function(){t.el.setAttribute("color","white")},500)}}),AFRAME.registerComponent("hole",{schema:{},init:function(){for(var t=0;t<=3;t++)for(var e=0;e<=3;e++)0==t||3==t?this.createCube(t,e):0!=e&&3!=e||this.createCube(t,e)},createCube:function(t,e){var i=document.createElement("a-box");i.setAttribute("position","0 "+(t+.5)+" "+e),i.setAttribute("src","#tile2"),this.el.appendChild(i)}});