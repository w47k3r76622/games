!function(t){var e={};function i(s){if(e[s])return e[s].exports;var a=e[s]={i:s,l:!1,exports:{}};return t[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)i.d(s,a,function(e){return t[e]}.bind(null,a));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";const s=[],a=[],r=[{title:"Line Worker",type:"line",warning:"Points frantically to the right!",reaction:"jumping up"},{title:"Ground Worker",type:"ground",warning:"Yells to watch out for the power surge!",reaction:"stepping forward"}],n=[{type:"surge",name:"power surge",impacts:"line",observedBy:"ground"},{type:"train",name:"freight train",impacts:"ground",observedBy:"line"}];function o(t){for(let e=0;e<s.length;e++)t!==s[e]&&null===s[e].partner&&a.push(new c(t,s[e]).init())}Number.prototype.toTime=function(){var t=new Date(this).toISOString().slice(11,-1).split(/:/g);t.shift();var e=t.pop().split(".");return e[1]=e[1]>=100?e[1]/10:e[1]/10+"0",t.push(e[0]),t.push(e[1]),t.join(":")};class h{constructor(t){this.type=t,this.spawnedAt=Date.now(),this.reactionCutoff=4e3,this.warnedAt=void 0,this.reactedAt=void 0}}class c{constructor(t,e){this.user1=t,this.user2=e,this.users=[this.user1,this.user2],this.startTime=Date.now(),this.clockStart=6e4,this.clockTotal=this.clockStart,this.remainingTime=this.clockTotal,this.tickRate=50,this.ticker=void 0,this.activeHazard=null,this.gameActive=!1}init(){return this.user1.start(this,this.user2,1),this.user2.start(this,this.user1,2),this.updateUserStatus(),this}start(){this.gameActive=!0,this.ticker=this.ticker?this.ticker:setInterval(this.tick.bind(this),this.tickRate),this.updateClients("gameon")}tick(){this.clockTotal-=this.tickRate,this.clockTotal<=0?(clearInterval(this.ticker),this.timeUp()):(this.runHazardSpawner(),this.checkForHazardDeath()),this.gameActive&&(this.remainingTime=this.clockTotal.toTime(),this.updateClients("tick",this.remainingTime))}runHazardSpawner(){50!==Math.floor(100*Math.random())+1||this.activeHazard||(this.activeHazard=new h(n[Math.round(Math.random())]),this.users.forEach(t=>{t.job.type===this.activeHazard.type.observedBy&&this.updateClient(t,"hazard",this.activeHazard)}))}checkForHazardDeath(){this.activeHazard&&(this.activeHazard.spawnedAt+this.activeHazard.reactionCutoff<Date.now()&&!this.activeHazard.reactedAt||this.activeHazard.reactedAt&&this.activeHazard.spawnedAt+this.activeHazard.reactionCutoff<this.activeHazard.reactedAt)&&this.loseGame()}updateUserStatus(){this.user1.isReady&&this.user2.isReady&&this.start(),this.updateClients("users",[this.user1.isReady,this.user2.isReady])}updateClient(t,e,i){t.socket.emit(e,i)}updateClients(t,e){this.users.forEach(i=>{i.socket.emit(t,e)})}sendMessageFromTo(t,e,i){this.activeHazard&&("warning"===t.type&&this.activeHazard.type.observedBy===e.job.type&&(this.activeHazard.warnedAt=Date.now()),"reaction"===t.type&&this.activeHazard.type.impacts===e.job.type&&(this.activeHazard.reactedAt=Date.now(),this.activeHazard.reactedAt<this.activeHazard.spawnedAt+this.activeHazard.reactionCutoff&&(this.updateClients("avoided",""),this.activeHazard=null))),i.socket.emit("msg",t)}timeUp(){this.winGame()}spawnHazard(){}winGame(){this.updateClients("won",""),this.end()}loseGame(){this.updateClients("lose",this.activeHazard),this.end()}end(){var t,e;this.gameActive=!1,clearInterval(this.ticker),t=this.user1,e=this.user2,a.splice(a.indexOf(t.game),1),a.push(new c(t,e).init())}score(){this.user1.guess===SENT_WARNING&&this.user1.warn(this.user1.warning),this.user2.guess===SENT_WARNING&&this.user2.warn(this.user2.warning)}}t.exports={io:t=>{let e;e=new class{constructor(t){this.socket=t,this.game=null,this.partner=null,this.isReady=!1,this.id=0,this.guess=GUESS_NO,this.warningMsg="Oh no!",this.reactGerund="pondering life",this.job=void 0}takeAction(t){t===PLAYER_READY&&(this.isReady=!0,this.game.updateUserStatus()),t===SENT_WARNING&&this.game.sendMessageFromTo(this.warning(),this,this.partner),t===REACTED_TO_WARNING&&this.game.sendMessageFromTo(this.reaction(),this,this.partner)}getJob(){this.partner.job?this.job=r[2+~r.indexOf(this.partner.job)]:this.job=r[Math.round(Math.random())]}start(t,e,i){this.id=i,this.game=t,this.partner=e,this.guess=GUESS_NO,this.isReady=!1,this.getJob(),this.socket.emit("start",{id:i,job:this.job})}end(){this.game=null,this.partner=null,this.guess=GUESS_NO,this.socket.emit("end")}warning(){return{type:"warning",message:this.job.warning.toString()}}reaction(){return{type:"reaction",message:`I've reacted to the warning by ${this.job.reaction}!`}}win(){this.socket.emit("win",this.partner.guess)}lose(){this.socket.emit("lose",this.partner.guess)}draw(){this.socket.emit("draw",this.partner.guess)}}(t),s.push(e),o(e),t.on("disconnect",()=>{!function(t){try{t.game.end(),a.splice(a.indexOf(t.game),1)}catch(t){}s.splice(s.indexOf(t),1)}(e),e.partner&&(e.partner.end(),o(e.partner))}),t.on("action",t=>{e.takeAction(t)}),t.on("minifail",()=>{if(e&&e.game)try{e.game.clockTotal+=2e3}catch(t){}})},stat:(t,e)=>{storage.get("games",0).then(t=>{e.send(`<h1>Games played: ${t}</h1>`)})}}}]);