var io=require("sandbox-io"),gDs=[],lAs=["gY"],hH=1,cC=1500,cD=1500,gI={vB:[],vC:[],gCs:[],vK:[],vX:cC,vY:cD},gY={id:0,vA:"cccccc",vH:"gaia",vG:!1,vB:0};gI.gCs.push(gY);var gH=db("d");"undefined"==typeof gH&&(gH=[]);var l=[],k=[];
io.on("connection",function(a){var b;a.on("b",function(c){if(!b)if(12<c.vH.length)a.emit("c",{g:"name has to be 12 characters or shorter."});else if(3>c.vH.length)a.emit("c",{g:"name has to be 3 characters or longer."});else{var d=hH++;gDs[d]=a;var e=Math.random().toString(36).substring(2);lAs[d]=e;b={id:d,vH:c.vH,vA:fY(d),vG:!0,vB:0};gI.gCs.push(b);pP(b);a.emit("gC",b);a.emit("d",gH);a.emit("l",l);a.emit("k",k);a.emit("lA",{lA:e});fU(a)}});a.on("a",function(c){for(var d=0;d<lAs.length;d++)if(lAs[d]==
c.lA){b=gI.gCs[d];gDs[d]&&gDs[d].disconnect();b.mTil&&(b.mTil<Date.now()?(pP(b),b.mTil=null):a.emit("m",{m:b.mTil-Date.now()}));b.vG=!0;a.emit("gC",b);a.emit("d",gH);a.emit("l",l);a.emit("k",k);fU(a);gDs[d]=a;return}a.emit("c",{g:""})});a.on("h",function(a){var b=Math.floor(gI.vB[a.vI].vE*Math.min(a.lD,100)/100);if(!(0>=b)){gI.vB[a.vI].vE-=b;var e=Math.ceil(fQ(gI.vB[a.vI],gI.vB[a.vJ])/100);gI.vC.push(new fX(a.vI,a.vJ,b,e))}});a.on("disconnect",function(){"undefined"!=typeof b&&(b.vG=!1,gDs[b.id]=
null)})});function pP(a){fS(a,25,150);fS(a,10,50)}function fR(){gI={vB:[],vC:[],gCs:[gY],vX:cC,vY:cD};hH=1;lAs=["gaia"];for(key in gDs)gDs[key]&&gDs[key].disconnect();gDs=[];l=[];k=[];fA()}
function fA(){for(var a=0;50>a;a++)fS(gY,fOI(10,30),fOI(0,100));for(a=0;7>a;a++)l.push({x:fOI(0,gI.vX),y:fOI(0,gI.vY),vA:fYR(100,.1),vT:fOI(300,400),vS:fO(.2,.5)});for(a=0;700>a;a++){var b={x:fOI(0,gI.vX),y:fOI(0,gI.vY),vA:{r:fOI(230,255),g:fOI(250,255),b:fOI(120,255),a:fOI(2,10)/10},vT:Math.floor(100*fO(.2,1))/100};k.push(b)}fT()}
function fS(a,b,c){for(var d=fOI(b,gI.vX-b),e=fOI(b,gI.vY-b),f=0;f<gI.vB.length;f++)fQ({x:d,y:e},gI.vB[f])<b+gI.vB[f].vT+10&&(f=-1,d=fOI(b,gI.vX-b),e=fOI(b,gI.vY-b),gI.vX++,gI.vY++);gI.vB.push(new fV(d,e,b,a.id,c));a.vB++}
function fT(){gI.vK=[];for(var a=0;a<gI.vC.length;a++)gI.vC[a].fT();for(a=0;a<gI.vC.length;a++)gI.vC[a].vX&&(gI.vC.splice(a,1),a--);for(a=0;a<gI.vB.length;a++)fW(gI.vB[a]);for(key in gDs)gDs[key]&&fU(gDs[key]);var b=gI.vB[0].vD;if(0==b)tt();else{for(a=0;a<gI.vB.length;a++)if(gI.vB[a].vD!=b){tt();return}for(a=0;a<gI.vC.length;a++)if(gI.vC[a].vD!=b){tt();return}0==b?tt():(a=new Date,gH.push({wA:a.getDate()+"."+(a.getMonth()+1)+"."+(a.getYear()-100),vZ:gI.gCs[b].vH,gCs:gI.gCs.length-1}),db("d",gH),null!=
gDs[b]&&gDs[b].emit("f",{gCs:gI.gCs.length-1}),fR())}}function tt(){setTimeout(fT,3E3)}function fU(a){a.emit("e",gI)}fA();function fV(a,b,c,d,e){this.x=a;this.y=b;this.vT=c;this.vD=d;this.vE=e;this.wB=15*c+fOI(-50,50)}function fW(a){var b=a.vT/10;gI.gCs[a.vD].vG&&(b*=2);var c=a.wB/Math.max(1,Math.min(5,gI.gCs[a.vD].vB/8));a.vE<=c&&(a.vE+=Math.floor(b))}function fX(a,b,c,d){this.vI=a;this.vD=gI.vB[a].vD;this.vJ=b;this.vE=c;this.vW=!0;this.vF=this.es=d}
fX.prototype.fT=function(){this.vW?this.vW=!1:this.es--;if(0>=this.es)if(this.vX=!0,gI.vB[this.vJ].vD==this.vD)gI.vK.push({vI:this.vI,vJ:this.vJ,vD:this.vD,vV:!1}),gI.vB[this.vJ].vE+=this.vE;else{var a=gI.gCs[gI.vB[this.vJ].vD],a=(.7+a.vB/gI.vB.length*.4)*(a.vG?.7:1),b=Math.floor(a*this.vE);gI.vB[this.vJ].vE<b?(gI.vB[this.vJ].vE=Math.floor(this.vE-gI.vB[this.vJ].vE/a),a=gI.vB[this.vJ].vD,gI.gCs[a].vB--,gI.gCs[this.vD].vB++,gI.vB[this.vJ].vD=this.vD,iR(a),gI.vK.push({vI:this.vI,vJ:this.vJ,vD:this.vD,
vV:!0,vU:!0})):(gI.vB[this.vJ].vE-=b,iR(this.vD),gI.vK.push({vI:this.vI,vJ:this.vJ,vD:this.vD,vV:!0,vU:!1}))}};function iR(a){for(var b=!1,c=0;c<gI.vB.length;c++)if(gI.vB[c].vD==a){b=!0;break}if(!b)for(c=0;c<gI.vC.length;c++)if(!gI.vC[c].vX&&gI.vC[c].vD==a){b=!0;break}b||(gI.gCs[a].mTil=Date.now()+3E4,gDs[a]&&gDs[a].emit("m",{m:3E4}))}function fO(a,b){return a+Math.random()*(b-a)}function fOI(a,b){return a+Math.floor(Math.random()*(b-a+1))}
function fQ(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))}var clrs=[.6,0,.8,.1,.4,.5,.3,.7,.2,.9];
function fY(a){function b(a){a=Math.floor(a);return(16>a?"0":"")+a.toString(16)}--a;var c=clrs[a%10]+.09*Math.abs(Math.cos(.5*a+fO(0,1))),d=.2*Math.sin(a/15)+.8+fO(-.1,0),e=.3*Math.cos(a/39)+.7+fO(-.2,.1),c=c%1,f,g,h;a=Math.floor(6*c);var n=6*c-a,c=e*(1-d),m=e*(1-n*d),d=e*(1-(1-n)*d);switch(a%6){case 0:f=e;g=d;h=c;break;case 1:f=m;g=e;h=c;break;case 2:f=c;g=e;h=d;break;case 3:f=c;g=m;h=e;break;case 4:f=d;g=c;h=e;break;case 5:f=e,g=c,h=m}f=Math.max(0,Math.min(1,f));g=Math.max(0,Math.min(1,g));h=Math.max(0,
Math.min(1,h));return b(255*f)+b(255*g)+b(255*h)}function fYR(a,b){function c(a){var b=255-a;return 0|Math.random()*b+a}return{r:c(a),g:c(a),b:c(a),a:b}};
