function Grid(a,b){this.cells=[],this.c=a,this.r=b,this.empty(),this.chain=/((?!00)\d{1,2}.)\1{2,9}/g}function tic(a){var b=(a-start)/1e3;start=a,G.update(b),G.render(),window.requestAnimationFrame(tic)}function addStats(){window.stats=new Stats,window.stats.setMode(0),window.stats.domElement.style.position="absolute",window.stats.domElement.style.left="300px",window.stats.domElement.style.top="0px",document.body.appendChild(window.stats.domElement)}function Point(a,b){this.x=a,this.y=b}function Region(a){this.points=a||[],this.length=a.length}var ElementFactory={c:0,getRandom:function(a,b){var c=null,d=Me.g[~~(M.random()*Me.g.length)];switch(d){case Me.AIR:c=Air.new(a,b);break;case Me.EARTH:c=Earth.new(a,b);break;case Me.FIRE:c=Fire.new(a,b);break;case Me.ROCK:c=Rock.new(a,b);break;case Me.WATER:c=Water.new(a,b)}return this.c++,c}},_Element=Base.extend({initialize:function(a,b){this.burned=!1,this.spriteAnim=[],this.anim=.4,this.animSpeed=.4,this.sc=0,this.cost=1,this.x=a,this.y=b,this.cx=a,this.cy=b,this.rx=0,this.ry=0,this.v={x:0,y:E},this.w=E,this.h=E,this.gravity=16,this._type=0,this._oType=0,this.fixed=!1,this.pressureDelay=.5,this.pressure=0,this._selected=!1,this.blink=.1,this.dispose=!1},set type(a){a!==this._type&&(0===this._oType&&(this._oType=a),this._type=a,this.rx=--a%(sprite.width/E)*E,this.ry=M.floor(a/(sprite.width/E))*E)},get type(){return this._oType},set selected(a){this.pressure=1.4,this._selected=a},get selected(){return this._selected},free:function(){this.gravity=16},onAnimLoop:function(){},update:function(a){if(this.x=this.cx,this.spriteAnim.length>0){var b=this.spriteAnim[this.sc];this.rx=(b-1)%(sprite.width/E)*E,this.ry=M.floor((b-1)/(sprite.width/E))*E,this.anim-=a,this.anim<=0&&(this.anim=this.animSpeed,this.sc=(this.sc+1)%this.spriteAnim.length,0===this.sc&&this.onAnimLoop())}0===this.gravity&&this.cy>this.y&&(this.y+=1),this.y<G.grid.r-1?0===G.grid.get(this.x,this.y+1)?(this.cy+=this.gravity*a+.1*this.y*a,this.cy>this.y&&(this.y+=1)):this.cy=this.y:this.cy=this.y=G.grid.r-1,this.selected&&(this.blink-=a)<0&&(this.blink=.1),this.pressure>0&&(this.pressureDelay-=a)<=0&&(this.pressureDelay=.5,(this.pressure-=1)<=0&&G.remove(this))},render:function(a){a=a||G.context,.1===this.blink&&a.drawImage(sprite,this.rx,this.ry,10,10,~~this.cx*E,~~this.cy*E,10,10)},collide:function(){},replace:function(a){var b=G.add(a.new(this.x,this.y));return G.remove(this),b}}),Air=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.type=Me.AIR},collide:function(a){switch(a.type){case Me.WATER:a.replace(Ice),G.remove(this);break;case Me.LAVA:case Me.FIRE:this.replace(Cloud)}return a}}),Cloud=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.type=Me.CLOUD,this.spriteAnim.push(57,47,37,27,17),this.animSpeed=.1},onAnimLoop:function(){G.remove(this)}}),Earth=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.type=Me.EARTH},collide:function(a){switch(_Element.collide.call(this,a),a.type){case Me.LAVA:case Me.FIRE:this.replace(Rock),G.remove(a);break;case Me.GRASS:a.replace(Earth);break;case Me.AIR:a.selected===!1&&(a.selected=!0);break;case Me.HEAD_PLANTS:case Me.PLANTS:G.remove(a)}return a}}),Eye=_Element.extend({initialize:function(){_Element.initialize.call(this,0,0),this.type=61,this.coords=[[0,60],[30,60],[60,60]],this.animSpeed=.1,this.animDelay=1,this.pcx=42,this.pcy=22,this.rw=50/G.width,this.rh=30/G.height,this.cvs=Canvas.get(30,20),this.ctx=this.cvs.getContext("2d"),this.t=this.coords[this.sc]},onAnimLoop:function(){this.anim=3},update:function(a){this.t=this.coords[this.sc],this.anim-=a,this.anim<=0&&(this.anim=this.animSpeed,this.sc=(this.sc+1)%this.coords.length,0===this.sc&&this.onAnimLoop()),G.ce&&(this.pcx=42-(42-G.ce.cx*E)*this.rw,this.pcy=22-(22-G.ce.cy*E)*this.rh)},render:function(){var a=this.cvs.width,b=this.cvs.height,c=this.pcx-(42-a/2),d=this.pcy-(22-b/2);this.ctx.clearRect(0,0,G.width,G.height),this.ctx.drawImage(sprite,this.t[0],this.t[1],a,b,0,0,a,b),this.ctx.globalCompositeOperation="source-out",this.ctx.drawImage(sprite,0,80,20,20,c-10,d-10,20,20),G.context.fillStyle="white";var e=20;G.context.drawImage(sprite,20,80,60,60,10,e-20,60,60),G.context.fillRect(25,e+22-10-2,this.cvs.width,this.cvs.height),G.context.drawImage(this.cvs,25,e+22-10-2),G.context.drawImage(sprite,this.t[0],this.t[1],30,20,25,e+10,30,20)},moveTo:function(){}}),Fire=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.type=Me.FIRE,this.spriteAnim.push(2,12,22,32,12),this.animSpeed=.23,this.sc=M.rand(4)},collide:function(a){switch(_Element.collide.call(this,a),a.type){case Me.WATER:this.replace(Cloud);break;case Me.GRASS:a.burned=!0,G.remove(this);break;case Me.AIR:case Me.HEAD_PLANTS:G.remove(a);break;case Me.PLANTS:var b=G.grid.get(a.x,a.y+1);b===Me.GRASS||b===Me.BURNED_GRASS?(a.burned=!0,G.remove(this)):G.remove(a);break;case Me.ICE:a.replace(Water),this.replace(Cloud)}return a},update:function(a){_Element.update.call(this,a);var b=G.get(this.x,this.y-1);b&&b.type===Me.FIRE?(this.type=Me.FIRE_BASE,this.spriteAnim=[]):(this.type=Me.FIRE,this.spriteAnim.push(2,12,22,32,12))}}),Grass=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.cost=5,this.type=Me.GRASS},collide:function(a){switch(_Element.collide.call(this,a),a.type){case Me.FIRE:G.remove(a);break;case Me.PLANTS:G.remove(a)}return a},update:function(a){_Element.update.call(this,a);var b=G.get(this.x,this.y-1);b&&(this.burned=b.burned),this.type=this.burned===!0?Me.BURNED_GRASS:Me.GRASS}}),HeadPlants=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.cost=3,this.type=Me.HEAD_PLANTS},update:function(a){_Element.update.call(this,a);var b=G.grid.get(this.x,this.y-1);0===b&&this.replace(Plants)}}),Ice=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.cost=3,this.type=Me.ICE},collide:function(a){switch(_Element.collide.call(this,a),a.type){case Me.LAVA:case Me.FIRE:this.replace(Water);break;case Me.GRASS:a.replace(Earth);break;case Me.WATER:a.replace(Ice);break;case Me.AIR:case Me.HEAD_PLANTS:case Me.PLANTS:G.remove(a)}return a}}),Lava=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.cost=5,this.type=Me.LAVA,this.spriteAnim.push(10,20,30),this.sc=M.rand(3)},collide:function(a){switch(_Element.collide.call(this,a),a.type){case Me.ICE:a.replace(Water);break;case Me.WATER:this.replace(Rock);break;case Me.AIR:case Me.FIRE:G.remove(a);break;case Me.GRASS:a.replace(Earth);break;case Me.HEAD_PLANTS:case Me.PLANTS:G.remove(a);break;case Me.EARTH:this.free(),a.selected===!1&&(a.selected=!0)}return a}}),Plants=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.cost=3,this.type=Me.PLANTS},update:function(a){_Element.update.call(this,a);var b=null;this.burned&&(this.type=Me.BURNED_PLANTS,b=G.get(this.x,this.y+1),b&&(b.burned=!0)),b=G.grid.get(this.x,this.y-1),(b===Me.HEAD_PLANTS||b===Me.PLANTS)&&this.replace(HeadPlants)}}),Rock=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.type=Me.ROCK},collide:function(a){switch(_Element.collide.call(this,a),a.type){case Me.GRASS:a.replace(Earth);break;case Me.HEAD_PLANTS:case Me.PLANTS:G.remove(a);break;case Me.LAVA:this.replace(Lava);break;case Me.FIRE:G.remove(this),a.replace(Lava)}return a}}),Water=_Element.extend({initialize:function(a,b){_Element.initialize.call(this,a,b),this.type=Me.WATER,this.spriteAnim.push(15,25,35,25),this.animSpeed=.21,this.sc=M.rand(3),this.toIceCountDown=2},update:function(a){_Element.update.call(this,a)},collide:function(a){switch(a.type){case Me.ICE:this.replace(Ice);break;case Me.EARTH:a.replace(Grass),this.replace(Plants);break;case Me.LAVA:a.replace(Rock),G.remove(this);break;case Me.FIRE:a.replace(Cloud),G.remove(this);break;case Me.GRASS:this.replace(Plants),a.burned=!1;break;case Me.PLANTS:if(a.burned===!1){{this.replace(Plants)}a.replace(HeadPlants)}else G.remove(this);break;case Me.HEAD_PLANTS:break;case Me.AIR:this.replace(Ice),G.remove(a)}return a}}),G={width:0,height:0,scale:4,sw:0,sh:0,context:null,color:"#2C2C2C",ent:null,ent2:null,entities:[],grid:null,delay:0,ceDelay:.3,ce:null,requestElement:0,_cleanRequested:!1,score:0,gameOver:!1,collideDelay:.2,shadows:{},dx:0,shake:0,level:0,increaseLevel:15,_initShadows:function(){var a=null;for(var b in Me){var c=Canvas.get(10,10);Canvas.pixelate(c),a=Me[b];var d=(a-1)%(sprite.width/E)*E,e=M.floor((a-1)/(sprite.width/E))*E;c.getContext("2d").drawImage(sprite,d,e,10,10,0,0,10,10),this.shadows[a]=Canvas.createAlphaMask("#000000",c,0,0,10,10)}},load:function(a){ElementFactory.c=0,this.score=0,this.ceDelay=.4,this.level=1,this.requestElement=.1,this.grid=new Grid(this.sw/E,this.sh/E);for(var b=0,c=1;3>c;c++)for(b=0;b<this.grid.c;b++)this.add(Earth.new(b,this.grid.r-c));this.add(Eye.new()),G.get(0,this.grid.r-2).replace(Grass),this.add(Plants.new(0,this.grid.r-3)),G.get(1,this.grid.r-2).replace(Ice),G.get(1,this.grid.r-1).replace(Ice),this.add(Earth.new(3,this.grid.r-3)),this.add(Earth.new(4,this.grid.r-3)),this.add(Grass.new(5,this.grid.r-3)),this.add(Plants.new(5,this.grid.r-4)),this.add(Fire.new(2,this.grid.r-3)),this.add(Water.new(6,this.grid.r-3)),this.add(Water.new(7,this.grid.r-3)),G.get(6,this.grid.r-2).replace(Rock),G.get(7,this.grid.r-2).replace(Rock),this.add(Grass.new(4,this.grid.r-4)),this.add(Plants.new(4,this.grid.r-5));var d=null;this.grid.empty();var e=this.entities.length;for(b=0;e>b;b++)d=this.entities[b];this.dx=0,this.ent=Canvas.get(G.width,G.height),this.ent2=Canvas.get(G.width,G.height),this._initShadows(),this.gameOver=!1,a()},get:function(a,b){for(var c=this.entities.length,d=null,e=0;c>e;e++)if(d=this.entities[e],d.x===a&&d.y===b)return d;return null},displayCount:function(a,b,c){var d=document.createElement("div");d.innerHTML="+ "+c,d.style.fontSize="20px",d.style.position="absolute",d.style.left=a+"px",d.style.top=b+"px",d.style.color="white",document.$("gameContent").appendChild(d),setTimeout(function(){document.$("gameContent").removeChild(d)},800)},increaseRow:function(){var a=this.entities.length,b=0;for(b=0;a>b;b++){var c=this.entities[b];61!==c.type&&(c.y-1<0?c._toRemove=!0:c.y-=1)}for(b=0;b<G.grid.c;b++){var d=M.random();G.add(d>.4?Earth.new(b,G.grid.r-1):d>.2?Rock.new(b,G.grid.r-1):d>.1?Ice.new(b,G.grid.r-1):Air.new(b,G.grid.r-1))}},restart:function(){this.shake=0,this.entities=[],this.load(function(){})},update:function(a){if(this.gameOver===!0)return this.shake=1,document.$("gameOver").style.display="block",void(Input.keys.s&&this.restart());document.$("gameOver").style.display="none",document.$("main").style.display="none",document.$("gameContent").style.display="block",this.shake>0&&(aa.play("shake"),(this.shake-=a)<0&&(this.shake=0,this.increaseRow(),this.ceDelay-=.05,this.ceDelay<.24&&(this.ceDelay=.24),this.level+=1));var b=0;this._cleanRequested&&(this._cleanRequested=!1,this._cleanEntities());var c=this.entities.length,d=null;for(this.grid.empty(),b=0;c>b;b++)d=this.entities[b],61!==d.type&&this.grid.set(d.x,d.y,d.type);for(b=0;c>b;b++)d=this.entities[b],d.update(a);if((this.collideDelay-=a)<0){this.collideDelay=.1;for(b=0;c>b;b++)if(d=this.entities[b],!d.selected){var e=this.get(d.x,d.y+1);e&&d.collide(e)}}if(this.requestElement>0&&(this.requestElement-=a,this.requestElement<=0)){this.ce&&(this.ce.free(),this.ce=null);var f=[],g=null,h=0,i=this.grid.getChain();for(b=0;b<i.length;b++)for(var j=0;j<i[b].length;j++)1===i[b][j]&&(g=this.get(j,b),g&&(f.push({x:j,y:b}),g.selected=!0,h+=g.cost));if(h>0){var k=null;if(1===f.length)k=f[0];else{var l=new Region(f);k=l.centroid(),(isNaN(k.x)||isNaN(k.y))&&(k=f[0])}this.displayCount(k.x*E*G.scale,k.y*E*G.scale,h),G.score+=h}}if(this.ce&&(this.ce.gravity=Input.keys.d?20:0),this.requestElement<=0&&(null===this.ce&&(this.ce=this.add(ElementFactory.getRandom(4+~~(1*Math.random()),0)),this.ce.gravity=0),this.ce.dispose===!0&&(aa.play("hurt"),this.dx=0,this.requestElement=this.ceDelay,this.ce.free(),this.ce=null,ElementFactory.c>0&&ElementFactory.c%this.increaseLevel===0&&(this.shake=.8)),this.ce&&(this.ce.y<=1||0===this.ce.gravity||this.grid.get(this.ce.x,this.ce.y+1)>0))){var m=this.dx;this.dx=0,Input.keys.r?m=1:Input.keys.l&&(m=-1),(this.delay-=a)<=0?(this.delay=this.ceDelay,this.grid.get(this.ce.x+m,this.ce.y+1)>0||this.ce.y===G.grid.r-1?this.grid.get(this.ce.x,this.ce.y+1)>0?0===this.ce.y?this.gameOver=!0:this.ce.dispose=!0:this.ce.cy+=1:(this.ce.cx+=m,this.ce.cy+=1)):this.dx=m}level.innerHTML="LEVEL "+this.level,score.innerHTML=this.score},render:function(){this.context.clearRect(0,0,this.width,this.height),this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height);var a=this.ent.getContext("2d");a.clearRect(0,0,this.width,this.height);var b=this.ent2.getContext("2d");b.clearRect(0,0,this.width,this.height),b.globalAlpha=.4;for(var c=null,d=null,e=this.entities.length,f=0;e>f;f++)c=this.entities[f],c.render(a),.1===c.blink&&(d=this.shadows[c._type],d&&b.drawImage(d,~~c.cx*E,~~c.cy*E));this.shake>0&&(this.context.save(),this.context.translate(6*(.5-M.random()),3.4*(.5-M.random()))),this.context.drawImage(this.ent2,-4,0),this.context.drawImage(this.ent,0,0),this.context.restore()},add:function(a){return this.entities.push(a),a},_cleanEntities:function(){for(var a=[],b=this.entities.length,c=0;b>c;c++)this.entities[c]._toRemove!==!0&&a.push(this.entities[c]);this.entities=a},remove:function(a){this._cleanRequested=!0,a._toRemove=!0,a.dispose=!0}};Grid.prototype={get:function(a,b){return 0>a||a>=this.c||0>b||b>=this.r?1:1*this.cells[b][a]},set:function(a,b,c){this.cells[b][a]=10>c?"0"+c:c+""},del:function(a,b){this.cells[b][a]="00"},empty:function(a){a=a||this.cells;for(var b=0;b<this.r;b++){a[b]=[];for(var c=0;c<this.c;c++)a[b][c]="00"}},_isChainAllowed:function(a){var b=1*a.replace(".","");return-1===Me.g.indexOf(b)},getChain:function(){var a,b=null,c=null,d="",e=0,f=0,g=[];for(this.empty(g),f=0;f<this.r;f++)for(b=this.cells[f],d=b.join(".")+".";null!==(c=this.chain.exec(d));)if(this._isChainAllowed(c[1]))for(e=c[0].match(/\./g).length,a=0;e>a;a++)g[f][a+c.index/3]=1;try{for(a=0;a<this.c;a++){for(d="",f=0;f<this.r;f++)d+=this.cells[f][a]+".";for(;null!==(c=this.chain.exec(d));)if(this._isChainAllowed(c[1]))for(e=c[0].match(/\./g).length,f=0;e>f;f++)g[f+c.index/3][a]=1}}catch(h){}return g}};var M=Math,E=10,start=0,Z=.1,sprite,startup,score,glasspane,level;document.$=document.getElementById;var Me={};Me.EMPTY=0,Me.WATER=1,Me.FIRE=2,Me.EARTH=3,Me.ROCK=4,Me.AIR=5,Me.GRASS=6,Me.PLANTS=7,Me.HEAD_PLANTS=8,Me.FLOWER=9,Me.LAVA=10,Me.ICE=11,Me.FIRE_BASE=42,Me.BURNED_PLANTS=13,Me.BURNED_GRASS=14,Me.CLOUD=17,Me.g=[Me.EARTH,Me.WATER,Me.WATER,Me.WATER,Me.FIRE,Me.FIRE,Me.FIRE,Me.AIR,Me.AIR],window.onload=function(){level=document.getElementById("level"),score=document.getElementById("score"),sprite=document.getElementById("sprite");{var a=document.getElementById("game");document.getElementById("glasspane")}G.glasspane=a.getContext("2d"),G.width=a.width,G.height=a.height,G.scale=4,G.context=a.getContext("2d"),Canvas.pixelate(a),G.context.scale(G.scale,G.scale),G.sw=G.width/G.scale,G.sh=G.height/G.scale,G.load(function(){window.requestAnimationFrame(tic),G.gameOver=!0})};var aa;!function(){function a(){this.sounds={}}a.prototype.add=function(a,b,c){this.sounds[a]=[],c.forEach(function(c,d){this.sounds[a].push({tick:0,count:b,pool:[]});for(var e=0;b>e;e++){var f=new Audio;f.src=jsfxr(c),this.sounds[a][d].pool.push(f)}},this)},a.prototype.play=function(a){var b=this.sounds[a],c=b.length>1?b[Math.floor(Math.random()*b.length)]:b[0];c.pool[c.tick].play(),c.tick<c.count-1?c.tick++:c.tick=0},aa=new a,aa.add("hurt",1,[[0,,.0399,,.2989,.2385,,-.5403,,,,,,.3776,,,,,1,,,,,.5]]),aa.add("step",1,[[1,,.039,,.1409,.4706,,-.6868,,,,,,.5661,,,,,1,,,,,.5]]),aa.add("shake",5,[[3,,.3774,.3842,.2146,.0436,,,,,,,,,,,,,1,,,,,.5]])}();var Canvas={o:null,get:function(a,b){var c=document.createElement("canvas");return c.width=a,c.height=b,c},pixelate:function(a){var b=a.getContext("2d");b.imageSmoothingEnabled=!1,b.mozImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.oImageSmoothingEnabled=!1,b.msImageSmoothingEnabled=!1},createAlphaMask:function(a,b,c,d,e,f){var g=this.get(e,f),h=g.getContext("2d");h.drawImage(b,c,d,e,f,0,0,e,f);for(var i=h.getImageData(0,0,e,f),j=0,k=i.data.length;k>j;j+=4)i.data[j]=a[0],i.data[j+1]=a[1],i.data[j+2]=a[2];return h.putImageData(i,0,0),g}},Input={keys:{l:0,u:0,r:0,d:0},onKey:function(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&0===c&&(c=b.charCode),37===c&&(this.keys.l=a),38===c&&(this.keys.u=a),39===c&&(this.keys.r=a),40===c&&(this.keys.d=a),32===c&&(this.keys.s=a)},onMouse:function(a,b){b||(b=window.event);var c=!1;b.which?c=1===b.which:b.button&&(c=0===b.button),c&&(this.mouse=a)}};document.onkeyup=function(a){Input.onKey(0,a)},document.onkeydown=function(a){Input.onKey(1,a)},document.onmouseup=function(a){Input.onMouse(0,a)},document.onmousedown=function(a){Input.onMouse(1,a)},M.rand=function(a){return this.sc=M.floor(M.random()*a)},Region.prototype.area=function(){var a,b,c,d,e=0;for(a=0,b=this.length-1;a<this.length;b=a,a++)c=this.points[a],d=this.points[b],e+=c.x*d.y,e-=c.y*d.x;return e/=2},Region.prototype.centroid=function(){var a,b,c,d,e,f=0,g=0;for(a=0,b=this.length-1;a<this.length;b=a,a++)d=this.points[a],e=this.points[b],c=d.x*e.y-e.x*d.y,f+=(d.x+e.x)*c,g+=(d.y+e.y)*c;return c=6*this.area(),new Point(f/c,g/c)},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();