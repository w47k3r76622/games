var C=document.getElementById("game");var G=C.getContext("2d");var hud=document.getElementById("hud");var HUD=hud.getContext("2d");var HUD2=document.getElementById("hud2").getContext("2d");var B=document.getElementsByTagName("body")[0];var ran=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)};var flip=function(){return ran(0,1)==0?true:false};var col=function(a,b){with(a){if(x+w/2>b.x-b.w/2&&x-w/2<b.x+b.w/2&&y+h/2>b.y-b.h/2&&y-h/2<b.y+b.h/2){return true}else{return false}}};var mix=function(e,t,n){return{r:e.r+Math.floor(t.r*n),g:e.g+Math.floor(t.g*n),b:e.b+Math.floor(t.b*n)}};var oppo=function(e){return{r:e.g,g:e.r,b:e.r+e.g/2}};var loopA=function(e){while(e>=360){e-=360}while(e<0){e+=360}return e};var tri=function(e,t,n,r,i){var s=toAngle(e,t,r.x,r.y);G.beginPath();G.moveTo(e+r.x*n,t+r.y*n);G.lineTo(e+r.y*n,t);G.lineTo(e,t+r.x*n);G.closePath();G.fillStyle=rgb(i);G.fill()};var co={r3:{r:188,g:73,b:58},y3:{r:188,g:135,b:58},b3:{r:44,g:84,b:122},g3:{r:43,g:141,b:69},w:{r:255,g:255,b:255},b:{r:25,g:25,b:25},en:{r:225,g:225,b:225}};var p={x:300,y:250,el:co.r3,w:30,h:30,c:mix(co.r3,co.w,-.5),hp:8,st:0,r:0,s:15,sd:.1};var en=[];var enN=function(){this.type=lvl.spawn[ran(0,lvl.spawn.length-1)];var e=C.getBoundingClientRect();if(flip()){this.x=ran(0,e.width)-20;flip()?this.y=0:this.y=e.height-20}else{this.y=ran(0,e.height)-20;flip()?this.x=0:this.x=e.width-20}this.r=ran(0,359);this.xv=0;this.yv=0;this.w=40;this.h=40;this.c={r:225,g:225,b:225};this.hp=10;this.acc=1;this.fric=1;this.tim=0};var lvl={c:{r:0,g:0,b:0},n:0,spawn:["s"],score:0,goal:30,tim:0,pause:0};var bg=[];var particles=[];var newP=function(e,t,n,r,i){this.x=e+ran(-15,15);this.y=t+ran(-15,15);this.xv=n+ran(-1,1);if(n==0){n+=.1}this.yv=n+ran(-1,1);this.r=ran(0,359);this.c=i[ran(0,i.length-1)];this.c.a=2;this.size=ran(3,20)};var fromAngle=function(e){return{x:Math.sin(Math.PI/180*e),y:Math.cos(Math.PI/180*e)}};var toAngle=function(e,t,n,r){if(n<e&&r>=t){return 180/Math.PI*Math.atan(Math.abs(r-t)/Math.abs(n-e))+270}if(r<t&&n>=e){return 180/Math.PI*Math.atan(Math.abs(r-t)/Math.abs(n-e))+90}else if(r<t&&n<e){return 180/Math.PI*Math.atan(Math.abs(n-e)/Math.abs(r-t))+180}else{return 180/Math.PI*Math.atan(Math.abs(n-e)/Math.abs(r-t))}};var rgb=function(c){with(c){if(typeof a==="undefined"){return"rgb("+r+","+g+","+b+")"}else{return"rgba("+r+","+g+","+b+","+a+")"}}};var hit=function(e){if(!p.st){p.s=.1;p.hp-=e;p.st+=200;if(p.hp<=0){en=[];particles=[];lvl.score=0;p.hp=8;resetBG()}}};var generateBG=function(){for(var e=0;e<12;e++){bg.push([]);for(var t=0;t<16;t++){bg[bg.length-1].push(new function(){this.c={r:e+t,g:e+t,b:e+t};this.x=t*50;this.y=e*50;this.w=50;this.h=50})}}};var resetBG=function(){for(var e=0;e<12;e++){for(var t=0;t<16;t++){bg[e][t].c={r:e+t,g:e+t,b:e+t}}}};var background=function(){var tmp=[];for(var i=0;i<12;i++){for(var ii=0;ii<16;ii++){with(bg[i][ii]){G.fillStyle=rgb(c);G.fillRect(x,y,w,h);if(x>p.x-w&&x<p.x+w&&y>p.y-h&&y<p.y+h){if((c.r+c.b+c.g)/3<=500){c=mix(c,p.el,.05)}}if(c.r>=255||c.b>=255||c.g>=255){for(var i3=0;i3<en.length;i3++){if(col(en[i3],{x:x,y:y,w:w,h:h})){if(en[i3].hp>0){en[i3].c=c}if(c.r>=255&&c.b>=255&&c.g>=255){if(en[i3].hp>0){en[i3].c=co.b;en[i3].hp=0;en[i3].acc=0;en[i3].fric=.98;console.log("hit enemy with white");for(var i4=0;i4<ran(16,22);i4++){particles.push(new newP(en[i3].x,en[i3].y,ran(-1,1),ran(-1,1),[{r:c.r,g:c.g,b:c.b}]))}en.push(new enN)}}else if(c.r>=255&&c.g<255&&c.b<255&&en[i3].tim==0){en[i3].hp-=1;console.log("hit enemy with red")}else if(c.g>=255&&c.r<255&&c.b<255&&en[i3].tim==0){en[i3].xv/=3;en[i3].yv/=3;console.log("hit enemy with green")}else if(c.b>=255&&c.g<255&&c.r<255&&en[i3].tim==0){if(en[i3].fric>0){en[i3].fric-=.01}console.log("hit enemy with blue")}}}}c.r<=i+ii?c.r=i+ii:c.r-=1;c.g<=i+ii?c.g=i+ii:c.g-=1;c.b<=i+ii?c.b=i+ii:c.b-=1}}}return tmp};var pMove=function(e,t){var n=C.getBoundingClientRect();p.x=e;p.y=t;if(p.x>n.width-15-2){p.x=n.width-15-2}else if(p.x<0+15+2){p.x=0+15+2}if(p.y>n.height-15-2){p.y=n.height-15-2}else if(p.y<0+15+2){p.y=0+15+2}};var moveParticles=function(){var tmp=[];for(var i=particles.length-1;i>-1;i--){with(particles[i]){x+=xv;y+=yv;tri(x,y,size,fromAngle(r),c);c.a-=.01;if(c.a<=0){tmp.push(i)}}}for(var i=tmp.length-1;i>-1;i-=1){particles.splice(tmp[i],1)}};var newLvl=function(){with(lvl){n++;score=0;if(n==1){spawn=["f"]}else{for(var i=0;i<ran(0,n/2);i++){spawn.push("s")}for(var i=0;i<ran(0,n);i++){spawn.push("f")}}goal=20+n*5;HUD2.fillStyle="white";HUD2.fillRect(0,600-n*5+1,50,3);if(n==120){HUD2.fillRect(0,0,50,600);console.log("yes you just won")}return n}};var explode=function(a){with(a){for(var i=0;i<ran(6,12);i++){particles.push(new newP(x,y,yv*2,xv*2,[{r:225,g:225,b:225},{r:25,g:25,b:25},{r:172,g:60,b:45}]))}}};var enMove=function(){for(var i=0;i<en.length;i++){with(en[i]){if(hp==0){c=co.b}c==co.en||tim>=100?tim=0:tim+=1;if(tim<50&&c!=co.en&&hp>0){c=co.en}var a=fromAngle(r);var point=toAngle(x,y,p.x,p.y);if(type=="s"){if(point-5<=r&&point+5>=r&&hp>0){xv+=a.x/10*acc;yv+=a.y/10*acc}else if(hp>0){r-point<0?r+=1:r-=1;r=loopA(r)}tri(x,y,45,fromAngle(point),{r:106,g:213,b:134,a:.2});tri(x,y,40,a,c);tri(x,y,35,a,co.b);tri(x,y,30,a,c);tri(x,y,25,a,{r:172,g:60,b:45});tri(x,y,20,a,co.en)}else if(type=="f"){if(hp>0){r=point;xv+=a.x/10;yv+=a.y/10}tri(x,y,50,a,{r:255,g:213,b:134,a:.2});tri(x,y,40,a,c);tri(x,y,30,a,co.b);tri(x,y,25,a,{r:125,g:125,b:125});tri(x,y,20,a,co.b);tri(x,y,10,a,co.en);tri(x,y,20,fromAngle(loopA(r-180)),{r:255,g:213,b:134,a:.2})}x+=xv;y+=yv;xv*=.99*fric;yv*=.99*fric}}};var drawP=function(){with(p){r=loopA(r+1);s+=sd;if(s<=10){s+=.05;sd=.05}else if(s>=20){s-=.05;sd=-.05}G.fillStyle=rgb({r:c.r,g:c.g,b:c.b,a:.8});G.beginPath();G.arc(x,y,s,0,s/5*Math.PI,false);G.fill();G.fillStyle=rgb(co.w);G.beginPath();G.arc(x,y,s*11/15,0,s/5*Math.PI,false);G.fill();s-=5;tri(x,y,s,fromAngle(r),p.el);tri(x,y,s,fromAngle(loopA(r+90)),p.el);s+=5;if(st>0){st-=1}}};var update=function(){C.height=C.height;var e=background();drawP();moveParticles();enMove();if(ran(0,en.length*170)==0){en.push(new enN)}for(var t=0;t<en.length;t++){for(var n=t;n<en.length;n++){if(col(en[t],en[n])){if(t!=n){e.push(t);e.push(n);explode(en[t]);explode(en[n])}}}}for(var t=e.length-1;t>-1;t-=1){en.splice(e[t],1);lvl.score++}for(var t=0;t<en.length;t++){if(col(en[t],p)){hit(1)}}hud.width=hud.width;HUD.fillStyle=rgb(mix(p.c,co.w,.5));for(var t=0;t<p.hp;t++){HUD.fillRect(t*100+20,(100-p.s*3)/2,60,p.s*3)}HUD.fillStyle=rgb(mix(p.c,co.w,.6));for(var t=0;t<p.hp;t++){HUD.fillRect(t*100+20,(100-p.s*2)/2,60,p.s*2)}HUD.fillStyle="white";for(var t=0;t<2;t++){HUD.fillRect(0,t*90,800*(lvl.score/lvl.goal),10)}lvl.tim>=100?lvl.tim=0:lvl.tim+=1;if(lvl.score>=lvl.goal){newLvl()}};document.addEventListener("mousemove",function(e){pMove(e.clientX-C.getBoundingClientRect().left,e.clientY-C.getBoundingClientRect().top)},false);document.addEventListener("keydown",function(e){if(e.keyCode==49){p.el=co.r3;p.c=mix(co.r3,co.w,-.5)}if(e.keyCode==50){p.el=co.b3;p.c=mix(co.b3,co.w,-.5)}if(e.keyCode==51){p.el=co.g3;p.c=mix(co.g3,co.w,-.5)}if(e.keyCode==32){lvl.pause?frame=self.setInterval(update,1):clearInterval(frame)}},false);generateBG();var frame=self.setInterval(update,1)