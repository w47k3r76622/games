/*! Force-of-Elementals 2014-09-14 */
function T(a,b,c,d,e){this.V=a,this.tr={Air:{rel:30,r:100,g:150,b:250,ra:35,FX:32,FY:0,FXS:15,FYS:15,RX:7.5,RY:7.5,AR:3},Earth:{rel:10,r:132,g:100,b:37,ra:10,FX:47,FY:0,FXS:14,FYS:14,RX:7,RY:7,AR:.2},Fire:{rel:25,r:255,g:90,b:16,ra:55,FX:25,FY:0,FXS:7,FYS:20,RX:3.5,RY:16.5,AR:0},Water:{rel:2,r:16,g:90,b:255,ra:40,FX:18,FY:0,FXS:7,FYS:20,RX:3.5,RY:16.5,AR:0}},this.x=b*a.sc*20,this.y=c*a.sc*20,this.TLvl=e,this.angle=0,this.type=d,this.rel=this.tr[this.type].rel,this.aRel=this.rel,this.r=this.tr[this.type].r,this.g=this.tr[this.type].g,this.b=this.tr[this.type].b,this.ra=this.tr[this.type].ra,this.aRa=0,this.FX=this.tr[this.type].FX,this.FY=this.tr[this.type].FY,this.FXS=this.tr[this.type].FXS,this.FYS=this.tr[this.type].FYS,this.RX=this.tr[this.type].RX,this.RY=this.tr[this.type].RY,this.AR=this.tr[this.type].AR,this.aAR=0,"Earth"!=this.type?(a.ctx_bg.fillStyle="rgba("+this.r+","+this.g+","+this.b+","+.2*this.TLvl+")",a.ctx_bg.fillRect(this.x+1*a.sc,this.y+1*a.sc,18*a.sc,18*a.sc),a.ctx_bg.drawImage(a.sprite,0,0,18,18,this.x+1*a.sc,this.y+1*a.sc,18*a.sc,18*a.sc)):(a.ctx_bg.fillStyle="rgba("+this.r+","+this.g+","+this.b+","+.05*this.TLvl+")",a.ctx_bg.fillRect(this.x+5*a.sc,this.y+5*a.sc,10*a.sc,10*a.sc))}function B(a,b,c,d){this.V=a,this.cx=c,this.map=d,this.size=b,this.startPos=[],this.templates=[["   X            ","  RW     R      ","   W RSAAAAAA R ","   W  S     W   ","   WR DDS  RW   ","   W  R S   W   "," R W  SAA   W  R","   WR SR   RW   ","   W  DDS   W   ","   W R  S   W   ","R  WAAAAA   WR  ","      R     Y   "],["                ","   SAAAR SAAAA  ","  SA  W  S R W  "," RS  RW SA  DW  ","XAA   WAA   W R ","    R    R  WA  ","   DDDS      W  ","  DW  DS   R W  ","  WR   DS   DW  ","  WAA   DDDDW   "," R  W   RWWW    ","    Y        R  "],["          R     ","      RDDDDDDDDX","   R   W W  R   "," RDDDDDWDWAAAA  "," DW  R   R   WA "," W          R W "," W  R         W "," WR       R   W "," WA    R    RDW ","  WAAAAADDDDDW  ","   R   WW R     ","       YY       "],[" V        R     "," S     RDDDDSSR "," SR    DW   DSS "," S     W  R  SS "," S    RWA    SA "," DDS    W    SR "," WRS R  W   SA  ","RWRDDDDDW  RS   "," W      R   SR  "," W R        DS  ",">W        R  DDX","                "],["     X       V  ","   DDW     R S  ","  DDWR  RSAARS  ","  W      S W S  ","  W  RSAAA WAA  "," RW   S R R     ","  W   SAAA SAA  ","  W   S  W S W  ","  WR  S RWAARW  ","  WAAAA   R  W  ","  RWAA       W  ","     R       Y  "],["   VR    V   R  ","   DS    DDS    ","  R DS   R DS   ","   DDDSR    S R ","  DWR DS   RS   ",">DWW   DS RSSR  ","  R   R DS SSSA<","    R   RDDSSA  ","   SAAAA RDSS   ","  RS R W R SAR  ","XAAA   WAAAA    ","   R   R    R   "]],this.elements={grass:{FXmod:0,type:"G"},W:{FXmod:1,type:"W"},A:{FXmod:1,type:"A"},S:{FXmod:1,type:"S"},D:{FXmod:1,type:"D"},">":{FXmod:1,type:">"},"<":{FXmod:1,type:"<"},V:{FXmod:1,type:"V"},Y:{FXmod:1,type:"Y"},X:{FXmod:1,type:"X"},R:{FXmod:1,type:"R"}},this.b=[],this.defeatAnimTimer=20,this.Bullets=[],this.Enemy=[],this.gold={x:0,y:0},this.Golds=[],this.Towers=new Array(16);for(var e=0;16>e;e++)this.Towers[e]=new Array(12);this.parse(this.templates[d]),1>b&&this.drawBg(),this.waves=0,this.count=0}function E(a,b,c,d,e){this.V=a,this.types={zombie:{gr:1,speed:.6,life:1e3,score:8,rise:.75,FX:0,FY:21,FXS:17,FYS:12,fC:[0],fR:0,Frot:0},orc:{gr:1,speed:1,life:60,score:1,rise:1,FX:18,FY:22,FXS:5,FYS:9,fC:[0,1],fR:8,Frot:0},dragon:{gr:0,speed:.9,life:800,score:6,rise:.9,FX:1,FY:34,FXS:25,FYS:19,fC:[0,1],fR:16,Frot:90},man:{gr:1,speed:.9,life:200,score:2,rise:1,FX:45,FY:19,FXS:8,FYS:14,fC:[0,1],fR:10,Frot:90},knight:{gr:1,speed:.8,life:1500,score:10,rise:.75,FX:46,FY:47,FXS:15,FYS:15,fC:[0],fR:0,Frot:-90},worm:{gr:1,speed:1,life:400,score:3,rise:1,FX:29,FY:22,FXS:14,FYS:9,fC:[0],fR:0,Frot:180}},this.type=d,this.ELvl=e,this.gr=this.types[d].gr,this.speed=this.types[d].speed*a.sc,this.aSpeed=this.speed,this.life=this.types[d].life*this.ELvl*2,this.hp=this.life,this.score=this.types[d].score*this.ELvl,this.rise=this.types[d].rise*a.sc+this.ELvl/20,this.FX=this.types[d].FX,this.FY=this.types[d].FY,this.FXS=this.types[d].FXS,this.FYS=this.types[d].FYS,this.fC=this.types[d].fC,this.Frot=this.types[d].Frot,this.distance=0,this.x=(b+this.FXS/4)*a.sc,this.y=(c+this.FYS/4)*a.sc,this.rotate=90,this.frame=0,this.fR=this.types[d].fR,this.fRa=0}function Bullet(a,b,c,d,e,f){this.V=a,this.typ={Air:{dmg:5,v:.5,r:100,g:150,b:250,ra:25},Fire:{dmg:10,v:1.3,r:255,g:90,b:16,ra:55},Water:{dmg:1.4,v:.8,r:16,g:90,b:255,ra:40}},this.type=b,this.ra=this.typ[this.type].ra,this.dmg=this.typ[this.type].dmg*c*c,this.lvl=c,this.v=this.typ[this.type].v,this.r=this.typ[this.type].r,this.g=this.typ[this.type].g,this.b=this.typ[this.type].b,this.a=f,this.x=d,this.y=e,this.ax=this.x+(10+13*Math.sin(this.a*a.rad))*a.sc,this.ay=this.y+(10-13*Math.cos(this.a*a.rad))*a.sc,this.timeLife=Math.round(this.ra/(2*a.sc*this.v))}function M(a){this.buttons=document.getElementsByClassName("buttons")[0].getElementsByTagName("button"),this.wavesInfo=document.getElementById("waves").getElementsByTagName("p"),this.upgradeInfo=document.getElementById("upgrade"),this.startButton=document.getElementById("waves").getElementsByTagName("button")[0];var b=a.fps;this.fps=b,this.up=0,this.cost=0,this.level=0,this.all=[],this.visible=[],this.buttons[0].onclick=function(){a.fps==b?(a.fps=2*b,Menu.buttons[0].style.background="#d4745b"):0!=a.fps&&(a.fps=b,Menu.buttons[0].style.background="#88d98a")},this.buttons[1].onclick=function(){a.fps>0?(Menu.buttons[0].style.background="#88d98a",Menu.buttons[1].style.background="#d4745b",Menu.upgradeInfo.style.visibility="hidden",a.ctx.fillStyle="rgba(0,0,0,0.2)",a.ctx.fillRect(0,0,a.W,a.H),a.fps=0):(a.fps=b,Menu.buttons[1].style.background="#88d98a")},this.buttons[2].onclick=function(){0!=a.fps&&(Menu.up=0,Menu.buttons[0].style.background="#88d98a",Menu.upgradeInfo.style.visibility="hidden",document.getElementById("waves").style.visibility="hidden",a.ctx_r.clearRect(0,0,a.W,a.H),a.mainmenu=1)},this.startButton.onclick=function(){a.timer<-0?a.timer=-0:a.timer}}function G(a,b,c){this.x=a.rand(-5,5)*a.sc+b+7*a.sc,this.y=a.rand(-5,5)*a.sc+c+10*a.sc,this.angle=a.rand(-20,20)}window.onload=function(){V.sprite=new Image,V.sprite.src="sprite.png",setTimeout(function(){V.sprite.onload=game.init()},50)};var game=function(){return this.V={fps:40,W:0,H:0,sc:2,score:0,lifes:10,rad:Math.PI/180,lastTime:0,timer:0,map:0,mainmenu:1,countWaves:0,s:[],sprite:{},ctx:{},ctx_bg:{},ctx_r:{},Water:10,Fire:15,Earth:25,Air:30,WaterR:40,FireR:55,AirR:35,EarthR:10,canvas_map:[],ctx_map:[],MenuMap:[],rand:function(a,b){return Math.floor(Math.random()*(b-a+1))+a}},this.init=function(){var a=document.createElement("canvas");V.ctx_bg=a.getContext("2d");var b=document.createElement("canvas");V.ctx=b.getContext("2d");var c=document.createElement("canvas");V.ctx_r=c.getContext("2d"),layout(b,a,c),document.getElementById("game").appendChild(a),document.getElementById("game").appendChild(b),document.getElementById("game").appendChild(c),mainmenu(),Menu=new M(V),Board=new B(V,1,V.ctx_bg,0),Board.drawBg(),animationLoop()},this.mainmenu=function(){for(var a=0;6>a;a++){{String(a)}V.canvas_map[a]=document.createElement("canvas"),V.ctx_map[a]=V.canvas_map[a].getContext("2d"),V.canvas_map[a].width=.2*V.W,V.canvas_map[a].height=.2*V.H,document.getElementById("level"+(a+1)).appendChild(V.canvas_map[a]),V.MenuMap[a]=new B(V,.2,V.ctx_map[a],a),document.getElementById("level"+(a+1)).addEventListener("mousedown",this.levelchoose,!1)}},this.layout=function(a,b,c){V.W=320*V.sc,V.H=240*V.sc,b.width=V.W,b.height=V.H,a.width=V.W,a.height=V.H,c.width=V.W,c.height=V.H,V.ctx.imageSmoothingEnabled=!1,V.ctx.mozImageSmoothingEnabled=!1,V.ctx.oImageSmoothingEnabled=!1,V.ctx.webkitImageSmoothingEnabled=!1,V.ctx_bg.imageSmoothingEnabled=!1,V.ctx_bg.mozImageSmoothingEnabled=!1,V.ctx_bg.oImageSmoothingEnabled=!1,V.ctx_bg.webkitImageSmoothingEnabled=!1},this.create=function(a){if(1==V.mainmenu){V.fps=40,V.map=a,V.mainmenu=0,Board.drawBg(),delete Board,delete Menu,V.s.length=0,Menu=new M(V),Board=new B(V,1,V.ctx_bg,V.map-1);for(var b=0;31>=b;b++)Menu.animCreating(b);this.waves(V.map,0),document.getElementsByClassName("box")[0].addEventListener("mousedown",this.mouse,!1)}},this.levelchoose=function(a){switch(a.toElement.innerHTML){case"Level 1":"level1"==document.getElementById("level1").className?create(1):V.map;break;case"Level 2":"level2"==document.getElementById("level2").className?create(2):V.map;break;case"Level 3":"level3"==document.getElementById("level3").className?create(3):V.map;break;case"Level 4":"level4"==document.getElementById("level4").className?create(4):V.map;break;case"Level 5":"level5"==document.getElementById("level5").className?create(5):V.map;break;case"Level 6":"level6"==document.getElementById("level6").className?create(6):V.map}},this.waves=function(a,b){switch(a){case 1:switch(b){case 0:V.score=80,V.lifes=15,V.countWaves=10;break;case 1:V.s.push("orc",1,4,40);break;case 2:V.s.push("orc",1,5,40);break;case 3:V.s.push("orc",1,10,35),V.s.push("orc",2,1,60);break;case 4:V.s.push("man",1,5,50);break;case 5:V.s.push("orc",2,10,45),V.s.push("man",1,5,55);break;case 6:V.s.push("man",1,5,45),V.s.push("orc",1,25,35);break;case 7:V.s.push("orc",3,25,40);break;case 8:V.s.push("man",2,10,40),V.s.push("orc",4,20,35);break;case 9:V.s.push("orc",5,25,25),V.s.push("man",3,10,50),V.s.push("man",2,20,45);break;case 10:V.s.push("worm",5,2,50);break;case 11:this.animWin(),document.getElementById("level2").className="level2"}break;case 2:switch(b){case 0:V.score=200,V.lifes=15,V.countWaves=15;break;case 1:V.s.push("orc",1,10,25);break;case 2:V.s.push("orc",1,20,25),V.s.push("man",1,5,40);break;case 3:V.s.push("orc",1,25,25),V.s.push("man",2,4,60);break;case 4:V.s.push("orc",2,20,25),V.s.push("man",1,10,40),V.s.push("orc",2,5,100);break;case 5:V.s.push("orc",2,10,25),V.s.push("orc",3,5,25),V.s.push("man",2,5,40);break;case 6:V.s.push("worm",1,10,35);break;case 7:V.s.push("worm",1,5,35),V.s.push("orc",2,4,50);break;case 8:V.s.push("orc",5,20,30),V.s.push("man",3,10,50);break;case 9:V.s.push("worm",2,10,35),V.s.push("man",4,10,40);break;case 10:V.s.push("worm",5,3,80);break;case 11:V.s.push("orc",4,25,30),V.s.push("man",5,5,40);break;case 12:V.s.push("orc",6,10,35),V.s.push("worm",5,10,50),V.s.push("orc",6,20,35);break;case 13:V.s.push("man",8,10,40);break;case 14:V.s.push("orc",10,16,30),V.s.push("man",7,12,40),V.s.push("worm",6,8,40);break;case 15:V.s.push("man",12,4,100),V.s.push("worm",9,2,80),V.s.push("dragon",6,1,150);break;case 16:this.animWin(),document.getElementById("level3").className="level3"}break;case 3:switch(b){case 0:V.score=1e3,V.lifes=5,V.countWaves=10;break;case 1:V.s.push("man",5,10,40);break;case 2:V.s.push("orc",10,10,25),V.s.push("man",6,10,40);break;case 3:V.s.push("orc",10,10,25),V.s.push("man",6,10,40);break;case 4:V.s.push("worm",4,30,50);break;case 5:V.s.push("dragon",3,12,60);break;case 6:V.s.push("orc",12,20,25),V.s.push("man",8,10,40);break;case 7:V.s.push("orc",12,30,25),V.s.push("dragon",4,10,50);break;case 8:V.s.push("worm",6,30,50);break;case 9:V.s.push("man",12,20,25),V.s.push("dragon",6,10,50);break;case 10:V.s.push("zombie",10,2,100);break;case 11:this.animWin(),document.getElementById("level4").className="level4"}break;case 4:switch(b){case 0:V.score=250,V.lifes=10,V.countWaves=12;break;case 1:V.s.push("orc",2,30,40);break;case 2:V.s.push("orc",3,20,40),V.s.push("dragon",1,8,55);break;case 3:V.s.push("zombie",1,2,55),V.s.push("orc",2,20,35);break;case 4:V.s.push("worm",1,10,25),V.s.push("man",2,20,40),V.s.push("dragon",2,4,50);break;case 5:V.s.push("orc",4,40,35);break;case 6:V.s.push("zombie",2,2,45),V.s.push("dragon",2,10,50),V.score+=250;break;case 7:V.s.push("zombie",3,4,65),V.s.push("worm",4,15,50),V.s.push("dragon",3,10,60);break;case 8:V.s.push("man",6,20,45),V.s.push("zombie",4,10,55),V.score+=250;break;case 9:V.s.push("orc",12,30,25),V.s.push("dragon",6,15,45);break;case 10:V.s.push("worm",10,30,55),V.s.push("zombie",6,10,45),V.s.push("dragon",6,15,25),V.score+=250;break;case 11:V.s.push("zombie",10,20,65);break;case 12:V.s.push("knight",12,4,150);break;case 13:this.animWin(),document.getElementById("level5").className="level5"}break;case 5:switch(b){case 0:V.score=250,V.lifes=5,V.countWaves=10;break;case 1:V.s.push("man",1,10,35),V.s.push("dragon",1,2,55),V.s.push("man",1,10,35),V.score+=100;break;case 2:V.s.push("zombie",1,2,65),V.s.push("dragon",1,8,40),V.s.push("zombie",1,2,65),V.score+=100;break;case 3:V.s.push("knight",1,2,75),V.s.push("dragon",2,8,40),V.s.push("knight",1,2,75),V.score+=100;break;case 4:V.s.push("worm",3,8,40),V.s.push("zombie",1,10,40),V.s.push("knight",1,2,75),V.score+=100;break;case 5:V.s.push("orc",10,30,25),V.s.push("dragon",4,10,40),V.s.push("orc",10,30,25),V.score+=100;break;case 6:V.s.push("man",8,30,35),V.s.push("knight",4,2,250),V.score+=100;break;case 7:V.s.push("orc",14,30,25),V.s.push("zombie",4,10,45),V.s.push("dragon",5,20,35),V.s.push("knight",6,2,250),V.score+=100;break;case 8:V.s.push("worm",11,30,35),V.s.push("man",10,15,140),V.s.push("man",30,4,140),V.score+=100;break;case 9:V.s.push("orc",15,30,25),V.s.push("knight",5,8,45),V.s.push("dragon",8,10,40),V.score+=100;break;case 10:V.s.push("zombie",15,2,140),V.s.push("dragon",15,2,140),V.s.push("knight",15,1,140),V.score+=500;break;case 11:this.animWin(),document.getElementById("level6").className="level6"}break;case 6:switch(b){case 0:V.score=500,V.lifes=5,V.countWaves=10;break;case 1:V.s.push("orc",1,30,25),V.s.push("orc",5,5,55);break;case 2:V.s.push("man",1,25,30),V.s.push("man",5,5,60),V.score+=100;break;case 3:V.s.push("worm",1,20,35),V.s.push("worm",5,5,65),V.score+=100;break;case 4:V.s.push("dragon",1,15,45),V.s.push("dragon",5,5,70),V.score+=100;break;case 5:V.s.push("zombie",1,10,45),V.s.push("zombie",5,5,75),V.score+=100;break;case 6:V.s.push("knight",1,10,50),V.s.push("knight",5,5,80),V.score+=100;break;case 7:V.s.push("zombie",2,15,45),V.s.push("dragon",3,15,50),V.score+=100;break;case 8:V.s.push("knight",5,10,60),V.score+=100;break;case 9:V.s.push("orc",10,25,35),V.s.push("man",10,15,40),V.s.push("worm",10,10,45),V.score+=100;break;case 10:V.s.push("orc",20,5,35),V.s.push("man",15,5,40),V.s.push("worm",12,5,45),V.s.push("dragon",10,5,45),V.s.push("zombie",8,5,45),V.s.push("knight",6,5,45),V.score+=500;break;case 11:this.animWin(),V.ctx_bg.fillStyle="red",V.ctx_bg.font="italic "+8*V.sc+"pt Calibri",V.ctx_bg.fillText("CONGRATULATION!",5*V.sc,200*V.sc),V.ctx_bg.fillText("You beat all Levels!",5*V.sc,230*V.sc)}}},this.animationLoop=function(a){if(requestAnimationFrame(animationLoop),a-V.lastTime>=1e3/V.fps)if(V.lastTime=a,V.mainmenu){if(V.fps=40,document.getElementById("main-menu").style.display="block",V.timer%V.rand(50,100)==0){V.timer=0;var b=V.rand(1,4);switch(b){case 1:Board.addEnemy("orc",2);break;case 2:Board.addEnemy("orc",2);break;case 3:Board.addEnemy("man",2);break;case 4:Board.addEnemy("dragon",2)}}V.ctx.clearRect(0,0,V.W,V.H),Menu.fireworks(4),Board.draw()}else V.ctx.clearRect(0,0,V.W,V.H),Board.draw(),Menu.fill()},this.drop=function(a,b,c,d){if(0!=V.fps){var e=Math.floor(b/(20*V.sc)),f=Math.floor(c/(20*V.sc));return b>10*V.sc&&b<310*V.sc&&c>10*V.sc&&c<230*V.sc?(V.ctx_r.clearRect(0,0,V.W,V.H),V.ctx_r.beginPath(),V.ctx_r.arc((20*e+10)*V.sc,(20*f+10)*V.sc,V[a+"R"]*V.sc,0,2*Math.PI),V.ctx_r.stroke()):V.ctx_r.clearRect(0,0,V.W,V.H),Board.addTower(e,f,a,d,1)}},this.mouse=function(a){var b=Math.floor(a.offsetX/(20*V.sc)),c=Math.floor(a.offsetY/(20*V.sc));V.ctx_r.clearRect(0,0,V.W,V.H),Menu.upgradeInfo.style.visibility="hidden",Board.Towers[b][c]&&0!=V.fps&&Menu.upgrade(b,c,Board.Towers[b][c].type,Board.Towers[b][c].TLvl)},this.animWin=function(){for(var a=0;30>=a;a++)Menu.animWin(a)},{init:init,drop:drop}}();T.prototype.draw=function(){V.ctx.save(),V.ctx.translate(this.x+10*V.sc,this.y+10*V.sc),V.ctx.rotate(this.angle*V.rad),V.ctx.drawImage(V.sprite,this.FX,this.FY,this.FXS,this.FYS,-this.RX*V.sc*(.8+this.TLvl/20),-this.RY*V.sc*(.8+this.TLvl/20),this.FXS*V.sc*(.8+this.TLvl/20),this.FYS*V.sc*(.8+this.TLvl/20)),V.ctx.restore()},T.prototype.shoot=function(a){for(var b,c,d,e=0;e<a.length;e++)this.sY=Math.round(this.y+10*V.sc-a[e].y),this.sX=Math.round(this.x+10*V.sc-a[e].x),this.aRa=Math.round(Math.sqrt(this.sX*this.sX+this.sY*this.sY))/V.sc,this.aRa<=this.ra&&(b>-1?a[b].distance<a[e].distance&&(b=e,c=this.sY,d=this.sX):(b=e,c=this.sY,d=this.sX));if(this.AR&&(this.angle+=this.AR+Math.abs(this.aAR),this.aAR>10?this.aAR-=.2:this.aAR>0?this.aAR-=.1:this.aAR),b>-1&&"Earth"!=this.type){if(this.AR?this.aAR+=.2:this.angle=Math.round(Math.atan2(c,d)/V.rad-90),this.aRel>=this.rel)return this.aRel=0,!0;this.aRel++}},B.prototype.addTower=function(a,b,c,d,e){var f=V[c]*e;if(!(16>a&&12>b))return!1;if(!this.Towers[a][b]&&V.score>=f)if("Earth"!=c){if("G"==this.b[b][a].type){if(d)return!0;this.Towers[a][b]=new T(this.V,a,b,c,e),this.Towers[a][b].draw(a,b),V.score-=f}}else if("G"!=this.b[b][a].type&&"R"!=this.b[b][a].type){if(d)return!0;this.Towers[a][b]=new T(this.V,a,b,c,e),this.Towers[a][b].draw(a,b),V.score-=f}},B.prototype.addEnemy=function(a,b){var c=this.startPos[V.rand(0,this.startPos.length-1)];this.Enemy[this.Enemy.length]=new E(this.V,c.x,c.y,a,b)},B.prototype.addGold=function(){for(var a=0;a<V.lifes;a++)this.Golds[a]=new G(this.V,this.gold.x,this.gold.y),this.Golds[a].draw()},B.prototype.delete=function(a,b){return a.slice(0,b).concat(a.slice(b+1))},B.prototype.draw=function(){for(var a=0;16>a;a++)for(var b=0;12>b;b++)if(this.Towers[a][b]&&(this.Towers[a][b].draw(),this.Towers[a][b].shoot(this.Enemy)))if("Air"==this.Towers[a][b].type)for(var c=0;24>c;c++)this.Bullets[this.Bullets.length]=new Bullet(this.V,this.Towers[a][b].type,this.Towers[a][b].TLvl,this.Towers[a][b].x,this.Towers[a][b].y,15*c);else this.Bullets[this.Bullets.length]=new Bullet(this.V,this.Towers[a][b].type,this.Towers[a][b].TLvl,this.Towers[a][b].x,this.Towers[a][b].y,this.Towers[a][b].angle);for(var a=0;a<this.Bullets.length;a++){this.Bullets[a].draw();for(var b=0;b<this.Enemy.length;b++){if(this.Bullets[a].timeLife<=0){this.Bullets=this.delete(this.Bullets,a);break}if(this.Enemy[b].hit(this.Bullets[a].ax,this.Bullets[a].ay)){this.Enemy[b].hp-=this.Bullets[a].dmg,this.Bullets=this.delete(this.Bullets,a);break}}}for(var a=0;a<this.Enemy.length;a++)this.Enemy[a].hp>0&&(this.Enemy[a].move(this.b,this.Towers),this.Enemy[a].draw()),this.Enemy[a].hp<=0&&(V.score+=this.Enemy[a].score,this.Enemy=this.delete(this.Enemy,a),this.Enemy[a]&&(this.Enemy[a].move(this.b,this.Towers),this.Enemy[a].draw()));V.lifes<=0&&0==V.mainmenu&&this.defeatAnimTimer>=0&&(this.defeatAnimTimer--,V.ctx.beginPath(),V.ctx.lineWidth=(30-this.defeatAnimTimer)*V.sc*9,V.ctx.strokeStyle="rgba(200,150,100,"+(30-this.defeatAnimTimer)/35+")",V.ctx.rect(0,0,V.W,V.H),V.ctx.stroke(),this.defeatAnimTimer<=0&&(V.ctx_r.clearRect(0,0,V.W,V.H),V.life=0,V.mainmenu=1,document.getElementById("waves").style.visibility="hidden",Menu.upgradeInfo.style.visibility="hidden",Menu.buttons[0].style.background="#88d98a")),0!=this.Enemy.length||V.s.length||0!=V.mainmenu||(Menu.startButton.style.display="block",this.Bullets=[],this.Enemy=[],V.timer=-901,V.fps=40,Menu.buttons[0].style.background="#88d98a",V.score+=5*this.waves,this.waves++,waves(V.map,this.waves)),V.timer++,V.s.length>=1&&0==V.mainmenu&&V.timer>V.s[3]&&(Menu.startButton.style.display="none",0==V.s[2]?(V.s=this.delete(V.s,3),V.s=this.delete(V.s,2),V.s=this.delete(V.s,1),V.s=this.delete(V.s,0)):(this.addEnemy(V.s[0],V.s[1]),V.s[2]--),V.timer=0)},B.prototype.drawBg=function(){for(var a=0;a<this.b.length;a++)for(var b=0;b<this.b[a].length;b++)"G"==this.b[a][b].type||"R"==this.b[a][b].type?(this.cx.fillStyle="#5fc148",this.cx.fillRect((20*b+2)*V.sc*this.size,(20*a+1)*V.sc*this.size,16.5*V.sc*this.size,16*V.sc*this.size),this.cx.drawImage(V.sprite,0,53,40,50,40*b*V.sc/2*this.size,(40*a*V.sc/2-5*V.sc)*this.size,40*V.sc/2*this.size,50*V.sc/2*this.size),"R"==this.b[a][b].type&&(this.cx.save(),this.cx.translate((40*b+20)*V.sc/2*this.size,((40*a+30)*V.sc/2-5*V.sc)*this.size),this.cx.rotate(V.rand(-20,100)*V.rad),this.cx.drawImage(V.sprite,51,34,10,10,-10*this.size,-10*this.size,20*V.sc/2*this.size,20*V.sc/2*this.size),this.cx.restore())):(this.cx.fillStyle="#bebf6a",this.cx.fillRect((20*b+2)*V.sc*this.size,(20*a+1)*V.sc*this.size,16.5*V.sc*this.size,16*V.sc*this.size),this.cx.drawImage(V.sprite,40,83,20,20,40*b*V.sc/2*this.size,40*a*V.sc/2*this.size,40*V.sc/2*this.size,40*V.sc/2*this.size),"X"==this.b[a][b].type&&(this.gold.x=40*b*V.sc/2,this.gold.y=40*a*V.sc/2,this.gold.i=a,this.gold.j=b))},B.prototype.parse=function(a){for(var b=0;b<a.length;b++){this.b.push([]);for(var c=0;c<a[b].length;c++)this.b[b].push(this.elements[" "==a[b].charAt(c)?"grass":a[b].charAt(c)]),("Y"==a[b].charAt(c)||"V"==a[b].charAt(c)||"<"==a[b].charAt(c)||">"==a[b].charAt(c))&&this.startPos.push({x:2*(10*c+2),y:2*(10*b+3)})}},B.prototype.goldDraw=function(){this.Golds=this.delete(this.Golds,this.Golds.length-1),this.clearBlock(this.gold.j,this.gold.i);for(var a=0;a<this.Golds.length;a++)this.Golds[a].draw()},B.prototype.clearBlock=function(a,b){"G"==this.b[b][a].type?(V.ctx_bg.fillStyle="#5fc148",V.ctx_bg.fillRect((20*a+2)*V.sc,(20*b+1)*V.sc,16.5*V.sc,16*V.sc),V.ctx_bg.drawImage(V.sprite,0,53,40,50,40*a*V.sc/2,40*b*V.sc/2-5*V.sc,40*V.sc/2,50*V.sc/2)):(V.ctx_bg.fillStyle="#bebf6a",V.ctx_bg.fillRect((20*a+2)*V.sc,(20*b+1)*V.sc,16.5*V.sc,16*V.sc),V.ctx_bg.drawImage(V.sprite,40,83,20,20,40*a*V.sc/2,40*b*V.sc/2,40*V.sc/2,40*V.sc/2))},E.prototype.move=function(a,b){switch(this.bx=Math.floor(this.x/(20*V.sc)),this.by=Math.floor(this.y/(20*V.sc)),a[this.by][this.bx].type){case"W":-360==this.rotate?this.rotate=0:this.rotate,90!=this.rotate&&this.rotate<90?this.rotate+=2.5:90!=this.rotate&&(this.rotate-=2.5);break;case"S":180==this.rotate?this.rotate=-180:this.rotate,-90!=this.rotate&&this.rotate<-90?this.rotate+=2.5:-90!=this.rotate&&(this.rotate-=2.5);break;case"A":-270==this.rotate?this.rotate=-90:this.rotate,0!=this.rotate&&this.rotate<0?this.rotate+=2.5:0!=this.rotate&&(this.rotate-=2.5);break;case"D":-90==this.rotate?this.rotate=270:this.rotate,180!=this.rotate&&this.rotate<180?this.rotate+=2.5:180!=this.rotate&&(this.rotate-=2.5);break;case"X":0==V.mainmenu&&(V.ctx.beginPath(),V.ctx.lineWidth=20*V.sc,V.ctx.strokeStyle="rgba(200,100,100,0.4)",V.ctx.rect(0,0,V.W,V.H),V.ctx.stroke(),V.lifes--),this.hp=0,this.life=0,Board.goldDraw();break;case"Y":this.rotate=90;break;case"V":this.rotate=-90;break;case"<":this.rotate=0;break;case">":this.rotate=180}b[this.bx][this.by]&&this.gr&&(this.aSpeed=this.speed/(b[this.bx][this.by].TLvl/2+1)),this.x+=Math.round(Math.sin(V.rad*(this.rotate-90))*this.aSpeed*10)/20,this.y-=Math.round(Math.cos(V.rad*(this.rotate-90))*this.aSpeed*10)/20,this.distance+=this.aSpeed,this.aSpeed=this.speed},E.prototype.draw=function(){this.hp<this.life&&(V.ctx.fillStyle="rgba(250,10,10,0.5)",V.ctx.fillRect(this.x-this.FXS/3*this.rise,this.y-this.FYS*this.rise,10*V.sc,1*V.sc),V.ctx.fillStyle="rgba(0,240,100,0.9)",V.ctx.fillRect(this.x-this.FXS/3*this.rise,this.y-this.FYS*this.rise,this.hp/this.life*V.sc*10,1*V.sc)),this.frame<this.fC.length-1&&this.fRa>=this.fR?(this.frame++,this.fRa=0):this.fRa++,this.frame==this.fC.length-1&&this.fRa>=this.fR&&(this.frame=0,this.fRa=0),V.ctx.save(),V.ctx.translate(this.x,this.y),V.ctx.rotate((this.rotate+this.Frot)*V.rad),V.ctx.drawImage(V.sprite,this.FX+this.fC[this.frame]*this.FXS,this.FY,this.FXS,this.FYS,-this.FXS,-this.FYS,this.FXS*this.rise,this.FYS*this.rise),V.ctx.restore()},E.prototype.hit=function(a,b){return this.x-this.FXS*this.rise/2<a&&this.x+this.FXS*this.rise/2>a&&this.y-this.FYS*this.rise/2<b&&this.y+this.FYS*this.rise/2>b?!0:!1},Bullet.prototype.draw=function(){switch(this.timeLife--,V.ctx.fillStyle="rgba("+this.r+","+this.g+","+this.b+",0.8)",this.type){case"Water":this.ax+=Math.sin(this.a*V.rad)*V.sc*4*this.v,this.ay-=Math.cos(this.a*V.rad)*V.sc*4*this.v,V.ctx.beginPath(),V.ctx.arc(this.ax,this.ay,2.2*(.4+this.lvl/6)*V.sc,0,2*Math.PI),V.ctx.fill();break;case"Fire":this.ax+=Math.sin(this.a*V.rad)*V.sc*4*this.v,this.ay-=Math.cos(this.a*V.rad)*V.sc*4*this.v,V.ctx.beginPath(),V.ctx.arc(this.ax,this.ay,3*(.4+this.lvl/6)*V.sc,0,2*Math.PI),V.ctx.fill();break;case"Air":this.ax+=Math.sin(this.a*V.rad)*V.sc*4*this.v,this.ay-=Math.cos(this.a*V.rad)*V.sc*4*this.v,V.ctx.beginPath(),V.ctx.arc(this.ax,this.ay,2*(.4+this.lvl/6)*V.sc,0,2*Math.PI),V.ctx.fill()}},M.prototype.fill=function(){if(document.getElementById("money").innerHTML=V.score+"$",document.getElementById("lifes").innerHTML=V.lifes,V.timer%30==0&&V.timer<=0){var a;if(a=Board.waves>V.countWaves?V.countWaves:Board.waves,this.wavesInfo[0].innerHTML=-V.timer/30!=0?"("+a+" of "+V.countWaves+") "+-V.timer/30:"("+a+" of "+V.countWaves+") ",V.timer<=0)for(var b=0,c=1;16>b;b+=4,c++)this.wavesInfo[c].innerHTML=V.s.length<=b?" ":V.s[b]+" ("+V.s[b+1]+") "+V.s[b+2]}this.up&&this.cost<=V.score&&5!=this.level&&(this.upgradeInfo.getElementsByTagName("button")[0].style.background="#88d98a")},M.prototype.upgrade=function(a,b,c,d){V.ctx_r.beginPath(),V.ctx_r.arc((20*a+10)*V.sc,(20*b+10)*V.sc,V[c+"R"]*V.sc,0,2*Math.PI),V.ctx_r.stroke(),this.cost=(d+1)*V[c],this.level=d,this.upgradeInfo.getElementsByTagName("button")[0].style.background="#c8d98a",this.upgradeInfo.getElementsByTagName("button")[1].style.background="#d4745b",this.upgradeInfo.getElementsByTagName("p")[0].innerHTML=c+"Element",this.upgradeInfo.getElementsByTagName("p")[1].innerHTML="Lvl "+(d+1)+" cost "+(d+1)*V[c]+"$",5==d?this.upgradeInfo.getElementsByTagName("p")[1].innerHTML="MAX":d,this.upgradeInfo.getElementsByTagName("p")[2].innerHTML="&nbsp Return "+d*V[c]+"$ &nbsp",this.upgradeInfo.style.visibility="visible",Menu.up=1,this.upgradeInfo.getElementsByTagName("button")[0].onclick=function(){V.score>=(d+1)*V[c]&&5>d&&0!=V.fps&&(Menu.up=0,delete Board.Towers[a][b],Board.addTower(a,b,c,0,d+1),V.ctx_r.clearRect(0,0,V.W,V.H),Menu.upgradeInfo.style.visibility="hidden",Menu.upgrade(a,b,c,d+1))},this.upgradeInfo.getElementsByTagName("button")[1].onclick=function(){0!=V.fps&&(Menu.up=0,delete Board.Towers[a][b],Board.clearBlock(a,b),V.score+=d*V[c],V.ctx_r.clearRect(0,0,V.W,V.H),Menu.upgradeInfo.style.visibility="hidden")}},M.prototype.fireworks=function(a){this.visible.length=0;for(var b=0;a>b;b++)this.all.push({x:V.W*V.rand(5,95)/100,y:V.H/10,h:V.rand(2,3),speedX:V.rand(-100,100)/100,speedY:V.rand(0,300)/100,r:V.rand(0,255),g:V.rand(0,55),b:V.rand(0,55)});for(var b=0;b<this.all.length;b++){var c=this.all[b];c.x+=c.speedX,c.y+=c.speedY,V.ctx.fillStyle="rgba("+c.r+","+c.g+","+c.b+",1)",c.speedY=c.speedY+.06,c.r=Math.min(255,c.r+2),c.g=Math.min(255,c.g+2),c.b=Math.min(255,c.b+2),V.ctx.fillRect(c.x-c.h/2,c.y-c.h/2,c.h,c.h),c.x+c.h/2>0&&c.x-c.h/2<V.W&&c.y+c.h/2>0&&c.y-c.h/2<V.H&&(255!=c.r||255!=c.g||255!=c.b)&&this.visible.push(c)}this.all=this.visible.concat()},M.prototype.animCreating=function(a){var a=a;setTimeout(function(){V.ctx_bg.fillStyle="rgba(203,229,225,0.1)",V.ctx_bg.fillRect(0,0,V.W,V.H/20*a),V.timer=-1801,a>30&&(document.getElementById("waves").style.visibility="visible",Menu.up=0,V.ctx_bg.clearRect(0,0,V.W,V.H),V.ctx_r.clearRect(0,0,V.W,V.H),Board.drawBg(),Board.addGold(),V.timer=-1801,0==V.mainmenu&&(document.getElementById("main-menu").style.display="none"))},40*a)},M.prototype.animWin=function(a){var a=a;setTimeout(function(){V.ctx_bg.fillStyle="rgba(183,209,255,"+(1-a/30)+")",V.ctx_bg.fillRect(0,V.H/29*a,V.W,V.H/29),V.ctx_r.clearRect(0,0,V.W,V.H),V.mainmenu=1,1==a&&(Menu.up=0,document.getElementById("waves").style.visibility="hidden",Menu.upgradeInfo.style.visibility="hidden",Menu.buttons[0].style.background="#88d98a",Menu.buttons[1].style.background="#88d98a")},40*a)},G.prototype.draw=function(){V.ctx_bg.save(),V.ctx_bg.translate(this.x,this.y),V.ctx_bg.rotate(this.angle*V.rad),V.ctx_bg.drawImage(V.sprite,32,15,13,7,-4,-7,20*V.sc/2,10*V.sc/2),V.ctx_bg.restore()};