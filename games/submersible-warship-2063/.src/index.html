<style>body{margin:0;text-align:center;background:#000;touch-action:none}canvas{image-rendering:-moz-crisp-edges;image-rendering:pixelated}</style><canvas id="c"></canvas><script>!function(){function e(e,n,t){return e>t?t:n>e?n:e}function n(e,n){return Math.floor(Math.random()*(n+1-e)+e)}function t(e){return e[n(0,e.length-1)]}var i=songs={konamiCode:{songData:[{i:[0,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,11,6],p:[1],c:[{n:[146,149,154,158,154],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},markSparlingSong:{songData:[{i:[2,104,128,0,3,234,128,0,0,0,0,20,35,0,0,0,195,6,1,2,183,152,0,49,147,4,103,4],p:[1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2],c:[{n:[135,,,,142,,,,143,,,,147,,,,135,,,,142,,,,143,,,,147],f:[21,,,,,,21,,,21,,21,21,,21,21,,21,21,,21,21,21,21,21,21,21,21,21,21,21,21,15,,,,,,15,,,17,,18,20,,21,24,,25,27,,30,31,33,37,40,43,45,51,53,55,58,60]},{n:[135,,,,142,,,,143,,,,147,,,,150,,,,154,,,,155,,,,159],f:[21,,,,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,,21,,,63,,,,71,82,89,92,96,99,102,107,111,115,120,127,131,135,141,145,149,155,159,164,168,172,,177,,183]}]},{i:[2,208,128,0,2,201,128,1,0,0,0,148,67,0,0,0,16,0,1,2,0,120,53,33,17,4,84,6],p:[,,3,4,3,4,3,4,3,4,3,4,3,4,3,4,9,10,36,4,3,4,3,4,3,4,3,4,3,4],c:[{n:[],f:[]},{n:[],f:[]},{n:[111],f:[21,21,21,,21,21,21,,21,,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,1,2,2,,3,2,4,,5,,6,6,6,7,8,7,8,10,13,15,17,20,22,24,26,28,31,,35,40,46,48]},{n:[111],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,48,63,59,69,77,88,96,102,113,131,143,157,168,186,195,120,107,92,82,71,60,46,39,30,19,11,5,4,2,1]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[119],f:[21,21,21,,21,21,21,,21,,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,1,2,2,,3,2,4,,5,,6,6,6,7,8,7,8,10,13,15,17,20,22,24,26,28,31,,35,40,46,48]},{n:[119],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,48,63,59,69,77,88,96,102,113,131,143,157,168,186,195,120,107,92,82,71,60,46,39,30,19,11,5,4,2,1]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[148],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[119,,,,,,,,,,,,,,,,121],f:[21,21,21,,21,21,21,,21,,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,1,2,2,,3,2,4,,5,,6,6,6,7,8,7,8,10,13,15,17,20,22,24,26,28,31,,35,40,46,48]}]},{i:[2,75,128,0,2,84,128,8,0,0,12,186,61,0,0,0,0,0,0,2,0,77,0,32,83,3,130,4],p:[,,5,6,5,6,5,6,5,6,5,6,5,6,5,6,7,8,34,6,5,6,5,6,5,6,5,6,5,6],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[99],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,21,21,21,21,21,21,,2,4,6,9,14,20,26,31,38,46,48,51,53,55,59,69,71,74,77,80,,88,99,106,113,122,135,139,147,153,157]},{n:[99],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,242,237,232,214,200,183,164,155,145,131,120,102,86,71,63,57,,52,48,44,36,30,23,17,13,10,6,4,2,1,1]},{n:[107],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,21,21,21,21,21,21,,2,4,6,9,14,20,26,31,38,46,48,51,53,55,59,69,71,74,77,80,,88,99,106,113,122,135,139,147,153,157]},{n:[107],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,242,237,232,214,200,183,164,155,145,131,120,102,86,71,63,57,,52,48,44,36,30,23,17,13,10,6,4,2,1,1]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[107,,,,,,,,,,,,,,,,109],f:[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,,21,21,21,21,21,21,21,21,21,21,,2,4,6,9,14,20,26,31,38,46,48,51,53,55,59,69,71,74,77,80,,88,99,106,113,122,135,139,147,153,157]}]},{i:[0,57,128,0,3,57,128,0,0,0,5,6,77,0,0,0,195,6,1,2,19,0,0,32,255,6,207,1],p:[,,,,28,30,28,30,28,30,28,30,28,30,28,30,28,30,28,30,28,30,28,30,28,30,28,30],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,,,138,,,,,,,,,,,,,,,,,,,,,,,,138,,,,,,,,142,,,,,,,,,,,,,,,,,,,,,,,,143,,,,,,,,123,,,,,,,,,,,,,,,,,,,,,,,,123],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,,,138,,,,,,,,,,,,,,,,,,,,,,,,138,,,,,,,,142,,,,,,,,,,,,,,,,,,,,,,,,140,,,,,,,,123,,,,,,,,,,,,,,,,,,,,,,,,123],f:[]}]},{i:[2,0,128,0,2,201,128,0,0,0,15,6,20,0,0,0,93,4,1,3,70,199,10,32,130,2,33,6],p:[,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[155,154,150,147,155,154,150,147,155,154,150,147,155,154,150,147,155,154,150,147,155,154,150,147,155,154,150,147,155,154,150,147],f:[]}]},{i:[0,160,128,1,0,160,128,0,1,210,4,7,41,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[,,,,,,,,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,,,,,135,,,,,,,,,,,,,,,,135],f:[]}]},{i:[0,255,116,1,0,255,116,0,1,0,4,6,35,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[,,,,,,,,27,15,27,15,27,15,27,15,27,15,27,15,27,15,27,15],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,135,,,,135],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,,,135],f:[]}]},{i:[2,117,128,0,1,92,128,2,0,19,17,20,68,0,0,0,51,2,1,2,232,112,0,32,171,3,81,4],p:[,,,,,,,,,,,,35,31,19,25,35,31,19,25],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[150,,,,,,,,152,,,,,,,,149,,,,,,,,145,,,,,,,,147,,,,,,,,147,,,,,,,,142,,,,,,,,142],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[154,,,,,,,,154,,,,,,,,154,,,,,,,,154,,,,,,,,147,,,,,,,,147,,,,,,,,145,,,,,,,,145],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[154,,,,,,,,154,,,,,,,,147,,,,,,,,149,,,,,,,,147,,,,,,,,147,,,,,,,,142,,,,,,,,142],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[147,,,,,,,,147,,,,,,,,147,,,,,,,,147,,,,,,,,154,,,,,,,,154,,,,,,,,152,,,,,,,,152],f:[]}]}],rowLen:4410,patternLen:32,endPattern:29,numChannels:8}},o=CPlayer=function(){var e,n,t,i,o,r=e=>Math.sin(6.283184*e),a=e=>.003959503758*Math.pow(2,(e-128)/12),s=(e,n,t)=>{var i,o,r,s,f,l,c,d=h[e.i[0]],g=e.i[1],w=e.i[3],p=h[e.i[4]],u=e.i[5],y=e.i[8],m=e.i[9],b=e.i[10]*e.i[10]*4,k=e.i[11]*e.i[11]*4,A=e.i[12]*e.i[12]*4,P=1/A,T=e.i[13],v=t*Math.pow(2,2-e.i[14]),S=new Int32Array(b+k+A),M=0,x=0;for(i=0,o=0;b+k+A>i;i++,o++)0>o||(o-=v,l=a(n+(15&(T=T>>8|(255&T)<<4))+e.i[2]-128),c=a(n+(15&T)+e.i[6]-128)*(1+8e-4*e.i[7])),r=1,b>i?r=i/b:b+k>i||(r-=(i-b-k)*P),s=l,w&&(s*=r*r),f=d(M+=s)*g,s=c,y&&(s*=r*r),f+=p(x+=s)*u,m&&(f+=(2*Math.random()-1)*m),S[i]=80*f*r|0;return S},h=[r,e=>.5>e%1?1:-1,e=>e%1*2-1,e=>{var n=e%1*4;return 2>n?n-1:3-n}];this.init=(r=>{e=r,n=r.endPattern,t=0,i=r.rowLen*r.patternLen*(n+1)*2,o=new Int32Array(i)}),this.generate=(()=>{var a,f,l,c,d,g,w,p,u,y,m,b,k,A,P=new Int32Array(i),T=e.songData[t],v=e.rowLen,S=e.patternLen,M=0,x=0,I=!1,C=[];for(l=0;n>=l;++l)for(w=T.p[l],c=0;S>c;++c){var B=w?T.c[w-1].f[c]:0;B&&(T.i[B-1]=T.c[w-1].f[c+S]||0,16>B&&(C=[]));var R=h[T.i[15]],E=T.i[16]/512,L=Math.pow(2,T.i[17]-9)/v,F=T.i[18],D=T.i[19],W=135.82764118168*T.i[20]/44100,K=1-T.i[21]/255,U=1e-5*T.i[22],O=T.i[23]/32,j=T.i[24]/512,V=6.283184*Math.pow(2,T.i[25]-9)/v,Y=T.i[26]/255,z=T.i[27]*v&-2;for(m=(l*S+c)*v,d=0;4>d;++d)if(g=w?T.c[w-1].n[c+d*S]:0){C[g]||(C[g]=s(T,g,v));var H=C[g];for(f=0,a=2*m;f<H.length;f++,a+=2)P[a]+=H[f]}for(f=0;v>f;f++)(y=P[p=2*(m+f)])||I?(b=W,F&&(b*=R(L*p)*E+.5),x+=(b=1.5*Math.sin(b))*(k=K*(y-x)-(M+=b*x)),y=3==D?x:1==D?k:M,U&&(y=1>(y*=U)?y>-1?r(.25*y):-1:1,y/=U),I=(y*=O)*y>1e-5,A=y*(1-(u=Math.sin(V*p)*j+.5)),y*=u):A=0,z>p||(A+=P[p-z+1]*Y,y+=P[p-z]*Y),P[p]=0|A,P[p+1]=0|y,o[p]+=0|A,o[p+1]+=0|y}return++t/e.numChannels}),this.createWave=(()=>{var e=44+2*i-8,n=e-36,t=new Uint8Array(44+2*i);t.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&n,n>>8&255,n>>16&255,n>>24&255]);for(var r=0,a=44;i>r;++r){var s=o[r];s=-32767>s?-32767:s>32767?32767:s,t[a++]=255&s,t[a++]=s>>8&255}return t}),this.getData=((e,n)=>{for(var t=2*Math.floor(44100*e),i=Array(n),r=0;2*n>r;r+=1){var a=t+r;i[r]=e>0&&a<o.length?o[a]/32768:0}return i})};const r=[38,38,40,40,37,39,37,39,66,65];let a=0;const s=0,h=1,f=2,l=3,d=4;let g,w,p,u,y,m,b=s,k=!1,A=!1,P=0,T=[],v=0;const S=1,M=2,x=180/Math.PI;let I={play:()=>{}},C={play:()=>{}},B=!1;function R(){this.left=0,this.right=0,this.up=0,this.down=0}function E(e,n,t){this.type=e,this.target=void 0,this.nextSteering=n||.5,this.remainingBeforeSteering=0,this.nextAttack=t||1,this.remainingBeforeAttack=0}function L(e,n=0,t=0,i=0){this.speed=e,this.dx=n,this.dy=t,this.dr=i}function F(e,n,t=0){this.x=e,this.y=n,this.r=t}function D(e,n,t,i){this.collide=e,this.killable=n,this.radius=t,this.group=i}function W(e){this.timeLeft=e}function K(e,n,t,i){this.alwaysRender=e,this.renderer=n,this.radarRenderer=t,this.debrisRenderer=i}const U=c.getContext("2d"),O=c.cloneNode(),j=O.getContext("2d"),V=c.cloneNode(),Y=V.getContext("2d"),z={},H=8;for(let e=0;44>e;e++)z["abcdefghijklmnopqrstuvwxyz0123456789.:!-%,/#"[e]]=e*H;const G=0,J=1,Z=2,q=.1;let N,$,Q,_,X="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWAAAAAIAgMAAAC6381cAAAADFBMVEUAAAARCgP///8AAADe3w1AAAAAAXRSTlMAQObYZgAAAVRJREFUKM9VUrtuwzAMpAf5C6wC8dd46a4CooFmTgtQ/RkPyZBdHoS2/9g7MQ9UhCT6yDvTNEVVc8yaFCvmHLU7uhAOSVPf6osYM0IKYMAy/f6cBIvnFOHEaZLSulW/zfptZSlmNtdS++4RX8yYicKswt/8mcLjJnIyOPb+IaC41OW/cD/b0+6ivlnI2mwH69xjTWRYxi3mtzYsA/KFSQhT5GJa2ss5Aqbws0onc887MmoBZ20F/hFZ2o6/xVjvuM11rLjr4cRWPCq2RmFjY9SudzFgbe3f83mdK+wMwf24r0DIGap9FdRJQ5TyG4Sd6hWzry5PxLz3O3Yb2Unc9JxBW3fmAflegdNiLq/Dxu+VWxJJTqGP03+epZlYRRUUhv98BVDWz9gPG0ATscO4mODn5fgYt+TjFpPivI2bBAAcuqChx328GAeagd/MWyGSpyBZpukP538JBjog7jUAAAAASUVORK5CYII=",ee=0,ne=!0;function te([e,i,o]){switch(e){case"player":return ie(e,{collision:new D(!0,a!==r.length,7,S),input:new R,position:new F(i,o),velocity:new L(40),sprite:new K(!0,me,Me,()=>Pe("rgb(75,190,250)"))});case"sub":return ie(e,{collision:new D(!0,!0,7,M),input:new R,position:new F(i,o,n(0,360)),velocity:new L(20),strategy:new E("patrol",.5,1.5),sprite:new K(!1,ke,xe,()=>Pe("rgb(230,90,100)"))});case"sub_disabled":return ie(e,{collision:new D(!0,!0,7,M),input:new R,position:new F(i,o,n(0,360)),velocity:new L(20),strategy:new E("random",.25),sprite:new K(!1,ke,xe,()=>Pe("rgb(230,90,100)"))});case"mine":return ie(e,{collision:new D(!0,!0,9,M),position:new F(i,o),velocity:new L(25,0,0,t([1,-1])),strategy:new E("guard",0,5),sprite:new K(!1,Ae,Ie,()=>Pe("rgb(230,90,100)"))});case"rock":return ie(e,{collision:new D(!0,!1,75),position:new F(i,o,n(0,360)),velocity:new L(0),sprite:new K(!0,Te)})}}function ie(e,n){return{...n,echo:{...n.position},online:!0,type:e}}function oe({x:e,y:n},{x:t,y:i}){return Math.pow(e-t,2)+Math.pow(n-i,2)}function re(e,n,t){return Math.pow(t,2)>oe(e,n)}function ae({position:e},n){const t=new E("cruise"),i=new D(!0,!0,5,n),o=new K(!1,be,Se,()=>Pe("rgb(220,240,150)")),r=new W(30),a=ce(e,-1),s=de(e,-1),h=ie("torpedo",{collision:i,position:new F(e.x+20*a,e.y+20*s,e.r),sprite:o,strategy:t,ttl:r,velocity:new L(60,a,s)});return T.push(h),h}function se(e){if(e.collision.killable){e.dead=!0,e!==w&&"torpedo"!==e.type&&v++;const{position:{x:t,y:i},velocity:{dx:o,dy:r,speed:a}}=e,s=new D(!1,!1),h=new K(!0,e.sprite.debrisRenderer);[1,2,3].forEach(e=>{const f=new F(t,i),l=new L(a,o/2+n(-2,2)/10,r/2+n(-2,2)/10,n(1,e+1)*(e%2?1:-1)),c=new W(n(20,50)/10);T.push(ie("debris",{collision:s,position:f,sprite:h,ttl:c,velocity:l}))})}}function he({position:e,velocity:n},{echo:t}){return(({x:e,y:n},{x:t,y:i})=>((Math.atan2(i,t)-Math.atan2(n,e))*x+180)%360-180)({x:n.dx,y:n.dy},{x:t.x-e.x,y:t.y-e.y})}function fe(e,n,t,i){const{position:o}=e,{echo:r}=n;return re(o,r,t)&&Math.abs(he(e,n))<i/2}function le({position:e,collision:{group:n}}){return p.filter((e=>({collision:n})=>!!n.group&&n.group!==e)(n)).sort(({position:n},{position:t})=>{const i=oe(n,e),o=oe(t,e);return o>i?-1:i>o?1:0})}function ce({r:e},n){return Math.sin(-e/x)*n}function de({r:e},n){return Math.cos(-e/x)*n}function ge(e,n){console.log(`loading ${n}...`);const t=new o;t.init(e);let i=0;for(;1>i;)i=t.generate(),console.log(`loaded ${100*i}%`);let r=t.createWave();return[document.createElement("audio"),URL.createObjectURL(new Blob([r],{type:"audio/wav"}))]}function we(){j.save(),j.shadowBlur=10,j.strokeStyle="rgb(70,105,105)",j.shadowColor=j.strokeStyle,j.fillStyle="rgba(30,60,60,0.5)",j.translate(O.width/2-100,O.height/2),j.save(),j.scale(.8,.8),j.rotate(35/x),j.beginPath(),j.moveTo(0,10),j.arc(0,10,20,1.5*Math.PI,.5*Math.PI),j.arc(0,-10,20,.5*Math.PI,1.5*Math.PI),j.closePath(),j.fill(),j.stroke(),j.moveTo(0,0),j.restore(),j.translate(38,0),j.beginPath(),j.arc(0,5,15,2*Math.PI,Math.PI),j.moveTo(15,5),j.lineTo(15,-20),j.lineTo(-15,-20),j.lineTo(-15,5),j.fill(),j.stroke(),j.closePath(),j.moveTo(0,0),j.translate(40,0),j.beginPath(),j.arc(0,-10,10,1.5*Math.PI,.5*Math.PI),j.moveTo(0,-20),j.lineTo(-15,-20),j.lineTo(-15,20),j.lineTo(0,20),j.moveTo(0,0),j.arc(0,10,10,1.5*Math.PI,.5*Math.PI),j.fill(),j.stroke(),j.closePath(),j.moveTo(0,0),j.translate(40,0),j.beginPath(),j.moveTo(0,0),j.lineTo(7.5,20),j.lineTo(22.5,-20),j.lineTo(-22.5,-20),j.lineTo(-7.5,20),j.lineTo(7.5,-20),j.fill(),j.stroke(),j.closePath(),j.translate(35,0),j.moveTo(0,0),j.beginPath(),j.lineTo(0,-20),j.lineTo(-15,20),j.lineTo(15,20),j.lineTo(0,-20),j.fill(),j.stroke(),j.closePath(),j.translate(40,0),j.beginPath(),j.arc(0,-10,10,1.5*Math.PI,.5*Math.PI),j.moveTo(0,-20),j.lineTo(-15,-20),j.lineTo(-15,20),j.lineTo(10,20),j.lineTo(0,0),j.fill(),j.stroke(),j.closePath(),j.moveTo(0,0),j.translate(-100,70),j.font="54px Arial",j.textAlign="center",j.textBase="bottom",j.fillText("2063",0,0),j.strokeText("2063",0,0),j.restore()}function pe(){j.fillStyle=j.createPattern(V,"repeat"),j.fillRect(0,0,O.width,O.height)}function ue(e,n,t){return t?e:n}function ye({position:e,echo:n,sprite:t}){const i=ue(e,n,t.alwaysRender);j.save(),j.translate(Math.round(i.x),Math.round(i.y)),j.rotate(i.r/x),t.renderer(),j.restore()}function me(){j.shadowBlur=10,j.fillStyle="rgb(75,190,250)",j.shadowColor=j.fillStyle,j.beginPath(),j.arc(0,2,5,0,2*Math.PI),j.fillRect(-2,-10,4,12),j.fill(),j.closePath()}function be(){j.shadowBlur=10,j.strokeStyle=w.online?"rgb(220,240,150)":"rgb(80,100,80)",j.lineWidth=3,j.shadowColor=j.strokeStyle,j.beginPath(),j.moveTo(0,-6),j.lineTo(0,2),j.stroke(),j.moveTo(0,4),j.lineTo(0,6),j.stroke(),j.closePath()}function ke(){j.beginPath(),j.shadowBlur=10,j.fillStyle=w.online?"rgb(230,90,100)":"rgb(55,40,35)",j.shadowColor=j.fillStyle,j.fillRect(-5,-3,10,10),j.fillRect(-2,-10,4,12),j.fill(),j.closePath()}function Ae(){j.lineWidth=2,j.shadowBlur=10,j.shadowColor=j.fillStyle=j.strokeStyle=w.online?"rgb(230,90,100)":"rgb(55,40,35)",j.beginPath(),j.arc(0,0,4,0,2*Math.PI),j.fill(),j.setLineDash([2,4]),j.arc(0,0,6,0,2*Math.PI),j.stroke(),j.closePath()}function Pe(e){j.beginPath(),j.shadowBlur=10,j.fillStyle=e,j.shadowColor=j.fillStyle,j.moveTo(-5,-10),j.lineTo(5,0),j.lineTo(-4,-2),j.fill(),j.closePath()}function Te(){j.shadowBlur=10,j.strokeStyle="rgb(70,105,105)",j.shadowColor=j.strokeStyle,j.fillStyle="rgba(30,60,60,0.5)",j.beginPath(),j.moveTo(0,-70),[[-25,-73],[-35,-35],[-70,-30],[-70,-25],[-70,-25],[-65,0],[-25,12],[-5,65],[12,73],[25,50],[55,45],[75,0],[60,-45],[35,-40],[38,-71],[0,-69]].forEach(([e,n])=>{j.lineTo(e,n)}),j.closePath(),j.fill(),j.stroke(),j.beginPath(),j.moveTo(-50,20),[[-70,25],[-50,50],[-25,50],[-25,25]].forEach(([e,n])=>{j.lineTo(e,n)}),j.closePath(),j.fill(),j.stroke()}function ve(e){const{position:n,echo:t,sprite:i}=e;if(i.radarRenderer){const o=ue(n,t,i.alwaysRender);j.save(),j.translate(Math.round(o.x),Math.round(o.y)),i.radarRenderer(e),j.restore()}}function Se({position:e,echo:n,sprite:t}){const i=ue(e,n,t.alwaysRender);j.rotate(i.r/x),j.shadowBlur=10,j.strokeStyle=w.online?"rgb(220,240,150)":"rgb(80,100,80)",j.shadowColor=j.strokeStyle,j.fillStyle=w.online?"rgba(80,100,80,0.15)":"rgba(80,100,80,0.25)",j.beginPath(),j.moveTo(-4,0),j.arc(0,0,200,5*-Math.PI/8,3*-Math.PI/8),j.lineTo(4,0),j.fill(),j.stroke(),j.closePath()}function Me(e){const{dashOffset:n=0,dashTime:t=0}=e;j.shadowBlur=10,j.strokeStyle="rgb(70,105,105)",j.shadowColor=j.strokeStyle,j.beginPath(),j.arc(0,0,100,0,2*Math.PI),j.stroke(),j.closePath(),j.beginPath(),j.lineDashOffset=n,j.setLineDash([4,8]),j.arc(0,0,40,0,2*Math.PI),j.stroke(),j.closePath(),e.dashTime=t+$,e.dashTime>q&&(e.dashTime-=q,e.dashOffset=(n-1)%12)}function xe({position:e,echo:n,sprite:t}){j.shadowBlur=10,j.shadowColor=j.strokeStyle="rgb(55,40,35)",j.beginPath(),j.arc(0,0,100,0,2*Math.PI),j.stroke(),j.closePath();const i=ue(e,n,t.alwaysRender);j.save(),j.shadowColor=j.strokeStyle=w.online?"rgb(105,45,55)":"rgb(55,40,35)",j.rotate(i.r/x),j.beginPath(),j.moveTo(-4,0),j.arc(0,0,200,5*-Math.PI/8,3*-Math.PI/8),j.lineTo(4,0),j.stroke(),j.closePath(),j.restore()}function Ie(){j.shadowBlur=10,j.shadowColor=j.strokeStyle=w.online?"rgb(105,45,55)":"rgb(55,40,35)",j.beginPath(),j.arc(0,0,250,0,2*Math.PI),j.stroke(),j.closePath()}function Ce(e,n,t,i=G,o=1){const r=o*H,a=e.length*r,s=i===Z?a:i===J?a/2:0;[...e].forEach((e,i)=>{e in z&&j.drawImage(X,z[e],0,H,H,n+i*r-s,t,r,r)})}function Be(){ne&&(_=requestAnimationFrame(Be),(()=>{switch(j.fillStyle="rgb(20,35,40)",j.fillRect(0,0,O.width,O.height),b){case s:Ce(B?"ready to dive!":"loading...",O.width/2,O.height/2,J),B&&ee>.4&&Ce("press any key",O.width/2,O.height-3*H,J);break;case h:pe(),Ce("js13kgames 2018",O.width/2,2*H,J),we(),Ce("move: arrows/wasd",2*H,O.height/2-2*H,G),Ce("torpedo: space",2*H,O.height/2,G),Ce("sonar: f/o",2*H,O.height/2+2*H,G),Ce("game: jerome lecomte",O.width-2*H,O.height/2-H,Z),Ce("music: mark sparling",O.width-2*H,O.height/2+H,Z),ee>.4&&Ce("press any key to start",O.width/2,O.height-3*H,J);break;case f:Ce(`mission #0${P+1}`,O.width/2,O.height/2-2*H,J),g[P].mission.forEach((e,n)=>{Ce(e,O.width/2,O.height/2+2*n*H,J)}),ee>.4&&Ce("press any key to start mission",O.width/2,O.height-3*H,J);break;case l:pe(),p.forEach(ve),p.forEach(ye),Ce(`sonar: ${w.online?"on":"off"}line`,O.width/2,2*H,J);break;case d:P<g.length?A?(Ce(`mission #0${P} complete`,O.width/2,O.height/2,J),ee>.4&&Ce("press any key to start next mission",O.width/2,O.height-3*H,J)):(Ce("you died!",O.width/2,O.height/2,J),ee>.4&&Ce("press any key to try again",O.width/2,O.height-3*H,J)):(we(),Ce("you finished submersible warship 2063",O.width/2,.25*O.height+2*H,J),Ce("thank you for playing!",O.width/2,.25*O.height+4*H,J),Ce("press t to tweet your score",O.width/2,.75*O.height,J))}U.drawImage(O,0,0,O.width,O.height,0,0,c.width,c.height)})(),N=Date.now(),(ee+=$=(N-Q)/1e3)>1&&(ee-=1),(()=>{switch(b){case l:p.forEach(i=>{(e=>{const{strategy:t,position:i,collision:{group:o}}=e;if(t)switch(t.type){case"patrol":t.target&&!re(i,t.target.echo,15)&&t.target.online||(e.strategy.patrolLocked=!1,t.target={echo:new F(n(.2*O.width,.8*O.width),n(.2*O.height,.8*O.height)),online:!0}),le(e).forEach(n=>{n.online&&!e.strategy.patrolLocked&&re(i,n.echo,100)&&(e.strategy.target=n,e.strategy.patrolLocked=!0)});break;case"lockon":const{online:o,dead:r}=t.target;!r&&o||(e.strategy={...t,type:"cruise",target:void 0,nextSteering:.5,remainingBeforeSteering:0},e.input=null,e.velocity.dr=0);break;case"cruise":le(e).forEach(n=>{fe(e,n,200,45)&&(e.strategy={...t,type:"lockon",target:n,nextSteering:.1,remainingBeforeSteering:0},t.target=n,e.input=new R)})}})(i),(e=>{const{input:n,strategy:i,position:o,collision:{group:r}}=e;if(i){if(i.remainingBeforeSteering-=$,0>i.remainingBeforeSteering)switch(i.remainingBeforeSteering+=i.nextSteering,i.type){case"patrol":case"lockon":const o=he(e,i.target);n.left=-5>o?-1:0,n.right=o>5?1:0,n.up=-1,n.down=0;break;case"random":n.up=t([-1,0]),n.left=t([-1,0]),n.right=t([1,0]),n.down=t([1,0])}if(i.remainingBeforeAttack-=$,0>i.remainingBeforeAttack&&(i.remainingBeforeAttack+=i.nextAttack,i.readyToFire=!0),i.readyToFire)switch(i.type){case"patrol":le(e).forEach(n=>{const{online:t}=n;t&&i.readyToFire&&fe(e,n,200,45)&&(ae(e,e.collision.group),i.target=n,i.readyToFire=!1,i.remainingBeforeAttack=i.nextAttack)});break;case"guard":le(e).forEach(n=>{const{echo:t}=n;if(n.online&&i.readyToFire&&re(o,t,250)){const t=o.r;o.r=he(e,n)+90,ae(e,r),o.r=t,i.readyToFire=!1,i.remainingBeforeAttack=i.nextAttack}})}}})(i),(({input:e,position:n,velocity:t})=>{e&&(t.dr=e.left+e.right,t.dx=ce(n,e.up+e.down),t.dy=de(n,e.up+e.down))})(i),(({velocity:e,position:n})=>{const t=e.speed*$;n.x+=t*e.dx,n.y+=t*e.dy,n.r=(n.r+t*e.dr)%360})(i),(({position:e,echo:n,sprite:t,online:i})=>{w.online&&i&&(n.x=e.x,n.y=e.y,n.r=e.r)})(i),(e=>{let{ttl:n}=e;n&&(n.timeLeft-=$,1>n.timeLeft&&(e.dead=!0))})(i),(n=>{const{position:t,collision:i}=n;t.x=e(t.x,0,O.width-i.radius),t.y=e(t.y,0,O.height-i.radius)})(i)});let i=new Set;p.forEach((e,n)=>{p.slice(n+1).forEach(n=>{((e,n)=>{const{position:t,collision:i}=e,{position:o,collision:r}=n;return i.collide&&r.collide&&re(t,o,i.radius+r.radius)})(e,n)&&(i.add(e),i.add(n))})}),i.forEach(se),p=p.filter(({dead:e})=>!e),T.length>0&&(T.forEach(e=>p.push(e)),T=[]),k||A?m+=$:(k=u.length===u.filter(({dead:e})=>e).length,A=y.length===y.filter(({dead:e})=>e).length),m>4&&(A&&(P+=1),b=d)}})(),Q=N)}function Re(e){(ne=e)?(Q=Date.now(),Be()):cancelAnimationFrame(_)}onload=(async e=>{document.title="SUBmersible WARship 2063",onresize(),X=await(e=>new Promise(n=>{let t=new Image;t.onload=(()=>n(t)),t.src=e}))(X),Re(!0),setTimeout(()=>{(async()=>{V.width=V.height=64,Y.strokeStyle="rgb(40,55,50)",Y.beginPath(),Y.moveTo(0,4),Y.lineTo(8,4),Y.stroke(),Y.closePath(),Y.beginPath(),Y.moveTo(4,0),Y.lineTo(4,8),Y.stroke(),Y.closePath()})(),g=[{mission:["enemy mine drifted into perimeter. destroy it.","turn off sonar to evade torpedos."],looseCondition:[["player",2*O.width/3,2*O.height/3]],otherEntities:[["rock",O.width/2,O.height/2]],winCondition:[["mine",O.width/3,O.height/3]]},{mission:["enemy subs entered perimeter. sink them all."],looseCondition:[["player",.9*O.width,.9*O.height]],otherEntities:[["rock",.35*O.width,0],["rock",.65*O.width,.75*O.height],["rock",0,.65*O.height],["rock",O.width,3*O.height/8]],winCondition:[["sub",.1*O.width,.1*O.height],["sub",.1*O.width,.9*O.height],["sub",.9*O.width,.1*O.height],["sub",.4*O.width,.4*O.height]]},{mission:["enemy sub broke down in perimeter. eliminate it.","enemy mines detected, proceed with caution"],looseCondition:[["player",.1*O.width,.9*O.height]],otherEntities:[["mine",.25*O.width,.25*O.height],["mine",.5*O.width,.25*O.height],["mine",.55*O.width,.6*O.height],["mine",.8*O.width,.8*O.height],["mine",.9*O.width,.1*O.height],["rock",.35*O.width,O.height],["rock",.6*O.width,0]],winCondition:[["sub_disabled",.8*O.width,.35*O.height]]}],(async()=>{let[e,n]=ge(i.konamiCode,"secret song");(I=e).src=n,[e,n]=ge(i.markSparlingSong,"Mark Sparling's song"),(C=e).src=n,C.loop=!0,B=!0})()},100)}),onresize=(()=>{c.width=O.width=innerWidth>1.6*innerHeight?1.6*innerHeight:innerWidth,c.height=O.height=innerWidth>1.6*innerHeight?innerHeight:innerWidth/1.6,U.imageSmoothingEnabled=j.imageSmoothingEnabled=!1}),document.onvisibilitychange=(e=>{Re(!e.target.hidden)}),onkeydown=(e=>{if(e.preventDefault(),!e.repeat)switch(b){case l:switch(e.code){case"ArrowLeft":case"KeyA":w.input.left=-1;break;case"ArrowUp":case"KeyW":w.input.up=-1;break;case"ArrowRight":case"KeyD":w.input.right=1;break;case"ArrowDown":case"KeyS":w.input.down=1;break;case"Space":w.dead||ae(w,w.collision.group);break;case"KeyP":Re(!ne)}}}),onkeyup=(e=>{switch(b){case s:C.play(),b=h;break;case h:e.which!==r[a]||a===r.length?b=f:++a===r.length&&I.play();break;case f:(()=>{m=0;const e=g[P];u=[...e.looseCondition.map(te)],w=u[0],y=e.winCondition.map(te),p=[...e.otherEntities.map(te),...u,...y],b=l})();break;case l:switch(e.code){case"ArrowLeft":case"KeyA":w.input.left=0;break;case"ArrowRight":case"KeyD":w.input.right=0;break;case"ArrowUp":case"KeyW":w.input.up=0;break;case"ArrowDown":case"KeyS":w.input.down=0;break;case"KeyO":case"KeyF":w.online=!w.online,w.switchModeTime=N}break;case d:switch(e.code){case"KeyT":open(`https://twitter.com/intent/tweet?text=I%20sunk%20${v||0}%20enemy%20submarines%20in%20SUBmersible%20WARship%202063%20by%20@herebefrogs%20for%20@js13kgames%202018%3A%20https%3A%2F%2Fgoo.gl%2FHLo6Df`,"_blank");break;default:A=k=!1,P<g.length?b=f:(a=0,b=h)}}})}();</script>