function SpawnCollectables(a,b){for(var c=0;b>c;c++){var d=CalcSP(maze,existingSessions,collectables);collectables.push({type:a,x:d.x,y:d.y})}}function InformOtherPlayersOfNewPosition(a,b,c,d){var e={sid:a.sid,x:a.x,y:a.y};e.name=a.name,e["char"]=a["char"],e.score=a.score,e.holding=a.holding,BroadcastToAllOthers(b,d?null:a,c||"pu",e)}function UpdateCurrentlyOnlineList(a){var b=[];for(var c in a)if(!a[c].dead){var d={sid:c,name:a[c].name,score:a[c].score};b.push(d),SubmitHighScore(d)}var e=[];for(var f in allHighestScores)e.push({name:f,score:allHighestScores[f]});var g=function(a,b){return b.score-a.score};b=b.sort(g),e=e.sort(g),e.length>10&&(e.length=10),BroadcastToAllOthers(a,null,"cp",{players:b,highscores:e})}function BroadcastToAllOthers(a,b,c,d){for(var e in a)b&&e==b.sid||a[e].socket.emit(c,d)}function SubmitHighScore(a){a.score>0&&(!allHighestScores[a.name]||allHighestScores[a.name]<a.score)&&(allHighestScores[a.name]=a.score,db("highscores",allHighestScores))}function CalcSP(a,b,c){var d=Math.floor(Math.random()*a.size),e=Math.floor(Math.random()*a.size);if(a.GetTileAtPosition(d,e).wall)return CalcSP(a,b,c);for(var f in b)if(Math.abs(b[f].x-d)<3&&b[f].y==e)return CalcSP(a,b,c);for(var g=0;g<c.length;g++)if(Math.abs(c[g].x-d)<3&&c[g].y==e)return CalcSP(a,b,c);return{x:d,y:e}}var io=require("sandbox-io"),shared=require("./shared.min.js"),clientSessionCounter=0,maze=new shared.Maze(new shared.RandomNumberGenerator,16),existingSessions={},collectables=[],FLIPPED=!0;SpawnCollectables("bomb",5),SpawnCollectables("point",13),SpawnCollectables("reverse",3),io.on("connection",function(a){function b(a,b){e.score+=3,existingSessions[a].dead=!0,UpdateCurrentlyOnlineList(existingSessions),BroadcastToAllOthers(existingSessions,null,"k",{perp:d,vic:a,perpScore:e.score,method:b})}var c=CalcSP(maze,existingSessions,collectables),d=clientSessionCounter++,e={sid:d,x:c.x,y:c.y,score:0,socket:a},f={sid:e.sid,nme:[],x:e.x,y:e.y,flipped:FLIPPED,collectables:collectables};for(var g in existingSessions)g!=d&&f.nme.push({sid:existingSessions[g].sid,x:existingSessions[g].x,y:existingSessions[g].y,name:existingSessions[g].name,"char":existingSessions[g]["char"]});a.emit("w",f),a.on("i",function(a){e.name=a.name,e["char"]=a["char"],existingSessions[d]=e,InformOtherPlayersOfNewPosition(e,existingSessions),UpdateCurrentlyOnlineList(existingSessions)}),a.on("disconnect",function(){InformOtherPlayersOfNewPosition(e,existingSessions,"rm"),delete existingSessions[d]}),a.on("p",function(a){var c=!1;null!=e.holding&&("reverse"==e.holding&&(FLIPPED=!FLIPPED,BroadcastToAllOthers(existingSessions,null,"f",{flipped:FLIPPED,name:e.name})),"bomb"==e.holding&&(BroadcastToAllOthers(existingSessions,null,"bomb",{placed:{x:a.x,y:a.y}}),setTimeout(function(){function c(a,b){return maze.GetTileAtPosition(a,b).wall}for(var d=null,e=null,f=null,g=null,h=5,i=1;h>=i;i++)null!=e||!c(a.x+i,a.y)&&i!=h||(e=a.x+i-1),null!=d||!c(a.x-i,a.y)&&i!=h||(d=a.x-i+1),null!=g||!c(a.x,a.y+i)&&i!=h||(g=a.y+i-1),null!=f||!c(a.x,a.y-i)&&i!=h||(f=a.y-i+1);BroadcastToAllOthers(existingSessions,null,"bomb",{expl:{x:a.x,y:a.y,r:e,l:d,t:f,b:g}});for(var j=d;e>=j;j++)for(var k in existingSessions)existingSessions[k].x==j&&existingSessions[k].y==a.y&&b(k,"b");for(var l=f;g>=l;l++)for(var k in existingSessions)existingSessions[k].x==a.x&&existingSessions[k].y==l&&b(k,"b")},1200)),e.holding=null,c=!0);for(var d=0;d<collectables.length;d++)if(collectables[d].x==a.x&&collectables[d].y==a.y){var f=CalcSP(maze,existingSessions,collectables);collectables[d].x=f.x,collectables[d].y=f.y,BroadcastToAllOthers(existingSessions,null,"c",{collect:a,add:collectables[d]}),c=!0,"point"==collectables[d].type?(e.score++,UpdateCurrentlyOnlineList(existingSessions)):"reverse"==collectables[d].type?e.holding="reverse":"bomb"==collectables[d].type?e.holding="bomb":c=!1}c&&InformOtherPlayersOfNewPosition(e,existingSessions,null,!0)}),a.on("t",function(a){BroadcastToAllOthers(existingSessions,e,"t",{name:e.name,msg:a.msg})}),a.on("m",function(a){var c=shared.keyCodes[a.key];if(c){var f=e.x+c.x,g=e.y+c.y;0==maze.GetTileAtPosition(f,g).wall&&(e.x=f,e.y=g,InformOtherPlayersOfNewPosition(e,existingSessions));for(var h in existingSessions)h!=d&&(existingSessions[h].x!=f||existingSessions[h].y!=g||existingSessions[h].dead||a.key==(FLIPPED?37:39)&&b(h,"s"))}})});var allHighestScores=db("highscores")||{};