function Game(a,b,c){function d(a){a.sid==m.sid?(h.score=a.score,h.holding=a.holding):i[a.sid]?(i[a.sid].x=a.x,i[a.sid].y=a.y,i[a.sid].name=a.name,i[a.sid]["char"]=a["char"],i[a.sid].score=a.score,i[a.sid].holding=a.holding):i[a.sid]=new Knight(a.x,a.y,a.name,a["char"],0,c)}function e(a,b){for(var c in i)if(!i[c].dead&&PosEq(i[c],a)&&b!=(FLIPPED?37:39))return b==(FLIPPED?39:37)?!0:!0;return!1}function f(a){for(var b=0;b<j.length;b++){var c=32*j[b].x+8,d=32*j[b].y+8,e=null;"bomb"==j[b].type?e=sprites.bomb:"point"==j[b].type?e=sprites.point:"reverse"==j[b].type&&(e=sprites.greenDiamond),e.draw(c,d,a)}}var g=new TextAnnouncer(a,b),h=new Knight(0,0,playerName,playerCharacter,0,c),i={},j=[],k=[],l=exports.keyCodes,m=io(document.location.href);m.on("w",function(a){m.sid=a.sid,h.x=a.x,h.y=a.y,FLIPPED=a.flipped,j=a.collectables;for(var b=0;b<a.nme.length;b++)d(a.nme[b]);m.emit("i",{name:playerName,"char":playerCharacter})}),m.on("bomb",function(a){if(a.placed&&k.push(new Bomb(a.placed.x,a.placed.y)),a.expl){for(var b=0;b<k.length;b++)if(PosEq(k[b],a.expl)){k.splice(b,1);break}for(var d=a.expl.l;d<=a.expl.r;d++)k.push(new Explosion(d,a.expl.y,50*Math.abs(d-a.expl.x),c));for(var e=a.expl.t;e<=a.expl.b;e++)k.push(new Explosion(a.expl.x,e,50*Math.abs(e-a.expl.y),c))}}),m.on("c",function(a){if(a.collect)for(var b=0;b<j.length;b++)if(PosEq(j[b],a.collect)){j.splice(b,1);break}a.add&&j.push(a.add)}),m.on("f",function(a){FLIPPED!=a.flipped&&(g.displayMessage(a.flipped?"<< REVERSED! <<":">> REVERSED! >>","middle"),g.displayMessage(a.name+" has reversed the game!","top")),FLIPPED=a.flipped}),m.on("cp",function(a){for(var b=a.players,c=b[0].score,d=0;d<b.length;d++){var e=b[d].score==c;b[d].sid==m.sid?h.gold=e:i[b[d].sid]&&(i[b[d].sid].gold=e),b[d]=b[d].name+" - "+b[d].score}for(var f=[],d=0;d<a.highscores.length;d++)f.push(a.highscores[d].name+" - "+a.highscores[d].score);b.unshift("Current Leaders"),f.unshift("High Scores"),document.getElementById("tr").innerHTML=b.join("<br />"),document.getElementById("tl").innerHTML=f.join("<br />")}),sprites={floor:new Sprite(c,0,0,16,16),wall:new Sprite(c,32,0,32,32),greenDiamond:new Sprite(c,0,16,16,16),bomb:new Sprite(c,96,0,16,16),point:new Sprite(c,96,16,16,16)},sprites.floor.scale=2;for(var n=new CameraController(a,b),o=new exports.Maze(new exports.RandomNumberGenerator,16),p=new SpriteBatch,q=0;q<o.size;q++)for(var r=0;r<o.size;r++){var s=o.GetTileAtPosition(r,q),t=s.wall?sprites.wall:sprites.floor;p.add(t,32*r,32*q)}var u=document.onkeydown=function(a){if(84==a.keyCode&&m.emit("t",{msg:window.prompt("Send message to all players:")}),a.keyCode==(FLIPPED?37:39)&&h.swingSword(),32==a.keyCode)return void m.emit("p",{x:h.x,y:h.y});var b={x:h.x,y:h.y},c=l[a.keyCode];c&&(b.x+=c.x,b.y+=c.y,0==e(b,a.keyCode)&&0==o.GetTileAtPosition(b.x,b.y).wall&&(m.emit("m",{sid:m.sid,key:a.keyCode}),h.x=b.x,h.y=b.y))};SetupTouchControls(u),m.on("pu",function(a){d(a)}),m.on("rm",function(a){delete i[a.sid]}),m.on("t",function(a){g.displayMessage(a.name+": "+a.msg,"bottom")}),m.on("k",function(a){var b="s"==a.method?" got ":" blew up ",d=null;a.vic==m.sid?(h.dead=!0,d=h,l=[],a.perp==m.sid?g.displayMessage("You"+b+"yourself!","top"):g.displayMessage(i[a.perp].name+b+"you","top"),g.displayMessage("You Are Dead","middle"),setTimeout(function(){window.location=window.location},3e3)):a.perp==m.sid?(h.score=a.perpScore,i[a.vic].dead=!0,d=i[a.vic],g.displayMessage("You"+b+i[a.vic].name,"top")):(i[a.perp].score=a.perpScore,i[a.vic].dead=!0,d=i[a.vic],g.displayMessage(i[a.perp].name+b+i[a.vic].name,"top")),k.push(new BloodSplatter(d.x,d.y,"b"==a.method?0:FLIPPED?-300:300,c))}),this.update=function(a,b){n.setTarget(32*h.x,32*h.y),n.update(a),h.update(a),g.update(a);for(var c in i)i[c].update(a);for(var c=0;c<k.length;c++)k[c].update(a),k[c].expired&&k.splice(c--,1)},this.draw=function(){b.clearRect(0,0,a.width,a.height),p.drawAll(n),f(n),b.font="10px monospace",b.fillStyle="white",b.textAlign="center",h.dead&&h.draw(n);for(var c in i)i[c].dead&&i[c].draw(n);for(var c in i)i[c].dead||i[c].draw(n);h.dead||h.draw(n);for(var c=0;c<k.length;c++)k[c].draw(n);g.draw()}}function PosEq(a,b){return a.x==b.x&&a.y==b.y}function BloodSplatter(a,b,c,d){function e(a,b,c,e){var f=null;0==a&&(f=new Sprite(d,64,0,8,8)),1==a&&(f=new Sprite(d,72,0,8,8)),2==a&&(f=new Sprite(d,64,8,8,8)),3==a&&(f=new Sprite(d,72,8,8,8)),this.update=function(a){var d=a/1e3;c.y+=h*d,b.x+=c.x*d,b.y+=c.y*d,f.scale=l+e*(o/n),f.alpha=Math.min(1.4-o/n,1)},this.draw=function(a){f.draw(b.x,b.y,a)}}this.x=a,this.y=b;for(var f=32*a+16,g=32*b+16,h=981,i=20,j={x:-500,y:-200},k={x:500,y:50},l=.5,m=1.8,n=500,o=0,p=[],q=0;i>q;q++){var r={x:j.x+Math.random()*(k.x-j.x)+c,y:j.y+Math.random()*(k.y-j.y)};p.push(new e(q%4,{x:f,y:g},r,Math.random()*m))}this.update=function(a){o+=a,o>n&&(this.expired=!0);for(var b=0;b<p.length;b++)p[b].update(a)},this.draw=function(a){for(var b=0;b<p.length;b++)p[b].draw(a)}}function Bomb(a,b){this.x=a,this.y=b,this.drawX=32*a+8,this.drawY=32*b+8,this.update=function(a){},this.draw=function(a){var b=Math.floor(4*Math.random())-2,c=Math.floor(4*Math.random())-2;sprites.bomb.draw(this.drawX+b,this.drawY+c,a)}}function Explosion(a,b,c,d){var e=new Sprite(d,112,0,16,16);e.scale=2;var f=0,g=300;this.drawX=32*a,this.drawY=32*b,this.update=function(a){f+=a,f>g+c&&(this.expired=!0)},this.draw=function(a){if(f>c){var b=Math.floor(6*Math.random())-2,d=Math.floor(6*Math.random())-2;e.draw(this.drawX+b,this.drawY+d,a)}}}function Knight(a,b,c,d,e,f){var g=null,h=null,i=new Sprite(f,64,16,16,16);i.scale=2,this.x=a,this.y=b,this.name=c,this["char"]=d,this.score=e,this.gold=!1;var j=20,k=32*this.x,l=32*this.y;this.update=function(a){var b=32*this.x-k,c=32*this.y-l;k+=b*j*(a/1e3),l+=c*j*(a/1e3),n&&(n+=a,n>m&&(n=0))};var m=200,n=1;this.swingSword=function(){n=1},this.draw=function(a){var b=null;"reverse"==this.holding&&(b=sprites.greenDiamond),"bomb"==this.holding&&(b=sprites.bomb),g?(this.dead?i.draw(k,l,a):(n?h.rotation=.3+n/m*1.3:h.rotation=1.5,this.gold&&(g.sx+=32),FLIPPED&&(g.sy+=32,h.rotation=-h.rotation),g.draw(k,l,a),h.draw(k+16-(FLIPPED?21:0),l,a),b&&b.draw(k-4+(FLIPPED?24:0),l+16,a),this.gold&&(g.sx-=32),FLIPPED&&(g.sy-=32)),a.fillText(this.name+" - "+this.score,k+16,l)):"m"==this["char"]?(g=new Sprite(f,0,32,32,32),h=new Sprite(f,16,0,16,32),h.rhs=[9,21]):"f"==this["char"]&&(g=new Sprite(f,64,32,32,32),h=new Sprite(f,80,0,16,32),h.rhs=[9,21])}}function CameraController(a,b){this.context=b;var c=4.5;this.drawableX=0,this.drawableY=0;var d=1e3,e=1e3,f=0,g=0;this.setTarget=function(a,b){f=a,g=b},this.update=function(b){this.globalScale=a.width>500?3:1.5;var h=f-d,i=g-e;d+=h*c*(b/1e3),e+=i*c*(b/1e3),this.drawableX=d-a.width/2/this.globalScale,this.drawableY=e-a.height/2/this.globalScale},this.drawImage=function(a,c,d,e,f,g,h,i,j,k,l,m,n){if(i*=m,j*=m,b.save(),b.globalAlpha=n,0==k)b.scale(this.globalScale,this.globalScale),b.translate(-this.drawableX,-this.drawableY),b.drawImage(a,c,d,e,f,g,h+.1,i,j);else{var o=l[0]*m,p=l[1]*m;b.translate(g*this.globalScale,h*this.globalScale),b.translate(o*this.globalScale,p*this.globalScale),b.scale(this.globalScale,this.globalScale),b.translate(-this.drawableX,-this.drawableY),b.rotate(k),b.drawImage(a,c,d,e,f,-o,-p,i,j)}b.restore()},this.fillText=function(a,c,d){b.save(),b.scale(this.globalScale,this.globalScale),b.translate(-this.drawableX,-this.drawableY),b.fillText(a,c,d),b.restore()}}function Sprite(a,b,c,d,e){this.img=a,this.sx=b,this.sy=c,this.sWidth=d,this.sHeight=e,this.scale=1,this.rotation=0,this.rhs=[0,0],this.alpha=1,this.draw=function(a,b,c){c.drawImage(this.img,this.sx,this.sy,this.sWidth,this.sHeight,a,b,this.sWidth,this.sHeight,this.rotation,this.rhs,this.scale,this.alpha)}}function SpriteBatch(){var a=[];this.add=function(b,c,d){a.push({sprite:b,x:c,y:d})},this.drawAll=function(b){var c=b.context;c.save(),c.scale(b.globalScale,b.globalScale),c.translate(-b.drawableX,-b.drawableY);for(var d=0;d<a.length;d++){var e=a[d].sprite;c.drawImage(e.img,e.sx,e.sy,e.sWidth,e.sHeight,a[d].x,a[d].y+.1,e.sWidth*e.scale,e.sHeight*e.scale)}c.restore()}}function TextAnnouncer(a,b){var c=[];this.displayMessage=function(b,d){if("top"==d)var e=.25*a.height,f="30px monospace";else if("bottom"==d)var e=.9*a.height,f="20px monospace";else var e=.6*a.height,f="60px monospace";c.push(new TextMessage(b,a.width/2,e,f))},this.update=function(a){for(var b=0;b<c.length;b++)c[b]&&c[b].update(a)&&(c[b]=null);c.length&&!c[c.length-1]&&c.pop()},this.draw=function(){for(var d=0;d<c.length;d++)c[d]&&c[d].draw(a,b)}}function TextMessage(a,b,c,d){var e=2e3,f=0;this.update=function(a){return f+=a,f>e?!0:void 0},this.draw=function(g,h){h.save(),h.globalAlpha=1-f/e,h.font=d,h.textAlign="center",h.fillStyle="white",h.translate(b,c),h.scale(1+f/e,1+f/e),h.fillText(a,0,-50),h.restore()}}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function SetupTouchControls(a){function b(b){var c=30,d=null;Math.abs(b.moveX)>4*c||Math.abs(b.moveY)>4*c?b.fast=!0:b.fast=!1,b.moveX>c&&(d=39),b.moveX<-c&&(d=37),b.moveY<-c&&(d=38),b.moveY>c&&(d=40),d&&(!b.done||b.duration-(b.reducer||0)>(b.fast?50:200))&&(b.done=!0,b.reducer=(b.reducer||0)+100,a({keyCode:d}))}function c(b){b.duration<120&&b.moveX<5&&b.moveY<5&&a({keyCode:32})}function d(a,b){return b.duration=Date.now()-b.startTime,b.moveX=a.screenX-b.startX,b.moveY=a.screenY-b.startY,b.curX=a.screenX,b.curY=a.screenY,b}var e={};document.body.addEventListener("touchstart",function(a){for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];e[c.identifier]={startTime:Date.now(),startX:c.screenX,startY:c.screenY}}a.preventDefault()}),document.body.addEventListener("touchmove",function(a){for(var c=0;c<a.changedTouches.length;c++){var f=a.changedTouches[c];b(d(f,e[f.identifier]))}a.preventDefault()}),document.body.addEventListener("touchend",function(a){for(var b=0;b<a.changedTouches.length;b++){var f=a.changedTouches[b];c(d(f,e[f.identifier])),delete e[f.identifier]}}),document.body.addEventListener("touchcancel",function(a){for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];delete e[c.identifier]}})}var FLIPPED=!1,playerName=getParameterByName("name").replace(/</g,"&lt;"),playerCharacter=getParameterByName("char");playerName&&playerCharacter||(window.location="/intro.html");var readyStateCheckInterval=setInterval(function(){if("complete"===document.readyState){clearInterval(readyStateCheckInterval);var a=new Image;a.src="sprites.png",a.onload=function(){function b(){d.width=window.innerWidth,d.height=window.innerHeight,e.mozImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1,c()}function c(){var a=Date.now();g=g||a,f.update(a-g,a),g=a,f.draw(),requestAnimationFrame(c)}var d=document.getElementsByTagName("canvas")[0],e=d.getContext("2d"),f=new Game(d,e,a);b(),window.addEventListener("resize",b,!1);var g=0}}},10);