isNum=function(a){return"number"===typeof a};isObj=function(a){return"object"===typeof a};GAME_WIDTH=800;GAME_HEIGHT=480;isDef=function(a){return"undefined"!==typeof a};sgn=function(a){return 0<a?1:-1};ms=function(){return(new Date).getTime()};rnd=function(a,d){return a+Math.random()*(d-a)};mix=function(a,d){var e,k=clone(a);for(e in d)isDef(d[e])&&(isDef(k[e])&&(k.parent=k.parent||{},k.parent[e]=k[e]),k[e]=isObj(d[e])?mix({},d[e]):d[e]);return k};
clone=function(a){var d,e={};for(d in a)e[d]=a[d];return e};
function ca(a,d){var e=STATE.ta;function k(d,a){return null!=e[a]&&null!=e[a][d]&&e[a][d]<=c}function g(c,d){return{sa:c,value:d.x+d.y*f,x:d.x,y:d.y,ka:0,la:0}}var l=Math.abs,c=0,f=e[0].length,u=e.length,y=f*u;return function(){for(var c=g(null,{x:d[0],y:d[1]}),e=Array(y),n=[g(null,{x:a[0],y:a[1]})],b=[],p=[],t,w,s,q,z;w=n.length;){t=y;s=-1;for(q=0;q<w;q++)n[q].ka<t&&(t=n[q].ka,s=q);w=n.splice(s,1)[0];if(w.value===c.value){s=b[b.push(w)-1];do p.push([s.x,s.y]);while(s=s.sa);e=b=n=[];p.reverse()}else{q=
w.x;t=w.y;s=t-1;z=t+1;var v=q+1,B=q-1,G=z<u&&k(q,z),H=v<f&&k(v,t),R=-1<B&&k(B,t),D=[];-1<s&&k(q,s)&&D.push({x:q,y:s});H&&D.push({x:v,y:t});G&&D.push({x:q,y:z});R&&D.push({x:B,y:t});t=D;q=0;for(z=t.length;q<z;q++)s=g(w,t[q]),e[s.value]||(s.la=w.la+(l(t[q].x-w.x)+l(t[q].y-w.y)),s.ka=s.la+(l(t[q].x-c.x)+l(t[q].y-c.y)),n.push(s),e[s.value]=!0);b.push(w)}}return p}()}
Collision={X:function(a,d){return a.x-a.origin.x<d.x-d.origin.x+d.width&&a.x-a.origin.x+a.width>d.x-d.origin.x&&a.y-a.origin.y<d.y-d.origin.y+d.height&&a.y-a.origin.y+a.height>d.y-d.origin.y},va:function(a,d){var e;Collision.X(a,d)&&(e={},e.x=Math.max(a.x-a.origin.x,d.x-d.origin.x),e.y=Math.max(a.y-a.origin.y,d.y-d.origin.y),e.width=Math.min(a.x-a.origin.x+a.width,d.x-d.origin.x+d.width)-e.x,e.height=Math.min(a.y-a.origin.y+a.height,d.y-d.origin.y+d.height)-e.y);return e},aa:function(a,d){var e=Collision.va(a,
d),k=0;return e?(e.width>e.height?(k=sgn(a.y-d.y),a.y+=e.height*k):(k=sgn(a.x-d.x),a.x+=e.width*k),!0):!1}};FONT_BLACK=0;FONT_WHITE=1;
Graphics=function(){var a=_.getElementById("c"),d=a.getContext("2d"),e="#fff",k=1,g=ASSETS.font,l={canvas:a,B:d,xa:function(c){d.imageSmoothingEnabled=c},qa:function(c){d.fillStyle=c?c:"#000";d.globalAlpha=1;d.fillRect(0,0,a.width,a.height);d.fillStyle=e;d.globalAlpha=k},Q:function(c,e,a){d.beginPath();d.arc(c,e,a,0,2*Math.PI);d.fill();d.closePath()},color:function(c){e=c;d.fillStyle=d.strokeStyle=e},alpha:function(c){k=d.globalAlpha=c},rect:function(c,e,a,g){d.fillRect(c,e,a,g)},Da:function(c,e,
a,g){d.strokeRect(c,e,a,g)},ma:function(c,d,e){var a=_.createElement("canvas"),g=a.getContext("2d");a.width=c;a.height=d;g.fillStyle=e;g.fillRect(0,0,a.width,a.height);return a},Ca:function(c,a,e,g){d.beginPath();d.moveTo(c,a);d.lineTo(e,g);d.stroke();d.closePath()},ja:function(c,a,e){d.drawImage(c,a,e)},ua:function(c,a,e,g,k,l,n){d.drawImage(c,g,k,l,n,a,e,l,n)},text:function(c,a,e,k,r,m,n,b){c=(c+"").toLowerCase();var p=c.length,t=-1,w=0,s=-1,q=0;k=isNum(k)?k:FONT_WHITE;n=isNum(n)?n:0;b=isNum(b)?
b:2;d.save();d.translate(a,e);isNum(r)&&isNum(m)&&d.scale(r,m);for(a=0;a<p;++a)s++,"\n"===c[a]&&(w++,s=-1),s>q&&(q=s),t="abcdefghijklmnopqrstuvwxyz 0123456789:.!?".indexOf(c[a]),0<=t&&(0===k||1===k)&&l.ua(g,(8+n)*s,w*(7+b),8*t,7*k,8,7);d.restore()}};d.fillStyle=d.strokeStyle=e;return l};function da(){this.wa=function(a){for(var d=0;24>d;d++)this[String.fromCharCode(97+d)]=a[d]||0;0.01>this.c&&(this.c=0.01);a=this.b+this.c+this.e;0.18>a&&(a=0.18/a,this.b*=a,this.c*=a,this.e*=a)}}
var X=new function(){this.ca=new da;var a,d,e,k,g,l,c,f,u,y,r,m;this.reset=function(){var a=this.ca;k=100/(a.f*a.f+0.001);g=100/(a.g*a.g+0.001);l=1-a.h*a.h*a.h*0.01;c=-a.i*a.i*a.i*1E-6;a.a||(r=0.5-a.n/2,m=5E-5*-a.o);f=1+a.l*a.l*(0<a.l?-0.9:10);u=0;y=1==a.m?0:(1-a.m)*(1-a.m)*2E4+32};this.za=function(){this.reset();var c=this.ca;a=c.b*c.b*1E5;d=c.c*c.c*1E5;e=c.e*c.e*1E5+12;return 3*((a+d+e)/3|0)};this.ya=function(n,b){var p=this.ca,t=1!=p.s||p.v,w=p.v*p.v*0.1,s=1+3E-4*p.w,q=p.s*p.s*p.s*0.1,z=1+1E-4*
p.t,v=1!=p.s,B=p.x*p.x,G=p.g,H=p.q||p.r,R=p.r*p.r*p.r*0.2,D=p.q*p.q*(0>p.q?-1020:1020),Y=p.p?((1-p.p)*(1-p.p)*2E4|0)+32:0,ea=p.d,Z=p.j/2,fa=p.k*p.k*0.01,S=p.a,T=a,ga=1/a,ha=1/d,ia=1/e,p=5/(1+p.u*p.u*20)*(0.01+q);0.8<p&&(p=0.8);for(var p=1-p,U=!1,aa=0,L=0,M=0,P=0,J=0,N,K=0,A,E=0,I,V=0,x,ba=0,F,W=0,Q=Array(1024),O=Array(32),C=Q.length;C--;)Q[C]=0;for(C=O.length;C--;)O[C]=2*Math.random()-1;for(C=0;C<b;C++){if(U)return C;Y&&++ba>=Y&&(ba=0,this.reset());y&&++u>=y&&(y=0,k*=f);l+=c;k*=l;k>g&&(k=g,0<G&&(U=
!0));A=k;0<Z&&(W+=fa,A*=1+Math.sin(W)*Z);A|=0;8>A&&(A=8);S||(r+=m,0>r?r=0:0.5<r&&(r=0.5));if(++L>T)switch(L=0,++aa){case 1:T=d;break;case 2:T=e}switch(aa){case 0:M=L*ga;break;case 1:M=1+2*(1-L*ha)*ea;break;case 2:M=1-L*ia;break;case 3:M=0,U=!0}H&&(D+=R,I=D|0,0>I?I=-I:1023<I&&(I=1023));t&&s&&(w*=s,1E-5>w?w=1E-5:0.1<w&&(w=0.1));F=0;for(var ja=8;ja--;){E++;if(E>=A&&(E%=A,3==S))for(N=O.length;N--;)O[N]=2*Math.random()-1;switch(S){case 0:x=E/A<r?0.5:-0.5;break;case 1:x=1-E/A*2;break;case 2:x=E/A;x=6.28318531*
(0.5<x?x-1:x);x=1.27323954*x+0.405284735*x*x*(0>x?1:-1);x=0.225*((0>x?-1:1)*x*x-x)+x;break;case 3:x=O[Math.abs(32*E/A|0)]}t&&(N=K,q*=z,0>q?q=0:0.1<q&&(q=0.1),v?(J+=(x-K)*q,J*=p):(K=x,J=0),K+=J,P+=K-N,x=P*=1-w);H&&(Q[V%1024]=x,x+=Q[(V-I+1024)%1024],V++);F+=x}F=0.125*F*M*B;n[C]=1<=F?32767:-1>=F?-32768:32767*F|0}return b}};
window.jsfxr=function(a){X.ca.wa(a);var d=X.za();a=new Uint8Array(4*((d+1)/2|0)+44);var d=2*X.ya(new Uint16Array(a.buffer,44),d),e=new Uint32Array(a.buffer,0,44);e[0]=1179011410;e[1]=d+36;e[2]=1163280727;e[3]=544501094;e[4]=16;e[5]=65537;e[6]=44100;e[7]=88200;e[8]=1048578;e[9]=1635017060;e[10]=d;for(var d=d+44,e=0,k="data:audio/wav;base64,";e<d;e+=3)var g=a[e]<<16|a[e+1]<<8|a[e+2],k=k+("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[g>>18]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[g>>
12&63]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[g>>6&63]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[g&63]);return k};Sounds=function(){this.da={}};Sounds.prototype.add=function(a,d,e){this.da[a]=[];e.forEach(function(e,g){this.da[a].push({ea:0,count:d,pa:[]});for(var l=0;l<d;l++){var c=new Audio;c.src=jsfxr(e);this.da[a][g].pa.push(c)}},this)};
Sounds.prototype.play=function(a){a=this.da[a];a=1<a.length?a[Math.floor(Math.random()*a.length)]:a[0];a.pa[a.ea].play();a.ea<a.count-1?a.ea++:a.ea=0};State=function(a){var d=[];return mix({remove:function(a){a=d.indexOf(a);0<=a&&d.splice(a,1)},add:function(a){d.push(a);a.W&&a.W()},update:function(){d.sort(function(a,d){return a.z-d.z});d.forEach(function(a){a.update&&a.update()})},M:function(a){d.forEach(function(d){d.M&&d.M(a)})},clear:function(){d.length=0}},a)};
Bullet=function(a){var d,e=!1,k=0,g=!1,l=255,c=25,f={C:1E3,parent:a,x:0,y:0,width:20,height:15,J:0,origin:{x:10,y:6},speed:25,ha:{x:0,y:0},z:0,type:0,W:function(){d=GFX.ma(f.width,f.height,"#FFDE82")},T:function(d){e&&(c=d||25,e=!1,d=a.L.indexOf(f),0<=d&&a.L.splice(d,1),f.z=1E7,g=!0)},ba:function(a,d,g,m){e||(m=m||1,m=rnd(-m,m),c=25,2===f.type&&(c=4,m=0),f.x=a,f.y=d,f.ha.x=Math.cos(g)*f.speed+m,f.ha.y=Math.sin(g)*f.speed+m,f.J=g,k=ms(),e=!0,l=255);return f},update:function(){if(e&&(f.z=f.y,f.x+=f.ha.x,
f.y+=f.ha.y,ms()-k>f.C||0>f.x||0>f.y||f.x>GAME_WIDTH||f.y>GAME_HEIGHT)){e=!1;var c=a.L.indexOf(f);0<=c&&a.L.splice(c,1)}},M:function(a){if(0===f.type)if(e){var k=a.B;k.save();k.translate(f.x,f.y);k.rotate(f.J);k.translate(-f.width/2,-f.height/2);a.ja(d,0,0);a.color("#FFECC5");a.Q(f.width,f.height/2,f.height/2);k.restore()}else g&&(a.color("#fff"),a.Q(f.x,f.y,30),g=!1);else 1===f.type&&e&&(a.color("rgb(255,"+l+", 0)"),a.Q(f.x,f.y,c),0<l&&(l-=20,c-=1.5,0>l&&(l=0)))}};return f};
Enemy=function(){function a(){if(y[r]){var a=Math.atan2(b.O.y-b.y,b.O.x-b.x);y[r].speed=2;y[r].C=1E4;y[r].ba(b.x,b.y,a,0);b.L.push(y[r]);r++;r>y.length&&(r=0)}}var d,e=ASSETS.guns,k=!1,g=100,l=0,c=0,f=!1,u=0,y=[],r=0,m=0,n=[],b={A:0,type:Math.floor(rnd(0,2)),O:null,x:-100,y:-100,width:30,height:30,origin:{x:15,y:15},z:0,speed:2,C:1,ga:3,V:!1,D:{},fa:!1,L:[],W:function(){if(0===b.type)d=ASSETS.enemy1;else{d=ASSETS.enemy2;for(var a=0;20>a;++a){var c=Bullet(this);y.push(c);STATE.add(c)}m=ms()}b.D.top=
{H:b.x,I:b.y,F:b.x+b.width,G:b.y};b.D.bottom={H:b.x,I:b.y+b.height,F:b.x+b.width,G:b.y+b.height};b.D.left={H:b.x,I:b.y,F:b.x,G:b.y+b.height};b.D.right={H:b.x+b.width,I:b.y,F:b.x+b.width,G:b.y+b.height};b.C=b.ga},set:function(a,c){k||(k=!0,b.x=a,b.y=c,b.C=3,b.speed=rnd(1,2),1===b.type&&(b.speed=1),b.fa=80<rnd(0,100)?!0:!1,f=!1,b.A=Math.floor(rnd(0,3)),m=ms())},update:function(){if(k){if(null!==b.O){if(0<n.length){var e=n[1];if(e){var g=40*e[0]-(b.x+15),e=40*e[1]-(b.y+15),f=Math.atan2(e,g);Math.sqrt(g*
g+e*e)<b.speed?n.splice(0,1):(b.x+=Math.cos(f)*b.speed,b.y+=Math.sin(f)*b.speed)}}(b.O.R||0==n.length)&&1E3<ms()-0&&(n=ca([Math.floor(b.x/40)+1,Math.floor(b.y/40)+1],[Math.floor((b.O.x+15)/40)+1,Math.floor((b.O.y+15)/40)+1]));b.L.forEach(function(a){Collision.X(a,b.O)&&(a.T(100),b.O.T())})}1800<ms()-m&&(a(),m=ms());0>=b.C&&(k=!1,STATE.Y(2,100),SOUNDS.play("sg"),l=b.x,c=b.y,b.fa?d=ASSETS.ammo:b.x=b.y=-100,KILLS++);b.D.top={H:b.x,I:b.y,F:b.x+b.width,G:b.y};b.D.bottom={H:b.x,I:b.y+b.height,F:b.x+b.width,
G:b.y+b.height};b.D.left={H:b.x,I:b.y,F:b.x,G:b.y+b.height};b.D.right={H:b.x+b.width,I:b.y,F:b.x+b.width,G:b.y+b.height}}},T:function(){k=!1;b.x=-100;b.y=-100;b.D.top={H:b.x,I:b.y,F:b.x+b.width,G:b.y};b.D.bottom={H:b.x,I:b.y+b.height,F:b.x+b.width,G:b.y+b.height};b.D.left={H:b.x,I:b.y,F:b.x,G:b.y+b.height};b.D.right={H:b.x+b.width,I:b.y,F:b.x+b.width,G:b.y+b.height};g=100;f=!0},M:function(a){k?(b.z=b.y,a.color("#000"),a.alpha(0.2),a.Q(b.x,b.y+15,10),a.alpha(1),a.B.save(),a.B.translate(b.x,b.y+5*Math.sin(u)),
a.B.drawImage(d,0,0,10,10,-15,-15,b.width,b.width),a.B.restore()):(0>=b.C&&0<g&&!f&&(a.color("#fff"),a.Q(l+15,c+15,g),g-=20,0>g&&(g=0)),b.fa&&(a.B.save(),a.B.translate(b.x,b.y+5*Math.sin(u)),b.z=b.y,0===b.type?a.B.drawImage(d,0,0,10,10,0,0,b.width,b.width):a.B.drawImage(e,10*b.A,0,10,7,0,0,40,28),a.B.restore()));u+=0.2}};return b};
Map=function(){var a,d,e,k,g=!0,l=ms(),c,f;return State({create:function(){AMMO=[150,15,500,0];GFX.canvas.style.cursor="auto";LAST_POS.x=GAME_WIDTH/2;LAST_POS.y=GAME_HEIGHT/2;mouse.U=!1;OLD_GUN=0;a=MOVES.length;d=KILLS;KILLS=MOVES.length=0;e="You survived "+a+" rooms and killed "+d+" enemies!";k="extreme mini massacre";c="Controls \n  Keyboard:\n   MOVE with WASD and AIM with MOUSE.\n   SHOOT with mouse button.\n   Q and E to change weapon.\n\n";f="developed by Felipe alfonso for JS13kgames 2014";
ixb&&gs&&(c+="  Gamepad:\n   LEFT AXIS to MOVE and RIGHT AXIS to AIM.\n   RT to SHOOT.\n   LEFT and RIGHT to change weapon")},M:function(a){a.text(k,GAME_WIDTH/2-32*k.length/2,26,1,4,4);a.text(c,20,100,1,1,1);a.alpha(0.5);a.text(f,0,GAME_HEIGHT-8,1,1,1);a.alpha(1);PLAYED&&a.text(e,GAME_WIDTH/2-12*e.length/2,GAME_HEIGHT/2,1,1.5,1.5);g&&a.text("Click to continue",GAME_WIDTH/2-128,GAME_HEIGHT-100,1,2,2);500<ms()-l&&(g=g?!1:!0,l=ms());mouse.U?setState(Room):pads[0]&&ixb&&gs&&(pads[0].buttons[7].pressed||
pads[0].buttons[0].pressed)&&setState(Room)}})};AMMO=[150,15,500,0];
Player=function(){function a(b,a){var c=b.F-b.H,d=b.G-b.I,e=a.F-a.H,g=a.G-a.I,f=c*g-d*e,k,l;if(0===f)return null;k=a.H-b.H;l=a.I-b.I;e=(k*g-l*e)/f;if(0>e||1<e)return null;f=(k*d-l*c)/f;return 0>f||1<f?null:{x:b.H+e*c,y:b.I+e*d}}function d(a){(0===b.A||1===b.A)&&ms()-c>l&&0>=AMMO[b.A]&&(b.P=!1,SOUNDS.play("em"),c=ms());1===b.A&&(b.P=!1);if(ms()-c>l)if(3!==b.A&&0>=AMMO[b.A])b.P=!1;else if(0===b.A)AMMO[b.A]--,b.K[f].speed=25,b.K[f].C=1E3,b.K[f].type=0,b.L.push(b.K[f].ba(b.x+50*Math.cos(b.J),b.y+50*Math.sin(b.J),
b.J)),f++,f>b.K.length-1&&(f=0),c=ms(),STATE.Y(2,100),SOUNDS.play("mg"),u=!0,l=80,b.P=!0;else if(1===b.A){AMMO[b.A]--;a=f+3;var d=f;a>b.K.length-1&&(d=f=0,a=3);for(f=d;f<a;++f)b.K[f].speed=35,b.K[f].C=1E3,b.K[f].type=0,b.L.push(b.K[f].ba(b.x+50*Math.cos(b.J),b.y+50*Math.sin(b.J),b.J,5));f>b.K.length-1&&(f=0);c=ms();STATE.Y(4,100);SOUNDS.play("sg");u=!0;l=500;b.P=!0}else 2===b.A?(AMMO[b.A]--,b.K[f].speed=10,b.K[f].C=200,b.K[f].type=1,b.L.push(b.K[f].ba(b.x+80*Math.cos(b.J),b.y+80*Math.sin(b.J),b.J,
5)),f++,f>b.K.length-1&&(f=0),c=ms(),SOUNDS.play("ft"),l=0,b.P=!0):3===b.A&&(b.K[f].speed=0,b.K[f].C=90,b.K[f].type=2,b.L.push(b.K[f].ba(b.x+5+80*Math.cos(b.J),b.y+5+80*Math.sin(b.J),b.J,0)),f++,f>b.K.length-1&&(f=0),a&&SOUNDS.play("sw"),c=ms(),l=0,b.P=!1)}function e(){var a=pads[0];if(a&&ixb&&gs){-0.3>a.axes[0]?(b.x+=5*a.axes[0],n+=0.2):0.3<a.axes[0]&&(b.x+=5*a.axes[0],n+=0.2);-0.3>a.axes[1]?(b.y+=5*a.axes[1],n+=0.2):0.3<a.axes[1]&&(b.y+=5*a.axes[1],n+=0.2);if(0.3<Math.abs(a.axes[2])||0.3<Math.abs(a.axes[3]))b.J=
Math.atan2(a.axes[3]-0,a.axes[2]-0),b.N.x=b.x+100*Math.cos(b.J),b.N.y=b.y+100*Math.sin(b.J);a.buttons[7]&&a.buttons[7].pressed&&d();a.buttons[14].pressed?(b.A=m,0===m?l=80:1===m?l=800:2===m&&(l=0)):a.buttons[15].pressed&&(b.A=3)}}var k=ASSETS.player,g=ASSETS.guns,l=80,c=0,f=0,u=!1,y=0,r=!0,m=0,n=1,b={z:0,x:LAST_POS.x,y:LAST_POS.y,J:0,width:35,height:35,origin:{x:17.5,y:17.5},K:[],L:[],N:{x:0,y:0},A:2,P:!1,V:!1,R:!1,W:function(){for(var a=0;150>a;++a)b.K.push(Bullet(this));m=OLD_GUN;b.A=OLD_GUN},update:function(){r&&
(3===b.A&&y!==b.J&&(d(0.05<=Math.abs(y)-Math.abs(b.J)),y=b.J),b.z=b.y,b.R=!1,keyboard[65]?(b.x-=5,n+=0.2,b.R=!0):keyboard[68]&&(b.x+=5,b.R=!0,n+=0.2),keyboard[87]?(b.y-=5,b.R=!0,n+=0.2):keyboard[83]&&(b.y+=5,b.R=!0,n+=0.2),b.J=Math.atan2(b.N.y-b.y,b.N.x-b.x),!0===mouse.U?d():b.P=!1,keyboard[81]?(b.A=m,0===m?l=80:1===m?l=800:2===m&&(l=0)):keyboard[69]&&(b.A=3),b.R||e(),OLD_GUN=b.A,STATE.S.forEach(function(a){Collision.X(a,b)&&(0<a.C?(STATE.$=!0,a.Aa=!1,a.C=0,STATE.Y(3,200),r=!1,STATE.ia=!0):(0===a.type?
0===m?AMMO[m]+=20:1===m?AMMO[m]+=5:2===m&&(AMMO[m]+=50):1===a.type&&(m=a.A,b.A=a.A,OLD_GUN=m,AMMO=[150,15,500,0]),SOUNDS.play("am"),a.T()))}))},T:function(){STATE.$=!0;STATE.Y(4,200);r=!1;STATE.ia=!0;SOUNDS.play("ex")},M:function(c){if(r){var d=c.B;if(b.P){d.beginPath();for(var e=0;90>e;++e){for(var f=4*e*Math.PI/180,f={H:b.x,I:b.y,F:b.x+600*Math.cos(f),G:b.y+600*Math.sin(f)},l=0;l<STATE.na.length;++l){var m=STATE.na[l],v;for(h in m.D)v=m.D[h],v=a(f,v),null!==v&&(f.F=v.x,f.G=v.y)}for(l=0;l<STATE.S.length;++l)for(h in m=
STATE.S[l],m.D)v=m.D[h],v=a(f,v),null!==v&&(f.F=v.x,f.G=v.y);0==e?d.moveTo(f.F,f.G):d.lineTo(f.F,f.G)}c.color("#fff");c.alpha(0.1);d.fill();d.closePath();c.alpha(1)}d.save();d.translate(b.x,b.y+5*Math.sin(n));d.translate(-b.width/2,-b.height/2);c.color("#000");c.alpha(0.2);c.Q(20,40,20);c.alpha(1);d.drawImage(k,0,0,k.width,k.height,0,5*Math.sin(n),40,40);d.translate(20,20);d.rotate(b.J);e=1;3===b.A&&(e=1.5);d.drawImage(g,10*b.A,0,10,7,20,-10,40*e,28*e);u&&2>b.A&&(c.color("#fff"),c.Q(70,-6,25),u=!1);
d.restore();if(3===b.A){d.beginPath();for(e=0;e<b.L.length;e++)f=b.L[e],0===e?d.moveTo(b.x+Math.cos(b.J),b.y+Math.sin(b.J)):d.lineTo(f.x,f.y);c.alpha(0.5);c.color("#fff");d.fill();d.closePath();c.alpha(1)}}}};return b};
Portal=function(a,d){var e=!0,k=100,g=0,l=0,c={x:a,y:d,width:50,height:60,C:1,ga:30,origin:{x:0,y:0},V:!1,D:{},W:function(){g=rnd(1500,3E3);l=ms();c.C=c.ga;c.D.top={H:c.x,I:c.y,F:c.x+c.width,G:c.y};c.D.bottom={H:c.x,I:c.y+c.height,F:c.x+c.width,G:c.y+c.height};c.D.left={H:c.x,I:c.y,F:c.x,G:c.y+c.height};c.D.right={H:c.x+c.width,I:c.y,F:c.x+c.width,G:c.y+c.height}},M:function(a){e?(c.D.top={H:c.x,I:c.y,F:c.x+c.width,G:c.y},c.D.bottom={H:c.x,I:c.y+c.height,F:c.x+c.width,G:c.y+c.height},c.D.left={H:c.x,
I:c.y,F:c.x,G:c.y+c.height},c.D.right={H:c.x+c.width,I:c.y,F:c.x+c.width,G:c.y+c.height},0>=c.C&&(c.width=c.height=0,e=!1,SOUNDS.play("ex"),STATE.Y(5,300),delete c.D),a.color("#D53E3C"),a.rect(c.x,c.y,c.width,c.height),a.color("#000"),a.rect(c.x+10,c.y+10,c.width-20,c.height-10),a.color("#5a5a5a"),a.rect(c.x-5,c.y-20,60,10),a.color("#18943D"),a.rect(c.x-5,c.y-20,60*c.C/c.ga,10),c.V&&(c.V=!1,a.color("#fff"),a.rect(c.x,c.y,c.width,c.height)),ms()-l>g&&STATE.oa&&0<c.C&&(g=rnd(1500,3E3),STATE.oa(c.x,
c.y),l=ms())):0<k&&(a.color("#fff"),a.Q(c.x+25,c.y+30,k),k-=10,0>k&&(k=0))}};return c};LAST_POS={x:GAME_WIDTH/2,y:GAME_HEIGHT/2};LAST_SIDE=0;MOVES=[];KILLS=OLD_GUN=0;PLAYED=!1;
Room=function(){function a(b,a){G[B].set(rnd(b-20,b+30),rnd(a-20,a+50));B++;B>G.length-1&&(B=0)}var d=0,e=0,k=[[[11,11,11,11,11,11,11,11,10,10,10,10,10,11,11,11,11,11,11,11,11,11],[11,1,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,11],[9,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,7],[9,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7],[9,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,3,7],[9,5,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7],[9,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,7],[11,1,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,1,1,1,1,11],[11,11,11,11,11,11,11,11,8,8,8,8,8,11,11,11,11,11,11,11,11,11]],[[11,11,11,11,11,11,11,11,10,10,10,10,10,11,11,11,11,11,11,11,11,11],[11,1,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,11],[11,1,0,-1,0,0,0,0,0,0,0,0,
0,0,0,0,1,0,-1,0,1,11],[11,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,11],[9,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,7],[9,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7],[9,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7],[9,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7],[9,1,0,-1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,7],[11,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,1,1,1,1,11],[11,11,11,11,11,11,11,11,8,8,8,8,8,11,11,11,11,11,11,11,
11,11]],[[11,11,11,11,11,11,11,11,10,10,10,10,10,11,11,11,11,11,11,11,11,11],[11,1,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,11],[11,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,0,0,-1,0,1,0,0,0,0,0,0,0,0,1,0,-1,0,0,1,11],[9,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,1,7],[9,5,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,3,7],[9,5,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,3,7],[9,5,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,3,7],[9,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,1,7],
[11,1,0,0,-1,0,1,0,0,0,0,0,0,0,0,1,0,-1,0,0,1,11],[11,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,11],[11,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,1,1,1,1,11],[11,11,11,11,11,11,11,11,8,8,8,8,8,11,11,11,11,11,11,11,11,11]],[[11,11,11,11,11,11,11,11,10,10,10,10,10,11,11,11,11,11,11,11,11,11],[11,1,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,0,0,0,1,1,1,1,1,1,0,0,1,1,1,1,0,0,0,1,11],[9,1,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,1,0,0,0,1,7],[9,5,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,3,7],[9,5,0,0,0,1,-1,0,0,0,0,0,0,0,0,-1,1,0,0,0,3,7],[9,5,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,3,7],[9,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,7],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,11],[11,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,1,1,1,1,11],[11,11,11,11,11,11,11,11,8,8,8,8,8,11,11,11,11,11,11,11,11,11]]][Math.floor(rnd(0,4))],g=[],l=[],c,f=!0,u=1,y=!1,r,m=0,n=2,b=0.02,p=!1,t=2,w=0,s=0,q=0,z=0,
v=[],B=0,G=[],H=4;return State({create:function(){PLAYED=!0;this.ta=k;this.oa=a;this.$=this.ia=!1;GFX.canvas.style.cursor="none";r=_.createElement("canvas");r.width=r.height=20;var b=r.getContext("2d");b.strokeStyle="#fff";b.lineWidth=4;b.beginPath();b.moveTo(10,0);b.lineTo(10,20);b.closePath();b.stroke();b.beginPath();b.moveTo(0,10);b.lineTo(20,10);b.closePath();b.stroke();b.clearRect(6,6,8,8);for(var d=Math.floor(rnd(7,11));d==LAST_SIDE;)d=Math.floor(rnd(7,11));c=Player();this.add(c);for(b=0;b<
c.K.length;b++)this.add(c.K[b]);H=d-4;for(b=2;0<b;){var d=Math.floor(rnd(4,14)),e=Math.floor(rnd(4,11)),f=k[d];isDef(f)&&(f=f[e],0===f&&(k[d][e]=1,b--))}for(b=0;b<k.length;++b)for(d=0;d<k[b].length;++d)0<k[b][d]||null===k[b][d]?(e=Tile(40*(d-1),40*(b-1),null==k[b][d]?1:k[b][d]),7>k[b][d]?(g.push(e),this.add(e)):l.push(e)):-1===k[b][d]&&(e=Portal(40*d,32*b),this.add(e),g.push(e),v.push(e));this.na=g;this.S=G;v.forEach(function(b){v.forEach(function(a){b!==a&&Collision.aa(a,b)})});g.forEach(function(b){v.forEach(function(a){Collision.aa(a,
b)})});g.forEach(function(b){Collision.aa(c,b)});for(b=0;100>b;++b)d=Enemy(),d.O=c,this.add(d),this.S.push(d)},Y:function(b,a){p||(t=b,w=a,s=ms(),p=!0)},update:function(){q=-(c.x-GAME_WIDTH/2);z=-(c.y-GAME_HEIGHT/2);if(y){if(mouse.x!==d||mouse.y!==e||c.R)c.N.x=mouse.x,c.N.y=mouse.y,c.N.x-=q,c.N.y-=z,d=mouse.x,e=mouse.y;LAST_POS.x=c.x;LAST_POS.y=c.y;this.parent.update();g.forEach(function(b){Collision.aa(c,b);STATE.S.forEach(function(a){isDef(b.C)||Collision.aa(a,b)});c.L.forEach(function(a){a&&Collision.X(a,
b)&&(b.C&&3!==c.A&&2!==c.A?(b.C--,b.V=!0):b.C&&(b.C-=0.2,b.V=!0),a.T());STATE.S.forEach(function(b){a&&Collision.X(a,b)&&(b.C&&(0===c.A?b.C=0:1===c.A?b.C=0:2===c.A?b.C--:3===c.A&&(b.C-=0.8)),b.fa||a.T())})})});for(var b=0;b<l.length;++b){var a=l[b];if(Collision.X(c,a)){SOUNDS.play("dr");this.$=!0;y=!1;10===a.Z?(LAST_POS.y=GAME_HEIGHT-c.height-20,LAST_SIDE=8,MOVES.push(10)):8===a.Z&&(LAST_POS.y=c.height+20,LAST_SIDE=10,MOVES.push(8));9===a.Z?(LAST_POS.x=GAME_WIDTH-c.width-20,LAST_SIDE=7,MOVES.push(9)):
7===a.Z&&(LAST_POS.x=c.width+20,LAST_SIDE=9,MOVES.push(7));return}}var f=0;v.forEach(function(b){0>=b.C&&f++});f===v.length&&g.forEach(function(b){if(b.Z===H){var a=g.indexOf(b),c=v.indexOf(b);0<=a&&(g.splice(a,1),v.splice(c,1));STATE.remove(b)}})}},M:function(a){a.qa("#071A2B");a.B.save();a.B.beginPath();a.B.save();p&&(q+=t|0,z+=t|0,t*=-1,ms()-s>w&&(p=!1));a.B.translate(q|0,z|0);a.B.rect(0,0,GAME_WIDTH,GAME_HEIGHT);a.B.clip();a.color("#163338");a.rect(0,0,GAME_WIDTH,GAME_HEIGHT);a.color("#242938");
a.rect(0,0,GAME_WIDTH,60);this.parent.M(a);a.B.closePath();a.B.restore();a.B.save();a.B.translate(q|0,z|0);a.B.save();a.B.translate(c.N.x,c.N.y);a.B.rotate(m);a.B.scale(n,n);a.B.translate(-10,-10);a.ja(r,0,0);a.B.restore();a.B.restore();m+=0.1;if(2.2<n||1.8>n)b*=-1;n+=b;f&&0<u?(u-=0.025,0>u&&(u=0,f=!1,y=!0),a.color("#000"),a.alpha(u),a.rect(0,0,GAME_WIDTH,GAME_HEIGHT),a.alpha(1)):this.$&&1>u&&(u+=0.025,1<u&&(u=1,this.$=!1,this.ia?(setState(Map),mouse.U=!1):setState(Room)),a.color("#000"),a.alpha(u),
a.rect(0,0,GAME_WIDTH,GAME_HEIGHT),a.alpha(1));a.text("ammo:"+AMMO[c.A],0,4,0,2,2);a.text("ammo:"+AMMO[c.A],0,0,1,2,2)},ra:function(){g.length=0;l.length=0;this.clear();delete this.S;delete this.na}})};
Tile=function(a,d,e){var k,g={x:a,y:d,Z:e,width:40,height:40,origin:{x:0,y:0},z:0,D:{},W:function(){g.z=g.y;k=7>e?GFX.ma(g.width,g.height,"#F2E4A4"):GFX.ma(40,40,"#000");g.D.top={H:g.x,I:g.y,F:g.x+g.width,G:g.y};g.D.bottom={H:g.x,I:g.y+g.height,F:g.x+g.width,G:g.y+g.height};g.D.left={H:g.x,I:g.y,F:g.x,G:g.y+g.height};g.D.right={H:g.x+g.width,I:g.y,F:g.x+g.width,G:g.y+g.height}},M:function(a){7>e&&(a.B.save(),a.B.translate(g.x,g.y),a.ja(k,0,0),a.B.restore(),a.color("#B83C2A"),a.rect(g.x,g.y+g.height,
g.width,g.height/2))}};return g};$=window;_=document;GFX=null;ASSETS={};STATE=SOUNDS=null;mouse={x:0,y:0,U:!1};ratio={x:1,y:1};keyboard={};pads={};ixb=!1;gs=!!navigator.getGamepads;(function(){var a="font.png player.png guns.png enemy1.png ammo.png enemy2.png".split(" "),d=null,e=0;$.onload=function(){a.forEach(function(k){d=new Image;d.onload=function(d){ASSETS[(d.target.src.match(/([^\/]+)(?=\.\w+$)?([^/]+?(\.png))/g)+"").replace(".png","")]=d.target;e++;e>=a.length&&main()};d.src=k})}})();
mainLoop=function(){requestAnimationFrame(mainLoop);if(gs){var a=navigator.getGamepads(),d,e=a.length;for(d=0;d<e;++d)a[d]&&(pads[a[d].index]=a[d]);pads[0]&&0<=pads[0].id.indexOf("Xbox 360")&&(ixb=!0)}GFX.qa();STATE&&null!==STATE&&(STATE.update&&STATE.update(),STATE.M&&STATE.M(GFX))};setState=function(a){a=a();STATE&&STATE.ra&&STATE.ra();STATE=a;STATE.create&&STATE.create()};
main=function(){function a(){var a=Math.min($.innerWidth/GAME_WIDTH,$.innerHeight/GAME_HEIGHT);GFX.canvas.style.width=GAME_WIDTH*a+"px";GFX.canvas.style.height=GAME_HEIGHT*a+"px";a.x=GAME_WIDTH/(GAME_WIDTH*a);a.y=GAME_HEIGHT/(GAME_HEIGHT*a)}function d(a){mouse.x=a.clientX-GFX.canvas.offsetLeft;mouse.y=a.clientY-GFX.canvas.offsetTop;mouse.x*=ratio.x;mouse.y*=ratio.y}window.onresize=a;SOUNDS=new Sounds;SOUNDS.add("mg",10,[[0,,0.1898,0.123,0.1973,0.3901,0.0381,-0.6025,,,,,,0.6192,-0.5134,,,,1,,,,,0.5]]);
SOUNDS.add("sg",10,[[3,,0.2739,0.4903,0.161,0.1388,,-0.3744,,,,,,,,,0.3948,-0.1186,1,,,,,0.5]]);SOUNDS.add("ft",10,[[3,,0.3976,0.3243,0.1494,0.0926,,,,,,,,,,,,,1,,,,,0.5]]);SOUNDS.add("sw",10,[[3,0.1385,0.1007,0.1,0.34,0.42,,0.06,-0.3,,,-0.3,-0.6024,,1E-4,,-0.16,-0.02,0.71,-0.26,,0.84,-0.7,0.3]]);SOUNDS.add("dr",10,[[3,,0.0259,,0.2126,0.4486,,-0.6876,,,,,,,,,,,1,,,0.2362,,0.5]]);SOUNDS.add("ex",10,[[3,,0.3825,0.4313,0.3835,0.7215,,-0.3735,,,,,,,,,0.0109,-0.0889,1,,,,,0.5]]);SOUNDS.add("am",10,[[3,
,0.0781,,0.1428,0.4633,,-0.5926,,,,,,,,,,,1,,,,,0.5]]);SOUNDS.add("em",10,[[0,,0.0963,,0.2931,0.6198,,-0.6907,,,,,,0.1502,,,,,1,,,0.2864,,0.5]]);GFX=Graphics();$.onkeydown=function(a){keyboard[a.keyCode]=!0};$.onkeyup=function(a){keyboard[a.keyCode]=!1};$.addEventListener("gamepaddisconnected",function(a){delete pads[a.Ba.index]});GFX.canvas.onmousemove=function(a){d(a)};GFX.canvas.onmousedown=function(a){d(a);mouse.U=!0};GFX.canvas.onmouseup=function(a){d(a);mouse.U=!1};GFX.xa(!1);mainLoop();setState(Map);
a()};
