class Board{constructor(t,e){this.nCols=t.nC,this.nRows=t.nR,this.tiles=this.deserializeTiles(t.sB,t.nR,t.nC),this.finalNumber=t.fN,this.players=[new Player(1,1==e),new Player(2,2==e)],this.me=this.players.find(t=>t.itsYou),this.endLine=new EndLine(this.nRows,this.finalNumber),this.offsetX=0,this.numColsDisplay=0,this.animating=!1,G.adaptResolution(),this.el=createSVG("svg"),this.el.id="board"}changeView(t,e,i,s){this.el.set([["viewBox",`${t} ${e} ${i} ${s}`]])}moveBoard(t){const e=this.el.viewBox.baseVal;this.offsetX+=t,this.changeView(this.offsetX,e.y,e.width,e.height)}animateBoardTo(t){const e=this;this.animating?setTimeout(()=>e.animateBoardTo(t),200):this.animateBoardToLoop(t)}animateBoardToLoop(t){let e=this;this.animating=!0,this.offsetX!=t?setTimeout(function(){requestAnimationFrame(()=>e.animateBoardToLoop(t));const i=t-e.offsetX,s=Math.abs(i),n=(s>120?8:s>20?5:s>3?3:s<1?s:1)*(s/i);e.moveBoard(n)},1e3/30):this.animating=!1}draw(t){this.el.appendChild(this.drawTiles(this.tiles,t)),this.drawPlayers(t),this.el.appendChild(this.endLine.render(t))}render(){const t=document.body.clientHeight>450?450:document.body.clientHeight;return this.tSize=t/6,this.offsetX=-this.tSize,this.changeView(this.offsetX,0,G.screenWidth,t),this.draw(this.tSize),this.el}refresh(){this.clear();const t=document.body.clientHeight>450?450:document.body.clientHeight;this.tSize=t/6,this.me&&(this.offsetX=this.me.currentPos.x*this.tSize-G.screenWidth/2),this.changeView(this.offsetX,0,G.screenWidth,t),this.draw(this.tSize)}clear(){for(;this.el.firstChild;)this.el.removeChild(this.el.firstChild)}drawTiles(t,e){this.numColsDisplay=parseInt((G.screenWidth+this.offsetX+e)/e),this.numColsDisplay>this.nRows&&(this.numColsDisplay=this.nRows);const i=6*this.numColsDisplay;let s=document.createDocumentFragment();for(let n=0;n<i;n++)s.appendChild(t[n].render(e));return s}drawNextTiles(t,e){let i=parseInt((G.screenWidth+e+t)/t);if(this.numColsDisplay<i&&i<=this.nRows){let e=document.createDocumentFragment();for(let s=6*(this.numColsDisplay-1);s<6*i;s++)e.appendChild(G.board.tiles[s].render(t));this.el.insertBefore(e,this.el.childNodes[0])}}drawPlayers(t){let e=document.createDocumentFragment();for(let i=0;i<this.players.length;i++)e.appendChild(this.players[i].render(t));this.el.appendChild(e)}deserializeTiles(t,e,i){const s=t.split(",");let n=[];for(let t=0;t<e;t++)for(let e=0;e<i;e++)n[t*i+e]=new Tile(t,e,s[t*i+e]);return n}}class Connector{constructor(t){this.el=createSVG("g"),this.itsYou=t,this.el.set([["text-anchor","middle"],["dominant-baseline","central"]]),this.dir=[{x:0,y:0,r:0},{x:1,y:0,r:0},{x:1,y:1,r:45,off:{x:.166,y:-.085}},{x:0,y:1,r:90,off:{x:.333,y:0}},{x:-1,y:1,r:135,off:{x:.4,y:.166}},{x:-1,y:0,r:180,off:{x:.333,y:.333}},{x:-1,y:-1,r:225,off:{x:.166,y:.4}},{x:0,y:-1,r:270,off:{x:0,y:.333}},{x:1,y:-1,r:315,off:{x:-.085,y:.166}}]}move(t,e,i){const s=this.dir.find(i=>e.x-t.x==i.x&&e.y-t.y==i.y);this.el.set([["transform",`translate(${e.x*i+i/3+(s.off?s.off.x*i:0)},${e.y*i+i/3+(s.off?s.off.y*i:0)}) scale(${i/200}) rotate(${s.r})`]])}render(t,e){let i=`<path fill="black" d="M 2 58 L 3 9 C 13.5 9 18 3 24 3 L 55.5 3 L 55.5 15 L 45 15 L 45 27 L 16.5 27 L 16.5 39 L 45 39 L 45 51 L 55.5 51 L 55.5 63 L 24 63 C 18 63 13.5 57 1 57 " class="b"/>\n            <path fill="${this.itsYou?"green":"red"}" d="M 55.5 3 L 55.5 15 L 45 15 L 45 27 L 16.5 27 L 16.5 39 L 45 39 L 45 51 L 55.5 51 L 55.5 63 L 80 63 L 80 3 Z" class="b"/>`;for(let t=0;t<5;t++)i+=`<line x1="80" y1="${18+8*t}" x2="60" y2="${18+8*t}" class="b"/>`;return this.el.innerHTML=i,this.move(t,t,e),this.el}}class EndLine{constructor(t,e){this.finalNumber=e,this.nRows=t,this.plug=new Plug(""),this.el=createSVG("g"),this.el.addEventListener(G.isTouchDevice?"touchstart":"click",this.select.bind(this))}select(){G.board.me.finish(this.nRows,this.finalNumber)}render(t){this.posX=this.nRows*t+2*t,this.posY=3*t;let e=`<pattern id="pattern-checkers" x="0" y="0" width="${2*t}" height="${2*t}" patternUnits="userSpaceOnUse" >\n        <rect x="0" width="${t}" height="${t}" y="0"/>\n        <rect x="${t}" width="${t}" height="${t}" y="${t}"/>\n      </pattern>\n      <rect x="${this.nRows*t}" y="0" width="${4*t}" height="${6*t}" fill="url(#pattern-checkers)" stroke="black" />`;this.el.innerHTML=e,this.el.appendChild(this.plug.render(this.posX,this.posY,t));let i=createSVG("text");return i.set([["x",this.posX+t/100+3],["y",this.posY+t/2+3],["fill","white"],["font-size",G.maxH()?"94px":"21vh"],["text-anchor","middle"],["dominant-baseline","central"],["stroke","darkred"],["stroke-width",G.maxH()?"4.6px":"1vh"]]),i.innerHTML=this.finalNumber,this.el.appendChild(i),this.el}}class FixContent{constructor(t,e,i){this.el=createSVG("svg"),this.el.set([["id","fix"]])}add(t){this.el.appendChild(t)}remove(t){this.el.removeChild(t)}render(){return this.el}}class Game{constructor(){this.el=document.getElementById("game"),this.body=document.body,this.state="intro",this.board=null,this.fixContent=null,this.client=null,this.screenHeight=document.body.clientHeight,this.screenWidth=document.body.clientWidth,this.maxH=(()=>this.screenHeight>=450),this.numberToGet=null,this.isTouchDevice="ontouchstart"in document.documentElement,this.intro=new Intro("connect"),this.add(this.intro.render())}add(t){this.el.appendChild(t)}clear(){for(;this.el.firstChild;)this.el.removeChild(this.el.firstChild)}changeView(t,e,i,s){this.el.set([["viewBox",`${t} ${e} ${i} ${s}`]])}resetView(){game.removeAttribute("viewBox")}adaptResolution(){this.screenHeight>=450&&"play"==this.state?(this.el.set([["style",'height:450px;margin:"0 auto"']]),this.body.set([["style",'display:flex;align-items: center;"']])):(this.el.removeAttribute("style"),this.body.removeAttribute("style"))}refresh(){const t=document.body.clientHeight;this.screenHeight=t,this.screenWidth=document.body.clientWidth,this.adaptResolution(),this.board&&this.board.refresh()}showNextNumber(t){this.numberToGet=t;const e={time:"4s",persist:!0,keyf:[{p:0,s:"font-size: 0vh;fill:'white'"},{p:50,s:"font-size: 25vh;transform: translate(0%, 0%);fill:red;text-anchor:middle;"},{p:100,s:"text-anchor:end; font-size: 0px;stroke-width: 0.3vh;transform: translate(45%, -40%); fill:yellow;"}]};this.fixContent.add(new Marker(t,this.board.tSize).render()),this.fixContent.add(new ImpactMsg("numToGet",t,e).render({x:"50%",y:"50%",anchor:"middle"}))}showMsg(t,e,i,s,n){this.fixContent.add(new ImpactMsg(t,e,{time:"2s",persist:n||!1,keyf:[{p:0,s:"font-size: 0vh;fill:'white';stroke-width:0.25vh;"},{p:70,s:"font-size: 10vh;stroke-width:0.25vh;"},{p:100,s:`font-size: 10vh;fill:${i};stroke-width:0.25vh;`}]}).render(s?{x:s.x,y:s.y,anchor:s.anchor}:{x:"90%",y:"5%",anchor:"end"}))}initClient(t){this.client=new GameClient,this.maxH()&&this.refresh()}disconnectClient(t){this.client.socket.disconnect(),this.client=null}endGame(t){t?this.showMsg("win","YOU WIN","green",{x:"50%",y:"50%",anchor:"middle"},!0):this.showMsg("lose","YOU LOSE","red",{x:"50%",y:"50%",anchor:"middle"},!0),setTimeout(()=>{G.state="wait",G.clear(),this.client.socket.disconnect(),G.add(new Intro("connect").render())},3e3)}play(t){let e;"join"==t&&(e=prompt("Enter the code")),this.client.socket.emit("play",t,e)}}class GameClient{constructor(){this.socket=io(),this.initializeEvents(this.socket)}initializeEvents(t){t.on("connect",()=>{G.state="wait"}),t.on("disconnect",()=>{"wait"!=G.state&&"finished"!=G.state&&(G.showMsg("disc","Sorry your rival has disconnected","red"),setTimeout(()=>{G.state="wait",G.clear(),this.socket.emit("disconnect"),G.add(new Intro("connect").render())},3e3))}),t.on("wait",()=>{document.body.onresize=null,G.state="wait",G.intro.wait()}),t.on("code",t=>{document.body.onresize=null,G.state="wait",G.intro.sharemenu(t)}),t.on("wrongCode",t=>{alert(`sorry cant find the code: ${t}`),G.state="wait",G.intro.submenu()}),t.on("play",e=>{G.state="play",G.clear(),G.board=new Board(e.board,e.player),G.fixContent=new FixContent,G.add(G.board.render()),G.add(G.fixContent.render()),G.resetView(),document.body.onresize=(()=>G.refresh());const i=function(){document.getElementById("fix")?t.emit("ready"):setTimeout(i,200)};i()}),t.on("start",t=>{G.showNextNumber(t.n)}),t.on("next",(t,e,i)=>{G.fixContent.remove(document.getElementById("numToGet")),G.board.players.forEach(t=>t.numberGetted(e,i)),G.showNextNumber(t.n)}),t.on("timeout",t=>{G.fixContent.remove(document.getElementById("numToGet")),G.showMsg("tout","TIMEOUT","red"),G.showNextNumber(t.n)}),t.on("finish",(t,e)=>{let i=G.board.players.find(t=>t.itsYou);G.board.players.forEach(i=>{i.numberGetted(t,e),i.finishMove(t,e)}),G.endGame(i.id==t),G.state="finished"}),t.on("info",t=>{G.intro.serverInfo.change(`Now: ${t.p} users and ${t.g} games`)})}}class ImpactMsg{constructor(t,e,i,s){this.text=e,this.id=t,this.el=createSVG("text"),this.el.set([["id",t]]),this.end=s,i&&this.setAnimation(t,i)}remove(t){t.parentNode.removeChild(t)}setAnimation(t,e){this.el.addEventListener("animationend",()=>{e.persist||this.remove(this.el),this.end&&this.end()}),this.anim=e;addStyle(`@keyframes ${t} {${(()=>{let t="";for(let i=0;i<e.keyf.length;i++)t+=`${e.keyf[i].p}% {${e.keyf[i].s}} `;return t})()}}`)}addAnimation(t,e){this.setAnimation(t,e),this.el.set([["style",`animation: ${t} ${this.anim.time} ${this.anim.persist?"forwards":""};`]])}render(t){return this.el.set([["x",`${t.x}`],["y",`${t.y}`],["font-weight","bold"],["font-family","arial"],["text-anchor",`${t.anchor}`],["dominant-baseline","central"],["fill","white"],["stroke-width","1vh"],["stroke","black"]]),this.anim&&this.el.set([["style",`animation: ${this.id} ${this.anim.time} ${this.anim.persist?"forwards":""};`]]),this.el.innerHTML=this.text,this.el}}class Intro{constructor(t){this.el=createSVG("g"),this.options=createSVG("g"),this.state=t,this.plug=new Plug(!1),this.serverInfo=new SVGText(""),this.anim=[{p:0,style:"font-size:0vh"},{p:60,s:"font-size:8vh"},{p:100,s:"font-size:0vh"}]}add(t){this.el.appendChild(t)}addOpt(t){this.options.appendChild(t)}remOpt(t){this.options.innerHTML=""}second(){this.add(new ImpactMsg("m2","ARE",{time:"0.5s",persist:!1,keyf:this.anim},this.third.bind(this)).render({x:"50%",y:"50%",anchor:"middle"}))}third(){let t=new ImpactMsg("m3","OFFLINE",{time:"0.5s",persist:!0,keyf:[{p:0,s:"font-size:0vh"},{p:100,s:"font-size:8vh"}]});this.add(t.render({x:"50%",y:"46%",anchor:"middle"})),setTimeout(()=>{t.addAnimation("goup",{time:"0.5s",persist:!0,keyf:[{p:0,s:"font-size:8vh"},{p:100,s:"transform: translate(0%, -4%);fill:red;"}]}),this.add(new ImpactMsg("m4","RACE",{time:"0.5s",persist:!0,keyf:[{p:0,s:"font-size:0vh"},{p:100,s:"font-size:8vh"}]},this.menu.bind(this)).render({x:"50%",y:"54%",anchor:"middle"}))},500)}playwithmenu(){this.remOpt(),this.addOpt(new SVGText("Create",G.play.bind(G,"create")).render(15,105,"end")),this.addOpt(new SVGText("Join",G.play.bind(G,"join")).render(40,105,"middle")),this.addOpt(new SVGText("Back",this.submenu.bind(this)).render(65,105,"start",{color:"red"}))}sharemenu(t){this.remOpt(),this.addOpt(new SVGText(`Share code: ${t}`).render(30,105,"middle",{size:"0.5em"})),this.addOpt(new SVGText("Back",()=>{this.playwithmenu.bind(this)(),G.client.socket.emit("removeGame")}).render(65,105,"start",{color:"red"}))}submenu(){null==G.client&&G.initClient(),this.plug.set(!0),this.remOpt(),this.addOpt(new SVGText("Rand",G.play.bind(G,"rand")).render(15,105,"end")),this.addOpt(new SVGText("With",this.playwithmenu.bind(this)).render(40,105,"middle")),this.addOpt(new SVGText("Exit",this.menu.bind(this)).render(65,105,"start",{color:"red"}))}wait(){this.remOpt(),this.plug.set(!0),this.addOpt(new SVGText("Waiting for rival",this.submenu.bind(this)).render(40,105,"middle",{size:"0.4em"})),this.addOpt(new SVGText("Back",()=>{G.client.socket.emit("removeGame"),this.menu.bind(this)()}).render(70,105,"start",{color:"red"})),this.add(this.options)}menu(){G.client=null,G.changeView(-40,-40,160,160),this.el.innerHTML="",this.remOpt(),this.add(new SVGText("Offline Race").render(40,-15,"middle",{size:"1.4em"})),this.add(this.plug.render()),this.plug.set(!1),this.addOpt(new SVGText("Play",this.submenu.bind(this)).render(40,105,"middle")),this.add(this.serverInfo.render(40,-5,"middle",{size:"0.5em",color:"lightgray"})),this.add(this.options)}render(){return"wait"!=this.state?this.add(new ImpactMsg("m1","YOU",{time:"2s",persist:!1,keyf:this.anim},this.second.bind(this)).render({x:"50%",y:"50%",anchor:"middle"})):this.menu(),this.el}}class Marker{constructor(t,e){this.number=t,this.alpha=0,this.scale=22+e/30,this.scalebg=24+e/30,this.counter=createSVG("path"),this.bg=createSVG("circle"),this.numberEl=createSVG("text"),this.el=createSVG("svg")}animate(){this.alpha++,this.alpha%=360;var t=this.alpha*Math.PI/180,e=Math.sin(t)*this.scale,i=Math.cos(t)*-this.scale,s=this.alpha>=180?1:0,n=`M 0 0 v ${-this.scale} A ${this.scale} ${this.scale} 1 `+s+" 1 "+e+" "+i+" z";this.alpha<360?setTimeout(this.animate.bind(this),1e3/360*30):n=`M 0 0 v ${-this.scale} A ${this.scale} ${this.scale} 1 1 1 -.1 ${-this.scale} z`,this.counter.set([["d",n]])}render(){return this.bg.set([["cx","0"],["cy","0"],["r",this.scalebg],["fill","orange"]]),this.numberEl.set([["x",0],["y",0],["font-size","33px"],["font-weight","bold"],["font-family","arial"],["text-anchor","middle"],["dominant-baseline","central"],["fill","white"],["stroke-width","2px"],["stroke","black"]]),this.numberEl.innerHTML=this.number,this.el.appendChild(this.bg),this.el.appendChild(this.counter),this.el.appendChild(this.numberEl),this.el.set([["x","91.5%"],["y","4%"],["height",2*this.scalebg],["width",2*this.scalebg],["viewBox",`${-this.scalebg} ${-this.scalebg} ${2*this.scalebg} ${2*this.scalebg}`]]),this.animate(),this.el}}class Player{constructor(t,e,i){this.id=t,this.itsYou=e;const s={x:-1,y:1==this.id?1:4};this.path=[s],this.currentPath=[s],this.currentPos=s,e&&(document.addEventListener("keydown",t=>{13==t.keyCode?this.sendPath():46==t.keyCode&&this.clearPath()},!1),document.addEventListener("touchstart",t=>{const e=t.touches[0].clientX;let i=function(t,e){e.changedTouches[0].clientX-t>50?this.sendPath():e.changedTouches[0].clientX-t<-50&&this.clearPath(),document.removeEventListener("touchend",i,!1)}.bind(this,e);document.addEventListener("touchend",i,!1)},!1)),this.connector=new Connector(this.itsYou),this.el=createSVG("g")}add(t){this.el.appendChild(t)}render(t){this.el.innerHTML="";let e=document.createDocumentFragment();for(let i=1;i<this.path.length;i++)e.appendChild(this.line(this.path[i-1],this.path[i],t));for(let i=1;i<this.currentPath.length;i++)e.appendChild(this.line(this.currentPath[i-1],this.currentPath[i],t));return this.add(this.connector.render(this.currentPos,t)),(this.currentPath.length>2||this.path.length>1)&&(this.currentPath.length>1?this.connector.move(this.currentPath[this.currentPath.length-2],this.currentPath[this.currentPath.length-1],t):this.connector.move(this.path[this.path.length-2],this.path[this.path.length-1],t)),this.add(e),this.el}line(t,e,i){let s=document.createDocumentFragment(),n=createSVG("line");return n.set([["x1",t.x*i+i/2],["y1",t.y*i+i/2],["x2",e.x*i+i/2],["y2",e.y*i+i/2],["stroke-linecap","round"],["style",`stroke:${this.itsYou?"green":"red"};stroke-width:6;stroke-opacity:.4;`],["pointer-events","none"]]),s.appendChild(n),s}move(t){const e=this.currentPath[this.currentPath.length-2]?this.currentPath[this.currentPath.length-2]:null;if(allowMove(this.currentPos,t,e)){const e=G.board.tSize;this.add(this.line(this.currentPos,t,e)),this.connector.move(this.currentPos,t,e);const i=t.x-this.currentPos.x;return 0!=i&&this.currentPos.x*e>G.screenWidth/2+G.board.offsetX-e&&this.currentPos.x*e<G.screenWidth/2+e+G.board.offsetX&&(G.board.drawNextTiles(e,G.board.offsetX+i*e),G.board.animateBoardTo(G.board.offsetX+i*e)),this.currentPath.push(t),this.currentPos=t,!0}return!1}preValidatePath(t,e){let i=0;for(let e=1;e<t.length;e++){i+=G.board.tiles[t[e].x*G.board.nCols+t[e].y].value}return i==e}preValidateFinish(t,e,i){let s=0;for(let e=1;e<t.length;e++){s+=G.board.tiles[t[e].x*G.board.nCols+t[e].y].value}return(s+=i)==e}sendPath(){this.preValidatePath(this.currentPath,G.numberToGet)?G.client.socket.emit("path",this.currentPath):G.showMsg("sumKO","INCORRECT","red")}clearPath(){const t=this.path.length;this.currentPos=t>0?this.path[t-1]:{x:-1,y:1==this.id?1:4},this.currentPath=[this.currentPos],G.board.animateBoardTo(this.currentPos.x*G.board.tSize-G.screenWidth/2),this.render(G.board.tSize)}finish(t,e){this.currentPos.x==t-1?this.preValidateFinish(this.currentPath,G.numberToGet,e)?G.client.socket.emit("finish",this.currentPath):G.showMsg("sumKO","INCORRECT","red"):G.showMsg("sumKO","SORRY U Cant finish","red")}numberGetted(t,e){this.id==t?(this.itsYou?(this.path=this.path.concat(this.currentPath),this.currentPath=[this.currentPos],G.showMsg("sumOK","WELL DONE !!","green")):this.path=this.path.concat(e),this.render(G.board.tSize)):this.itsYou&&this.clearPath()}finishMove(t,e){const i={x:e[e.length-1].x+1,y:e[e.length-1].y};this.id==t&&(this.itsYou,this.path=this.path.concat([i]),this.render(G.board.tSize))}}class Plug{constructor(t){this.el=createSVG("g"),this.connected=t}set(t){this.connected=t,this.el.children[0].set([["fill",t?"lightgreen":"gray"]])}render(t,e,i){let s=`<rect x="2" y="2" rx="8" ry="8" width="80" height="80" fill="${this.connected?"lightgreen":"gray"}" class="b"/>\n      <path d="M 12 12 l 60 0 l 0 40 l -10 0 l 0 10 l -10 0 l 0 10 l -20 0 l 0 -10 l -10 0 l 0 -10 l -10 0 Z" class="b" fill="black"/>`;for(let t=0;t<5;t++)s+=`<line x1="${22+10*t}" y1="15" x2="${22+10*t}" y2="40" class="w"/>`;this.el.innerHTML=s;const n=i/30,h=40*n;return t&&e&&this.el.set([["transform",`translate(${t-h},${e-h}) scale(${n})`]]),this.el}}class SVGText{constructor(t,e){this.text=t,this.event=e,this.el=createSVG("text"),this.el.addEventListener("click",this.event,!1)}change(t){this.el.innerHTML=t}render(t,e,i,s,n){const h=s?`fill:${s.color};font-size:${s.size}`:"",r=(this.event?"cursor:pointer;":"")+h;return this.el.set([["x",t],["y",e],["text-anchor",i||"middle"],["style",r]]),this.el.innerHTML=this.text,this.el}}class Tile{constructor(t,e,i){this.x=t,this.y=e,this.value=parseInt(i),this.selected=!1,this.el=createSVG("g"),this.el.addEventListener(G.isTouchDevice?"touchstart":"click",this.select.bind(this))}select(){this.selected=G.board.me.move({x:this.x,y:this.y}),this.selected||(this.el.childNodes[0].set([["fill","red"]]),setTimeout(()=>this.el.childNodes[0].set([["fill","none"]]),200))}render(t){G.screenHeight;return this.tSize=t,this.el.innerHTML=`<circle cx=${this.x*t+t/2} cy=${this.y*t+t/2} r=${t/3} stroke="gray" stroke-width="1.5" fill="white" stroke-dasharray="4"/>\n                          <text x=${this.x*t+t/2} y=${this.y*t+t/2} fill="black" font-size=${G.maxH()?"26px":"6vh"} text-anchor="middle" dominant-baseline="central">\n                            ${this.value}\n                          </text>`,this.el}}