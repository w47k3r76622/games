kontra={init(t){var e=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");this.context=e.getContext("2d")},_noop:new Function,_tick:new Function},kontra.gameLoop=function(t){let e,i,n,a,r=(t=t||{}).fps||60,o=0,s=1e3/r,h=1/r,l=!1===t.clearCanvas?kontra._noop:function(){kontra.context.clearRect(0,0,kontra.canvas.width,kontra.canvas.height)};function d(){if(i=requestAnimationFrame(d),n=performance.now(),a=n-e,e=n,!(a>1e3)){for(kontra._tick(),o+=a;o>=s;)f.update(h),o-=s;l(),f.render()}}let f={update:t.update,render:t.render,isStopped:!0,start(){e=performance.now(),this.isStopped=!1,requestAnimationFrame(d)},stop(){this.isStopped=!0,cancelAnimationFrame(i)}};return f},kontra.tileEngine=function(t){function e(t){let e,i;return void 0!==t.x&&void 0!==t.y?(e=x.getRow(t.y),i=x.getCol(t.x)):(e=t.row,i=t.col),e<0||i<0||e>=o||i>=r?-1:i+e*r}function i(t){let e,i,n=0,a=x.tilesets.length-1;for(;n<=a;){if(e=(n+a)/2|0,t>=(i=x.tilesets[e]).firstGrid&&t<=i.lastGrid)return i;i.lastGrid<t?n=e+1:a=e-1}}let n,a,r=(t=t||{}).width,o=t.height,s=t.tileWidth||t.tilewidth||32,h=t.tileHeight||t.tileheight||32,l=r*s,d=o*h,f=t.context||kontra.context,c=f.canvas.width,G=f.canvas.height,u=document.createElement("canvas"),g=u.getContext("2d"),y=Math.max(0,l-c),m=Math.max(0,d-G),p=[],x={width:r,height:o,tileWidth:s,tileHeight:h,mapWidth:l,mapHeight:d,context:f,x:t.x||0,y:t.y||0,tilesets:[],layers:{},addTilesets:function(t){[].concat(t).map(function(t){let e,i,n,a,r,o=t.image;if(""+o===o){let t=1/0;for(;t>=0;){let i=(t=o.lastIndexOf("/",t))<0?o:o.substr(t);if(kontra.assets.images[i]){e=kontra.assets.images[i];break}t--}}else e=o;i=t.firstGrid,n=(e.width/s|0||1)*(e.height/h|0||1),i||(x.tilesets.length>0?(r=((a=x.tilesets[x.tilesets.length-1]).image.width/s|0)*(a.image.height/h|0),i=a.firstGrid+r):i=1),x.tilesets.push({firstGrid:i,lastGrid:i+n-1,image:e}),x.tilesets.sort(function(t,e){return t.firstGrid-e.firstGrid})})},addLayers:function(t){[].concat(t).map(function(t){let e,i,n,a,o,s;if(t.render=void 0===t.render||t.render,Array.isArray(t.data[0]))for(e=[],i=0;n=t.data[i];i++)for(a=0;a<r;a++)e.push(n[a]||0);else e=t.data;for(o in x.layers[t.name]={data:e,zIndex:t.zIndex||0,render:t.render},t.properties){s=t.properties[o];try{s=JSON.parse(s)}catch(t){}x.layers[t.name][o]=s}x.layers[t.name].render&&(p.push(t.name),p.sort(function(t,e){return x.layers[t].zIndex-x.layers[e].zIndex}))}),function(){let t,e,n,a,o,l,d,f,c;for(let G,u=0;G=x.layers[p[u]];u++)for(let u=0,y=G.data.length;u<y;u++)(t=G.data[u])&&(n=(e=i(t)).image,a=u%r*s,o=(u/r|0)*h,l=(f=t-e.firstGrid)%(c=n.width/s)*s,d=(f/c|0)*h,g.drawImage(n,l,d,s,h,a,o,s,h))}()},layerCollidesWith:function(t,i){let n,a=x.getRow(i.y),r=x.getCol(i.x),o=x.getRow(i.y+i.height),s=x.getCol(i.x+i.width);for(let i=a;i<=o;i++)for(let a=r;a<=s;a++)if(n=e({row:i,col:a}),x.layers[t].data[n])return!0;return!1},tileAtLayer:function(t,i){let n=e(i);if(n>=0)return x.layers[t].data[n]},render:function(){x.context.drawImage(u,x.sx,x.sy,c,G,x.x,x.y,c,G)},renderLayer:function(t){let n,a,l,d,f,u,g,y,m,p=x.layers[t],w=x.getRow(),I=x.getCol(),v=e({row:w,col:I}),A=I*s-x.sx,T=w*h-x.sy,M=Math.min(Math.ceil(c/s)+1,r),E=M*Math.min(Math.ceil(G/h)+1,o),S=0;for(;S<E;)(l=p.data[v])&&(f=(d=i(l)).image,n=A+S%M*s,a=T+(S/M|0)*h,y=(u=l-d.firstGrid)%(g=f.width/s)*s,m=(u/g|0)*h,x.context.drawImage(f,y,m,s,h,n,a,s,h)),++S%M==0?v=I+ ++w*r:v++},getRow:function(t){return t=t||0,(x.sy+t)/h|0},getCol:function(t){return t=t||0,(x.sx+t)/s|0},get sx(){return n},get sy(){return a},set sx(t){n=Math.min(Math.max(0,t),y)},set sy(t){a=Math.min(Math.max(0,t),m)}};x.sx=t.sx||0,x.sy=t.sy||0,u.width=l,u.height=d;for(let e in t.properties){let i=t.properties[e];try{i=JSON.parse(i)}catch(t){}x[e]=x[e]||i}return t.tilesets&&x.addTilesets(t.tilesets),t.layers&&x.addLayers(t.layers),x};var CPlayer=function(){var t,e,i,n,a,r=function(t){return Math.sin(6.283184*t)},o=function(t){return.003959503758*Math.pow(2,(t-128)/12)},s=function(t,e,i){var n,a,r,s,l,d,f,c=h[t.i[0]],G=t.i[1],u=t.i[3],g=h[t.i[4]],y=t.i[5],m=t.i[8],p=t.i[9],x=t.i[10]*t.i[10]*4,w=t.i[11]*t.i[11]*4,I=t.i[12]*t.i[12]*4,v=1/I,A=t.i[13],T=i*Math.pow(2,2-t.i[14]),M=new Int32Array(x+w+I),E=0,S=0;for(n=0,a=0;n<x+w+I;n++,a++)a>=0&&(a-=T,d=o(e+(15&(A=A>>8|(255&A)<<4))+t.i[2]-128),f=o(e+(15&A)+t.i[6]-128)*(1+8e-4*t.i[7])),r=1,n<x?r=n/x:n>=x+w&&(r-=(n-x-w)*v),s=d,u&&(s*=r*r),l=c(E+=s)*G,s=f,m&&(s*=r*r),l+=g(S+=s)*y,p&&(l+=(2*Math.random()-1)*p),M[n]=80*l*r|0;return M},h=[r,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(r){t=r,e=r.endPattern,i=0,n=r.rowLen*r.patternLen*(e+1)*2,a=new Int32Array(n)},this.generate=function(){var o,l,d,f,c,G,u,g,y,m,p,x,w,I,v=new Int32Array(n),A=t.songData[i],T=t.rowLen,M=t.patternLen,E=0,S=0,L=!1,O=[];for(d=0;d<=e;++d)for(u=A.p[d],f=0;f<M;++f){var N=u?A.c[u-1].f[f]:0;N&&(A.i[N-1]=A.c[u-1].f[f+M]||0,N<16&&(O=[]));var F=h[A.i[15]],k=A.i[16]/512,P=Math.pow(2,A.i[17]-9)/T,R=A.i[18],H=A.i[19],W=43.23529*A.i[20]*3.141592/44100,b=1-A.i[21]/255,C=1e-5*A.i[22],Y=A.i[23]/32,_=A.i[24]/512,D=6.283184*Math.pow(2,A.i[25]-9)/T,U=A.i[26]/255,B=A.i[27]*T&-2;for(p=(d*M+f)*T,c=0;c<4;++c)if(G=u?A.c[u-1].n[f+c*M]:0){O[G]||(O[G]=s(A,G,T));var K=O[G];for(l=0,o=2*p;l<K.length;l++,o+=2)v[o]+=K[l]}for(l=0;l<T;l++)(m=v[g=2*(p+l)])||L?(x=W,R&&(x*=F(P*g)*k+.5),S+=(x=1.5*Math.sin(x))*(w=b*(m-S)-(E+=x*S)),m=3==H?S:1==H?w:E,C&&(m=(m*=C)<1?m>-1?r(.25*m):-1:1,m/=C),L=(m*=Y)*m>1e-5,I=m*(1-(y=Math.sin(D*g)*_+.5)),m*=y):I=0,g>=B&&(I+=v[g-B+1]*U,m+=v[g-B]*U),v[g]=0|I,v[g+1]=0|m,a[g]+=0|I,a[g+1]+=0|m}return++i/t.numChannels},this.createWave=function(){var t=44+2*n-8,e=t-36,i=new Uint8Array(44+2*n);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var r=0,o=44;r<n;++r){var s=a[r];s=s<-32767?-32767:s>32767?32767:s,i[o++]=255&s,i[o++]=s>>8&255}return i},this.getData=function(t,e){for(var i=2*Math.floor(44100*t),n=new Array(e),r=0;r<2*e;r+=1){var o=i+r;n[r]=t>0&&o<a.length?a[o]/32768:0}return n}};const maps=[{online:Number.POSITIVE_INFINITY,offline:0,text:"COLLECT THE ARTIFACTS",data:["                    ","                    ","                    ","                    ","                    ","                    ","                    ","          a  a      ","                    ","      @             ","                    ","                    ","                    ","                    ","                    "]},{online:Number.POSITIVE_INFINITY,offline:0,text:"AVOID THE GHOSTS",data:["                    ","         @     G    ","                    ","                    ","    ==     =====    ","    =   =  =#A#=    ","    =   ====###=    ","    =          =    ","    =          =    ","    ============    ","                    ","                    ","                    ","                    ","                    "]},{online:Number.POSITIVE_INFINITY,offline:0,text:"THESE WON'T HURT YOU",data:["                    ","                    ","                    ","                    ","       ###          ","      ##A##         ","      #####         ","  ====#   #====     ","  =####   ####=     ","  =#G #   #G #=     ","  =#  #   #  #=     ","  =####   ####=     ","  ===== @ =====     ","                    ","                    "]},{online:4e3,offline:1e4,text:"UNLESS...",data:["                           ","G    G    G    G           ","                           ","                           ","                           ","###########################","                           ","                           "," @   a      a      a       ","                           ","                           ","###########################","                           ","                           "," G    G    G    G          ","                           "]},{online:4500,offline:3e3,text:"KEEP GOING",data:[" @                  ","  ###############   "," ################   ","               ##   ","               ## G ","               ##   ","               ##   ","               ##   ","               ##   ","             G ##   ","    G          ##   ","   ##############   ","   #A############   ","   ###     G        "," G                  "]},{online:5e3,offline:1600,text:"STAY WITHIN THE LINES",data:["  #  #  #  #  #  #  "," @# G#  # G#  #G #  ","#################A##","G #  #  #  # G#  # G","  #  #  #  #  #  #  ","#####A##############","  # G#  # G#  #  #  ","  #  #  #  #  #  #  ","##############A#####"," G#  #  #  # G#  # G","  #  #  #  #  #  #  ","#################A##","  #  #  #  #  #  #  ","  # G#  # G#  #  #  ","########A###########"]},{online:1e4,offline:6e3,text:"DON'T PANIC",data:["==================================","                        #########=","   @               ===  =======##=","       =====       ===            ","========#A#======  ===##====  ==  ","#######=A#A=####=  #      ##  ==  ","#  #  #=   =#  #=  =====  ==  ==  ","#G #G #=   =#G #=  =====  ==    ##","#######=   =####=  =====  ==##====","     #     ======  =====      ====","     #     #           #  ==     =","    #      #       =====  =====##=","####  G    #====  #  ===  ==     =","   #      #========    =##=     #=","=   ######==     G     #     G###=","==                     #    #####=","=================================="]},{online:5e3,offline:1500,text:"BOO!",data:["                    ","                    ","                    ","    =============   ","    =#        Ga=   ","    =#  == ====G=   ","    =#  =#A= #= =   ","    =#  =#A= #= =   ","    =#  == ==== =   ","    =# @       a=   ","    =============   ","                    ","                    ","                    ","                    "]},{online:Number.POSITIVE_INFINITY,offline:0,text:"THEY'LL ALWAYS FOLLOW",data:["               G  G  G  G G G  G G      ","              G  G G G G G  G G  G  G   ","         G  G  G  G    G  G    G G G  G ","                G  ###########A     G  G","  G    G    G  G  #############  G      ","                 G## G  G  G GG   G    G"," G  G  G  G   G   ##  G    G    G   G   ","                  ## G   G   G  G G    G","  G   G ############   G   G   G   G G  ","        #@#########  G   G G G   G      "," G  G   ###                G     G      ","            G  G   G  G  G              ","    G  G         G   G                  "," G        G  G  G                       ","     G  G                               "]},{online:15e3,offline:9e3,text:"GOOD LUCK",data:["==========  ##    ##G            ","=########= #  #    ##   #####   G","=#    G #=##   #A      ##   ##   ","=# =#   #=#     ##     #     #   ","=# =###A#=# ===  #   ###     #   ","=# =======# ===  ##  #    ===   =","=#      ## #==    ###  #   =#   =","=#####  ##== # ===     #   =#  a=","         ######        #    =   =","    #####=    #####    #    =   #","#####   =  == #   # = ##   ##   #","#  G#===    = # @ # =##   =##   #","#  =#===    = #   # ===  =##    #","#  =#===      #####  =# G=#a   G#","#  =#===#=           =#  =###   =","#  =#===#### =====  #=#   ===   =","#  =#=### # =    ############   =","#  =### ###=  #  #  #       #   ="," =### ####=  #   #   ===    #   =","##A# ####=  #   ###  =a=   ###  =","#######=   ##G   #          #   ="," G==# ########   ###############=","                           G### ="]},{online:Number.POSITIVE_INFINITY,offline:0,text:"WHOA",data:["     G G G G G G    ","  G               G ","                    ","                    ","G                   ","                   G","                    ","G        @          ","                    ","                   G","G                   ","                    ","                    ","  G              G  ","     G G G G G G    "]}];!function(){const t={songData:[{i:[3,0,128,0,2,176,128,20,0,0,0,12,33,96,2,0,61,4,1,2,109,86,7,32,112,3,67,2],p:[,,3,2,2,2,2,1,4,5,2,1,2,1,4,5,4,5,2,1,2,1],c:[{n:[106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,108,120,132,144,132,120,108,120,108,120,132,144,132,120,108,120,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106,96,108,120,132,120,108,96,108,96,108,120,132,120,108,96,108],f:[]},{n:[106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106],f:[]},{n:[106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,106,118,130,142,130,118,106,118,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106,94,106,118,130,118,106,94,106],f:[6,,,,6,,,,6,,,,6,,,,6,,,,6,,,,6,,,,6,,,,16,,,,32,,,,64,,,,96,,,,128,,,,160,,,,176,,,,192]},{n:[111,123,135,147,135,123,111,123,111,123,135,147,135,123,111,123,111,123,135,147,135,123,111,123,111,123,135,147,135,123,111,123,99,111,123,135,123,111,99,111,99,111,123,135,123,111,99,111,99,111,123,135,123,111,99,111,99,111,123,135,123,111,99,111],f:[]},{n:[111,123,135,147,135,123,111,123,111,123,135,147,135,123,111,123,113,125,137,149,137,125,113,125,113,125,137,149,137,125,113,125,99,111,123,135,123,111,99,111,99,111,123,135,123,111,99,111,101,113,125,137,125,113,101,113,101,113,125,137,125,113,101,113],f:[]}]},{i:[0,255,116,1,0,255,116,0,1,0,4,6,35,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[,,,,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c:[{n:[144,,,,144,,,,144,,,,144,,,,144,,,,144,,,,144,,,,144],f:[]}]},{i:[3,100,128,1,3,201,128,2,0,0,0,6,49,0,0,0,139,4,1,3,30,184,119,244,147,6,84,6],p:[,,,2,2,2,2,1,4,3,2,1,2,1,4,3,4,3,2,1,2,1],c:[{n:[,,94,,,,94,,,,94,,,,94,,,,96,,,,96,,,,96,,,,96],f:[]},{n:[,,94,,,,94,,,,94,,,,94,,,,94,,,,94,,,,94,,,,94],f:[]},{n:[,,99,,,,99,,,,99,,,,99,,,,101,,,,101,,,,101,,,,101],f:[]},{n:[,,99,,,,99,,,,99,,,,99,,,,99,,,,99,,,,99,,,,99],f:[]}]},{i:[2,255,128,0,3,255,128,0,0,0,5,6,58,12,4,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[3,4,2,2,2,2,2,5,6,7,2,5,2,1,6,7,6,7,2,1,2,5],c:[{n:[130,,,,138,,,,130,,,,135,,,,132,,,,140,,,,132,,,,137],f:[]},{n:[130,,,,138,,,,130,,,,135,,,,130,,,,138,,,,130,,,,135],f:[2,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,255]},{n:[130,,,,138,,,,130,,,,135,,,,130,,,,138,,,,130,,,,135],f:[2,,,,,,,,2,,,,,,,,2,,,,,,,,2,,,,,,,,,,,,,,,,32,,,,,,,,64,,,,,,,,96]},{n:[130,,,,138,,,,130,,,,135,,,,130,,,,138,,,,130,,,,135],f:[2,,,,,,,,2,,,,,,,,2,,,,,,,,2,,,,,,,,130,,,,,,,,160,,,,,,,,192,,,,,,,,224]},{n:[130,,,,138,,,,130,,,,135,,,,132,,,,140,,,,132],f:[2,,,,2,,,,2,,,,2,,,,2,,,,2,,,,2,,,,,,,,224,,,,192,,,,160,,,,128,,,,96,,,,64,,,,16]},{n:[135,,,,143,,,,135,,,,140,,,,135,,,,143,,,,135,,,,140],f:[2,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,255]},{n:[135,,,,143,,,,135,,,,140,,,,137,,,,145,,,,137,,,,142],f:[]}]},{i:[3,0,128,0,3,68,128,0,1,218,4,4,40,0,0,1,55,4,1,2,67,115,124,190,67,6,39,1],p:[,,,,,,,,1,1,1,1,,,1,1,1,1],c:[{n:[,,,,135,,,,,,,,135,,,,,,,,135,,,,,,,,135,,147],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,60,4,10,34,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],p:[,,,,,,,,1,1,1,1,,,1,1,1,1],c:[{n:[,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147],f:[]}]},{i:[0,255,106,1,0,255,106,0,1,0,5,7,164,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,,,,,1],c:[{n:[,,,,,,,,,,,,,,,,147],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,255,158,158,158,0,0,0,51,2,1,2,58,239,0,32,88,1,157,2],p:[,,,,,,,1,,,,,,1,,,,1,,,,1],c:[{n:[135],f:[]}]}],rowLen:5513,patternLen:32,endPattern:21,numChannels:8},e={songData:[{i:[3,255,128,0,0,255,140,0,0,0,2,2,23,204,4,0,96,3,1,3,94,79,0,32,84,2,12,4],p:[1],c:[{n:[147],f:[]}]}],rowLen:5513,patternLen:4,endPattern:0,numChannels:1},i={songData:[{i:[0,255,106,1,0,255,106,0,1,0,5,7,164,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[1],c:[{n:[147],f:[]}]}],rowLen:5513,patternLen:20,endPattern:0,numChannels:1},n=document.createElement("audio"),a=document.createElement("audio"),r=document.createElement("audio"),o=1.5,s=.707,h=13,l=37,d=38,f=39,c=40,G=32,u=32,g=1,y=3,m=4,p=["#FFFF00","#FF00FF","#00FFFF","#FF0000","#00FF00","#0000FF"],x=1200,w="G",I="F",v="B",A="W",T=3e3,M=5,E="images/tilesheet.png",S="THEY FOLLOW",L="Press enter";let O=!1;const N=["YOU DID IT","YOU FINISHED 'THEY FOLLOW'","A JS13KGAMES 2018 ENTRY","","AUTHORS:","TERO JÄNTTI","SAMI HEIKKINEN","","THANK YOU:","STRAKER - KONTRA LIBRARY","BITS'N'BITES - SOUNDBOX","SHREYAS MINOCHA - JS13K-BOILERPLATE","THE WHOLE JS13KGAMES COMMUNITY :)","","THANKS FOR PLAYING!",""];let F,k,P,R,H,W,b,C,Y,_,D,U={},B=M,K=0,z=[],V=0,J=0;function q(){return V===W}function $(){return K>=maps.length-1}class j{constructor(t,e){this.x=t,this.y=e}plus(t){return new j(this.x+t.x,this.y+t.y)}minus(t){return new j(this.x-t.x,this.y-t.y)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalized(){let t=this.magnitude();return 0===t?new j(0,0):new j(this.x/t,this.y/t)}static getRandomDir(){return new j(Math.floor(3*Math.random())-1,Math.floor(3*Math.random())-1).normalized()}}function X(t,e,i){return Math.min(Math.max(t,e),i)}function Q(t,e){let i={x:-R.sx+t.x,y:-R.sy+t.y,width:t.width,height:t.height};return R.layerCollidesWith(e,i)}function Z(t){return b&&Q(t,v)}function tt(t,e){return{type:"ghost",position:t,number:e,width:22,height:22,color:"red",relativeDir:j.getRandomDir(),get x(){return this.position.x},get y(){return this.position.y},update(){let t=null;if(Z(this)){this.color="yellow";let t=new j(20*(-.5+Math.random()),20*(-.5+Math.random()));this.move(t)}else{if("red"!==this.color&&(this.color="red"),this._target)1e3<performance.now()-this._targetBegin?(this._target=null,this._targetBegin=null):t=this._target.minus(this.position).normalized();else if($()&&1500<performance.now()-D){let e=J+.3*this.number,i=180+30*Math.sin(10*J);t=H.position.plus(new j(Math.cos(e)*i,Math.sin(e)*i)).minus(this.position).normalized()}else if(!H.dead){let e=this._getPlayerTarget();e&&(t=e.minus(this.position).normalized())}if(t){if(Z({x:this.x+t.x,y:this.y+t.y,width:this.width,height:this.height})){let e=new j(this.x,this.y);e.x-=5*t.x,e.y-=5*t.y;let i=function(t,e){let i=t.x+t.width/2,n=t.y+t.height/2,a=e.x+e.width/2,r=e.y+e.height/2;return new j(a-i,r-n)}(this,H),n=50;Math.abs(i.x)<Math.abs(i.y)?e.x+=Math.random()>=.5?n:-n:e.y+=Math.random()>=.5?n:-n,this._target=e,this._targetBegin=performance.now()}else this.move(t)}}},move(t){let e=new j(X(this.x+t.x,0,R.mapWidth-this.width),X(this.y+t.y,0,R.mapHeight-this.height));this.position=e},_getPlayerTarget(){let t=(e=this.position,i=H.position,e.minus(i).magnitude());var e,i;if(t>400)return null;let n=new j(H.x+H.width/2,H.y+H.height/2);return!b&&t>140&&(n.x+=130*this.relativeDir.x,n.y+=130*this.relativeDir.y),n},render(){let t=1.4*this.width,e=1.4*this.height,i=this.x-.5*(t-this.width),n=this.y-.7*(e-this.height);F.save(),F.translate(i,n),F.fillStyle=this.color,F.fillRect(0,e/2,t,e/2),F.beginPath(),F.arc(t/2,e/2,t/2,0,2*Math.PI),F.fill(),F.fillStyle="black",F.beginPath(),F.arc(.3*t,e/2,.15*t,0,2*Math.PI),F.arc(.7*t,e/2,.15*t,0,2*Math.PI),F.fill(),F.restore()}}}function et(t,e){let i=[],n=t.data;for(let t=0;t<n.length;t++){let a=n[t];for(let n=0;n<a.length;n++)a[n]===e&&i.push(new j(n*G,t*u))}return i}function it(t,e){return t.data.reduce((t,e)=>t+e).split("").map(e)}function nt(t){z=[],b=!0,C=null,Y=D=performance.now(),P=t,_=t.online,(R=kontra.tileEngine({tileWidth:G,tileHeight:u,width:t.data[0].length,height:t.data.length})).addTilesets({image:k});const e=it(t,t=>"#"===t||"A"===t?m:0);R.addLayers([{name:w,data:it(t,t=>" "===t||"G"===t||"@"===t||"a"===t?g:0)},{name:A,data:it(t,t=>"="===t?y:0),render:!0},{name:I,data:e,render:!1},{name:v,data:e,render:!1}]);let i=et(t,"@")[0];i.x+=5,H={type:"player",position:i,width:20,height:25,get x(){return this.position.x},get y(){return this.position.y},collidesWith(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},update(){let t=0,e=0;U[l]?t=-o:U[f]&&(t=o),U[d]?e=-o:U[c]&&(e=o),t&&e&&(t*=s,e*=s);let i={x:X(this.x+t,0,R.mapWidth-this.width),y:X(this.y+e,0,R.mapHeight-this.height),width:this.width,height:this.height};Q(i,A)?t&&e&&(Q(i={x:X(this.x+t,0,R.mapWidth-this.width),y:this.y,width:this.width,height:this.height},A)&&Q(i={x:this.x,y:X(this.y+e,0,R.mapHeight-this.height),width:this.width,height:this.height},A)||(this.position=new j(i.x,i.y))):this.position=new j(i.x,i.y)},render(){F.fillStyle="green";let t=1.2*this.width,e=this.height,i=this.x-(t-this.width),n=this.y-(e-this.height);F.fillRect(i,n,t,e),F.save(),F.translate(i,n),F.fillStyle="white",F.beginPath(),F.arc(.32*t,e/2,.15*t,0,2*Math.PI),F.arc(.68*t,e/2,.15*t,0,2*Math.PI),F.fill(),F.fillStyle="black",F.beginPath(),F.arc(.32*t,e/2,.05*t,0,2*Math.PI),F.arc(.68*t,e/2,.05*t,0,2*Math.PI),F.fill(),F.restore()}},z.push(H);let n=et(t,"A").concat(et(t,"a"));W=n.length,V=0,n.forEach((t,e)=>{t.x+=5,t.y+=5;let i=function(t,e){return{type:"item",position:t,color:p[e%p.length],width:20,height:20,get x(){return this.position.x},get y(){return this.position.y},update(){},render(){let t=this.width,e=this.height;F.save(),F.translate(this.x,this.y),F.fillStyle="black",F.strokeStyle=this.color,F.lineWidth=3,F.beginPath(),F.moveTo(0,e),F.lineTo(t/2,0),F.lineTo(t,e),F.closePath(),F.fill(),F.stroke(),F.restore()}}}(t,e);z.push(i)}),et(t,"G").forEach((t,e)=>{let i=tt(t,e);z.push(i)})}function at(t,e){t.fillStyle="white",t.font="20px Sans-serif",t.fillText(e,.35*kontra.canvas.width,40)}function rt(t,e){t.fillStyle="white",t.font="22px Sans-serif";let i=14*e.length;t.fillText(e,kontra.canvas.width/2-i/2,120)}function ot(){document.addEventListener("keydown",t=>{if(U[t.which]=!0,!O){nt(maps[K]),O=!0,st("main"),kontra.gameLoop({update(){for(let t=0;t<z.length;t++){let e=z[t];e.update()}!function(){for(let t=0;t<z.length;t++){let e=z[t];"ghost"!==e.type||"yellow"===e.color||!H.collidesWith(e)||H.dead||q()||(H.dead=!0,st("end"),B--),"item"===e.type&&H.collidesWith(e)&&(e.dead=!0,V++,st("eat"))}}(),function(){const t=o;H.x-R.sx<200?R.sx-=t:R.sx+kontra.canvas.width-H.x<200&&(R.sx+=t),H.y-R.sy<200?R.sy-=t:R.sy+kontra.canvas.height-H.y<200&&(R.sy+=t)}();let t=performance.now();_<t-Y&&(C=t,Y=t,_=b?P.offline:P.online),C&&x<t-C&&(b=!b,C=null),q()&&K<maps.length-1&&nt(maps[++K]),z=z.filter(t=>!t.dead),J+=.005},render(){let t=performance.now()-D;R.render(),C&&Math.random()>=.5&&R.renderLayer(I),b&&!C&&R.renderLayer(v),F.save(),F.translate(-R.sx,-R.sy);for(let t=0;t<z.length;t++){let e=z[t];e.render()}if(F.restore(),W&&at(F,`A: ${V} / ${W}             L: ${B}`),H.dead?rt(F,B>0?"TRY AGAIN (ENTER)":"GAME OVER! (ENTER)"):t<T&&P.text&&rt(F,P.text),$()&&2*T<t){let e=Math.floor((t-2*T)/T)%N.length;rt(F,N[e])}}}).start()}t.which===h&&H.dead&&(B<=0&&(K=0,B=M),nt(maps[K]),st("main"))}),document.addEventListener("keyup",t=>{U[t.which]=!1})}function st(t){switch(t){case"main":n.currentTime=0,n.volume=.9;var e=n.play();void 0!==e&&e.then(()=>{}).catch(t=>{});break;case"end":r.play();var i=n.volume,o=setInterval(function(){(i=(parseFloat(i)-.2).toFixed(1))>=0?n.volume=i:(n.pause(),clearInterval(o))},100);break;case"eat":a.play()}}function ht(t,e,i){var n=new CPlayer;n.init(e);var a=!1;setInterval(function(){if(!a&&(a=n.generate()>=1)){var e=n.createWave();t.src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),t.loop=i}},0)}kontra.init(),at(F=kontra.context,S),ht(n,t,!0),ht(a,e,!1),ht(r,i,!1),(k=document.createElement("img")).src=E,k.onload=(()=>{rt(F,L),ot()})}();