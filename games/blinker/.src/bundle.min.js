let t,i,e={};function s(t,...i){(e[t]||[]).map(t=>t(...i))}function h(){return i}function o(e){return t=document.getElementById(e)||e||document.querySelector("canvas"),i=t.getContext("2d"),i.imageSmoothingEnabled=!1,s("init"),{canvas:t,context:i}}function n(t){return t*Math.PI/180}function r(t,i){return Math.floor(Math.random()*(i-t+1))+t}function a(t,i,e){return Math.min(Math.max(t,e),i)}class c{constructor(t=0,i=0,e={}){this.x=t,this.y=i,e._c&&(this.clamp(e._a,e._b,e._d,e._e),this.x=t,this.y=i)}add(t){return new c(this.x+t.x,this.y+t.y,this)}subtract(t){return new c(this.x-t.x,this.y-t.y,this)}scale(t){return new c(this.x*t,this.y*t)}normalize(t=this.length()){return new c(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}clamp(t,i,e,s){this._c=!0,this._a=t,this._b=i,this._d=e,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?a(this._a,this._d,t):t}set y(t){this._y=this._c?a(this._b,this._e,t):t}}function l(){return new c(...arguments)}l.prototype=c.prototype,l.class=c;const d=()=>{};class u extends class{constructor(t){return this.init(t)}init(t={}){this.position=l(),this.velocity=l(),this.acceleration=l(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let i=this.acceleration;t&&(i=i.scale(t)),this.velocity=this.velocity.add(i);let e=this.velocity;t&&(e=e.scale(t)),this.position=this.position.add(e),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}_pc(){}}{init({width:t=0,height:i=0,context:e=h(),render:s=this.draw,update:o=this.advance,children:n=[],anchor:r={x:0,y:0},opacity:a=1,rotation:c=0,scaleX:l=1,scaleY:d=1,...u}={}){this.children=[],super.init({width:t,height:i,context:e,anchor:r,opacity:a,rotation:c,scaleX:l,scaleY:d,...u}),this._di=!0,this._uw(),n.map(t=>this.addChild(t)),this._rf=s,this._uf=o}update(t){this._uf(t),this.children.map(i=>i.update&&i.update(t))}render(t){let i=this.context;i.save(),(this.x||this.y)&&i.translate(this.x,this.y),this.rotation&&i.rotate(this.rotation),1==this.scaleX&&1==this.scaleY||i.scale(this.scaleX,this.scaleY);let e=-this.width*this.anchor.x,s=-this.height*this.anchor.y;(e||s)&&i.translate(e,s),this.context.globalAlpha=this.opacity,this._rf(),(e||s)&&i.translate(-e,-s);let h=this.children;t&&(h=h.filter(t)),h.map(t=>t.render&&t.render()),i.restore()}draw(){}_pc(t,i){this._uw(),this.children.map(t=>t._pc())}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:i=0,_wo:e=1,_wr:s=0,_wsx:h=1,_wsy:o=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this._wo=e*this.opacity,this._wr=s+this.rotation;let{x:n,y:r}=function(t,i){let e=Math.sin(i),s=Math.cos(i);return{x:t.x*s-t.y*e,y:t.x*e+t.y*s}}({x:this.x,y:this.y},s);this._wx=n,this._wy=r,this._wsx=h*this.scaleX,this._wsy=o*this.scaleY,this._wx=this.x*h,this._wy=this.y*o,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this._wx+=t,this._wy+=i}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,opacity:this._wo,rotation:this._wr,scaleX:this._wsx,scaleY:this._wsy}}addChild(t,{absolute:i=!1}={}){this.children.push(t),t.parent=this,t._pc=t._pc||d,t._pc()}removeChild(t){let i=this.children.indexOf(t);-1!==i&&(this.children.splice(i,1),t.parent=null,t._pc())}get opacity(){return this._opa}set opacity(t){this._opa=t,this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}setScale(t,i=t){this.scaleX=t,this.scaleY=i}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}function p(){return new u(...arguments)}p.prototype=u.prototype,p.class=u;class y extends p.class{init({...t}={}){super.init({...t})}draw(){this.color&&(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height))}}function f(){return new y(...arguments)}function x(t){let i=t.canvas;t.clearRect(0,0,i.width,i.height)}function g({fps:t=60,clearCanvas:i=!0,update:e=d,render:o,context:n=h()}={}){let r,a,c,l,u,p=0,y=1e3/t,f=1/t,g=i?x:d;function w(){if(a=requestAnimationFrame(w),c=performance.now(),l=c-r,r=c,!(l>1e3)){for(s("tick"),p+=l;p>=y;)u.update(f),p-=y;g(n),u.render()}}return u={update:e,render:o,isStopped:!0,start(){r=performance.now(),this.isStopped=!1,requestAnimationFrame(w)},stop(){this.isStopped=!0,cancelAnimationFrame(a)}},u}f.prototype=y.prototype,f.class=y;let w={},m={},v={},b={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"left",ArrowUp:"up",ArrowRight:"right",ArrowDown:"down"};function _(t){let i=b[t.code];v[i]=!0,w[i]&&w[i](t)}function M(t){let i=b[t.code];v[i]=!1,m[i]&&m[i](t)}function z(){v={}}function k(t,i,e="keydown"){const s="keydown"==e?w:m;[].concat(t).map(t=>s[t]=i)}function E(t,i="keydown"){const e="keydown"==i?w:m;[].concat(t).map(t=>e[t]=0)}function A(t){return!!v[t]}class C{constructor({create:t,maxSize:i=1024}={}){this._c=t,this.objects=[t()],this.size=0,this.maxSize=i}get(t={}){if(this.size===this.objects.length){if(this.size===this.maxSize)return;for(let t=0;t<this.size&&this.objects.length<this.maxSize;t++)this.objects.push(this._c())}let i=this.objects[this.size];return this.size++,i.init(t),i}getAliveObjects(){return this.objects.slice(0,this.size)}clear(){this.size=this.objects.length=0,this.objects.push(this._c())}update(t){let i,e=!1;for(let s=this.size;s--;)i=this.objects[s],i.update(t),i.isAlive()||(e=!0,this.size--);e&&this.objects.sort((t,i)=>i.isAlive()-t.isAlive())}render(){for(let t=this.size;t--;)this.objects[t].render()}}function S(){return new C(...arguments)}S.prototype=C.prototype,S.class=C;let[P,T,I]=["canvas","body","html"].map(t=>document.querySelector(t));const L=[0,0,0],D=P.width,V=P.height,j=D/2,O=V/2;function q(t){let i=t.style;i.position="absolute",i.height="100vh",i.width="100vw",i.margin=0,i.overflow="hidden"}function R(t,i,e){return{x:t.x+i.x*Math.cos(e),y:t.y+i.y*Math.sin(e)}}function B(){return!(A("up")||A("down")||A("left")||A("right"))}function G(t,i,e){return A("left")?t:A("right")?i:e}function Q(t,i,e){return A("up")?t:A("down")?i:e}function X(t,i){return Math.atan2(i.y-t.y,i.x-t.x)}function Y(t,i,e){return{x:(i.x-e.x)*Math.cos(t)-(i.y-e.y)*Math.sin(t)+e.x,y:(i.x-e.x)*Math.sin(t)+(i.y-e.y)*Math.cos(t)+e.y}}function F(t,i){return t.x==i.x&&t.y==i.y&&t.z==i.z}q(I),q(T),function(t){let i=t.style;i.display="flex",i.height="100 %",i.alignItems="center",i.justifyContent="center"}(T),P.style.height="100vh";const N="white";function W(t,i,e,s,h,o){t.beginPath(),t.moveTo(e,s),t.setLineDash([5,5]),t.lineWidth=5,t.strokeStyle=i,t.lineTo(h,o),t.stroke()}function K(t,i,e){t.fillStyle=i,t.beginPath();for(let i in e)t.moveTo(...e[i][0]),e[i][1].forEach(i=>t.bezierCurveTo(...i)),t.lineTo(...e[i][2]);t.fill()}function U(t,i,e,s=0,h=0,o=!1,n=!0){t.fillStyle=i,t.beginPath(),t.arc(s,h,e,0,2*Math.PI),n&&t.fill(),o&&t.stroke()}function H(t,i,e,s,h=0,o=0,n=!1,r=!0){t.beginPath(),t.rect(h,o,e,s),t.fillStyle=i,r&&t.fill(),n&&t.stroke()}function J(t,i){let e=Y(i,{x:t[0],y:t[1]},{x:0,y:0}),s=Y(i,{x:t[2],y:t[3]},{x:0,y:0}),h=Y(i,{x:t[4],y:t[5]},{x:0,y:0});return[e.x,e.y,s.x,s.y,h.x,h.y]}function Z(t,i){let e=[];for(let s=0;s<2*Math.PI;s+=i){let i=t[1].map(t=>J(t,s));e.push([t[0],i,t[2]])}return e}function $(t,i=1){return f({width:D,height:V,color:t,opacity:i})}function tt(t,i,e,s){return f({x:t,y:i,width:4*D,height:V,color:s,opacity:.2,dx:e,render:function(){let t=this.height/2,i=this.width/8,e=[[[0,0],[[i,-t,i,-t,2*i,0],[3*i,t,3*i,t,4*i,0],[5*i,-t,5*i,-t,6*i,0],[6*i,this.height,6*i,this.height,6*i,this.height],[5*i,this.height+t,5*i,this.height+t,4*i,this.height],[3*i,this.height-t,3*i,this.height-t,2*i,this.height],[i,this.height+t,i,this.height+t,0,this.height]],[0,0]]];K(this.context,this.color,e)},update:function(){this.advance(),this.x<-this.width/2&&(this.x=0)}})}let it=S({create:f}),et=t=>{let i=t.width*t.height;for(let e=0;e<r(i/500,i/100);e++)it.get({x:t.x,y:t.y,opacity:1,color:"pink",radius:5,ttl:100,dx:r(-5,5),dy:r(-5,5),update:function(){this.opacity>.02&&(this.opacity-=.02),this.advance()},render:function(){U(this.context,this.color,this.radius)}})},st=t=>{let i=l(-1*t.dx,-1*t.dy).normalize();it.get({x:t.x+15*i.x,y:t.y+15*i.y,color:["red","yellow","red"],radius:5,ttl:3,opacity:.25,render(){U(this.context,this.color[this.ttl],this.radius)}})},ht=t=>{if(Math.abs(t.dx)<.2&&Math.abs(t.dy)<.2)return;let i=l(-1*t.dx,-1*t.dy).normalize();for(let e=0;e<3;e++)it.get({x:t.x+10*i.x+r(-2,2),y:t.y+10*i.y+r(-2,2),opacity:.1,color:"silver",radius:10,ttl:50,dx:i.x+r(-1.5,1.5),dy:i.y+r(-1.5,1.5),update:function(){this.opacity>.02&&(this.opacity-=.02),this.advance()},render:function(){U(this.context,this.color,this.radius)}})},ot=t=>{let i=l(t.x,t.y),e=l(r(-300,300),r(-300,300)).normalize().scale(100),s=i.add(e),h=X(s,t),o=l(Math.cos(h),Math.sin(h)).normalize(),n=s.distance(i)/100;it.get({x:s.x,y:s.y,opacity:.1,color:"silver",radius:5,ttl:100,dx:n*o.x,dy:n*o.y,update:function(){this.opacity+=.01,this.advance()},render:function(){U(this.context,this.color,this.radius)}})},nt=t=>{let i=l(t.x,t.y),e=l(r(-3,3),r(-3,3)),s=X(i,e),h=l(i.x+100*Math.cos(s),i.y+100*Math.sin(s)),{x:o,y:n}=e.normalize().scale(h.distance(i)/100);it.get({x:i.x,y:i.y,opacity:1,color:"grey",radius:5,ttl:100,dx:o,dy:n,update:function(){this.opacity>.1&&(this.opacity-=.01),this.advance()},render:function(){U(this.context,this.color,this.radius)}})};var rt=function(){var t,i,e,s,h,o=function(t){return Math.sin(6.283184*t)},n=function(t){return.003959503758*2**((t-128)/12)},r=function(t,i,e){var s,h,o,r,c,l,d=a[t.i[0]],u=t.i[1],p=t.i[3]/32,y=a[t.i[4]],f=t.i[5],x=t.i[8]/32,g=t.i[9],w=t.i[10]*t.i[10]*4,m=t.i[11]*t.i[11]*4,v=t.i[12]*t.i[12]*4,b=1/v,_=-t.i[13]/16,M=t.i[14],z=e*2**(2-t.i[15]),k=new Int32Array(w+m+v),E=0,A=0;for(s=0,h=0;s<w+m+v;s++,h++)h>=0&&(h-=z,c=n(i+(15&(M=M>>8|(255&M)<<4))+t.i[2]-128),l=n(i+(15&M)+t.i[6]-128)*(1+8e-4*t.i[7])),o=1,s<w?o=s/w:s>=w+m&&(o=(1-(o=(s-w-m)*b))*3**(_*o)),r=d(E+=c*o**p)*u,r+=y(A+=l*o**x)*f,g&&(r+=(2*Math.random()-1)*g),k[s]=80*r*o|0;return k},a=[o,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var i=t%1*4;return i<2?i-1:3-i}];this.init=function(o){t=o,i=o.endPattern,e=0,s=o.rowLen*o.patternLen*(i+1)*2,h=new Int32Array(s)},this.generate=function(){var n,c,l,d,u,p,y,f,x,g,w,m,v,b,_=new Int32Array(s),M=t.songData[e],z=t.rowLen,k=t.patternLen,E=0,A=0,C=!1,S=[];for(l=0;l<=i;++l)for(y=M.p[l],d=0;d<k;++d){var P=y?M.c[y-1].f[d]:0;P&&(M.i[P-1]=M.c[y-1].f[d+k]||0,P<17&&(S=[]));var T=a[M.i[16]],I=M.i[17]/512,L=2**(M.i[18]-9)/z,D=M.i[19],V=M.i[20],j=43.23529*M.i[21]*3.141592/44100,O=1-M.i[22]/255,q=1e-5*M.i[23],R=M.i[24]/32,B=M.i[25]/512,G=6.283184*2**(M.i[26]-9)/z,Q=M.i[27]/255,X=M.i[28]*z&-2;for(w=(l*k+d)*z,u=0;u<4;++u)if(p=y?M.c[y-1].n[d+u*k]:0){S[p]||(S[p]=r(M,p,z));var Y=S[p];for(c=0,n=2*w;c<Y.length;c++,n+=2)_[n]+=Y[c]}for(c=0;c<z;c++)(g=_[f=2*(w+c)])||C?(m=j,D&&(m*=T(L*f)*I+.5),A+=(m=1.5*Math.sin(m))*(v=O*(g-A)-(E+=m*A)),g=3==V?A:1==V?v:E,q&&(g=(g*=q)<1?g>-1?o(.25*g):-1:1,g/=q),C=(g*=R)*g>1e-5,b=g*(1-(x=Math.sin(G*f)*B+.5)),g*=x):b=0,f>=X&&(b+=_[f-X+1]*Q,g+=_[f-X]*Q),_[f]=0|b,_[f+1]=0|g,h[f]+=0|b,h[f+1]+=0|g}return++e/t.numChannels},this.createAudioBuffer=function(t){for(var i=t.createBuffer(2,s/2,44100),e=0;e<2;e++)for(var o=i.getChannelData(e),n=e;n<s;n+=2)o[n>>1]=h[n]/65536;return i},this.createWave=function(){var t=44+2*s-8,i=t-36,e=new Uint8Array(44+2*s);e.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&i,i>>8&255,i>>16&255,i>>24&255]);for(var o=0,n=44;o<s;++o){var r=h[o];r=r<-32767?-32767:r>32767?32767:r,e[n++]=255&r,e[n++]=r>>8&255}return e},this.getData=function(t,i){for(var e=2*Math.floor(44100*t),s=new Array(i),o=0;o<2*i;o+=1){var n=e+o;s[o]=t>0&&n<h.length?h[n]/32768:0}return s}},at={songData:[{i:[0,117,92,0,3,128,123,15,0,0,19,35,29,16,58,7,0,97,0,1,2,82,118,0,40,0,0,72,2],p:[1],c:[{n:[135],f:[1]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},ct={...at,songData:[...at.songData]};ct.songData[0]={...at.songData[0],i:{...at.songData[0].i}},ct.songData[0].i[24]=20,ct.songData[0].i[27]=144,ct.songData[0].i[28]=4;class lt{constructor(t){this.player=new rt,this.player.init(t),this.interval=null,this.promise=new Promise(t=>{let i=!1,e=setInterval(()=>{if(i)return t(!0),void clearInterval(e);i=this.player.generate()>=1,i&&(this.wave=this.player.createWave(),this.audio=document.createElement("audio"),this.audio.volume=0,this.audio.src=URL.createObjectURL(new Blob([this.wave],{type:"audio/wav"})))},0)})}stop(){this.audio.pause()}play(){this.audio.pause(),this.audio.currentTime=0,this.audio.volume=.5,this.audio.play()}playBGM(){this.audio.loop=!0,clearInterval(this.interval),this.interval=setInterval(()=>{this.audio.volume+=.05,this.audio.volume>.5&&clearInterval(this.interval)},100),this.audio.play()}stopBGM(){clearInterval(this.interval),this.interval=setInterval(()=>{this.audio.volume-=.025,this.audio.volume<.1&&(this.audio.pause(),this.audio.currentTime=0,clearInterval(this.interval))},100)}}let dt={},ut={},pt={lightsaber:at,explosion:{songData:[{i:[0,219,128,0,3,0,128,0,0,89,5,6,43,19,0,0,0,0,0,1,2,70,0,0,64,0,6,16,6],p:[1],c:[{n:[99],f:[1]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},hit:{songData:[{i:[3,0,128,0,3,0,92,0,0,117,5,6,58,0,0,0,0,0,0,1,2,37,0,1,63,0,0,1,1],p:[1],c:[{n:[99],f:[1]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},rush:ct},yt={battle:{songData:[{i:[0,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[2,2,3,3,3,3,4,4,5,5,5,6,3,3,3,3,7,7],c:[{n:[],f:[1]},{n:[131,,138,,146,,143,,146,,134,,129,,138,,146,,155,,146,,134,,127,,134,,143,,151,,143,,131,,129,,136,,145,,150,,145,,133],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,3]},{n:[131,134,138,143,146,150,155,150,146,138,134,138,129,134,138,143,146,150,155,150,146,138,134,138,127,131,134,139,143,146,151,146,143,134,131,134,129,133,136,141,145,148,150,148,145,136,133,136],f:[1,,1,,,,,,,,,,1,,1,,,,,,,,,,1,,1,,,,,,,,,,1,,1,,,,,,,,,,2,,,,,,,,,,,,2,,,,,,,,,,,,2,,,,,,,,,,,,2]},{n:[143,,145,,146,,145,,146,,145,,141,,145,,146,,145,,146,,145,,139,,145,,146,,145,,146,,145,,141,,145,,150,148,146,145,138,139,141],f:[1]},{n:[143,,143,,143,,143,,143,,143,,145,,145,,145,,145,,145,,145,,146,,146,,146,,146,,146,,146,,148,,148,,148,,148,,148,,148],f:[1]},{n:[143,,143,,143,,143,,143,,143,,145,,145,,145,,145,,145,,145,,158,,158,,158,,158,,158,,158,,160,,160,,160,,160,,160,,160],f:[]},{n:[131,,,,146,,,,146,,,,129,,,,146,,,,146,,,,127,,,,143,,,,143,,,,129,,,,145,,,,145],f:[1]}]},{i:[3,255,116,79,0,255,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[11,11,11,11,12,13,14,14,14,14,14,14,12,12,12,13,11,11],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[150,,153,153,,153,153,,153,,153,,150,,153,153,,153,153,,153,,153,,150,,153,153,,153,153,,153,,153,,150,,153,153,,153,153,,153,,153],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,3]},{n:[153,153,,153,153,,153,153,,153,155,,153,153,,153,153,,153,153,,153,155,,153,153,,153,153,,153,153,,153,155,,153,153,,153,153,,153,153,,153,155],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,3]},{n:[153,153,,153,153,,153,153,,153,155,,153,153,,153,153,,153,153,,153,155,,153,153,,153,153,,153,153,,153,155,,153,,,153,153,,153,,151,,150],f:[]},{n:[150,,153,153,153,153,153,,153,153,153,153,150,,153,153,153,153,153,,153,153,153,153,150,,153,153,153,153,153,,153,153,153,153,150,,153,153,153,153,153,,153,153,153,153],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,3]}]},{i:[2,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[,,2,2,3,3,4,4,4,4,5,5,4,4,4,4],c:[{n:[],f:[]},{n:[148,,,,,,,,,,148,,148,,,,,,,,,,148,,148,,,,,,,,,,148,,148,,,,,,,,,,148],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,2]},{n:[148,,,,,,,,,,148,,148,,,,,,,,,,148,,148,,,,,,,,148,,150,,,,148,,,,150,,,,148],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,2]},{n:[131,,,,136,,136,,,,136,,131,,,,136,,136,,,,136,,131,,,,136,,136,,,,136,,131,,,,136,,136,,,,136],f:[]},{n:[131,,,,136,,136,,136,,136,,131,,,,136,,136,,136,,136,,131,,,,136,,136,,136,,136,,131,,,,136,,136,,136,,136],f:[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,2]}]}],rowLen:5513,patternLen:48,endPattern:17,numChannels:3},travel:{songData:[{i:[0,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[1,1,1,1,2,2,2,2],c:[{n:[119,,122,,124,,,,117,,122,,124,,,,115,,119,,122,,,,117,,121,,124],f:[1]},{n:[119,,121,,122,,,,117,,121,,122,,,,115,,121,,122,,,,117,,121,,122,,121],f:[]}]},{i:[0,255,116,79,0,255,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[11,11,11,11,12,12,12,12],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[140,,140,,140,140,,140,140,,140,,140,140,,140,140,,140,,140,140,,140,140,,140,,140,140,,140],f:[1]},{n:[140,,,,140,,,,140,,140,140,,140,140,,140,,,,140,,,,140,140,,140,140,,140],f:[1]}]},{i:[0,117,104,64,0,91,104,0,64,216,4,40,43,51,0,0,0,203,15,0,3,69,141,15,4,21,7,24,1],p:[11,11,11,11,11,11,11,11],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,123,,,,,,,,123,,,,,,,,123,,,,,,,,123],f:[1]}]}],rowLen:12027,patternLen:32,endPattern:7,numChannels:3}},ft=null;Object.keys(pt).forEach(t=>dt[t]=new lt(pt[t])),Object.keys(yt).forEach(t=>ut[t]=new lt(yt[t]));let xt=[Object.keys(dt).map(t=>dt[t].promise),Object.keys(ut).map(t=>ut[t].promise)].flat();function gt(t){dt[t].play()}function wt(t){ut[t].playBGM(),ft=t}function mt(t){ut[ft].stopBGM(),wt(t)}let vt=Promise.all(xt);o();class bt{constructor(t){this.timer=0,this.countdown=4e3,this.timeouts=[],this.intervals=[],this.body=t,this.cooldown=!1,this.finished=!1}cd(t){this.cooldown=!0,this.timeouts.push(setTimeout(()=>this.cooldown=!1,t))}move(t){if(B()){let i=function(t){let i=l(t.dx,t.dy);return 0===i.x&&0===i.y?l(0,-1).normalize():i.normalize()}(this.body).scale(t);if(0!==this.body.dx&&0!==this.body.dy)this.body.setVelocity(i.x,i.y);else{let i=this.body.rotation;this.body.setVelocity(t*Math.cos(i),t*Math.sin(i))}}else this.body.setVelocity(G(-t,t,0),Q(-t,t,0))}attack(t){this.cooldown||this.finished||(0===this.timer?(this.start(),this.first(t)):this.timer>150&&(this.lance(t),this.cd(1e3),this.timeouts.push(setTimeout(()=>{this.end()},1e3))))}first(t){t.tInv(500),this.cd(150);let i={x:4*-this.body.width,y:4*-this.body.height};this.move(20),new kt(i,this.body,this.body.u).add(),gt("lightsaber")}lance(t){t.tInv(500);this.move(30),new Pt(t,5*t.width,2*t.height,10).add()}start(){this.intervals.push(setInterval(()=>this.timer+=100,100)),this.timeouts.push(setTimeout(()=>this.finished=!0,this.countdown))}end(){this.intervals.forEach(t=>clearInterval(t)),this.timeouts.forEach(t=>clearTimeout(t)),this.finished=!0}}class _t extends f.class{constructor(t,i,e,s,h={x:0,y:0,z:0},o){super({x:t,y:i,width:e,height:s}),this.u=o,this.anchor={x:.5,y:.5},this.canCollide=!0,this.timeouts=[],this.intervals=[],this.vertices=this.getVertices(),this.coords=h,this.inv=!1}updateVertices(){this.vertices=this.getVertices()}getVertices(){let t=this.width/2,i=this.height/2,{x:e,y:s}=this;return[{x:e-t,y:s-i},{x:e-t,y:s+i},{x:e+t,y:s+i},{x:e+t,y:s-i}].map(t=>Y(this.rotation,t,this))}setPosition(t,i){return this.x=t,this.y=i,this}setVelocity(t,i){return this.dx=t,this.dy=i,this}setCollision(t,i){i?this.timeouts.push(setTimeout(()=>this.canCollide=t,i)):this.canCollide=t}collide(){}add(){this.u.add(this.coords,this)}tInv(t){return this.inv=!0,this.timeouts.push(setTimeout(()=>this.inv=!1,t)),this}remove(){this.timeouts.forEach(t=>clearTimeout(t)),this.intervals.forEach(t=>clearInterval(t)),this.ttl=0}}class Mt extends _t{constructor(t,i,e,s,h,o){super(t,i,25,25,h,o),this.moveSpeed=.25,this.speedLimit=5,this.baseSpeed=2,this.combo=null,this.released=!0,this.baseColor=e,this.color=e,this.name=s,this.regen=!1,this.canMove=!0}attack(){this.combo&&!this.combo.finished&&this.combo.attack(this)}canAttack=()=>A("shift")&&!this.attackCooldown&&this.released;isActive=()=>this.name===this.u.active;shouldCancel=()=>null!==this.combo&&this.combo.canceled;cancel(){this.combo=null,this.color=this.baseColor}move(){if(!this.canMove)return;this.x<0&&(this.x=this.width),this.x>D&&(this.x=D-this.width),this.y<0&&(this.y=this.height),this.y>V&&(this.y=V-this.height);let t=Q(-1,1,0),i=G(-1,1,0);0===t&&0===i||(this.rotation=Math.atan2(t,i)),Math.abs(this.dx)<this.baseSpeed&&(this.dx=this.baseSpeed*i),Math.abs(this.dy)<this.baseSpeed&&(this.dy=this.baseSpeed*t),this.ddx=this.moveSpeed*i,this.ddy=this.moveSpeed*t,Math.abs(this.dx)>this.speedLimit&&(this.dx*=.9),Math.abs(this.dy)>this.speedLimit&&(this.dy*=.9),A("up")||A("down")||(this.dy*=.95),A("left")||A("right")||(this.dx*=.95),this.advance(),B()||(st(this),ht(this))}collide(t){if(this.canCollide&&!this.inv&&this.isActive()&&this.canMove&&t instanceof Et){gt("hit");let t=this.u.getPlayers();t.forEach(t=>t.tInv(1e3));let i=l(-1*this.dx,-1*this.dy).normalize();this.setVelocity(i.x*this.width||0,i.y*this.height||-this.height),this.u.getRegen()?(t.forEach(t=>t.die()),setTimeout(()=>this.u.lose(),1500)):(this.u.switcheroo(),this.regenerate())}}regenerate(){this.regen=!0;let t=this.u.lifetime,i=setInterval(()=>{this.u.lifetime>t+100&&(this.regen=!1,clearInterval(i))},100)}travel(t){this.u.getInactive().setVelocity(0,0),this.u.getQuadrant(t).remove(this),this.coords=t,this.u.getQuadrant(t).add(this)}update(){this.isActive()&&(this.shouldCancel()&&this.cancel(),this.canAttack()?(this.combo||(this.combo=new bt(this)),this.combo.finished&&(this.combo=null),this.attack()):A("shift")||(this.released=!0),this.move(),this.vertices=this.getVertices())}draw(){H(this.context,this.inv&&this.u.lifetime%2==0?"transparent":this.color,this.width,this.height),!this.regen&&K(this.context,N,[[[0,-5],[[0,-10,-10,-15,-30,-25]],[25,-5]],[[0,30],[[0,35,-10,40,-30,50]],[25,30]],[[30,0],[[40,0,40,25,30,25]],[30,0]]])}die(){this.opacity=0,this.setVelocity(0,0),this.canMove=!1,et(this),gt("explosion")}}class zt extends _t{constructor(t,i,e){super(t.x,t.y,5,5,t.coords,e),this.radius=10,this.origin=t,this.destiny=i,this.color=N,this.ttl=10}draw(){U(this.context,this.color,this.radius)}update(){let t=(i=this,e=this.destiny,Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2))/this.ttl);var i,e;let s=X(this,this.destiny);this.setVelocity(t*Math.cos(s),t*Math.sin(s)),this.ttl-=1,this.advance()}}class kt extends _t{constructor(t,i,e){let s=n(135),{x:h,y:o}=R(i,t,i.rotation+s);super(h,o,100,5,i.coords,e),this.ttl=10,this.offset=t,this.center=i,this.rotation=i.rotation+s,this.color="green",this.opacity=.9,this.swing={should:!0,total:n(90),accumulated:0,duration:10}}damage(){return r(15,20)}update(){this.ttl-=1;let t=this.swing.total/this.swing.duration;this.rotation+=t,this.swing.accumulated+=t;let{x:i,y:e}=R(this.center,this.offset,this.rotation);this.setPosition(i,e),this.updateVertices()}}class Et extends _t{constructor(t,i,e,s,h,o=2){super(t,i,50,50,s,h),this.maxHp=e,this.hp=e,this.color="lavender",this.speed=o}draw(){var t,i,e,s;t=this.context,i=this.inv?this.u.lifetime%2==0?this.color:"transparent":this.color,e=this.width,s=this.height,K(t,i,[[[0,0],[[e/2,0,e/2,-s,e/2,-s],[e/2,0,e,0,e,0],[e,s/2,2*e,s/2,2*e,s/2],[e,s/2,e,s,e,s],[e/2,s,e/2,2*s,e/2,2*s],[e/2,s,0,s,0,s],[0,s/2,-e,s/2,-e,s/2],[0,s/2,0,0,0,0]],[0,0]]])}die(){et(this),gt("explosion"),this.remove()}collide(t){if(!this.inv&&(t instanceof kt||t instanceof Pt)){this.tInv(1e3);let i=t.damage();new At(this,i,this.u),this.hp-=i,this.hp<=0&&this.die()}}move(){this.rotation+=n(1);let t=X(this,this.u.getActive());this.setVelocity(Math.cos(t)*this.speed,Math.sin(t)*this.speed),this.advance()}update(){this.move(),this.vertices=this.getVertices()}}class At extends f.class{constructor(t,i,e){super({center:t,x:t.x,y:t.y,ttl:100,value:i,color:N,dx:r(-2,2),dy:r(-5,-3)-2,ddy:.2,u:e}),this.add()}add(){this.u.add(this.center.coords,this)}draw(){this.context.fillStyle=this.color,this.context.beginPath(),this.context.font="32px Roboto",this.context.fillText(this.value,10,50)}update(){this.opacity-=.01,this.ttl-=1,this.advance()}}class Ct extends _t{constructor(t,i,e,s,h,o,n){super(t,i,e,s,{x:0,y:0,z:0},n),this.thickness=h,this.destiny=o,this.enableTravel=!0,this.color=this.destiny?"transparent":"red",this.opacity=.7}update(){this.destiny&&this.enableTravel?this.color="transparent":this.color="red"}collide(t){if(!(t instanceof Ct)&&t instanceof Mt&&t.isActive()){let i={x:t.x,y:t.y},e=l(-1*t.dx,-1*t.dy),s=100,h={x:D-s,y:V-s};this.height>this.width?(i.x=t.x>h.x?s:h.x,t.x+=e.x):(i.y=t.y>h.y?s:h.y,t.y+=e.y),this.destiny&&this.enableTravel&&(this.u.getPlayers().forEach(t=>{t.setPosition(i.x,i.y),t.travel(this.destiny)}),this.u.travel(this.destiny))}}}class St extends _t{constructor(t,i,e,s,h){super(t,i,55,55,e,h),this.color=s,this.abs=0,this.anchor={x:0,y:0},this.enableTravel=!1}addDestiny(t){this.destiny=t}collide(t){t instanceof Mt&&(this.colliding=!0),t instanceof Mt&&A("space")&&this.enableTravel&&!t.inv&&(this.u.travel(this.destiny.coords),this.u.getPlayers().forEach(t=>{t.setPosition(this.destiny.x,this.destiny.y).tInv(1e3).travel(this.destiny.coords)}))}update(){this.abs++,this.colliding?(this.rotation+=n(-2),this.colliding=!1):this.rotation+=n(-1),this.abs>10&&(this.abs=0,"silver"===this.color?nt(this):ot(this))}draw(){var t,i;t=this.context,i=this.color,K(t,i,Z([[0,0],[[-30,0,-30,-50,0,-50],[-5,-50,-5,0,0,0]],[0,0]],n(30)))}}class Pt extends _t{constructor(t,i,e,s){super(t.x,t.y,i,e,t.coords,t.u),this.color="green",this.body=t,this.opacity=.3,this.ttl=s,gt("rush")}damage(){return r(15,20)}update(){this.setPosition(this.body.x,this.body.y),this.rotation=this.body.rotation,this.ttl-=1,this.vertices=this.getVertices()}}class Tt extends Et{constructor(t,i){super(300,300,100,t,i,2),this.width=20,this.height=20,this.color="red",this.minions=Array(16).fill("").map((t,i)=>new It(this.x,this.y,50,Math.PI/8*i,this)),this.minions.forEach(t=>t.add())}draw(){H(this.context,this.color,this.width,this.height)}die(){et(this),gt("explosion"),this.u.bossWin(),this.remove()}}class It extends Et{constructor(t,i,e,s,h){super(t,i,e,h.coords,h.u),this.enemy=h,this.angle=s,this.fixPosition()}fixPosition(){this.setPosition(this.enemy.x+100*Math.cos(this.angle+this.enemy.rotation),this.enemy.y+100*Math.sin(this.angle+this.enemy.rotation))}update(){this.enemy.hp<=0&&this.die(),this.rotation+=n(-1),this.fixPosition(),this.advance(),this.vertices=this.getVertices()}}class Lt extends _t{constructor(t,i){super(j-25,O-25,50,50,t,i),this.color=N,this.shouldAnimate=!1,this.rotation=n(1),this.rotate=1,this.scaling=1,this.grow=!0,this.anchor={x:0,y:0}}draw(){!function(t){let{width:i,height:e,context:s,color:h}=t,o=[[0,-e/2],[[i/2,-e/2,i,-e/2,i,-e],[i,0,i,0,i,0],[0,0,0,0,0]],[0,-e/2]],r=Z([[0,0],[[i,0,i,0,i,-e],[i,0,i,0,i,0]],[0,0]],n(24));K(s,"#306BAC",Z(o,n(24))),K(s,h,r)}(this)}update(){this.rotation+=n(this.rotate),this.scaleX=this.scaling,this.scaleY=this.scaling,this.shouldAnimate&&(this.rotate+=n(1),this.scaling+=this.grow?.1:-.2),this.scaleX>50&&(this.u.getPlayers().forEach(t=>t.remove()),this.grow=!1),this.scaleX<1&&(this.remove(),setTimeout(()=>this.u.showVictory(),2e3))}collide(t){t instanceof Mt&&this.u.victory()}}class Dt extends Et{constructor(t,i,e=r(10,70),s,h){super(t,i,1,s,h,0),this.width=e,this.height=e,this.color="grey"}draw(){H(this.context,this.color,this.width,this.height)}update(){this.rotation+=n(.5),this.getVertices()}}class Vt extends Et{constructor(t,i){super(j-50,O-50,150,t,i,4),this.width=75,this.height=75,this.color="pink",this.f=0}draw(){!function(t){let{width:i,height:e,color:s,context:h,inv:o,u:n}=t,r=e+e/2,a=[[[0,-e/4],[[0,-e/2,-i/2,-e,-i,-e],[2*i,-e,2*i,-e,2*i,-e],[i+i/2,-e,i,-e/2,i,-e/4]],[0,-e/4]],[[0,e+e/4],[[0,r,-i/2,2*e,-i,2*e],[2*i,2*e,2*i,2*e,2*i,2*e],[i+i/2,2*e,i,r,i,e+e/4]],[0,e+e/4]]];H(h,o&&n.lifetime%2==0?"transparent":s,i,e),K(h,N,a)}(this)}die(){et(this),gt("explosion"),this.u.showGoal(),this.remove()}load(t,i){new jt(this,this.u.getActive(),t,i).add(),gt("hit")}fire(){this.u.lifetime%25==0&&(this.f++,this.f<5?this.load(5,10):5==this.f?this.load(10,10):10==this.f?(this.load(10,75),setTimeout(()=>this.load(10,75),150),setTimeout(()=>this.load(10,75),300)):this.f>15&&(this.f=0))}update(){this.fire(),this.move(),this.rotation=X(this,this.u.getActive()),this.vertices=this.getVertices()}}class jt extends Et{constructor(t,i,e,s){super(t.x,t.y,s,t.coords,t.u),this.width=s,this.destiny={...i},this.height=s,this.color="orange",this.timestamp=this.u.lifetime,this.theta=X(t,i),this.setVelocity(e*Math.cos(this.theta),e*Math.sin(this.theta))}draw(){H(this.context,this.color,this.width,this.height)}die(){this.remove()}update(){this.vertices=this.getVertices(),this.rotation+=n(15),this.advance(),this.u.lifetime>this.timestamp+300&&this.die()}}class Ot{constructor(t,i,e){this.x=t,this.y=i,this.z=e}}class qt{constructor(t,i,e,s){this.coords=new Ot(t,i,e),this.bodies=[],this.t=5,this.u=s,this.frame=this.setFrame(),this.frame.forEach(t=>this.add(t)),this.cleared=!1}close(){this.frame.forEach(t=>t.enableTravel=!1)}open(){this.frame.forEach(t=>t.enableTravel=!0)}add(t){this.bodies.push(t)}remove(t){for(let i=0;i<this.bodies.length;i++)this.bodies[i]===t&&this.bodies.splice(i,1)}clear(){for(let t=0;t<this.bodies.length;t++)(this.bodies[t]instanceof kt||this.bodies[t]instanceof Pt)&&this.bodies.splice(t,1)}setFrame(){let[t,i,e]=[D,V,this.t],[s,h,o,n]=(()=>{let{x:t,y:i,z:e}=this.coords;return[i-1>=0?new Ot(t,i-1,e):null,t-1>=0?new Ot(t-1,i,e):null,i+1<5?new Ot(t,i+1,e):null,t+1<5?new Ot(t+1,i,e):null]})(this.coords);return[new Ct(t/2,e/2,t,e,e,s,this.u),new Ct(e/2,e+i/2,e,i,e,h,this.u),new Ct(t-e/2,i/2+e,e,i,e,n,this.u),new Ct(t/2,i-e/2,t,e,e,o,this.u)]}}class Rt{constructor(t,i,e,s){this.quadrants=[];for(let h=0;h<t;h++){let t=[];for(let o=0;o<i;o++)t.push(new qt(h,o,e,s));this.quadrants.push(t)}}}const{context:Bt}=o();let Gt=t=>{let[i,e,s,h]=[D,V,100,200],o=[[[h,s],[[i-h,s,i-h,s,i-h,s],[i-s,s,i-s,s,i-s,h],[i-s,e-h,i-s,e-h,i-s,e-h],[i-s,e-s,i-s,e-s,i-h,e-s],[h,e-s,h,e-s,h,e-s],[s,e-s,s,e-s,s,e-h],[s,h,s,h,s,h],[s,s,s,s,h,s]],[h,s]]];return f({bar:0,opacity:.15,transparent:!0,lifetime:0,baseColor:t,shapes:o,update:function(){if(this.lifetime++,this.transparent=!this.transparent,this.lifetime<200)return this.color=this.transparent?"transparent":this.baseColor;this.movement+=.01,this.bar>=.9&&(this.lifetime=0,this.bar=0),this.transparent?this.color="transparent":(this.color=Bt.createLinearGradient(0,0,D,V),this.color.addColorStop(0+this.bar,this.baseColor),this.color.addColorStop(.05+this.bar,"transparent"),this.color.addColorStop(.1+this.bar,this.baseColor))},render:function(){K(this.context,this.color,o)}})},Qt=()=>{let[t,i,e,s,h]=[D,V,100,200,400],o=[[[0,0],[[t,0,t,0,t,0],[t,i,t,i,t,i],[t-s,i-e,t-s,i-e,t-s,i-e],[t-e,i-e,t-e,i-e,t-e,i-s],[t-s,e,t-s,e,t-h,e],[h,e,h,e,h,e],[s,e,s,e,e,i-s],[e,i-e,e,i-e,s,i-e],[t-s,i-e,t-s,i-e,t-s,i-e],[t,i,t,i,t,i],[0,i,0,i,0,i]],[0,0]]];return f({render:function(){K(this.context,"black",o)}})},Xt=(t,i,e,s)=>new Yt({color:N,opacity:.6,render:function(){!function(t,i,e,s,h=0,o=0,n=!1){t.font=s+"px Arial Black",t.setLineDash([15,3]),t.lineWidth=s/10,t.strokeStyle=i,t.fillStyle=i,t.textAlign="center",t.strokeText(e,h,o),n&&t.fillText(e,h,o)}(this.context,this.color,t,s,i,e,!0)}});class Yt extends f.class{constructor(t){super(t),this.baseColor=this.color,this.flicker=r(50,250),this.lifetime=0}toggle(){this.color=this.color==this.baseColor?"transparent":this.baseColor}update(){this.lifetime++,this.lifetime>500&&this.toggle(),this.lifetime>=500+this.flicker&&(this.lifetime=0,this.flicker=r(50,250),this.color=this.baseColor)}}let Ft=()=>f({children:[Gt("red"),Xt("FATAL ERROR",j,O,50),Xt("PRESS ENTER TO TRY AGAIN",j,O+200,35),Qt()]}),Nt=()=>f({children:[$("darkgrey"),Gt("blue"),Xt("WELCOME HOME",j,O,50),Xt("THANKS FOR KEEPING ME ALIVE",j,O+200,30),Qt()]});function Wt(t,i){function e(t){let i=[];for(let e=0;e<t.length;e++){let s=l(t[e].x,t[e].y),h=e+1===t.length?0:e+1,o=l(t[h].x,t[h].y),n=s.subtract(o),r={x:n.y,y:-n.x};i.push(r)}return i}function s(t,i){let e=l(t.x,t.y),s=e.dot(i[0]),h=s;for(let t=1;t<i.length;t++){let o=e.dot(i[t]);o<s?s=o:o>h&&(h=o)}return{min:s,max:h,overlap:function(t){return!(s>t.max||t.min>h)}}}let h=e(t.vertices),o=e(i.vertices);for(let e=0;e<h.length;e++){let o=h[e],n=s(o,t.vertices),r=s(o,i.vertices);if(!n.overlap(r))return!1}for(let e=0;e<o.length;e++){let h=o[e],n=s(h,t.vertices),r=s(h,i.vertices);if(!n.overlap(r))return!1}return!0}function Kt(){return Ht.isPaused}vt.then(()=>{ii.stop(),$t.start(),b.ControlLeft="ctrl",b.ShiftLeft="shift",b.Escape="esc",b.Enter="enter",k("enter",(function(){Jt.countdown(),wt("travel")})),k("ctrl",(function(){Ht.switcherooOnCooldown||(Ht.switcherooOnCooldown=!0,Ht.switcheroo(),setTimeout(()=>Ht.switcherooOnCooldown=!1,500))}))}),function(){let t;for(t=0;t<26;t++)b[t+65]=b["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)b[48+t]=b["Digit"+t]=""+t;window.addEventListener("keydown",_),window.addEventListener("keyup",M),window.addEventListener("blur",z)}();class Ut extends f.class{constructor(t,i,e){super(),this.size={x:t,y:i,z:e},this.depths=this.createDepths(t,i,e),this.coords=new Ot(...L),this.q=this.getQuadrant(this.coords),this.stairMap={},this.width=D,this.height=V,this.exploredMaps=new Set,this.active="player",this.makeStairs(),this.makeEnemies(),this.makeBosses(),this.makeGoal(),this.travel(this.coords),this.player=new Mt(400,200,"goldenrod","player",this.coords,this),this.shadow=new Mt(375,500,"purple","shadow",this.coords,this),this.switcherooOnCooldown=!1,this.playerMap={shadow:this.shadow,player:this.player},this.lifetime=0,this.isPaused=!0}getRegen(){return this.getActive().regen||this.getInactive().regen}victory(){E(["ctrl","shift","esc","enter","left","up","down","right"]),this.getPlayers().forEach(t=>t.canMove=!1),this.q.goal.shouldAnimate=!0}showVictory(){Jt.win()}lose(){Jt.lose()}restart(){let t=this.stairMap[this.coords.z].up;this.getPlayers().forEach(i=>{i.travel(t.coords),i.setPosition(t.x,t.y),i.canMove=!0,i.regen=!1,i.opacity=1}),this.travel(t.coords)}makeGoal(){let{coords:t}=this.stairMap[this.size.z-1].down,i=new Lt(t,this);this.getQuadrant(t).goal=i;let e=new Vt(t,this);this.getQuadrant(t).add(e)}makeStairs(){for(let t=0;t<this.depths.length;t++){let i=Array(this.size.x).fill("").map((t,i)=>i).map((t,i)=>Array(this.size.y).fill("").map((i,e)=>[t,e])).flat(),[e,s]=i.splice(r(0,i.length-1),1).flat(),[h,o]=i.splice(r(0,i.length-1),1).flat();0==t&&([e,s]=[0,0]);let n=this.getQuadrant(new Ot(e,s,t)),a=this.getQuadrant(new Ot(h,o,t)),c=new St(r(100,this.width-100),r(100,this.height-100),n.coords,"silver",this),l=new St(r(100,this.width-100),r(100,this.height-100),a.coords,"brown",this);c.enableTravel=!0,l.opacity=0,a.close(),0!==t&&n.add(c),t<this.size.z-1&&a.add(l),this.stairMap[t]={up:c,down:l}}for(let t=0;t<Object.keys(this.stairMap).length;t++)0!==t&&this.stairMap[t].up.addDestiny(this.stairMap[t-1].down),t!==this.size.z-1&&this.stairMap[t].down.addDestiny(this.stairMap[t+1].up)}makeEnemies(){this.depths.map(t=>t.quadrants).flat().flat().forEach(t=>{let{up:i,down:e}=this.stairMap[t.coords.z];if(!(F(t.coords,new Ot(0,0,0))||F(t.coords,i.coords)||F(t.coords,e.coords))){for(let i=0;i<r(0,4);i++)t.add(new Et(r(100,D-100),r(100,V-100),r(25,50),t.coords,this,2+t.coords.z));for(let i=0;i<r(5,10+5*t.coords.z);i++)t.add(new Dt(r(100,D-100),r(100,V-100),r(25,50),t.coords,this))}})}makeBosses(){for(let t=0;t<this.size.z-1;t++){let{coords:i}=this.stairMap[t].down;new Tt(i,this).add()}}createDepths(t,i,e){let s=[];for(let h=0;h<e;h++)s.push(new Rt(t,i,h,this));return s}add(t,i){this.getQuadrant(t).add(i)}getQuadrant(t){let{x:i,y:e,z:s}=t;return this.depths[s].quadrants[i][e]}getCurrentQuadrant(){return this.getQuadrant(this.coords)}getPlayers(){return Object.values(this.playerMap)}getActive(){return this.playerMap[this.active]}getInactive(){return this.playerMap[this.toggleShadow(this.active)]}travel(t){it.clear(),this.q.clear(),this.coords=t,this.exploredMaps.add(t),this.q=this.getQuadrant(t),this.checkBoss()&&mt("battle")}checkBoss(){return F(this.coords,this.stairMap[this.coords.z].down.coords)&&!this.q.cleared}bossWin(){mt("travel"),this.q.open(),this.stairMap[this.coords.z].down.opacity=1,this.stairMap[this.coords.z].down.enableTravel=!0,this.q.cleared=!0}showGoal(){mt("travel"),this.q.add(this.q.goal)}render(){this.q.bodies.forEach(t=>{t.render()})}update(){this.lifetime++;let t=this.q.bodies;for(let i=t.length-1;i>=0;i--)for(let e=i-1;e>=0;e--)if(t[i].canCollide&&t[e].canCollide){Wt(t[i],t[e])&&(t[e].collide(t[i]),t[i].collide(t[e]))}for(let i=t.length-1;i>=0;i--)t[i].isAlive()?t[i].update():t.splice(i,1)}toggleShadow(t){return"player"===t?"shadow":"player"}switcheroo(){if(this.getRegen())return;new zt(this.getActive(),this.getInactive(),this).add(),this.active=this.toggleShadow(this.active),this.getActive().tInv(300)}}let Ht=new Ut(5,5,3),Jt=(Zt=Ht,{disableAll(){Object.keys(this.elements).forEach(t=>this.toggle(t,!1))},toggle(t,i){if(void 0!==i)return this.elements[t].show=i;this.elements[t].show=!this.elements[t].show},lose:function(){E("esc"),this.disableAll(),this.toggle("lose",!0),Zt.isPaused=!0,k("enter",()=>{E("enter"),Zt.restart(),this.toggle("lose",!1),this.start()})},win:function(){E("esc"),this.disableAll(),this.toggle("victory",!0),Zt.isPaused=!0},countdown:function(){E("enter"),this.toggle("title"),this.toggle("subtitle"),setTimeout(()=>this.elements.blackout.sprite.isStarting=!0,500),setTimeout(()=>this.elements.holopad.show=!1,2500),setTimeout(()=>this.start(),3500)},start:function(){["map","mapGrid","darken","blackout","holopad"].forEach(t=>this.toggle(t)),Zt.isPaused=!1,k("esc",()=>{Zt.isPaused=!Zt.isPaused})},elements:{blackout:{show:!0,sprite:function(){let t=$("black");return t.isStarting=!1,t.update=function(){t.isStarting&&t.opacity>.1&&(t.opacity-=.0125)},t}()},title:{show:!0,sprite:Xt("BLINKER",j,O,50)},subtitle:{show:!0,sprite:Xt("PRESS ENTER TO BEGIN",j,O+250,35)},darken:{show:!1,sprite:$("black",.5)},victory:{show:!1,sprite:Nt()},lose:{show:!1,sprite:Ft()},holopad:{show:!0,sprite:Gt("green")},frame:{show:!0,sprite:Qt()},mapGrid:{show:!1,sprite:new Yt({x:j-75*Zt.size.x/2,y:200,opacity:.5,color:N,render:function(){let[t,i,e,s]=[50,50,12.5,25],h=Zt.size.x*t+(Zt.size.x-1)*s+s,o=Zt.size.y*i+(Zt.size.y-1)*s+s;for(let i=0;i<=Zt.size.y;i++){let o={x:-e,y:(t+s)*i-e},n={x:h-e,y:(t+s)*i-e};W(this.context,this.color,o.x,o.y,n.x,n.y)}for(let i=0;i<=Zt.size.x;i++){let h={x:(t+s)*i-e,y:-e},n={x:(t+s)*i-e,y:o-e};W(this.context,this.color,h.x,h.y,n.x,n.y)}}})},map:{show:!1,sprite:f({x:j-75*Zt.size.x/2,y:200,render:function(){let[t,i,e]=[50,50,25],{up:s,down:h}=Zt.stairMap[Zt.coords.z];for(let o of Zt.exploredMaps)if(o.z===Zt.coords.z){let n=h&&F(h.coords,o),r=s&&F(s.coords,o),a=F(o,Zt.coords),c=n?"yellow":r?"orange":"blue",l=o.x*(e+t),d=o.y*(e+i);H(this.context,c,t,i,l,d),a&&U(this.context,N,5,l+t/2,d+i/2)}}})}},render:function(){Object.keys(this.elements).forEach(t=>{this.elements[t].show&&this.elements[t].sprite.render()})},update:function(){Object.keys(this.elements).forEach(t=>this.elements[t].sprite.update())}});var Zt;Ht.player.add(),Ht.shadow.add();const $t=g({update:()=>{si.update(),!Kt()&&it.update(),!Kt()&&Ht.update(),Kt()&&Jt.update()},render:()=>{si.render(),!Kt()&&it.render(),!Kt()&&Ht.render(),Kt()&&Jt.render()}});let ti=f({children:[tt(0,0,2,"purple"),$("black",.5)]});const ii=g({render:()=>{ti.render()},update:()=>{ti.update()}});let ei=$("blue",.25);ei.update=function(){switch(Ht.coords.z){case 1:return this.color="blue";case 2:return this.color="purple";case 3:return this.color="red";default:return this.color="transparent"}};const si=f({id:"background",children:[$("black"),tt(-1300,-500,-1,"darkred"),tt(-200,500,-2.5,"darkblue"),tt(-1e3,800,-2,"gray"),tt(0,0,-.5,"purple"),ei]});ii.start()
