<!DOCTYPE html>
<html><head><style>
html{background-color:#000;cursor:none}
body{margin:0;overflow:hidden}
canvas{image-rendering:pixelated;width:100vw;height:100vh;object-fit:contain}
img{display:none}
song{display:none}
stage{display:none}
</style>
<img src="data:image/png;base64,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"/>
<song name="sm">
H)bD(GD'?,GQ'Z(SD,NJ'M)_D(GD'[(SE,NN'M(GD,GX'M(SF'L,NI'?(SF'L)bX(GH'[)dM(SD'M,GZ)bK(GI'[(SD,NG'M)_G(GN'\,NM(SF'L)^Z,GZ'?(GG'K(SG'M)_y'?,NI(SE'M(GP'[(SD'M)aP(BJ,B['Z(ND'?,IJ'L(BK'?)aM'[(ND,IP'M)a[(BG,BX'M(NE'L(NF)_N,IJ'M(BD'[)^~(NG'M(BI,B['[(ND,IH'M(BD'\(ND,IP'L(BD,G\'L(NE'N(ND,FN'L(BF,CZ'[,BM'?(NE'L)af(@L,@k'\(LE'M)^L(@K,Co'L)aM'M)^U(LD'M)[O(@E,Fk'L(LD)XO'M)[P(LD'M)^T(@D,Ii'M)aN'L)dO(LF'M)b~(CH,J~'[(OG'M(CI'[(OI'M,C~)_~(CH'M(OD'M(OL'L(CJ'\(OL'L)^T(BH,Bi'\(NE'M)^S(BH,Fj'[(ND'M)^[(BI,Il'L(NC'M(ND)_O'M(BD,Nl'[)a~(NL'M(BJ,Rh'[(NF'M(BH'[)ZN(NJ,BT'M)\m(BH,Dl'M(NC'M(NG'L)^o(BM,Fi'\(NE'L)_L(GJ,GZ'\(SD,NJ'L)ZM(GD'\,NQ(SD'M(GE,G['L(SD'M(SD,NJ'M)_O(GF'[)aR(SE'M)_L(GI,GV'[(SD,NJ'M(GF)ZN'[(SD,NM'M)YZ(GF,GZ'L(SE'M)Ze(SD,NM'M(GE'\(SD'L)YT(BH,BY'\)ZP(NJ,IK'L(BD'T(NG'E)YQ'?,IN'L)ZO'?,BZ(BH'L(NF'M,IJ(NH'L)YX'?(BH'[)Z~(NH'L,BX'?(BG'[,IJ(NI'M(BF'[(NE,IQ'M(BE,GY'M(NF'L(ND,FL'M(BG,CZ'\(ND,BM'L,@k)ZX(@I'[)[U'?(LH'L,Cn)^J(@H'[(LD'?)ZT'L(@J,Fj)[['M(LF'M(LF)aD'L(@J,Ij'?)ZM'[(LE)[L'L(@K,Lq'?)dW'[(LG)ZS'L(@H'?)[G,Ol'[)gO(LF'M)Z^(@J,Rn'M(LF'L(LI)[L'M)f`(@J,Uh'[)dN(LE'M)a](BJ,Bp'\)bO(NH'L)gR(BG,Fi'[(ND'?)aD'L(BH)bY,Im'M(NF'M(ND)gM'L(BH)a]'?,Nk'[(NF)bP'M)f~(BH,Rm'[(NG'M(BH,Um'[(NF'M(BI,Zj'M(NF'M(NF'L(BF'Z(NF'O
</song><song name="taf">
H(aD'A(bD'A(eG'B(fF(ZH'X(gL'L(fK'X(eO'L(fX'Y(ZO'K(af'f(bg(Zg'f(^h'f(_I(SX'X(GQ(GQ'~'~'Q
</song><song name="tts">
H*E^*[]'W*LX*ZW'W*QV*Ur'W*ST'W*QS*VV'W*LW*UW'W*EZ*Vn'W*LV'W*QW*Us'W*SV'W*QS*Vn'W*LV'W*Cc*S~'W*JX'W*O['W*QZ'W*S['W*UW'W*E]*Vr'W*LX'W*QV*Uu'W*SX'W*QW*Vq'W*LX'W*Gb*Sn'W*NZ'W*SW'W*Uc'W*V['W*Z\'W*^~'~'b*ZW'W*XY'W*EZ*Z~'W*LZ'W*QX'W*S^'W*UY'W*VX'W*X~'~'b*VZ'W*UV'W*C[*S~'W*J['W*O]'W*QY'W*SZ'W*UX'W*Eb*Vq'W*LW'W*QW*Ur'W*SW'W*QW*Vn'W*LX'W*G]*Sm'W*NX'W*SX'W*G['W*NU'W*SV'W*GW'W*NU'W*ST'W*GX'W*NS'W*SQ'W
</song><stage>hJQeoUOEwAg?EwoYOCwAQTQwTYIIwTUEEwbcEE</stage>
<stage>hZJehFQEwAi?DwhJQCw1JLCwAJQCwfACZwUJLCwAXHCwLXUCwhXGCwrXVClQHQlHVNlnVNlxHQ</stage>
<stage>hHgeAFIEpIII0gp1HKg0wAg?EwAJICwsHIE</stage>
<stage>hLgeqRIEpHIIgMp3BIg0wAg?EwAAGSwAbGFwASCJwQJEXwqVICwoACX</stage>
<stage>hGgeyPIEplYI0gwAg?EwyTICwSHHZwkAHVlOHZ</stage>
<stage>hEHe0DMEwAg?Ew0HMZwUHEZwAHIZwMAEZwsAEZwcAEZwkHEZlwHZlIHZlQHZlYHZlgHZloHZ</stage>
<stage>hEgeycOEpPZGvgpYKGMgpVPG5gpSUGCgwAg?EwuHEZlIHZ</stage>
<stage>hDIeuESEpSUI0gwAi?CwuISCwWIUCw2KKKwAKKKweAEKwAISClqIIlSII</stage>
<stage>h3JeGKIEpzVI5gwYSGDwAi?CwxJLMwcAHLwGOICl8JZ</stage>
<stage>hGgeAHIEp5LGg0w0gMEwAgMEwbgMEwwLICwALICwQLICwgLIC</stage>
<stage>hGie0DIEp0KG2gwAi?CwyACJwySOQw0HIClMAi</stage>
<stage>hIieyFIEpEGIg0pERIg+wAi?CwOWQEwyJICwAACiwOHdEleWM</stage>
<stage>h2geyDIEwAg?Ew0JEQwyHICwoJEQweMENwUPEKwKSEHwAZEH</stage>
<script>
const KMap={ArrowLeft:1,KeyA:1,ArrowRight:2,KeyD:2,ArrowUp:4,KeyW:4,ArrowDown:8,KeyS:8,Space:16,KeyZ:16,Comma:32,KeyX:32,Enter:64,};class Input{constructor(){this.state=0;this.gp=[];this.kh={};this.kl=evt=>this.onKey(evt);window.addEventListener("keydown",this.kl);window.addEventListener("keyup",this.kl);}end(){if(this.kl){window.removeEventListener("keydown",this.kl);window.removeEventListener("keyup",this.kl);this.kl=null;}this.gp=[];this.state=0;}update(){this.ugp();return this.state;}onKey(e){if(e.repeat){if(KMap[e.code]){e.stopPropagation();e.preventDefault();}return;}if(e.ctrlKey||e.altKey)return;e.stopPropagation();e.preventDefault();const value=e.type==="keydown";const bi=KMap[e.code];if(bi)return this.setState(bi,value);if(!value)return;this.kh[e.code]?.();}ugp(){for(const src of navigator?.getGamepads?.()||[]){if(!src)continue;let gamepad=this.gp[src.index];if(!gamepad){gamepad=this.gp[src.index]={axes:src.axes.map(v=>0),buttons:src.buttons.map(v=>0),state:0,};}const thr=0.25;const cka=(ix,idl,idh)=>{const nv=(src.axes[ix]>thr)?1:(src.axes[ix]<-thr)?-1:0;if(nv===gamepad.axes[ix])return;if(gamepad.axes[ix]<0)this.setState(idl,0,gamepad);else if(gamepad.axes[ix]>0)this.setState(idh,0,gamepad);gamepad.axes[ix]=nv;if(gamepad.axes[ix]<0)this.setState(idl,1,gamepad);else if(gamepad.axes[ix]>0)this.setState(idh,1,gamepad);};cka(0,1,2);cka(1,4,8);const ckb=(ix,id)=>{if(src.buttons[ix].value){if(gamepad.buttons[ix])return;gamepad.buttons[ix]=1;this.setState(id,1,gamepad);}else{if(!gamepad.buttons[ix])return;gamepad.buttons[ix]=0;this.setState(id,0,gamepad);}};ckb(0,16);ckb(1,32);ckb(2,32);ckb(8,64);ckb(9,64);ckb(12,4);ckb(13,8);ckb(14,1);ckb(15,2);}}setState(btnid,value,gamepad){if(gamepad){if(value){if(gamepad.state&btnid)return;gamepad.state|=btnid;}else{if(!(gamepad.state&btnid))return;gamepad.state&=~btnid;}}if(value){if(this.state&btnid)return;this.state|=btnid;}else{if(!(this.state&btnid))return;this.state&=~btnid;}}}
class Video{constructor(){this.src=document.querySelector("img");this.cv=document.querySelector("canvas");this.cv.width=256;this.cv.height=144;this.c=this.cv.getContext("2d");this.bcv=document.createElement("CANVAS");this.bcv.width=256;this.bcv.height=144;this.bc=this.bcv.getContext("2d");}end(){this.c.fillStyle="#888";this.c.fillRect(0,0,256,144);}bg(){this.c.drawImage(this.bcv,0,0);}rect(x,y,w,h,c){this.c.fillStyle=c;this.c.fillRect(x,y,w,h);}blit(dx,dy,sx,sy,w,h){this.c.drawImage(this.src,sx,sy,w,h,dx,dy,w,h);}flop(dx,dy,sx,sy,w,h){this.c.save();this.c.translate(dx+w/2,dy+h/2);this.c.scale(-1,1);this.c.drawImage(this.src,sx,sy,w,h,-w/2,-h/2,w,h);this.c.restore();}decint(x,y,v,dc){v=Math.floor(v);let p=10**dc;let started=0;for(;p>=1;p/=10,x+=4){const digit=Math.floor(v/p)%10;if(!digit&&!started&&(p>1))continue;started=1;this.blit(x,y,88+3*digit,15,3,5);}}bblit(dx,dy,sx,sy,w,h){this.bc.drawImage(this.src,sx,sy,w,h,dx,dy,w,h);}bflop(dx,dy,sx,sy,w,h){this.bc.save();this.bc.translate(dx+w/2,dy+h/2);this.bc.scale(-1,1);this.bc.drawImage(this.src,sx,sy,w,h,-w/2,-h/2,w,h);this.bc.restore();}}
const insv=[[0.01,0.11,0.02,0.04,0.3,0.5,"0963"],[0.01,0.08,0.025,0.05,0.5,[1,1,0,0.5,0,0.3,0,0.2,0,0.1]],[0.04,0.11,0.03,0.05,0.8,[1,1,0.5,0.3,0.2,0.05]],[0.01,0.11,0.02,0.05,0.9,7.6,"9990"],[0.025,0.11,0.04,0.06,0.5,[1,1,0,0.2,0,0.07]],[0.015,0.11,0.025,0.03,0.9,2,"0972"],];const sndv=[[0.7,"sine",300,1000],[0.2,"sawtooth",100],];class Audio{constructor(){if(!AudioContext)return;this.hz=[];for(let n=0;n<128;n++){this.hz.push(440*Math.pow(2,(n-69)/12));}this.ctx=new AudioContext({sampleRate:44100,latencyHint:"interactive",});if(this.ctx.state==="suspended"){this.ctx.resume();}this.songs={};this.songTempo=1;this.song=0;this.songp=0;this.songDelay=0;this.vv=[];this.ldc();}end(){if(this.ctx){this.ctx.suspend();this.ctx=null;}}snd(id){if(!this.ctx)return;const s=sndv[id];if(!s)return;const t0=this.ctx.currentTime;const ta=t0+0.015;const td=ta+0.02;const ts=td+0.2;const tr=ts+0.5;const opt={frequency:s[2]};if(typeof(s[1])==="string")opt.type=s[1];else opt.periodicWave=new PeriodicWave(this.ctx,{real:s[1]});const osc=new OscillatorNode(this.ctx,opt);if(s.length>3){const stept=(tr-t0)/(s.length-3);let t=t0,i=3;osc.frequency.setValueAtTime(s[2],t0);for(;i<s.length;i++){t+=stept;osc.frequency.linearRampToValueAtTime(s[i],t);}}const env=new GainNode(this.ctx);env.gain.setValueAtTime(0,0);env.gain.setValueAtTime(0,t0);env.gain.linearRampToValueAtTime(0.3*s[0],ta);env.gain.linearRampToValueAtTime(0.1*s[0],td);env.gain.setValueAtTime(0.1*s[0],ts);env.gain.linearRampToValueAtTime(0,tr);osc.connect(env);env.connect(this.ctx.destination);osc.start();setTimeout(()=>{env.disconnect();osc.stop();},(tr-this.ctx.currentTime)*1000);}update(){if(!this.ctx)return;if(this.song){const limit=this.ctx.currentTime+3;while(this.songTime<limit){if(this.songp>=this.song.length){if(this.srpt){this.songp=1;this.songTime+=0.01;continue;}else{this.song=null;return;}}const opcode=this.song[this.songp++];if(opcode===39){const tickc=this.song[this.songp++]-62;if((tickc<1)||(tickc>64))return this.ps();this.songTime+=(tickc*this.songTempo)/1000;}else{const chid=opcode-40;if((chid<0)||(chid>15))return this.ps();const noteid=35+this.song[this.songp++]-63;if((noteid<35)||(noteid>98))return this.ps();const duration=this.song[this.songp++]-63;if((duration<0)||(duration>=64))return this.ps();this.playNote(chid,noteid,(duration*this.songTempo)/1000,this.songTime);}}}}playNote(chid,noteid,durs,when){const ins=insv[chid];if(!ins)return;let fmrate=0;const opt={frequency:this.hz[noteid]};if(ins[5]instanceof Array)ins[5]=new PeriodicWave(this.ctx,{real:ins[5]});if(ins[5]instanceof PeriodicWave)opt.periodicWave=ins[5];else if(typeof(ins[5])==="string")opt.type=ins[5];else if(typeof(ins[5])==="number"){opt.type="sine";fmrate=ins[5];}else return;const osc=new OscillatorNode(this.ctx,opt);const t0=when;const ta=t0+ins[0];const va=ins[1];const td=ta+ins[2];const vd=ins[3];const ts=td+durs;const tr=ts+ins[4];let modgain,mod;if(fmrate){modgain=new GainNode(this.ctx);if(ins[6]){const a=(opt.frequency*ins[6][0].toString())/10;const b=(opt.frequency*ins[6][1].toString())/10;const c=(opt.frequency*ins[6][2].toString())/10;const d=(opt.frequency*ins[6][3].toString())/10;modgain.gain.setValueAtTime(a,0);modgain.gain.setValueAtTime(a,t0);modgain.gain.setValueAtTime(b,ta);modgain.gain.setValueAtTime(c,td);modgain.gain.setValueAtTime(c,ts);modgain.gain.setValueAtTime(d,tr);}else{modgain.gain.value=opt.frequency;}mod=new OscillatorNode(this.ctx,{type:"sine",frequency:opt.frequency*fmrate});mod.start();mod.connect(modgain);modgain.connect(osc.frequency);}const env=new GainNode(this.ctx);env.gain.setValueAtTime(0,0);env.gain.setValueAtTime(0,t0);env.gain.linearRampToValueAtTime(va,ta);env.gain.linearRampToValueAtTime(vd,td);env.gain.setValueAtTime(vd,ts);env.gain.linearRampToValueAtTime(0,tr);osc.connect(env);env.connect(this.ctx.destination);osc.start();const v={env,osc,modgain,mod};this.vv.push(v);setTimeout(()=>{env.disconnect();osc.stop();if(modgain)modgain.disconnect();if(mod){mod.stop();mod.disconnect();}const p=this.vv.indexOf(v);if(p>=0)this.vv.splice(p,1);},(tr-this.ctx.currentTime)*1000);}playSong(name,once){if(!name){this.ps();}else if(this.songs[name]){this.ps(this.songs[name],once);}else{this.pendingSongName=name;this.pendingSongOnce=once;}}ps(src,once){for(const v of this.vv){if(v.env.gain.value>=1){v.env.disconnect();}else if(!v.env.gain.value){v.env.disconnect();}else{v.env.gain.cancelScheduledValues(0);v.env.gain.setValueAtTime(v.env.gain.value,0);v.env.gain.linearRampToValueAtTime(0,this.ctx.currentTime+0.1);}}this.vv=[];if(src&&(src.length>1)&&this.ctx){this.song=src;this.songp=1;this.songTempo=src[0]-62;this.songTime=this.ctx.currentTime;this.srpt=!once;}else{this.song="";this.songp=0;this.songTempo=1;this.songTime=0;}}ldc(){for(const e of document.querySelectorAll("song")){const src=new TextEncoder("utf8").encode(e.innerText.replace(/\s+/g,""));const name=e.getAttribute("name");this.songs[name]=src;}}}
class Dot{constructor(e,v,a){this.e=e;this.v=v;this.a=a;}reset(){this.x=0;this.y=0;this.gr=80;this.flr=0;this.flp=0;this.clm=0;this.j=0;this.jt=0;this.ded=0;this.af=0;this.ac=0;}setup(x,y){this.x=x;this.y=y;}die(){if(this.e.wt)return;this.e.dc++;this.a.snd(1);this.a.playSong("tts");this.ded=0.001;}jon(){if(this.clm||this.flr){this.a.snd(0);this.clm=0;this.flr=0;this.j=1;this.jt=0.375;}}joff(){this.j=0;}update(s){if(this.ded){this.ded+=s;return;}this.pvy=this.y;if(this.e.bdx){this.x+=this.e.bdx*s*120;this.flp=this.e.bdx<0;if((this.ac-=s)<=0){this.ac+=this.clm?0.2:0.125;if(++this.af>=4)this.af=0;}this.clm=0;}else if(this.e.wt){if((this.ac-=s)<=0){this.ac+=0.2;if(++this.af>=2)this.af=0;}}else if(!this.clm||this.flr){this.af=0;this.ac=0;}if(this.e.bdy){if(this.clm=this.fldr()){this.y+=this.e.bdy*s*80;if(this.y<this.clm.y-24)this.y=this.clm.y-24;this.x=this.clm.x;this.flr=0;if(!this.e.bdx)if((this.ac-=s)<=0){this.ac+=0.2;if(++this.af>=2)this.af=0;}}}if(this.clm){}else if(this.j&&this.jt){this.y-=s*this.jt*550;if((this.jt-=s)<=0){this.jt=0;}}else if(this.flr===1){this.y=144-24;}else if(this.flr){this.y=this.flr.y-24;}else{if(this.gr<160)this.gr+=80*s;this.y+=this.gr*s;}this.collide();}collide(){let nflr=0,lc=0,rc=0,uc=0,dc=0;if(this.x<0){this.x=0;lc++;}else if(this.x>256-16){this.x=256-16;rc++;}if(this.y<0){this.y=0;uc++;}else if(this.y>=144-24){nflr=1;this.y=144-24;dc++;}const pltv=[];for(const wl of this.e.wv){const le=wl.x+wl.w-this.x;if(le<=0)continue;const ue=wl.y+wl.h-this.y;if(ue<=0)continue;const re=this.x+16-wl.x;if(re<=0)continue;const de=this.y+24-wl.y;if(de<0)continue;if(wl.dx||wl.dy)pltv.push(wl);if((le<=re)&&(le<=ue)&&(le<=de)){this.x=wl.x+wl.w;lc++;this.clm=0;}else if((re<=ue)&&(re<=de)){this.x=wl.x-16;rc++;this.clm=0;}else if(ue<=de){this.y=wl.y+wl.h;uc++;}else{this.y=wl.y-24;nflr=wl;dc++;}}if(!this.clm){for(const ldr of this.e.ldrv){if(this.x>=ldr.x+16)continue;if(this.x+16<=ldr.x)continue;if(this.pvy+24>ldr.y)continue;if(this.y+24<ldr.y)continue;this.y=ldr.y-24;nflr=ldr;dc++;}}if((lc&&rc)||(uc&&dc)){for(const plt of pltv){plt.dx*=-1;plt.dy*=-1;plt.x+=plt.dx*0.02;plt.y+=plt.dy*0.02;}}if(nflr!==this.flr){this.flr=nflr;this.gr=80;}}fldr(){for(const ldr of this.e.ldrv){if(this.x+8<ldr.x)continue;if(this.y+24<ldr.y)continue;if(this.x+8>=ldr.x+16)continue;if(this.y>ldr.y+ldr.h)continue;return ldr;}return 0;}render(){if(this.ded){const mx=this.x+8;const my=this.y+12;const r=this.ded*80;let fr=Math.floor(this.ded*10)&3;for(let i=0,t=0;i<7;i++,t+=(Math.PI*2)/7){const dx=Math.floor(mx+Math.cos(t)*r-3.5);const dy=Math.floor(my+Math.sin(t)*r-3.5);this.v.blit(dx,dy,fr*7,0,7,7);if(++fr>=4)fr=0;}return;}const dx=Math.round(this.x);const dy=Math.round(this.y);let srcx=0;let srcy=7;if(this.e.wt){srcy+=24;if(this.af)srcx+=16;if(this.flp)this.v.flop(dx,dy,srcx,srcy,16,24);else this.v.blit(dx,dy,srcx,srcy,16,24);}else if(this.clm&&!this.flr&&(this.y+24>this.clm.y)){srcx=48;srcy=7;if(this.af&1)this.v.blit(dx,dy,srcx,srcy,16,24);else this.v.flop(dx,dy,srcx,srcy,16,24);}else{if(!this.clm)switch(this.af){case 1:srcx+=16;break;case 3:srcx+=32;break;}if(this.flp)this.v.flop(dx,dy,srcx,srcy,16,24);else this.v.blit(dx,dy,srcx,srcy,16,24);}}}
class Ecom{constructor(g,v,a,i){this.g=g;this.v=v;this.a=a;this.i=i;this.bdx=0;this.bdy=0;this.bj=0;this.bc=0;this.pvs=0;this.dot=new Dot(this,v,a);this.wv=[];this.ldrv=[];this.tkv=[];this.wz={x:0,y:0,w:0,h:0};this.wt=0;this.dt=0;this.fin=0;this.tt=0;this.sc=0;this.dc=0;this.scr=0;}reset(st){this.st=st;this.bdx=0;this.bdy=0;this.bj=0;this.bc=0;this.dot.reset();this.wv=[];this.ldrv=[];this.tkv=[];this.wz={x:0,y:0,w:0,h:0};this.a.playSong("sm");const b65=(s)=>{s=s.charCodeAt(0);if((s>=65)&&(s<=90))return s-65;if((s>=97)&&(s<=122))return s-97+26;if((s>=48)&&(s<=57))return s-48+52;if(s===43)return 62;if(s===47)return 63;if(s===63)return 64;return 0;};for(let i=0;i<st.length;){const op=st[i++];switch(op){case"w":{const x=b65(st[i++])<<2;const y=b65(st[i++])<<2;const w=b65(st[i++])<<2;const h=b65(st[i++])<<2;this.wv.push({x,y,w,h,c:"#040"});}break;case"h":{const x=(b65(st[i++])<<2)-8;const y=(b65(st[i++])<<2)-24;this.dot.setup(x,y);}break;case"p":{const x=b65(st[i++])<<2;const y=b65(st[i++])<<2;const w=b65(st[i++])<<2;const dx=(b65(st[i++])<<2)-128;const dy=(b65(st[i++])<<2)-128;this.wv.push({x,y,w,h:8,dx,dy,hold:0});}break;case"l":{const x=b65(st[i++])<<2;const y=b65(st[i++])<<2;const h=b65(st[i++])<<2;this.ldrv.push({x,y,h});}break;case"e":{const x=b65(st[i++])<<2;const y=b65(st[i++])<<2;const w=b65(st[i++])<<2;const h=b65(st[i++])<<2;this.wz={x,y,w,h};}break;}}this.rbg();}win(){if(this.dot.ded)return;this.a.playSong("taf",1);this.wt=0.01;}stk(){if(this.bc>=13)return;this.tkv.push({x:this.dot.x+8-3.5,y:this.dot.y-8,y0:this.dot.y-8,dx:(this.bdx<0)?1:(this.bdx>0)?-1:this.dot.flp?1:-1,t:0,n:this.bc,});this.sc++;if(++this.bc>=13){this.dot.die();}}victory(){this.fin=0.001;this.cscr=13;this.ttscr=Math.round(Math.max(0,170-this.tt));this.scscr=Math.max(0,170-this.sc);this.dscr=(this.dc?0:50);this.scr=this.cscr+this.ttscr+this.scscr+this.dscr;}restart(){this.fin=0;this.tt=0;this.sc=0;this.dc=0;this.scr=0;this.reset(this.g.nextStage());}update(s,state){if(this.wt>0){this.wt+=s;this.bdx=0;this.bdy=0;}if(this.dot.ded){this.dt+=s;}if(this.fin>0){this.fin+=s;if(state!==this.pvs){if((state&16)&&(!(this.pvs&16))&&(this.fin>0.5)){this.restart();}this.pvs=state;}return;}if(!this.wt&&!this.dot.ded)this.tt+=s;if(state!==this.pvs){const kd=(n)=>{switch(n){case 1:case 4:return-1;case 2:case 8:return 1;}return 0;};if(!this.wt){const ndx=kd(state&(1|2));const ndy=kd(state&(4|8));if(ndx!==this.bdx){if(this.bdx=ndx)this.stk();}if(ndy!==this.bdy){if((this.bdy=ndy)&&this.dot.fldr())this.stk();}}if(state&16){if(!this.bj){this.bj=1;if(this.wt){this.wt=0;const st=this.g.nextStage();if(st){this.reset(st);}else{this.victory();return;}}else if(this.dot.ded>0.5){this.reset(this.st);}else if(this.dot.ded>0){}else if(!this.wt){this.stk();this.dot.jon();}}}else if(this.bj){this.bj=0;this.dot.joff();}this.pvs=state;}for(const wl of this.wv){if(!wl.dx&&!wl.dy)continue;const dx=wl.dx*s;const dy=wl.dy*s;wl.x+=dx;wl.y+=dy;if(!this.dot.ded&&!this.wt&&(this.dot.flr===wl)){this.dot.x+=dx;this.dot.y+=dy;}if(wl.hold>0){wl.hold-=s;}else if(this.ckwl(wl)){wl.x-=dx;wl.y-=dy;}}for(let i=this.tkv.length;i-->0;){const tk=this.tkv[i];tk.t+=s;tk.x+=tk.dx*s*10;tk.y=tk.y0+(tk.t-0.25)**2*100;if(tk.y>144)this.tkv.splice(i,1);}this.dot.update(s);if(!this.dot.ded&&!this.wt){const x=this.dot.x+8;const y=this.dot.y+12;if((x>=this.wz.x)&&(y>=this.wz.y)&&(x<this.wz.x+this.wz.w)&&(y<this.wz.y+this.wz.h)){this.win();}}}ckwl(wl){if((wl.x<0)||(wl.x+wl.w>=256)||(wl.y<0)||(wl.y+wl.h>=144)){wl.dx*=-1;wl.dy*=-1;wl.hold=0.25;return 1;}for(const o of this.wv){if(o===wl)continue;if(o.x>=wl.x+wl.w)continue;if(o.y>=wl.y+wl.h)continue;if(o.x+o.w<=wl.x)continue;if(o.y+o.h<=wl.y)continue;wl.dx*=-1;wl.dy*=-1;wl.hold=0.25;return 1;}return 0;}rfin(){this.v.rect(0,0,256,144,"#466");this.v.blit(80,40,32,31,37,5);this.v.decint(160,40,this.cscr,3);this.v.blit(100,47,32,36,17,5);this.v.decint(120,47,this.tt,5);this.v.decint(160,47,this.ttscr,3);this.v.blit(93,54,32,41,24,5);this.v.decint(120,54,this.sc,5);this.v.decint(160,54,this.scscr,3);this.v.blit(93,61,32,46,24,5);this.v.decint(120,61,this.dc,5);this.v.decint(160,61,this.dscr,3);this.v.decint(160,70,this.scr,3);this.v.rect(160,68,17,1,"#888");this.v.blit(60,60,((this.fin*5)&1)?16:0,31,16,24);}render(){if(this.fin)return this.rfin();this.v.bg();for(const wl of this.wv){if(wl.c)continue;let x=Math.round(wl.x);let y=Math.round(wl.y);for(let subx=x+8,i=Math.floor(wl.w/8)-2;i-->0;subx+=8){this.v.blit(subx,y,88,7,8,8);}this.v.blit(x,y,80,7,8,8);this.v.flop(x+wl.w-8,y,79,7,8,8);}this.dot.render();for(const tk of this.tkv){this.v.blit(Math.floor(tk.x),Math.floor(tk.y),28+tk.n*7,0,7,7);}this.v.blit(1,144-6,88+Math.floor(this.bc/10)*3,15,3,5);this.v.blit(5,144-6,88+(this.bc%10)*3,15,3,5);if(this.wt){this.v.rect(99,137,58,6,((this.wt*2)&1)?"#000":"#084");this.v.blit(100,138,64,23,56,4);}else if(this.dot.ded){this.v.rect(99,137,64,6,((this.dt*2)&1)?"#000":"#408");this.v.blit(100,138,64,27,62,4);}}rbg(){const gx=this.wz.x+(this.wz.w>>1),gy=this.wz.y+(this.wz.h>>1);const grd=this.v.bc.createRadialGradient(gx,gy,1,gx,gy,256);grd.addColorStop(0,"#ace");grd.addColorStop(1,"#46a");this.v.bc.fillStyle=grd;this.v.bc.fillRect(0,0,256,144);const colc=(256>>2)+2;const rowc=(144>>2)+2;const bm=new Uint8Array(colc*rowc);for(let x=0;x<colc;x++)bm[x]=bm[colc*rowc-x]=1;for(let y=0;y<rowc;y++)bm[y*colc]=bm[(y+1)*colc-1]=1;for(const wl of this.wv){if(!wl.c)continue;const x=(wl.x>>2)+1,y=(wl.y>>2)+1,w=wl.w>>2,h=wl.h>>2;let rp=y*colc+x;for(let yi=h;yi-->0;rp+=colc){for(let xp=rp,xi=w;xi-->0;xp++)bm[xp]=1;}}for(let y=0,rp=colc+1,yi=144>>2;yi-->0;rp+=colc,y+=4){for(let x=0,xp=rp,xi=256>>2;xi-->0;xp++,x+=4){if(!bm[xp])continue;const nw=bm[xp-colc-1],n=bm[xp-colc],ne=bm[xp-colc+1],w=bm[xp-1],e=bm[xp+1],sw=bm[xp+colc-1],s=bm[xp+colc],se=bm[xp+colc+1];if(n&&w&&e&&s){if(nw&&ne&&sw&&se){this.v.bblit(x,y,120,7,4,4);}else if(!nw){this.v.bblit(x,y,108,11,4,4);}else if(!ne){this.v.bblit(x,y,104,11,4,4);}else if(!sw){this.v.bblit(x,y,108,7,4,4);}else{this.v.bblit(x,y,104,7,4,4);}}else if(n&&w&&e){this.v.bblit(x,y,112,7,4,4);}else if(n&&w&&s){this.v.bblit(x,y,116,11,4,4);}else if(n&&e&&s){this.v.bblit(x,y,112,11,4,4);}else if(w&&e&&s){this.v.bblit(x,y,116,7,4,4);}else if(n&&w){this.v.bblit(x,y,100,11,4,4);}else if(n&&e){this.v.bblit(x,y,96,11,4,4);}else if(w&&s){this.v.bblit(x,y,100,7,4,4);}else if(e&&s){this.v.bblit(x,y,96,7,4,4);}else{this.v.bblit(x,y,124,11,4,4);}}}for(const ldr of this.ldrv){const x=Math.round(ldr.x);let y=Math.round(ldr.y+ldr.h);while(y>ldr.y){y-=6;this.v.bblit(x,y,64,7,16,6);}}let x=this.wz.x+8;const y=this.wz.y+this.wz.h;let i=(this.wz.w-16)/8;for(;i-->0;x+=8)this.v.bblit(x,y,72,15,8,8);this.v.bblit(this.wz.x,y,64,15,8,8);this.v.bblit(this.wz.x+this.wz.w-8,y,80,15,8,8);}}
class Stages{constructor(){this.v=Array.from(document.getElementsByTagName("stage")).map(e=>e.innerText);}}
class Game{constructor(v,a,i){this.v=v;this.a=a;this.i=i;v.game=this;this.running=false;this.pf=null;this.pvtime=0;this.i.kh.Escape=()=>this.end();this.ecom=new Ecom(this,this.v,this.a,this.i);this.stg=new Stages();}begin(){if(this.running)return;this.running=true;this.stp=0;this.ecom.reset(this.stg.v[this.stp]);this.pvtime=Date.now();this.pf=window.requestAnimationFrame(()=>this.update());}end(){this.v.end();this.a.end();this.i.end();this.running=false;if(this.pf){window.cancelAnimationFrame(this.pf);this.pf=null;}}update(){this.pf=null;if(!this.running)return;this.a.update();const state=this.i.update();const now=Date.now();let elapsed=now-this.pvtime;if(elapsed>=10){if(elapsed>20){elapsed=20;}this.ecom.update(elapsed/1000,state);this.pvtime=now;this.ecom.render();}this.pf=window.requestAnimationFrame(()=>this.update());}nextStage(){this.stp++;if(this.stp>=this.stg.v.length){this.stp=-1;return null;}return this.stg.v[this.stp];}}
window.addEventListener("load",()=>{const game=new Game(new Video(),new Audio(),new Input());game.begin();});
</script></head><body><canvas></canvas></body></html>
