"use strict";let zzfx,zzfxV,zzfxX,zzfxR;zzfxV=.3,zzfx=(e=1,t=.05,i=220,s=0,o=0,n=.1,r=0,a=1,h=0,l=0,c=0,d=0,u=0,m=0,g=0,p=0,w=0,y=1,f=0,C=0)=>{let x,b,z=2*Math.PI,T=h*=500*z/zzfxR**2,S=(0<g?1:-1)*z/4,v=i*=(1+2*t*Math.random()-t)*z/zzfxR,A=[],I=0,V=0,M=0,E=1,G=0,R=0,O=0;for(l*=500*z/zzfxR**3,g*=z/zzfxR,c*=z/zzfxR,d*=zzfxR,u=zzfxR*u|0,b=(s=99+zzfxR*s)+(f*=zzfxR)+(o*=zzfxR)+(n*=zzfxR)+(w*=zzfxR)|0;M<b;A[M++]=O)++R%(100*p|0)||(O=r?1<r?2<r?3<r?Math.sin((I%z)**3):Math.max(Math.min(Math.tan(I),1),-1):1-(2*I/z%2+2)%2:1-4*Math.abs(Math.round(I/z)-I/z):Math.sin(I),O=(u?1-C+C*Math.sin(2*Math.PI*M/u):1)*(0<O?1:-1)*Math.abs(O)**a*e*zzfxV*(M<s?M/s:M<s+f?1-(M-s)/f*(1-y):M<s+f+o?y:M<b-w?(b-M-w)/n*y:0),O=w?O/2+(w>M?0:(M<b-w?1:(b-M)/w)*A[M-w|0]/2):O),x=(i+=h+=l)*Math.sin(V*g-S),I+=x-x*m*(1-1e9*(Math.sin(M)+1)%2),V+=x-x*m*(1-1e9*(Math.sin(M)**2+1)%2),E&&++E>d&&(i+=c,v+=c,E=0),!u||++G%u||(i=v,h=T,E=E||1);return(e=zzfxX.createBuffer(1,b,zzfxR)).getChannelData(0).set(A),(i=zzfxX.createBufferSource()).buffer=e,i.connect(zzfxX.destination),i.start(),i},zzfxX=new(window.AudioContext||webkitAudioContext),zzfxR=44100;class Sound{static buttonClick(){zzfx(1,0,10,.04,0,.09,0,1,0,0,100,.06,0,0,0,0,0,1,0)}static buttonLocked(){zzfx(1,0,20,.04,0,.09,1,10,0,0,-50,.06,0,0,0,0,0,1,0)}static wrongCombination(){Sound.buttonLocked()}static tileSelect(e){zzfx(1,0,20,.04,0,.09,0,1,0,0,50*(e+1),.06,0,0,0,0,0,1,0)}static score(){zzfx(1,0,400,.04,0,.09,0,1,0,100,0,0,0,0,0,0,0,1,0)}static coming(){zzfxV=.1,Sound.buttonClick(),zzfxV=.3}static opening(){}}class Vector{constructor(e=0,t=0){this.x=e,this.y=t}add(e){return new Vector(this.x+e.x,this.y+e.y)}diff(e){return new Vector(this.x-e.x,this.y-e.y)}mul(e){return new Vector(this.x*e,this.y*e)}length(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}equals(e){return this.x==e.x&&this.y==e.y}round(){return new Vector(Math.round(this.x),Math.round(this.y))}floor(){return new Vector(Math.floor(this.x),Math.floor(this.y))}clone(){return new Vector(this.x,this.y)}}const logins=+localStorage.getItem("logins")||0;localStorage.setItem("logins",logins+1);class Color{constructor(e=0,t=0,i=0,s=255){this.r=e,this.g=t,this.b=i,this.a=s}equals(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}shift(e,t){const i=[[this.r,e.r],[this.g,e.g],[this.b,e.b],[this.a,e.a]].map(([e,i])=>{const s=Math.sign(i-e);return(s>0?Math.min:Math.max)(e+t*s,i)});return new Color(...i)}toString(){return`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a/255})`}}Color.white=new Color(255,255,255),Color.darkGrey=new Color(33,33,33),Color.grey=new Color(45,45,45),Color.lightGrey=new Color(92,92,92),Color.yellow=new Color(255,255);class Observable{constructor(){this.subs={}}on(e,t){return this.subs[e]||(this.subs[e]=[]),this.subs[e].push(t),()=>{const i=this.subs[e].findIndex(e=>e===t);i>=0&&(this.subs[e][i]=null)}}trigger(e,t){const i=`on${e.charAt(0).toUpperCase()}${e.slice(1)}`;"function"==typeof this[i]&&this[i](t),this.subs[e]&&(this.subs[e].forEach(e=>e&&e(t)),this.subs[e]=this.subs[e].filter(Boolean))}destroy(){this.subs=[]}}class GameObject extends Observable{constructor({pos:e=new Vector,opacity:t=1,scale:i=1,freezed:s=!1,children:o=[],...n}={}){super(),this.pos=e,this.opacity=t,this.scale=i,this.freezed=s,this.children=[];for(let e in n)this[e]=n[e];this.addChildren(o||[]),this.addChildren(this.createChildren())}destroy(){super.destroy(),this.parent&&this.parent.removeChild(this);const e=this.children;this.children=[],e.forEach(e=>e.destroy())}createChildren(){return[]}addChildren(e){e.forEach(e=>this.addChild(e))}addChild(e,t=this.children.length){e.parent=this,this.children[t]=e,e.trigger("mount"),this.trigger("childrenChange")}getChild(e){if(e===this.id)return this;for(let t=0;t<this.children.length;t++){let i=this.children[t].getChild(e);if(i)return i}}get(e){return"function"==typeof this[e]?this[e]():this[e]}removeChild(e){const t=this.children.findIndex(t=>t===e);this.children.splice(t,1),this.trigger("childrenChange")}update(e){this.children.forEach(t=>t.update(e))}render(e){this.children.forEach(t=>{e.save();const{x:i,y:s}=t.pos.round();e.translate(i,s),e.scale(t.scale,t.scale),e.globalAlpha=t.opacity*this.getGlobalOpacity(),t.render(e),e.restore()})}isFreezed(){const e=this.freezed;return this.parent&&!e?this.parent.isFreezed():e}getGlobalOpacity(){return this.parent?this.opacity*this.parent.getGlobalOpacity():this.opacity}getGlobalPosition(){return this.parent?this.pos.add(this.parent.getGlobalPosition()):this.pos}}class GameSingleton extends Observable{constructor({canvas:e=document.createElement("canvas"),viewRes:t=new Vector}){super(),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.viewRes=t,this.subCanvas=document.createElement("canvas"),this.subCanvas.width=this.viewRes.x,this.subCanvas.height=this.viewRes.y,this.subCtx=this.subCanvas.getContext("2d"),this.subCtx.imageSmoothingEnabled=!1,this.root=new GameObject({}),this.oldT=0,window.onresize=()=>this.fitScreen(),this.fitScreen()}fitScreen(){const e=window.getComputedStyle(this.canvas);this.canvasSize=new Vector(parseInt(e.width),parseInt(e.height)),this.canvas.width=this.canvasSize.x,this.canvas.height=this.canvasSize.y,this.ctx.imageSmoothingEnabled=!1;const t=Math.min(this.canvasSize.x/this.viewRes.x,this.canvasSize.y/this.viewRes.y);this.viewSize=new Vector(this.viewRes.x*t,this.viewRes.y*t),this.viewPos=this.canvasSize.diff(this.viewSize).mul(.5)}loop(e){if(window.requestAnimationFrame(e=>this.loop(e)),this.root){if(this.oldT){const t=e-this.oldT;this.trigger("tick",t),this.subCtx.fillStyle="black",this.subCtx.fillRect(0,0,this.viewRes.x,this.viewRes.y),this.root.update(t),this.root.render(this.subCtx),this.ctx.drawImage(this.subCanvas,0,0,this.viewRes.x,this.viewRes.y,this.viewPos.x,this.viewPos.y,this.viewSize.x,this.viewSize.y)}this.oldT=e}}play(){this.loop()}}const Game=new GameSingleton({canvas:document.getElementById("game"),viewRes:new Vector(96,144)});class Trophy{constructor(e,t,i){this.name=e,this.message=t,this.unlocked=null!=this.getMessage(),this.condition=i}getFullPath(){return"OS13kTrophy,ðŸŸ£,Connection,"+this.name}getMessage(){return window.localStorage.getItem(this.getFullPath())}unlock(){this.unlocked=!0,this.setMessage(this.message)}setMessage(e){window.localStorage.setItem(this.getFullPath(),e)}}class Record extends Trophy{constructor(e){super(e,"",()=>!0),this.message=this.getBest(),this.unlocked=!0}getFullPath(){return"OS13kTrophy,ðŸŸ£,Connection,HIGH SCORE: "+this.name}getBest(){return parseInt(this.getMessage())||0}setBest(e){this.setMessage(parseInt(e))}}class TrophyCase{static getTrophy(e){return this.trophies.find(t=>t.name==e)}static updateTrophyStatus(){const e=[];this.trophies.forEach(t=>{!t.unlocked&&t.condition()&&(t.unlock(),e.push(t))}),TrophyCase.notifyTrophies(e)}static async notifyTrophies(e){for(let t=0;t<e.length;t++)await TrophyCase.notifyTrophy(e[t])}static async notifyTrophy(e){const t=new Vector(4,4),i=new Vector(5,4),s=new GameText({text:e.name,size:Game.viewRes.diff(t.mul(2)).diff(i.mul(2))}),o=new Vector(t.x,-s.getTextMetrics().y-i.mul(2).y),n=new Button({text:e.name,freezed:!0,size:new Vector(Game.viewRes.diff(t.mul(2)).x,s.getTextMetrics().y+i.mul(2).y),pos:o});Game.root.getChild("popup").addChild(n),await Promise.all([Animate.slide(n,{delay:400,duration:400,to:t}).promise,Animate.fadeIn(n,{delay:400,duration:400}).promise]),await Promise.all([Animate.slide(n,{delay:1e3,duration:400,to:o}).promise,Animate.fadeOut(n,{delay:1e3,duration:400}).promise])}}TrophyCase.trophies=[new Record("3 IN A ROW"),new Record("GET SQUARE"),new Record("HIGH FIVE"),new Record("SIX PACK"),new Record("ARCADE"),new Trophy("WELCOME BACK","OPEN THE GAME TWICE",()=>+localStorage.getItem("logins")>1),new Trophy("RETURNING CUSTOMER","OPEN THE GAME TEN TIMES",()=>+localStorage.getItem("logins")>10),new Trophy("TIME TO SETTLE IT DOWN","UNLOCK 'GET SQUARE'",()=>TrophyCase.getTrophy("3 IN A ROW").getBest()>20),new Trophy("YOU'RE AWESOME","UNLOCK 'HIGH FIVE'",()=>TrophyCase.getTrophy("GET SQUARE").getBest()>15),new Trophy("THEORETICALLY ENDLESS FUN","UNLOCK 'ARCADE'",()=>TrophyCase.getTrophy("HIGH FIVE").getBest()>10),new Trophy("CULTURIST","UNLOCK 'SIX PACK'",()=>TrophyCase.getTrophy("ARCADE").getBest()>30),new Trophy("OVERACHIEVER I","SCORE MORE THAN 25 POINTS IN '3 IN A ROW'",()=>TrophyCase.getTrophy("3 IN A ROW").getBest()>25),new Trophy("OVERACHIEVER II","SCORE MORE THAN 20 POINTS IN 'GET SQUARE'",()=>TrophyCase.getTrophy("GET SQUARE").getBest()>20),new Trophy("OVERACHIEVER III","SCORE MORE THAN 15 POINTS IN 'HIGH FIVE'",()=>TrophyCase.getTrophy("HIGH FIVE").getBest()>15),new Trophy("OVERACHIEVER IV","SCORE MORE THAN 40 POINTS IN 'ARCADE'",()=>TrophyCase.getTrophy("ARCADE").getBest()>40),new Trophy("OVERACHIEVER V","SCORE MORE THAN 15 POINTS IN 'SIX PACK'",()=>TrophyCase.getTrophy("SIX PACK").getBest()>15),new Trophy("ALL STARS","UNLOCK ALL TROPHIES",()=>TrophyCase.trophies.filter(e=>!(e instanceof Record)&&"ALL STARS"!=e.name).every(e=>e.unlocked))];class GameText extends GameObject{constructor({text:e="",font:t=gameFont,fontSize:i=1,lineHeight:s=1.5,size:o=null,align:n="left",color:r=Color.white,...a}){super({text:e,font:t,fontSize:i,lineHeight:s,size:o,align:n,color:r,...a}),this.size?this.fixedSize=!0:(this.fixedSize=!1,this.recalculateSize())}recalculateSize(){this.size=this.getTextMetrics(this.get("text"))}render(e){this.fixedSize||this.recalculateSize();let t=new Vector;"center"==this.get("align")&&(t=this.size.mul(.5).diff(this.getTextMetrics(this.get("text")).mul(.5)));const i=this.get("text"),s=this.font.getHeight(),o=s*this.fontSize;let n=Math.round(t.x),r=0;this.splitText(i).forEach(t=>{t.trim().split("").forEach(t=>{const i=this.font.getWidth(t),a=this.font.getOffset(t),h=i*this.fontSize;if(e.drawImage(this.font.source,a,0,i,s,n,r,h,o),!this.color.equals(Color.white)){const{x:t,y:i}=this.getGlobalPosition(),s=e.getImageData(t+n,i+r,h,o);for(let e=0;e<s.data.length;e+=4)s.data[e]=this.color.r/255*s.data[e],s.data[e+1]=this.color.g/255*s.data[e+1],s.data[e+2]=this.color.b/255*s.data[e+2];e.putImageData(s,t+n,i+r)}n+=h}),n=0,r+=Math.round(o*this.lineHeight)}),super.render(e)}splitText(e){const t=[[]];let i=0;return e.trim().split(" ").forEach((e,s)=>{t[t.length-1]&&t[t.length-1].length&&(e=" "+e);const o=this.getTextMetrics(e).x;if(i+o>this.size.x){if(o>this.size.x){const s=this.getTextMetrics("-").x,o=e.split("").findIndex((e,t,o)=>{const n=o.slice(0,t+1);return i+this.getTextMetrics(n.join("")).x+s>this.size.x});o>1&&(t[t.length-1].push(e.slice(0,o)+"-"),e=e.slice(o)),i=this.getTextMetrics(e).x}else i=o;t.push([e.trim()])}else t[t.length-1].push(e.trim()),i+=o}),t.map(e=>e.join(" "))}getTextMetrics(e){const t=this.fixedSize&&!e?this.splitText(this.get("text")):[e];return new Vector(Math.max(...t.map(e=>e.split("").reduce((e,t)=>e+this.font.getWidth(t)*this.fontSize,0))),t.length*this.font.getHeight()*this.fontSize*this.lineHeight-(this.lineHeight-1)).floor()}}class GameFont{constructor(e,t){this.sourcePath=e,this.metaPath=t,this.source=new Image,this.meta={},this.charsMap=new Map}async load(){await new Promise(e=>{this.source.onload=e,this.source.src=this.sourcePath});const e=await fetch(this.metaPath);e.ok&&(this.meta=await e.json());let t=0;for(let e of this.meta.ranges){Array.isArray(e)||(e=[e,e]);const[i,s]=e.map(e=>parseInt(e,16));for(let e=i;e<=s;e++)this.charsMap.set(e,t),t+=1}}getIndex(e){return e=e.charCodeAt(0),this.charsMap.get(e)}getHeight(){return this.meta.height}getWidth(e){const t=this.getIndex(e);return this.meta.width[t]}getOffset(e){const t=this.getIndex(e);let i=0;for(let e=0;e<t;e++)i+=this.meta.width[e];return i}}const gameFont=new GameFont("./font.png","./font.meta.json");class Spritesheet{constructor(e,t){this.sourcePath=e,this.source=new Image,this.meta=t}async load(){await new Promise(e=>{this.source.onload=e,this.source.src=this.sourcePath})}getIndex(e){return this.meta.assetNames.indexOf(e)}getHeight(){return this.meta.height}getWidth(){return this.meta.width}getOffset(e){return isNaN(parseInt(e))&&(e=this.getIndex(e)),this.meta.width*e}}const assets=new Spritesheet("./sprites.png",{width:11,height:11,assetNames:["triangle","square","circle","cross","lock"]});class InputSingleton extends Observable{constructor(){super(),this.isMouseDown=!1,this.isTouchDevice=!1,this.isScrolling=!1,this.mousePos=new Vector(0,0),this.scrollVelocity=5,this.sensitivity=2,this.lastDragPoint=null,Game.canvas.onmousedown=e=>this.onCanvasMouseDown(e),Game.canvas.onmouseup=e=>this.onCanvasMouseUp(e),Game.canvas.onmousemove=e=>this.onCanvasMouseMove(e),Game.canvas.ontouchstart=e=>this.onCanvasTouchStart(e),Game.canvas.ontouchend=e=>this.onCanvasTouchEnd(e),Game.canvas.ontouchmove=e=>this.onCanvasTouchMove(e),Game.canvas.onwheel=e=>this.onCanvasWheel(e)}onCanvasTouchStart(e){e=this._normalizeTouchEvent(e),this.onCanvasMouseDown(e)}onCanvasTouchEnd(e){e=this._normalizeTouchEvent(e),this.onCanvasMouseUp(e)}onCanvasTouchMove(e){e=this._normalizeTouchEvent(e),this.onCanvasMouseMove(e)}_normalizeTouchEvent(e){return this.isTouchDevice=!0,e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY,e.isTouchEvent=!0,e}onCanvasMouseDown(e){this.isMouseDown=!0,this.lastDragPoint=this.initialDragPoint=this.normalizePosition(this.eventToVector(e)),this.stopMomentum&&this.stopMomentum(),this.triggerMouseEvent("mousedown",e)}onCanvasMouseUp(e){this.isMouseDown=!1,this.triggerMouseEvent("mouseup",e),this.isScrolling&&(this.stopMomentum=Game.on("tick",e=>{const t=this.lastDelta=this.lastDelta.diff(this.lastDelta.mul(this.scrollVelocity*(e/1e3)));this.triggerEvent("scroll",{delta:t}),t.length()<.1&&this.stopMomentum()})),this.isScrolling=!1}onCanvasMouseMove(e){if(this.triggerMouseEvent("mousemove",e),this.isMouseDown){const t=this.normalizePosition(this.eventToVector(e));if(!this.isScrolling){t.diff(this.initialDragPoint).length()>this.sensitivity&&(this.isScrolling=!0)}if(this.isScrolling){const e=t.diff(this.lastDragPoint);this.lastDelta=e,this.lastDragPoint=t,this.triggerEvent("scroll",{delta:e})}}}onCanvasWheel(e){const t=(e.shiftKey?new Vector(e.deltaY,0):new Vector(0,e.deltaY)).mul(this.scrollVelocity).mul(-1);this.triggerEvent("scroll",{delta:t})}triggerMouseEvent(e,t){if(!t.isTouchEvent&&this.isTouchDevice)return;const i=this.normalizePosition(this.eventToVector(t));this.mousePos=i,this.triggerEvent(e,{pos:i})}triggerEvent(e,t){this.trigger(e,{name:e,...t})}eventToVector(e){return new Vector(e.clientX,e.clientY)}normalizePosition(e){const t=e.diff(Game.viewPos);return t.x=t.x*Game.viewRes.x/Game.viewSize.x,t.y=t.y*Game.viewRes.y/Game.viewSize.y,t}}const Input=new InputSingleton;class Timer extends Observable{constructor(e=0){super(),this.duration=e,this.progress=0,this.unsubscribe=Game.on("tick",e=>this.onGameTick(e))}onGameTick(e){this.progress+=e,this.trigger("tick",Math.min(this.progress/this.duration,1)),this.progress>this.duration&&(this.trigger("completed"),this.unsubscribe(),this.destroy())}}class Interval extends Observable{constructor(e){super(),this.interval=e,this.stopped=!1,this.onTimerCompleted()}onTimerCompleted(){this.stopped?this.destroy():(this.trigger("tick"),this.timer=new Timer(this.interval),this.timer.on("completed",()=>this.onTimerCompleted()))}stop(){this.stopped=!0}}class GameAnimation extends Observable{constructor({duration:e,delay:t=0}){super(),this.promise=new Promise(i=>{new Timer(t).on("completed",()=>{this.trigger("start");const t=new Timer(e);t.on("tick",e=>this.trigger("progress",e)),t.on("completed",()=>{this.trigger("end"),i(),this.destroy()})})})}}class Animate{static jumpOut(e,{duration:t,delay:i}){const s=new GameAnimation({duration:t,delay:i});let o=0;return s.on("start",()=>o=e.pos.y),s.on("progress",t=>{e.pos.y=o+(-8+Math.pow(8*t-Math.sqrt(8),2)),e.opacity=1-t}),s}static jumpIn(e,{duration:t,delay:i}){const s=new GameAnimation({duration:t,delay:i});e.opacity=0;let o=0;return s.on("start",()=>o=e.pos.y),s.on("progress",t=>{e.pos.y=o-6*(1-t),e.opacity=t}),s}static shake(e,{duration:t,delay:i}){const s=new GameAnimation({duration:t,delay:i});let o=0;return s.on("start",()=>o=e.pos.x),s.on("progress",t=>{e.pos.x=o+1*Math.sin(2*Math.PI*t)}),s}static explode(e,{duration:t,delay:i}){const s=new GameAnimation({duration:t,delay:i}),{scale:o,pos:n,size:r}=e;return s.on("progress",t=>{e.pos=n.diff(r.mul(1.25*t/2)),e.scale=o+1.25*t,e.opacity=1-t}),s}static fadeTo(e,{duration:t,delay:i,to:s}){const o=new GameAnimation({duration:t,delay:i}),{opacity:n}=e;return o.on("progress",t=>{const i=n+(s-n)*t;e.opacity=i}),o}static fadeIn(e,t){return Animate.fadeTo(e,{...t,to:1})}static fadeOut(e,t){return Animate.fadeTo(e,{...t,to:0})}static blink(e,{duration:t,delay:i}){const s=new GameAnimation({duration:t,delay:i}),o=e.opacity,n=e.opacity>=.5?0:1;return s.on("progress",t=>{t>=0&&t<.5?e.opacity=n:t>=.5&&t<1&&(e.opacity=o),1==t&&(e.opacity=n)}),s}static zoomTo(e,{duration:t,delay:i,to:s}){const o=new GameAnimation({duration:t,delay:i}),{pos:n,size:r,scale:a}=e,h=n.add(r.mul(a).diff(r).mul(.5));return o.on("progress",t=>{const i=a+(s-a)*t;e.pos=h.diff(r.mul(i).diff(r).mul(.5)),e.scale=i}),o}static zoomIn(e,t){return e.scale=0,Animate.zoomTo(e,{...t,to:1})}static zoomOut(e,t){return e.scale=1,Animate.zoomTo(e,{...t,to:0})}static slide(e,{duration:t,delay:i,to:s}){const o=new GameAnimation({duration:t,delay:i});let{pos:n}=e;return n=new Vector(n.x,n.y),o.on("progress",t=>{e.pos=n.add(s.diff(n).mul(t))}),o}static lift(e,{duration:t,delay:i}){const s=new GameAnimation({duration:t,delay:i});let{pos:o}=e;const n=new Vector(o.x,o.y+-4);return s.on("progress",t=>{e.opacity=1-t,e.pos=o.add(n.diff(o).mul(t))}),s}static counter(e,{duration:t,delay:i,to:s}){const o=new GameAnimation({duration:t,delay:i});return e.text="0",o.on("progress",t=>{e.text=""+Math.round(s*t)}),o}}class Rectangle extends GameObject{constructor({color:e=new Color,size:t=new Vector,...i}){super(i),this.color=e,this.size=t}render(e){e.fillStyle=this.get("color").toString();const{x:t,y:i}=this.get("size");e.fillRect(0,0,t,i),super.render(e)}}class ResultsScreen extends GameObject{constructor({score:e=0,level:t,...i}){super({level:t,score:e,...i}),this.trophy=TrophyCase.getTrophy(this.level.name),this.previousBest=this.trophy.getBest(),this.on("mount",()=>this.updateTrophy()),this.on("mount",()=>this.entryAnimation())}updateTrophy(){this.previousBest<this.score&&this.trophy.setBest(this.score)}async entryAnimation(){this.freezed=!0;const e=this.getChild("title"),t=e.pos.clone(),i=Game.viewRes.mul(.5).diff(e.getGlobalPosition());e.pos=new Vector(t.x,i.y),await Animate.blink(e,{duration:800}).promise,await Animate.slide(e,{duration:600,delay:400,to:t}).promise;const s=this.getChild("scoreLabel"),o=this.getChild("score"),n=Animate.counter(o,{duration:1200,to:this.score});await Promise.all([Animate.fadeIn(s,{duration:600}).promise,Animate.fadeIn(o,{duration:600}).promise]);const r=this.getChild("bestLabel"),a=this.getChild("best");if(await Promise.all([Animate.fadeIn(r,{duration:600}).promise,Animate.fadeIn(a,{duration:600}).promise]),await n.promise,this.previousBest<this.score){const e=new GameText({...a,size:null,pos:a.getGlobalPosition(),scale:20,opacity:0,text:this.score+" NEW",color:Color.yellow});e.pos=e.pos.diff(e.size.mul(e.scale).diff(e.size).mul(.5)),this.addChild(e),await Promise.all([Animate.explode(a,{duration:400}).promise,Animate.zoomTo(e,{duration:400,to:1}).promise,Animate.fadeIn(e,{duration:400}).promise])}TrophyCase.updateTrophyStatus();const h=this.getChild("retry"),l=this.getChild("menu");await Promise.all([Animate.fadeIn(h,{duration:600}).promise,Animate.fadeIn(l,{duration:600}).promise]),this.freezed=!1}createChildren(){const e=new GameText({id:"scoreLabel",text:"SCORE: ",pos:new Vector(4,42),opacity:0}),t=new GameText({id:"score",text:"0",pos:new Vector(4+e.size.x,42),opacity:0}),i=new GameText({id:"bestLabel",text:"BEST: ",pos:new Vector(4,50),opacity:0}),s=new GameText({id:"best",text:""+TrophyCase.getTrophy(this.level.name).getBest(),pos:new Vector(4+i.size.x,50),opacity:0}),o=new Vector(8,8),n=Game.viewRes.diff(o.mul(2));return[new Flexbox({direction:"column",pos:o,size:n,spaceBetween:8,align:"center",justify:"center",children:[new GameText({id:"title",text:"TIME'S UP",fontSize:2,opacity:0,pos:new Vector(0,Game.viewRes.y/2),align:"center"}),new Flexbox({size:new Vector(n.x,7),justify:"start",children:[e,t]}),new Flexbox({size:new Vector(n.x,7),justify:"start",children:[i,s]}),new Flexbox({direction:"row",size:new Vector(n.x,17),spaceBetween:4,justify:"center",children:[new Button({id:"retry",text:"RETRY",align:"center",opacity:0,onClick:()=>this.retry(),size:new Vector(n.x/2,17)}),new Button({id:"menu",text:"MENU",align:"center",opacity:0,onClick:()=>this.goToMenu(),size:new Vector(n.x/2,17)})]})]})]}retry(){Sound.buttonClick(),this.level instanceof Arcade?Game.root.getChild("main").addChild(new Arcade({...this.level,children:null,opacity:1})):Game.root.getChild("main").addChild(new Level({...this.level,children:null,opacity:1})),this.destroy()}async goToMenu(){const e=new Vector(Game.viewRes.x,0),t={pos:e.mul(-1)},i=this.level instanceof Arcade&&!(this.previousBest<=30&&this.score>30)||"HIGH FIVE"==this.level.name&&this.previousBest<=10&&this.score>10?new Menu(t):new LevelsScreen(t);Game.root.getChild("main").addChild(i);await Promise.all([Animate.slide(this,{duration:300,to:this.pos.add(e)}).promise,Animate.fadeOut(this,{duration:300}).promise,Animate.slide(i,{duration:300,to:new Vector}).promise,Animate.fadeIn(i,{duration:300}).promise]),this.destroy()}}class Sprite extends GameObject{constructor({asset:e="",spritesheet:t=assets,...i}){super({asset:e,spritesheet:t,...i})}render(e){e.drawImage(this.spritesheet.source,this.spritesheet.getOffset(this.asset),0,this.spritesheet.getWidth(),this.spritesheet.getHeight(),0,0,this.spritesheet.getWidth(),this.spritesheet.getHeight()),super.render(e)}}class ColoredSprite extends GameObject{constructor({asset:e="",spritesheet:t=assets,size:i=new Vector,...s}){super({asset:e,spritesheet:t,size:i,...s}),this.accentColor=null,this.shiftDur=200,this.canvas=document.createElement("canvas"),this.canvas.width=t.getWidth(),this.canvas.height=t.getHeight(),this.ctx=this.canvas.getContext("2d");new Sprite({asset:e,spritesheet:t}).render(this.ctx),this.colorArray=this.toColorArray(this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)),this.baseColor=this.colorArray.find(e=>255==e.a),this.currentColor=this.baseColor}update(e){let t=null;if(this.accentColor?this.currentColor.equals(this.accentColor)||(t=this.accentColor):this.currentColor.equals(this.baseColor)||(t=this.baseColor),t){const i=this.currentColor.shift(t,e/this.shiftDur*255);this.colorArray=this.colorArray.map(e=>255==e.a?i:e),this.currentColor=i}super.update(e)}toColorArray(e){const t=[],i=e.data;for(let e=0;e<i.length;e+=4)t.push(new Color(i[e],i[e+1],i[e+2],i[e+3]));return t}toImageData(e){return new ImageData(Uint8ClampedArray.from(e.reduce((e,t)=>[...e,t.r,t.g,t.b,t.a],[])),this.canvas.width)}render(e){this.ctx.putImageData(this.toImageData(this.colorArray),0,0),e.drawImage(this.canvas,0,0,this.size.x,this.size.y),super.render(e)}}class Area extends GameObject{constructor({size:e=new Vector,...t}){super({size:e,...t}),this.isInside=!1,this.isPressed=!1,this.listeners=[Input.on("mouseup",e=>this.onMouseEvent("mouseup",e)),Input.on("mousedown",e=>this.onMouseEvent("mousedown",e)),Input.on("mousemove",e=>this.onMouseEvent("mousemove",e))]}destroy(){super.destroy(),this.listeners.forEach(e=>e()),this.listeners=[]}onMouseEvent(e,t){!this.isFreezed()&&this.isPointWithinObject(t.pos)?(this.isInside||(this.trigger("mouseenter",t),this.isInside=!0),"mousedown"==e&&(this.isPressed=!0),this.trigger(e,t),"mouseup"==e&&this.isPressed&&(Input.isScrolling||this.trigger("click",t),this.isPressed=!1)):(this.isInside&&(this.trigger("mouseexit",t),this.isPressed=!1),this.isInside=!1)}isPointWithinObject(e){const t=this.getGlobalPosition(),{x:i,y:s}=t,{x:o,y:n}=t.add(this.size);return e.x>i&&e.x<o&&e.y>s&&e.y<n}}class Tile extends Area{constructor({...e}){super(e),this.accentColor=null,this.baseColor=Color.grey,this.currentColor=this.baseColor,this.shiftDur=400}update(e){let t=null;this.accentColor?this.currentColor.equals(this.accentColor)||(t=this.accentColor):this.currentColor.equals(this.baseColor)||(t=this.baseColor),t&&(this.currentColor=this.currentColor.shift(t,e/this.shiftDur*255)),super.update(e)}render(e){e.fillStyle="black",e.lineWidth=1,e.strokeStyle=this.currentColor.toString(),e.strokeRect(.5,.5,this.size.x-1,this.size.y-1),e.fillRect(1,1,this.size.x-2,this.size.y-2),super.render(e)}}class Modal extends GameObject{constructor({text:e="",pos:t=Game.viewRes.mul(.5),size:i=Game.viewRes,...s}){super({text:e,size:i,pos:t,...s})}onMount(){Animate.zoomIn(this,{duration:200})}createChildren(){const e=new Vector(8,8),t=this.size.diff(e.mul(2));return[new Flexbox({pos:e,size:t,direction:"column",align:"end",justify:"start",spaceBetween:12,children:[new Button({text:"X",fillStyle:Color.grey,strokeStyle:Color.lightGrey,padding:4.5,size:new Vector(17,18),onClick:()=>this.close()}),new GameText({size:t,text:this.text,lineHeight:2})]})]}close(){Animate.zoomOut(this,{duration:200}).on("end",()=>{this.trigger("close"),this.destroy()})}render(e){e.strokeStyle=Color.lightGrey.toString(),e.fillStyle=Color.darkGrey.toString(),e.fillRect(0,0,this.size.x,this.size.y),e.strokeRect(.5,.5,this.size.x-1,this.size.y-1),super.render(e)}}class Button extends Area{constructor({text:e="",locked:t=!1,padding:i=4,size:s=new Vector,align:o="left",strokeStyle:n=Color.lightGrey,fillStyle:r=Color.darkGrey,playSounds:a=!0,...h}){super({text:e,size:s,align:o,locked:t,padding:i,border:1,strokeStyle:n,fillStyle:r,playSounds:a,...h}),this.locked?(this.opacity=.5,this.on("click",()=>{this.playSounds&&Sound.buttonLocked(),Animate.shake(this,{duration:200})})):this.on("click",()=>{this.playSounds&&Sound.buttonClick()})}createChildren(){const e=[new GameText({text:this.text,align:this.align,size:this.size.diff(new Vector(this.padding+this.border+(this.locked?5.5:0),this.padding+this.border).mul(2)),pos:new Vector(this.padding+this.border,this.padding+this.border)})];return this.locked&&e.push(this.createLock()),e}createLock(){return new Sprite({asset:"lock",size:new Vector(11,11),pos:new Vector(this.size.x-11-this.padding,(this.size.y-11)/2)})}render(e){e.strokeStyle=this.strokeStyle.toString(),e.fillStyle=this.fillStyle.toString(),this.isPressed&&!this.locked||e.fillRect(0,0,this.size.x,this.size.y),e.strokeRect(this.isPressed&&!this.locked?1.5:.5,this.isPressed&&!this.locked?1.5:.5,this.size.x-(this.isPressed&&!this.locked?3:1),this.size.y-(this.isPressed&&!this.locked?3:1)),super.render(e)}}function parseData(e){return parseInt(e,16).toString(4).padStart(2*e.length,"0").split("")}function serializeData(e){return e=e.join(""),parseInt(e,4).toString(16).padStart(e.length/2,"0")}class Combination extends GameObject{constructor({...e}){super(e)}onNext(e){e&&this.highlight(),this.swap()}highlight(){this.children[0]&&this.children[0].children.forEach(e=>e.accentColor=Color.yellow)}swap(){const e=this.children[0];e&&Promise.all(e.children.map((e,t)=>Animate.jumpOut(e,{duration:400,delay:50*t}).promise)).then(()=>this.removeChild(e));const t=this.get("combo"),i=this.createRow(t);this.addChild(i),i.children.forEach((t,i)=>{Animate.jumpIn(t,{duration:200,delay:(e?300:0)+50*i})})}createRow(e){return new Flexbox({size:new Vector(this.parent.size.x,11),direction:"row",justify:"center",align:"start",spaceBetween:3,children:e.map((e,t)=>new ColoredSprite({asset:e,size:new Vector(11,11)}))})}}class Countdown extends GameObject{constructor({length:e=0,width:t=2,duration:i=0,color:s="white",...o}){super(o),this.length=e,this.time=this.duration=i,this.progress=0,this.color=s,this.width=t,this.trail=0,this.trailColor=new Color(255,0,0,0),this.trailFade=400,this.completed=!1}update(e){this.completed||(this.progress=Math.max(0,Math.min(this.progress+e,this.duration)),this.trailColor.a=Math.max(this.trailColor.a-e/this.trailFade*255,0),this.progress==this.duration&&(this.completed=!0,this.trigger("completed"))),super.update(e)}reduceBy(e){this.trail=this.progress,this.update(e),this.trailColor=new Color(255,0,0,255)}incrementBy(e){this.trail=this.progress,this.update(-e),this.trailColor=new Color(0,255,0,255)}render(e){e.lineWidth=this.width,e.strokeStyle=this.color;const t=this.length-this.length/this.duration*this.progress,i=Math.round((this.length-t)/2),s=Math.round(t+(this.length-t)/2);e.beginPath(),e.moveTo(i,this.width/2),e.lineTo(s,this.width/2),e.stroke(),e.strokeStyle=this.trailColor.toString();this.length,this.length,this.duration,this.trail;e.beginPath(),e.moveTo(i,this.width/2),e.lineTo(s,this.width/2),e.stroke(),super.render(e)}}class GameBoard extends GameObject{constructor({data:e="0",combo:t=[],...i}){const s=e.split(" ").map(e=>parseData(e));super({data:e,combo:t,grid:s,...i}),this.comboPlayed=[],this.tilesPlayed=[],this.generationsSince=[0,0,0,0],this.unsubscribe=Input.on("mouseup",()=>this.submit())}destroy(){super.destroy(),this.unsubscribe()}createChildren(){return this.grid.reduce((e,t,i)=>[...e,...t.map((e,t)=>this._createChild(new Vector(t,i),e))],[])}_createChild(e,t){return new Tile({pos:e.mul(21),size:new Vector(17,17),children:[new ColoredSprite({pos:new Vector(3,3),size:new Vector(11,11),asset:t})],onMousedown:function(){this.parent.select(this,t)},onMousemove:function(){this.parent.select(this,t)}})}replaceTiles(e,t=[0,0,0,0]){const i=e.reduce((e,t)=>(e[t.x].push(t),e),range(4).map(()=>[]));let s=0;i.forEach((e,i)=>{if(!e.length)return;const o=e.map((o,n)=>{const r=this.getTile(o),a=Animate.explode(this.getTile(o),{duration:200}),h=this.getIndexFromCoord(o);this.children[h]=null,this.children[this.children.length]=r,a.on("end",()=>{r.destroy()});const l=new Vector(i,-(e.length-n));return this._createChild(l,t[s++])}),n=range(3).map(e=>this.getTile(new Vector(i,e))).filter(Boolean);o.concat(n).forEach((t,s)=>{const n=new Vector(i,s),r=this.getIndexFromCoord(n);s<o.length?(t.opacity=0,this.addChild(t,r),Animate.fadeIn(t,{duration:200+100*e.length,delay:50*(3-(s+1))})):this.children[r]=t,Animate.slide(t,{duration:200+100*e.length,delay:50*(3-(s+1)),to:new Vector(21*i,21*s)})})})}getIndexFromCoord(e){return e.x+4*e.y}getCoordFromIndex(e){return new Vector(e%4,Math.floor(e/4))}getIndexFromTile(e){return this.children.findIndex(t=>t===e)}getTile(e){return this.children[this.getIndexFromCoord(e)]}getCoord(e){return this.getCoordFromIndex(this.getIndexFromTile(e))}getValue(e){return this.getTile(e).children[0].asset}getBorderingPositions(e,t=[]){const i=[];return e.y+1<this.grid.length&&i.push(new Vector(e.x,e.y+1)),e.y-1>=0&&i.push(new Vector(e.x,e.y-1)),e.x+1<this.grid[e.y].length&&i.push(new Vector(e.x+1,e.y)),e.x-1>=0&&i.push(new Vector(e.x-1,e.y)),i.filter(e=>!t.find(t=>t.equals(e)))}getEveryPossibleCoord(){return range(this.grid.length).reduce((e,t,i)=>e.concat(range(this.grid[i].length).map((e,t)=>new Vector(t,i))),[])}findCombination(e,t=[],i=null,s=0){if(s>=e.length)return!0;i||(i=this.getEveryPossibleCoord());for(let o of i)if(this.getValue(o)==e[s]){const i=this.findCombination(e,[...t,o],this.getBorderingPositions(o,t),s+1);if(i)return!0===i?[o]:[o,...i]}}getRandomCoords(e,t=[],i=null,s=0){if(s>=e)return!0;i||(i=this.getEveryPossibleCoord()),i=shuffle(i);for(let o of i){const i=this.getRandomCoords(e,[...t,o],this.getBorderingPositions(o,t),s+1);if(i)return!0===i?[o]:[o,...i]}}coordsToValue(e){return e.map(e=>this.getValue(e))}select(e,t){if(Input.isMouseDown&&this.tilesPlayed.length<this.get("combo").length){const i=this.getCoord(e);if(this.tilesPlayed.length){if(this.tilesPlayed.find(e=>e.equals(i)))return;const e=this.tilesPlayed[this.tilesPlayed.length-1];if(i.diff(e).length()>1)return}Sound.tileSelect(this.tilesPlayed.length),this.tilesPlayed.push(i),this.comboPlayed.push(t),e.accentColor=Color.yellow,e.children[0].accentColor=Color.yellow}}generateValue(){let e=this.generationsSince.findIndex(e=>e>4);return-1==e&&(e=Math.floor(4*Math.random())),this.generationsSince[e]=0,this.generationsSince.forEach((t,i)=>i!=e&&this.generationsSince[i]++),e}submit(){if(!this.tilesPlayed.length)return;const e=this.get("combo"),t=Array.from(e).reverse();e.length!=this.comboPlayed.length||serializeData(e)!=serializeData(this.comboPlayed)&&serializeData(t)!=serializeData(this.comboPlayed)?(this.tilesPlayed.map(e=>{const t=this.getTile(e);t.accentColor=null,t.children[0].accentColor=null,Animate.shake(t,{duration:200})}),Sound.wrongCombination()):(this.replaceTiles(this.tilesPlayed,range(e.length).map(()=>this.generateValue())),this.trigger("submit")),this.comboPlayed=[],this.tilesPlayed=[]}render(e){const t=e=>{const t=this.getTile(e),{pos:i,size:s}=t;return i.add(s.mul(.5))},i=(t,i)=>{e.beginPath(),e.strokeStyle=Color.yellow.toString(),e.lineWidth=5,e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.stroke()};this.tilesPlayed.forEach((e,s,o)=>{if(s){const n=o[s-1];i(t(n),t(e))}s==o.length-1&&i(t(e),Input.mousePos.diff(this.getGlobalPosition()))}),super.render(e)}}class Level extends GameObject{constructor({comboLength:e,name:t="",board:i="",time:s=0,...o}){super({name:t,comboLength:e,board:i,time:s,...o}),this.score=0,this.turn=-1,this.combo=[],this.nextTurn()}createChildren(){const e=new Vector(8,8),t=Game.viewRes.diff(e.mul(2));return[new Flexbox({pos:e,size:t,direction:"column",justify:"start",align:"start",spaceBetween:8,children:[new Score({id:"score",size:new Vector(t.x,7),score:()=>this.score}),new Combination({id:"combination",size:new Vector(t.x,11),combo:()=>this.combo}),new Countdown({id:"countdown",duration:this.time,size:new Vector(t.x,1),length:t.x,onCompleted:()=>this.gameOver()}),new GameBoard({id:"board",data:this.board,size:new Vector(t.x,59),combo:()=>this.combo,onSubmit:e=>this.onCombinationSubmit(e)}),new Button({id:"button",align:"center",text:"NOT FOUND",size:new Vector(Game.viewRes.x-16,17),playSounds:!1,onClick:()=>this.onCombinationNotFound()})]})]}gameOver(){this.combo=[],this.getChild("combination").trigger("next",!1),this.getChild("board").children.forEach((e,t)=>{Animate.slide(e,{duration:400,delay:50*(3-Math.floor(t/4)),to:e.pos.add(new Vector(0,30))})});Animate.fadeOut(this,{duration:400}).on("end",()=>this.destroy()),Game.root.getChild("main").addChild(new ResultsScreen({score:this.score,level:this}))}generateCombination(){return Math.random()>2/3?range(this.comboLength).map(()=>Math.floor(4*Math.random())):this.getChild("board").coordsToValue(this.getChild("board").getRandomCoords(this.comboLength))}nextTurn(){this.turn>=0&&(this.score++,Sound.score(),this.getChild("score").increment()),this.turn++,this.combo=this.generateCombination(),this.getChild("combination").trigger("next",!0)}onCombinationSubmit(){this.nextTurn()}onCombinationNotFound(){if(this.getChild("board").findCombination(this.combo)){const e=this.getChild("button");e.freezed=!0;new Timer(600).on("completed",()=>e.freezed=!1),this.getChild("countdown").reduceBy(2e3),Animate.shake(this.getChild("combination"),{duration:200}),Animate.shake(this.getChild("board"),{duration:200}),Sound.buttonLocked()}else this.combo.length&&this.nextTurn()}}class Score extends GameObject{constructor({score:e=0,...t}){super(t),this.score=e,this.labelObject=new GameText({text:()=>""+this.get("score"),align:"center",size:new Vector(Game.viewRes.x-16,0)}),this.addChild(this.labelObject)}increment(){const e=new GameText({text:"+1",color:Color.yellow,pos:new Vector(Math.round((Game.viewRes.x-16)/2+this.labelObject.getTextMetrics().x/2),0)});this.addChild(e);Animate.lift(e,{duration:1e3}).on("end",()=>e.destroy())}}class Arcade extends Level{constructor(e={}){super({...e,name:"ARCADE",comboLength:3,board:"e4 1b b4",time:6e4})}nextTurn(){this.turn>=0&&this.getChild("countdown").incrementBy(2e3),this.comboLength=Math.min(3+Math.floor((this.score+1)/10),6),super.nextTurn()}}window.localStorage.setItem("unlocked,3 IN A ROW",!0);class LevelsScreen extends GameObject{constructor(e={}){super({levels:[{name:"3 IN A ROW",comboLength:3,locked:!1,board:"c6 c6 c6",time:6e4},{name:"GET SQUARE",comboLength:4,locked:TrophyCase.getTrophy("3 IN A ROW").getBest()<=20,unlockCondition:"SCORE MORE THAN 20 POINTS IN '3 IN A ROW' TO UNLOCK",board:"55 55 55",time:6e4},{name:"HIGH FIVE",comboLength:5,locked:TrophyCase.getTrophy("GET SQUARE").getBest()<=15,unlockCondition:"SCORE MORE THAN 15 POINTS IN 'GET SQUARE' TO UNLOCK",board:"f1 78 1a",time:6e4},{name:"SIX PACK",comboLength:6,locked:TrophyCase.getTrophy("ARCADE").getBest()<=30,unlockCondition:"SCORE MORE THAN 30 POINTS IN ARCADE TO UNLOCK",board:"eb 69 28",time:6e4}],...e})}createChildren(){const e=new Vector(8,12),t=Game.viewRes.diff(e.mul(2));return[new Flexbox({pos:e,size:t,direction:"column",justify:"start",align:"start",spaceBetween:6,children:[new Area({size:new Vector(t.x/2,13),onClick:()=>this.back(),children:[new GameText({text:"< BACK"})]}),...this.levels.map((e,i)=>new Button({text:e.name,locked:e.locked,size:new Vector(t.x,17),onClick:()=>this.playLevel(i),onMount:function(){if(!this.locked&&!window.localStorage.getItem("unlocked,"+e.name)){const t=this.createLock();this.addChild(t),this.opacity=.5,Animate.explode(t,{duration:400,delay:400}),Animate.fadeIn(this,{duration:400,delay:400}),window.localStorage.setItem("unlocked,"+e.name,!0)}}}))]})]}async back(){const e=new Vector(Game.viewRes.x,0),t=new Menu({pos:e.mul(-1)});Sound.buttonClick(),Game.root.getChild("main").addChild(t);await Promise.all([Animate.slide(this,{duration:300,to:this.pos.add(e)}).promise,Animate.fadeOut(this,{duration:300}).promise,Animate.slide(t,{duration:300,to:new Vector}).promise,Animate.fadeIn(t,{duration:300}).promise]),this.destroy()}playLevel(e){const t=this.levels[e];if(t.locked){this.freezed=!0;const e=new Modal({text:t.unlockCondition});Game.root.getChild("main").addChild(e),e.on("close",()=>this.freezed=!1)}else Sound.buttonClick(),Game.root.getChild("main").addChild(new Level({...t})),this.destroy()}}class Menu extends GameObject{createChildren(){const e=new Vector(0,8),t=new Vector(8,8),i=new Title({id:"title",animate:this.animate}),s=Game.viewRes.diff(t.mul(2)).diff(e);return[new Flexbox({pos:e.add(t),size:new Vector(s.x,i.size.y),children:[i]}),new Flexbox({id:"body",pos:new Vector(e.add(t).x,e.add(t.mul(3)).add(i.size).y),size:s,align:"center",justify:"start",direction:"column",spaceBetween:6,children:[new Button({text:"LEVELS",size:new Vector(s.x,17),onClick:()=>this.browseLevels()}),new Button({text:"ARCADE",locked:TrophyCase.getTrophy("HIGH FIVE").getBest()<=10,size:new Vector(s.x,17),onClick:()=>this.playArcade(),onMount:function(){if(!this.locked&&!window.localStorage.getItem("unlocked,ARCADE")){const e=this.createLock();this.addChild(e),this.opacity=.5,Animate.explode(e,{duration:400,delay:400}),Animate.fadeIn(this,{duration:400,delay:400}),window.localStorage.setItem("unlocked,ARCADE",!0)}}}),new Button({text:"TROPHIES",size:new Vector(s.x,17),onClick:()=>this.browseTrophies()})]})]}comingSoon(){Game.root.getChild("main").addChild(new Modal({text:"COMING SOON"}))}async nextScreen(e,t=1){const i=Game.viewRes.x,s=new Vector(i*t,0),o=new e({pos:s});Game.root.getChild("main").addChild(o);await Promise.all([Animate.slide(this,{duration:300,to:this.pos.diff(s)}).promise,Animate.fadeOut(this,{duration:300}).promise,Animate.slide(o,{duration:300,to:new Vector}).promise,Animate.fadeIn(o,{duration:300}).promise]),this.destroy()}browseLevels(){this.nextScreen(LevelsScreen)}browseTrophies(){this.nextScreen(TrophiesScreen)}playArcade(){TrophyCase.getTrophy("HIGH FIVE").getBest()>10?(Sound.buttonClick(),Game.root.getChild("main").addChild(new Arcade),this.destroy()):Game.root.getChild("main").addChild(new Modal({text:"SCORE MORE THAN 10 POINTS IN 'HIGH FIVE' TO UNLOCK"}))}}class Flexbox extends GameObject{constructor({direction:e="row",spaceBetween:t=0,align:i="center",justify:s="center",...o}){super({direction:e,spaceBetween:t,align:i,justify:s,...o})}onChildrenChange(){const e="row"==this.direction?"x":"y",t="row"==this.direction?"y":"x",i=new Vector;i[e]=1;const s=this.children.reduce((e,t)=>e.add(t.size),new Vector),o=i.mul(this.spaceBetween),n=s.add(o.mul(this.children.length-1)),r=new Vector;"center"==this.justify?r[e]=this.size.mul(.5).diff(n.mul(.5))[e]:"end"==this.justify&&(r[e]=this.size.diff(n)[e]),this.children.forEach(i=>{"center"==this.align?r[t]=this.size.mul(.5).diff(i.size.mul(.5))[t]:"end"==this.align&&(r[t]=this.size.diff(i.size)[t]),i.pos=r.floor(),r[e]+=i.size[e]+o[e]})}}class Title extends GameObject{constructor({size:e=new Vector(45,17),animate:t=!1,...i}={}){super({size:e,animate:t,...i})}createChildren(){const e=this.animate?400:0,t=this.animate?400:0,i=function(){Animate.slide(this,{delay:t,duration:e,to:this.pos.diff(new Vector(20))})};new Timer(t);this.animate&&Sound.opening();const s=new Vector(this.size.x/2-8.5,0).floor();return[new Tile({pos:s,size:new Vector(17,17),onMount:i}),new Rectangle({pos:s.add(new Vector(16,3)),size:new Vector(1,11),color:Color.grey,onMount:i}),new Rectangle({pos:s.add(new Vector(16,3)),size:new Vector(1,11),opacity:0,onMount:function(){Animate.fadeIn(this,{delay:t,duration:e}),i.call(this)}}),new GameText({pos:s.add(new Vector(-31,5)),text:"NNECTION",onMount:function(){Animate.slide(this,{delay:t,duration:e,to:this.pos.add(new Vector(27))})}}),new Rectangle({pos:s.add(new Vector(0,3)),size:new Vector(1,11),color:Color.grey,onMount:i}),new Rectangle({pos:s.add(new Vector(0,3)),size:new Vector(1,11),opacity:0,onMount:function(){Animate.fadeIn(this,{delay:t,duration:e}),i.call(this)}}),new Rectangle({pos:s.add(new Vector(-Game.viewRes.x,3)),size:new Vector(Game.viewRes.x,11),onMount:i}),new GameText({pos:s.add(new Vector(2,5)),text:"C",onMount:function(){Animate.slide(this,{delay:t,duration:e,to:this.pos.diff(new Vector(26))})}}),new Rectangle({pos:s.add(new Vector(1,3)),size:new Vector(15,11),onMount:i}),new ColoredSprite({pos:s.add(new Vector(3,3)),size:new Vector(11,11),asset:"circle",onMount:i})]}}class OpeningScreen extends GameObject{createChildren(){return[new GameText({text:"FEDETIBALDO PRESENTS",size:Game.viewRes,pos:new Vector(8,Game.viewRes.y-11-7-8),opacity:0,onMount:async function(){await Animate.fadeIn(this,{duration:1e3}).promise,await Animate.fadeOut(this,{duration:1e3,delay:500}).promise,this.destroy()}}),new Flexbox({size:Game.viewRes,align:"center",justify:"center",direction:"row",spaceBetween:3,opacity:0,onMount:function(){const e=Animate.fadeIn(this,{duration:2400,delay:2500});e.on("start",()=>{this.addChildren(range(4).map(e=>new Tile({size:new Vector(17,17),createChildren:function(){return[this.createChild(e-1)]},createChild:e=>new ColoredSprite({pos:new Vector(3,3),size:new Vector(11,11),asset:Math.abs(e%4)}),onMount:function(){const t=new Timer(600*(e+1)),i=new Interval(0);let s=e-1;i.on("tick",()=>{e+1==4&&Sound.coming(),i.interval=t.progress/4/4,s=(s+1)%4,this.children[0].destroy(),this.addChild(this.createChild(s))}),t.on("completed",()=>{this.destroy(),i.stop()})}})))}),e.on("end",async()=>{const e=new Menu({animate:!0});e.freezed=!0;const t=e.getChild("title"),i=e.getChild("body");i.opacity=0,Sound.coming(),Game.root.getChild("main").addChild(e);const s=t.pos.clone(),o=Game.viewRes.mul(.5).diff(t.getGlobalPosition()).diff(t.size.mul(.5).round()),n=new Vector(s.x,o.y);t.pos=n,await Animate.slide(t,{duration:800,delay:1300,to:s}).promise,await Animate.fadeIn(i,{duration:400}),e.freezed=!1})}})]}}class TrophiesScreen extends GameObject{onMount(){this.listener=Input.on("scroll",({delta:e})=>{this.isFreezed()||(this.pos=this.pos.add(new Vector(0,e.y)),this.pos.y=Math.max(-316,Math.min(this.pos.y,0)))})}destroy(){this.listener(),super.destroy()}createChildren(){const e=new Vector(8,12),t=Game.viewRes.diff(e.mul(2));return[new Flexbox({pos:e,size:t,direction:"column",justify:"start",align:"start",spaceBetween:6,children:[new Area({size:new Vector(t.x/2,13),onClick:()=>this.back(),children:[new GameText({text:"< BACK"})]}),...TrophyCase.trophies.filter(e=>!(e instanceof Record)).map((e,i)=>{const s=!e.unlocked,o=new GameText({text:e.name,size:new Vector(t.x-10-(s?11:0),7)});return new Button({text:e.name,locked:s,size:new Vector(t.x,o.getTextMetrics().y+8),onClick:()=>this.openModal(e.message)})})]})]}openModal(e){this.freezed=!0;const t=new Modal({text:e});Game.root.getChild("main").addChild(t),t.on("close",()=>this.freezed=!1)}async back(){Sound.buttonClick();const e=new Vector(Game.viewRes.x,0),t=new Menu({pos:e.mul(-1)});Game.root.getChild("main").addChild(t);await Promise.all([Animate.slide(this,{duration:300,to:this.pos.add(e)}).promise,Animate.fadeOut(this,{duration:300}).promise,Animate.slide(t,{duration:300,to:new Vector}).promise,Animate.fadeIn(t,{duration:300}).promise]),this.destroy()}}function range(e){return new Array(e).fill(null).map((e,t)=>t)}function shuffle(e){for(var t,i,s=e.length;s;)i=Math.floor(Math.random()*s--),t=e[s],e[s]=e[i],e[i]=t;return e}!async function(){await Promise.all([gameFont.load(),assets.load()]),Game.root.addChildren([new GameObject({id:"main"}),new GameObject({id:"popup"})]),Game.root.getChild("main").addChild(+localStorage.getItem("logins")>1?new Menu({animate:!0}):new OpeningScreen),TrophyCase.updateTrophyStatus(),Game.play()}();