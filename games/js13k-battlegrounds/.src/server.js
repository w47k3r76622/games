'use strict';function mc(a,b){this.A=a;this.T=b;this.N=0;this.entities=[];this.K=[];this.currentTime=this.startTime=0}mc.prototype.ga=function(){this.currentTime=Date.now()/1E3-this.startTime};function nc(a,b){this.h=a;this.t=b}var oc=0,pc=[];function rc(a){var b=wc(!0);this.Wa=a;this.L=b;this.h=b.da(25,25);this.K=[]}rc.prototype.wa=function(){let a=this.L.b;a.ga();a.N=this.h.s;a.K.length=0;var b=this.K,c=a.K;0<b.length&&(c.push.apply(c,b),b.length=0);this.Wa.emit("update",a)};
function xc(){this.A=oc++;this.T=1E4*Math.random()|0;this.Sa=1;this.U=[];this.l=new ia(this.T);this.b=new mc(this.A,this.T);this.Ca=0;if(0!==this.A){for(var a=0;19>a;a++){var b=this.da(this.l.ca(),this.l.ca());b.name=ca();b.Ha=!0}a=this.l.$(6,40,.5);for(b=0;b<a.length;b++)this.Z(6,a[b].x,a[b].y,a[b].z);a=this.l.$(7,40,.5);for(b=0;b<a.length;b++)this.Z(7,a[b].x,a[b].y,a[b].z)}}l=xc.prototype;l.Ga=function(a){a.L&&a.L.ta(a);this.U.push(a);a.L=this;a.h=this.da(25,25)};
l.Z=function(a,b,c,e,d,g,h){a=new q(a,b,c,e,d,g,h);a.s=this.Sa++;this.b.entities.push(a);return a};l.da=function(a,b){a=this.Z(2,a,this.l.i(a,b)+1,b);a.I=30;a.o=0;a.g=0;a.pitch=0;return a};l.ta=function(a){var b=this.U;b.splice(b.indexOf(a),1);b=this.b.entities;b.splice(b.indexOf(a.h),1)};l.Y=function(a){for(let b=0;b<this.U.length;b++)this.U[b].K.push(a)};l.Qa=function(){this.b.ga();return-3>this.b.currentTime};
l.xa=function(a,b,c,e){if(!(0>=a.I)){var d=Math.hypot(b,c,e);b=b/d*10;c=c/d*10;e=e/d*10;d=this.Z(3,a.x,a.y+.5,a.z,b,c,e);d.w=a.s;a.o=10;a.I--;a=new q(13,d.x+.05*b,d.y+.05*c,d.z+.05*e);a.w=d.w;this.Y(a)}};l.Ia=function(a){var b=a.c,c=a.a,e=a.f,d=Math.hypot(b,c,e);const g=b/d,h=c/d;d=e/d;if(b=this.na(a,b,c,e))switch(c=b.h,e=b.t,c.v){case 2:c.j-=25,this.ha(c,a.w),this.Y(new q(14,a.x+e*g,a.y+e*h,a.z+e*d))}return!!b};
l.na=function(a,b,c,e){var d=Math.hypot(b,c,e);b/=d;c/=d;e/=d;let g=d,h=null;for(var f=0;f<this.b.entities.length;f++){var k=this.b.entities[f];if(!(2!==k.v||k.s===a.s||k.s===a.w||0>=k.j)){var n=yc(b,c,e,a.x-k.x,a.y-k.y,a.z-k.z,1,d);null!==n&&n<g&&(g=n,h=k)}}for(f=0;f<this.l.S.length;f++)k=this.l.S[f],n=yc(b,c,e,a.x-k.x,a.y-k.y,a.z-k.z,.8,d),null!==n&&n<g&&(g=n,h=k);for(f=0;f<this.l.M.length;f++)k=this.l.M[f],n=yc(b,c,e,a.x-k.x,a.y-(k.y-4.2),a.z-k.z,.8,d),null!==n&&n<g&&(g=n,h=k);for(d=0;d<g;d+=.1)if(a.y+
d*c<this.l.i(a.x+d*b,a.z+d*e)){g=d;h=da;break}return h?new nc(h,g):null};l.ha=function(a,b){if(0>=a.j){a.j=0;a.sa=ja(this.b)+1;let c=new q(15,a.x,a.y,a.z);c.s=a.s;c.w=b;this.Y(c)}};function yc(a,b,c,e,d,g,h,f){var k=a*a+b*b+c*c;a=2*(a*e+b*d+c*g);d=e*e+d*d+g*g-h*h;if(0>a*a-4*k*d)return null;e=(-1*a+Math.sqrt(Math.pow(a,2)-4*k*d))/(2*k);k=(-1*a-Math.sqrt(Math.pow(a,2)-4*k*d))/(2*k);return 0<=e&&e<f||0<=k&&k<f?Math.min(e,k):0<=e&&e<f?e:0<=k&&k<f?k:null}
l.V=function(a,b){let c=b.x-a.x;b=b.z-a.z;let e=Math.hypot(c,b);a.c=c/e*8/30;a.f=b/e*8/30;a.x+=a.c;a.z+=a.f;a.y=this.l.i(a.x,a.z)+1;a.g=Math.atan2(a.c,a.f)};l.Ma=function(a,b,c){a.c=a.a=a.f=0;let e=this.ba(a,2,40),d=this.ba(a,6,20,b),g=this.ba(a,4,40,c,this.l.M);ha(b,a)?this.V(a,c):0===a.o&&e?(this.V(a,e),this.xa(a,e.x-a.x+.2*Math.random()-.1,e.y-a.y+.2*Math.random()-.1,e.z-a.z+.2*Math.random()-.1)):d?this.V(a,d):ha(c,a)?this.V(a,c):g&&(b=Date.now()/3E3*2*m,this.V(a,{x:g.x+3*Math.cos(b),z:g.z+3*Math.sin(b)}))};
l.ba=function(a,b,c,e,d){let g=null;d=d||this.b.entities;for(let f=0;f<d.length;f++){let k=d[f];if(a!==k&&k.v===b&&0<k.j&&(!e||!ha(e,k))){var h=k.x-a.x;let b=k.y-a.y,d=k.z-a.z,e=Math.hypot(h,d);e<c&&(h=this.na(a,h,b,d),h&&h.h!==k||(g=k,c=e))}}return g};
l.update=function(){this.b.ga();if(0<=this.b.currentTime&&!(1>=ja(this.b))){var a=this.l.aa(this.b.currentTime),b=this.l.ka(this.b.currentTime);for(let e=this.b.entities.length-1;0<=e;e--){var c=this.b.entities[e];if(0>=c.j)continue;let d=!1;switch(c.v){case 2:0<c.o&&c.o--;c.Ha&&this.Ma(c,a,b);0==this.Ca%33&&ha(a,c)&&(c.j-=5,this.ha(c));break;case 3:this.Ia(c)&&(d=!0);c.x+=c.c;c.y+=c.a;c.z+=c.f;if(-500>c.x||500<c.x||-500>c.z||500<c.z)d=!0;break;case 6:case 7:let e=this.ba(c,2,1);e&&(6===c.v?e.I+=
30:e.j=Math.min(100,e.j+50),c=new q(16,c.x,c.y,c.z),c.w=e.s,this.Y(c),d=!0)}d&&this.b.entities.splice(e,1)}this.Ca++}};function wc(a){for(var b=a?0:1;b<pc.length;b++)if(a||pc[b].Qa())return pc[b];a=new xc;a.b.startTime=Date.now()/1E3+30;pc.push(a);return a}setInterval(function(){for(let a=pc.length-1;0<a;a--){let b=pc[a];0===b.U.length?pc.splice(a,1):b.update()}},33);
module.exports=function(a){const b=new rc(a);a.on("update",function(a){if(a&&void 0!==a.x&&void 0!==a.y&&void 0!==a.z){b.h.name=a.name;b.h.g=a.g;b.h.x=a.x;b.h.y=a.y;b.h.z=a.z;b.h.c=a.c;b.h.a=a.a;b.h.f=a.f;if(a.actions)for(let c=0;c<a.actions.length;c++){const d=a.actions[c];switch(d.v){case 8:wc().Ga(b);break;case 9:b.L.xa(b.h,d.c,d.a,d.f)}}b.wa()}});a.on("disconnect",function(){b.L.ta(b)});b.wa()};
