"use strict";class Vec{constructor(x=0,y=0){this.x=x;this.y=y;this.m;return this};copy(v){this.x=v.x;this.y=v.y;return this};vFrD(d){this.x=Math.cos(d);this.y=Math.sin(d);return this};clear(){this.x=0;this.y=0;return this};add(v){this.x+=v.x;this.y+=v.y;return this};sub(v){this.x-=v.x;this.y-=v.y;return this};scale(n){this.x*=n;this.y*=n;return this};dir(v){return Math.atan2(this.y,this.x)};dist(v){return Math.sqrt(Math.pow(v.x-this.x,2)+Math.pow(v.y-this.y,2))};mag(){this.m=Math.sqrt(this.x*this.x+this.y*this.y);return this.m};unit(){this.mag();this.x/=this.m;this.y/=this.m;this.m=1;return this};dotPrd(v){v.unit();return this.x*v.x+this.y*v.y};project(v,out){this.m=this.dotPrd(v);out.x=this.m*v.x;out.y=this.m*v.y;return out};perp(){this.m=this.x;this.x=this.y;this.y=-this.m;return this};limit(n){this.mag();if(this.m>n){this.unit();this.scale(n)}
return this}};class Obj{constructor(type='brick',round=!1,w,h){this.id=_id++,this.pos=new Vec();this.w=w||0;this.h=h||0;this.pos2=new Vec();this.vel=new Vec();this.acc=0.6;this.min=256;this.max=256;this.round=round;this.type=type;this.energy=0;this.time=0;this.reserve=0;this._centre=new Vec();this._collis={}};setBP(){_fW=512/11;_i=Math.floor(this.pos.y/_fW);this.rows=[_i,((this.pos.y%_fW)/_fW>=0.5?_i+1:_i-1)]
_i=Math.floor(this.pos.x/_fW);this.cols=[_i,((this.pos.x%_fW)/_fW>=0.5?_i+1:_i-1)]};update(fT){this.setBP();this.vel.limit(this.max);_tVec.copy(this.vel).scale(fT/1000);switch(this.type){case 'particle':this.vel.y+=5*fT/1000;this.energy-=fT;this.min=this.energy/this.max;if(this.energy<=0)
particlesI.push(particlesA.splice(particlesA.indexOf(this),1));break;case 'ball':if(this.pos.dist(this.pos2)<0.5){if(this.pos.y>500)
ball.pos.y=500;if(this.pos.x<12)
this.pos.x=12;if(this.pos.x>500)
this.pos.x=500}
this.pos2.copy(this.pos);_tVec.scale(1+Math.min(this.max,this.energy/2000*this.max)/this.max);if(this.vel.mag()<this.max)
this.vel.unit().scale(this.max);if(Math.abs(this.vel.mag())<this.min)
this.vel.unit().scale(this.min);if(this.energy<0)
this.energy=0;if(Math.random()>(1-this.energy/10000)/2-0.2)
addParticle([this.pos,300,{x:0,y:0},Math.min(11,1+11*this.energy/10000)/12,2,1,0.3])
break;case 'brick':if(this.time){this.collis=[];_fW=0;for(_i=-1;_i<2;_i++){for(_j=-1;_j<2;_j++){if(brickL[this.col+_i]&&brickL[this.col+_i][this.row+_j])
_fW=brickL[this.col+_i][this.row+_j];if(_fW&&_fW.id!==this.id)this.collis.push(_fW)}}
this.collis.sort((a,b)=>Math.abs(this.colour-a.colour)<Math.abs(this.colour-b.colour));this.collis.forEach((b,i)=>{if(this.energy>b.energy){if(Math.abs(this.colour-b.colour)<0.12||Math.abs(this.colour-b.colour)>0.41){b.energy+=(1/this.collis.length)*5*this.energy*fT/1000}}});this.collis.length=0;this.energy*=1-(1*fT/1000)
if(((gameTime-this.min)/this.time)>1){this.time=0;score+=Math.floor(1000*((1-gameTime/200000)/2+0.5));playBuffer(0.1,'test',72)
for(_i=0;_i<Math.min(100,this.energy/20);_i++){_tVec2.vFrD(Math.floor(Math.random()*4)*(pi/2)).scale(Math.sqrt(this.energy)*3);addParticle([{x:this.pos.x+Math.random()*this.w-this.w/2,y:this.pos.y+Math.random()*this.h-this.h/2},300,_tVec2,this.colour,1,0.5,0.3])}
bricksI.push(bricksA.splice(bricksA.indexOf(this),1));delete brickL[this.col][this.row]}}else{this.pos2.x=Math.floor(7-Math.min(this.energy/100,1)*7)*32
if(this.energy>=100){this.energy-=100;this.time=500-gameTime%500+Math.floor(Math.random()*2)*125;if(this.time<250)
this.time+=250;this.min=gameTime}else this.energy=Math.max(0,this.energy-fT/20)}
this.rows.forEach(r=>{if(!bp[r])bp[r]=[];this.cols.forEach(c=>{if(!bp[r][c])bp[r][c]=[];bp[r][c].push(this)})});if(this.acc>0){this.acc-=fT;if(this.acc<0)
this.acc=0}
break;case 'player':if(this.reserve>10){this.energy+=this.reserve*0.6;this.reserve*=0.4}
break};this.pos.add(_tVec)};render(ctx){_ctx.save();_ctx.translate(this.pos.x,this.pos.y);_ctx.fillStyle='red';switch(this.type){case 'particle':_i=Math.max(Math.min(1,ease[3](this.min)),0)*this.time;_ctx.save();_ctx.scale(_i,_i);_ctx.globalCompositeOperation='add';_ctx.globalAlpha=this.collis;_i=Math.floor(this.colour*12);_ctx.drawImage(images['p'+this.reserve],32*(_i%4),32*Math.floor(_i/4),32,32,-16,-16,32,32);_ctx.restore();break;case 'ball':this.time+=this.vel.dir()/4;_ctx.save();_ctx.rotate(this.time);_ctx.drawImage(images.ball,-9,-9);_ctx.restore();break;case 'brick':_ctx.drawImage(images['b'+((Math.floor(this.colour*7)+colourOffset)%12)],this.pos2.x,Math.floor(Math.max(0,(Math.min(100,this.acc))/100)*7)*32,32,32,-this.w/2,-this.h/2,this.w,this.h);break;case 'player':_i=ease[2](Math.min(0.999,this.energy/10000))*100;_ctx.drawImage(images.player,Math.min(896,Math.floor(_i/20)*128),Math.floor(_i%20)*25,128,24,-this.w/2,-this.h/2,this.w,this.h);break};_ctx.restore()};get centre(){return this._centre.copy(this.pos)};get TL(){_tVec.x=this.pos.x-this.HW;_tVec.y=this.pos.y-this.HH;return _tVec};get TR(){_tVec.x=this.pos.x+this.HW;_tVec.y=this.pos.y-this.HH;return _tVec};get BL(){_tVec.x=this.pos.x-this.HW;_tVec.y=this.pos.y+this.HH;return _tVec};get BR(){_tVec.x=this.pos.x+this.HW;_tVec.y=this.pos.y+this.HH;return _tVec}
get HW(){return this.w/2};get HH(){return this.h/2}}
let scale,Canvas=(w,h,context='2d')=>{let cnv=document.createElement('canvas'),ctx=cnv.getContext(context);cnv.width=w;cnv.height=h;cnv.context=ctx;return cnv},makeRGrad=(o)=>{_ctx=o[0];_fW=_ctx.createRadialGradient(o[1][0],o[1][1],o[1][2],o[1][3],o[1][4],o[1][5]);for(_k=2;_k<o.length;_k++)
_fW.addColorStop(o[_k][0],[o[_k][1]]);return _fW},hillNoise,hillNumber=0,drawHill=(img)=>{_ctx=images[img].context;_ctx.clearRect(0,0,1024,1024);_ctx.strokeStlye='darkgreen';_ctx.fillStyle='green';_ctx.beginPath();_ctx.moveTo(0,1024);_ctx.lineTo(0,hillNoise[0][0]*4)
for(_i=1;_i<32;_i++){_ctx.quadraticCurveTo(_i*32,hillNoise[_i][hillNumber]*4,_i*32+16,((hillNoise[_i][hillNumber]+hillNoise[(_i+1)%32][hillNumber])/2)*4)}
_ctx.lineTo(1023-16,1023);_ctx.closePath();_ctx.stroke();_ctx.fill();_ctx.save();_ctx=images.dmy.context;_ctx.clearRect(0,0,1024,1024);_ctx.drawImage(images[img],0,0);_ctx.globalCompositeOperation='multiply';_ctx.drawImage(images.hG,0,0);_ctx=images[img].context;_ctx.globalCompositeOperation='source-atop';_ctx.drawImage(images.dmy,0,0);_ctx.globalCompositeOperation='destination-over';_ctx.fillStyle='blue';_ctx.fillRect(0,562,1008,462);_ctx.restore();hillNumber=(hillNumber+1)%32},drawAssets=o=>{BG.style.left=innerWidth/2-512+'px';BG.style.top=innerHeight/2-512+'px';for(_i=0;_i<8;_i++){hills.push(new Obj('hill'))};hills.forEach((h,i)=>{h.w=1024;h.h=1024;h.pos.y=(i/8)*512;h.acc=i});let img=Canvas(256,256);_ctx=img.context;images.bgN=Canvas(512,512);makeNoise(images.bgN.context,null,512,1/64,4,(n,x,y)=>[n,n,n]);images.bgM=Canvas(512,512);_ctx=images.bgM.context;for(_i=0;_i<512;_i++){for(_j=0;_j<512;_j++){_k=(_j<51?_j/50:1)*Math.max(_i<51?1-_i/50:(_i>462?1-(511-_i)/50:0),_j>462?1-(511-_j)/50:0);_ctx.fillStyle='rgba(0,0,0,'+_k+')';_ctx.fillRect(_i,_j,1,1)}}
images.bg=Canvas(1024,1024);_ctx=images.bg.context;for(_i=0;_i<4;_i++){_ctx.drawImage(images.bgN,_i%2*512,Math.floor(_i/2)*512)}
images.n0=Canvas(32,32);makeNoise(images.n0.context,null,32,1/32,2,(n,x,y)=>{n=Math.min(n*((x<9?x/8:(x>23?(31-x)/8:1))*0.9+0.1),n*((y<9?y/8:(y>23?(31-y)/8:1))*0.9+0.1));return[n,n,n]});for(_k=0;_k<12;_k++){images['b'+_k]=Canvas(256,256);_ctx=images['b'+_k].context;for(_i=0;_i<8;_i++){for(_j=0;_j<8;_j++){_ctx.globalAlpha=0.6*_i/8+0.4;_ctx.drawImage(images.n0,_i*32+1,_j*32+1,30,30);_ctx.globalAlpha=1;_ctx.globalCompositeOperation='multiply';_fW=ease[1](_k/12)*360;_ctx.fillStyle='hsl('+((1-_j/8)*_fW+(_j/8)*(ease[0](_k/12)*330+180))+','+(_j/8*20+80)+'%,'+(100-100/16*(_i+1))+'%)';_ctx.fillRect(_i*32+1,_j*32+1,30,30)}}}
images.n1=Canvas(128,24);makeNoise(images.n1.context,null,128,1/64,6,(n,x,y)=>{n=Math.min(n*(x<11?x/10:(x>117?(127-x)/10:1)),n*(y<11?y/10:(y>13?(24-y)/10:1)));return[n,n,n]});images.player=Canvas(1024,512);_ctx=images.player.context;for(_i=0;_i<100;_i++){_j=Math.floor(_i/20)*128;_ctx.fillStyle=makeRGrad([_ctx,[_j+64,(_i%20)*25+12,(_i/100)*54+10,_j+64,(_i%20)*25+12,0],[0,'hsl(100,80%,30%)'],[1,'hsl(120,100%,50%)']]);_ctx.fillRect(_j+1,(_i%20)*25+1,126,24);_ctx.save();_ctx.globalCompositeOperation='multiply';_ctx.globalAlpha=0.8-(_i/100)*0.8;_ctx.drawImage(images.n1,_j+1,(_i%20)*25+1);_ctx.restore()}
images.ball=Canvas(18,18);_ctx=images.ball.context;_fW=makeRGrad([_ctx,[8,8,8,8,8,0],[0,'grey'],[1,'white']]);_ctx.fillStyle=_fW;_ctx.beginPath();_ctx.arc(9,9,8,0,Math.PI*2);_ctx.fill();hillNoise=makeNoise(null,[],32,1/32,6,n=>n);images.hG=Canvas(1024,1024);images.dmy=Canvas(1024,1024);_ctx=images.hG.context;_ctx.fillStyle=makeRGrad([_ctx,[512,0,1024,512,0,0],[0,'rgba(0,0,0,0.8)'],[0.7,'rgba(0,0,0,0)']]);_ctx.drawImage(images.bg,0,0,1024,4096);_ctx.globalCompositeOperation='destination-in';_ctx.fillRect(0,0,1023,1023);for(_j=0;_j<8;_j++){images['h'+_j]=Canvas(1024,1024);drawHill('h'+_j)}
_ctx=images.dmy.context;_ctx.clearRect(0,0,1024,1024);_ctx.fillStyle=makeRGrad([_ctx,[512,1024,1024,512,1024,0],[0,'darkblue'],[0.55,'rgba(0,0,0,0)']]);_ctx.fillRect(0,0,1024,1024);_ctx.globalCompositeOperation='source-atop';_ctx.drawImage(images.bg,0,0);images.sG=Canvas(1024,1024);_ctx=images.sG.context;_ctx.fillStyle=makeRGrad([_ctx,[512,1024,1024,512,1024,0],[0,'darkblue'],[0.7,'cornflowerblue']]);_ctx.fillRect(0,0,1024,1024);_ctx.globalAlpha=0.4;_ctx.globalCompositeOperation='screen';_ctx.drawImage(images.dmy,0,0);for(_i=0;_i<4;_i++)
images['p'+_i]=Canvas(128,128);_ctx=images.p0.context;for(_k=0;_k<12;_k++){for(_i=0;_i<32;_i++){for(_j=0;_j<32;_j++){_ctx.fillStyle='hsla('+330*_k/12+',100%,50%,'+ease[2](1-(Math.abs(_i-16)/16))*ease[2](1-(Math.abs(_j-16)/16))+')';_ctx.fillRect(_i+(_k%4)*32,_j+Math.floor(_k/4)*32,1,1)}}}
_ctx=images.p1.context;for(_k=0;_k<12;_k++){for(_i=0;_i<16;_i++){for(_j=0;_j<16;_j++){_ctx.fillStyle='hsla('+330*_k/12+',100%,50%,'+Math.min(1,1.1*ease[3]((_i/16)*(_j/16)))+')';_ctx.fillRect(_i+(_k%4)*32,_j+Math.floor(_k/4)*32,1,1);_ctx.fillRect(31-_i+(_k%4)*32,_j+Math.floor(_k/4)*32,1,1);_ctx.fillRect(_i+(_k%4)*32,31-_j+Math.floor(_k/4)*32,1,1);_ctx.fillRect(31-_i+(_k%4)*32,31-_j+Math.floor(_k/4)*32,1,1)}}}
images.p2=Canvas(256,256);_ctx=images.p2.context;for(_i=0;_i<12;_i++){_ctx.fillStyle='rgba(255,'+255*(_i+1)/12+','+255*(_i+1)/12+',0.5)'
_ctx.beginPath();_ctx.arc(16+(_i%4)*32,16+Math.floor(_i/4)*32,7,0,tau,!1);_ctx.fill()}},_ctx,_fW,_i,_j,_k,_id=0,_tVec=new Vec(),_tVec2=new Vec(),_tBrick=new Obj(),_touch,paused=!1,timePaused=0,lastT=0,deltaT=0,simT=1000/60,simulate=timeStamp=>{if(!paused){deltaT+=timeStamp-lastT;lastT=timeStamp;begin(timeStamp);while(deltaT>simT){deltaT-=simT;update(simT)}
render()}else{deltaT+=timeStamp-lastT;lastT=timeStamp;while(deltaT>simT){deltaT-=simT;timePaused+=simT}}
requestAnimationFrame(simulate)},mtv=new Vec(),collision=(o1,o2)=>{mtv.clear();if(o1.round||o2.round){if(o1.round&&o2.round)
return CvC(o1,o2);else if(!o1.round)
return CvR(o2,o1);else return CvR(o1,o2,!0)}else{return RvR(o1,o2)}},dist,hWs,hHs,over=new Vec(),RvR=(o1,o2,invert)=>{dist=o1.centre.sub(o2.centre);hWs=o1.w/2+o2.w/2;hHs=o1.h/2+o2.h/2;if(Math.abs(dist.x)<hWs){if(Math.abs(dist.y)<hHs){over.x=hWs-Math.abs(dist.x);over.y=hHs-Math.abs(dist.y);if(over.x>over.y){if(dist.y>0){mtv.y=over.y}else{mtv.y=-over.y}}else{if(dist.x>0){mtv.x=over.x}else{mtv.x=-over.x}};if(invert)mtv.scale(-1);return!0}}
return!1},len,quadC,quadP,dirP,distP,quadrants={0:'BR',1:'BL','-1':'TR','-2':'TL',2:'TL'},CvR=(c,r,invert)=>{dist=c.centre.sub(r.centre);len=c.w/2+_tVec.copy(r.TL).sub(r.centre).mag();if(dist.mag()<len){quadC=quadrants[Math.floor(dist.dir()/Math.PI*2)];distP=c.centre.sub(r[quadC]);dirP=Math.floor(distP.dir()/Math.PI*2);quadP=quadrants[dirP];if(quadP===quadC){if(distP.mag()<c.w/2){mtv.copy(distP).unit().scale(c.w/2-distP.mag());if(invert)mtv.scale(-1);return!0}
return!1}else return RvR(c,r,!0)}},CvC=(o1,o2)=>{dist=o1.centre.sub(o2.centre);hWs=o1.w/2+o2.w/2;if(dist.mag()<hWs){mtv.copy(dist).unit().scale(hWs-dist.mag());return!0}
return!1},prj1=new Vec(),prj2=new Vec(),Bounce=v=>{prj1=v.project(mtv.perp(),prj1);prj2=v.project(mtv.perp().unit(),prj2).scale(-1);return v.copy(prj1.add(prj2))},initControls=()=>{addEventListener('mousemove',mouseHandler,!1);addEventListener('mousedown',mouseHandler,!1);addEventListener('mouseup',mouseHandler,!1);addEventListener('touchstart',mouseHandler,!1);addEventListener('touchend',mouseHandler,!1);addEventListener('touchmove',mouseHandler,!1);addEventListener('resize',resize,!1);socket.on('hiScores',s=>{hiScores=s});socket.emit('getScores');setTimeout(()=>{if(!hiScores)
socket.emit('getScores')},2000);socket.on('place',p=>{console.log('you placed ',p[0]+1,p[1]);hiScores=p[1];render()})},keyHandler=e=>{if(e.keyCode==32){if(!paused)
paused=!0;else paused=!1}},mouse={x:0,y:0},tapHit=(n,t)=>{tapHits.push([n,t])},mouseHandler=e=>{if(e.touches&&e.touches[0]){mouse.x=(e.touches[0].clientX-field.pos.x)/scale;mouse.y=e.touches[0].clientY}else{mouse.x=(e.clientX-field.pos.x)/scale;mouse.y=e.clientY}
if(!dO&&(e.type==='mousedown'||e.type==='touchstart')){switch(gameState){case 0:if(mouse.y>field.pos.y+256&&mouse.x>150&&mouse.x<350){_fW=window.open('','Title');_i='<h3>BeatBricks High Scores</h3><ul>';if(hiScores){hiScores.forEach(s=>{_i+='<li><p>'+s.s+': '+s.n+'</li>'})}
_i+='</ul>';_fW.document.body.innerHTML=_i}else{if(!ready)
start();else{if(!starting){starting=!0;setup()}}}
break;case 1:_j=performance.now();_i=Math.floor(_j-tapTime);if(_i>230&&_i<270){tapHit(300,_j)}
else if(_i>470&&_i<530){tapHit(750,_j)}
else if(_i>950&&_i<1050){tapHit(1500,_j)}
tapTime=_j|0;break}}},submitHS=()=>{hsName=document.getElementById('name').value;if(hsName){localStorage.bbHiName=hsName;socket.emit('submitScore',{n:hsName,s:score});hsDiv.style.display='none';dO=!1}},cancelHS=()=>{hsDiv.style.display='none';dO=!1},aCtx,socket=io({upgrade:!1,transports:["websocket"]}),dO=!1,hiScores,gameState=0,ready=!1,starting=!1,hiScore=localStorage.bbHiScore||0,hsDiv=document.getElementById('subScoreDiv'),hsName=localStorage.bbHiName,score=hiScore,gameTime=0,overTime=0,tapTime=0,tapHits=[],_tH,hitTime=0,beat=0,maxD=1.5,BG=Canvas(1024,1024),screen=Canvas(innerWidth,innerHeight),hills=[],levelMap=[],colourOffset=0,images={},field=new Obj('field',0,512,512),player=new Obj('player'),bgPos=new Vec(),ball=new Obj('ball',!0),brick=new Obj('brick'),bricksA=[],bricksI=[],brickL={},rowNum=0,particlesA=[],particlesI=[],intrvl,intCount=-1,dNote,bp=[],controlTimer=0,printed=!1,start=()=>{if(!aCtx){aCtx=new(window.AudioContext||window.webkitAudioContext)();prepareSounds()}
ready=!0},gameOver=(state)=>{for(_i=bricksA.length-1;_i>=0;_i--)
bricksI.push(bricksA.splice(_i,1))
Y=0.5;gameState=state},setup=(s)=>{randomMessage=(randomMessage+1)%messages.length;localStorage.bbMessageNumber=randomMessage;colourOffset=Math.floor(Math.random()*9)+10;_tVec.x=0.5;_tVec.y=0.5;makeNoise(null,levelMap,16,1/4,4,n=>{if(n/256<_tVec.x)
_tVec.x=n/256;if(n/256>_tVec.y)
_tVec.y=n/256
return n/256},1,2);for(_i=0;_i<16;_i++){for(_j=0;_j<16;_j++){levelMap[_i][_j]=(1/(_tVec.y-_tVec.x))*(levelMap[_i][_j]-_tVec.x)}}
player.pos.x=192;player.pos.y=512;player.w=128;player.h=24;player.max=1000;player.energy=0;mouse.x=256;ball.w=16;ball.h=16;ball.pos.x=235;ball.pos.y=200;ball.energy=0;ball.vel.x=1;ball.vel.y=0;gameTime=0;brickL={};score=0;setTimeout(()=>{gameState=4;gameTime=-4000;starting=!1},1000)},W,H,Y=0.5,resize=()=>{W=innerWidth;H=innerHeight;screen.width=W;screen.height=H;if(W*1.2>H)
scale=(H*0.75)/512;else scale=0.9*W/512;field.pos.x=W/2-field.w*scale/2;field.pos.y=Y*H-field.h*scale/2;BG.style.left=innerWidth/2-512+'px';BG.style.top=innerHeight/2-512+'px'},addRow=()=>{for(_i=0;_i<16;_i++){if(bricksI.length>0)
_tBrick=bricksI.pop()[0];else _tBrick=new Obj('brick');_tBrick.pos.x=_i*32+16;_tBrick.pos.y=-16
_tBrick.pos2.x=7*32;_tBrick.w=30;_tBrick.h=30;_tBrick.vel.y=5.4;_tBrick.col=_i;_tBrick.row=rowNum;_tBrick.acc=0;_tBrick.time=0;_tBrick.energy=0;_tBrick.reserve=0;_tBrick.min=null;_tBrick.colour=levelMap[_i][rowNum];bricksA.push(_tBrick);if(!brickL[_i])brickL[_i]={};brickL[_i][rowNum]=_tBrick}
rowNum++},addParticle=o=>{_fW=particlesI.pop();if(!_fW)
_fW=new Obj('particle');else _fW=_fW[0];_fW.pos.copy(o[0]);_fW.energy=o[1];_fW.max=o[1];if(o[2]){_fW.vel.copy(o[2]);_fW.vel.scale(0.8+Math.random()*0.4)}
_fW.colour=o[3]||'white';_fW.reserve=o[4];_fW.time=o[5];_fW.collis=o[6];particlesA.push(_fW)},begin=tS=>{switch(gameState){case 0:_i=Math.floor(gameTime/500)%11;if(_i!==rowNum){rowNum=_i;if(ready)
playBuffer(0.1,'tick')}
break;case 1:if((gameTime>100000&&bricksA.length===0)||gameTime>200000){gameOver(3);if(score>hiScore){localStorage.bbHiScore=score|0;hiScore=score}}
if(rowNum==(Math.floor(gameTime/6000))&&rowNum<16){addRow();if(rowNum==1){bricksA.forEach(b=>b.pos.y+=gameTime/1000*b.vel.y)}}
if(rowNum==16)
setTimeout(()=>{bricksA.forEach(b=>b.vel.clear())},3000);if(aCtx&&Math.floor(gameTime/250)%16!==beat){beat=Math.floor(gameTime/250)%16;_i=Object.keys(brickL[beat]?brickL[beat]:0)
if(_i.length){brickL[beat][_i[_i.length-1]].acc=(beat==0||beat==8?300:150);playBuffer((beat%4===0?0.4:0.1),'tick');_fW=[];_i.forEach(el=>{switch(el){case rowNum-4+'':case rowNum-7+'':case rowNum-8+'':if(Math.random()>0.8){playBuffer(0.3,'high',60+minor[Math.floor(Math.random()*8)]);brickL[beat][el].acc=500}
break;case rowNum-2+'':case rowNum-3+'':if(Math.random()>0.8){playBuffer(0.1,'drum')
brickL[beat][el].acc=250}
break;case rowNum-5+'':case rowNum-10+'':case rowNum-12+'':if(Math.random()>0.8){playBuffer(0.2,'mid',42+minor[Math.floor(Math.random()*8)]);brickL[beat][el].acc=250}
break;case rowNum-6+'':case rowNum-9+'':case rowNum-11+'':if(intCount<0&&Math.random()>0.8){intCount=0;dNote=36+minor[Math.floor(Math.random()*3)];intrvl=setInterval(()=>{playBuffer(0.1,'drone',dNote);if(brickL[beat][el])
brickL[beat][el].acc=1000;intCount++;if(intCount>32){clearInterval(intrvl);intCount=-1}},62.5)}
break}})}}
while(tapHits.length){_tH=tapHits.shift();hitTime=_tH[1];player.reserve+=_tH[0];for(_j=0;_j<20;_j++){_tVec2.copy(player.pos);_tVec2.x+=Math.random()*player.w-player.w/2;_tVec2.y+=Math.random()*player.h/2-player.h/4;addParticle([_tVec2,100,{x:0,y:0},4/12,1,_tH[0]/1000,0.1])}}
break;case 2:if(gameTime>0)
gameTime=-2050;if(gameTime>-50)
gameState=0;break;case 3:if(gameTime>0){gameTime=-5050;dO=!0;hsDiv.style.display='block';hsDiv.style.top='1%';hsDiv.style.left=innerWidth/4+'px';hsDiv.children[0].innerHTML='Submit your score of '+score;if(hsName)
hsDiv.children[2].value=hsName}
if(gameTime>-50)
gameState=0;break;case 4:if(gameTime>-50){rowNum=0;gameState=1}
break}},update=fT=>{gameTime+=fT;if(gameState==1){hills.forEach((h,i)=>{h.pos.y+=i/8;if(h.min<1)
h.min+=fT/2000});_fW=hills[7];if(_fW.pos.y>512){_fW.pos.y=0;drawHill('h'+_fW.acc);_fW.min=0;hills.unshift(hills.pop())}
if(controlTimer<=0){controlTimer=0;_i=mouse.x-player.centre.x;if(Math.abs(_i)>player.w/10){player.vel.x+=_i*player.acc}else player.vel.scale(0.55)}else controlTimer-=fT;bp=[];player.update(fT);ball.update(fT);bricksA.forEach(b=>{b.update(fT)});particlesA.forEach(p=>p.update(fT));if(player.pos.x>512){player.pos.x=512;player.vel.clear()}
if(player.pos.x<0){player.pos.x=0;player.vel.clear()}
ball.collis={};ball.rows.forEach(r=>{ball.cols.forEach(c=>{if(bp[r]&&bp[r][c]&&bp[r][c].length){bp[r][c].forEach(i=>{ball.collis[i.id]=i})}})})
ball.bounced=!1;for(_i in ball.collis){if(collision(ball,ball.collis[_i])){_k=Math.max(300,ball.energy*0.9);for(_j=0;_j<10;_j++){_tVec2.vFrD(mtv.dir()+pi+Math.random()*pi-pi/2).scale(Math.sqrt(_k)*2);addParticle([ball.pos,500,_tVec2,ball.collis[_i].colour,0,0.6,1])}
playBuffer(0.1,'test',60);ball.pos.sub(mtv);Bounce(ball.vel);ball.collis[_i].energy+=_k;ball.energy*=0.2;ball.bounced=!0}}
ball.collis={};if(collision(ball,player)){ball.pos.sub(mtv);if(performance.now()-hitTime>500){playBuffer(Math.min(0.1,player.energy/100000)+0.01,'bounce',42);ball.energy+=player.energy;player.energy=0}
Bounce(ball.vel);_i=(ball.vel.dir()+player.vel.x/1000*maxD);_j=Math.min(Math.max((_i>0?-_i:_i),-2.84),-0.3);if(_i>0)
_j*=-1;ball.vel.vFrD(_j);player.vel.clear();controlTimer=100}
if(ball.pos.y<8){ball.vel.y=Math.abs(ball.vel.y);playBuffer(0.01,'bounce',49);Y-=0.01}
if(ball.pos.y>504){ball.vel.y=-Math.abs(ball.vel.y);playBuffer(0.01,'bounce',41);Y=Math.max(0,Y+0.01);if(Y>0.99)gameOver(2);if(Y<0)Y=0}
field.pos.y=Y*(innerHeight-field.h*scale);if(ball.pos.x<8){playBuffer(0.01,'bounce',47);_i=ball.vel.dir();if(_i<=pi&&_i>pi-pi/16)
ball.vel.vFrD(_i-pi/32)
ball.vel.x=Math.abs(ball.vel.x)}
if(ball.pos.x>504){playBuffer(0.01,'bounce',47);_i=ball.vel.dir();if(_i>=0&&_i<pi/16)
ball.vel.vFrD(_i+pi/32);ball.vel.x=-Math.abs(ball.vel.x)}}},drawBG=(a=1)=>{_ctx=BG.context;_ctx.clearRect(0,0,1024,1024);_ctx.drawImage(images.sG,-512+(Math.sin(gameTime/30000)*256),0,2048,800);hills.forEach((h,i)=>{_ctx.save();_i=(0.9*h.pos.y/512+0.1)/2;_ctx.scale(_i+1,1);_ctx.globalAlpha=h.min;_ctx.drawImage(images['h'+h.acc],-1024*_i/4,h.pos.y);_ctx.restore()})
_ctx.fillStyle='rgba(0,0,0,'+Math.max(0,1-a)+')';_ctx.fillRect(0,0,1024,1024)},render=()=>{_ctx=screen.context;_ctx.fillStyle='green';_ctx.clearRect(0,0,innerWidth,innerHeight);_ctx.save();_ctx.translate(field.pos.x,field.pos.y);_ctx.scale(scale,scale);if(gameState!==4){_ctx.save();_ctx.globalAlpha=0.5;_ctx.drawImage(images.bg,-256+Math.sin(gameTime/5000)*40,-256+Math.cos(gameTime/5000)*40);_ctx.globalCompositeOperation='destination-in';_ctx.drawImage(images.bgM,0,0);_ctx.restore()}
_ctx.textAlign='center';switch(gameState){case 0:BG.context.clearRect(0,0,BG.width,BG.height);_fW='BEAT BRICKS';for(_i=0;_i<_fW.length;_i++){if(rowNum===_i){_ctx.font='46px arial';_ctx.fillStyle='rgb(0,255,0)'}else{_ctx.font='42px arial';_ctx.fillStyle='white'}
_ctx.fillRect(256+40*_i-40*6-18+field.w*0.075,61,38,38)
_ctx.fillStyle='red';_ctx.fillText(_fW[_i],256+40*_i-40*6+field.w*0.075,96)}
_ctx.font='16px arial'
_ctx.fillText('~by KeithK',430,128);if(!ready){_ctx.fillStyle='white';_ctx.font='32px arial'
_ctx.fillText('- touch or click -',256,175)}else{_ctx.fillStyle='grey';_ctx.font='16px arial'
_ctx.fillText('only one level',256,150);_ctx.fillStyle='green';_ctx.font='32px arial'
_ctx.fillText("'Back Country'",256,175)}
if(hiScores){_ctx.fillStyle='grey';_ctx.font='14px arial'
_ctx.fillText('Coil Subscriber High Scores',256,230);_ctx.fillStyle='white';_ctx.font='24px arial'
for(_i=0;_i<10;_i++){_j=hiScores[_i];if(_j)
_ctx.fillText(_j.s+' - '+_j.n,256,256+_i*24)}
_ctx.fillStyle='grey';_ctx.font='14px arial'
if(document.monetization&&document.monetization.state==='started')
_ctx.fillText('Thanks for subscribing',256,500);else _ctx.fillText('www.Coil.com',256,490)}
break;case 1:drawBG(Math.min(1,ease[2](gameTime/60000)));_ctx=screen.context;player.render(_ctx);bricksA.forEach(b=>b.render(_ctx));particlesA.forEach(p=>p.render(_ctx));ball.render(_ctx);if(gameTime>190000){_ctx.save();_ctx.fillStyle='red';_ctx.textAlign='left';_ctx.font='5vh futura'
_ctx.fillText(''+roundToTwo((200000-gameTime)/1000),220,256);_ctx.restore()}
break;case 2:_ctx.fillStyle='red';_ctx.font='64px arial';_ctx.fillText('GAME OVER',256,256);break;case 3:_ctx.fillStyle='red';_ctx.font='32px arial';_ctx.fillText('YOUR SCORE WAS:',256,256);_ctx.fillText(score,256,320);break;case 4:_ctx=screen.context;_ctx.fillStyle='black';_ctx.fillRect(0,0,innerWidth,innerHeight);_ctx.font='32px arial';_ctx.fillStyle='white';_ctx.fillText(messages[randomMessage][0],256,256);_ctx.fillText(messages[randomMessage][1],256,288);break};_ctx.fillStyle='white';_ctx.font='24px arial'
_ctx.rotate(pi/2);_ctx.fillText(score,0,20);if(gameState==1)
_ctx.fillText((200-gameTime/1000)|0,480,20);_ctx.restore()},messages=[['Tap in time with the beat','to energize your hits.'],['Bricks are worth more points,','the earlier they are broken.'],['Tap along with quarter,','half, or whole notes.'],["You don't have to hit the","beat, just stay in time with it."],['Player velocity on contact','determines the balls direction.']],randomMessage=localStorage.bbMessageNumber||0,sampleRate=44100,sounds={},instruments={},halfStep=1.059463094,pi=Math.PI,minor=[0,2,3,5,7,8,10,12],generate=[i=>Math.max(0.8,Math.random()*2-1),(i,p)=>Math.sin(i*6.28/p),(i,p,h)=>wave(i,p,x=>x%2==0?0:1,h),(i,p,h)=>wave(i,p,x=>1,h),(i,p,h)=>wave(i,p,i=>Math.sin(i*50),h),(i,p,h)=>wave(i,p,i=>1/i,h),],ease=[i=>i,i=>i*i*Math.pow((3-2*i),1),i=>i*i,i=>1-Math.pow(1-i,2)],_w=0,wave=(i,p,hFun,h)=>{_w=0;for(let _i=1;_i<h;_i+=1)
_w+=generate[1](i,p/_i)/_i*(_i==1?1:Math.max(0,Math.min(1,hFun(_i))));return _w},createInstrument=o=>{instruments[o[0]]={};let inst=instruments[o[0]];for(let i=0;i<o[2];i++){o[3][1]=freqFromMidi(o[1]+i);inst[o[1]+i]=createBuffer(o[3])}},bN=0,createBuffer=o=>{bN++;let mG=o[0],mF=o[1],h=o[2],A=o[3]*sampleRate,D=o[4]*sampleRate,S=o[5]*sampleRate,L=o[6],R=o[7]*sampleRate,pS=o[8]||0,tG=o[9]||-1,tF=o[10]||0,tW=o[11]||0,tS=o[12]||0,eT=o[13]||0,ad=A+D,as=ad+S,P=sampleRate/mF,eV=0,B=aCtx.createBuffer(2,as+R,sampleRate),bL=B.length,v=0,e=0,t=0,hS=0;for(let i=0;i<2;i++){let C=B.getChannelData(i);for(let j=0,jL=bL;j<jL;j++){eV=ease[eT](j/jL);P=sampleRate/(mF+pS*eV);v=generate[mG](j,P,h);t=1;if(tG>0)t=generate[tG](j,sampleRate/(tF+tS*eV),100)*tW+(1-tW);t=t/2+0.5;if(j<=A)e=ease[3](j/A);else if(j<=ad)e=ease[2](-(j-ad)/D)*(1-L)+L;if(j>as)e=ease[1](-(j-as)/R+1)*L;C[j]=v*t*e;if(Math.abs(C[j])>hS)
hS=Math.abs(C[j])}
for(let j=0,jL=bL;j<jL;j++){C[j]*=1/hS}};return B},freqFromMidi=midi=>{return roundToTwo(440*Math.pow(halfStep,midi-69))},roundToTwo=value=>{return Math.round(value*100)/100},_source,_gain,playBuffer=(gain,name,note)=>{_source=aCtx.createBufferSource();_gain=aCtx.createGain();_gain.gain.value=gain||0.5;if(note)_source.buffer=instruments[name][note];else _source.buffer=sounds[name];_source.connect(_gain);_gain.connect(aCtx.destination);_source.start()},prepareSounds=()=>{sounds.tick=createBuffer([0,,,0.005,0.01,0,0.9,0.01])
playBuffer(0.4,'tick');createInstrument(['bounce',41,14,[2,0,10,0.01,0.05,0,1,0.1,30,0,4,1,200]]);createInstrument(['test',60,13,[2,0,5,0.01,0.05,0,0.5,0.01]]);createInstrument(['high',60,13,[4,0,10,0.05,0.2,0,0.5,0.01]]);sounds.drum=createBuffer([5,130.81,20,0.01,0.25,0,0,0.01,-130]);createInstrument(['drone',36,13,[5,0,12,1,0.1,0.5,0.3,0.2,-1]]);createInstrument(['mid',42,13,[4,0,10,0.05,0.2,0.25,0.5,0.1,,1,6.125,1]])},tau=pi*2,size=256,nums=[],perm=[],dirs=[],_n,_X,_Y,polyX,polyY,distX,distY,hash,grad,fade=t=>1-6*t**5+15*t**4-10*t**3,surflet=(x,y,gridX,gridY,w)=>{distX=Math.abs(x-gridX);distY=Math.abs(y-gridY);polyX=fade(distX);polyY=fade(distY);hash=perm[perm[gridX%w]+gridY%w];grad=(x-gridX)*dirs[hash][0]+(y-gridY)*dirs[hash][1];return polyX*polyY*grad},pNoise=(x,y,w)=>{_X=x|0;_Y=y|0;return(surflet(x,y,_X,_Y,w)+surflet(x,y,_X+1,_Y,w)+surflet(x,y,_X,_Y+1,w)+surflet(x,y,_X+1,_Y+1,w))},turbulence=(x,y,per,octs)=>{_n=0;for(_i=0;_i<octs;_i++)
_n+=0.5**_i*pNoise(x*2**_i,y*2**_i,per*2**_i);return _n},makeNoise=(ctx,out,wh,f,d,cB,sX=1,sY=1)=>{for(_j=0;_j<wh;_j++){for(_k=0;_k<wh;_k++){_fW=(turbulence(_j*f*(1/sX),_k*f*(1/sY),(wh*f)|0,d)+1)*128;_fW=cB(_fW,_j,_k);if(out){if(!out[_j])out[_j]={};out[_j][_k]=_fW}
if(ctx){ctx.fillStyle='rgb('+_fW[0]+','+_fW[1]+','+_fW[2]+')';ctx.fillRect(_j,_k,1,1)}}}
return out};for(_i=0;_i<size;_i++){nums.push(_i);dirs.push([Math.cos(_i*tau/size),Math.sin(_i*tau/size)])};for(_i=0;_i<size;_i++){_n=nums.splice((Math.random()*nums.length)|0,1)[0];perm[_i]=_n;perm[_i+size]=_n};resize();screen.context.imageSmoothingEnabled=!1;document.body.appendChild(BG);document.body.appendChild(screen);_ctx=screen.context;_ctx.fillStyle='blue';_ctx.font='5vh futura';_ctx.fillText('loading',innerWidth/2-_ctx.measureText('loading').width/2,innerHeight/2);setTimeout(()=>{drawAssets();initControls();requestAnimationFrame(simulate)},10)