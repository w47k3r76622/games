let{init:init,Sprite:Sprite,SpriteSheet:SpriteSheet,GameLoop:GameLoop,Vector:Vector,Animation:Animation}=kontra,{canvas:canvas}=init();kontra.initKeys();let tilesheet,tileatlas=new Image;tileatlas.src="tiles.gif",tileatlas.onload=function(){tilesheet=SpriteSheet({image:tileatlas,frameWidth:16,frameHeight:16,animations:{laddertile:{frames:"0..0"},wall:{frames:"1..1"},watertoptile:{frames:"2..2",frameRate:4},movingplatform:{frames:"3..3"},pushableblock:{frames:"4..4"},spring:{frames:"5..5"},acidtop:{frames:"6..7",frameRate:10},acidbody:{frames:"8..9",frameRate:10},404:{frames:"13..13"},gem:{frames:"10..11",frameRate:4},lasercapsule:{frames:"12..12"},laddercollectible:{frames:"14..14"},watercollectible:{frames:"15..15"},springcollectible:{frames:"16..16"},platformcollectible:{frames:"17..17"},pushablecollectible:{frames:"18..18"},door:{frames:"19..19"}}})};let enemysheet,playerspr,p,rightcol,leftcol,bottomcol,middlecol,topcol,shooting,enemyatlas=new Image;enemyatlas.src="enemies.gif",enemyatlas.onload=function(){enemysheet=SpriteSheet({image:enemyatlas,frameWidth:16,frameHeight:16,animations:{bat:{frames:"0..1",frameRate:8},rat:{frames:"2..3",frameRate:8},scorpion:{frames:"4..6",frameRate:8},wisp:{frames:"7..9",frameRate:12}}})};let laser,gp,gamerunning,horspeed,b=new Array,enemies=new Array,levelloaded=!1,gravity={x:0,y:1},frameCount=0,currentlevel=1,friction=1,rcol=!1,lcol=!1,startjump=!1,dead=0,deathcount=0,gemsleft=32,boxesleft=5,onfloor=!1,ladder=!1,ladderclimb=!1,water=!1,onmovingplatform=!1,spacedown=!1,updateDOM=!1,zdown=!1,verblock=0,ladderx=0,table404={BLOCK:{found:!0},LADDER:{found:!1},WATER:{found:!1},MOVINGPLATFORM:{found:!1},SPRING:{found:!1},PUSHABLE:{found:!1},ACID:{found:!0},DOOR:{found:!0},GEM:{found:!0}},gemscollected=new Array;for(let e=1;e<=48;e++)gemscollected[e]=!1;spawnPlayer();let loop=GameLoop({update:function(){if(p&&tilesheet&&enemysheet){let e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];gp=e[0],levelloaded||loadLevel(),0!=currentlevel&&(gamerunning||(Pressed("a")||Pressed("d")||Pressed("w")||Pressed("s")||Pressed("left")||Pressed("right")||Pressed("up")||Pressed("down")||Pressed("space")||Pressed("z")||Pressed("enter"))&&(gamerunning=!0),p&&(updatePlayer(),p.update(),(laser.x<0||laser.x>416)&&resetLaser(),laser.update()),updateEnemies(),updateBlocks(),startjump=!1,gamerunning&&frameCount++,p&&(p.canmove||(p.canmove=!0)),gamerunning&&updateTimer()),1==updateDOM&&(updateDeathCounter(),updateEnvelopeCounter(),updateShootInstruction(),updateTitle(),updateDOM=!1)}},render:function(){if(p&&tilesheet&&enemysheet){for(i=0;i<=b.length-1;i++){let e=isFound(b[i].type)?b[i].anim:"404";"none"!=e&&b[i].playAnimation(e),"WATER"!=b[i].type||b[i].watertop||(b[i].color="404"==e?"transparent":"#005784"),b[i].opacity=404==e||i>0&&"GEM"==b[i].type&&"WATER"==b[i-1].type?.5:1,("DOOR"!=b[i].type||isFound(b[i].type)||0==currentlevel)&&b[i].render()}for(i=0;i<=enemies.length-1;i++)enemies[i].render();p&&(p.render(),laser.render())}}});function updatePlayer(){everyXFrames(15)&&(p.shooting=!1),dead>0&&++dead%31==0&&(dead=0,p.x=playerStartX,p.y=playerStartY),rcol=!1,lcol=!1,bcol=!1,water?(p.opacity=.5,horspeed=2):(p.opacity=1,horspeed=3.8),Pressed("up")&&ladder&&!Pressed("left")&&!Pressed("right")&&"3"==findBlock(p.x,p.y-32)&&0==dead&&(p.y-=2,ladderclimb=!0),Pressed("down")&&ladder&&!Pressed("left")&&!Pressed("right")&&"1"!=findBlock(p.x,p.y+5)&&0==dead&&(p.y+=2,ladderclimb=!0),Pressed("space")&&(onfloor||water)&&!spacedown&&0==dead&&(p.dy=water?-6:-12,startjump=!0,ladderclimb=!1),spacedown=!!Pressed("space"),Pressed("left")&&!Pressed("right")&&p.canmove&&0==dead&&(p.scaleX=-1,rcol||(p.dx=-horspeed,ladderclimb=!1)),Pressed("right")&&!Pressed("left")&&p.canmove&&0==dead&&(p.scaleX=1,rcol||(p.dx=horspeed,ladderclimb=!1)),Pressed("z")&&!zdown&&-64==laser.y&&shootLaser(),zdown=!!Pressed("z"),(0!=p.dx&&onfloor||water)&&(-1==p.scaleX?p.dx+friction>0||rcol?p.dx=0:p.dx+=friction:p.dx-friction<0||rcol?p.dx=0:p.dx-=friction),b.forEach(function(e,t,a){kontra.collides(rightcol,e)&&isFound(e.type)&&"LADDER"!=b[t].type&&"WATER"!=b[t].type&&"GEM"!=b[t].type&&(rcol=!0),kontra.collides(leftcol,e)&&isFound(e.type)&&"LADDER"!=b[t].type&&"WATER"!=b[t].type&&"GEM"!=b[t].type&&(lcol=!0)}),p.dx<0&&rcol?p.dx=0:p.dx>0&&rcol&&(p.dx=0),water?p.dy>.5&&(p.dy=.5):p.dy>8&&(p.dy=8);let e,t=!1,a=!1,n=!1;for(ladder=!1,water=!1,onmovingplatform=!1,verblock=0,i=0;i<=b.length-1;i++)kontra.collides(bottomcol,b[i])&&b[i].y<p.y&&p.x+p.width/2>=b[i].x&&p.dy>=0&&("LADDER"!=b[i].type&&"WATER"!=b[i].type&&"GEM"!=b[i].type&&isFound(b[i].type)&&(t=!0,verblock=i),"SPRING"==b[i].type&&isFound(b[i].type)&&(a=!0),"ACID"==b[i].type&&isFound(b[i].type)&&killPlayer(),"WATER"!=b[i].type||isFound(b[i].type)||(t=!0,verblock=i)),kontra.collides(topcol,b[i])&&isFound(b[i].type)&&b[i].y<=p.y-p.height&&"LADDER"!=b[i].type&&"WATER"!=b[i].type&&"GEM"!=b[i].type&&(t=!1,n=!0,verblock=i),kontra.collides(bottomcol,b[i])&&isFound(b[i].type)&&"LADDER"==b[i].type&&(ladder=!0,ladderx=b[i].x),kontra.collides(middlecol,b[i])&&isFound(b[i].type)&&"WATER"==b[i].type&&(water=!0);if(e=water?gravity.y/1.5:gravity.y,1==t){for(;kontra.collides(p,b[verblock])&&!ladderclimb;)p.y-=e;startjump||(p.dy=0),onfloor=!0,0!=b[verblock].dx&&(onmovingplatform=!0,rcol||lcol||(p.x+=b[verblock].dx)),a&&(p.dy=-18,b[verblock].sprung=!0)}else if(1==n)for(p.dy=0;kontra.collides(p,b[verblock]);)p.y+=e;if(t||(onfloor=!1),ladderclimb||1!=levelloaded?ladderclimb&&(p.x=ladderx+p.width/2,p.dy=0):p.dy+=e,!ladder&&ladderclimb&&Pressed("down")&&(ladder=!0),ladderclimb&&"0"==findBlock(p.x,p.y+5)&&(ladderclimb=!1,ladder=!1),p.x>416&&(currentlevel++,levelloaded=!1,p.x=0,playerStartX=p.x,playerStartY=p.y),p.x<0&&(currentlevel--,levelloaded=!1,p.x=416,playerStartX=p.x,playerStartY=p.y),p.y>320&&(currentlevel+=8,levelloaded=!1,p.y=16,playerStartX=p.x,playerStartY=p.y),(p.y<0||ladderclimb&&p.y<=32&&Pressed("up")||water&&p.y<=32&&p.dx<0)&&(currentlevel-=8,levelloaded=!1,p.y=320,playerStartX=p.x,playerStartY=p.y),0==p.dx&&onfloor&&p.playAnimation("idle"),p.dy!=gravity.y&&p.playAnimation("jump"),(Pressed("left")||Pressed("right"))&&p.dy==gravity.y||1==water){let e;e=water?4:8,p.playAnimation("run"),p.currentAnimation.frameRate=e}if(ladderclimb){let e;e=Pressed("up")||Pressed("down")?8:0,p.playAnimation("climb"),p.currentAnimation.frameRate=e}p.shooting&&p.playAnimation("use"),dead>0&&p.playAnimation("dead")}function updateBlocks(){for(i=0;i<=b.length-1;i++){if(kontra.collides(b[i],laser)&&isFound(b[i].type)&&"GEM"!=b[i].type&&resetLaser(),1==b[i].watertop&&everyXFrames(8)&&isFound(b[i].type)&&(b[i].y+=b[i].y%16==0?1:-1),"ACID"==b[i].type&&everyXFrames(12)&&isFound(b[i].type)&&(b[i].y+=b[i].y%16==0?2:-2),"MOVINGPLATFORM"==b[i].type&&(b.forEach(function(e,t,a){kontra.collides(b[i],b[t])&&t!=i&&b[t].y==b[i].y&&(b[i].multiplier*=-1)}),b[i].dx=b[i].originaldx*b[i].multiplier,(kontra.collides(b[i],leftcol)||kontra.collides(b[i],rightcol)&&isFound(b[i].type))&&(p.x>b[i].x&&b[i].dx>0&&(b[i].dx=0),p.x<b[i].x&&b[i].dx<0&&(b[i].dx=0))),"PUSHABLE"==b[i].type&&isFound(b[i].type)){let e=!0,t=!0;b.forEach(function(t,a,n){kontra.collides(b[i],b[a])&&a!=i&&"LADDER"!=b[a].type&&"GEM"!=b[a].type&&(Math.abs(b[a].y-b[i].y)<=Math.round(3*gravity.y)&&(e=!1,b[a].x<b[i].x?b[i].x+=3*gravity.y:b[i].x-=3*gravity.y),b[a].y>b[i].y&&"WATER"!=b[a].type&&"LADDER"!=b[a].type&&(b[i].y=b[a].y-32-2*gravity.y))}),kontra.collides(b[i],rightcol)&&e?b[i].dx=p.dx:b[i].dx=0,b[i].dy=t?3*gravity.y:0}if("SPRING"==b[i].type&&isFound(b[i].type)&&(b[i].sprung?(b[i].y=b[i].originaly+16,everyXFrames(30)&&(b[i].sprung=!1)):b[i].y=b[i].originaly),"GEM"==b[i].type&&kontra.collides(b[i],rightcol)){if(b[i].actualgem&&0==gemscollected[currentlevel])gemscollected[currentlevel]=!0,gemsleft--,updateDOM=!0;else switch(b[i].anim){case"laddercollectible":table404.LADDER.found=!0,boxesleft--,updateDOM=!0,levelloaded=!1;break;case"watercollectible":table404.WATER.found=!0,boxesleft--,updateDOM=!0,levelloaded=!1;break;case"springcollectible":table404.SPRING.found=!0,boxesleft--,updateDOM=!0,levelloaded=!1;break;case"platformcollectible":table404.MOVINGPLATFORM.found=!0,boxesleft--,updateDOM=!0,levelloaded=!1;break;case"pushablecollectible":table404.PUSHABLE.found=!0,boxesleft--,updateDOM=!0,levelloaded=!1;break;case"lasercapsule":p.ammo++,updateDOM=!0}0==boxesleft&&0==gemsleft&&1==table404.DOOR.found&&(table404.DOOR.found=!1,levelloaded=!1),b[i].x=-32,b[i].y=-32}b[i].update()}}function updateEnemies(){for(i=0;i<=enemies.length-1;i++)enemies[i].playAnimation(enemies[i].type),enemies[i].currentAnimation.frameRate=8*Math.abs(enemies[i].dx),enemies[i].walkcount+=Math.abs(enemies[i].dx),enemies[i].walkcount>=enemies[i].hor&&0!=enemies[i].dx&&(enemies[i].dx*=-1,enemies[i].scaleX*=-1,enemies[i].walkcount=0),(kontra.collides(enemies[i].children[0],bottomcol)||kontra.collides(enemies[i].children[0],middlecol)||kontra.collides(enemies[i].children[0],leftcol)||kontra.collides(enemies[i].children[0],rightcol))&&killPlayer(),kontra.collides(enemies[i].children[0],laser)&&(resetLaser(),enemies[i].life--,0==enemies[i].life&&(enemies[i].y=-64,enemies[i].x=-64)),enemies[i].update()}function everyXFrames(e){return frameCount%e==0}function isFound(e){return table404[e].found}function findBlock(e,t){return e=Math.floor(e/32),t=Math.floor(t/32),levels[currentlevel].charAt(e+13*t)}function loadLevel(){for(b=new Array,enemies=new Array,i=0;i<=10;i++){let e=levels[currentlevel].substr(13*i,13);for(a=0;a<=e.length-1;a++)switch("0"!=e.charAt(a)&&(b.push(Sprite({x:32*a,y:32*i,height:32,width:32})),"#"==e.charAt(a)&&b.push(Sprite({x:32*a,y:32*i,height:32,width:32}))),e.charAt(a)){case"1":b[b.length-1].type="BLOCK",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="wall";break;case"2":b[b.length-1].animations=tilesheet.animations,b[b.length-1].type="MOVINGPLATFORM",b[b.length-1].anim="movingplatform",b[b.length-1].dx=-1,b[b.length-1].originaldx=-1,b[b.length-1].multiplier=1;break;case"3":b[b.length-1].type="LADDER",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="laddertile";break;case"4":b[b.length-1].type="WATER",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="none";break;case"5":b[b.length-1].type="WATER",b[b.length-1].watertop=!0,b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="watertoptile";break;case"6":b[b.length-1].type="PUSHABLE",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="pushableblock";break;case"7":b[b.length-1].type="SPRING",b[b.length-1].sprung=!1,b[b.length-1].originaly=b[b.length-1].y,b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="spring";break;case"8":b[b.length-1].type="ACID",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="acidtop";break;case"9":b[b.length-1].type="ACID",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="acidbody";break;case"A":b[b.length-1].type="DOOR",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="door";break;case"*":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="gem",b[b.length-1].actualgem=!0,1==gemscollected[currentlevel]&&(b[b.length-1].x=-32,b[b.length-1].y=-32);break;case"%":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="lasercapsule";break;case"L":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="laddercollectible",1==table404.LADDER.found&&(b[b.length-1].x=-32,b[b.length-1].y=-32);break;case"W":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="watercollectible",1==table404.WATER.found&&(b[b.length-1].x=-32,b[b.length-1].y=-32);break;case"S":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="springcollectible",1==table404.SPRING.found&&(b[b.length-1].x=-32,b[b.length-1].y=-32);break;case"M":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="platformcollectible",1==table404.MOVINGPLATFORM.found&&(b[b.length-1].x=-32,b[b.length-1].y=-32);break;case"P":b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="pushablecollectible",1==table404.PUSHABLE.found&&(b[b.length-1].x=-32,b[b.length-1].y=-32);break;case"#":b[b.length-2].type="WATER",b[b.length-2].animations=tilesheet.animations,b[b.length-2].anim="none",b[b.length-1].type="GEM",b[b.length-1].animations=tilesheet.animations,b[b.length-1].anim="gem",b[b.length-1].actualgem=!0,1==gemscollected[currentlevel]&&(b[b.length-1].x=-32,b[b.length-1].y=-32)}}placeEnemies(),updateDOM=!0,p.ammo=0,levelloaded=!0}function spawnPlayer(){updateEnvelopeCounter(),(playerspr=new Image).src="player.gif",playerspr.onload=function(){let e=SpriteSheet({image:playerspr,frameWidth:16,frameHeight:16,animations:{idle:{frames:"0..0",frameRate:30},jump:{frames:"1..1",frameRate:30},run:{frames:"1..2",loop:!0,frameRate:8},climb:{frames:"3..4",frameRate:6},use:{frames:"5..5",frameRate:30},dead:{frames:"6..6",frameRate:30}}});p.animations=e.animations,p.canmove=!0,p.ammo=0},p=Sprite({x:48,y:300,height:32,width:32,shooting:!1,anchor:{x:.5,y:1}}),rightcol=Sprite({x:12,y:-30,height:24,width:5}),leftcol=Sprite({x:-18,y:-30,height:24,width:5}),bottomcol=Sprite({x:-10,y:-5,height:5,width:20}),middlecol=Sprite({x:-12,y:-15,height:5,width:20}),topcol=Sprite({x:-12,y:-32,height:5,width:20}),p.addChild(rightcol),p.addChild(leftcol),p.addChild(bottomcol),p.addChild(middlecol),p.addChild(topcol),laser=Sprite({x:-64,y:-64,height:4,width:8,color:"#66ccff"})}function killPlayer(){0==dead&&(p.canmove=!1,dead=1,deathcount++,updateDOM=!0)}function spawnEnemy(e,t,a,i,n,l){let r=Sprite({x:16*t+16,y:16*a,dx:i,hor:n,height:32,width:32,type:e,walkcount:0,anchor:{x:.5,y:0},animations:enemysheet.animations});switch(r.scaleX=0!=i?Math.sign(i):l,e){case"scorpion":r.life=2;break;case"wisp":r.opacity=.5;break;default:r.life=1}let o=Sprite({x:0,y:16,height:12,width:20,anchor:{x:.5,y:0}});r.addChild(o),enemies.push(r)}function placeEnemies(){switch(currentlevel){case 3:spawnEnemy("rat",16,4,.5,32,-1);break;case 4:spawnEnemy("rat",16,6,0,0,-1);break;case 5:spawnEnemy("bat",14,6,-1,96,-1);break;case 6:spawnEnemy("scorpion",8,8,-.5,32,-1);break;case 8:1==table404.WATER.found&&(spawnEnemy("wisp",2,12,2,304,1),spawnEnemy("wisp",22,14,-2,304,-1));break;case 10:spawnEnemy("bat",8,10,1,96,1),spawnEnemy("bat",16,12,-1,96,-1);break;case 11:1==table404.WATER.found&&(spawnEnemy("wisp",2,10,2,304,1),spawnEnemy("wisp",22,14,-2,304,-1));break;case 13:spawnEnemy("bat",4,6,1,256,1);break;case 15:spawnEnemy("rat",14,8,0,0,-1);break;case 17:spawnEnemy("wisp",8,10,1,96,1),spawnEnemy("wisp",16,12,-1,96,-1);break;case 18:spawnEnemy("scorpion",8,6,1,128,1);break;case 19:spawnEnemy("bat",8,6,1,96,1),spawnEnemy("bat",16,12,-1,96,-1);break;case 20:spawnEnemy("rat",6,10,0,0,1);break;case 21:spawnEnemy("rat",6,4,0,0,1),spawnEnemy("rat",14,10,.5,32,1);break;case 22:spawnEnemy("rat",14,10,0,0,1),spawnEnemy("rat",14,4,.5,32,1);break;case 23:spawnEnemy("scorpion",4,14,1,64,1);break;case 26:spawnEnemy("bat",18,4,-1,208,-1);break;case 27:spawnEnemy("rat",4,6,.5,64,1)}}function shootLaser(){p.ammo>0&&(laser.x=p.x,laser.y=p.y-p.height/2,laser.dx=8*p.scaleX,p.shooting=!0,p.ammo--,updateDOM=!0)}function resetLaser(){laser.y=-64,laser.dx=0}function updateDeathCounter(){let e="";for(i=1;i<=deathcount;i++)e+="💀";document.getElementById("deathcount").innerHTML=e}function updateEnvelopeCounter(){let e="";for(i=1;i<=gemsleft;i++)e+="✉️";document.getElementById("envcount").innerHTML=e}function updateShootInstruction(){let e="";for(i=1;i<=p.ammo;i++)e+="⚡";document.getElementById("shoot").innerHTML=e}function updateTitle(){let e="";for(i=1;i<=boxesleft;i++)e+="📦";if(0==boxesleft&&0==gemsleft&&(e="🚪"),0==currentlevel){e="",e+=Math.floor(frameCount/60/60),e+=":";let t=frameCount/60%60;t<10&&(e+="0"),e+=t.toFixed(3),document.getElementById("timer").innerHTML="Well Done!"}document.getElementById("title").innerHTML=e}function updateTimer(){let e="";e+=Math.floor(frameCount/60/60),e+=":";let t=frameCount/60%60;t<10&&(e+="0"),e+=t.toFixed(3),document.getElementById("timer").innerHTML=e}function Pressed(e){switch(e){case"left":return!!(kontra.keyPressed(e)||kontra.keyPressed("a")||gp&&(gp.buttons[14].pressed||-1==Math.round(gp.axes[0])));case"right":return!!(kontra.keyPressed(e)||kontra.keyPressed("d")||gp&&(gp.buttons[15].pressed||1==Math.round(gp.axes[0])));case"up":return!!(kontra.keyPressed(e)||kontra.keyPressed("w")||gp&&(gp.buttons[12].pressed||-1==Math.round(gp.axes[1])));case"down":return!!(kontra.keyPressed(e)||kontra.keyPressed("s")||gp&&(gp.buttons[13].pressed||1==Math.round(gp.axes[1])));case"space":return!!(kontra.keyPressed(e)||gp&&gp.buttons[0].pressed);case"z":return!!(kontra.keyPressed(e)||kontra.keyPressed("enter")||gp&&gp.buttons[2].pressed)}}loop.start();