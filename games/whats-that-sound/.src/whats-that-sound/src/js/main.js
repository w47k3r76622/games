var SCALE=8,TILE=16,HALF_TILE=TILE/2,MAP_SIZE_X=20,MAP_SIZE_Y=20,PLAYER_HITBOX=12,COLLISION_RANGE=2,DESTINATION_RANGE=5,CANVAS_W=60*TILE,CANVAS_H=40*TILE,OFFSCREEN={x:-100,y:-100},WARNING_TIME=3E3,DANGER_TIME=2E3,STATE_INTRO=0,STATE_TUTORIAL=1,STATE_PLAY=2,STATE_END=3,STATE_OUTRO=4,canvas,ctx,player,enemy,map,camera,hud,enemySpawnId=null,sfxLoopId=null,inputLocked=!1,gameState=STATE_INTRO,timer=0,timerId=null,sfx_playerHit=createSFX([3,,.0707,,.2685,.7213,,-.3051,,,,,,,,,,,1,,,,,.5]),sfx_warning=
createSFX([0,,.1884,,.0365,.464,,,,,,,,.3026,,,,,1,,,.1,,.28]),sfx_gameOver=createSFX([1,.2045,.1804,.1303,.62,.2308,,-.2527,-.0312,.0561,,-.1611,.4463,.0859,.0137,.4703,.7618,.0148,.6813,-.0014,,8E-4,-.1493,.5]),sfx_gameSuccess=createSFX([0,,.01,.3592,.3356,.729,,,,,,.5557,.6239,,,,,,1,,,,,.5]);document.addEventListener("mousedown",mouseDown);document.addEventListener("mouseup",mouseUp);document.addEventListener("mousemove",mouseMove);
function startGame(){map=new Map(1);player=new Player(map.playerPos||{x:190,y:60},3,2.5/SCALE);enemy=new Enemy(OFFSCREEN);camera=new Camera(0,0,CANVAS_W,CANVAS_H,map.width*TILE,map.height*TILE,SCALE);camera.setDeadZone(CANVAS_W/2,CANVAS_H/2);camera.follow(player);hud=new Hud(player.life,CANVAS_W,CANVAS_H);canvas=document.getElementById("gameCanvas");canvas.width=CANVAS_W;canvas.height=CANVAS_H;ctx=canvas.getContext("2d");ctx.scale(SCALE,SCALE);ctx.mozImageSmoothingEnabled=!1;ctx.imageSmoothingEnabled=
!1;setInterval(update,10);lockInput(!0)}function update(){camera.update();draw();player.moving&&(movePlayer(camera.getScreenToWorldPos(player.destination.x,player.destination.y)),checkPlayerCollision());checkPlayerPath()}
function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);drawMap(WALL_TILE);drawPlayer();ctx.fillStyle="#100";ctx.globalAlpha=.6;ctx.fillRect(0,0,CANVAS_W,CANVAS_H);ctx.globalAlpha=1;drawEnemy();drawHUD();gameState==STATE_INTRO?drawIntro():gameState==STATE_TUTORIAL?drawTutorial():gameState==STATE_OUTRO&&drawOutro()}
function drawIntro(){ctx.fillStyle="#000";ctx.fillRect(0,0,CANVAS_W,CANVAS_H);ctx.fillStyle="#FFF";ctx.font="5px Courier New";ctx.textAlign="center";ctx.fillText("You find yourself lost in",60,10);ctx.fillText("a haunted dungeon. They've taken",60,18);ctx.fillText("away your powers. You must",60,26);ctx.fillText("find and retrieve your staff.",60,34);ctx.fillText("But wait...",60,45);ctx.font="bold 6px Courier New";ctx.fillText("What's that sound?!",60,55);ctx.font="3px Courier New";ctx.fillText("click to continue",
60,65)}
function drawTutorial(){ctx.fillStyle="#000";ctx.fillRect(0,0,CANVAS_W,CANVAS_H);ctx.drawImage(map.mapAsset,1*TILE,1*TILE,TILE,TILE,55,55,TILE/2,TILE/2);ctx.fillStyle="#FFF";ctx.font="5px Courier New";ctx.textAlign="center";ctx.font="bold 6px Courier New";ctx.fillText("Click and hold",60,10);ctx.fillText("the mouse to move.",60,18);ctx.font="5px Courier New";ctx.fillText("The ghost in  here does not want",60,26);ctx.fillText("you in certain areas. You have a ",60,34);ctx.fillText("ring that warns you of danger.",60,
42);ctx.fillText("Listen to it and go find your staff.",60,50);ctx.font="3px Courier New";ctx.fillText("click to continue",60,68)}
function drawOutro(){ctx.fillStyle="#000";ctx.fillRect(0,0,CANVAS_W,CANVAS_H);ctx.drawImage(map.mapAsset,1*TILE,1*TILE,TILE,TILE,50,45,TILE,TILE);ctx.fillStyle="#FFF";ctx.font="5px Courier New";ctx.textAlign="center";ctx.font="bold 6px Courier New";ctx.fillText("Congratulations!",60,20);ctx.font="5px Courier New";ctx.fillText("You found your staff in",60,28);ctx.fillText(timer+" seconds and",60,36);ctx.fillText("survived the dungeon!",60,42);ctx.font="3px Courier New";ctx.fillText("click to play again",
60,68)}function drawLight(a,b,c,d){ctx.save();ctx.globalCompositeOperation="lighter";d=ctx.createRadialGradient(a,b,0,a,b,c);d.addColorStop(0,"#AA9");d.addColorStop(.2,"#885");d.addColorStop(.7,"#220");d.addColorStop(.95,"#110");d.addColorStop(1,"#000");ctx.fillStyle=d;ctx.beginPath();ctx.arc(a,b,c,0,2*Math.PI);ctx.fill();ctx.restore()}
function drawPlayer(){var a={};a.x=player.position.x-HALF_TILE;a.y=player.position.y-HALF_TILE;a=camera.getWorldToScreenPos(a.x,a.y);drawLight(a.x+HALF_TILE,a.y+HALF_TILE,30);ctx.drawImage(player.spriteAsset,player.sprite.x,player.sprite.y,TILE,TILE,a.x,a.y,TILE,TILE)}
function drawMap(a){ctx.fillStyle="#000";ctx.fillRect(0,0,CANVAS_W,CANVAS_H);a=camera.getViewport();for(var b=clamp(Math.floor(a.left/TILE)-1,0,map.width),c=clamp(Math.floor(a.top/TILE)-1,0,map.height),d=clamp(Math.ceil(a.right/TILE)+1,0,map.width),f=clamp(Math.ceil(a.bottom/TILE)+1,0,map.height);c<f;c++)for(var e=b;e<d;e++)map.data[c][e]==WIN_TILE?(ctx.drawImage(map.mapAsset,2*TILE,TILE,TILE,TILE,e*TILE-a.left,c*TILE-a.top,TILE,TILE),ctx.drawImage(map.mapAsset,1*TILE,1*TILE,TILE,TILE,e*TILE-a.left,
c*TILE-a.top,TILE,TILE)):map.data[c][e]!=WALL_TILE&&ctx.drawImage(map.mapAsset,2*TILE,TILE,TILE,TILE,e*TILE-a.left,c*TILE-a.top,TILE,TILE)}function drawEnemy(){var a=camera.getWorldToScreenPos(enemy.position.x-HALF_TILE,enemy.position.y-HALF_TILE);ctx.drawImage(enemy.spriteAsset,enemy.sprite.x,enemy.sprite.y,TILE,TILE,a.x,a.y,TILE,TILE)}
function drawHUD(){for(var a=hud.getTileImage("life"),b=hud.getTileImage("emptyLife"),c=hud.getLifeBarPos(),d=0;d<player.maxLife;d++)d<player.life?ctx.drawImage(hud.spriteAsset,a.x,a.y,a.width,a.height,c.x+d*TILE/2,c.y,a.width/2,a.height/2):ctx.drawImage(hud.spriteAsset,b.x,b.y,b.width,b.height,c.x+d*TILE/2,c.y,b.width/2,b.height/2);ctx.fillStyle="#FFF";ctx.font="5px Courier New";ctx.textAlign="right";ctx.fillText(timer,c.x+camera.wViewPort-5,c.y+5)}function clamp(a,b,c){return a<=b?b:a>=c?c:a}
function mouseDown(a){inputLocked||(player.moving=!0,player.destination=getMousePos(canvas,a));gameState==STATE_INTRO?gameState=STATE_TUTORIAL:gameState==STATE_TUTORIAL?(gameState=STATE_PLAY,lockInput(!1),null!=timerId&&clearInterval(timerId),timerId=setInterval(function(){timer++},1E3)):gameState==STATE_OUTRO&&setTimeout(function(){restartGame()},500)}function mouseUp(a){player.moving=!1}
function mouseMove(a){gameState==STATE_PLAY&&!inputLocked&&player.moving&&(player.destination=getMousePos(canvas,a))}
function movePlayer(a){if(distance(player.position,a)>DESTINATION_RANGE){var b=player.position,c=subtract(a,b),d=Math.abs(c.x)<DESTINATION_RANGE,f=Math.abs(c.y)<DESTINATION_RANGE;if(!player.availableDir.up&&0>c.y||!player.availableDir.down&&0<c.y||f)c.y=0;if(!player.availableDir.left&&0>c.x||!player.availableDir.right&&0<c.x||d)c.x=0;c=normalize(c);b=add(b,multiply(c,player.speed));player.position=b;player.updateSprite(a)}}
function getMousePos(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top}}function createSprite(a){var b=new Image;b.src=a;b.context=ctx;b.width=TILE;b.height=TILE;return b}function createSFX(a){var b=new Audio;b.src=jsfxr(a);return b}
function checkPlayerCollision(){var a=player.position;a=new Rectangle(a.x-PLAYER_HITBOX/2,a.y-PLAYER_HITBOX/2,PLAYER_HITBOX,PLAYER_HITBOX);player.availableDir.up=!(map.getTileFromCoordinates(a.left,a.top-COLLISION_RANGE)==WALL_TILE||map.getTileFromCoordinates(a.right,a.top-COLLISION_RANGE)==WALL_TILE);player.availableDir.down=!(map.getTileFromCoordinates(a.left,a.bottom+COLLISION_RANGE)==WALL_TILE||map.getTileFromCoordinates(a.right,a.bottom+COLLISION_RANGE)==WALL_TILE);player.availableDir.left=!(map.getTileFromCoordinates(a.left-
COLLISION_RANGE,a.top)==WALL_TILE||map.getTileFromCoordinates(a.left-COLLISION_RANGE,a.bottom)==WALL_TILE);player.availableDir.right=!(map.getTileFromCoordinates(a.right+COLLISION_RANGE,a.top)==WALL_TILE||map.getTileFromCoordinates(a.right+COLLISION_RANGE,a.bottom)==WALL_TILE)}
function checkPlayerPath(){var a=player.position,b=player.currentTile;map.getTileFromCoordinates(a.x,a.y)==WARNING_TILE?(b==SAFE_TILE&&(enemy.startSpawnTime=(new Date).getTime(),enemySpawnId=setTimeout(function(){playerEnemyInteraction()},WARNING_TIME),sfxLoopId||(sfxLoopId=setInterval(function(){playWarningLoop(500/WARNING_TIME)},500))),player.currentTile=WARNING_TILE):map.getTileFromCoordinates(a.x,a.y)==DANGER_TILE?(b==SAFE_TILE?(enemy.startSpawnTime=(new Date).getTime(),enemySpawnId=setTimeout(function(){playerEnemyInteraction()},
DANGER_TIME),sfxLoopId||(sfxLoopId=setInterval(function(){playWarningLoop(300/DANGER_TIME)},300))):b==WARNING_TILE&&((new Date).getTime()-enemy.startSpawnTime<=WARNING_TIME-DANGER_TIME&&(clearTimeout(enemySpawnId),enemySpawnId=setTimeout(function(){playerEnemyInteraction()},DANGER_TIME),clearInterval(sfxLoopId),sfxLoopId=null,sfxLoopId=setInterval(function(){playWarningLoop(300/DANGER_TIME)},300)),null==enemySpawnId&&(enemySpawnId=setTimeout(function(){playerEnemyInteraction()},DANGER_TIME))),player.currentTile=
DANGER_TILE):map.getTileFromCoordinates(a.x,a.y)==WIN_TILE&&gameState==STATE_PLAY?gameEnd(!0):(clearTimeout(enemySpawnId),enemySpawnId=null,clearInterval(sfxLoopId),sfxLoopId=null,player.currentTile=SAFE_TILE,sfx_warning.volume=0)}function playerEnemyInteraction(){enemy.spawn(player.position);player.takeDamage();sfx_playerHit.play();clearInterval(sfxLoopId);sfx_warning.volume=0;0==player.life&&gameEnd(!1)}
function playWarningLoop(a){sfx_warning.play();sfx_warning.volume=1<=sfx_warning.volume+a?1:sfx_warning.volume+a}function gameEnd(a){lockInput(!0);gameState=STATE_END;a?(sfx_gameSuccess.play(),setTimeout(function(){gameState=STATE_OUTRO},500)):(setTimeout(function(){sfx_gameOver.play()},500),setTimeout(function(){restartGame()},500))}
function restartGame(){null!=timerId&&clearInterval(timerId);timer=0;player.life=player.maxLife;player.position=map.playerPos;player.destination=null;sfx_warning.volume=0;lockInput(!1);gameState=STATE_PLAY;timerId=setInterval(function(){timer++},1E3)}function lockInput(a){inputLocked=a;player.moving=!1};
