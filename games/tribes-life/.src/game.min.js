function game_loop(){requestAnimFrame(game_loop);var e=(new Date).getTime(),t=e-(time||e);time=e;var n=1e3/((e=new Date)-last_update);fps+=(n-fps)/fps_filter;last_update=e;game.loop(t,fps.toFixed(1))}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var Gfx=function(e){this.layers=[];this.screen={width:null,height:null,scale:4,sprite_size:8};var t=document.getElementById("game"),n,r;n=e.tiles_wide*this.screen.sprite_size*this.screen.scale;r=e.tiles_high*this.screen.sprite_size*this.screen.scale;t.style.width=n+"px";t.style.height=r+"px";this.screen.width=n/this.screen.scale<<0;this.screen.height=r/this.screen.scale<<0};Gfx.prototype.init=function(e){this.loaded=0;this.sprites={logo:new Image,pointer:new Image,tileset:new Image};this.sprites.logo.src="sprites/logo.png";this.sprites.pointer.src="sprites/pointer.png";this.sprites.tileset.src="sprites/tileset.png";for(var t in this.sprites){this.sprites[t].onload=function(){game.gfx.loaded++}}for(var n=0;n<e.layers;n++){var r=document.createElement("canvas");r.width=this.screen.width*this.screen.scale;r.height=this.screen.height*this.screen.scale;var i=r.getContext("2d");i.mozImageSmoothingEnabled=false;i.webkitImageSmoothingEnabled=false;i.msImageSmoothingEnabled=false;i.imageSmoothingEnabled=false;this.layers.push({canvas:r,ctx:i,render:false});document.getElementById("game").appendChild(r)}};Gfx.prototype.load=function(){var e=0,t;for(t in this.sprites){if(this.sprites.hasOwnProperty(t))e++}if(this.loaded>=e){return true}return false};Gfx.prototype.clear_layer=function(e){this.layers[e].ctx.clearRect(0,0,this.screen.width*this.screen.scale,this.screen.height*this.screen.scale)};Gfx.prototype.clear_region=function(e){this.layers[e.layer].ctx.clearRect((e.x-e.size*.5)*this.screen.scale*this.screen.sprite_size,(e.y-e.size*.5)*this.screen.scale*this.screen.sprite_size,e.size*2*this.screen.scale*this.screen.sprite_size,e.size*2*this.screen.scale*this.screen.sprite_size)};Gfx.prototype.clear_sprite=function(e){this.layers[e.layer].ctx.clearRect(e.x,e.y,this.screen.scale*this.screen.sprite_size,this.screen.scale*this.screen.sprite_size)};Gfx.prototype.draw_tileset=function(){for(var e=0;e<this.tileset_ids.length;e++){this.put_tile({id:e,x:e,y:0,layer:1});this.layers[1].render=true}};Gfx.prototype.put_tile=function(e){var t,n,r,i,s=this.sprites.tileset.width/this.screen.sprite_size,o=this.sprites.tileset.height/this.screen.sprite_size;if(e.id>=s){t=e.id%s;n=e.id/s<<0}else{t=e.id;n=0}if(e.pixel_perfect){r=e.x;i=e.y}else{r=e.x*this.screen.sprite_size*this.screen.scale;i=e.y*this.screen.sprite_size*this.screen.scale}this.layers[e.layer].ctx.drawImage(this.sprites.tileset,t*this.screen.sprite_size,n*this.screen.sprite_size,this.screen.sprite_size,this.screen.sprite_size,r,i,this.screen.sprite_size*this.screen.scale,this.screen.sprite_size*this.screen.scale)};var Gui=function(){this.layer=null;this.bubbles=[];this.buttons=[]};Gui.prototype.init=function(e){this.layer=e.layer;this.add_button({x:game.world.width-3,y:2,sprites:[23,22],changer:"pause",fn:function(){game.pause=!game.pause}})};Gui.prototype.zeros=function(e,t){var n=e+"";while(n.length<t)n="0"+n;return n};Gui.prototype.clear=function(){game.gfx.layers[this.layer].ctx.clearRect(0,0,game.gfx.screen.width*game.gfx.screen.scale,game.gfx.screen.height*game.gfx.screen.scale)};Gui.prototype.draw_image=function(e){var t=e.x*game.gfx.screen.scale*game.gfx.screen.sprite_size,n=e.y*game.gfx.screen.scale*game.gfx.screen.sprite_size,r=game.gfx.sprites[e.name];if(e.center){t-=(r.width*.5<<0)*game.gfx.screen.scale;n-=(r.height*.5<<0)*game.gfx.screen.scale}game.gfx.layers[this.layer].ctx.drawImage(r,0,0,r.width,r.height,t,n,r.width*game.gfx.screen.scale,r.height*game.gfx.screen.scale)};Gui.prototype.draw_box=function(e){var t,n,r=e.width,i=e.height,s={x:e.x,y:e.y};for(t=0;t<r;t++){for(n=0;n<i;n++){if(n===0){if(t===0)tile=e.sprites[0];if(t>0&&t<r-1)tile=e.sprites[1];if(t===r-1)tile=e.sprites[2]}if(i>2&&n>0){if(t===0)tile=e.sprites[3];if(t>0&&t<r-1)tile=e.sprites[4];if(t===r-1)tile=e.sprites[5]}if(n===i-1){if(t===0)tile=e.sprites[6];if(t>0&&t<r-1)tile=e.sprites[7];if(t===r-1)tile=e.sprites[8]}if(tile){game.gfx.put_tile({layer:e.layer,id:tile,x:s.x+t,y:s.y+n})}}}};Gui.prototype.draw_loading=function(e){var t=game.gfx.layers[this.layer].ctx,n=game.gfx.screen.width*game.gfx.screen.scale,r=game.gfx.screen.height*game.gfx.screen.scale;t.textBaseline="bottom";t.textAlign="center";t.fillStyle="#fff";t.font="900 "+4*game.gfx.screen.scale+"px 'Source Code Pro', monospace,serif";t.fillText("LOADING GAME..",n*.5<<0,r*.5<<0)};Gui.prototype.draw_fps=function(){var e=game.gfx.layers[this.layer].ctx;e.font="900 "+5*game.gfx.screen.scale+"px 'Source Code Pro', monospace,serif";e.textBaseline="bottom";e.textAlign="right";e.fillStyle="#fff";e.fillText("FPS "+game.fps,(game.world.width-2)*game.gfx.screen.scale*game.gfx.screen.sprite_size,(game.world.height-1)*game.gfx.screen.scale*game.gfx.screen.sprite_size)};Gui.prototype.draw_pointer=function(){var e=game.input.pointer.pos.x<<0,t=game.input.pointer.pos.y<<0;game.gfx.layers[this.layer].ctx.drawImage(game.gfx.sprites.pointer,game.input.pointer.enable?8:0,0,8,8,e,t,8*game.gfx.screen.scale,8*game.gfx.screen.scale)};Gui.prototype.add_button=function(e){this.buttons.push({pos:{x:e.x,y:e.y},sprites:e.sprites,changer:e.changer,fn:e.fn})};Gui.prototype.draw_buttons=function(){var e,t;for(e in this.buttons){t=this.buttons[e];game.gfx.put_tile({layer:this.layer,id:game[t.changer]?t.sprites[0]:t.sprites[1],x:t.pos.x,y:t.pos.y})}};Gui.prototype.button_clicked=function(e,t){var n,r;for(n in this.buttons){r=this.buttons[n];if(e>=r.pos.x&&e<r.pos.x+1&&t>=r.pos.y&&t<r.pos.y+1){r.fn();return true}}return false};var Input=function(){this.pointer={enable:false,pos:{x:null,y:null}}};Input.prototype.init=function(){var e=document.getElementById("game");e.addEventListener("mousedown",this.enable_pointer,false);e.addEventListener("mouseup",this.disable_pointer,false);e.addEventListener("mousemove",this.track_pointer,false);e.addEventListener("touchstart",this.enable_pointer,false);e.addEventListener("touchend",this.disable_pointer,false);e.addEventListener("touchcancel",this.disable_pointer,false);e.addEventListener("touchmove",this.track_pointer,false);e.addEventListener("contextmenu",function(e){e.preventDefault()},false)};Input.prototype.enable_pointer=function(e){e.preventDefault();var t,n;if(e.touches){t=e.touches[0].pageX;n=e.touches[0].pageY}else{t=e.pageX;n=e.pageY}game.input.pointer.enable=true;game.user_select_on_screen()};Input.prototype.disable_pointer=function(){game.input.pointer.enable=false};Input.prototype.track_pointer=function(e){e.preventDefault();var t,n,r=this.getBoundingClientRect(),i=r.left,s=r.top;if(e.touches){t=e.touches[0].pageX;n=e.touches[0].pageY}else{t=e.pageX;n=e.pageY}game.input.pointer.pos.x=t-i;game.input.pointer.pos.y=n-s;game.user_draw_on_screen()};Messages=function(){this.layer=null;this.bubbles=[]};Messages.prototype.init=function(e){this.layer=e.layer};Messages.prototype.draw_message=function(e){var t=game.gfx.layers[this.layer].ctx,n=0,r={},i=0,s=0,o,u,a,f,l,c;t.fillStyle="#000";t.font="900 "+5*game.gfx.screen.scale+"px 'Source Code Pro', monospace,serif";t.textBaseline="top";t.textAlign="left";for(f=0;f<e.msg.length;f++){s=e.msg[f].length;if(s>i){i=s;o=f}}o=t.measureText(e.msg[o]).width;u=(o/game.gfx.screen.sprite_size/game.gfx.screen.scale<<0)+2;a=f+1;if(u<2)u=2;r={x:e.x-u,y:e.y-a+1};game.gui.draw_box({layer:this.layer,width:u,height:a,x:r.x,y:r.y,sprites:[18,19,20,24,25,26,30,31,32]});for(var f=0;f<e.msg.length;f++){t.fillText(e.msg[f],(r.x*game.gfx.screen.sprite_size+5)*game.gfx.screen.scale,((r.y+f)*game.gfx.screen.sprite_size+4)*game.gfx.screen.scale)}};Messages.prototype.add_conversation=function(e){for(var t=0;t<e.bubbles.length;t++){this.bubbles.push({msg:e.bubbles[t],pos:{x:e.pos.x,y:e.pos.y},delay:t===0?e.delay||false:false,time:game.settings.conversation_time})}};Messages.prototype.draw_conversation=function(){var e;if(this.bubbles.length>0){bubble=this.bubbles[0];if(bubble.delay&&bubble.delay<0){if(bubble.time<0){this.draw_message({msg:bubble.msg,x:bubble.pos.x,y:bubble.pos.y});if(game.input.pointer.enable){this.bubbles.splice(0,1)}}else{bubble.time--}}else{bubble.delay--}}};Moog=function(){this.audio=new(window.AudioContext||window.webkitAudioContext)};Moog.prototype.play=function(e){if(e.pause)return;var t=e.vol||.2,n=e.attack||20,r=e.decay||300,i=e.freq||30,s=e.oscilator||0;gain=this.audio.createGain(),osc=this.audio.createOscillator();gain.connect(this.audio.destination);gain.gain.setValueAtTime(0,this.audio.currentTime);gain.gain.linearRampToValueAtTime(e.vol,this.audio.currentTime+n/1e3);gain.gain.linearRampToValueAtTime(0,this.audio.currentTime+r/1e3);osc.frequency.value=i;osc.type=s;osc.connect(gain);osc.start(0);setTimeout(function(){osc.stop(0);osc.disconnect(gain);gain.disconnect(game.moog.audio.destination)},r)};var time,fps=0,last_update=new Date*1-1,fps_filter=30;var Entity=function(e){this.life=e.life;this.type=e.type;this.energy=100;this.age=0;this.animations=e.animations;this.active_animation="idle";this.fps_limit=e.fps_limit;this.frame=Math.random()*(e.animations[this.active_animation].length-1)<<0;this.frame_counter=0;this.flip=false;this.pos={x:e.x,y:e.y};this.target={x:e.x,y:e.y};this.render_pos={x:e.x*game.gfx.screen.sprite_size*game.gfx.screen.scale,y:e.y*game.gfx.screen.sprite_size*game.gfx.screen.scale};this.speed=e.speed};Entity.prototype.distance_to=function(e){var t=0;var n=0;t=e.x-this.pos.x;t=t*t;n=e.y-this.pos.y;n=n*n;return Math.sqrt(t+n)<<0};Entity.prototype.change_animation_to=function(e){if(this.active_animation!==e){this.active_animation=e;this.frame=Math.random()*this.animations[this.active_animation].length<<0}};Entity.prototype.animate=function(){if(this.life&&this.frame_counter++>this.fps_limit+game.delta*this.speed){this.frame++;if(this.frame>=this.animations[this.active_animation].length){this.frame=0}this.frame_counter=0}};Gui.prototype.draw_intro=function(e){var t=game.gfx.layers[this.layer].ctx,n=game.gfx.screen.width*game.gfx.screen.scale,r=game.gfx.screen.height*game.gfx.screen.scale;t.textBaseline="bottom";t.textAlign="center";t.fillStyle="#000";t.font="900 "+4*game.gfx.screen.scale+"px 'Source Code Pro', monospace,serif";t.fillText("P1X PRESENTS",n*.5<<0,(r*.5<<0)-128);this.draw_image({name:"logo",x:game.world.width*.5<<0,y:(game.world.height*.5<<0)-2,center:true});t.fillText("8X8 SPRITES; 16 COLOUR PALETTE",n*.5<<0,r*.5<<0);game.gfx.layers[this.layer].ctx.fillText("#js13kGames compo",n*.5<<0,(r*.5<<0)+24);t.fillText("@W84DEATH",n*.5<<0,(r*.5<<0)+48);if(game.timer%2==1){t.fillStyle="#fff";t.fillText("CLICK TO START",n*.5<<0,(r*.5<<0)+128)}};var World=function(){this.width=0;this.height=0;this.data=[];this.entities=[]};World.prototype.init=function(e){var t,n;this.width=e.width;this.height=e.height;this.data=[this.width];for(t=0;t<this.width;t++){this.data[t]=[this.height];for(n=0;n<this.height;n++){this.data[t][n]={type:0,sprite:0,growing:1+Math.random()*10<<0,clear:true,grass:false,tree:false,target:false}}}};World.prototype.init_island=function(){var e,t,n,r,i,s,o,u,a=[[0,0,1,1,1,1,0,0,1,1,0],[1,1,1,1,2,1,1,0,0,1,0],[1,1,1,2,3,2,1,1,0,0,0],[0,1,2,3,2,2,2,1,0,0,0],[1,1,2,2,3,2,1,1,0,1,0],[1,1,1,2,2,1,1,1,0,0,0],[0,0,1,1,1,1,0,0,1,1,1],[1,0,0,0,0,0,0,1,1,2,1],[0,0,0,1,1,0,0,0,1,1,1],[0,0,0,1,1,0,0,0,0,0,0]];t=a[0].length;n=a.length;s=(this.width*.5<<0)-t*.5<<0;o=(this.height*.5<<0)-n*.5<<0;for(r=0;r<t;r++){for(i=0;i<n;i++){u=a[i][r];if(u==0||u==1){this.data[r+s][i+o].type=a[i][r]}if(u==2){this.data[r+s][i+o].type=1;this.data[r+s][i+o].grass=true;this.data[r+s][i+o].clear=false;this.data[r+s][i+o].sprite=Math.random()<.5?15:16}if(u==3){this.data[r+s][i+o].type=1;this.data[r+s][i+o].tree=true;this.data[r+s][i+o].clear=false;this.data[r+s][i+o].sprite=Math.random()<.5?21:22}}}game.spawn_entity({type:"tribe",x:s+4,y:o+2});game.spawn_entity({type:"tribe",x:s+3,y:o+1});game.spawn_entity({type:"tribe",x:s+5,y:o+2});for(var e=0;e<3;e++){game.spawn_entity({type:"rabbit",x:s+3,y:o+5})}};World.prototype.binary_neigbours=function(e,t,n){var r=0;if(this.data[e-1][t-1].type==n)r+=1;if(this.data[e][t-1].type==n)r+=2;if(this.data[e+1][t-1].type==n)r+=4;if(this.data[e+1][t].type==n)r+=8;if(this.data[e+1][t+1].type==n)r+=16;if(this.data[e][t+1].type==n)r+=32;if(this.data[e-1][t+1].type==n)r+=64;if(this.data[e-1][t].type==n)r+=128;return r};World.prototype.generate_sprites=function(){var e;for(x=1;x<this.width-1;x++){for(y=1;y<this.height-1;y++){if(this.data[x][y].type==1){e=this.binary_neigbours(x,y,1);if(e==60||e==120||e==56||e==124||e==40||e==108||e==44||e==104||e==121){this.data[x][y].sprite=6}else if(e==14||e==15||e==30||e==31||e==10||e==95||e==79||e==78){this.data[x][y].sprite=8}else if(e==240||e==241||e==224||e==225||e==160||e==176||e==177||e==245||e==228||e==229||e==161){this.data[x][y].sprite=7}else if(e==198||e==199||e==135||e==195||e==131||e==130||e==134||e==194||e==147||e==151||e==215){this.data[x][y].sprite=9}else if(e==112||e==48||e==96||e==32){this.data[x][y].sprite=12}else if(e==6||e==7||e==3||e==2){this.data[x][y].sprite=13}else if(e==28||e==8||e==24||e==12||e==29||e==88){this.data[x][y].sprite=10}else if(e==128||e==129||e==192||e==193||e==209){this.data[x][y].sprite=11}else if(e==143||e==207||e==159||e==223||e==158){this.data[x][y].sprite=x%2==0?4:5}else if(e==0||e==64||e==1||e==5||e==21||e==85||e==16||e==4||e==20||e==68){this.data[x][y].sprite=14}else{if(this.data[x][y].sprite!=2&&this.data[x][y].sprite!=3){if(this.data[x][y].sprite<15){this.data[x][y].sprite=Math.random()>.5?2:3}}}}}}};World.prototype.grow_plants=function(){var e=[],t,n,r,i,s;for(x=1;x<this.width-1;x++){for(y=1;y<this.height-1;y++){if(this.data[x][y].type==1){if(this.data[x][y].grass&&Math.random()*game.settings.grass_grow_factor<this.data[x][y].growing||this.data[x][y].tree&&Math.random()*game.settings.tree_grow_factor<this.data[x][y].growing){e=[];for(n=x-1;n<=x+1;n++){for(r=y-1;r<=y+1;r++){if(this.data[x][y].grass&&game.world.data[n][r].clear||this.data[x][y].tree&&(game.world.data[n][r].clear||game.world.data[n][r].grass)){if(this.binary_neigbours(n,r,1)==255){e.push({x:n,y:r})}}}}if(e.length>0){t=Math.random()*e.length<<0;i=e[t].x;s=e[t].y;if(this.data[x][y].grass){this.data[i][s].grass=true;this.data[i][s].sprite=Math.random()<.5?15:16}if(this.data[x][y].tree){this.data[i][s].tree=true;this.data[i][s].grass=false;this.data[i][s].sprite=Math.random()<.5?21:22}this.data[i][s].clear=false;game.gfx.put_tile({layer:1,id:this.data[i][s].sprite,x:i,y:s})}}}}}};Entity.prototype.ai=function(){var e=[],t,n=0,r=this.pos.x*game.gfx.screen.sprite_size*game.gfx.screen.scale,i=this.pos.y*game.gfx.screen.sprite_size*game.gfx.screen.scale;for(var s=this.pos.x-1;s<=this.pos.x+1;s++){for(var o=this.pos.y-1;o<=this.pos.y+1;o++){if(game.world.data[s]&&game.world.data[s][o]&&game.world.data[s][o].type==1){if(!game.find_entity_at_pos({x:s,y:o})){e.push({x:s,y:o})}else{n++}}}}if(Math.random()<=this.speed){if(e.length>0){if(r===this.render_pos.x&&i===this.render_pos.y){t=Math.random()*e.length<<0;this.pos.x=e[t].x;this.pos.y=e[t].y}}}else{if(r===this.render_pos.x&&i===this.render_pos.y){if(n>5){this.energy=(this.energy*.5<<0)-1}if(this.type=="rabbit"&&e.length>=2&&this.energy>=80&&Math.random()<=game.settings.rabbits_reproduction&&this.age>10){var t=Math.random()*e.length<<0;game.spawn_entity({type:"rabbit",x:e[t].x,y:e[t].y})}if(this.type=="rabbit"&&game.world.data[this.pos.x][this.pos.y].grass&&this.energy<50){game.world.data[this.pos.x][this.pos.y].grass=false;game.world.data[this.pos.x][this.pos.y].clear=true;game.world.data[this.pos.x][this.pos.y].sprite=Math.random()<.5?2:3;game.gfx.put_tile({layer:1,id:game.world.data[this.pos.x][this.pos.y].sprite,x:this.pos.x,y:this.pos.y});this.energy+=30;if(this.energy>100){this.energy=100}}if(this.type=="tribe"&&(game.world.data[this.pos.x][this.pos.y].grass||game.world.data[this.pos.x][this.pos.y].tree)&&this.energy<50){this.energy+=10;if(this.energy>100){this.energy=100}}}}};Entity.prototype.move=function(){var e=this.pos.x*game.gfx.screen.sprite_size*game.gfx.screen.scale,t=this.pos.y*game.gfx.screen.sprite_size*game.gfx.screen.scale,n=game.delta*this.speed<<0;if(e!==this.render_pos.x||t!==this.render_pos.y){this.change_animation_to("move");if(this.render_pos.x<e){this.render_pos.x+=n;this.flip=false}if(this.render_pos.x>e){this.render_pos.x-=n;this.flip=true}if(this.render_pos.y<t){this.render_pos.y+=n}if(this.render_pos.y>t){this.render_pos.y-=n}if(Math.abs(this.render_pos.x-e)<game.gfx.screen.sprite_size){this.render_pos.x=e}if(Math.abs(this.render_pos.y-t)<game.gfx.screen.sprite_size){this.render_pos.y=t}}else{this.change_animation_to("idle")}};var game={gfx:new Gfx({tiles_wide:40,tiles_high:22}),gui:new Gui,input:new Input,moog:new Moog,messages:new Messages,world:new World,fps:0,state:"loading",timer:0,pause:false,settings:{debug_world:false,game_clock:100,conversation_time:30,water_animations:18,rabbits_reproduction:.01,tribes_reproduction:.3,grass_grow_factor:1e3,tree_grow_factor:2e3},init:function(){window.setInterval(game.inc_timer,game.settings.game_clock);window.onblur=function(){game.pause=true};window.onfocus=function(){game.pause=false};this.gfx.init({layers:5});this.gui.init({layer:4});this.messages.init({layer:4});this.input.init();this.moog.play({freq:5e3,attack:80,decay:400,oscilator:3,vol:.2});this.world.init({width:game.gfx.screen.width/game.gfx.screen.sprite_size<<0,height:game.gfx.screen.height/game.gfx.screen.sprite_size<<0});game_loop()},inc_timer:function(){if(!game.pause){game.timer++;game.entitiesAI();game.world.grow_plants()}},new_game:function(){this.world.init_island();this.world.generate_sprites()},user_select_on_screen:function(){var e=this.input.pointer.pos.x/this.gfx.screen.scale/this.gfx.screen.sprite_size<<0,t=this.input.pointer.pos.y/this.gfx.screen.scale/this.gfx.screen.sprite_size<<0;if(this.state=="game"&&e>0&&t>0&&e<this.world.width-1&&t<this.world.height-1){if(this.world.data[e][t].type==0){this.world.data[e][t].type=1;this.world.generate_sprites();this.gfx.layers[1].render=true}else{this.world.data[e][t].targeted=!this.world.data[e][t].targeted;this.gfx.layers[3].render=true}}},user_draw_on_screen:function(){var e,t;if(this.input.pointer.enable&&this.state=="game"){e=this.input.pointer.pos.x/this.gfx.screen.scale/this.gfx.screen.sprite_size<<0;t=this.input.pointer.pos.y/this.gfx.screen.scale/this.gfx.screen.sprite_size<<0;if(e>0&&t>0&&e<this.world.width-1&&t<this.world.height-1&&this.world.data[e][t].type==0){this.world.data[e][t].type=1;this.world.generate_sprites();this.gfx.layers[1].render=true}}},entitiesAI:function(){var e,t;for(e in this.world.entities){t=this.world.entities[e];if(t.life){t.ai();t.energy-=t.type=="tribe"?.1:.5;if(t.energy<0){this.gfx.clear_sprite({layer:2,x:t.render_pos.x,y:t.render_pos.y});t.life=false;this.world.entities[e]=false}}}},find_entity_at_pos:function(e){var t,n;for(t in game.world.entities){n=game.world.entities[t];if(n.life&&n.pos.x===e.x&&n.pos.y===e.y){return true}}return false},spawn_entity:function(e){if(e.type=="rabbit"){this.world.entities.push(new Entity({type:e.type,life:true,speed:.1+Math.random()*.1,animations:{idle:[46,46,46,46,46,47],move:[48,50]},fps_limit:2,x:e.x,y:e.y}))}if(e.type=="tribe"){this.world.entities.push(new Entity({type:e.type,life:true,speed:.05+Math.random()*.05,animations:{idle:[42,42,42,42,42,42,44],move:[36,38,40,38]},fps_limit:4,x:e.x,y:e.y}))}},debug_binary_neighbors:function(e,t){var n=game.gfx.layers[2].ctx,r=e*game.gfx.screen.scale*game.gfx.screen.sprite_size+game.gfx.screen.sprite_size*.5*game.gfx.screen.scale,i=t*game.gfx.screen.scale*game.gfx.screen.sprite_size+game.gfx.screen.sprite_size*.5*game.gfx.screen.scale;n.textBaseline="middle";n.textAlign="center";n.fillStyle="#000";n.font="900 "+3*game.gfx.screen.scale+"px 'Source Code Pro', monospace,serif";n.fillText(this.world.binary_neigbours(e,t,1),r,i)},draw_energy:function(e){if(e.life){var t=game.gfx.layers[2].ctx,n=e.render_pos.x,r=e.render_pos.y,i=n+game.gfx.screen.sprite_size*.5*game.gfx.screen.scale,s=r+game.gfx.screen.sprite_size*.5*game.gfx.screen.scale;t.textBaseline="middle";t.textAlign="center";t.fillStyle=game.timer%2==0?"#000":"#fff";t.font="900 "+3*game.gfx.screen.scale+"px 'Source Code Pro', monospace,serif";t.fillText(e.energy<<0,i,s)}},update:function(){switch(this.state){case"loading":if(this.gfx.load()){this.gui.draw_box({layer:0,width:14,height:9,x:(this.world.width*.5<<0)-7,y:(this.world.height*.5<<0)-6,sprites:[18,19,20,24,25,26,30,31,32]});this.gfx.put_tile({layer:0,id:46,x:(this.world.width*.5<<0)+6,y:(this.world.height*.5<<0)+3});this.gfx.layers[0].render=true;this.state="intro"}break;case"intro":if(this.input.pointer.enable){this.new_game();this.gfx.layers[0].render=true;this.gfx.layers[1].render=true;this.state="game"}break;case"game":if(!game.pause){for(entity in this.world.entities){e=this.world.entities[entity];if(e.life){e.animate();e.age+=.1}}}break;case"game_over":if(this.input.pointer.enable){this.new_game();this.state="game"}break}},render:function(){this.gui.clear();var e,t,n,r,i,s;switch(this.state){case"loading":break;case"intro":this.gui.draw_intro();break;case"game":if(this.gfx.layers[0].render){for(t=0;t<this.world.width;t++){for(n=0;n<this.world.height;n++){this.gfx.put_tile({layer:0,id:Math.random()<.5?0:1,x:t,y:n})}}this.gfx.layers[0].render=false}for(e=0;e<this.settings.water_animations;e++){this.gfx.put_tile({layer:0,id:Math.random()<.5?0:1,x:Math.random()*this.world.width<<0,y:Math.random()*this.world.height<<0})}if(this.gfx.layers[1].render){this.gfx.clear_layer(1);if(this.settings.debug_world)this.gfx.clear_layer(2);for(t=0;t<this.world.width;t++){for(n=0;n<this.world.height;n++){if(this.world.data[t][n].type>0){this.gfx.put_tile({layer:1,id:this.world.data[t][n].sprite,x:t,y:n});if(this.settings.debug_world)this.debug_binary_neighbors(t,n)}}}this.gfx.layers[1].render=false}if(this.gfx.layers[3].render){this.gfx.clear_layer(3);for(t=0;t<this.world.width;t++){for(n=0;n<this.world.height;n++){if(this.world.data[t][n].type>0&&this.world.data[t][n].targeted){this.gfx.put_tile({layer:3,id:this.world.data[t][n].tree?33:27,x:t,y:n})}}}this.gfx.layers[3].render=false}for(i in this.world.entities){r=this.world.entities[i];if(r.life){this.gfx.clear_sprite({layer:2,x:r.render_pos.x,y:r.render_pos.y});r.move();this.gfx.put_tile({layer:2,id:r.animations[r.active_animation][r.frame]+(r.flip?1:0),x:r.render_pos.x,y:r.render_pos.y,pixel_perfect:true})}}this.gui.draw_fps();this.gui.draw_image({name:"logo",x:1,y:this.world.height-3});break;case"game_over":break}this.gui.draw_pointer()},loop:function(e,t){this.fps=t;this.delta=e;this.update();this.render()}};game.init()