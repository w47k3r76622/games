var canvas=null,ctx=null,nop=null,sprload=!1,world=[[]],pathStart=[8,8],pathEnd=[0,0],currentPath=[],playerHiddenLocation=-1,enemyImg=new Image;let isMoving=!1,enemy={pathStart:[],currentPath:[],pathEnd:[],isMoving:!1,color:"#3a4c64",isReturning:!1,spot:-1},friends=[];const defaultFriends=[{pathStart:[],currentPath:[],pathEnd:[],isMoving:!1,color:"#3a4c64"},{pathStart:[],currentPath:[],pathEnd:[],isMoving:!1,color:"#909e8d"},{pathStart:[],currentPath:[],pathEnd:[],isMoving:!1,color:"#c19e7e"},{pathStart:[],currentPath:[],pathEnd:[],isMoving:!1,color:"#393124"},];let hiddingSpots=[];const defaultHiddingSpots=[{pos:[5,5],occupied:!1,taken:!1,w:43,h:32,off:[-5,0],hidden:-1,image:1},{pos:[2,11],occupied:!1,taken:!1,hidden:-1,image:2,w:32,h:32},{pos:[4,7],occupied:!1,taken:!1,hidden:-1,image:3,w:32,h:32},{pos:[2,4],occupied:!1,taken:!1,hidden:-1,image:4,w:32,h:32},{pos:[10,10],occupied:!1,taken:!1,hidden:-1,image:5,off:[-8,0],w:48,h:30},];var bloodImg,nameImg,img1,img2,img3,img4,img5,seq1,seq2,ac=new AudioContext,when=ac.currentTime,tempo=132,lead=["G4  e","-   e","G3  e","-   e","F4  e","-   e","G#4  e","-   e","G4  e","-   e","G3  e","-   e","F4  e","-   e","G#4  e","-   e","G4  e","-   e","G3  e","-   e","F4  e","-   e","G#4  e","-   e","G4  e","-   e","G4  e","-   e","F4  e","-   e","G#4  e","-   e",],harmony=["D4  e","D3  e","D4  e","D3  e","F4  e","D3  e","F4  e","D3  e","D4  e","D3  e","D4  e","D3  e","F4  e","D3  e","F4  e","D3  e",];function generateHiddingSpots(){return hiddingSpots.forEach(e=>{let t=[-1,-1];for(;-1==t[0]&&-1==t[1];){let n=getRandomInt(2,13),a=getRandomInt(2,13);0==world[n][a]&&(t=[n,a],world[n][a]=-1)}e.pos=t}),!0}function loadImages(){(img1=new Image).src="./tent.png",(img2=new Image).src="./bush1.png",(img3=new Image).src="./log.png",(img4=new Image).src="./bush2.png",(img5=new Image).src="./log2.png",(bloodImg=new Image).src="./blood.png",(nameImg=new Image).src="./name.png"}function onload(){(canvas=document.getElementById("gameCanvas")).width=512,canvas.height=512,canvas.addEventListener("click",canvasClick,!1),(ctx=canvas.getContext("2d")).imageSmoothingEnabled=!1,loadImages(),hiddingSpots=JSON.parse(JSON.stringify(defaultHiddingSpots)),friends=JSON.parse(JSON.stringify(defaultFriends)),(nop=new Image).src="./log.png",nop.onload=loaded}function loaded(){sprload=!0,enemyImg.src="./enemy.png",createWorld()}function clrWrl(){for(var e=0;e<16;e++){world[e]=[];for(var t=0;t<16;t++)world[e][t]=0}}function createWorld(){clrWrl(),generateHiddingSpots(),currentPath=[],generateFriends(),startMovingFriends(),setInterval(()=>{update()},500)}function drawBlood(e,t){ctx.globalAlpha=.4,ctx.drawImage(bloodImg,e,t,32,32),ctx.globalAlpha=1}function redraw(){if(!sprload)return;ctx.fillStyle="rgba(165,193,80, 1)",ctx.fillRect(0,0,canvas.width,canvas.height);for(var e=0;e<16;e++)for(var t=0;t<16;t++)-11==world[e][t]?(ctx.drawImage(img1,32*e-5,32*t,43,32),drawBlood(32*e,32*t)):-12==world[e][t]?(ctx.drawImage(img2,32*e,32*t,32,32),drawBlood(32*e,32*t)):-13==world[e][t]?(ctx.drawImage(img3,32*e,32*t,32,32),drawBlood(32*e,32*t)):-14==world[e][t]&&(ctx.drawImage(img4,32*e,32*t,32,32),drawBlood(32*e,32*t)),-15==world[e][t]&&(ctx.drawImage(img5,32*e-8,32*t,48,30),drawBlood(32*e,32*t));let n=e=>{switch(e){case 1:return img1;case 2:return img2;case 3:return img3;case 4:return img4;case 5:return img5}};hiddingSpots.forEach(e=>{ctx.fillStyle=e.taken?"white":"grey";let t=e.off?e.off[0]:0,a=e.off?e.off[1]:0;ctx.drawImage(n(e.image),32*e.pos[0]+t,32*e.pos[1]+a,e.w,e.h)}),drawPlayer(),state==STATES.HIDDING?drawFriends():drawEnemy()}function canvasClick(e){if(state==STATES.GAME_START)seq1.play(when),seq2.play(when),state=STATES.HIDDING;else if(state==STATES.HIDDING){var t,n;if(isMoving)return;void 0!=e.pageX&&void 0!=e.pageY?(t=e.pageX,n=e.pageY):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t-=canvas.offsetLeft,currentPath=findPath(world,pathStart,pathEnd=[Math.floor(t/32),Math.floor((n-=canvas.offsetTop)/32)]),isMoving=!0}}function findPath(e,t,n){var a=Math.abs,i=Math.max,r=function e(t,n){return i(a(t.x-n.x),a(t.y-n.y))},o=function e(t,n,a,i,r,o,c,s,l){t=r>-1,n=o<16,a=c<16,i=s>-1,a&&(t&&d(c,r)&&l.push({x:c,y:r}),n&&d(c,o)&&l.push({x:c,y:o})),i&&(t&&d(s,r)&&l.push({x:s,y:r}),n&&d(s,o)&&l.push({x:s,y:o}))};function c(e,t){var n=t-1,a=t+1,i=e+1,r=e-1,c=n>-1&&d(e,n),s=a<16&&d(e,a),l=i<16&&d(i,t),h=r>-1&&d(r,t),_=[];return c&&_.push({x:e,y:n}),l&&_.push({x:i,y:t}),s&&_.push({x:e,y:a}),h&&_.push({x:r,y:t}),o(c,s,l,h,n,a,i,r,_),_}function d(t,n){return null!=e[t]&&null!=e[t][n]&&e[t][n]<=0}function s(e,t){return{Parent:e,value:t.x+16*t.y,x:t.x,y:t.y,f:0,g:0}}return function e(){for(var a,i,o,d,l,h,_,g,p=s(null,{x:t[0],y:t[1]}),$=s(null,{x:n[0],y:n[1]}),f=Array(256),u=[p],m=[],S=[];d=u.length;){for(_=0,l=256,h=-1;_<d;_++)u[_].f<l&&(l=u[_].f,h=_);if((i=u.splice(h,1)[0]).value==$.value){o=m[m.push(i)-1];do S.push([o.x,o.y]);while(o=o.Parent);f=m=u=[],S.reverse()}else{for(_=0,g=(a=c(i.x,i.y)).length;_<g;_++)f[(o=s(i,a[_])).value]||(o.g=i.g+r(a[_],i),o.f=o.g+r(a[_],$),u.push(o),f[o.value]=!0);m.push(i)}}return S}()}function generateFriend(e){let t=null,n=[];for(;null==t;){let a=getRandomInt(0,hiddingSpots.length-1);(t=hiddingSpots[a])&&!t.occupied||(t=null)}t.occupied=!0;let i;return i=[e+5,0],world[0]=0,n=findPath(world,i,t.pos),{friendPathStart:i,friendCurrentPath:n,hiddingSpot:t}}function generateFriends(){friends.forEach((e,t)=>{let{friendPathStart:n,friendCurrentPath:a,hiddingSpot:i}=generateFriend(t);e.pathStart=n,e.currentPath=a,e.pathEnd=i.pos})}function startMovingFriends(){friends.forEach(e=>e.isMoving=!0)}function generateEnemy(e=!0){if(e){let t=getRandomInt(0,hiddingSpots.length-1),n=hiddingSpots[t],a=[n.pos[0]-1,n.pos[1]],i=findPath(world,[7,1],a);enemy.spot=t,enemy.currentPath=i,enemy.pathEnd=a,enemy.pathStart=[7,1],enemy.isMoving=!0,enemy.isReturning=!e}else{let r=findPath(world,enemy.pathStart,[7,0]);enemy.currentPath=r,enemy.pathEnd=[7,0],enemy.isMoving=!0,enemy.isReturning=!e}}function cleanHiddingSpots(){hiddingSpots.forEach(e=>{world[e.pos[0]][e.pos[1]]=0,e.hidden=-1})}function move(){if(isMoving){let e=hiddingSpots.filter(e=>e.pos[0]==currentPath[0][0]&&e.pos[1]==currentPath[0][1]);if(e.length&&-1!=e[0].hidden){currentPath=pathStart,pathEnd=pathStart,isMoving=!1;return}1==currentPath.length?(isMoving=!1,pathStart=currentPath[0]):pathStart=currentPath.shift(),-1!==(playerHiddenLocation=isHidden())&&(hiddingSpots[playerHiddenLocation].occupied=!0)}}function isHidden(){return hiddingSpots.findIndex(e=>{let t=pathStart[0],n=pathStart[1];return e.pos[0]==t&&e.pos[1]==n})}function moveEnemy(){enemy.isMoving&&(1==enemy.currentPath.length?(enemy.isMoving=!1,enemy.pathStart=enemy.currentPath[0],enemy.isReturning&&(state=STATES.HIDDING,seq1.play(when),seq2.play(when),tick=TICK_START,pathStart=[8,8],startMovingFriends())):enemy.pathStart=enemy.currentPath.shift())}function drawEnemy(){drawPerson(32*enemy.pathStart[0],32*enemy.pathStart[1],"white");let e=32*enemy.pathStart[0],t=32*enemy.pathStart[1];ctx.fillStyle="white",ctx.beginPath(),ctx.moveTo(e+26,t+17),ctx.lineTo(e+30,t),ctx.lineTo(e+28,t+17),ctx.closePath(),ctx.stroke(),ctx.fill()}function moveFriends(){friends.forEach((e,t)=>{if(e.isMoving){if(1==e.currentPath.length){e.isMoving=!1,friendPathStartX=t+5,friendPathStartY=0,e.pathStart=[friendPathStartX,friendPathStartY];let n=hiddingSpots.filter(t=>t.pos[0]==e.currentPath[0][0]&&t.pos[1]==e.currentPath[0][1]);if(n&&n.length){if(n[0].taken){let{friendPathStart:a,friendCurrentPath:i,hiddingSpot:r}=generateFriend(e);e.pathStart=a,e.currentPath=i,e.pathEnd=r.pos,e.isMoving=!0}else n[0].hidden=t}return}let o=e.currentPath.shift();if(e.pathStart=o,-1!==playerHiddenLocation){let c=hiddingSpots[playerHiddenLocation].pos;if(e.pathEnd[0]==c[0]&&e.pathEnd[1]==c[1]){let d=hiddingSpots.filter(e=>!1==e.occupied)[0];friendCurrentPath=findPath(world,o,d.pos),e.currentPath=friendCurrentPath,playerHiddenLocation=-1}}}})}function drawFriends(){friends.forEach(e=>{e.isMoving&&e.pathStart&&drawPerson(32*e.pathStart[0],32*e.pathStart[1],e.color)})}seq1=new TinyMusic.Sequence(ac,tempo,lead),seq2=new TinyMusic.Sequence(ac,tempo,harmony),seq1.staccato=.55,seq2.staccato=.55,seq1.gain.gain.value=.3,seq2.gain.gain.value=.2,seq1.mid.frequency.value=800,seq1.mid.gain.value=3,seq2.mid.frequency.value=1200;var TICK_START=20,tick=TICK_START,enemyTick=5,gameOverTick=0,canMoveFriends=!1,STATES={HIDDING:"HID",TRANSITION:"TRA",ATTACK:"ATT",GAME_OVER:"OVER",YOU_WIN:"WIN",GAME_START:"START"},state=STATES.GAME_START;function update(){if(state==STATES.GAME_OVER){if(ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(enemyImg,25,75,canvas.width-50,canvas.height-75),gameOverTick>6)state=STATES.GAME_START,gameOverTick=0;else if(gameOverTick>3){ctx.font="bold 32px serif",ctx.fillStyle="white";let e="No one survived that night",t=ctx.measureText(e).width;ctx.fillText(e,canvas.width/2-t/2,100),clrWrl(),hiddingSpots=JSON.parse(JSON.stringify(defaultHiddingSpots)),friends=JSON.parse(JSON.stringify(defaultFriends)),generateHiddingSpots(),currentPath=[],generateFriends(),startMovingFriends()}gameOverTick++}else if(state==STATES.GAME_START){ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(nameImg,64,64,384,128),ctx.font="bold 32px serif",ctx.fillStyle="white";let n="This is what happened that night",a=ctx.measureText(n).width;ctx.fillText(n,canvas.width/2-a/2,300),ctx.font="bold 24px serif";let i="Use the mouse to hide before he gets you",r=ctx.measureText(i).width;ctx.fillText(i,canvas.width/2-r/2,350)}else if(state==STATES.YOU_WIN){ctx.fillStyle="#000000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.font="bold 32px serif",ctx.fillStyle="white";let o="You were the only survivor.",c=ctx.measureText(o).width;ctx.fillText(o,canvas.width/2-c/2,100),gameOverTick>6&&(state=STATES.GAME_START,gameOverTick=0),gameOverTick++}else if(state==STATES.HIDDING){if(!friends.length){state=STATES.YOU_WIN;return}move(),tick<=TICK_START-1&&moveFriends(),10==--tick&&(generateEnemy(),enemyTick=5),0==tick&&(tick=TICK_START,zzfx(...[,,432,.01,,.42,,4,,,,,,,80,.1,,.65,.01,.32]),seq1.stop(),seq2.stop(),state=STATES.ATTACK),redraw()}else state==STATES.ATTACK&&(-1==(playerHiddenLocation=isHidden())&&(pathStart[1]<15?enemy.currentPath=[enemy.currentPath[0],[pathStart[0],pathStart[1]+1],]:enemy.currentPath=[enemy.currentPath[0],[pathStart[0],pathStart[1]-1],],3==--enemyTick&&handleAttack()),enemy.isMoving||(3==--enemyTick&&handleAttack(),1==enemyTick&&(cleanHiddingSpots(),generateFriends()),0!=enemyTick||(generateEnemy(!1),enemyTick=5)),moveEnemy(),redraw())}function handleAttack(){if(zzfx(...[1.3,,129,.02,.03,.04,4,2.6,4,,,,,.5,,.5,,.51,.01,]),-1==(playerHiddenLocation=isHidden())){state=STATES.GAME_OVER;return}if(-1==hiddingSpots[enemy.spot].hidden)zzfx(...[1.1,,403,,.35,.18,4,3.8,4,,-40,.01,,,20,.7,,.78,,.1,185,]),zzfx(...[2,,403,,.35,.18,4,3.8,4,,-40,.01,,,20,.7,,.78,,.1,185,]),gameOverTick=0,state=STATES.GAME_OVER;else{friends.splice(hiddingSpots[enemy.spot].hidden,1);let e=hiddingSpots[enemy.spot].pos[0],t=hiddingSpots[enemy.spot].pos[1];world[e][t]=-10-hiddingSpots[enemy.spot].image,hiddingSpots.splice(enemy.spot,1),hiddingSpots.forEach(e=>{e.occupied=!1,e.taken=!1})}}function getRandomInt(e,t){return e=Math.ceil(e),Math.floor(Math.random()*((t=Math.floor(t))-e+1))+e}function drawPlayer(){drawPerson(32*pathStart[0],32*pathStart[1],"black")}function drawPerson(e,t,n){ctx.strokeStyle="black",ctx.fillStyle="black",ctx.beginPath(),ctx.fillStyle=n,ctx.arc(e+16-1,t,3,0,2*Math.PI,!0),ctx.stroke(),ctx.fill(),ctx.beginPath(),ctx.moveTo(e+12,t+4),ctx.lineTo(e+8,t+6),ctx.lineTo(e+4,t+18),ctx.lineTo(e+10,t+10),ctx.lineTo(e+10,t+18),ctx.lineTo(e+19,t+18),ctx.lineTo(e+19,t+12),ctx.lineTo(e+24,t+18),ctx.lineTo(e+20,t+6),ctx.lineTo(e+16,t+4),ctx.fillStyle="black",ctx.moveTo(e+10,t+18),ctx.lineTo(e+11,t+32),ctx.lineTo(e+14,t+18),ctx.moveTo(e+15,t+18),ctx.lineTo(e+18,t+32),ctx.lineTo(e+19,t+18),ctx.closePath(),ctx.stroke(),ctx.fill()}onload();