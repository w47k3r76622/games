var SHAPEWARS=function(k,aE,aL,aV,aC){var P,I,bs,bw,e,bA,aD,z,aj,bj,be,h,bD,bm,m,J,ba,y,l,by=16.66666666,i=k.getElementById("f"),U=k.getElementById("b"),aa=i.getContext("2d"),bE=U.getContext("2d"),am=5,bp=3,an=160,aP=150,H,a6,a4,A,bh,ag,bt,aq,ap,bl,az,aB,a8=32,a7=30,aH=false,bi=0,bg=0,ah=40,aY=30,q,S,x=an/2-ah/2,w=aP/2-aY/2,aQ=Math.floor(an/ah),aX=Math.floor(aP/aY),aU,bx,bz=[],aN,aM,at,G,t,aS,d,W,bf,a1=false,B,bC,D=0,aJ=0,j,aZ,a2,bB,av=[0,1,2],f=[1,0,4,3,2];function bu(){if(ap<bt){ap=bt}else{if(ap>ag){ap=ag}}if(aq<bh){aq=bh}else{if(aq>A){aq=A}}}function v(bF,bG){return bF%bG}function u(bF,bG){return Math.floor(bF/bG)}function aK(bG,bF,bH){if(bG<I){return bF*bH+bG}else{return -1}}function ak(bF,bH){var bG=new Float32Array(15);bG[0]=bF;bG[1]=bH;bG[2]=x;bG[3]=w;bG[4]=-1;bG[5]=-1;bG[6]=-1;bG[7]=-1;bG[8]=0;bG[9]=165;bG[10]=-1;bG[11]=-1;bG[12]=aK(bF,bH,I);bG[13]=-1;bG[14]=0;return bG}function bd(bH,bK,bI){var bF,bJ,bG;bH[6]=bK;bH[7]=bI;bF=bK-bH[2];bJ=bI-bH[3];if(bF===0){bH[10]=0;if(bJ>0){bH[11]=1}else{bH[11]=-1}}else{if(bJ===0){if(bF>0){bH[10]=1}else{bH[10]=-1}bH[11]=0}else{if(Math.sqrt(Math.pow(bF,2)+Math.pow(bJ,2))>1){bG=Math.sqrt(Math.pow(1,2)*Math.pow(bJ,2)/(Math.pow(bF,2)+Math.pow(bJ,2)));if(bJ>0){bH[11]=bG}else{bH[11]=-bG;bJ=-bJ}bH[10]=bF/bJ*bG}}}}function bc(bG){var bF,bH;bF=bG[6]-bG[2];bH=bG[7]-bG[3];if(Math.sqrt(Math.pow(bF,2)+Math.pow(bH,2))<=1){bG[2]+=bF;bG[3]+=bH;bG[6]=-1;bG[7]=-1;bG[11]=-1;bG[10]=-1}else{bG[3]+=bG[11];bG[2]+=bG[10]}}function Q(){bE.clearRect(0,0,845,480);a5()}function aA(bG,bH){var bF;for(bF=0;bF<bx;bF+=1){if(bA[bH][bF]===0){bA[bH][bF]=2;return bF}}for(bF=0;bF<bx;bF+=1){if(bA[bH][bF]===4&&aD[bH][bF]===bG&&e[bH][bF]<20){bA[bH][bF]=3;return bF}}for(bF=0;bF<bx;bF+=1){if(bA[bH][bF]===4&&aD[bH][bF]!==bG){bA[bH][bF]=2;return bF}}for(bF=0;bF<bx;bF+=1){if(bA[bH][bF]===1&&aD[bH][bF]!==bG){bA[bH][bF]=2;return bF}}return undefined}function ac(bH,bG){var bF,bI;bF=aA(P[bH],bG[12]);if(bF!==undefined){bG[14]=0;bG[13]=bF;bI=u(bF,aQ);bF=v(bF,aQ);bd(bG,bF*ah,bI*aY)}else{bG[14]+=1;if(bG[14]>60){m[P[bH]]+=1;bG[4]=v(bH,I);bG[5]=u(bH,I);bG[8]=3;bd(bG,x,w);bG[14]=0}}}function aO(){var bH,bG,bI,bF;for(bH=0;bH<P.length;bH+=1){for(bG=0;bG<aj[bH];bG+=1){bI=J[bH][bG];if(bI[6]!==-1){bc(bI)}}if((P[bH]===y)||(t&&bm[P[bH]]===2)){if(aj[bH]<be[bH]&&(bw[bH]<1||bw[bH]===600)){bj[bH]+=1;for(bG=0;bG<aj[bH];bG+=1){if(J[bH][bG][8]===0){bj[bH]+=0.1}}if(bj[bH]>=400){bj[bH]=0;m[P[bH]]+=1;J[bH][aj[bH]]=ak(v(bH,I),u(bH,I));aj[bH]+=1;if(t&&bm[P[bH]]===2&&aM[P[bH]]!==-1){ay(P[bH],v(aM[P[bH]],I),u(aM[P[bH]],I),1)}Q()}}if(bw[bH]!==0){r(P[bH],bH);if(t&&bm[P[bH]]===2&&m[P[bH]]>0&&G[P[bH]]>60){G[P[bH]]=0;ay(P[bH],v(bH,I),u(bH,I),1)}if(t&&bm[P[bH]]===2&&m[P[bH]]>0&&G[P[bH]]<60){G[P[bH]]+=1}}bF=[];for(bG=0;bG<aj[bH];bG+=1){bI=J[bH][bG];if(bI[4]===-1&&bI[6]===-1&&bI[8]===0){bd(bI,Math.random()*(an-ah),Math.random()*(aP-aY))}else{if(bI[4]!==-1&&bI[6]===-1){if(bI[2]!==x&&bI[3]!==w){bd(bI,x,w)}else{bI[0]=bI[4];bI[1]=bI[5];bI[12]=aK(bI[0],bI[1],I);bI[4]=-1;bI[5]=-1;if(P[bH]===P[bI[12]]){if(bH===bI[12]){bI[8]=0}else{bI[8]=1}}else{bI[8]=1}}}else{if(bI[8]===1){if(bI[2]===x&&bI[3]===w&&bI[6]===-1){ac(bH,bI)}else{if(bI[6]===-1){if(bA[bI[12]][bI[13]]===2){bI[9]-=1;e[bI[12]][bI[13]]-=1;if(bw[bI[12]]>=0){bw[bI[12]]=1}if(bI[9]===0){bF.push(bG);Q();if(P[bI[12]]===9){bA[bI[12]][bI[13]]=0}else{bA[bI[12]][bI[13]]=4}}if(e[bI[12]][bI[13]]===0){aD[bI[12]][bI[13]]=P[bH];if(bI[9]===0){bA[bI[12]][bI[13]]=4}else{bA[bI[12]][bI[13]]=3}}}else{if(bA[bI[12]][bI[13]]===3){if(bw[bI[12]]>=0){bw[bI[12]]=1}bI[9]-=1;e[bI[12]][bI[13]]+=1;if(bI[9]===0){bF.push(bG);Q();bA[bI[12]][bI[13]]=4}if(e[bI[12]][bI[13]]===20){bA[bI[12]][bI[13]]=1}}else{if(bA[bI[12]][bI[13]]===1){ac(bH,bI)}}}}}}}}}if(bF.length>0){for(bG=aj[bH];bG>=0;bG-=1){for(bI=0;bI<bF.length;bI+=1){if(bG===bF[bI]){aj[bH]-=1;J[bH].splice(bG,1);break}}}}}}}function a(bJ){var bI,bG,bF,bH;for(bI=0;bI<bw.length;bI+=1){if(z[bI][bJ]===1){if(bw[bI]>0&&bw[bI]<600){bw[bI]+=1}bF=true;for(bG=0;bG<bx;bG+=1){if(aD[bI][bG]!==bJ){bF=false;break}}if(bF&&bw[bI]>1){bw[bI]=-1;aN[bJ]=P[bI];P[bI]=bJ}else{if(!bF&&bw[bI]===-1){bw[bI]=1}}bF=true;for(bG=0;bG<bx;bG+=1){if(e[bI][bG]<20||aD[bI][bG]!==bJ){bF=false;break}}if(bF){if(bm[bJ]===2){aM[bJ]=at[bJ];at[bJ]=-1}bw[bI]=0;Q();for(bG=0;bG<z[bI].length;bG+=1){if(z[bI][bG]===1){z[bI][bG]=0}}}}}}function E(){D=80}function bn(bF,bI,bH,bG){bF+=a6-aq;bI+=a4-ap;if(bF>=bh&&bF<=bl&&bI>=bt&&bI<=az){bG.drawImage(bH,bF,bI)}}function a5(){var bH,bG,bF,bI;for(bH=0;bH<P.length;bH+=1){if(P[bH]!==8){bF=v(bH,I)*an+a6-aq;bI=u(bH,I)*aP+a4-ap;if(bF>=bh&&bF<=bl&&bI>=bt&&bI<=az){if(bw[bH]>0){bE.drawImage(aU,bF-5,bI-5)}bE.drawImage(H[P[bH]],bF,bI)}}}}function c(bH,bG,bM,bI,bF,bK,bJ,bL){bH.beginPath();bH.rect(bG,bM,bI,bF);bH.closePath();bH.lineWidth=2;bH.strokeStyle=bK;bH.stroke();bH.fillStyle=bJ;return bH}function ar(){var bI,bH,bJ,bG,bF;for(bI=0;bI<P.length;bI+=1){if(P[bI]<8){for(bH=0;bH<aj[bI];bH+=1){bJ=J[bI][bH];bn(bJ[0]*an+bJ[2],bJ[1]*aP+bJ[3],q[P[bI]],aa);bF=Math.round(bJ[9]/165*6);for(bG=0;bG<bF;bG+=1){bn(bJ[0]*an+bJ[2]+bG*4+7,bJ[1]*aP+bJ[3]+2,W,aa)}}}}}function V(){var bG,bF;for(bG=0;bG<bw.length;bG+=1){if(bw[bG]!==0){for(bF=0;bF<bx;bF+=1){if(aD[bG][bF]!==9){bn(v(bG,I)*an+v(bF,aQ)*ah,u(bG,I)*aP+u(bF,aQ)*aY,S[aD[bG][bF]],bE)}}}}}function br(){var bH,bG,bF,bI;for(bH=0;bH<P.length;bH+=1){if(P[bH]!==8){bF=v(bH,I)*an+a6-aq;bI=u(bH,I)*aP+a4-ap;if(bF>=bh&&bF<=bl&&bI>=bt&&bI<=az){for(bG=0;bG<be[bH];bG+=1){if(bG<aj[bH]){aa.drawImage(d,bF+12*bG+5,bI+aP-20)}else{aa.drawImage(aS,bF+12*bG+5,bI+aP-20)}}}}}}function aR(){aa.font="18px monospace";aa.fillStyle="white";if(aJ===0){aa.drawImage(af(0,0,845,30,"black","black",0.8),0,480-30)}else{if(aJ%15<5){aa.drawImage(af(0,0,845,30,"black","black",0.8),0,480-30)}else{if(aJ%15<10){aa.drawImage(af(0,0,845,30,"green","green",0.8),0,480-30)}else{aa.drawImage(af(0,0,845,30,"darkgreen","darkgreen",0.8),0,480-30)}}aa.textAlign="center";aa.fillText("CHANGED!",845/2,480-10);aJ-=1}if(D===0){aa.drawImage(af(0,0,845,30,"black","black",0.8),0,0)}else{if(D%15<5){aa.drawImage(af(0,0,845,30,"black","black",0.8),0,0)}else{if(D%15<10){aa.drawImage(af(0,0,845,30,"crimson","crimson",0.8),0,0)}else{aa.drawImage(af(0,0,845,30,"red","red",0.8),0,0)}}D-=1}aa.textAlign="end";if(B===0){aa.fillText("CONQUER ALL PLAYERS",845-10,480-10)}else{if(B===1){aa.fillText("CONQUER: "+h[j[y]]+"("+bD[j[y]]+")",845-10,480-10);aa.fillStyle=bD[j[y]];aa.fillText("("+bD[j[y]]+")",845-10,480-10);aa.fillStyle="white"}else{if(B===2){aa.fillText("FLATLAND FESTIVAL: NO SHAPE WINS THIS ROUND",845-10,480-10)}}}aa.textAlign="start";aa.fillText("OBJECTIVE REVERSAL IN "+Math.round(a2/1000),10,480-10);aa.fillText("MUSIC ON/OFF",10,20);aa.textAlign="end";if(bC===0){aa.fillText("NO RESTRICTIONS",845-10,20)}else{if(bC===1){aa.fillText("ATTACK NEUTRALS ONLY",845-10,20)}else{if(bC===4){aa.fillText("ATTACK ONLY: "+h[aZ[y]]+"("+bD[aZ[y]]+")",845-10,20);aa.fillStyle=bD[aZ[y]];aa.fillText("("+bD[aZ[y]]+")",845-10,20);aa.fillStyle="white"}else{if(bC===3){aa.fillText("A TRUCE! NO SHAPE CAN BE ATTACKED",845-10,20)}else{if(bC===2){aa.fillText("ATTACK PLAYERS ONLY",845-10,20)}}}}}}function M(){aa.drawImage(af(0,0,845,480,"black","black",0.5),0,0);aa.textAlign="center";aa.fillStyle="red";aa.font="80px monospace";aa.fillText("YOU HAVE LOST...",845/2,480/2+40);aa.font="30px monospace";aa.fillStyle="white";if(ab()){aa.fillText("Touch screen to restart game",845/2,480/2+120)}else{aa.fillText("Click to restart game",845/2,480/2+120)}}function aW(bJ){if(G[bJ]<550||bC===3){G[bJ]+=1}else{if(m[bJ]>0){G[bJ]=0;var bH=[],bL=0,bI,bF,bK,bG;for(bI=0;bI<P.length;bI+=1){bF=v(bI,I);bK=u(bI,I);if(P[bI]===bJ){if(bk(bI)){bL+=1}bG=aK(bF-1,bK,I);if(P[bG]!==8&&P[bG]!==undefined&&P[bG]!==bJ){if((bC===1&&P[bG]===9)||(bC===2&&P[bG]!==9)||(bC===4&&P[bG]===aZ[bJ])||bC===0){bH.push(bG)}}bG=aK(bF+1,bK,I);if(P[bG]!==8&&P[bG]!==undefined&&P[bG]!==bJ){if((bC===1&&P[bG]===9)||(bC===2&&P[bG]!==9)||(bC===4&&P[bG]===aZ[bJ])||bC===0){bH.push(bG)}}bG=aK(bF,bK-1,I);if(P[bG]!==8&&P[bG]!==undefined&&P[bG]!==bJ){if((bC===1&&P[bG]===9)||(bC===2&&P[bG]!==9)||(bC===4&&P[bG]===aZ[bJ])||bC===0){bH.push(bG)}}bG=aK(bF,bK+1,I);if(P[bG]!==8&&P[bG]!==undefined&&P[bG]!==bJ){if((bC===1&&P[bG]===9)||(bC===2&&P[bG]!==9)||(bC===4&&P[bG]===aZ[bJ])||bC===0){bH.push(bG)}}}}if(bH.length>0){aM[bJ]=bH[Math.floor(Math.random()*bH.length)];for(bI=0;bI<bL;bI+=1){ay(bJ,v(aM[bJ],I),u(aM[bJ],I),1)}}}}}function X(){var bF;for(bF=0;bF<bm.length;bF+=1){if(bm[bF]===2){if(aM[bF]===-1){aW(bF)}else{if(G[bF]<60){G[bF]+=1}else{G[bF]=0;if(!L(bF,v(aM[bF],I),u(aM[bF],I))){aM[bF]=-1}if((bC===1&&(P[aM[bF]]!==9&&P[aM[bF]]!==bF))||(bC===2&&P[aM[bF]]===9)||(bC===3)||(bC===4&&(P[aM[bF]]!==aZ[bF]&&P[aM[bF]]!==bF))){aM[bF]=-1}}}a(bF)}}}function O(){aa.clearRect(0,0,845,845);V();ar();br();aR();if(ba[y]===1){M()}}function T(bF){while(bF){l+=by;aO();a(y);if(t){X()}bF-=1}}function b(){var bF=false,bH,bG;if(B===0){for(bG=0;bG<h.length;bG+=1){if(a0(bG)){bF=true;if(bH!=undefined){bF=false;break}bH=bG}}}else{if(B===1){for(bG=0;bG<h.length;bG+=1){if(a0(bG)){if(!a0(j[bG])&&aN[bG]===j[bG]){bH=bG;bF=true;break}}}}}if(bF){a1=false;aE.removeEventListener("resize",ai);if(ab()){i.removeEventListener("touchstart",s);i.removeEventListener("touchend",aT)}else{aE.removeEventListener("keydown",R);i.removeEventListener("mousedown",ao)}aa.drawImage(af(0,0,845,480,"black","black",0.5),0,0);aa.font="50px monospace";aa.fillStyle="white";aa.textAlign="center";aa.fillText("GAME RESOLVED:",845/2,480/2-70);if(y===bH){aa.fillStyle="green";aa.font="80px monospace";aa.fillText("YOU HAVE WON!",845/2,480/2+40)}else{aa.fillStyle="red";aa.font="80px monospace";aa.fillText(h[bH]+" HAS WON!",845/2,480/2+40)}aa.font="30px monospace";if(B===0){aa.fillText("LAST SHAPE STANDING",845/2,480/2+100)}else{if(B===1){aa.fillText("CONQUERED: "+h[j[bH]]+"("+bD[j[bH]]+")",845/2,480/2+100)}}aa.fillStyle="white";aa.font="30px monospace";if(ab()){aa.fillText("Touch screen to restart game",845/2,480/2+160)}else{aa.fillText("Click to restart game",845/2,480/2+160)}if(bB!==undefined){clearTimeout(bB)}}else{for(bG=0;bG<h.length;bG+=1){if(!a0(bG)){ba[bG]=1}}}}function a0(bG){var bF;for(bF=0;bF<P.length;bF+=1){if(P[bF]===bG){return true}}return false}function g(){var bF=0,bH=0,bG;for(bG=0;bG<P.length;bG+=1){if(P[bG]!==8){if(P[bG]===9){bH+=1}else{bF+=1}}}return bH-bF}function o(){var bG=f[Math.floor(Math.random()*f.length)],bF;if(bG===bC){bG=o()}if(bG===1&&g()<h.length){bG=o()}if((bG===2||bG===4)&&g()>h.length){bG=o()}return bG}function n(bG,bF){var bH;if(bF){bH=(bG+1)%h.length}else{bH=(bG-1+h.length)%h.length}if(!a0(bH)){if(bF){bH=n(bG+1,bF)}else{bH=n(bG-1,bF)}}return bH}function a3(){var bG=0,bF;for(bF=0;bF<h.length;bF+=1){if(ba[bF]===1){bG+=1}}if(bG===h.length-1){return true}else{return false}}function K(){var bH=o(),bG,bF;if(bH===2&&h.length===2){bH=4}if(bH===bC){bH=K()}if(bH===4){if(a3()){bH=K()}else{if(B===1){aZ=j}else{aZ=[];bF=Math.random()<0.5?true:false;for(bG=0;bG<h.length;bG+=1){if(a0(bG)){aZ[bG]=n(bG,bF)}}}}}if(bH===3){a2=10000;if(t){for(bG=0;bG<h.length;bG+=1){if(bm[bG]===2){aM[bG]=-1}}}}if(bH===1){a2=15000;if(t){for(bG=0;bG<h.length;bG+=1){if(bm[bG]===2&&aM[bG]!==-1&&P[aM[bG]]!==9){aM[bG]=-1}}}}if(bC===4){a2=15000;if(t){for(bG=0;bG<h.length;bG+=1){if(bm[bG]===2&&aM[bG]!==-1&&P[aM[bG]]!==aZ[bG]){aM[bG]=-1}}}}if(bH===2){a2=20000;if(t){for(bG=0;bG<h.length;bG+=1){if(bm[bG]===2&&aM[bG]!==-1&&P[aM[bG]]===9){aM[bG]=-1}}}}return bH}function Y(){var bF=av[Math.floor(Math.random()*av.length)];if(bF===1&&a3()){bF=Y()}return bF}function aw(){var bH,bG,bF;bH=Y();if(bH===1){j=[];bF=Math.random()<0.5?true:false;for(bG=0;bG<h.length;bG+=1){if(a0(bG)){j[bG]=n(bG,bF)}}}a2=20000;return bH}function C(){aJ=80;var bF;if(B===undefined){B=0;bC=0;a2=30000}else{B=aw();bC=K()}bB=setTimeout(C,a2)}function Z(bG){if(a1){aE.requestAnimationFrame(Z)}var bF=Math.floor((bG-l)/by);if(bF>0){T(bF);O()}if(t){b()}a2-=bF*by}function L(bG,bF,bH){if(P[aK(bF-1,bH,I)]===bG){return 1}else{if(P[aK(bF,bH-1,I)]===bG){return 2}else{if(P[aK(bF+1,bH,I)]===bG){return 3}else{if(P[aK(bF,bH+1,I)]===bG){return 4}}}}return 0}function bk(bG){var bF;for(bF=0;bF<aj[bG];bF+=1){if(J[bG][bF][8]===0){return true}}return false}function aF(bG,bI,bF,bH){return Math.sqrt(Math.pow(bG-bF,2)+Math.pow(bI-bH,2))}function aI(bK,bF,bM,bG){var bJ,bL=[],bI,bH;bJ=aK(bF-1,bM,I);if(P[bJ]===bK){if(bk(bJ)){return bJ}else{bH=true;for(bI=0;bI<bG.length;bI+=1){if(bJ===bG[bI]){bH=false;break}}if(bH){bG.push(bJ);bL.push([bF-1,bM])}}}bJ=aK(bF,bM-1,I);if(P[bJ]===bK){if(bk(bJ)){return bJ}else{bH=true;for(bI=0;bI<bG.length;bI+=1){if(bJ===bG[bI]){bH=false;break}}if(bH){bG.push(bJ);bL.push([bF,bM-1])}}}bJ=aK(bF+1,bM,I);if(P[bJ]===bK){if(bk(bJ)){return bJ}else{bH=true;for(bI=0;bI<bG.length;bI+=1){if(bJ===bG[bI]){bH=false;break}}if(bH){bG.push(bJ);bL.push([bF+1,bM])}}}bJ=aK(bF,bM+1,I);if(P[bJ]===bK){if(bk(bJ)){return bJ}else{bH=true;for(bI=0;bI<bG.length;bI+=1){if(bJ===bG[bI]){bH=false;break}}if(bH){bG.push(bJ);bL.push([bF,bM+1])}}}bJ=null;for(bI=0;bI<bL.length;bI+=1){bH=aI(bK,bL[bI][0],bL[bI][1],bG);if(bJ===null){bJ=bH}else{if(bH!==null){if(aF(bF,bM,v(bJ,I),u(bJ,I))>aF(bF,bM,bL[bI][0],bL[bI][1])){bJ=bH}}}}return bJ}function ay(bI,bF,bK,bG){var bJ,bH;bJ=aK(bF,bK,I);if((bC===1&&(P[bJ]!==9&&P[bJ]!==bI))||(bC===2&&P[bJ]===9)||(bC===3&&P[bJ]!==bI)||(bC===4&&(P[bJ]!==aZ[bI]&&P[bJ]!==bI))){E();return}if(P[bJ]===bI){if(!bk(bJ)){bJ=aI(bI,bF,bK,[])}}else{bJ=aI(bI,bF,bK,[])}bw[aK(bF,bK,I)]=1;z[aK(bF,bK,I)][bI]=1;Q();if(bJ===aK(bF,bK,I)){for(bH=0;bH<aj[bJ];bH+=1){if(J[bJ][bH][8]===0){J[bJ][bH][4]=bF;J[bJ][bH][5]=bK;J[bJ][bH][8]=1;bd(J[bJ][bH],x,w);m[bI]-=1}}}else{for(bH=0;bH<aj[bJ];bH+=1){if(J[bJ][bH][8]===0){J[bJ][bH][4]=bF;J[bJ][bH][5]=bK;J[bJ][bH][8]=3;m[bI]-=1}}}}function r(bG,bH){var bF;for(bF=0;bF<aj[bH];bF+=1){if(J[bH][bF][8]===0){J[bH][bF][8]=1;bd(J[bH][bF],x,w);m[bG]-=1}}}function p(bH,bF,bI){if(m[bH]>0){var bG;if(P[aK(bF,bI,I)]!==8&&P[aK(bF,bI,I)]!==bH){bG=L(bH,bF,bI);if(bG!==0){ay(bH,bF,bI,bG)}}else{if(P[aK(bF,bI,I)]===bH){bG=L(bH,bF,bI);if(bG!==0){ay(bH,bF,bI,bG)}}}}}function ad(bI,bF){var bH=k.createElement("canvas"),bG;bH.width=an;bH.height=aP;bG=bH.getContext("2d");bG=c(bG,2,2,an-4,aP-4,bF,bI);bG.fill();return bH}function bo(bI,bF){var bH=k.createElement("canvas"),bG;bH.width=an+10;bH.height=aP+10;bG=bH.getContext("2d");bG=c(bG,5,5,an,aP,bF,bI,bI);bG.shadowBlur=20;bG.shadowColor="red";bG.globalAlpha=0.7;bG.stroke();bG.fill();return bH}function N(bF){var bH=k.createElement("canvas"),bG;bH.width=ah;bH.height=aY;bG=bH.getContext("2d");bG=c(bG,ah/4-2,aY/4-2,ah/2,aY/2,"white",bF);bG.shadowBlur=10;bG.shadowColor="white";bG.globalAlpha=1;bG.fill();return bH}function au(bH){var bG=k.createElement("canvas"),bF;bG.width=ah;bG.height=aY;bF=bG.getContext("2d");bF=c(bF,2,2,ah-4,aY-4,bH,bH);bF.fill();return bG}function af(bK,bJ,bG,bL,bM,bI,bH){var bN=k.createElement("canvas"),bF;bN.width=bG;bN.height=bL;bF=bN.getContext("2d");bF=c(bF,bK,bJ,bG-2*bK,bL-2*bJ,bI,bM);bF.shadowBlur=2;bF.shadowColor="white";bF.globalAlpha=bH||1;bF.stroke();bF.fill();return bN}function F(){var bF;H=new Array(10);q=new Array(h.length);S=new Array(h.length);aU=bo("red","red");d=af(1,1,10,10,"black","white");aS=af(1,1,10,10,"white","white");W=af(0,0,2,2,"white","white");for(bF=0;bF<10;bF+=1){H[bF]=undefined}H[9]=ad("Orange","Gold");for(bF=0;bF<h.length;bF+=1){H[bF]=ad(bD[bF],"Gold");q[bF]=N(bD[bF]);S[bF]=au(bD[bF])}}function aG(){a6=(845-am*an)/2;a4=(480-bp*aP)/2;A=(I-am+1)*an;ag=(bs-bp+1)*aP;bh=-1*an;bl=am*an+2*a6;bt=-1*aP;az=bp*aP+2*a4;F();bu()}function ae(bF,bG){if(!aH){aH=true;bi=bF;bg=bG}aq-=bF-bi;ap-=bG-bg;bi=bF;bg=bG;bu();Q()}function ai(){var bH=aE.innerWidth,bK=aE.innerHeight,bG=bH/845-0.02,bF=bK/480-0.02,bJ,bI;aB=Math.min(bG,bF);if(aB===bG){bJ="0px";bI=((bK-480*aB)/2)+"px"}else{bJ=((bH-845*aB)/2)+"px";bI="0px"}U.style.transformOrigin="0 0";U.style.transform="scale("+aB+")";i.style.transformOrigin="0 0";i.style.transform="scale("+aB+")";U.style.top=bI;i.style.top=bI;U.style.left=bJ;i.style.left=bJ}function R(bH){bH=bH||aE.event;var bG=bH.keyCode,bF=false;if(bG===38||bG===87){ap-=a7;bF=true}else{if(bG===40||bG===83){ap+=a7;bF=true}else{if(bG===37||bG===65){aq-=a8;bF=true}else{if(bG===39||bG===68){aq+=a8;bF=true}}}}if(bF){bu();Q()}}function ax(bF){ae(bF.offsetX,bF.offsetY)}function bb(bF){i.removeEventListener("mousemove",ax);i.removeEventListener("mouseout",bb)}function ao(bF){i.addEventListener("mousemove",ax);i.addEventListener("mouseout",bb)}function al(bH){if(bH.offsetX<100&&bH.offsetY<30){MUSIC.toggle();i.removeEventListener("mousemove",ax);i.removeEventListener("mouseout",bb);aH=false}else{if(a1&&ba[y]===0){i.removeEventListener("mousemove",ax);i.removeEventListener("mouseout",bb);if(aH===false){var bF=bH.offsetX+aq-a6,bI=bH.offsetY+ap-a4,bG;if(bF>0&&bI>0&&bF<=an*I&&bI<=aP*bs){p(y,Math.floor(bF/an),Math.floor(bI/aP))}}else{aH=false}}else{i.removeEventListener("mouseup",al);k.getElementById("game").style.display="none";k.getElementById("r").style.display="block";k.getElementById("mute").style.display="block"}}}function bq(bF){bF.preventDefault();var bG=bF.touches[0];ae(bG.screenX,bG.screenY)}function s(bF){i.addEventListener("touchmove",bq)}function aT(bF){i.removeEventListener("touchmove",bq);aH=false}function bv(){var bH,bG,bF;h=new Array(aC.length);bD=new Array(aC.length);bm=new Int8Array(aC.length);aN=new Int8Array(aC.length);ba=new Int8Array(aC.length);m=new Int8Array(aC.length);aM=new Int16Array(aC.length);at=new Int16Array(aC.length);G=new Int16Array(aC.length);bw=new Int16Array(aL.length*aL[0].length);for(bH=0;bH<aC.length;bH+=1){h[bH]=aC[bH].name;bD[bH]=aC[bH].color;bm[bH]=aC[bH].type;if(bm[bH]===0){y=bH}m[bH]=3;aM[bH]=-1;at[bH]=-1;aN[bH]=-1}t=false;if(y===0){for(bH=1;bH<aC.length;bH+=1){if(bm[bH]===2){t=true;break}}}bs=aL.length;I=aL[0].length;P=new Int8Array(aL.length*aL[0].length);be=new Int8Array(aL.length*aL[0].length);aj=new Int8Array(aL.length*aL[0].length);bj=new Float32Array(aL.length*aL[0].length);e=new Array(aL.length*aL[0].length);bA=new Array(aL.length*aL[0].length);z=new Array(aL.length*aL[0].length);aD=new Array(aL.length*aL[0].length);J=new Array(aL.length*aL[0].length);bx=aQ*aX;for(bH=0;bH<aL.length;bH+=1){for(bG=0;bG<aL[0].length;bG+=1){z[bH*aL[0].length+bG]=new Int8Array(aC.length);P[bH*aL[0].length+bG]=aL[bH][bG];be[bH*aL[0].length+bG]=aV[bH][bG];aj[bH*aL[0].length+bG]=0;bj[bH*aL[0].length+bG]=0;if(aL[bH][bG]!==8){e[bH*aL[0].length+bG]=new Int8Array(bx);bA[bH*aL[0].length+bG]=new Int8Array(bx);aD[bH*aL[0].length+bG]=new Int8Array(bx)}else{e[bH*aL[0].length+bG]=new Int8Array(1);bA[bH*aL[0].length+bG]=new Int8Array(1)}J[bH*aL[0].length+bG]=new Array(aV[bH][bG]);if(aL[bH][bG]<8){aj[bH*aL[0].length+bG]=3;J[bH*aL[0].length+bG][0]=ak(bG,bH);J[bH*aL[0].length+bG][1]=ak(bG,bH);J[bH*aL[0].length+bG][2]=ak(bG,bH)}for(bF=0;bF<e[bH*aL[0].length+bG].length;bF+=1){if(aL[bH][bG]!==8){if(aL[bH][bG]===9){e[bH*aL[0].length+bG][bF]=20;bA[bH*aL[0].length+bG][bF]=0}else{e[bH*aL[0].length+bG][bF]=20+5;bA[bH*aL[0].length+bG][bF]=1}aD[bH*aL[0].length+bG][bF]=aL[bH][bG]}}}}aq=0;ap=0}function ab(){if(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)){return true}return false}function a9(){bv();if(t){C()}a1=true;i.width=845;i.height=480;U.width=845;U.height=480;aG();ai();aE.addEventListener("resize",ai);i.addEventListener("mouseup",al);if(ab()){i.addEventListener("touchstart",s);i.addEventListener("touchend",aT)}else{aE.addEventListener("keydown",R);i.addEventListener("mousedown",ao)}a5();l=aE.performance.now();aE.requestAnimationFrame(Z)}a9()};var two_players={snake:{map:[[0,8,8,8,8],[9,8,9,9,8],[9,9,9,9,9],[8,9,9,8,9],[8,8,8,8,1]],types:[[5,0,0,0,0],[1,0,1,5,0],[1,0,3,0,1],[0,5,1,0,1],[0,0,0,0,5]]},tauros:{map:[[9,9,8,9,9],[9,8,8,8,9],[0,9,9,9,1],[9,8,8,8,9],[9,9,8,9,9]],types:[[2,4,0,4,2],[1,0,0,0,1],[5,1,1,1,5],[1,0,0,0,1],[2,4,0,4,2]]},rose:{map:[[8,9,9,9,8,1],[8,9,8,9,9,9],[9,9,9,8,9,8],[0,8,9,9,9,8]],types:[[0,4,1,3,0,5],[0,1,0,2,1,2],[2,1,2,0,1,0],[5,0,3,1,4,0]]},center:{map:[[0,9,9],[9,9,9],[9,9,1]],types:[[3,1,1],[1,5,1],[1,1,3]]}},two_players_index=["snake","tauros","rose","center"];var four_players={diamond:{map:[[8,8,1,8,8],[8,9,9,9,8],[0,9,9,9,2],[8,9,9,9,8],[8,8,3,8,8]],types:[[0,0,5,0,0],[0,3,1,3,0],[5,1,3,1,5],[0,3,1,3,0],[0,0,5,0,0]]},cross:{map:[[9,9,1,9,9],[9,8,9,8,9],[0,9,9,9,2],[9,8,9,8,9],[9,9,3,9,9]],types:[[4,2,5,2,4],[2,0,1,0,2],[5,1,1,1,5],[2,0,1,0,2],[4,2,5,2,4]]},nest:{map:[[0,9,8,9,1],[9,9,9,9,9],[8,9,8,9,8],[9,9,9,9,9],[3,9,8,9,2]],types:[[3,3,0,3,3],[3,3,1,3,3],[0,1,0,1,0],[3,3,1,3,3],[3,3,0,3,3]]}},four_players_index=["diamond","cross","nest"];var COMMUNICATION=(function(){var n=io(document.location.href),k=document.getElementById("log"),g=document.getElementById("r"),c=document.getElementById("register"),u=document.getElementById("settings"),r=document.getElementById("settings-2"),o=document.getElementById("settings-4"),s=document.getElementById("play"),y=document.getElementById("game"),i=document.getElementById("username"),q=document.getElementById("players"),d=document.getElementById("mode"),p,e,z,t=["blue","crimson","darkgreen","darkorange","darkslateblue","darkturquoise","hotpink","indigo"],f;function k(B,A,C){if(B===1){B="Received"}else{B="Sending"}k.innerHTML+="<li>"+Date.now()+" | "+B+" | "+A+" | "+C+"</li>"}function x(B){var A;f=B;g.style.display="none";u.style.display="block";if(e===4){o.style.display="block"}else{r.style.display="block"}if(p===0){for(A=0;A<e;A+=1){document.getElementById("p-"+(A+1)+"-type"+e).disabled=true;if(B[A].type===2){document.getElementById("p-"+(A+1)+"-type"+e).getElementsByTagName("option")[1].selected="selected"}else{document.getElementById("p-"+(A+1)+"-type"+e).getElementsByTagName("option")[0].selected="selected"}document.getElementById("p-"+(A+1)+"-name"+e).disabled=true;document.getElementById("p-"+(A+1)+"-name"+e).value=B[A].name;a(document.getElementById("p-"+(A+1)+"-color"+e),"cs "+B[A].color);document.getElementById("p-"+(A+1)+"-color"+e).getElementsByClassName(B[A].color)[0].selected="selected";w(B[A].color)}}}n.on("registered",function(A){k(1,"registered",JSON.stringify(A));x(A)});n.on("start",function(A){k(1,"start",JSON.stringify(A))});function j(A,B){k(0,A,JSON.stringify(B));n.emit(A,B)}function b(){z=i.value;e=parseInt(q.options[q.selectedIndex].value);p=parseInt(d.options[d.selectedIndex].value);if(p===1){j("register",{name:z,players:e,mode:p})}else{var B,A=[];A.push({name:z,color:t[0],type:0});for(B=1;B<e;B+=1){A.push({name:"pc-"+B,color:t[B],type:2})}x(A)}}function v(){var A,D,B,C=[];u.style.display="none";o.style.display="none";r.style.display="none";y.style.display="block";document.getElementById("mute").style.display="none";for(B=0;B<e;B+=1){C.push({name:document.getElementById("p-"+(B+1)+"-name"+e).value,color:t[document.getElementById("p-"+(B+1)+"-color"+e).options[document.getElementById("p-"+(B+1)+"-color"+e).selectedIndex].value],type:parseInt(document.getElementById("p-"+(B+1)+"-type"+e).options[document.getElementById("p-"+(B+1)+"-type"+e).selectedIndex].value)})}D=document.getElementById("map"+e).options[document.getElementById("map"+e).selectedIndex].value;if(e===4){if(D==="random"){D=four_players[four_players_index[Math.floor(Math.random()*four_players_index.length)]]}else{D=four_players[D]}}else{if(D==="random"){D=two_players[two_players_index[Math.floor(Math.random()*two_players_index.length)]]}else{D=two_players[D]}}A={map:D.map,types:D.types,players:C};SHAPEWARS(document,window,A.map,A.types,A.players)}function a(B,A){B.className=A}function m(A){var B;for(B=0;B<e;B+=1){document.getElementById("p-"+(B+1)+"-color"+e).getElementsByClassName(A)[0].disabled=false}}function w(A){var B;for(B=0;B<e;B+=1){document.getElementById("p-"+(B+1)+"-color"+e).getElementsByClassName(A)[0].disabled=true}}function h(A){m(this.className);a(this,this.options[this.selectedIndex].className);w(this.className)}function l(A){MUSIC.toggle()}c.addEventListener("click",b);s.addEventListener("click",v);document.getElementById("p-1-color4").addEventListener("change",h);document.getElementById("p-2-color4").addEventListener("change",h);document.getElementById("p-3-color4").addEventListener("change",h);document.getElementById("p-4-color4").addEventListener("change",h);document.getElementById("p-1-color2").addEventListener("change",h);document.getElementById("p-2-color2").addEventListener("change",h);document.getElementById("mute").addEventListener("click",l)})();var SOUNDS=function(){var l=typeof AudioContext!=="undefined"?new AudioContext:new webkitAudioContext,i=l.currentTime,c=160,g,f,e,h=false,j=["F2  e","F2  e","-  q","A2  e","A2  e","-  q","E2  e","E2  e","-  q","G2  e","G2  e","-  q","F2  e","-  e","C2  e","-  e","A2  e","-  e","F2  e","- e","E2  e","-  e","C2  e","- e","G2  e","-  e","A2  e","-  e"],b=["F5   e","A5  e","D5   e","D5  e","-   e","A5  e","-   e","Bb5  e","-   e","A5  e","-   e","F5 e","Bb4   e","A5  e","C5   e","Bb5  e","F5   e","A5  e","D5   e","D5  e","-   e","A5  e","-   e","Bb5  e","-   e","A5  e","-   e","F5 e","D5   e","A5  e","C5   e","Bb5  e"],d=["-  q","Bb2  q","A2  q","-   q","E2  q","-   q","G2  h","F2  q","-   q","A2  q","-   q","E2  q","-   q","G2  h"];g=new Sequence(l,c,j);f=new Sequence(l,c,b);e=new Sequence(l,c,d);g.staccato=0.55;f.staccato=0.55;e.staccato=0.05;e.smoothing=0.4;g.gain.gain.value=0.1/6;f.gain.gain.value=0.04/6;e.gain.gain.value=0.06/6;g.mid.frequency.value=800;g.mid.gain.value=3;f.mid.frequency.value=1200;e.mid.gain.value=3;e.bass.gain.value=6;e.bass.frequency.value=80;e.mid.gain.value=-6;e.mid.frequency.value=500;e.treble.gain.value=-2;e.treble.frequency.value=1400;function k(){h=true;i=l.currentTime;g.play(i);f.play(i+(60/c)*32);e.play(i+(60/c)*16)}function a(){h=false;g.stop();f.stop();e.stop()}return{start_music:function(){k()},stop_music:function(){a()},toggle:function(){if(h){a()}else{k()}}}};var MUSIC=new SOUNDS();MUSIC.start_music();