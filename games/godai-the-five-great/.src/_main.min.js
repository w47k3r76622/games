var FPS=60;var KEY_ENTER=13;var KEY_LEFT=37;var KEY_UP=38;var KEY_RIGHT=39;var KEY_DOWN=40;var SPIRITUPGRADES={earth:["Deep rest","Train"],water:["Health diet","Practise"],fire:["Run","Stealth hunt","Marathon","Study"],air:["Rest and muse","Improve"],"void":["Heal","Focus"]};var spiritUpgrades={earth:["Deep rest","Train"],water:["Health diet","Practise"],fire:["Run","Stealth hunt","Marathon","Study"],air:["Rest and muse","Improve"],"void":["Heal","Focus"]};var MINUTE_SECOND=2;var MINUTE_INCREASE=15;var DAYS_LEFT=13;var DISTANCE_LEFT=113;var SWORDSMAN_KNOWLEDGE=[{strength:2,technique:1},{strength:3,technique:1},{strength:3,technique:2},{strength:3,technique:2,strategy:1},{strength:4,technique:2,strategy:1},{strength:4,technique:3,strategy:1},{strength:4,technique:3,strategy:2},{strength:4,technique:3,strategy:2,perfection:1},{strength:5,technique:3,strategy:2,perfection:1},{strength:5,technique:4,strategy:2,perfection:1},{strength:5,technique:4,strategy:3,perfection:1},{strength:5,technique:4,strategy:3,perfection:2},{strength:5,technique:4,strategy:3,perfection:2,focus:1}];var DEATHWINDOW_FADEIN_TIME=1.5*FPS;var BATTLEWINDOW_FADEIN_TIME=1.5*FPS;var BATTLEWINDOW_FADEOUT_TIME=1.5*FPS;var ENEMY_LIFE_FACTOR=5;var READING_TIME=3*FPS;var FADING_TIME=2.5*FPS;var HEIGHT_FONT=25;var CANVAS_WIDTH=400;var CANVAS_HEIGHT=300;var REST_RECOVER_PER_Q=0.02;var HUNGER_PER_Q=0.025;var HUNGER_PAIN_TOLERANCE=250;var HUNGER_PAIN_DAMAGE=1;var WALK_DISTANCE_PER_Q=0.005;var WALK_COST_PER_Q=0.075;var HUNT_CHANCE_INC_PER_Q=0.33;var HUNT_COST_PER_Q=0.05;var FEED_RATION_COST_PER_Q=0.025;var FEED_RECOVER_PER_Q=0.5;var MEDITATE_COST_PER_Q=0.005;var SPIRIT_INCREASE_PER_Q=0.075;var RUN_DISTANCE_PER_Q=0.01;var RUN_COST_PER_Q=0.225;var MARATHON_DISTANCE_PER_Q=0.0075;var MARATHON_COST_PER_Q=0.1;var HEAL_COST_PER_Q=0.025;var HEAL_RECOVER_PER_Q=0.05;var DEEP_REST_FACTOR=1.5;var HEALTH_DIET_FACTOR=1.25;var STEALTH_HUNTING_FACTOR=1.25;var TRAINING_COST_PER_Q=0.05;var PRACTISING_COST_PER_Q=0.075;var STUDING_COST_PER_Q=0.01;var IMPROVING_COST_PER_Q=0.0125;var FOCUSING_COST_PER_Q=0.02;var GODAI_INCREASE_PER_Q=0.075;var MSG_HUNGER_DAMAGE="Ouch! Damage from hunger suffered.";var fatigueStates=["restful","in good shape","tired","shattered","exhausted"];var hungerStates=["satiated","light appetite","appetite","hunger","pain"];var RESTING="RESTING";var WALKING="WALKING";var HUNTING="HUNTING";var FEEDING="FEEDING";var MEDITATE="MEDITATING";var DEEP_RESTING="DEEP RESTING";var TRAIN="TRAINING";var HEALTH_DIET="ON HEALTH DIET";var PRACTISE="PRACTISING";var RUN="RUNNING";var STEALTH_HUNT="STEALTH HUNTING";var MARATHON="RUNNING MARATHON";var STUDY="STUDING";var REST_AND_MUSE="RESTING AND MUSING";var IMPROVE="SEARCHING FOR PERFECTION";var HEAL="HEALING";var FOCUS="FOCUSING MIND";var states=[{name:RESTING,events:{}},{name:WALKING,initial:true,events:{}},{name:HUNTING,events:{}},{name:FEEDING,events:{}},{name:MEDITATE,events:{}},{name:DEEP_RESTING,events:{}},{name:TRAIN,events:{}},{name:HEALTH_DIET,events:{}},{name:PRACTISE,events:{}},{name:RUN,events:{}},{name:STEALTH_HUNT,events:{}},{name:MARATHON,events:{}},{name:STUDY,events:{}},{name:REST_AND_MUSE,events:{}},{name:IMPROVE,events:{}},{name:HEAL,events:{}},{name:FOCUS,events:{}}];window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1000/FPS)}})();function Mouse(a){this._game=a;this._event=undefined;this._listen()}Mouse.prototype._listen=function(){var a=this;document.onmousedown=function(b){a._event=b;b.preventDefault()}};Mouse.prototype.handleMouseclicks=function(){if(this._event&&this._event.originalTarget.id=="canvas"){this._game.mouseClick()}this._event=undefined};function Keyboard(a){this._game=a;this._keys={};this._listen()}Keyboard.prototype._listen=function(){var a=this;document.onkeydown=function(b){a._keys[String(b.keyCode)]=true;b.preventDefault()}};Keyboard.prototype.handleKeypresses=function(){for(var a in this._keys){if(this._keys[a]){this._game.keyPressed(a)}}this._keys={}};function UI(a){this._scene=a;this._createUI();this._initializeUI()}UI.prototype._createUI=function(){var a=document.getElementById("divUI");a.style.display="block"};UI.prototype._initializeUI=function(){var a=this;this._restButton=document.getElementById("rest");this._walkButton=document.getElementById("walk");this._huntingButton=document.getElementById("hunt");this._feedButton=document.getElementById("feed");this._meditateButton=document.getElementById("meditate");this._restButton.onclick=function(b){a._scene.getMiyamoto().changeStateTo(RESTING)};this._walkButton.onclick=function(b){a._scene.getMiyamoto().changeStateTo(WALKING)};this._huntingButton.onclick=function(b){a._scene.getMiyamoto().changeStateTo(HUNTING)};this._huntingButton.value="Hunt";this._feedButton.onclick=function(b){a._scene.getMiyamoto().changeStateTo(FEEDING)};this._meditateButton.onclick=function(b){a._scene.getMiyamoto().changeStateTo(MEDITATE)}};UI.prototype._checkHuntingState=function(){if(this._scene.getMiyamoto().getState()!=HUNTING&&this._scene.getMiyamoto().getState()!=STEALTH_HUNT){this._huntingButton.innerHTML=this._huntingButton.value}else{this._huntingButton.innerHTML="Stop hunting"}};UI.prototype.checkIfTrainButtonsShouldBeEnabled=function(a){if(this._trainButton){this._trainButton.removeAttribute("disabled")}if(this._practiseButton){this._practiseButton.removeAttribute("disabled")}if(this._studyButton){this._studyButton.removeAttribute("disabled")}if(this._improveButton){this._improveButton.removeAttribute("disabled")}if(this._focusButton){this._focusButton.removeAttribute("disabled")}if(a.strength>=5){this._trainButton.setAttribute("disabled",true)}if(a.technique>=a.strength-1){this._practiseButton.setAttribute("disabled",true)}if(a.strategy>=a.technique-1){this._studyButton.setAttribute("disabled",true)}if(a.perfection>=a.strategy-1){this._improveButton.setAttribute("disabled",true)}if(a.focus>=a.perfection-1){this._focusButton.setAttribute("disabled",true)}};UI.prototype.addNewOption=function(a){var b=this;switch(a){case SPIRITUPGRADES.earth[0]:this._deepRestButton=document.getElementById(a);this._deepRestButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(DEEP_RESTING)};break;case SPIRITUPGRADES.earth[1]:this._trainButton=document.getElementById(a);this._trainButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(TRAIN)};break;case SPIRITUPGRADES.water[0]:this._healthDietButton=document.getElementById(a);this._healthDietButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(HEALTH_DIET)};break;case SPIRITUPGRADES.water[1]:this._practiseButton=document.getElementById(a);this._practiseButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(PRACTISE)};break;case SPIRITUPGRADES.fire[0]:this._runButton=document.getElementById(a);this._runButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(RUN)};break;case SPIRITUPGRADES.fire[2]:this._marathonButton=document.getElementById(a);this._marathonButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(MARATHON)};break;case SPIRITUPGRADES.fire[3]:this._studyButton=document.getElementById(a);this._studyButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(STUDY)};break;case SPIRITUPGRADES.air[0]:this._restAndMuseButton=document.getElementById(a);this._restAndMuseButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(REST_AND_MUSE)};break;case SPIRITUPGRADES.air[1]:this._improveButton=document.getElementById(a);this._improveButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(IMPROVE)};break;case SPIRITUPGRADES["void"][0]:this._healButton=document.getElementById(a);this._healButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(HEAL)};break;case SPIRITUPGRADES["void"][1]:this._focusButton=document.getElementById(a);this._focusButton.onclick=function(c){b._scene.getMiyamoto().changeStateTo(FOCUS)};break;default:break}};UI.prototype.upgradeHuntingOption=function(){var a=this;this._huntingButton=document.getElementById(SPIRITUPGRADES.fire[1]);this._huntingButton.innerHTML=SPIRITUPGRADES.fire[1];this._huntingButton.value=SPIRITUPGRADES.fire[1];this._huntingButton.onclick=function(b){a._scene.getMiyamoto().changeStateTo(STEALTH_HUNT)}};UI.prototype.show=function(){var a=document.getElementById("divUI");a.style.display="block"};UI.prototype.hide=function(){var a=document.getElementById("divUI");a.style.display="none"};UI.prototype.tick=function(){this._checkHuntingState()};function SpiritUI(a){this._scene=a;this._spiritUpgrades=spiritUpgrades;this._createSpiritUI();this._initializeSpiritUI()}SpiritUI.prototype._createSpiritUI=function(){var a=document.getElementById("divSpirit");a.style.display="none"};SpiritUI.prototype._hideOptionsAndRelaunchGame=function(a){a.hide();a._scene.showUI();a._scene.play()};SpiritUI.prototype._initializeSpiritUI=function(){var a=this;this._earthButton=document.getElementById("earthUP");this._waterButton=document.getElementById("waterUP");this._fireButton=document.getElementById("fireUP");this._airButton=document.getElementById("airUP");this._voidButton=document.getElementById("voidUP");this._earthButton.onclick=function(b){a._hideOptionsAndRelaunchGame(a);a._getSpiritUpgrade("earth")};this._waterButton.onclick=function(b){a._hideOptionsAndRelaunchGame(a);a._getSpiritUpgrade("water")};this._fireButton.onclick=function(b){a._hideOptionsAndRelaunchGame(a);a._getSpiritUpgrade("fire")};this._airButton.onclick=function(b){a._hideOptionsAndRelaunchGame(a);a._getSpiritUpgrade("air")};this._voidButton.onclick=function(b){a._hideOptionsAndRelaunchGame(a);a._getSpiritUpgrade("void")};this._checkAvailableUpgrades()};SpiritUI.prototype._shouldPowerBeDisabled=function(b){var a=this._scene.getMiyamoto().getSkill();switch(b){case SPIRITUPGRADES.earth[1]:if(a.strength>=5){return true}break;case SPIRITUPGRADES.water[1]:if(a.technique>=a.strength-1){return true}break;case SPIRITUPGRADES.fire[3]:if(a.strategy>=a.technique-1){return true}break;case SPIRITUPGRADES.air[1]:if(!a.strategy||a.perfection>=a.strategy-1){return true}break;case SPIRITUPGRADES["void"][1]:if(!a.perfection||a.focus>=a.perfection-1){return true}break;default:return false;break}return false};SpiritUI.prototype._getSpiritUpgrade=function(b){var d=document.getElementById(b);var c=this._spiritUpgrades[b][0];this._spiritUpgrades[b].splice(0,1);if(c==SPIRITUPGRADES.fire[1]){var e=document.getElementById("hunt");e.setAttribute("id",c);e.innerHTML=c;this._scene.getUI().upgradeHuntingOption()}else{var a=document.createElement("li");var f=document.createElement("button");f.setAttribute("type","button");f.setAttribute("id",c);if(this._shouldPowerBeDisabled(c)){f.setAttribute("disabled",true)}f.innerHTML=c;a.appendChild(f);d.appendChild(a);this._scene.getUI().addNewOption(c)}this._scene.getMessageWindow().add("Learned '"+c+"' power from "+b)};SpiritUI.prototype._checkAvailableUpgrades=function(){var e=0;for(var d in this._spiritUpgrades){if(!this._spiritUpgrades[d].length){var c=this["_"+d+"Button"];if(c.parentNode.parentNode){c.parentNode.parentNode.removeChild(c.parentNode)}}else{e++}}if(e==0){if(!document.getElementById("improvementLimit")){var f=this;var b=document.getElementById("improvement");var a=document.createElement("li");var c=document.createElement("button");c.setAttribute("id","improvementLimit");c.innerHTML="The Sky is the limit";c.onclick=function(g){g.preventDefault();f._hideOptionsAndRelaunchGame(f)};a.appendChild(c);b.appendChild(a)}}};SpiritUI.prototype.show=function(){var a=document.getElementById("divSpirit");a.style.display="block";this._checkAvailableUpgrades()};SpiritUI.prototype.hide=function(){var a=document.getElementById("divSpirit");a.style.display="none"};SpiritUI.prototype.tick=function(){};var SPRITE_SIZE=35;function SpriteMiyamoto(){this._initialize()}SpriteMiyamoto.prototype._initialize=function(){this._loaded=false;this._animate=false;this._walking=new Image();this._walking.src="img/walking.gif";this._walking.onload=function(){this._loaded=true};this._framesLost=0;this._count=0};SpriteMiyamoto.prototype.animate=function(){this._animate=true};SpriteMiyamoto.prototype.stop=function(){this._animate=false};SpriteMiyamoto.prototype._drawSprite=function(a){var b=this._count;a.drawImage(this._walking,b*SPRITE_SIZE,0,SPRITE_SIZE,SPRITE_SIZE,a.canvas.width/2-(SPRITE_SIZE*5/2),a.canvas.height/2-(SPRITE_SIZE*5/2),SPRITE_SIZE*5,SPRITE_SIZE*5)};SpriteMiyamoto.prototype.draw=function(a){this._drawSprite(a)};SpriteMiyamoto.prototype.tick=function(){if(this._animate){this._framesLost++;if(this._framesLost>4){this._count++;this._framesLost=0}if(this._count>6){this._count=0}}};function Time(b,a){this._scene=b;this._count=0;this._seconds=0;this._minutes=a.minutes||0;this._hours=a.hours||0;this._daysLeft=DAYS_LEFT}Time.prototype._getPrettyTime=function(){var a=(this._hours<10)?"0"+this._hours:this._hours;var b=(this._minutes<10)?"0"+this._minutes:this._minutes;return a+":"+b};Time.prototype.getDaysLeft=function(){return this._daysLeft};Time.prototype.draw=function(b){b.fillStyle="rgb(26, 26, 26)";b.font="bold 18px 'Lucida Console', Monaco, monospace";var d=this._getPrettyTime();var c=b.measureText(d).width;var a=b.canvas.width-20-c;var e=20;b.fillText(d,a,e);b.font="bold 14px 'Lucida Console', Monaco, monospace";if(this._daysLeft>1){d=this._daysLeft+" days left"}else{d="last day"}c=b.measureText(d).width;a=b.canvas.width-20-c;e=40;b.fillText(d,a,e)};Time.prototype.tick=function(){this._count++;if(this._count>=60){this._count=0;this._seconds++;this._scene.getMiyamoto().tick()}if(this._seconds>=MINUTE_SECOND){this._seconds=0;this._minutes+=MINUTE_INCREASE}if(this._minutes>=60){this._minutes=0;this._hours++}if(this._hours>=24){this._hours=0;this._daysLeft--}};function Distance(a){this._scene=a;this._distanceLeft=DISTANCE_LEFT}Distance.prototype.getDistanceLeft=function(){return this._distanceLeft};Distance.prototype.coverDistance=function(a){this._distanceLeft-=a;if(this._distanceLeft<=0){this._distanceLeft=0}};Distance.prototype.draw=function(b){b.fillStyle="rgb(26, 26, 26)";b.font="bold 14px 'Lucida Console', Monaco, monospace";var d="distance left: "+this._distanceLeft.toFixed(2)+" ri";var c=b.measureText(d).width;var a=20;var e=20;b.fillText(d,a,e)};Distance.prototype.tick=function(){};function EncounterList(a){this._scene=a;this._encounters=[];this._createEncounterList()}EncounterList.prototype._createEncounterList=function(){var c=["Hikita Bungoro","Kamiizumi Nobutsuna","Sasaki Kojiro","Tadashima Akiyama","Tsukahara Bokuden","Tsutsumi Hozan","Yagyu Munenori","Negishi Shingoro","Nakayama Hakudo","Chiba Narimasa","Shinto Munen","Maniwa Nen"];var d=DISTANCE_LEFT;for(var f=0;f<12;f++){var b=Math.floor(Math.random()*c.length);var g=d/(12-f);g=((Math.random()/2)+0.5)*g;d-=g;var e={name:c[b],skill:SWORDSMAN_KNOWLEDGE[f],ri:d};c.splice(b,1);this._encounters.push(e)}var a={name:"Miyake Gunbei",skill:SWORDSMAN_KNOWLEDGE[12],ri:0};this._encounters.push(a)};EncounterList.prototype.getEncounters=function(){return this._encounters};EncounterList.prototype.checkEncounters=function(){if(this._encounters[0]){var a=this._scene.getDistance().getDistanceLeft();if(this._encounters[0].ri>=a){var b=this._encounters.splice(0,1)[0];this._scene.launchBattleWindow(b)}}};function Miyamoto(c){this._scene=c;this._states=states;this._stateIndexes={};this._currentState=RESTING;this._lastState=RESTING;for(var b=0,a=states.length;b<a;b++){this._stateIndexes[this._states[b].name]=b;if(this._states[b].initial){this.changeStateTo(this._states[b].name)}}this._chanceToHuntSomething=0;this._training=0;this._practising=0;this._studing=0;this._improving=0;this._focusing=0;this._hungerPain=0;this._life=99;this._spirit=25;this._hunger=0;this._fatigue=0;this._supplies=4;this._skill={strength:3,technique:1,strategy:0,perfection:0,focus:0};this._spriteMiyamoto=new SpriteMiyamoto()}Miyamoto.prototype.getState=function(){return this._currentState.name};Miyamoto.prototype.getLife=function(){return this._life};Miyamoto.prototype.getSkill=function(){return this._skill};Miyamoto.prototype.changeStateTo=function(c){for(var b=0,a=states.length;b<a;b++){if(this._states[b].name==c){this._lastState=this._currentState;if(this._lastState.name==HUNTING){this._currentState=this._states[this._stateIndexes[RESTING]];this._resolveHunting()}else{if(this._lastState.name==STEALTH_HUNT){this._currentState=this._states[this._stateIndexes[RESTING]];this._resolveHunting()}else{this._currentState=this._states[b]}}this._scene.getMessageWindow().add("Miyamoto is "+this._currentState.name);return true}}return false};Miyamoto.prototype._rest=function(a){if(a){this._fatigue-=REST_RECOVER_PER_Q*DEEP_REST_FACTOR}else{this._fatigue-=REST_RECOVER_PER_Q}if(this._fatigue<=0){this._fatigue=0;this.changeStateTo(WALKING)}};Miyamoto.prototype._move=function(a){switch(a){case"walk":this._scene.getDistance().coverDistance(WALK_DISTANCE_PER_Q);this._fatigue+=WALK_COST_PER_Q;break;case"run":this._scene.getDistance().coverDistance(RUN_DISTANCE_PER_Q);this._fatigue+=RUN_COST_PER_Q;break;case"marathon":this._scene.getDistance().coverDistance(MARATHON_DISTANCE_PER_Q);this._fatigue+=MARATHON_COST_PER_Q;break;default:break}};Miyamoto.prototype._resolveHunting=function(){if(this._currentState!=HUNTING){var b=this._chanceToHuntSomething;var a=Math.random()*100;switch(true){case a<(b/4):this._supplies+=1;this._scene.getMessageWindow().add("1 ration hunt!");break;case a>=(b/4)&&a<(b/2):this._supplies+=2;this._scene.getMessageWindow().add("2 rations hunt!");break;case a>=(b/2)&&a<(3*b/4):this._supplies+=3;this._scene.getMessageWindow().add("3 rations hunt!");break;case a>=(3*b/4)&&a<b:this._supplies+=4;this._scene.getMessageWindow().add("4 rations hunt!");break;default:this._scene.getMessageWindow().add("No rations hunt!");break}this._chanceToHuntSomething=0}};Miyamoto.prototype._hunt=function(b){var a=(b)?STEALTH_HUNTING_FACTOR:1;if(this._lastState.name!=HUNTING&&this._lastState.name!=STEALTH_HUNT){this._chanceToHuntSomething+=HUNT_CHANCE_INC_PER_Q*a;this._fatigue+=HUNT_COST_PER_Q/a;if(this._chanceToHuntSomething>=80){this.changeStateTo(RESTING)}}else{this.changeStateTo(RESTING)}};Miyamoto.prototype.battleDecreasesLife=function(a){this._life-=a;if(this._life<=0){this._life=0}};Miyamoto.prototype._hungerPainDecreasesLife=function(){this._hungerPain+=this._hunger-80;if(this._hungerPain>=HUNGER_PAIN_TOLERANCE){this._hungerPain=0;this._life-=HUNGER_PAIN_DAMAGE*Math.random();var a=this._scene.getMessageWindow().getMessagesNumber();if(a<6||this._scene.getMessageWindow().getMessage(a-1)!=MSG_HUNGER_DAMAGE){this._scene.getMessageWindow().add(MSG_HUNGER_DAMAGE)}}};Miyamoto.prototype._checkHungerLimits=function(){if(this._hunger<=0){this._hunger=0;this.changeStateTo(RESTING)}if(this._supplies<=0){this._supplies=0;this.changeStateTo(MEDITATE)}};Miyamoto.prototype._checkHungerPainLimit=function(){if(this._hunger>=80){this._hungerPainDecreasesLife()}};Miyamoto.prototype._feed=function(a){if(a){this._hunger-=FEED_RECOVER_PER_Q*HEALTH_DIET_FACTOR;this._supplies-=FEED_RATION_COST_PER_Q/HEALTH_DIET_FACTOR}else{this._hunger-=FEED_RECOVER_PER_Q;this._supplies-=FEED_RATION_COST_PER_Q}this._checkHungerLimits()};Miyamoto.prototype._checkSpiritLimits=function(){if(this._spirit>=99){this._scene.getMessageWindow().add("Spiritual level gained!");this._spirit=0;this._scene.pause();this._scene.hideUI();this._scene.showSpiritualImprovementSelection()}};Miyamoto.prototype._meditate=function(){this._spirit+=SPIRIT_INCREASE_PER_Q;this._fatigue+=MEDITATE_COST_PER_Q;this._checkSpiritLimits()};Miyamoto.prototype._increaseHunger=function(){this._hunger+=HUNGER_PER_Q};Miyamoto.prototype._checkFatigueLimit=function(){if(this._fatigue>=99){this.changeStateTo(RESTING)}};Miyamoto.prototype._getPrettyFatigue=function(){var b=this._fatigue;var a=0;switch(true){case b<0:this._fatigue=0;a=0;break;case b>=0&&b<20:a=0;break;case b>=20&&b<40:a=1;break;case b>=40&&b<60:a=2;break;case b>=60&&b<80:a=3;break;case b>=80&&b<99:a=4;break;case b>=99:this._fatigue=99;a=4;break;default:break}return fatigueStates[a]};Miyamoto.prototype._getPrettyHunger=function(){var b=this._hunger;var a=0;switch(true){case b<0:this._hunger=0;a=0;break;case b>=0&&b<20:a=0;break;case b>=20&&b<40:a=1;break;case b>=40&&b<60:a=2;break;case b>=60&&b<80:a=3;break;case b>=80&&b<99:a=4;break;case b>=99:this._hunger=99;a=4;break;default:break}return hungerStates[a]};Miyamoto.prototype._train=function(){this._training+=GODAI_INCREASE_PER_Q;this._fatigue+=TRAINING_COST_PER_Q;if(this._training>=99){this._training=0;this._skill.strength+=1;this._scene.getMessageWindow().add("Miyamoto has now "+this._skill.strength+" point(s) of strength");this._scene.getUI().checkIfTrainButtonsShouldBeEnabled(this._skill);this.changeStateTo(RESTING)}};Miyamoto.prototype._practise=function(){this._practising+=GODAI_INCREASE_PER_Q;this._fatigue+=PRACTISING_COST_PER_Q;if(this._practising>=99){this._practising=0;this._skill.technique+=1;this._scene.getMessageWindow().add("Miyamoto has now "+this._skill.technique+" point(s) of technique");this._scene.getUI().checkIfTrainButtonsShouldBeEnabled(this._skill);this.changeStateTo(MEDITATE)}};Miyamoto.prototype._study=function(){this._studing+=GODAI_INCREASE_PER_Q;this._fatigue+=STUDING_COST_PER_Q;if(this._studing>=99){this._studing=0;this._skill.strategy+=1;this._scene.getMessageWindow().add("Miyamoto has now "+this._skill.strategy+" point(s) of strategy");this._scene.getUI().checkIfTrainButtonsShouldBeEnabled(this._skill);this.changeStateTo(RESTING)}};Miyamoto.prototype._improve=function(){this._improving+=GODAI_INCREASE_PER_Q;this._fatigue+=IMPROVING_COST_PER_Q;if(this._improving>=99){this._improving=0;this._skill.perfection+=1;this._scene.getMessageWindow().add("Miyamoto has now "+this._skill.perfection+" point(s) of perfection");this._scene.getUI().checkIfTrainButtonsShouldBeEnabled(this._skill);this.changeStateTo(MEDITATE)}};Miyamoto.prototype._focus=function(){this._focusing+=GODAI_INCREASE_PER_Q;this._fatigue+=FOCUSING_COST_PER_Q;if(this._focusing>=99){this._focusing=0;this._skill.focus+=1;this._scene.getMessageWindow().add("Miyamoto has now "+this._skill.focus+" point of correct mindset");this._scene.getUI().checkIfTrainButtonsShouldBeEnabled(this._skill);this.changeStateTo(WALKING)}};Miyamoto.prototype._heal=function(){this._life+=HEAL_RECOVER_PER_Q;this._fatigue+=HEAL_COST_PER_Q;if(this._life>=99){this._life=99;this.changeStateTo(RESTING)}};Miyamoto.prototype.tick=function(){this._spriteMiyamoto.tick();switch(this._currentState.name){case RESTING:this._rest(false);break;case WALKING:this._move("walk");break;case HUNTING:this._hunt(false);break;case FEEDING:this._feed(false);break;case MEDITATE:this._meditate();break;case DEEP_RESTING:this._rest(true);break;case TRAIN:this._train();break;case HEALTH_DIET:this._feed(true);break;case PRACTISE:this._practise();break;case RUN:this._move("run");break;case STEALTH_HUNT:this._hunt(true);break;case MARATHON:this._move("marathon");break;case STUDY:this._study();break;case REST_AND_MUSE:this._meditate();this._rest(false);break;case IMPROVE:this._improve();break;case HEAL:this._heal();break;case FOCUS:this._focus();break;default:break}if(this._currentState.name==WALKING||this._currentState.name==RUN||this._currentState.name==MARATHON){this._spriteMiyamoto.animate()}else{this._spriteMiyamoto.stop()}if(this._currentState.name!=FEEDING){this._increaseHunger()}this._checkHungerPainLimit();this._checkFatigueLimit()};Miyamoto.prototype.draw=function(a){this._spriteMiyamoto.draw(a);this._drawStatus(a)};Miyamoto.prototype._drawStatus=function(b){b.fillStyle="rgb(26, 26, 26)";b.font="bold 14px 'Lucida Console', Monaco, monospace";var d="life: "+this._life.toFixed(2);var a=20;var e=b.canvas.height-45;b.fillText(d,a,e);d="fatigue: "+this._getPrettyFatigue();var c=b.measureText(d).width;a=b.canvas.width-20-c;e=b.canvas.height-45;b.fillText(d,a,e);d="hunger: "+this._getPrettyHunger();var c=b.measureText(d).width;a=b.canvas.width-20-c;e=b.canvas.height-25;b.fillText(d,a,e);d="supplies: "+this._supplies.toFixed(2)+" rations";var c=b.measureText(d).width;a=b.canvas.width/2-c/2;e=b.canvas.height-5;b.fillText(d,a,e)};function DeathWindow(a){this._scene=a;this._initialize()}DeathWindow.prototype.show=function(a){this._visible=true;this._count=0;this._fadeIn=true};DeathWindow.prototype.hide=function(a){this._visible=false;this._initialize()};DeathWindow.prototype.isVisible=function(){return this._visible};DeathWindow.prototype._initialize=function(){this._visible=false;this._count=0;this._fadeIn=false;this._showTxt=false;this._fadeBG=0;this._fadeTxt=0};DeathWindow.prototype._drawWindowBackground=function(b){if(this._fadeIn){this._fadeBG=this._count/DEATHWINDOW_FADEIN_TIME;if(this._fadeBG>=1){this._fadeBG=1;this._fadeIn=false;this._showTxt=true;this._count=0}}b.strokeStyle="rgba(26, 26, 26, "+this._fadeBG+")";b.fillStyle="rgba(26, 26, 26, "+this._fadeBG+")";var a=b.canvas.width;var c=b.canvas.height;b.fillRect(0,0,a,c)};DeathWindow.prototype._drawText=function(b,f,c,e){var d=c.measureText(b).width;var a=c.canvas.width/2-d/2;c.fillStyle="rgba(255, 255, 255, "+e+")";c.fillText(b,a,f)};DeathWindow.prototype._drawMessages=function(a){a.fillStyle="white";a.font="bold 12px 'Lucida Console', Monaco, monospace";if(this._showTxt){this._fadeTxt=this._count/DEATHWINDOW_FADEIN_TIME;if(this._scene.getMiyamoto().getLife()<=0){this._drawText("Miyamoto Musashi is dead",a.canvas.height/2,a,this._fadeTxt)}else{this._drawText("Miyamoto did not accomplished the objective",a.canvas.height/2,a,this._fadeTxt)}}};DeathWindow.prototype.draw=function(a){if(!this._visible){return}this._drawWindowBackground(a);this._drawMessages(a)};DeathWindow.prototype.tick=function(){if(this._visible){this._count++}};function BattleWindow(a){this._scene=a;this._initialize()}BattleWindow.prototype.show=function(a){this._visible=true;this._count=0;this._fadeIn=true};BattleWindow.prototype.hide=function(a){this._visible=false};BattleWindow.prototype.launchEncounter=function(a){this._encounter=a;this._skillMiyamoto=this._scene.getMiyamoto().getSkill();this._encounterResult=this._calculateEncounterResult();this.show()};BattleWindow.prototype._initialize=function(){this._visible=false;this._count=0;this._fadeIn=false;this._showEnemy=false;this._showResult=false;this._fadeOut=false;this._fadeBG=0;this._fadeTxtEnemy=0;this._fadeTxtResult=0;this._encounter={}};BattleWindow.prototype._drawWindowBackground=function(b){if(this._fadeIn){this._fadeBG=this._count/BATTLEWINDOW_FADEIN_TIME*0.9;if(this._fadeBG>=0.9){this._fadeBG=0.9;this._fadeIn=false;this._showEnemy=true;this._count=0}}if(this._fadeOut){this._fadeBG=(1-((this._count-2*READING_TIME)/BATTLEWINDOW_FADEOUT_TIME))*0.9;if(this._fadeBG<=0){this._initialize();this.hide();this._scene.getMiyamoto().battleDecreasesLife(this._encounterResult.damage);this._scene.play();this._scene.showUI()}}b.strokeStyle="rgba(26, 26, 26, "+this._fadeBG+")";b.fillStyle="rgba(26, 26, 26, "+this._fadeBG+")";var a=b.canvas.width;var c=b.canvas.height;b.fillRect(0,0,a,c)};BattleWindow.prototype._drawText=function(b,f,c,e){var d=c.measureText(b).width;var a=c.canvas.width/2-d/2;c.fillStyle="rgba(255, 255, 255, "+e+")";c.fillText(b,a,f)};BattleWindow.prototype._drawMessages=function(b){b.fillStyle="white";b.font="bold 12px 'Lucida Console', Monaco, monospace";this._drawText("ENCOUNTER!",b.canvas.height*0.75,b,this._fadeBG);if(this._showEnemy){this._fadeTxtEnemy=this._count/BATTLEWINDOW_FADEIN_TIME;this._drawText("Miyamoto Musashi has run into "+this._encounter.name,25,b,this._fadeTxtEnemy);var d=0;this._drawText("His skills are:",55,b,this._fadeTxtEnemy);for(var a in this._encounter.skill){this._drawText(a+": "+this._encounter.skill[a],70+d*15,b,this._fadeTxtEnemy);d++}this._drawText("Miyamoto Musashi skills are: ",70+(d+1)*15,b,this._fadeTxtEnemy);var c=2;for(var a in this._skillMiyamoto){if(this._skillMiyamoto[a]){this._drawText(a+": "+this._skillMiyamoto[a],70+(d+c)*15,b,this._fadeTxtEnemy);c++}}if(this._fadeTxtEnemy>=1){this._fadeTxtEnemy=1}if(this._count>=READING_TIME){this._showResult=true}}if(this._showResult){this._fadeTxtResult=(this._count-READING_TIME)/BATTLEWINDOW_FADEIN_TIME;this._drawText(this._encounterResult.text,b.canvas.height*0.9,b,this._fadeTxtResult);if(this._encounterResult.text2){this._drawText(this._encounterResult.text2,b.canvas.height*0.9+15,b,this._fadeTxtResult)}if(this._fadeTxtResult>=1){this._fadeTxtResult=1}if(this._count>=2*READING_TIME){this._fadeOut=true}}};BattleWindow.prototype._calculateSwordsmanPower=function(c){var a=0;for(var b in c){switch(b){case"strength":a+=c[b]*1;break;case"technique":a+=c[b]*1.25;break;case"strategy":a+=c[b]*1.5;break;case"perfection":a+=c[b]*1.75;break;case"focus":a+=c[b]*3;break;default:break}}return a};BattleWindow.prototype._calculateEncounterResult=function(){var i={};var h=this._calculateSwordsmanPower(this._encounter.skill);var e=this._encounter.skill.strength*ENEMY_LIFE_FACTOR;var c=this._calculateSwordsmanPower(this._skillMiyamoto);var b=this._scene.getMiyamoto().getLife();var f=0;var a=0;while(e>0&&b>0){var g=Math.random()*h;var d=Math.random()*c;if(d>=g){e-=(d-g)}else{b-=(g-d);a+=(g-d)}f++}if(e<=0){i.text="Miyamoto defeated "+this._encounter.name+" in "+f+" movements";if(a>0){i.text2="but suffered "+a.toFixed(0)+" damage point(s)"}else{i.text2="in a masterly way"}}else{i.text=this._encounter.name+" has defeated Miyamoto Musashi"}i.damage=a;return i};BattleWindow.prototype.draw=function(a){if(!this._visible){return}this._drawWindowBackground(a);this._drawMessages(a)};BattleWindow.prototype.tick=function(){if(this._visible){this._count++}};function MessageWindow(a){this._scene=a;this._messages=[];this._visible=false;this._count=0;this.show()}MessageWindow.prototype.show=function(a){this._visible=true};MessageWindow.prototype.hide=function(a){this._visible=false};MessageWindow.prototype.getMessagesNumber=function(){return this._messages.length};MessageWindow.prototype.getMessage=function(a){return this._messages[a]};MessageWindow.prototype.add=function(a){if(a!=MSG_HUNGER_DAMAGE&&a!=this._messages[this._messages.length-1]){this._messages.push(a)}};MessageWindow.prototype._drawWindowBackground=function(d){if(this._messages.length>0){var b=(this._count-FADING_TIME>0)?this._count-FADING_TIME:0;b=b*HEIGHT_FONT/(READING_TIME-FADING_TIME);var f=0;if(this._messages.length==1){f=(this._count-FADING_TIME)/(READING_TIME-FADING_TIME)*0.3;f=(f>0)?f:0}d.strokeStyle="rgba(26, 26, 26, "+(0.3-f)+")";d.fillStyle="rgba(26, 26, 26, "+(0.3-f)+")";var c=Math.min(5,this._messages.length-1);if(c==5){b=0}var e=(c+1)*HEIGHT_FONT+15-b;var a=d.canvas.width/10;var g=d.canvas.height/2-e/2;d.fillRect(a,g,a*8,e)}};MessageWindow.prototype._drawMessages=function(k){k.fillStyle="red";k.font="bold 12px 'Lucida Console', Monaco, monospace";var b=Math.min(5,this._messages.length-1);var c=b*HEIGHT_FONT;var j=this._messages[0];var i=(this._count-FADING_TIME>0)?this._count-FADING_TIME:0;i=i*HEIGHT_FONT/(READING_TIME-FADING_TIME);var a=1-(1*i/(READING_TIME-FADING_TIME));if(j){var e=k.measureText(j).width;var g=k.canvas.width/2-e/2;k.fillStyle="rgba(255, 255, 255, "+a+")";var f=k.canvas.height/2-c/2-i;k.fillText(j,g,f)}k.fillStyle="white";for(var d=1;d<=b;d++){j=this._messages[d];e=k.measureText(j).width;g=k.canvas.width/2-e/2;f=k.canvas.height/2-c/2+(HEIGHT_FONT*d)-i/2;k.fillText(j,g,f)}if(this._messages.length>6){g=9*k.canvas.width/10-20;f=1.82*c;k.fillText("+"+(this._messages.length-6),g,f)}};MessageWindow.prototype.draw=function(a){if(!this._visible){return}this._drawWindowBackground(a);this._drawMessages(a)};MessageWindow.prototype.tick=function(){if(this._visible&&this._messages.length>0){this._count++;if(this._count>=READING_TIME){this._count=0;this._messages.splice(0,1)}}};function WinScene(a){this._game=a;document.getElementById("divUI").style.display="none"}WinScene.prototype.keyPressed=function(a){if(a==KEY_ENTER){this._game.setScene(new StartupScene(this._game))}};WinScene.prototype.mouseClick=function(){this._game.setScene(new StartupScene(this._game))};WinScene.prototype._clearCanvas=function(a){a.fillStyle="rgb(255, 255, 255)";a.fillRect(0,0,a.canvas.width,a.canvas.height)};WinScene.prototype._drawText=function(b){b.fillStyle="rgb(26, 26, 26)";b.font="bold 14px Verdana, Geneva, sans-serif";var d="YOU WIN.";var c=b.measureText(d).width;var a=b.canvas.width/2-c/2;var e=b.canvas.height/2;b.fillText(d,a,e)};WinScene.prototype.draw=function(a){this._clearCanvas(a);this._drawText(a)};WinScene.prototype.tick=function(){};function PlayScene(a){this._game=a;this._paused=false;this._time=new Time(this,{hours:6,minutes:15});this._distance=new Distance();this._messageWindow=new MessageWindow(this);this._miyamoto=new Miyamoto(this);this._ui=new UI(this);this._spiritUI=new SpiritUI(this);this._encounters=new EncounterList(this);this._battleWindow=new BattleWindow(this);this._deathWindow=new DeathWindow(this)}PlayScene.prototype._checkEncounters=function(){this._encounters.checkEncounters()};PlayScene.prototype._checkGameOver=function(){if(this._distance.getDistanceLeft()<=0){this._game.setScene(new WinScene(this._game))}if(this._time.getDaysLeft()<=0||this._miyamoto.getLife()<=0){this.pause();this.hideUI();this.showDeathWindow()}};PlayScene.prototype.getMiyamoto=function(){return this._miyamoto};PlayScene.prototype.getDistance=function(){return this._distance};PlayScene.prototype.getMessageWindow=function(){return this._messageWindow};PlayScene.prototype.showDeathWindow=function(){this._deathWindow.show(this)};PlayScene.prototype.getUI=function(){return this._ui};PlayScene.prototype.keyPressed=function(a){if(this._deathWindow.isVisible()&&a==KEY_ENTER){this._game.setScene(new StartupScene(this._game))}};PlayScene.prototype.mouseClick=function(){if(this._deathWindow.isVisible()){this._game.setScene(new StartupScene(this._game))}};PlayScene.prototype.showSpiritualImprovementSelection=function(){this._spiritUI.show()};PlayScene.prototype.launchBattleWindow=function(a){this.pause();this._ui.hide();this._battleWindow.launchEncounter(a)};PlayScene.prototype.showUI=function(){this._ui.show()};PlayScene.prototype.hideUI=function(){this._ui.hide()};PlayScene.prototype.pause=function(){this._paused=true};PlayScene.prototype.play=function(){this._paused=false};PlayScene.prototype.draw=function(a){this._miyamoto.draw(a);this._time.draw(a);this._distance.draw(a);this._messageWindow.draw(a);this._battleWindow.draw(a);this._deathWindow.draw(a)};PlayScene.prototype.tick=function(){if(!this._paused){this._time.tick();this._ui.tick();this._miyamoto.tick();this._messageWindow.tick();this._checkEncounters();this._checkGameOver()}else{this._battleWindow.tick();this._deathWindow.tick()}};function StartupScene(a){this._game=a;this._count=0;document.getElementById("divUI").style.display="none"}StartupScene.prototype.keyPressed=function(a){if(a==KEY_ENTER){this._game.setScene(new PlayScene(this._game))}};StartupScene.prototype.mouseClick=function(){this._game.setScene(new PlayScene(this._game))};StartupScene.prototype._clearCanvas=function(a){a.fillStyle="rgb(255, 255, 255)";a.fillRect(0,0,a.canvas.width,a.canvas.height)};StartupScene.prototype._drawText=function(b){b.fillStyle="rgba(26, 26, 26, "+Math.abs(Math.cos(this._count/Math.PI/4))+")";b.font="bold 14px Verdana, Geneva, sans-serif";var d="PRESS ENTER KEY OR TAP HERE";var c=b.measureText(d).width;var a=b.canvas.width/2-c/2;var e=b.canvas.height*0.75;b.fillText(d,a,e);b.fillStyle="rgb(26, 26, 26)";b.font="bold 24px Verdana, Geneva, sans-serif";d="GODAI";c=b.measureText(d).width;var a=b.canvas.width/2-c/2;var e=b.canvas.height*0.4;b.fillText(d,a,e);b.font="bold 21px Verdana, Geneva, sans-serif";d="The five great";c=b.measureText(d).width;var a=b.canvas.width/2-c/2;var e=b.canvas.height*0.5;b.fillText(d,a,e)};StartupScene.prototype.draw=function(a){this._clearCanvas(a);this._drawText(a)};StartupScene.prototype.tick=function(){this._count++};function Game(a){this._ctx=a;this._scene=new StartupScene(this)}Game.prototype.setScene=function(a){this._scene=a};Game.prototype.getScene=function(){return this._scene};Game.prototype.keyPressed=function(a){this._scene.keyPressed(a)};Game.prototype.mouseClick=function(){this._scene.mouseClick()};Game.prototype.tick=function(){this._scene.tick()};Game.prototype.draw=function(a){this._scene.draw(a)};function GameRunner(){this._ctx=this._createCanvasContext();this._game=new Game(this._ctx);this._keyboard=new Keyboard(this._game);this._mouse=new Mouse(this._game)}GameRunner.prototype._createCanvasContext=function(){var a="canvas";var b=document.createElement("canvas");b.setAttribute("id","canvas");b.setAttribute("width",CANVAS_WIDTH);b.setAttribute("height",CANVAS_HEIGHT);document.getElementById("canvasHolder").appendChild(b);b=document.getElementById("canvas");return b.getContext("2d")};GameRunner.prototype._clearCanvas=function(){this._ctx.fillStyle="rgb(255, 255, 255)";this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)};GameRunner.prototype._gameLoop=function(){this._keyboard.handleKeypresses();this._mouse.handleMouseclicks();this._game.tick();this._clearCanvas();this._game.draw(this._ctx)};GameRunner.prototype.run=function(){var b=this;(function a(){b._gameLoop();requestAnimFrame(a,b)})()};