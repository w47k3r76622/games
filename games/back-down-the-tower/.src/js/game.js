function resetHero(e,t){e.clearPieces(),t.sprite.x=500,t.sprite.y=500,t.sprite.color="green",t.sprite.width=20,t.sprite.height=20,t.health=10,t.sprite.swordHealth=0,t.sprite.hasSword=!1,t.sprite.direction="up",t.invulnerable=!1,t.invulnerableCounter=0,t.renderMe=!0,t.setSpeed(5),t.addToPieces(e)}function moveSword(e){let{hero:t,sword:o}=e.pieces;null==o&&t.sprite.attack?((o=new Sword("sword","item",t.sprite.x+t.sprite.width,t.sprite.y)).updatePosition(t.sprite),o.addToPieces(pieces)):o&&o.renderMe&&o.renderTime>0?(o.updatePosition(t.sprite),o.updateHealth(t.sprite.swordHealth)):o&&o.renderMe&&o.renderTime<=0&&o.kill()}let pieces=new Allpieces,hero=new Hero("hero",Sprite({}));resetHero(pieces,hero),on("melee",moveSword);let runGameLoopUpdate=function(e,t){startLevels(e,t);let o=t.getPiece("hero"),r=t.getByType("wall"),a=t.getByType("item"),s=t.getByType("enemy"),i=t.getByType("move"),p=t.getByType("stairs"),l={},d={},n=a.sword;for(let e in i){let t=i[e],r=!1;anyDirTrue(o.contactedOnWith(t))&&o.getMoveAbilityStatus()&&!o.invulnerable&&(r=!0),r?(d[e]=t,t.enableMovement()):(l[e]=t,t.disableMovement())}Object.values(s).forEach(e=>{e.updateStopMove(e.touchedOn(a),!0),e.updateStopMove(e.touchedOn(r),!0),e.updateStopMove(e.touchedOn(i),!0),e.updateStopMove(e.touchedOn(s),!0),e.updateStopMove(e.touchedOn(p),!0)}),Object.values(a).forEach(t=>{o.sprite.collidesWith(t.sprite)&&("sword"==t.sprite.itemType&&(o.sprite.hasSword=!0,o.sprite.swordHealth=10,e.swordHealth=o.sprite.swordHealth),o.itemCount+=1,t.kill(),"heart"==t.itemType&&(o.health+=1))});for(let t in s){let r=s[t];o.sprite.collidesWith(r.sprite)&&!o.invulnerable&&(o.health-=1,o.invulnerable=!0),n&&n.sprite.collidesWith(r.sprite)&&(r.kill(),e.enemiesKilled+=1,o.sprite.swordHealth-=1)}o.blinkEffect(5),o.setStopMove(o.touchedOn({...r,...l,...p}));for(let e in d){let t=d[e];t.setStopMove(t.touchedOn({...r,...l,...p,...s})),t.updateStopMove(o.getStopMove(),!0),o.updateStopMove(t.getStopMove(),!0);for(let e in d){let r=d[e];r.updateStopMove(t.getStopMove(),!0),r.updateStopMove(r.touchedOn(s),!0),o.updateStopMove(r.getStopMove(),!0)}o.updateStopMove(t.getStopMove(),!0)}n&&(n.renderTime>=0?n.renderTime=n.renderTime-1/60:(n.kill(),o.sprite.attack=!1,e.swordHealth=o.sprite.swordHealth,n.renderTime=.5)),(anyDirTrue(o.touchedOn(p))||Object.values(p).some(e=>o.sprite.collidesWith(e.sprite)))&&(e.floor-=1,e.floorStarted=!1,t.clearPieces(),e.floor<=0&&(e.state="end",e.win=!0)),o.health<=0&&(e.state="end"),t.updateAll(),t.purgePieces(),keyPressed("esc")&&(e.resetGame(),e.state="menu",resetHero(t,o))},loop=GameLoop({update:function(){switch(gameState.state){case"menu":case"backstory":break;case"game":runGameLoopUpdate(gameState,pieces);break;case"end":break;default:showMenu()}},render:function(){switch(gameState.state){case"menu":showMenu();break;case"backstory":backStory();break;case"game":pieces.renderAll(),makeStats(hero),gameState.updateTimer();break;case"end":endGame();break;default:showMenu(gameState)}}});loop.start();