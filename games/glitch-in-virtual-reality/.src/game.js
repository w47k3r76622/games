function generateMap(a){map=[];for(var b=0;b<a;b++){map[b]=[];for(var c=0;c<a;c++)map[b][c]=-1}var d=GetRandom(5,10),e=GetRandom(5,10);createRoom(Math.round(a/2-d/2),Math.round(a/2-e/2),d,e);for(var f=25,g=0;g<f;g++)for(var h=!1;!h;){var c=GetRandom(1,a-1),b=GetRandom(1,a-1);if(c>0&&c<map[b].length-1&&b<map.length-1&&b>0&&1==map[b][c]){var d=GetRandom(10,20),e=GetRandom(10,20);map[b-1][c]==-1&&1==map[b][c+1]&&1==map[b][c-1]&&1!=map[b+1][c]&&(roomIntersects(c-d/2,b-e+1,d,e)||(createRoom(c-d/2,b-e+1,d,e),map[b][c]=2,h=!0)),map[b+1][c]==-1&&1==map[b][c+1]&&1==map[b][c-1]&&1!=map[b-1][c]&&(roomIntersects(c-d/2,b,d,e)||(createRoom(c-d/2,b,d,e),map[b][c]=2,h=!0)),map[b][c-1]==-1&&1==map[b+1][c]&&1==map[b-1][c]&&1!=map[b][c-1]&&(roomIntersects(c-d+1,b-e/2,d,e)||(createRoom(c-d+1,b-e/2,d,e),map[b][c]=2,h=!0)),map[b][c+1]==-1&&1==map[b+1][c]&&1==map[b-1][c]&&1!=map[b][c+1]&&(roomIntersects(c,b-e/2,d,e)||(createRoom(c,b-e/2,d,e),map[b][c]=2,h=!0))}}}function createRoom(a,b,c,d){for(var e=a;e<a+c;e++)for(var f=b;f<b+d;f++)f==b||e==a||f==b+d-1||e==a+c-1?map[f][e]=1:map[f][e]=0}function roomIntersects(a,b,c,d){if(a+c>map[0].length-1||b+d>map.length-1)return!0;if(b<1||a<1)return!0;for(var e=0;e<d;e++)for(var f=0;f<c;f++){if(void 0==map[e+b])return!0;if(void 0==map[e+b][f+a])return!0;if(0==map[e+b][f+a])return!0}return!1}function Player(){this.x=1,this.y=1,this.hp=50,this.armor=0,this.damage=2,this.sightRange=3,this.inventory=[],this.hitRate=.7,this.equippedWeapon="",this.equippedArmor="",this.useItem=function(a){a<this.inventory.length&&this.inventory[a].use(this)&&this.inventory.splice(a,1)},this.tossItem=function(a){a<this.inventory.length&&this.inventory.splice(a,1)},this.equipItem=function(a){if(a<this.inventory.length){var b=this.inventory[a];"SWORD"==b.type?(""!=this.equippedWeapon&&(this.equippedWeapon.equipped=!1,this.damage-=this.equippedWeapon.buff),this.equippedWeapon=b,this.equippedWeapon.equipped=!0,this.damage+=this.equippedWeapon.buff):"ARMOR"==b.type?(""!=this.equippedArmor&&(this.equippedArmor.equipped=!1,this.armor-=this.equippedArmor.buff),this.equippedArmor=b,this.equippedArmor.equipped=!0,this.armor+=this.equippedArmor.buff):addMessage("PLAYER","You can't equip that.")}},this.takeDamage=function(a,b){var c=a;b||(c=a-this.armor),c<0&&(c=0),this.hp-=c,addMessage("PLAYER","Took "+c+" damage.")},this.updateUI=function(){var a=document.getElementById("hp");a.innerHTML=this.hp;var b=document.getElementById("damage");b.innerHTML=this.damage;var c=document.getElementById("armor");c.innerHTML=this.armor;var d=document.getElementById("sightrange");d.innerHTML=this.sightRange;var e=document.getElementById("hitrate");e.innerHTML=this.hitRate,e.innerHTML.length>5&&(e.innerHTML=e.innerHTML.substring(0,4))},this.move=function(a,b,c){if(c)return this.x+=a,void(this.y+=b);var d=this.x+a,e=this.y+b;void 0!=map[e]&&void 0!=map[e][d]&&(0!=map[e][d]&&2!=map[e][d]||(theGame.checkForEnemyAt(d,e,!0,this.damage)||(this.x=d,this.y=e,2==map[e][d]&&(map[e][d]=0,addMessage("PLAYER","You opened the door with a creak."))),theGame.checkTraps(),theGame.checkForItems())),theGame.updateEnemies()}}function Enemy(a,b,c){this.x=a,this.y=b,this.hp=10,this.damage=1,this.hitRate=.5,this.dead=!1,this.type=c||"RAT",this.sightRange=5,this.chasing=!1,this.xOffset=14,this.yOffset=6,this.numTurns=1,this.coolsDown=!1,this.coolingDown=!1,this.ghost=!1,this.big=!1,this.attackText="has attacked the player!",this.spotsPlayerText="has spotted the player!",this.lostPlayerText="has lost the trail of the player.."}function createRandomEnemy(a,b){var c=new Enemy(a,b),d=7;Math.abs(a-theGame.stairsX)<20&&Math.abs(b-theGame.stairsY)<20&&(d=enemyTypes.length);var e=enemyTypes[GetRandom(0,d)];switch(e){case"RAT":c.type="RAT",c.hp=4,c.damage=1,c.sightRange=5,c.hitRate=.8,c.xOffset=14,c.yOffset=6,c.numTurns=1,c.coolsDown=!0;break;case"ZOMBIE":c.type="ZOMBIE",c.hp=4,c.damage=2,c.sightRange=4,c.hitRate=.7,c.xOffset=1,c.yOffset=6,c.numTurns=1,c.spotsPlayerText="has started shambling towards the player.",c.coolsDown=!0;break;case"SKELETON":c.type="SKELETON",c.hp=4,c.damage=2,c.sightRange=5,c.hitRate=.7,c.xOffset=9,c.yOffset=6,c.numTurns=1,c.spotsPlayerText="has started shambling towards the player.",c.coolsDown=!1;break;case"OOZE":c.type="OOZE",c.hp=4,c.damage=4,c.sightRange=5,c.hitRate=.5,c.xOffset=6,c.yOffset=6,c.numTurns=1,c.coolsDown=!0;break;case"BIGOOZE":c.type="BIGOOZE",c.hp=20,c.big=!0,c.damage=4,c.sightRange=3,c.hitRate=.5,c.xOffset=0,c.yOffset=5,c.numTurns=1,c.coolsDown=!0;break;case"BEHOLDER":c.type="BEHOLDER",c.hp=25,c.big=!0,c.damage=5,c.sightRange=7,c.hitRate=.8,c.xOffset=2,c.yOffset=5,c.numTurns=1,c.coolsDown=!0,c.spotsPlayerText="I see you...",c.lostPlayerText="Where did he go?",c.attackText="Has stared you down.";break;case"DEATH":c.type="DEATH",c.hp=10,c.big=!0,c.damage=6,c.sightRange=5,c.hitRate=.4,c.xOffset=4,c.yOffset=3.5,c.numTurns=2,c.coolsDown=!1,c.ghost=!0,c.spotsPlayerText="You're time has come.",c.lostPlayerText="Player has skirted death.",c.attackText="Has shortened your life..";break;case"BASILISK":c.type="BASILISK",c.hp=10,c.big=!0,c.damage=6,c.sightRange=6,c.hitRate=.7,c.xOffset=2,c.yOffset=3.5,c.numTurns=1,c.coolsDown=!1,c.spotsPlayerText="Has caught your scent.",c.attackText="Has bit you.";break;case"DRAGON":c.type="DRAGON",c.hp=15,c.big=!0,c.damage=10,c.sightRange=6,c.hitRate=.7,c.xOffset=6,c.yOffset=3.5,c.numTurns=1,c.coolsDown=!0,c.spotsPlayerText="Is hunting you down.",c.attackText="Has scorched you with fire.";break;case"GIANTSKELETON":c.type="GIANTSKELETON",c.hp=8,c.big=!0,c.damage=6,c.sightRange=6,c.hitRate=.6,c.xOffset=1,c.yOffset=4,c.numTurns=1,c.coolsDown=!0;break;case"BAT":c.type="BAT",c.hp=2,c.damage=1,c.sightRange=6,c.hitRate=.5,c.xOffset=3,c.yOffset=6,c.numTurns=2;break;case"DRAGONLING":c.type="DRAGONLING",c.hp=4,c.damage=2,c.sightRange=5,c.hitRate=.7,c.xOffset=0,c.yOffset=7,c.numTurns=2;break;case"GHOST":c.type="GHOST",c.hp=2,c.damage=2,c.sightRange=5,c.hitRate=.5,c.xOffset=2,c.yOffset=7,c.spotsPlayerText="You are being haunted",c.lostPlayerText="The haunting has ceased.",c.attackText="has frightened the player!",c.numTurns=1,c.ghost=!0,c.coolsDown=!0;break;case"WRAITH":c.type="WRAITH",c.hp=6,c.damage=2,c.sightRange=6,c.hitRate=.3,c.xOffset=10,c.yOffset=6,c.spotsPlayerText="You feel intense dread.",c.lostPlayerText="The haunting has ceased.",c.attackText="is sucking the player's soul!",c.numTurns=2,c.ghost=!0}return c}function Trap(a,b,c){this.x=a,this.y=b,this.type=c||"Pit",this.damage=5,this.setOff=!1,this.spotted=!1,this.spotText="You see a trap nearby!",this.triggerText="You have set off the trap!"}function Item(a,b,c){this.x=a,this.y=b,this.type=c||"FOOD",this.equipped=!1,this.useText="Food has been collected!",this.buff=GetRandom(1,4),this.use=function(a){return"FOOD"==this.type?(addMessage("PLAYER","Consumed food."),that.player.hp+=Math.floor(10*Math.random()),!0):"POTION"==this.type?(this.generateRandomPotionEffect(a),!0):void addMessage("PLAYER","You can't use that.  Try equipping it.")},this.generateRandomPotionEffect=function(a){var b=["hp","sightRange","hitRate","damage","armor"],c=b[Math.floor(Math.random()*b.length)],d=Math.random(),e=Math.round(Math.random()),f=a[c]*d;"hitRate"!=c&&(f=Math.ceil(f)),e?(a[c]-=f,addMessage("ITEM","The potion made you fill ill. "+c+" went down.")):(a[c]+=f,addMessage("ITEM","The potion made you fill impowered. "+c+" went up."))}}function Game(){that=this,this.state="menu",this.traps=[],this.enemies=[],this.items=[],this.player=new Player,this.inventoryUp=!1,this.inventoryCursor=0,this.stairsX=0,this.stairsY=0,this.gameCanvas=document.getElementById("game"),this.gameCtx=this.gameCanvas.getContext("2d"),this.gameCtx.imageSmoothingEnabled=!1,this.gameCanvas.width=640,this.gameCanvas.height=480,this.handleKeyPressed=function(a){if("play"==that.state)if(0==that.inventoryUp){switch(String.fromCharCode(a.keyCode)){case"W":that.player.move(0,-1);break;case"A":that.player.move(-1,0);break;case"S":that.player.move(0,1);break;case"D":that.player.move(1,0);break;case"M":that.map=!that.map}13==a.keyCode&&(1==that.inventoryUp?that.inventoryUp=!1:that.inventoryUp=!0)}else{switch(String.fromCharCode(a.keyCode)){case"E":that.player.equipItem(that.inventoryCursor);break;case"T":that.player.tossItem(that.inventoryCursor);break;case"U":that.player.useItem(that.inventoryCursor);break;case"W":that.inventoryCursor>0&&(that.inventoryCursor-=1);break;case"S":that.inventoryCursor<that.player.inventory.length-1&&(that.inventoryCursor+=1)}13==a.keyCode&&(1==that.inventoryUp?that.inventoryUp=!1:that.inventoryUp=!0)}"play"!=that.state&&13==a.keyCode&&that.start()},this.start=function(){this.state="play",clearMessages(),addMessage("GM","I am zzzzhe game master."),addMessage("SYSTEM","*malfunction on level 5*"),addMessage("GM","Welcome to the Dungeons of Ma'kidar."),addMessage("SYSTEM","*ERROR 503 can not disengage virtual reality helmet*"),addMessage("UNKNOWN","You must defeat me to live."),this.player=new Player,this.inventoryUp=!1,this.inventoryCursor=0,this.map=!1,this.items=[],this.enemies=[],this.traps=[],generateMap(100);for(var a=0;a<map.length;a++){for(var b=!1,c=0;c<map[a].length;c++)if(0==map[a][c]){this.player.x=c,this.player.y=a,b=!0;break}if(b)break}for(var a=map.length-1;a>0;a--){for(var b=!1,c=map[a].length-1;c>0;c--)if(0==map[a][c]){this.stairsX=c,this.stairsY=a,b=!0;break}if(b)break}this.populateTraps(100),this.populateEnemies(100),this.populateItems(15)},this.update=function(){this.player.updateUI(),screenOffset.x=-this.player.x*tileSize+this.gameCanvas.width/2,screenOffset.y=-this.player.y*tileSize+this.gameCanvas.height/2,this.player.x==this.stairsX&&this.player.y==this.stairsY&&(this.state="win"),this.player.hp<1&&(this.state="lose")},this.draw=function(){if(this.gameCanvas.width=this.gameCanvas.width,this.gameCtx.imageSmoothingEnabled=!1,this.gameCtx.fillStyle="black",this.gameCtx.fillRect(0,0,this.gameCanvas.width,this.gameCanvas.height),"menu"==this.state&&(this.gameCtx.fillStyle="white",this.gameCtx.font="20px Courier New",this.gameCtx.fillText("Hit Enter To Start",240,240)),"win"==this.state&&(this.gameCtx.fillStyle="white",this.gameCtx.font="20px Courier New",this.gameCtx.fillText("You have escaped!",240,200),this.gameCtx.fillText("Hit Enter To Start",240,240)),"lose"==this.state&&(this.gameCtx.fillStyle="white",this.gameCtx.font="20px Courier New",this.gameCtx.fillText("You have perished!",240,200),this.gameCtx.fillText("Hit Enter To Start",240,240)),"play"==this.state){for(var a=0;a<map.length;a++)for(var b=0;b<map[a].length;b++){var c=map[a][b];1==c&&this.drawSprite(tilesImage,2,0,spriteTileSize,tileSize,b,a),2==c&&this.drawSprite(tilesImage,11,1,spriteTileSize,tileSize,b,a)}for(var d=0;d<this.traps.length;d++){var e=this.traps[d];e.spotted&&!e.setOff&&(this.gameCtx.strokeStyle="grey",this.gameCtx.setLineDash([6]),this.gameCtx.strokeRect(e.x*tileSize+screenOffset.x,e.y*tileSize+screenOffset.y,tileSize,tileSize)),e.setOff&&this.drawSprite(tilesImage,6,0,spriteTileSize,tileSize,e.x,e.y)}for(var d=0;d<this.items.length;d++){var f=this.items[d],g=0,h=0;switch(f.type){case"POTION":g=5,h=3;break;case"FOOD":g=1,h=3;break;case"SWORD":g=1,h=4;break;case"ARMOR":g=14,h=4}this.drawSprite(tilesImage,g,h,spriteTileSize,tileSize,f.x,f.y)}for(var d=0;d<this.enemies.length;d++){var i=this.enemies[d],g=0,h=0;0==i.big?0==i.dead?this.drawSprite(tilesImage,i.xOffset,i.yOffset,spriteTileSize,tileSize,i.x,i.y):this.drawSprite(tilesImage,10,1,spriteTileSize,tileSize,i.x,i.y):0==i.dead?this.drawSprite(tilesImage,i.xOffset,i.yOffset,2*spriteTileSize,tileSize,i.x,i.y,2):this.drawSprite(tilesImage,10,1,spriteTileSize,tileSize,i.x,i.y,2)}if(this.drawSprite(tilesImage,5,5,spriteTileSize,tileSize,this.player.x,this.player.y),this.drawSprite(tilesImage,5,0,spriteTileSize,tileSize,this.stairsX,this.stairsY),this.map){this.gameCtx.fillStyle="white",this.gameCtx.fillRect(4*this.player.x,4*this.player.y,4,4),this.gameCtx.fillRect(4*this.stairsX,4*this.stairsY,4,4);for(var a=0;a<map.length;a++)for(var b=0;b<map[a].length;b++){var c=map[a][b];1==c&&(this.gameCtx.fillStyle="red",this.gameCtx.fillRect(4*b,4*a,4,4))}for(var d=0;d<this.enemies.length;d++)this.gameCtx.fillStyle="purple",this.gameCtx.fillRect(4*this.enemies[d].x,4*this.enemies[d].y,4,4)}if(this.inventoryUp){var j=this.gameCanvas.width/4,k=this.gameCanvas.height/4,l=this.gameCanvas.width/2,m=this.gameCanvas.height/1.5;this.gameCtx.fillStyle="white",this.gameCtx.font="30px Courier New",this.gameCtx.fillText("Inventory",j+80,k-20,l,20),this.gameCtx.fillStyle="black",this.gameCtx.fillRect(j,k,l,m),this.gameCtx.beginPath(),this.gameCtx.lineWidth="6",this.gameCtx.strokeStyle="white",this.gameCtx.setLineDash([0]),this.gameCtx.rect(j-3,k-3,l+6,m+6),this.gameCtx.stroke(),this.gameCtx.fillStyle="white",this.gameCtx.fillRect(j,k+this.inventoryCursor*tileSize,tileSize,tileSize);for(var d=0;d<this.player.inventory.length;d++)this.gameCtx.fillStyle="white",1==this.player.inventory[d].equipped&&(this.gameCtx.fillStyle="grey"),this.gameCtx.font="20px Courier New","SWORD"==this.player.inventory[d].type||"ARMOR"==this.player.inventory[d].type?this.gameCtx.fillText("+"+this.player.inventory[d].buff+" "+this.player.inventory[d].type,j+tileSize,k+20+d*tileSize):this.gameCtx.fillText(this.player.inventory[d].type,j+tileSize,k+20+d*tileSize)}}},this.cleanUp=function(){},this.drawSprite=function(a,b,c,d,e,f,g,h){h=h||1,this.gameCtx.drawImage(a,b*d,c*d,d,d,f*e+screenOffset.x,g*e+screenOffset.y,e*h,e*h)},this.populateItems=function(a){for(var b=0;b<a;b++){var c=0,d=0;do c=Math.floor(Math.random()*map[0].length),d=Math.floor(Math.random()*map.length);while(0!=map[d][c]);this.items.push(new Item(c,d,itemTypes[Math.floor(Math.random()*itemTypes.length)]))}},this.populateTraps=function(a){for(var b=0;b<a;b++){var c=0,d=0;do c=Math.floor(Math.random()*map[0].length),d=Math.floor(Math.random()*map.length);while(0!=map[d][c]);this.traps.push(new Trap(c,d))}},this.populateEnemies=function(a){for(var b=0;b<a;b++){var c=0,d=0;do c=Math.floor(Math.random()*map[0].length),d=Math.floor(Math.random()*map.length);while(0!=map[d][c]||Math.abs(c-this.player.x)<10&&Math.abs(d-this.player.y)<10);this.enemies.push(new createRandomEnemy(c,d))}},this.updateEnemies=function(){for(var a=0;a<this.enemies.length;a++){var b=this.enemies[a];if(0==b.dead){var c=0;if(1==b.coolingDown){b.coolingDown=!1;continue}for(;c<b.numTurns;){var d=b.x,e=b.y;if(Math.abs(b.x-this.player.x)<b.sightRange&&Math.abs(b.y-this.player.y)<b.sightRange?(0==b.chasing&&(b.chasing=!0,addMessage(b.type,b.spotsPlayerText)),b.x<this.player.x?d+=1:b.x>this.player.x&&(d-=1),b.y>this.player.y?e-=1:b.y<this.player.y&&(e+=1)):(1==b.chasing&&(b.chasing=!1,addMessage(b.type,b.lostPlayerText)),d+=Math.floor(3*Math.random())-1,e+=Math.floor(3*Math.random())-1),0==b.big){if(void 0!=map[e]&&void 0!=map[e][d]&&(0==map[e][d]||1==b.ghost)){if(this.player.x==d&&this.player.y==e){var f=Math.random();f<b.hitRate?(addMessage(b.type,b.attackText),this.player.takeDamage(b.damage)):addMessage(b.type,"Attack missed the player!")}else this.checkForEnemyAt(d,e,!1)||(b.x=d,b.y=e);1==b.coolsDown&&(b.coolingDown=!0)}}else if(void 0!=map[e]&&void 0!=map[e+1]&&void 0!=map[e][d]&&void 0!=map[e+1][d]&&void 0!=map[e][d+1]&&void 0!=map[e+1][d+1]&&(0==map[e][d]&&0==map[e+1][d]&&0==map[e][d+1]&&0==map[e+1][d+1]||1==b.ghost)){if(this.player.x==d&&this.player.y==e||this.player.x==d+1&&this.player.y==e||this.player.x==d+1&&this.player.y==e+1||this.player.x==d&&this.player.y==e+1){var f=Math.random();f<b.hitRate?(addMessage(b.type,b.attackText),this.player.takeDamage(b.damage)):addMessage(b.type,"Attack missed the player!")}else b.x=d,b.y=e;1==b.coolsDown&&(b.coolingDown=!0)}c++}}}},this.checkForItems=function(){for(var a=0;a<this.items.length;a++){var b=this.items[a];if(b.x==this.player.x&&b.y==this.player.y)return void(this.player.inventory.length<10?(this.player.inventory.push(b),addMessage("PLAYER","Picked up "+b.type),this.items.splice(a,1)):addMessage("PLAYER","You have too much in your inventory to pick this up."))}},this.checkTraps=function(){for(var a=0;a<this.traps.length;a++){var b=this.traps[a];b.setOff||(b.x==this.player.x&&b.y==this.player.y&&(b.setOff=!0,addMessage("TRAP",b.triggerText),this.player.takeDamage(b.damage,!0)),b.spotted||Math.abs(b.x-this.player.x)<this.player.sightRange&&Math.abs(b.y-this.player.y)<this.player.sightRange&&(b.spotted=!0,addMessage("TRAP",b.spotText)))}},this.checkForEnemyAt=function(a,b,c,d){for(var e=0;e<this.enemies.length;e++){var f=this.enemies[e];if((0==f.big&&f.x==a&&f.y==b||1==f.big&&(a==f.x&&b==f.y||a==f.x+1&&b==f.y||a==f.x+1&&b==f.y+1||a==f.x&&b==f.y+1))&&0==f.dead){if(c){var g=Math.random();g<this.player.hitRate?(addMessage("PLAYER","You have attacked the enemy."),f.hp-=d,f.hp<=0&&(f.dead=!0,addMessage("PLAYER",f.type+" has been slain!"))):addMessage("PLAYER","Attack misssed the enemy!")}return!0}}return!1}}function addMessage(a,b){var c=document.getElementById("messageLog"),d=c.innerHTML,e="<b>"+a+"</b>: "+b+"</br>";d+=e,c.innerHTML=d,c.scrollTop=c.scrollHeight}function clearMessages(){var a=document.getElementById("messageLog");a.innerHTML="<b>Message Log</b></br>"}function GetRandom(a,b){return~~(Math.random()*(b-a))+a}var tilesImage=new Image;tilesImage.src="img/minirogue-all.png";var spriteTileSize=8,tileSize=32,map=[],screenOffset={x:0,y:0};generateMap(100);var itemTypes=["FOOD","POTION","SWORD","ARMOR"],enemyTypes=["RAT","BAT","GHOST","WRAITH","ZOMBIE","DRAGONLING","OOZE","BIGOOZE","BEHOLDER","DEATH","BASILISK","GIANTSKELETON","DRAGON"],trapTypes=["PIT","SPIKES","FIRE RUNES","POISON VENTS"],trapText=["You fell down a pit.","You were impaled by spikes.","You set off fire runes.","Poison blasts you in the face."];theGame=new Game;var mainloop=function(){theGame.update(),theGame.draw()},animFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null,recursiveAnim=function(){mainloop(),animFrame(recursiveAnim)};document.addEventListener("keydown",theGame.handleKeyPressed,!1),animFrame(recursiveAnim);
