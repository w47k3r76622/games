var Container=function(){var e=function(){};return e.prototype.init=function(e,t,i,o){this.game=e,this.width=t?t:this.width,this.height=i?i:this.height,this.map=this.makeMap(t,i),this.fallSpeed=this.OriginalSpeed=o?o:this.fallSpeed,this.noOfDropTetris=0,this.drawContainer(),this.nextTetris=new Tetris(this,3,3,Math.random()),this.dropTetris(new Tetris(this,3,3,Math.random()))},e.prototype.restart=function(){var e=this.makeMap(this.width,this.height);this.map.forEach(function(t,i){t.forEach(function(t,o){e[i][o].view=t.view,e[i][o].view.classList.forEach(function(t){"container__block"!=t&&e[i][o].view.classList.remove(t)})})}),this.map=e,this.noOfDropTetris=0,this.refreshView(!1),this.clean(),this.nextTetris=new Tetris(this,3,3,Math.random()),this.dropTetris(new Tetris(this,3,3,Math.random()))},e.prototype.bind=function(e){this.nextBlocksView=e},e.prototype.update=function(){if(this.clean(),this.game.combo.decreaseEnergy(.001),this.curTetris.update(this.fallSpeed)){if(!this.fillTetris(this.curTetris))return;this.dropTetris(new Tetris(this,3,3,Math.random())),this.removeCompletedRows(),this.game.combo.increaseEnergy(.2)&&this.collapse()}this.curTetris.draw(this)},e.prototype.clean=function(){this.map.forEach(function(e){e.forEach(function(e){var t=e.color;e.view.classList.remove("container__block--tetris--"+t)})})},e.prototype.makeMap=function(e,t){for(var i=[],o=0;t>o;){var r=0;for(i[o]=[];e>r;)i[o][r]={color:null,view:null,occupy:0},++r;++o}return i},e.prototype.reverse=function(){var e=this.curTetris,t=!1;this.map.forEach(function(i,o){var r=i.reduce(function(e,t,i,o){return e+t.occupy},0);if(r>0&&!t){var n=0==e.occupy[2].length?2:3;if(e.position.y+n>=o)return void(t=!0);i.map(function(e){return e.occupy=1-e.occupy,e})}}),this.refreshView(!1)},e.prototype.dropTetris=function(e){this.curTetris=this.nextTetris,this.nextTetris=e;var t=this;t.release(),[].forEach.call(t.nextBlocksView,function(e){e.classList.remove("sidebar__element__next__block--fill")}),e.occupy.forEach(function(e,i){e.forEach(function(e){var o=e+3*i;t.nextBlocksView[o].classList.add("sidebar__element__next__block--fill")})}),++t.noOfDropTetris,t.fallSpeed=30-Math.sqrt(t.noOfDropTetris),t.OriginalSpeed=t.fallSpeed},e.prototype.fillTetris=function(e){var t=e.getArea(),i=this,o=!0;return t.forEach(function(e){0===e.y&&(i.hitCeil(),o=!1),i.map[e.y][e.x].occupy=1,i.map[e.y][e.x].view.classList.add("container__block--occupy")}),i.game.combo.increaseScore(2*Math.floor(30-i.OriginalSpeed)),i.refreshView(!0),o},e.prototype.hitCeil=function(){this.game.lose()},e.prototype.removeCompletedRows=function(){var e=this;this.map.forEach(function(t,i){var o=t.reduce(function(e,t,i,o){return e+t.occupy},0);o===e.width&&(t.map(function(e){return e.occupy=0,e}),e.downOneRow(i),e.game.combo.increaseEnergy(2),e.game.combo.increaseScore(10))}),this.refreshView(!0)},e.prototype.downOneRow=function(e){var t=this.map,i=e-1;for(i;i>0;--i)t[i].forEach(function(e,o){t[i+1][o].occupy=e.occupy})},e.prototype.collapse=function(){function e(){if(a.occupy=0,i.refreshView(!1),s<=i.height&&0===p.occupy)h.occupy=0,h=p,p=s<i.height?i.map[s][c]:null,++s;else{if(++r,r===t.length)return i.refreshView(!1),i.removeCompletedRows(),void o.start();n=t[r],c=n.x,s=n.y,a=n.tetris,h=a,p=i.map[s][c]}h.occupy=1,window.requestAnimationFrame(e)}var t,i=this,o=this.game;o.stop(),t=this.map.reduce(function(e,t,i){return t.reduce(function(e,t,o){return 1===t.occupy&&e.push({x:o,y:i,tetris:t}),e},e),e},[]),t=t.reverse();var r=0,n=t[r],c=n.x,s=n.y,a=n.tetris,h=a,p=i.map[s][c];window.requestAnimationFrame(e),this.game.combo.clear()},e.prototype.refreshView=function(e){this.map.forEach(function(t){t.forEach(function(t){0===t.occupy&&t.view.classList.contains("container__block--occupy")?e?(t.view.addEventListener("animationend",function(e){t.view.classList.remove("container__block--occupy"),t.view.classList.remove("container__block--occupying")},!1),t.view.classList.add("container__block--occupying")):t.view.classList.remove("container__block--occupy"):0==t.occupy||t.view.classList.contains("container__block--occupy")||t.view.classList.add("container__block--occupy")})})},e.prototype.rush=function(){this.OriginalSpeed||(this.OriginalSpeed=this.fallSpeed),this.fallSpeed=this.fallSpeed/5},e.prototype.release=function(){this.fallSpeed=this.OriginalSpeed},e.prototype.drawContainer=function(){function e(e){var t=document.createElement("div");return e.forEach(function(e){t.classList.add(e)}),t}var t=this.game.view,i=e(["container"]);this.map.forEach(function(t){var o=e(["container__row","clearfix"]);t.forEach(function(t){var i=e(["container__block"]);o.appendChild(i),t.view=i}),i.appendChild(o)}),t.appendChild(i)},e}();