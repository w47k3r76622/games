(()=>{var i=class a{constructor(e=0,t=0){this.x=e;this.y=t}moveTowards(e,t){let l=e.x-this.x,h=e.y-this.y,m=l*l+h*h;if(m==0||t>=0&&m<=t*t)return;let d=Math.sqrt(m);this.x+=l/d*t,this.y+=h/d*t}distanceFrom(e){let t=e.x-this.x,l=e.y-this.y,h=t*t+l*l;return Math.sqrt(h)}copy(){return new a(this.x,this.y)}};var s=class{constructor(e=0,t=0,l=new i){this.width=e;this.height=t;this.pos=l}intersects(e){return this.pos.x<=e.pos.x+e.width&&this.pos.x+this.width>=e.pos.x&&this.pos.y<=e.pos.y+e.height&&this.pos.y+this.height>=e.pos.y}contains(e){return!1}containsPoint(e){return this.pos.x<=e.x&&e.x<=this.pos.x+this.width&&this.pos.y<=e.y&&e.y<=this.pos.y+this.height}};var n=800,y=600,ke=!1,ie=[];var me="spring",W=()=>me,se=a=>{let{stage:e}=window;me=a,e.className="",e.classList.add(me)},Te=()=>{switch(W()){case"spring":se("summer");break;case"summer":se("fall");break;case"fall":se("winter");break;case"winter":se("spring");break}};var{stage:be,bg:Pe,mg:ve,fg:Ae,offscreen:Re}=window,Ie=()=>{be.classList.add(W()),be.style.width=n+"px",be.style.height=y+"px";for(let a of[Pe,ve,Ae,Re])a.width=n,a.height=y},ne=a=>a.getContext("2d"),C={mg:ne(ve),fg:ne(Ae),bg:ne(Pe),offscreen:ne(Re)};var le=class{constructor(e){this.playingField=e}pos=new i;update(e){}},ae=class extends le{constructor(t){super(t);this.playingField=t;this.pos.x=t.pos.x-30,this.pos.y=t.pos.y}draw(t){let{playingField:l,pos:{x:h,y:m}}=this,d=l.width+60;t.save(),t.lineWidth=2,t.translate(h,m);let k=60,b=15;t.fillStyle="#4c6389",t.fillRect(0,-b,k,b),t.strokeRect(0,-b,k,b),t.fillRect(l.width,-b,k,b),t.strokeRect(l.width,-b,k,b);let E=120,f=20;t.fillStyle="#62758e",t.fillRect(d/2-E/2,-f,E,f),t.strokeRect(d/2-E/2,-f,E,f);let v=40;t.fillStyle="#838cad",t.fillRect(0,0,d,v),t.strokeRect(0,0,d,v);let A=10;t.fillStyle="#b5bcd6",t.fillRect(0,0,d,A),t.strokeRect(0,0,d,A),t.restore()}},oe=class extends le{constructor(t){super(t);this.playingField=t;this.pos.x=t.pos.x-30,this.pos.y=t.height+15}draw(t){let{playingField:l,pos:{x:h,y:m}}=this,d=l.width+60;t.save(),t.lineWidth=2,t.translate(h,m);let k=30;t.fillStyle="#c9833e",t.fillRect(0,0,d,k),t.strokeRect(0,0,d,k);let b=15;t.fillStyle="#8b4736",t.fillRect(0,-b,d,b),t.strokeRect(0,-b,d,b);let E=60,f=30;t.fillStyle="#933655",t.fillRect(0,-f/1.3,E,f),t.strokeRect(0,-f/1.3,E,f),t.fillRect(d-E,-f/1.3,E,f),t.strokeRect(d-E,-f/1.3,E,f);let v=-f/1.3+f,A=10,M=2;t.fillStyle="#c13d38",t.beginPath(),t.moveTo(d,v-M),t.lineTo(d-E/2,-f+A),t.lineTo(d-E,v-M),t.closePath(),t.fill(),t.beginPath(),t.moveTo(0,v-M),t.lineTo(E/2,-f+A),t.lineTo(E,v-M),t.closePath(),t.fill(),t.beginPath();let I=120,B=50;t.fillStyle="#933655",t.fillRect(d/2-I/2,-B/1.5,I,B),t.strokeRect(d/2-I/2,-B/1.5,I,B);let T=15;t.fillStyle="#c13d38",t.moveTo(d/2-I/2,T),t.lineTo(d/2-I/4,-T),t.lineTo(d/2+I/4,-T),t.lineTo(d/2+I/2,T),t.closePath(),t.fill(),t.restore()}};var he=[],Le=({x:a,y:e})=>({x:a,y:e,vx:0,vy:0,alpha:1,count:8,radius:1,embers:[],ended:!1,emberRadius:5}),Ne=a=>{let e=[],t=a.count,l=a.radius;for(let h=0;h<t;++h){let m={x:a.x,y:a.y,alpha:1,vx:l*Math.cos(Math.PI*2*h/t),vy:l*Math.sin(Math.PI*2*h/t),radius:a.emberRadius};e.push(m)}return e},Ce=(a,e)=>{e.embers.length||(e.embers=Ne(e)),e.embers.map(t=>{t.x+=t.vx,t.y+=t.vy,a.save(),a.translate(t.x,t.y),a.lineWidth=4,a.strokeStyle=`hsla(16, 88%, 54%,${e.alpha})`,a.fillStyle=`hsla(16, 88%, 54%,${e.alpha})`,a.beginPath(),a.arc(0,0,t.radius,0,Math.PI*2),a.fill(),a.stroke(),a.restore()}),e.alpha&&(e.alpha-=.03,e.alpha<0&&(e.ended=!0))};var De=(a,e=100,t=100,l=1)=>`hsla(${a}, ${e}%, ${t}%, ${l})`;var N=(a,e)=>(a=Math.ceil(a),e=Math.floor(e),Math.floor(Math.random()*(e-a)+a)),fe=(a,e)=>(a=Math.ceil(a),e=Math.floor(e),Math.random()*(e-a)+a);var Ue=(a,e)=>Math.random()>.5?a:e;var re=class{constructor(e,t,l){this.pos=e;this.vel=t;this.opacity=l;this.centerX=this.pos.x}angle=0;centerX;range=.5;fadeIn=!0;opacityIncrement=.001;color={summer:[65,59,60],winter:[194,63,56],spring:[311,36,85],fall:[30,53,67]};update(e){this.pos.x=this.centerX+Math.sin(this.angle)*this.range,this.pos.y-=this.vel.y,this.angle+=this.vel.x,this.fadeIn?this.opacity+=this.opacityIncrement:this.opacity-=this.opacityIncrement,this.opacity>1&&(this.fadeIn=!1),(this.pos.y<0||this.opacity<0)&&(this.pos.x=N(0,n),this.pos.y=N(0,y),this.fadeIn=!0,this.opacity=0)}draw(e){e.save(),e.translate(this.pos.x,this.pos.y);let[t,l,h]=this.color[W()];e.fillStyle=De(t,l,h,this.opacity),e.fillRect(0,0,3,3),e.restore()}};var pe=class extends s{color={spring:"#cad648",summer:"#cad648",winter:"#48b5d6",fall:"#d6c148"};draw(e){e.save(),e.strokeStyle=this.color[W()],e.lineWidth=2,e.strokeRect(this.pos.x,this.pos.y,this.width,this.height),e.setLineDash([3,3]),e.beginPath(),e.moveTo(this.pos.x+this.width/4,y/2),e.lineTo(this.pos.x+this.width-this.width/4,y/2),e.closePath(),e.stroke(),e.beginPath(),e.moveTo(this.pos.x+this.width/2,y/2-20),e.lineTo(this.pos.x+this.width/2,y/2+20),e.closePath(),e.stroke(),e.beginPath(),e.moveTo(this.pos.x-20,y/2),e.lineTo(this.pos.x+20,y/2),e.closePath(),e.stroke(),e.beginPath(),e.moveTo(this.pos.x+this.width-20,y/2),e.lineTo(this.pos.x+this.width+20,y/2),e.closePath(),e.stroke(),e.restore()}};var R=class{constructor(e){this.milliseconds=e}elapsed=0;current=0;previous=0;hasPassed(){return this.current=Date.now(),this.previous&&(this.elapsed+=this.current-this.previous),this.previous=this.current,this.elapsed>=this.milliseconds?(this.elapsed=0,!0):!1}};var de=class{constructor(e,t,l){this.parentId=e;this.angle=t;this.position.x=this.origin.x=l.x,this.position.y=this.origin.y=l.y}origin=new i(0,0);position=new i(0,0);velocity=new i(8,8);width=10;height=2;finished=!1;update(){this.position.x+=Math.cos(this.angle)*this.velocity.x,this.position.y+=Math.sin(this.angle)*this.velocity.y}draw(e){e.save(),e.translate(this.position.x,this.position.y),e.rotate(this.angle),e.fillRect(0,0,this.width,this.height),e.restore()}};var Ve=(...a)=>Me(Be(...a)),Me=(...a)=>{let e=Ee.createBufferSource(),t=Ee.createBuffer(a.length,a[0].length,D);return a.map((l,h)=>t.getChannelData(h).set(l)),e.buffer=t,e.connect(Ee.destination),e.start(),e},Be=(a=1,e=.05,t=220,l=0,h=0,m=.1,d=0,k=1,b=0,E=0,f=0,v=0,A=0,M=0,I=0,B=0,T=0,_=1,O=0,J=0)=>{let L=2*Math.PI,K=b*=500*L/D**2,Z=(0<I?1:-1)*L/4,j=t*=(1+2*e*Math.random()-e)*L/D,$=[],H=0,Q=0,S=0,V=1,ge=0,Fe=0,z=0,x,X;for(l=99+D*l,O*=D,h*=D,m*=D,T*=D,E*=500*L/D**3,I*=L/D,f*=L/D,v*=D,A=D*A|0,X=l+O+h+m+T|0;S<X;$[S++]=z)++Fe%(100*B|0)||(z=d?1<d?2<d?3<d?Math.sin((H%L)**3):Math.max(Math.min(Math.tan(H),1),-1):1-(2*H/L%2+2)%2:1-4*Math.abs(Math.round(H/L)-H/L):Math.sin(H),z=(A?1-J+J*Math.sin(2*Math.PI*S/A):1)*(0<z?1:-1)*Math.abs(z)**k*a*We*(S<l?S/l:S<l+O?1-(S-l)/O*(1-_):S<l+O+h?_:S<X-T?(X-S-T)/m*_:0),z=T?z/2+(T>S?0:(S<X-T?1:(X-S)/T)*$[S-T|0]/2):z),x=(t+=b+=E)*Math.sin(Q*I-Z),H+=x-x*M*(1-1e9*(Math.sin(S)+1)%2),Q+=x-x*M*(1-1e9*(Math.sin(S)**2+1)%2),V&&++V>v&&(t+=f,j+=f,V=0),!A||++ge%A||(t=j,b=K,V=V||1);return $},We=.3,D=44100,Ee=new(window.AudioContext||webkitAudioContext);var _e=(a,e,t,l=125)=>{let h,m,d,k,b,E,f,v,A,M,I,B,T,_,O,J=0,L=[],K=[],Z=[],j=0,$=0,H=1,Q={},S=44100/l*60>>2;for(;H;j++)L=[H=v=I=T=0],t.map((V,ge)=>{for(f=e[V][j]||[0,0,0],H|=!!e[V][j],O=T+(e[V][0].length-2-!v)*S,_=ge==t.length-1,m=2,k=T;m<f.length+_;v=++m){for(b=f[m],A=m==f.length+_-1&&_||M!=(f[0]||0)|b|0,d=0;d<S&&v;d++>S-99&&A?B+=(B<1)/99:0)E=(1-B)*L[J++]/2||0,K[k]=(K[k]||0)-E*$+E,Z[k]=(Z[k++]||0)+E*$+E;b&&(B=b%1,$=f[1]||0,(b|=0)&&(L=Q[[M=f[J=0]||0,b]]=Q[[M,b]]||(h=[...a[M]],h[2]*=2**((b-12)/12),b>0?Be(...h):[])))}T=O});return[K,Z]},P=class a{static hit=[,,328,.02,.01,0,1,.69,-5.9,,,,,,,,.11];static shoot=[.2,,298,,,.07,2,.18,-2.9,-.1,,,.04,,,,.22,.69,.09,.05];static death=[,,466,.03,.01,.06,,1.17,-8.8,2.7,,,,.2,,,,.57,.06];static arrowHit=[.2,,670,.01,,.02,3,.73,-2.1,,506,.04,,.8,-57,,,,.02];static music=_e([[,0,77,,,.7,2,.41,,,,,,,,.06],[,0,43,.01,,.3,2,,,,,,,,,.02,.01],[,0,170,.003,,.008,,.97,-35,53,,,,,,.1],[.8,0,270,,,.12,3,1.65,-2,,,,,4.5,,.02],[,0,86,,,,,.7,,,,.5,,6.7,1,.05],[,0,41,,.05,.4,2,0,,,9,.01,,,,.08,.02],[,0,2200,,,.04,3,2,,,800,.02,,4.8,,.01,.1],[.3,0,16,,,.3,3]],[[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33],[3,1,22,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,24,,,,,,,,,,,,,,,,,,,,,,,,22,,22,,22,,,,],[5,-1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[,1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33],[3,1,24,,,,,,,,27,,,,,,,,,,,,,,,,27,,,,24,,,,24,,,,,,,,27,,,,,,,,,,,,,,,,24,,24,,24,,,,],[5,-1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[,1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[6,1,,,34,34,34,,,,,,34,34,,,,,34,,,,34,34,,,,,34,,,,34,,,,34,34,34,,,,,,34,,,,,,34,34,,,34,34,,,,,,,,,34,34],[4,1,,,,,,,24,,,,,,24,,24,,,,24,,,,24,,,,,,,,,,,,,,,,24,,,,,,24,,24,,,,24,,,,24,,,,,,,,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,23,23,35,23,23,36,23,23,35,23,23,36,23,23,35,35,23,23,35,23,23,35,23,23,36,23,23,35,23,23,36,36],[5,-1,21,,,19,,,21,,,,,,,,,,21,,,19,,,17,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[3,1,24,,,24,,,24,,,,,,,,,,24,,,24,,,24,,,,24.75,24.5,24.26,24.01,24.01,24.01,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25],[4,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,24.75,24.5,24.26,24.01,24.01,24.01,24.01,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,23,,21,23,,35,,23,,21,23,,35,,35,,23,,21,23,,35,,21,23,,35,,21,23,,,],[6,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34,36,34,,33,34,34,36,31,36,34,,31,34,32,,33,36,34,,31,34,34,36,33,36,33,,31,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29],[4,1,24,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,21,,19,21,,33,,21,,19,21,,33,,33,,21,,19,21,,33,,21,,19,21,,33,,33,,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29],[2,1,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,,,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,,,],[6,1,,,36,,,,,,36,,36,,,,,,,,36,,,,,,36,,36,,,,,,,,36,,,,,,,,,,,,,,,,36,,,,,,36,,36,,,,,,],[3,1,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25,,,,,25,,,,,25,,,25,,,,,,,,25,,,,,,,,25,25,25,25]],[[1,-1,14,14,26,14,14,26,14,14,26,14,14,26,14,14,26,26,14,14,26,14,14,26,14,14,26,14,14,26,14,14,26,26,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29,19,19,31,19,19,31,19,19,31,19,19,31,19,19,31,31],[4,1,24,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,36,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,19,,19,19,31,19,19,31,19,,19,19,31,19,19,31],[2,1,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,,,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,,,],[3,1,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25],[6,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34,,,,,,34,,34,,,,,,,,34,,,,,,34,,34,,,,,,]]],[0,1,1,2,3,4,4]);static playSound(e){Ve(...e)}static _music;static playMusic(){a._music=Me(...a.music)}static stopMusic(){a._music&&(a._music.stop(),delete a._music)}};var G=class{constructor(e,t=0){this.bounds=e;this.rank=t;this.startPos=e.pos.copy()}id=Math.random().toString();name="Soldier";cost=1;upgradeCost=2;healCost=1;goldValue=1;type=3;damaged=0;maxDamageFrames=30;meleeAttack=0;meleeAttackFrames=30;speed=.25;attack=1;maxHealth;health;attackRange=50;attackRate=new R(1e3);attackAngle=0;experience=0;experienceForEliteStatus=6;experienceForUpgradedStatus=3;startPos;target;get width(){return this.bounds.width}get height(){return this.bounds.height}get pos(){return this.bounds.pos}alive=!0;canUpgrade(){return this.rank===0?this.experience>=this.experienceForUpgradedStatus:this.rank===1?this.experience>=this.experienceForEliteStatus:!1}upgrade(){this.rank===1&&(this.rank=2),this.rank===0&&(this.rank=1)}hasDamage(){return this.health<this.maxHealth}update(e,t){t.length!==0&&(this.target||(this.target=this.selectTarget(t)),this.target&&this.pos.distanceFrom(this.target.pos)>this.attackRange&&this.pos.moveTowards(this.target.pos,this.speed),this.attackRate.hasPassed()&&this.pos.distanceFrom(this.target.pos)<=this.attackRange&&this.performAttack(),this.target.health<=0&&delete this.target,this.damaged&&this.damaged--,this.meleeAttack&&this.meleeAttack--,this.alive&&this.health<=0&&(P.playSound(P.death),he.push(Le(this.pos))),this.alive=this.health>0)}performAttack(){this.target&&(this.attackAngle=Math.atan2(this.target.pos.y-this.pos.y,this.target.pos.x-this.pos.x),this.type===0?(ie.push(new de(this.id,this.attackAngle,this.pos)),P.playSound(P.shoot)):(this.meleeAttack=this.meleeAttackFrames,this.target.health-=this.attack,this.target.health<=0&&(this.experience+=1),this.target.damaged=this.target.maxDamageFrames,P.playSound(P.hit)))}animateMeleeAttack(e){if(this.meleeAttack&&this.target){e.save(),e.fillStyle="white";let l=(this.meleeAttackFrames-this.meleeAttack*2)*(.0174533*2);e.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?e.rotate(this.attackAngle-l):e.rotate(this.attackAngle+l),e.lineWidth=2,e.fillStyle="gray",e.fillRect(0,0,this.attackRange-this.width,this.width/3),e.strokeRect(0,0,this.attackRange-this.width,this.width/3),e.restore()}}draw(e){if(this.damaged>0&&(e.save(),e.beginPath(),e.arc(this.pos.x,this.pos.y,this.width,0,2*Math.PI),e.fillStyle="rgba(255, 0, 0, .4)",e.closePath(),e.fill(),e.restore()),ke){this.target&&(e.save(),e.beginPath(),e.moveTo(this.pos.x,this.pos.y),e.lineTo(this.target.pos.x,this.target.pos.y),e.closePath(),e.stroke(),e.restore());let t=this.getHitBox();e.strokeRect(t.pos.x,t.pos.y,t.width,t.height)}}drawHealthBar(e){let t=this.getHitBox();e.save();let l=t.height/6;e.fillStyle="red",e.fillRect(t.pos.x,t.pos.y-l*2,t.width,l),e.fillStyle="green";let h=t.width/this.maxHealth,m=this.health*h;e.fillRect(t.pos.x,t.pos.y-l*2,m,l),e.lineWidth=2,e.strokeRect(t.pos.x,t.pos.y-l*2,t.width,l),e.restore()}isStrongAgainst(e){switch(this.type){case 2:return e.type===1;case 1:return e.type===0;case 0:return e.type===2}return!1}selectTarget(e){let t=this.sortSoldiersByDistance(e),l=t.filter(h=>this.isStrongAgainst(h));return l.length?l[0]:t[0]}sortSoldiersByDistance(e){return e.sort((t,l)=>t.pos.distanceFrom(this.pos)<l.pos.distanceFrom(this.pos)?0:1)}getHitBox(){return new s(this.width*2,this.height*2,new i(this.pos.x-this.width,this.pos.y-this.height))}collides(e){return e.some(t=>t.getHitBox().intersects(this.getHitBox()))}};var F={0:{main:"#305182",accent:"#4192c3",skin:"#ffdba2"},1:{main:"#378230",accent:"#5bc341",skin:"#ffdba2"},2:{main:"#823030",accent:"#c34141",skin:"#ffdba2"}},o=class extends G{name="Swordsman";type=2;cost=2;upgradeCost=2;healCost=1;goldValue=2;attack=1;speed=.5;maxHealth=4;health=this.maxHealth;attackRange=50;attackRate=new R(1e3);draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),this.animateMeleeAttack(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.arc(0,0,this.width,Math.PI,0),e.closePath(),e.fillStyle=F[this.rank].main,e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width,-this.height/4),e.lineTo(-this.width,0),e.lineTo(this.width,0),e.lineTo(this.width,-this.height/4),e.lineTo(0,-this.height/1.5),e.closePath(),e.fillStyle=F[this.rank].accent,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=F[this.rank].skin,e.fill(),e.stroke(),e.restore(),super.draw(e)}upgrade(){super.upgrade(),this.rank===1&&(this.health+=2,this.speed+=.1),this.rank===2&&(this.attack+=1)}},w=class extends G{name="Crossbowman";type=0;cost=8;upgradeCost=3;healCost=3;goldValue=4;attack=1;speed=.25;maxHealth=3;health=this.maxHealth;attackRange=250;attackRate=new R(1200);draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.arc(0,0,this.width,Math.PI,0),e.closePath(),e.fillStyle=F[this.rank].accent,e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width,-this.height/2.5),e.lineTo(-this.width*1.25,0),e.lineTo(this.width*1.25,0),e.lineTo(this.width,-this.height/2.5),e.closePath(),e.fillStyle=F[this.rank].main,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=F[this.rank].skin,e.fill(),e.stroke(),e.restore(),super.draw(e)}upgrade(){super.upgrade(),this.rank===1&&(this.health+=1,this.attack+=1),this.rank===2&&(this.attackRate=new R(1e3))}},g=class extends G{name="Knight";type=2;cost=6;upgradeCost=3;healCost=3;goldValue=3;attack=2;speed=.33;maxHealth=8;health=this.maxHealth;attackRange=50;attackRate=new R(1e3);animateMeleeAttack(e){if(this.meleeAttack&&this.target){e.save(),e.fillStyle="white";let l=(this.meleeAttackFrames-this.meleeAttack*2)*(.0174533*2);e.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?e.rotate(this.attackAngle-l):e.rotate(this.attackAngle+l),e.lineWidth=2,e.fillStyle="black",e.moveTo(0,0),e.lineTo(this.attackRange-this.width,0),e.stroke(),e.fillStyle="gray",e.beginPath(),e.arc(this.attackRange-this.width,0,this.width/3,0,2*Math.PI),e.closePath(),e.fill(),e.stroke(),e.restore()}}draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),this.animateMeleeAttack(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.arc(0,-this.height,this.width/4,Math.PI,0),e.closePath(),e.fillStyle=F[this.rank].main,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,Math.PI,0),e.closePath(),e.fillStyle=F[this.rank].accent,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=F[this.rank].skin,e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width,-this.height/4),e.lineTo(-this.width,0),e.lineTo(0,this.height/2),e.lineTo(this.width,0),e.lineTo(this.width,-this.height/4),e.lineTo(0,-this.height/1.5),e.closePath(),e.fillStyle=F[this.rank].main,e.fill(),e.stroke(),e.restore(),super.draw(e)}upgrade(){super.upgrade(),this.rank===1&&(this.speed+=.1),this.rank===2&&(this.attackRate=new R(800))}},ue=class extends G{name="Pope";type=2;attack=4;speed=.25;maxHealth=100;health=this.maxHealth;attackRange=100;attackRate=new R(1e3);animateMeleeAttack(e){if(this.meleeAttack&&this.target){e.save(),e.fillStyle="white";let l=(this.meleeAttackFrames-this.meleeAttack*2)*(.0174533*2);e.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?e.rotate(this.attackAngle-l):e.rotate(this.attackAngle+l),e.lineWidth=2,e.fillStyle="black",e.moveTo(0,0),e.lineTo(this.attackRange-this.width,0),e.stroke(),e.fillStyle="gold",e.beginPath(),e.arc(this.attackRange-this.width,0,this.width/3,0,2*Math.PI),e.closePath(),e.fill(),e.stroke(),e.restore()}}draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),this.animateMeleeAttack(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=F[this.rank].skin,e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width*1.2,-this.height*.9),e.lineTo(-this.width,0),e.lineTo(this.width,0),e.lineTo(this.width*1.2,-this.height*.9),e.lineTo(0,-this.height*1.5),e.closePath(),e.fillStyle="white",e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width*1.1,-this.height*.5),e.lineTo(-this.width,0),e.lineTo(0,this.height/2),e.lineTo(this.width,0),e.lineTo(this.width*1.1,-this.height*.5),e.lineTo(0,-this.height),e.closePath(),e.fillStyle="gray",e.fill(),e.stroke(),e.beginPath(),e.arc(0,-this.height*.9,this.width/4,2*Math.PI,0),e.closePath(),e.fillStyle="gold",e.fill(),e.stroke(),e.restore(),super.draw(e)}};var U={0:{main:"#794100",accent:"#c37100",skin:"#ffdba2"},1:{main:"#004391",accent:"#264044",skin:"#ffdba2"},2:{main:"#000000",accent:"#880000",skin:"#ffdba2"}},Y=class extends G{name="Foot Soldier";type=2;cost=1;upgradeCost=2;healCost=1;attack=1;speed=.4;maxHealth=4;health=this.maxHealth;attackRange=50;attackRate=new R(1e3);goldValue=1;animateMeleeAttack(e){if(this.meleeAttack&&this.target){e.save(),e.fillStyle="white";let l=(this.meleeAttackFrames-this.meleeAttack*2)*(.0174533*2);e.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?e.rotate(this.attackAngle-l):e.rotate(this.attackAngle+l),e.lineWidth=2,e.fillStyle="black",e.moveTo(0,0),e.lineTo(this.attackRange-this.width,0),e.stroke(),e.fillStyle="gray",e.beginPath(),e.arc(this.attackRange-this.width,0,this.width/3,0,2*Math.PI),e.closePath(),e.fill(),e.stroke(),e.restore()}}draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),this.animateMeleeAttack(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.arc(0,-this.height,this.width/5,0,2*Math.PI),e.closePath(),e.fillStyle=U[this.rank].accent,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,Math.PI,0),e.closePath(),e.fillStyle=U[this.rank].accent,e.fill(),e.stroke(),e.fillStyle=U[this.rank].main,e.fillRect(-this.width,-this.height/2,this.width*2,this.height/2),e.strokeRect(-this.width,-this.height/2,this.width*2,this.height/2),e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=U[this.rank].skin,e.fill(),e.stroke(),e.restore(),super.draw(e)}upgrade(){super.upgrade(),this.rank===1&&(this.speed+=.25,this.health+=1),this.rank===2&&(this.attack+=.2)}},ee=class extends G{name="Horse Archer";type=0;cost=8;upgradeCost=4;healCost=2;goldValue=2;attack=1;speed=.8;maxHealth=4;health=this.maxHealth;attackRange=180;attackRate=new R(1e3);draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.ellipse(0,-this.height,this.width/3,this.height/4,0,0,2*Math.PI),e.closePath(),e.fillStyle=U[this.rank].accent,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,Math.PI,0),e.closePath(),e.fillStyle=U[this.rank].main,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=U[this.rank].skin,e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width,-this.height/2),e.lineTo(-this.width,0),e.lineTo(0,this.height/3),e.lineTo(this.width,0),e.lineTo(this.width,-this.height/2),e.lineTo(0,-this.height/4),e.closePath(),e.fillStyle=U[this.rank].accent,e.fill(),e.stroke(),e.restore(),super.draw(e)}upgrade(){super.upgrade(),this.rank===1&&(this.speed+=.1,this.attackRange+=20),this.rank===2&&(this.attack+=1)}},ce=class extends G{name="Mounted Knight";type=1;cost=4;upgradeCost=3;healCost=3;goldValue=3;attack=2;speed=.7;maxHealth=7;health=this.maxHealth;attackRange=60;attackRate=new R(1e3);draw(e){let{x:t,y:l}=this.pos;this.drawHealthBar(e),this.animateMeleeAttack(e),e.save(),e.translate(t,l),e.lineWidth=2,e.beginPath(),e.ellipse(0,-this.height,this.width/5,this.height/3,0,0,2*Math.PI),e.closePath(),e.fillStyle=U[this.rank].accent,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,this.width,Math.PI,0),e.closePath(),e.fillStyle=U[this.rank].main,e.fill(),e.stroke(),e.beginPath(),e.moveTo(-this.width*1.25,this.height/1.5),e.lineTo(-this.width,-this.height/3),e.lineTo(this.width,-this.height/3),e.lineTo(this.width*1.25,this.height/1.5),e.closePath(),e.fillStyle=U[this.rank].main,e.fill(),e.stroke(),e.fillStyle=U[this.rank].accent,e.fillRect(-this.width,-this.height/2,this.width*2,this.height/2),e.strokeRect(-this.width,-this.height/2,this.width*2,this.height/2),e.beginPath(),e.arc(0,0,this.width,0,Math.PI),e.closePath(),e.fillStyle=U[this.rank].skin,e.fill(),e.stroke(),e.restore(),super.draw(e)}upgrade(){super.upgrade(),this.rank===1&&(this.speed+=.25,this.attack+1),this.rank===2&&(this.health+=3)}};var ze=[[92,475],[176,287],[58,244],[31,354],[159,443],[61,575],[198,14],[134,92],[117,261],[46,16],[217,236],[97,146],[221,511],[142,522],[197,579],[157,188],[0,134],[34,508],[112,348],[121,4],[205,96],[134,587],[218,413],[5,422],[63,92],[223,340],[85,402],[14,289],[221,171],[0,595],[776,159],[584,514],[742,373],[736,562],[809,492],[629,60],[710,250],[624,225],[665,308],[776,311],[633,387],[563,287],[654,148],[602,593],[770,18],[759,434],[712,190],[669,544],[639,483],[560,67],[573,141],[748,500],[806,100],[705,74],[562,379],[571,441],[665,0],[699,421],[594,8],[775,242]],te=class{constructor(e,t,l){this.radius=e;this.color=t;this.pos=l}angle=0;vr;maxRotation;update(e){this.angle+=this.vr,Math.abs(this.angle)>this.maxRotation&&(this.vr=this.vr*-1)}draw(e){e.save(),e.fillStyle=this.color[W()],e.translate(this.pos.x,this.pos.y),e.rotate(this.angle),e.beginPath(),e.lineWidth=2,e.moveTo(-this.radius,0),e.lineTo(0,-this.radius),e.arc(0,0,this.radius,0,Math.PI),e.closePath(),e.fill(),e.stroke(),e.restore()}},ye=class{constructor(e,t){this.size=e;this.pos=t;this.sway=Ue(.05,.2);let l=this.size*.7,h=this.size*.9,m=this.size,d=new i(this.pos.x,this.pos.y-h/2),k=new i(this.pos.x,d.y-l/2);this.topSegment=new te(l,this.topColor,k),this.middleSegment=new te(h,this.middleColor,d),this.bottomSegment=new te(m,this.bottomColor,this.pos);for(let b of[this.topSegment,this.bottomSegment,this.middleSegment])b.maxRotation=this.sway,b.vr=this.sway/50}stumpColor="#673d33";topColor={summer:"#afba38",spring:"#afba38",winter:"#d5eef1",fall:"#c0be3d"};middleColor={summer:"#75a535",spring:"#75a535",winter:"#64b5ce",fall:"#caab20"};bottomColor={summer:"#316a26",spring:"#316a26",winter:"#547fb1",fall:"#8f6e15"};topSegment;middleSegment;bottomSegment;sway;update(e){this.topSegment.update(e),this.middleSegment.update(e),this.bottomSegment.update(e)}draw(e){this.drawStump(e),this.bottomSegment.draw(e),this.middleSegment.draw(e),this.topSegment.draw(e)}drawStump(e){let t=this.size/2,l=this.size*1.1;e.save(),e.translate(this.pos.x,this.pos.y),e.fillStyle=this.stumpColor,e.beginPath(),e.moveTo(0,0),e.lineTo(-t*.6,0),e.lineTo(-t,l),e.lineTo(0,l*1.1),e.lineTo(t,l),e.lineTo(t*.6,0),e.closePath(),e.fill(),e.stroke(),e.restore()}overlaps(e){let{x:t,y:l}=this.pos,h=Math.sqrt(Math.pow(e.pos.x-t,2)+Math.pow(e.pos.y-l,2));return h<=this.bottomSegment.radius+e.bottomSegment.radius&&h>=Math.abs(this.bottomSegment.radius-e.bottomSegment.radius)}},Ge=ze.map(([a,e])=>new ye(30,new i(a,e)));var r=250,u=175,c=100,q=[[new o(new s(15,15,new i(n/2-100,r))),new o(new s(15,15,new i(n/2+100,r))),new o(new s(15,15,new i(n/2,r)))],[new o(new s(15,15,new i(n/2-100,u)),1),new o(new s(15,15,new i(n/2+100,u)),1),new g(new s(15,15,new i(n/2,c)))],[new o(new s(15,15,new i(n/2-100,r))),new o(new s(15,15,new i(n/2+100,r))),new w(new s(15,15,new i(n/2-50,u))),new w(new s(15,15,new i(n/2+50,u))),new g(new s(15,15,new i(n/2,c)),1)],[new o(new s(15,15,new i(n/2-100,r)),2),new o(new s(15,15,new i(n/2+100,r))),new o(new s(15,15,new i(n/2-50,r))),new o(new s(15,15,new i(n/2+50,r)),2),new w(new s(15,15,new i(n/2-50,u))),new w(new s(15,15,new i(n/2+50,u))),new g(new s(15,15,new i(n/2,c)),1)],[new o(new s(15,15,new i(n/2-100,r))),new o(new s(15,15,new i(n/2+100,r))),new o(new s(15,15,new i(n/2-50,r))),new o(new s(15,15,new i(n/2+50,r))),new o(new s(15,15,new i(n/2-100,u)),1),new o(new s(15,15,new i(n/2+100,u)),1),new o(new s(15,15,new i(n/2-50,u)),1),new o(new s(15,15,new i(n/2+50,u)),1),new o(new s(15,15,new i(n/2-100,c)),2),new o(new s(15,15,new i(n/2+100,c)),2),new o(new s(15,15,new i(n/2-50,c)),2),new o(new s(15,15,new i(n/2+50,c)),2)],[new o(new s(15,15,new i(n/2-100,r))),new o(new s(15,15,new i(n/2+100,r))),new o(new s(15,15,new i(n/2-50,r))),new o(new s(15,15,new i(n/2+50,r))),new g(new s(15,15,new i(n/2,r))),new w(new s(15,15,new i(n/2-50,c)),2),new w(new s(15,15,new i(n/2+50,c)),2),new w(new s(15,15,new i(n/2,c)),2)],[new g(new s(15,15,new i(n/2-100,r))),new g(new s(15,15,new i(n/2+100,r))),new o(new s(15,15,new i(n/2-100,u)),1),new o(new s(15,15,new i(n/2+100,u)),1),new o(new s(15,15,new i(n/2-50,u)),1),new o(new s(15,15,new i(n/2+50,u)),1),new o(new s(15,15,new i(n/2,u)),1),new w(new s(15,15,new i(n/2-100,c)),2),new w(new s(15,15,new i(n/2+100,c)),2),new w(new s(15,15,new i(n/2,c)),1)],[new g(new s(15,15,new i(n/2-100,r)),1),new g(new s(15,15,new i(n/2+100,r)),1),new g(new s(15,15,new i(n/2-50,r)),1),new g(new s(15,15,new i(n/2+50,r)),1),new g(new s(15,15,new i(n/2,r)),2),new w(new s(15,15,new i(n/2-100,u)),1),new w(new s(15,15,new i(n/2+100,u)),1),new w(new s(15,15,new i(n/2-50,u)),1),new w(new s(15,15,new i(n/2+50,u)),1),new w(new s(15,15,new i(n/2,u)),1),new o(new s(15,15,new i(n/2-100,c)),2),new o(new s(15,15,new i(n/2+100,c)),2),new o(new s(15,15,new i(n/2-50,c)),2),new o(new s(15,15,new i(n/2+50,c)),2),new o(new s(15,15,new i(n/2,c)),2)],[new w(new s(15,15,new i(n/2-100,r)),1),new o(new s(15,15,new i(n/2+100,r)),2),new o(new s(15,15,new i(n/2-50,r)),2),new o(new s(15,15,new i(n/2+50,r)),2),new o(new s(15,15,new i(n/2,r)),1),new w(new s(15,15,new i(n/2-100,u)),1),new g(new s(15,15,new i(n/2+100,u)),1),new g(new s(15,15,new i(n/2-50,u)),1),new g(new s(15,15,new i(n/2+50,u)),1),new g(new s(15,15,new i(n/2,u)),1),new g(new s(15,15,new i(n/2-100,c)),2),new o(new s(15,15,new i(n/2+100,c)),2),new o(new s(15,15,new i(n/2-50,c)),2),new o(new s(15,15,new i(n/2+50,c)),2),new w(new s(15,15,new i(n/2,c)),2)],[new g(new s(15,15,new i(n/2-100,r)),2),new g(new s(15,15,new i(n/2+100,r)),2),new g(new s(15,15,new i(n/2-50,r)),2),new g(new s(15,15,new i(n/2+50,r)),2),new g(new s(15,15,new i(n/2,r)),2),new w(new s(15,15,new i(n/2-100,u)),1),new w(new s(15,15,new i(n/2+100,u)),1),new w(new s(15,15,new i(n/2-50,u)),1),new w(new s(15,15,new i(n/2+50,u)),1),new w(new s(15,15,new i(n/2,u)),1),new o(new s(15,15,new i(n/2-100,c)),2),new o(new s(15,15,new i(n/2+100,c)),2),new o(new s(15,15,new i(n/2-50,c)),2),new o(new s(15,15,new i(n/2+50,c)),2),new o(new s(15,15,new i(n/2,c)),2)],[new g(new s(15,15,new i(n/2-100,r)),2),new g(new s(15,15,new i(n/2+100,r)),2),new g(new s(15,15,new i(n/2-50,r)),2),new g(new s(15,15,new i(n/2+50,r)),2),new g(new s(15,15,new i(n/2,r)),2),new w(new s(15,15,new i(n/2-100,u)),2),new w(new s(15,15,new i(n/2+100,u)),2),new w(new s(15,15,new i(n/2-50,u)),2),new w(new s(15,15,new i(n/2+50,u)),2),new w(new s(15,15,new i(n/2,u)),2),new o(new s(15,15,new i(n/2-100,c)),2),new o(new s(15,15,new i(n/2+100,c)),2),new o(new s(15,15,new i(n/2-50,c)),2),new o(new s(15,15,new i(n/2+50,c)),2),new o(new s(15,15,new i(n/2,c)),2)],[new g(new s(15,15,new i(n/2-100,r)),2),new g(new s(15,15,new i(n/2+100,r)),2),new g(new s(15,15,new i(n/2-50,r)),2),new g(new s(15,15,new i(n/2+50,r)),2),new g(new s(15,15,new i(n/2,r)),2),new w(new s(15,15,new i(n/2-100,u)),2),new w(new s(15,15,new i(n/2+100,u)),2),new w(new s(15,15,new i(n/2-50,u)),2),new w(new s(15,15,new i(n/2+50,u)),2),new w(new s(15,15,new i(n/2,u)),2),new o(new s(15,15,new i(n/2-100,c)),2),new o(new s(15,15,new i(n/2+100,c)),2),new o(new s(15,15,new i(n/2-50,c)),2),new o(new s(15,15,new i(n/2+50,c)),2),new o(new s(15,15,new i(n/2,c)),2),new ue(new s(30,30,new i(n/2,c)))]];var p=document.querySelector.bind(document),we=class{mouse=new i;_gold=0;get gold(){return this._gold}set gold(e){this._gold=e,p("#gold").innerText=e}_wave=0;get wave(){return this._wave}set wave(e){this._wave=e,p("#wave").innerText=`${e}/${q.length}`}_state=3;get state(){return this._state}set state(e){this._state=e,this.setUILayerVisibility()}_healCost=0;get healCost(){return this._healCost}set healCost(e){this._healCost=e,this.updateHealCostUi()}_upgradeCost=0;get upgradeCost(){return this._upgradeCost}set upgradeCost(e){this._upgradeCost=e,this.updateUpgradeCostUI()}maxSoldiersPerArmy=15;projectiles=ie;explosions=he;soldierSize=15;playerUnits=[new Y(new s),new ce(new s),new ee(new s)];playerArmy=[new Y(new s(this.soldierSize,this.soldierSize,new i(n/2-50,y-200))),new Y(new s(this.soldierSize,this.soldierSize,new i(n/2+50,y-200))),new ee(new s(this.soldierSize,this.soldierSize,new i(n/2,y-150)))];enemyUnits=[new o(new s),new g(new s),new w(new s)];enemyArmy=[];selectedUnit;placementBounds=new s;_livingSoldiers;get livingSoldiers(){return this._livingSoldiers}set livingSoldiers(e){this._livingSoldiers=e,p("#soldiers").innerText=`${e.length}/${this.playerArmy.length}`}_livingEnemies;get livingEnemies(){return this._livingEnemies}set livingEnemies(e){this._livingEnemies=e,p("#enemies").innerText=`${e.length}/${this.enemyArmy.length}`}$recruitButtons=[];calculateLivingSoldiers(){return this.playerArmy.filter(e=>e.alive)}calculateLivingEnemies(){return this.enemyArmy.filter(e=>e.alive)}startBattle(){this.wave>q.length||(P.playMusic(),delete this.selectedUnit,this.state=0,this.enemyArmy=q[this.wave-1],[...this.enemyArmy,...this.playerArmy].forEach(e=>{e.attackRate.elapsed=0,e.damaged=0,e.meleeAttack=0}))}start(){window.onmousemove=e=>{e.target.getAttribute("id")==="fg"&&(this.mouse.x=e.offsetX,this.mouse.y=e.offsetY)},this.createPlayingField(),this.createDecorations(),this.createGlitter(),this.initDom(),this.setUILayerVisibility(),this.updateRecruitButtons(),this.wave=1,this.gold=0,this.updateHealCostUi(),this.updateUpgradeCostUI(),this.livingEnemies=this.enemyArmy,this.livingSoldiers=this.playerArmy,this.placementBounds.pos.x=this.playingField.pos.x,this.placementBounds.pos.y=this.playingField.pos.y+this.playingField.height/2,this.placementBounds.width=this.playingField.width,this.placementBounds.height=this.playingField.height/2,p("#current-soldiers").innerText=this.playerArmy.length}updateHealCostUi(){p("#heal-cost").innerText=this.healCost>0?"$"+this.healCost:"",this.healCost===0||this.healCost>this.gold?p("#heal-cost").parentElement.setAttribute("disabled",""):p("#heal-cost").parentElement.removeAttribute("disabled")}updateUpgradeCostUI(){p("#upgrade-cost").innerText=this.upgradeCost>0?"$"+this.upgradeCost:"",this.upgradeCost===0||this.upgradeCost>this.gold?p("#upgrade-cost").parentElement.setAttribute("disabled",""):p("#upgrade-cost").parentElement.removeAttribute("disabled")}update(e){this.glitter.forEach(t=>t.update(e)),this.decorations.forEach(t=>t.update(e)),this.state===3&&this.selectedUnit&&this.placementBounds.containsPoint(this.mouse)&&(this.selectedUnit.bounds.pos=this.mouse.copy()),this.state===0&&(this.livingEnemies=this.calculateLivingEnemies(),this.livingSoldiers=this.calculateLivingSoldiers(),this.livingEnemies.forEach(l=>l.update(e,this.livingSoldiers)),this.livingSoldiers.forEach(l=>l.update(e,this.livingEnemies)),this.updateProjectiles(),(this.livingEnemies.length<=0||this.livingSoldiers.length<=0)&&this.endBattle())}updateProjectiles(){for(let e of this.projectiles.filter(t=>!t.finished))e.update(),this.livingSoldiers.find(t=>t.id===e.parentId)?e.finished=this.checkProjectileHitsEnemyUnit(e):this.livingEnemies.find(t=>t.id===e.parentId)&&(e.finished=this.checkProjectileHitsPlayerUnit(e)),this.playingField.containsPoint(e.position)||(e.finished=!0)}checkProjectileHitsPlayerUnit(e){let t=this.livingSoldiers.filter(h=>h.id!==e.parentId).find(h=>h.getHitBox().containsPoint(e.position));if(!t)return!1;let l=this.livingEnemies.find(h=>h.id===e.parentId);return l&&(t.damaged=t.maxDamageFrames,t.health-=l.attack,P.playSound(P.arrowHit)),!0}checkProjectileHitsEnemyUnit(e){let t=this.livingEnemies.filter(h=>h.id!==e.parentId).find(h=>h.getHitBox().containsPoint(e.position));if(!t)return!1;let l=this.livingSoldiers.find(h=>h.id===e.parentId);return l&&(t.damaged=t.maxDamageFrames,t.health-=l.attack,P.playSound(P.arrowHit),t.health<=0&&(l.experience+=1)),!0}setUILayerVisibility(){switch(this.state){case 3:p("#ui-left").style.visibility="visible",p("#ui-right").style.visibility="visible",p("#ui-soldier-counts").style.visibility="hidden",p("#ui-battle-breakdown").style.visibility="hidden";break;case 0:p("#ui-left").style.visibility="hidden",p("#ui-right").style.visibility="hidden",p("#ui-soldier-counts").style.visibility="visible",p("#ui-battle-breakdown").style.visibility="hidden";break;case 1:case 2:p("#ui-left").style.visibility="hidden",p("#ui-right").style.visibility="hidden",p("#ui-soldier-counts").style.visibility="hidden",p("#ui-battle-breakdown").style.visibility="visible";break;case 5:p("#ui-game-complete").style.visibility="visible",p("#ui-left").style.visibility="hidden",p("#ui-right").style.visibility="hidden",p("#ui-soldier-counts").style.visibility="hidden",p("#ui-battle-breakdown").style.visibility="hidden"}}endingBattle=!1;endBattle(){this.endingBattle||(this.endingBattle=!0,setTimeout(()=>{P.stopMusic();let e={};e.waveNumber=this.wave,e.unitsLost=this.playerArmy.length-this.livingSoldiers.length,e.goldEarned=this.enemyArmy.reduce((l,h)=>l+h.goldValue,0),e.battleWon=this.livingSoldiers.length>0,this.state=3;let t=this.livingSoldiers.length>0;e.goldEarned=t?e.goldEarned:Math.floor(e.goldEarned/2),t&&this.wave<=q.length?(this.wave+=1,Te()):this.resetSoldierHealth(),this.gold+=e.goldEarned,this.healCost=this.calculateHealCost(),this.upgradeCost=this.calculateUpgradeCost(),C.bg.clearRect(0,0,n,y),this.playingField.draw(C.bg),this.livingSoldiers=this.playerArmy.filter(l=>l.alive),p("#current-soldiers").innerText=this.playerArmy.length,this.projectiles.length=0,this.playerArmy=this.livingSoldiers,this.resetSoldierPositions(),this.setUILayerVisibility(),this.updateRecruitButtons(),this.endingBattle=!1,this.wave>q.length?this.state=5:this.showBattleBreakdown(e)},2500))}showBattleBreakdown(e){let t=e.battleWon;this.state=t?1:2,t?p("#ui-battle-breakdown").classList.remove("loss"):p("#ui-battle-breakdown").classList.add("loss"),p("#status").innerText=t?"Battle Won":"Battle Lost",p("#wave-number").innerText=e.waveNumber,p("#troops-lost").innerText=e.unitsLost,p("#gold-earned").innerText=e.goldEarned,p("#continue").innerText=t?"Continue":"Try Again"}hideBattleBreakdown(){this.state=3}resetSoldierHealth(){this.enemyArmy.forEach(e=>{e.alive=!0,e.health=e.maxHealth}),this.playerArmy.forEach(e=>{e.alive=!0,e.health=e.maxHealth})}resetSoldierPositions(){this.enemyArmy.forEach(e=>e.bounds.pos=e.startPos.copy()),this.playerArmy.forEach(e=>e.bounds.pos=e.startPos.copy())}draw(){C.mg.clearRect(0,0,n,y),C.fg.clearRect(0,0,n,y),this.glitter.forEach(e=>e.draw(C.fg));for(let[e,t]of this.explosions.entries())t.ended?this.explosions.splice(e,1):Ce(C.fg,t);this.decorations.forEach(e=>e.draw(C.mg)),this.state===0&&(this.projectiles.filter(e=>!e.finished).forEach(e=>e.draw(C.mg)),this.livingEnemies.forEach(e=>e.draw(C.mg))),this.livingSoldiers.forEach(e=>{this.state!==0&&(e.damaged=0,e.meleeAttack=0),e.draw(C.mg)}),this.highlightPlacementBounds(),this.highlightSelectedUnit()}highlightPlacementBounds(){if(!this.selectedUnit)return;let e=C.fg;e.save(),this.placementValid()?e.strokeStyle="rgba(0, 255, 0, .4)":e.strokeStyle="rgba(255, 0, 0, .4)",e.lineWidth=4,e.strokeRect(this.placementBounds.pos.x,this.placementBounds.pos.y,this.placementBounds.width,this.placementBounds.height),e.restore()}highlightSelectedUnit(){if(!this.selectedUnit)return;let{selectedUnit:{pos:e,width:t}}=this,l=C.fg;l.save(),l.beginPath(),l.arc(e.x,e.y,t*1.5,0,2*Math.PI),this.placementValid()?l.fillStyle="rgba(0, 255, 0, .4)":l.fillStyle="rgba(255, 0, 0, .4)",l.closePath(),l.fill(),l.restore()}placementValid(){if(this.selectedUnit){let e=this.placementBounds.containsPoint(this.mouse),t=this.selectedUnit.getHitBox(),l=this.livingSoldiers.filter(h=>h.id!==this.selectedUnit?.id).every(h=>!h.getHitBox().intersects(t));return e&&l}return!1}initDom(){p("#heal").addEventListener("click",this.handleHealClick),p("#start").addEventListener("click",this.handleStartClick),p("#upgrade").addEventListener("click",this.handleUpgradeClick),p("#continue").addEventListener("click",this.handleContinueClick),p("#play-again").addEventListener("click",()=>window.location.reload()),p("#stage").addEventListener("pointerup",this.handleDrop),p("#stage").addEventListener("pointerdown",this.handleUnitPlacement),this.createRecruitButtons()}handleContinueClick=()=>{this.state===1&&(this.state=3),this.state===2&&(this.state=3)};createRecruitButtons(){let e=p("#recruit-buttons");for(let t of this.playerUnits){let l=document.createElement("span");l.classList.add("cost"),l.innerText="$"+t.cost;let h=document.createElement("span");h.innerText=t.name;let m=document.createElement("button");m.dataset.unit=t.name,m.dataset.cost=t.cost.toString(),m.addEventListener("click",()=>{this.recruit(t.name)}),m.appendChild(l),m.appendChild(h),e.appendChild(m),this.$recruitButtons.push(m)}}updateRecruitButtons(){for(let e of this.$recruitButtons)Number(e.dataset.cost)>this.gold||this.playerArmy.length>=this.maxSoldiersPerArmy?e.setAttribute("disabled",""):e.removeAttribute("disabled")}handleUpgradeClick=()=>{let e=this.calculateUpgradeCost();this.gold>=e&&(this.livingSoldiers.filter(t=>t.canUpgrade()).forEach(t=>t.upgrade()),this.gold-=e,this.upgradeCost=this.calculateUpgradeCost(),this.updateRecruitButtons())};handleHealClick=()=>{let e=this.calculateHealCost();this.gold>=e&&(this.gold-=e,this.livingSoldiers.forEach(t=>t.health=t.maxHealth),this.healCost=this.calculateHealCost(),this.updateRecruitButtons())};handleStartClick=()=>{this.state!==0&&this.startBattle()};handleUnitPlacement=e=>{if(this.state===0)return;let t=new i(e.offsetX,e.offsetY);this.selectedUnit?this.handleDrop(e):this.selectedUnit=this.livingSoldiers.find(l=>l.getHitBox().containsPoint(t))};handleDrop=e=>{if(!this.selectedUnit)return;let t=this.placementValid()?this.mouse.copy():this.selectedUnit.startPos;this.selectedUnit.bounds.pos=t,this.selectedUnit.startPos=t.copy(),delete this.selectedUnit};calculateHealCost(){return this.livingSoldiers.filter(e=>e.hasDamage()).reduce((e,t)=>t.healCost+e,0)}calculateUpgradeCost(){return this.livingSoldiers.filter(e=>e.canUpgrade()).reduce((e,t)=>t.upgradeCost+e,0)}recruit(e){let t=this.playerUnits.find(l=>l.name===e);if(this.gold>=t.cost&&this.livingSoldiers.length<this.maxSoldiersPerArmy){this.gold-=t.cost;let l=this.playingField.pos.x+30,h=this.playingField.pos.x+this.playingField.width-30,m=this.playingField.pos.y+this.playingField.height-60,d=this.playingField.pos.y+this.playingField.height/2,k=new i(N(l,h),N(m,d)),b=new s(this.soldierSize,this.soldierSize,k),E=new t.constructor(b);for(;E.collides(this.livingSoldiers);)E.bounds.pos=new i(N(l,h),N(m,d));this.playerArmy.push(E),this.updateRecruitButtons(),this.healCost=this.calculateHealCost(),this.upgradeCost=this.calculateUpgradeCost(),p("#current-soldiers").innerText=this.playerArmy.length}}decorations=[];createDecorations(){this.decorations=[...Ge,new ae(this.playingField),new oe(this.playingField)],this.decorations.sort((e,t)=>e.pos.y<t.pos.y?0:1)}playingField;createPlayingField(){let t=n/3.3;this.playingField=new pe(n-t*2,y-25*2,new i(t,25)),this.playingField.draw(C.bg)}glitter=[];createGlitter(){for(let t=0;t<100;t++)this.glitter.push(new re(new i(N(0,n),N(0,y)),new i(fe(.01,.05),.1),fe(.05,.8)))}};Ie();var Se=new we;window.addEventListener("load",()=>{let a=Date.now();Se.start();function e(){requestAnimationFrame(e);let t=Date.now(),l=t-a;a=t,Se.update(l),Se.draw()}e()});})();
//! ZzFXM (v2.0.3) | (C) Keith Clark | MIT | https://github.com/keithclark/ZzFXM
