<!DOCTYPE html>
<html lang="en">
  <head>
    <title>js13k2018</title>

    <meta charset="UTF-8">

    <style>
      body {
        background-color: black;
      }

      canvas {
        position: absolute;
        width: 640px;
        height: 480px;

        border: 5px solid white;
      }
    </style>
  </head>
  <body>
    <canvas id="game" width="640" height="480"></canvas>
    <canvas id="text" width="640" height="480"></canvas>

    <script>
      kontra={init(a){var b=this.canvas=document.getElementById(a)||a||document.querySelector("canvas");this.context=b.getContext("2d")},_noop:new Function,_tick:new Function},kontra.gameLoop=function(b){function f(){if(g=requestAnimationFrame(f),h=performance.now(),j=h-d,d=h,!(1e3<j)){for(kontra._tick(),l+=j;l>=o;)q.update(p),l-=o;c(),q.render()}}let d,g,h,j,k=(b=b||{}).fps||60,l=0,o=1e3/k,p=1/k,c=!1===b.clearCanvas?kontra._noop:function(){kontra.context.clearRect(0,0,kontra.canvas.width,kontra.canvas.height)},q={update:b.update,render:b.render,isStopped:!0,start(){d=performance.now(),this.isStopped=!1,requestAnimationFrame(f)},stop(){this.isStopped=!0,cancelAnimationFrame(g)}};return q},!function(){let a={},b={},d={13:"enter",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"};for(let a=0;26>a;a++)d[65+a]=(10+a).toString(36);for(i=0;10>i;i++)d[48+i]=""+i;addEventListener("keydown",function(e){let f=d[e.which];b[f]=!0,a[f]&&a[f](e)}),addEventListener("keyup",function(a){b[d[a.which]]=!1}),addEventListener("blur",function(){b={}}),kontra.keys={bind(b,c){[].concat(b).map(function(b){a[b]=c})},unbind(b,c){[].concat(b).map(function(b){a[b]=c})},pressed:a=>!!b[a]}}(),!function(){var a=Math.min,b=Math.max;class c{constructor(a,b){this._x=a||0,this._y=b||0}add(a,b){this.x+=(a.x||0)*(b||1),this.y+=(a.y||0)*(b||1)}clamp(a,b,c,d){this._c=!0,this._a=a,this._b=b,this._d=c,this._e=d}get x(){return this._x}get y(){return this._y}set x(c){this._x=this._c?a(b(this._a,c),this._d):c}set y(c){this._y=this._c?a(b(this._b,c),this._e):c}}kontra.vector=(a,b)=>new c(a,b),kontra.vector.prototype=c.prototype;class d{init(a,b,c,d){for(b in a=a||{},this.position=kontra.vector(a.x,a.y),this.velocity=kontra.vector(a.dx,a.dy),this.acceleration=kontra.vector(a.ddx,a.ddy),this.width=this.height=0,this.context=kontra.context,a)this[b]=a[b];if(c=a.image)this.image=c,this.width=c.width,this.height=c.height;else if(c=a.animations){for(b in c)this.animations[b]=c[b].clone(),d=d||c[b];this._ca=d,this.width=d.width,this.height=d.height}return this}get x(){return this.position.x}get y(){return this.position.y}get dx(){return this.velocity.x}get dy(){return this.velocity.y}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set x(a){this.position.x=a}set y(a){this.position.y=a}set dx(a){this.velocity.x=a}set dy(a){this.velocity.y=a}set ddx(a){this.acceleration.x=a}set ddy(a){this.acceleration.y=a}isAlive(){return 0<this.ttl}collidesWith(a){return this.x<a.x+a.width&&this.x+this.width>a.x&&this.y<a.y+a.height&&this.y+this.height>a.y}update(a){this.advance(a)}render(){this.draw()}playAnimation(a){this._ca=this.animations[a],this._ca.loop||this._ca.reset()}advance(a){this.velocity.add(this.acceleration,a),this.position.add(this.velocity,a),this.ttl--,this._ca&&this._ca.update(a)}draw(){this.image?this.context.drawImage(this.image,this.x,this.y):this._ca?this._ca.render(this):(this.context.fillStyle=this.color,this.context.fillRect(this.x,this.y,this.width,this.height))}}kontra.sprite=a=>new d().init(a),kontra.sprite.prototype=d.prototype}(),!function(){function b(a){let b=k.x-j(a.x,h(k.x,a.x+a.width)),c=k.y-j(a.y,h(k.y,a.y+a.height));return b*b+c*c<k.radius*k.radius}function c(){let a,c,d=m.length?m:l;for(let e=d.length-1;0<=e;e--)if(c=(a=d[e]).collidesWithPointer?a.collidesWithPointer(k):b(a))return a}function f(a){e[q[a.button]]=!0,d(a,"onDown")}function g(a){e[q[a.button]]=!1,d(a,"onUp")}function d(b,d){if(!kontra.canvas)return;let e,f,g;-1===b.type.indexOf("mouse")?(e=(b.touches[0]||b.changedTouches[0]).clientX,f=(b.touches[0]||b.changedTouches[0]).clientY):(e=b.clientX,f=b.clientY),k.x=e-kontra.canvas.offsetLeft,k.y=f-kontra.canvas.offsetTop,b.target===kontra.canvas&&(g=c())&&g[d]&&g[d](),p[d]&&p[d](b,g)}var h=Math.min,j=Math.max;let k,l=[],m=[],p={},o=[],e={},q={0:"left",1:"middle",2:"right"};addEventListener("mousedown",f),addEventListener("touchstart",f),addEventListener("mouseup",g),addEventListener("touchend",g),addEventListener("blur",function(){e={}}),addEventListener("mousemove",function(a){d(a,"onOver")}),k=kontra.pointer={x:0,y:0,radius:5,track(a){[].concat(a).map(function(a){a._r||(a._r=a.render,a.render=function(){l.push(this),this._r()},o.push(a))})},untrack(a,b){[].concat(a).map(function(a){a.render=a._r,a._r=b;let c=o.indexOf(a);-1!==c&&o.splice(c,1)})},over:a=>-1!==o.indexOf(a)&&c()===a,onDown(a){p.onDown=a},onUp(a){p.onUp=a},pressed:a=>!!e[a]},kontra._tick=function(){m.length=0,l.map(function(a){m.push(a)}),l.length=0}}();const letters={A:[[,1],[1,,1],[1,,1],[1,1,1],[1,,1]],B:[[1,1],[1,,1],[1,1,1],[1,,1],[1,1]],C:[[1,1,1],[1],[1],[1],[1,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1,1],[1,,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[1,1,1],[,,1],[,,1],[1,,1],[1,1,1]],K:[[1,,,1],[1,,1],[1,1],[1,,1],[1,,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,1,1,1,1],[1,,1,,1],[1,,1,,1],[1,,,,1],[1,,,,1]],N:[[1,,,1],[1,1,,1],[1,,1,1],[1,,,1],[1,,,1]],O:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],P:[[1,1,1],[1,,1],[1,1,1],[1],[1]],Q:[[0,1,1],[1,,,1],[1,,,1],[1,,1,1],[1,1,1,1]],R:[[1,1],[1,,1],[1,,1],[1,1],[1,,1]],S:[[1,1,1],[1],[1,1,1],[,,1],[1,1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[1,1,1]],V:[[1,,,,1],[1,,,,1],[,1,,1],[,1,,1],[,,1]],W:[[1,,,,1],[1,,,,1],[1,,,,1],[1,,1,,1],[1,1,1,1,1]],X:[[1,,,,1],[,1,,1],[,,1],[,1,,1],[1,,,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1,1,1],[,,,1],[,,1],[,1],[1,1,1,1,1]],0:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],1:[[,1],[,1],[,1],[,1],[,1]],2:[[1,1,1],[0,0,1],[1,1,1],[1,0,0],[1,1,1]],3:[[1,1,1],[0,0,1],[1,1,1],[0,0,1],[1,1,1]],4:[[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1]],5:[[1,1,1],[1,0,0],[1,1,1],[0,0,1],[1,1,1]],6:[[1,1,1],[1,0,0],[1,1,1],[1,0,1],[1,1,1]],7:[[1,1,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],8:[[1,1,1],[1,0,1],[1,1,1],[1,0,1],[1,1,1]],9:[[1,1,1],[1,0,1],[1,1,1],[0,0,1],[1,1,1]],"?":[[1,1,1],[,,1],[1,1,1],[,,],[1,,]],"!":[[,1],[,1],[,1],[,,],[,1]],"-":[[,,],[,,],[1,1,1]],".":[[,,],[,,],[,,],[,,],[1,,]],",":[[,,],[,,],[,,],[,1],[1,,]],"^":[[,1],[1,1,1],[,1],[,1],[,1]],"&":[[,1],[,1],[,1],[1,1,1],[,1]],"<":[[,,],[,1],[1,,],[,1],[,,]],">":[[,,],[,1],[,,1],[,1],[,,]],":":[[,,],[,1],[,,],[,1]],"/":[[,,],[,,1],[,1],[1,,]],"'":[[1,,],[1,,]]," ":[[,,],[,,],[,,],[,,],[,,]]},canvas=document.getElementById("text"),context=canvas.getContext("2d");function clearAllText(){context.clearRect(0,0,canvas.width,canvas.height)}function clearTextBox(){context.clearRect(0,325,canvas.width,150)}function clearLvl5(){context.clearRect(0,0,250,50),context.clearRect(180,50,30,25)}function drawText(a,b,c,d,e){let f=[];a=a.toUpperCase();for(let g=0;g<a.length;g++){const b=letters[a.charAt(g)];b&&f.push(b)}context.fillStyle=e;let g=c;for(let h=0;h<f.length;h++){const a=f[h];let c=d,e=0;for(let d=0;d<a.length;d++){const f=a[d];for(let a=0;a<f.length;a++)f[a]&&context.fillRect(g+a*b,c,b,b);e=Math.max(e,f.length*b),c+=b}g+=b+e}}function textBox(a,b,c){a=a.split("\\"),context.strokeStyle="white",context.fillStyle="black",context.lineWidth=4,context.rect(25,350,590,100),context.stroke(),context.fill(),drawText(a[0],4,35,360,c),drawText(a[1]||"",4,35,390,c),drawText(a[2]||"",4,35,420,c)}kontra.init(document.querySelector("#game"));const width=640,height=480;let curLvl=1;const playerSpeed=4,playerRad=kontra.sprite({width:60,height:60});let curDialogue,inDialogue=!1,curDialogueIndex=0,curDialogueChar=0,weapon=!1,health=10;const charSize=30,bulletSpeed=7,enemySpeed=2.5;let kills=0,fight=!0,lvl5BoxShown=!1,timers=[0,0,0],bullets=[],enemies=[],levels=[{player:kontra.vector(305,(height-30)/2),world:[],text:[[515/2,10,"^ Town ^",4,"white"]],triggers:[[270,0,100,30,2]],chars:{blue:{sprite:[305,100,30,30,"blue"],dialogue:["Hey Red!","What are you doing all the way down\\here? It's dangerous to go alo- err...\\unaccompanied! You need a weapon!","Go up into town, I'll meet you there\\in front of the shop."]}}},{player:kontra.vector(305,400),world:[[100,100,100,70,"white"],[100,170,30,30,"white"],[170,170,30,30,"white"],[440,100,100,70,"white"],[440,170,30,30,"white"],[510,170,30,30,"white"],[100,280,100,70,"white"],[100,350,30,30,"white"],[170,350,30,30,"white"],[440,280,100,70,"white"],[440,350,30,30,"white"],[510,350,30,30,"white"]],text:[[515/2,10,"^ Town ^",4,"white"]],triggers:[[270,0,100,20,3]],chars:{green:{sprite:[305,100,30,30,"green"],dialogue:["The shop?","It's just up North, be careful..."]}}},{player:kontra.vector(305,400),world:[[]],text:[[515/2,450,"& Town &",4,"white"],[10,(height-50)/2,"<- Shop",4,"white"],[250,10,"^ Internet ^",4,"white"]],triggers:[[270,460,100,20,2],[0,0,20,height,4],[270,0,100,30,5,!1]],chars:{}},{player:kontra.vector(535,(height-30)/2),world:[],text:[[515,(height-50)/2,"Town ->",4,"white"]],triggers:[[620,0,20,height,3]],chars:{blue:{sprite:[400,100,30,30,"blue"],dialogue:["Hi again!","Go talk to the shopkeeper, he can\\give you a weapon!"]},orange:{sprite:[100,300,30,30,"orange"],dialogue:["Hello there adventurer! What are\\you looking for?","You're looking for a weapon? Lucky\\for you, I have a data blaster, last\\one in stock! That'll be 400 bits!","You don't have any money? ...\\Well, why don't we make a deal?","The Internet went down this\\morning. I'll give you this data\\blaster, and in exchange you fix it.","How does that sound? ...","Great! You can find the Internet\\up to the north. Press Z to\\shoot the blaster. Good luck!"]}}},{player:kontra.vector(305,400),world:[],text:[[75,50,"Defeat    enemies to progress!",4,"white"]],triggers:[],chars:{}},{player:kontra.vector(305,400),world:[[270,75,100,50,"white"],[275,80,90,40,"black"]],text:[[150,25,"Turn on the Internet!",4,"white"]],triggers:[],chars:{}}];function createSprite(a){return kontra.sprite({x:a[0],y:a[1],width:a[2],height:a[3],color:a[4],level:a[4]})}function genLevels(){for(let a=0;a<levels.length;a++){for(let b=0;b<levels[a].world.length;b++){const c=levels[a].world[b];levels[a].world[b]=createSprite(c)}for(let b=0;b<levels[a].triggers.length;b++){const c=levels[a].triggers[b];levels[a].triggers[b]=createSprite(c),levels[a].triggers[b].enabled=!(c[5]!=null)||c[5]}for(const b in levels[a].chars){const c=levels[a].chars[b].sprite;levels[a].chars[b].sprite=createSprite(c)}}}function getLevel(a){let b=levels[a-1];b.colliders=[];for(const c of b.world)b.colliders.push(c);for(const c in b.chars)b.colliders.push(b.chars[c].sprite);clearAllText();for(const c of b.text)drawText(c[2],c[3],c[0],c[1],c[4]);return b}{drawText("Internet Quest",10,10,10,"white"),drawText("arrow keys to move",7,10,125,"white"),drawText("z to interact",7,10,175,"white");drawText("made by",7,10,275,"white"),drawText("Ivan Fonseca",7,230,275,"#0891db");drawText("for js    games 2018",7,10,325,"white"),drawText("13k",7,170,325,"red"),drawText("press z to start",7,10,430,"#03c123")}document.body.addEventListener("keydown",game);function game(a){if(90!=a.keyCode)return;document.body.removeEventListener("keydown",game),clearAllText(),genLevels();let b=getLevel(1),c=kontra.sprite({x:305,y:(height-charSize)/2,color:"red",width:charSize,height:charSize,update(){5==curLvl&&(clearLvl5(),drawText(`Health: ${health}`,4,5,5,"white"),drawText(25-kills+"",4,180,50,"white"),0>=health&&(health=10,curLvl=3,b=getLevel(3),this.position=b.player,kills=0),25<=kills&&(d.stop(),enemies=[],bullets=[],fight=!1,weapon=!1,timers[2]=-1,d.start(),d.stop(),curLvl=6,b=getLevel(6),this.position=b.player,setTimeout(()=>d.start(),3e3))),6==curLvl&&130>this.y&&(d.stop(),this.render=()=>{},clearAllText(),setTimeout(()=>{const a=new Path2D;a.arc(633/2,100,7,0,2*Math.PI),kontra.context.fillStyle="#dc143c",kontra.context.fill(a)},2e3),setTimeout(()=>{kontra.context.clearRect(0,0,width,height)},4e3),setTimeout(()=>{kontra.context.clearRect(0,0,width,height),textBox("Thanks for playing!\\github.com/IvanFon\\<3",6,"white")},6e3)),inDialogue||(kontra.keys.pressed("left")?(this.x-=playerSpeed,b.colliders.forEach(a=>this.x+=this.collidesWith(a)?playerSpeed:0)):kontra.keys.pressed("right")&&(this.x+=playerSpeed,b.colliders.forEach(a=>this.x-=this.collidesWith(a)?playerSpeed:0)),kontra.keys.pressed("up")?(this.y-=playerSpeed,b.colliders.forEach(a=>this.y+=this.collidesWith(a)?playerSpeed:0)):kontra.keys.pressed("down")&&(this.y+=playerSpeed,b.colliders.forEach(a=>this.y-=this.collidesWith(a)?playerSpeed:0))),this.position.clamp(0,0,width-this.width,height-this.height);for(const a of b.triggers)if(!this.collidesWith(a))lvl5BoxShown&&(clearTextBox(),lvl5BoxShown=!1);else if(a.enabled){curLvl=a.level,b=getLevel(a.level),this.position=b.player,5==curLvl&&(timers[2]=120);break}else 5==a.level&&(textBox("You need a weapon first!",4,"white"),lvl5BoxShown=!0);if(0>=timers[0]&&kontra.keys.pressed("z"))if(timers[0]=30,!inDialogue){for(const a in playerRad.x=this.x-15,playerRad.y=this.y-15,b.chars)if(b.chars[a].sprite.collidesWith(playerRad)){inDialogue=!0,curDialogueIndex=0,curDialogue=b.chars[a].dialogue,curDialogueChar=a,"orange"==a&&(weapon=!0,levels[2].triggers[2].enabled=!0),textBox(curDialogue[0],6,"white");break}}else if(clearTextBox(),curDialogueIndex<curDialogue.length){if(0<=curDialogue[curDialogueIndex].indexOf("Area unlocked")){const a=curDialogue[curDialogueIndex].split("$");b.triggers[a[1]].enabled=!0,b.chars[curDialogueChar].dialogue.splice(curDialogueIndex,1),textBox("Area unlocked!",6,"#0891db")}else textBox(curDialogue[curDialogueIndex],6,"white");curDialogueIndex++}else inDialogue=!1,timers[1]=60;if(0>=timers[1]&&kontra.keys.pressed("z")&&!inDialogue&&weapon){for(let a=0;4>a;a++).5<=Math.random()?bullets.push(kontra.sprite({x:c.x,y:c.y,width:3,height:12,color:"white",update(){0==a?this.y+=bulletSpeed:1==a?this.y-=bulletSpeed:2==a?this.x+=bulletSpeed:3==a?this.x-=bulletSpeed:void 0}})):(bullets.push(kontra.sprite({x:c.x-5,y:c.y-5,width:10,height:10,color:"white",update(){0==a?this.y+=bulletSpeed:1==a?this.y-=bulletSpeed:2==a?this.x+=bulletSpeed:3==a?this.x-=bulletSpeed:void 0}})),bullets.push(kontra.sprite({x:c.x-2,y:c.y-2,width:4,height:4,color:"black",update(){0==a?this.y+=bulletSpeed:1==a?this.y-=bulletSpeed:2==a?this.x+=bulletSpeed:3==a?this.x-=bulletSpeed:void 0}})));timers[1]=20}}}),d=kontra.gameLoop({update(){c.update(),bullets=bullets.filter(a=>(a.update(),!(0>a.x||a.x>width||0>a.y||a.y>height))),enemies.map(a=>a.update()),timers=timers.map(a=>--a),0==timers[2]&&(enemies.push(kontra.sprite({x:.5<=Math.random()?width/6:5*(width/6),y:.5<=Math.random()?height/6:5*(height/6),width:20,height:20,color:"#ff00f1",health:2,update(){if(!(0>=this.health)){this.x>c.x&&(this.x-=enemySpeed),this.x<c.x&&(this.x+=enemySpeed),this.y>c.y&&(this.y-=enemySpeed),this.y<c.y&&(this.y+=enemySpeed),this.collidesWith(c)&&(health--,this.health=0,kills++);for(let a=0;a<bullets.length;a++)this.collidesWith(bullets[a])&&(bullets.splice(a,1),this.health--,0>=this.health&&kills++)}},render(){0<this.health&&this.draw()}})),fight&&(timers[2]=200-(25-kills)-8*kills))},render(){c.render(),bullets.map(a=>a.render()),enemies.map(a=>a.render()),b.world.map(a=>a.render()),Object.keys(b.chars).map(a=>b.chars[a].sprite.render())}});d.start()}
    </script>
  </body>
</html>
