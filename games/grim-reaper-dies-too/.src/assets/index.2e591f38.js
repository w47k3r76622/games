var ae=Object.defineProperty;var le=(i,e,t)=>e in i?ae(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>(le(i,typeof e!="symbol"?e+"":e,t),t),_=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var q=(i,e,t)=>(_(i,e,"read from private field"),t?t.call(i):e.get(i)),P=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},U=(i,e,t,n)=>(_(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t);var B=(i,e,t)=>(_(i,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function k(i,e,t){return Math.max(Math.min(e,t),i)}function V(i,e){let t;return(...n)=>{clearTimeout(t),t=setTimeout(()=>i(...n),e)}}function de(i){let e=0,t=0,n=0;return s=>{s-n>=1e3?(n=s,e=t,t=0):t+=1,i.font="20px sans-serif",i.fillStyle="green",i.fillText(e.toFixed(2),window.innerWidth-70,window.innerHeight-15)}}const he=1280,a=32;function o(i){const e=k(.75,window.innerWidth/he,1.75);return i*e}function L(i){return i<1?[]:[...Array(i).keys()]}function ce(i,e){return!(i.x>e.x+e.size||e.x>i.x+i.size||i.y>e.y+e.size||e.y>i.y+i.size)}function fe(i){const e=new Image;return e.src=i,e}const N=()=>window.DEBUG&&!1;function J(){I.width=window.innerWidth,I.height=window.innerHeight}const I=document.querySelector("canvas");J();window.addEventListener("resize",V(J,100));const x=I.getContext("2d");function me(){x.clearRect(0,0,I.width,I.height)}const X="__0ctothorp/grim-reaper-dies-too__",z={playedAlready:X+";playedAlready",highscore:X+";highscore"};var S;class ye{constructor(){d(this,"_screen","mainmenu");P(this,S,0);d(this,"waitingForStart",3e3);d(this,"score",0);d(this,"mainmenu");d(this,"howtoplay");d(this,"uded");var t,n;const e=document.getElementById("howtoplay-btn");this.howtoplay=document.getElementById("howtoplay"),this.mainmenu=document.getElementById("mainmenu"),this.uded=document.getElementById("uded"),localStorage.getItem(z.playedAlready)&&(e.style.display="initial"),e.addEventListener("click",()=>{this.mainmenu.style.display="none",this.howtoplay.style.display="block"}),(t=document.querySelector("#restart-btn"))==null||t.addEventListener("click",()=>{this.level=0,this.screen="game",this.uded.style.display=""}),(n=document.querySelector("#back-to-menu"))==null||n.addEventListener("click",()=>{this.uded.style.display="none",this.level=0,this.screen="mainmenu"}),document.querySelectorAll(".start").forEach(s=>s.addEventListener("click",()=>this.handleStart()))}handleStart(){localStorage.getItem(z.playedAlready)?(this.howtoplay.style.display="none",this.mainmenu.style.display="none",this.screen="game"):(localStorage.setItem(z.playedAlready,"true"),this.mainmenu.style.display="none",this.howtoplay.style.display="block")}set screen(e){switch(this._screen=e,e){case"uded":this.handleUDed();break;case"mainmenu":this.mainmenu.style.display="flex",this.waitingForStart=3e3;break}}get screen(){return this._screen}handleUDed(){this.uded.style.display="block";const e=Number(localStorage.getItem(z.highscore))||0,t=this.uded.querySelector(".score");this.score>e?(t.innerHTML="\u{1F389} "+this.score.toFixed()+" \u{1F389}",localStorage.setItem(z.highscore,this.score.toFixed())):t.innerHTML=this.score.toFixed(),this.uded.querySelector(".highscore").innerHTML=e.toFixed()}set level(e){U(this,S,e),se(q(this,S)),re(),this.waitingForStart=3e3,e===0?this.score=0:this.score+=1}get level(){return q(this,S)}canRunSystems(){return this.screen==="game"&&!this.waitingForStart}countdown(e){this.screen==="game"&&this.waitingForStart!==0&&(x.fillStyle="white",x.font=`${o(128)}px sans-serif`,x.fillText(parseInt((this.waitingForStart/1e3+1).toString()).toString(),window.innerWidth/2-10,window.innerHeight/2-10),this.waitingForStart=Math.max(this.waitingForStart-e,0))}}S=new WeakMap;const m=new ye;class g{constructor(e){d(this,"entity");this.entity=e}getAllComponents(){return c[this.entity]}}class O extends g{constructor(t,n=0,s=0){super(t);d(this,"x");d(this,"y");this.x=n,this.y=s}}class W extends g{constructor(t,n,s){super(t);d(this,"x",0);d(this,"y",0);d(this,"segment");d(this,"index");this.segment=n,this.index=s,this.calcPosition(),window.addEventListener("resize",V(()=>this.calcPosition(),200))}calcPosition(){const t=p(m.level);(this.segment==="top"||this.segment==="bottom")&&(this.x=window.innerWidth/2-(t.width+2)*o(a)/2+this.index*o(a)),this.segment==="top"&&(this.y=window.innerHeight/2-(t.height+2)/2*o(a)),this.segment==="bottom"&&(this.y=window.innerHeight/2+t.height/2*o(a)),(this.segment==="left"||this.segment==="right")&&(this.y=window.innerHeight/2-t.height*o(a)/2+this.index*o(a)),this.segment==="left"&&(this.x=window.innerWidth/2-(t.width/2+1)*o(a)),this.segment==="right"&&(this.x=window.innerWidth/2+t.width/2*o(a))}}class Q extends g{constructor(){super(...arguments);d(this,"transform")}start(){this.transform=this.getAllComponents().transform}tryMoveY(t,n){const s=p(m.level),r=this.transform.y+t;t<0?r<s.y?(this.transform.y=s.y,n==null||n()):this.transform.y=r:r>s.y+(s.height-1)*o(a)?(this.transform.y=s.y+(s.height-1)*o(a),n==null||n()):this.transform.y=r}tryMoveX(t,n){const s=p(m.level),r=this.transform.x+t;t<0?r<s.x?(this.transform.x=s.x,n==null||n()):this.transform.x=r:r>s.x+(s.width-1)*o(a)?(this.transform.x=s.x+(s.width-1)*o(a),n==null||n()):this.transform.x=r}}const K={},w=[],Z=["KeyW","KeyA","KeyS","KeyD"];window.addEventListener("keydown",i=>{Z.includes(i.code)&&w[0]!==i.code&&(i.code,w.unshift(i.code)),K[i.code]=!0});window.addEventListener("keyup",i=>{if(Z.includes(i.code)){w[0]===i.code&&w.shift();const e=w.findIndex(t=>t===i.code);e>-1&&w.splice(e,e)}K[i.code]=!1});const F=fe("spritesheet.png"),H={skull:{x:0,y:0,size:16},npcNormal:{x:16,y:0,size:16},npcEvil:{x:32,y:0,size:16},door:{x:0,y:16,size:32},heart:{x:32,y:16,size:16},wall:{x:32,y:32,size:16}};class u{constructor(){d(this,"offset",{x:0,y:0});d(this,"playerTransform")}start(){this.playerTransform=c.player.transform}update(){const e=p(m.level),t=this.playerTransform,n=e.width*o(a);if(n>window.innerWidth){const r=t.x-window.innerWidth/2;r>0?this.offset.x=Math.max(-r,(window.innerWidth-n)/2-o(a)):r<0&&(this.offset.x=Math.min(-r,(n-window.innerWidth)/2+o(a)))}const s=e.height*o(a);if(s>window.innerHeight){const r=t.y-window.innerHeight/2;r>0?this.offset.y=Math.max(-r,(window.innerHeight-s)/2-o(a)):r<0&&(this.offset.y=Math.min(-r,(s-window.innerHeight)/2+o(a)))}}static getInstance(){return c.camera.camera}}var A,ee;class v extends g{constructor(t,n){super(t);P(this,A);d(this,"size");d(this,"collidingWith",new Set);d(this,"enabled",!0);d(this,"transform");this.size=n}start(){this.transform=c[this.entity].transform}DEBUG_render(t){var n,s;!B(this,A,ee).call(this)&&N()||(this.collidingWith.size>0?t.strokeStyle="rgb(255,0,0)":t.strokeStyle="rgb(0,255,0)",t.lineWidth=2,t.beginPath(),t.rect((n=this.transform)==null?void 0:n.x,(s=this.transform)==null?void 0:s.y,o(this.size[0]),o(this.size[1])),t.closePath(),t.stroke())}}A=new WeakSet,ee=function(){return this.transform||(this.transform=c[this.entity].transform),this.transform};class M extends g{constructor(t,n,s){super(t);d(this,"spriteId");d(this,"size");d(this,"transform");this.spriteId=n,this.size=s||a}start(){this.transform=c[this.entity].transform}render(t){if(!this.transform&&(this.transform=c[this.entity].transform,!this.transform))return;const{x:n,y:s}=this.transform,r=o(this.size);t.imageSmoothingEnabled=!1;const l=H[this.spriteId];t.drawImage(F,l.x,l.y,l.size,l.size,n+u.getInstance().offset.x,s+u.getInstance().offset.y,r,r)}}class ue extends Q{constructor(){super(...arguments);d(this,"speed",.5)}update(t){if(!K[w[0]])return;const n=o(this.speed*t);switch(w[0]){case"KeyW":this.tryMoveY(-n);break;case"KeyA":this.tryMoveX(-n);break;case"KeyS":this.tryMoveY(n);break;case"KeyD":this.tryMoveX(n);break}}}class pe extends g{constructor(){super(...arguments);d(this,"hearts",3)}render(t){t.imageSmoothingEnabled=!1;const n=H.heart;L(this.hearts).forEach(s=>{t.drawImage(F,n.x,n.y,n.size,n.size,window.innerWidth-(s+1)*o(64),o(16),o(48),o(48))})}}class ge extends v{constructor(){super(...arguments);d(this,"playerHealth");d(this,"disabledTime",-1)}start(){if(this.playerHealth=c.player.ui,!this.playerHealth)throw new Error("no health component on player")}update(){!this.enabled&&this.disabledTime>-1&&Date.now()>=this.disabledTime+1e3&&(this.enabled=!0)}onCollide(t){for(const n of t){const s=c[n],{npcLife:r}=s;if(r&&(r.lifeProgress>=r.shouldDieAt[0]&&r.lifeProgress<=r.shouldDieAt[1]&&(c.player.collider.collidingWith.delete(n),delete c[n],m.score+=1,document.querySelector("#hit-audio").play(),Object.keys(c).filter(l=>l.startsWith("npc")).length===0&&c.door.spawner.spawn()),!r.living&&this.enabled)){if(this.playerHealth.hearts-=1,document.querySelector("#hurt-audio").play(),this.playerHealth.hearts===0){this.enabled=!1,m.screen="uded";return}this.enabled=!1,this.disabledTime=Date.now()}}}}class we extends Q{constructor(t){super(t);d(this,"speed",.2);d(this,"direction",[0,0]);d(this,"accumulatedTime",0);d(this,"life");d(this,"playerTransform");d(this,"boundRecomputeDirection");this.boundRecomputeDirection=this.recomputeDirection.bind(this)}start(){if(super.start(),this.life=c[this.entity].npcLife,!this.life)throw`no life component on ${this.entity}`;this.playerTransform=c.player.transform,this.recomputeDirection()}recomputeDirection(){const t=Math.floor(Math.random()*2);this.direction[t]=Math.random()>.5?-1:1,this.direction[Math.abs(t-1)]=0,this.accumulatedTime=0}update(t){const n=o(this.speed*t);if(this.life.living){if(this.accumulatedTime>=2e3){this.recomputeDirection();return}this.accumulatedTime+=t,this.direction[1]===1&&this.tryMoveY(-n,this.boundRecomputeDirection),this.direction[1]===-1&&this.tryMoveY(n,this.boundRecomputeDirection),this.direction[0]===-1&&this.tryMoveX(-n,this.boundRecomputeDirection),this.direction[0]===1&&this.tryMoveX(n,this.boundRecomputeDirection)}else{const s=this.playerTransform,r=this.transform,l=r.x-s.x,h=r.y-s.y;Math.abs(l)>Math.abs(h)?this.tryMoveX(n*-Math.sign(l),this.boundRecomputeDirection):this.tryMoveY(n*-Math.sign(h),this.boundRecomputeDirection)}}}class xe extends g{render(e){const t=c[this.entity].transform;if(!t)return;const n=c[this.entity].npcLife;if(!n)return;const{x:s,y:r}=t,l=o(a);if(e.imageSmoothingEnabled=!1,n.living){const h=H.npcNormal;e.drawImage(F,h.x,h.y,h.size,h.size,s+u.getInstance().offset.x,r+u.getInstance().offset.y,l,l)}else{const h=H.npcEvil;e.drawImage(F,h.x,h.y,h.size,h.size,s+u.getInstance().offset.x,r+u.getInstance().offset.y,l,l)}if(n.living){const h=o(75);e.strokeStyle="green",e.lineWidth=o(11),e.beginPath();const f=s+l/2-h/2+u.getInstance().offset.x,y=r-o(10)+u.getInstance().offset.y;e.moveTo(f,y),e.lineTo(f+h,y),e.closePath(),e.stroke(),e.strokeStyle="red",e.beginPath();const D=f+n.shouldDieAt[0]*h;e.moveTo(D,y),e.lineTo(f+n.shouldDieAt[1]*h,y),e.closePath(),e.stroke(),e.strokeStyle="yellow",e.beginPath();const E=f+h*n.lifeProgress;e.moveTo(E,y),e.lineTo(E+1,y),e.closePath(),e.stroke()}N()&&(e.font="16px sans-serif",e.fillStyle="rgb(0, 255, 0)",e.fillText(this.entity,s,r-o(20)))}}var R,te;class ve extends g{constructor(){super(...arguments);P(this,R);d(this,"shouldDieAt",[0,1]);d(this,"lifeProgress",0);d(this,"_living",!0);d(this,"lifeLength",Math.random()*5e3+1e4)}start(){const t=Math.min(Math.random()+.25,.75);this.shouldDieAt=[t-.1,t+.1]}update(t){this.living&&(this.lifeProgress+=t/this.lifeLength,this.lifeProgress>1&&(this.lifeProgress=1,this.living=!1))}set living(t){if(this._living=t,t)return;Object.entries(c).filter(([s])=>s.startsWith("npc")).map(([,s])=>s).every(s=>{var r;return!((r=s.npcLife)!=null&&r.living)})&&B(this,R,te).call(this)}get living(){return this._living}}R=new WeakSet,te=function(){c.door.spawner.spawn()};class be extends v{onCollide(){}}class Me extends v{onCollide(e){for(const t of e)t==="player"&&(m.level+=1,document.querySelector("#powerup-audio").play())}}class Se extends g{constructor(){super(...arguments);d(this,"playerTransform")}start(){this.playerTransform=c.player.transform}spawn(){const t=this.playerTransform,n=p(m.level),s=t.x>window.innerWidth/2?-1:1,r=n.width*o(a),l=k(n.x+o(64),t.x+s*r/2+Math.random()*s*r/2,n.x+r-o(64)),h=t.y>window.innerHeight/2?-1:1,f=n.height*o(a),y=k(n.y+o(64),t.y+h*f/2+Math.random()*h*f/2,n.y+f-o(64));c.door.transform=new O("door",l,y)}}function ie({x:i,y:e}){const t=p(m.level);return{x:window.innerWidth/2-t.width*o(a)/2+i*o(a),y:window.innerHeight/2-t.height/2*o(a)+e*o(a)}}const Y=13,$=12;function p(i){let e=Y,t=$;return e=Y+i,t=$+Math.floor(i*.5),{width:e,height:t,get x(){return window.innerWidth/2-e/2*o(a)},get y(){return window.innerHeight/2-t/2*o(a)}}}function Ee(i){return{x:Math.floor(Math.random()*i.width),y:Math.floor(Math.random()*i.height)}}function ne(i,e){let t;do t=Ee(i);while(e[parseInt(t.x.toFixed())][parseInt(t.y.toFixed())]);return t}function Te(i,e){const t=p(i);return Object.fromEntries(L(i+1).map(n=>{const s=`npc${n}`,r=ne(t,e),l=ie(r);return[s,{transform:new O(s,l.x,l.y),renderer:new xe(s),movement:new we(s),npcLife:new ve(s),collider:new be(s,[a,a])}]}))}function ze(i){const{width:e,height:t}=p(i),n={},s=e+2;return L(s).forEach(r=>{const l=`maptop${r}`;n[l]={transform:new W(l,"top",r),renderer:new M(l,"wall"),collider:new v(l,[a,a])};const h=`mapbottom${r}`;n[h]={transform:new W(h,"bottom",r),renderer:new M(h,"wall"),collider:new v(h,[a,a])}}),L(t).forEach(r=>{const l=`mapleft${r}`;n[l]={transform:new W(l,"left",r),renderer:new M(l,"wall"),collider:new v(l,[a,a])};const h=`mapright${r}`;n[h]={transform:new W(h,"right",r),renderer:new M(h,"wall"),collider:new v(h,[a,a])}}),n}function se(i){const e=p(i),t=Array(e.width).fill(Array(e.height).fill(!1)),n=Te(i,t),s={transform:void 0,renderer:new M("door","door",a*2),collider:new Me("door",[a*2,a*2]),spawner:new Se("door")},r=ze(i),l=ie(ne(e,t));c={door:s,player:{transform:new O("player",l.x,l.y),renderer:new M("player","skull"),movement:new ue("player"),ui:new pe("player"),collider:new ge("player",[a,a])},...r,...n,camera:{camera:new u}}}let c={};se(0);function re(){var i;for(const e of Object.values(c))for(const t of Object.values(e))(i=t==null?void 0:t.start)==null||i.call(t)}function b(i){for(const e in c){const t=c[e];i(t)}}function Ie(){b(i=>{var e;return(e=i.renderer)==null?void 0:e.render(x)})}function De(i){b(e=>{var t,n;return(n=(t=e.movement)==null?void 0:t.update)==null?void 0:n.call(t,i)})}function Pe(i){b(e=>{var t,n;return(n=(t=e.npcLife)==null?void 0:t.update)==null?void 0:n.call(t,i)})}function We(){var i;(i=c.camera.camera)==null||i.update()}function Ce(){b(i=>{var e,t;return(t=(e=i.ui)==null?void 0:e.render)==null?void 0:t.call(e,x)})}const C=new Set;function G(i,e){return i<e?i+e:e+i}function Le(i){b(e=>{var t;b(n=>{var s,r,l,h,f,y,D,E;if(!(!e.collider||!n.collider)&&!(e.collider.entity.startsWith("map")&&n.collider.entity.startsWith("map"))){if(e.collider.entity!==n.collider.entity&&e.transform&&n.transform&&ce({x:(s=e.transform)==null?void 0:s.x,y:(r=e.transform)==null?void 0:r.y,size:o(e.collider.size[0])},{x:(l=n.transform)==null?void 0:l.x,y:(h=n.transform)==null?void 0:h.y,size:o(n.collider.size[0])})){const T=G(e.collider.entity,n.collider.entity);C.has(T)||(C.add(T),e.collider.collidingWith.add(n.collider.entity),n.collider.collidingWith.add(e.collider.entity),(y=(f=e.collider).onCollide)==null||y.call(f,e.collider.collidingWith),(E=(D=n.collider).onCollide)==null||E.call(D,n.collider.collidingWith))}else if(e.collider.entity!==n.collider.entity){const T=G(e.collider.entity,n.collider.entity);C.has(T)&&C.delete(T),e.collider.collidingWith.delete(n.collider.entity),n.collider.collidingWith.delete(e.collider.entity)}}}),N()&&((t=e.collider)==null||t.DEBUG_render(x))}),b(e=>{var t,n;return(n=(t=e.collider)==null?void 0:t.update)==null?void 0:n.call(t,i)})}window.DEBUG=!1;const Fe=de(x);re();let j=0;function oe(i){const e=i-j;j=i,m.canRunSystems()&&(De(e),Pe(e)),We(),me(),m.canRunSystems()&&Le(e),Ie(),Ce(),m.countdown(e),N()&&Fe(i),requestAnimationFrame(oe)}requestAnimationFrame(oe);
