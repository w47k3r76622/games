"use strict";function onkey(t,a,e){var r={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,X:88};switch(a){case r.LEFT:return controls.left=e,!1;case r.RIGHT:return controls.right=e,!1;case r.UP:return controls.up=e,!1;case r.DOWN:return controls.down=e,!1;case r.SPACE:return controls.space=e,!1;case r.X:return controls.x=e,!1}}var $={};$.width=800,$.height=500,$.colors={pink:"rgba(295, 99, 247, 1)",purple:"rgba(91, 0, 110, 1)",darkbrown:"rgba(73, 60, 43, 1)",brown:"rgba(164, 100, 34, 1)",yellow:"rgba(247, 226, 107, 1)",darkgreen:"rgba(47, 72, 78, 1)",green:"rgba(88, 167, 46, 1)",nightblue:"rgba(27, 38, 50, 1)",skyblue:"rgba(49, 162, 242, 1)"},$.red="rgba(190, 38, 51, 1)",$.black="rgba(0, 0, 0, 1)",$.gray="rgba(157, 157, 157, 1)",$.timer=0,$.red_chat=0,$.frank_chat=0,$.hermit_chat=0,$.entities=[],$.glitch=0,$.stop=!1,$.stop_count=10,$.quest_state=0,$.skip_state=0;var dt=0,controls={left:!1,right:!1,jump:!1};$.init=function(){$.canvas=document.getElementsByTagName("canvas")[0],$.canvas.width=$.width,$.canvas.height=$.height,$.ctx=$.canvas.getContext("2d"),$.chat=new $.Chat,$.quests=new $.Quests,$.generateRandomObjects(),$.map_x=80,$.map_y=50,$.loop()},$.loop=function(){$.render(),$.update(),window.requestAnimFrame($.loop)},$.update=function(){if(!$.stop){if($.timer++,100==$.timer&&$.chat.addChat("Frank","Oh hi. I'm Frank, how are you?",$.colors.green),300==$.timer&&$.chat.addChat("Frank","You can control me with the arrow keys. How do you like my home?",$.colors.green),700==$.timer&&$.chat.addChat("Frank","I know, it could use a lick of paint. But I like it here!",$.colors.green),800==$.timer&&$.chat.addChat("Frank","I got my stuff, I got my space. I'm happy.",$.colors.green),1100==$.timer&&$.chat.addChat("Frank","Let's go outside for a bit. You can walk on all the light tiles.",$.colors.green),1350==$.timer&&($.player.y>220?$.map.setData(96,60,$.colors.darkgreen):$.map.setData(96,63,$.colors.darkgreen)),1380==$.timer&&$.chat.addChat("Frank","What in the highest!",$.colors.green),1440==$.timer&&$.chat.addChat("Frank","A tree! In the middle of my house!",$.colors.green),1550==$.timer&&$.chat.addChat("Frank","I mean, I like trees. But not ones appearing without an invitation.",$.colors.green),1720==$.timer&&$.chat.addChat("Frank","This is highly irregular!",$.colors.green),2e3==$.timer&&$.chat.addChat("Frank","I need to go ask Gunnar. Gunnar knows about science and stuff.",$.colors.green),2200==$.timer&&$.chat.addChat("Frank","He lives not far to the south east. Let's go!",$.colors.green),2400==$.timer&&($.quests.addQuest(1,"Find Gunnar the science guy in the south east",3,3),$.quest_state=1),0==$.skip_state&&controls.space&&($.skip_state=1,$.timer=1999),$.timer>3e3&&50==$.map_y&&80==$.map_x&&0==$.red_chat&&($.red_chat=$.timer,$.map.setData(110,70,$.red)),$.red_chat>0&&($.timer===$.red_chat+30&&$.chat.addChat("Frank","Did you see that?",$.colors.green),$.timer===$.red_chat+150&&$.chat.addChat("Frank","That's... not good",$.colors.green),$.timer===$.red_chat+300&&$.chat.addChat("Frank","That red sludge is highly dangerous. Don't go near it!",$.colors.green),$.timer===$.red_chat+500&&$.chat.addChat("Frank","It will ooze around open spaces. Good luck it's been trapped between solid stuff!",$.colors.green),$.timer===$.red_chat+650&&($.chat.addChat("Frank","But how did it get there?",$.colors.green),$.red_chat=-1)),"noone"===$.npcs.overlap());else if("Gunnar"===$.npcs.overlap())for(var t=$.quests.getAll(),a=0;a<t.length;a++)1!==t[a].id||t[a].complete||($.quests.complete(1),$.quest_state=2,$.chat.addChat("Gunnar","HI FRANK!",$.colors.skyblue),$.frank_chat=$.timer);else if("The Hermit"===$.npcs.overlap())for(var t=$.quests.getAll(),a=0;a<t.length;a++)2!==t[a].id||t[a].complete||($.quests.complete(2),$.quest_state=3,$.chat.addChat("The Hermit","Frank. I didn't expect _you_",$.colors.yellow),$.hermit_chat=$.timer);if($.hermit_chat>0){if($.timer===$.hermit_chat+70&&$.chat.addChat("Frank","Apologies oh great Hermit...",$.colors.green),$.timer===$.hermit_chat+270&&$.chat.addChat("The Hermit","Yeah yeah. This kinda thing happens way too often for my liking.",$.colors.yellow),$.timer===$.hermit_chat+350&&$.chat.addChat("Frank","So sorry oh great Hermit...",$.colors.green),$.timer===$.hermit_chat+500&&$.chat.addChat("The Hermit","I got good news: I have the perfect solution!",$.colors.yellow),$.timer===$.hermit_chat+600&&$.chat.addChat("Frank","Ah! Thank you so much oh great...",$.colors.green),$.timer===$.hermit_chat+660&&$.chat.addChat("The Hermit","If you lot can't learn... maybe others will.",$.colors.yellow),$.timer===$.hermit_chat+800&&$.chat.addChat("Frank","What do you mean...others? ",$.colors.green),$.timer>$.hermit_chat+1e3)for(var a=1;a<5;a++){var e=$.util.randomIntInRange(0,41),r=$.util.randomIntInRange(0,26);$.map.setData(e,r,$.red)}if($.timer>$.hermit_chat+1500){for(var a=0;a<41;a++)for(var o=0;o<26;o++)$.map.setData(a,o,$.red);$.Draw.rectFill(160,160,160,160,$.red),document.getElementById("death").innerHTML="Frank had one last thought before the red sludge ate him up: It had been a bad day for Frank.<br/><br/>Thanks for playing!<br/><br/>Made by dollarone for JS13k 2016.",$.stop=!0}}$.frank_chat>0&&($.timer===$.frank_chat+70&&$.chat.addChat("Frank","Hi Gunnar.",$.colors.green),$.timer===$.frank_chat+150&&$.chat.addChat("Frank","Uhm... weird things are happening man.",$.colors.green),$.timer===$.frank_chat+300&&$.chat.addChat("Frank","A tree suddenly appeared in my house!",$.colors.green),$.timer===$.frank_chat+400&&$.chat.addChat("Gunnar","OH NOT THIS AGAIN.",$.colors.skyblue),$.timer===$.frank_chat+480&&$.chat.addChat("Frank","Again? What do you...",$.colors.green),$.timer===$.frank_chat+600&&$.chat.addChat("Gunnar","OHSHITOHSHITOHSHIT",$.colors.skyblue),$.timer===$.frank_chat+800&&$.chat.addChat("Frank","Gunnar? Why is this happening?",$.colors.green),$.timer===$.frank_chat+1e3&&$.chat.addChat("Gunnar","FRANK! YOU HAVE TO GO ASK FOR HELP.",$.colors.skyblue),$.timer===$.frank_chat+1300&&$.chat.addChat("Gunnar","GO TO THE HERMIT AND PLEAD!",$.colors.skyblue),$.timer===$.frank_chat+1650&&$.chat.addChat("Frank","The Hermit? but...",$.colors.green),$.timer===$.frank_chat+1690&&$.chat.addChat("Gunnar","FRANK!",$.colors.skyblue),$.timer===$.frank_chat+1700&&$.chat.addChat("Gunnar","YOU NEED TO DO THIS FOR ME. I HAVE ... HISTORY WITH HIM.",$.colors.skyblue),$.timer===$.frank_chat+2e3&&$.chat.addChat("Gunnar","THE HERMIT LIVES ON THE ISLAND NORTH WEST OF HERE.",$.colors.skyblue),$.timer===$.frank_chat+2250&&$.chat.addChat("Frank","But how do I cross the red sludge?",$.colors.green),$.timer===$.frank_chat+2500&&$.chat.addChat("Gunnar","NOT A PROBLEM. HERE. TAKE THIS. ",$.colors.skyblue),$.timer===$.frank_chat+2800&&$.chat.addChat("Gunnar","ITS A RANDOMASSERâ„¢. ",$.colors.skyblue),$.timer===$.frank_chat+3e3&&$.chat.addChat("Gunnar","JUST PRESS THAT X BUTTON TO USE IT. ",$.colors.skyblue),$.timer===$.frank_chat+3300&&$.chat.addChat("Gunnar","AND BE CAREFUL. IT'S NOT PASSED SAFETY TESTING YET. ",$.colors.skyblue),$.timer===$.frank_chat+3450&&$.chat.addChat("Frank","Gunnar... what does it do?",$.colors.green),$.timer===$.frank_chat+3750&&$.chat.addChat("Gunnar","OH IT JUST CHANGES THE STRUCTURE OF MASS AROUND YOU.",$.colors.skyblue),$.timer===$.frank_chat+4100&&($.chat.addChat("Gunnar","NOW GO AS QUICK AS YOU CAN. TIME IS POTENTIALLY LIMITED.",$.colors.skyblue),$.quests.addQuest(2,"Ask the Hermit on the northwestern island for help",3,3),$.quest_state=2)),$.glitch++,$.quest_state>0&&$.glitch>parseInt(63-20*$.quest_state)&&($.randomGlitch(),$.glitch=0);for(var a=0;a<$.entities.length;a++)$.entities[a].update();$.player.update(),$.quests.update(),$.chat.update(),$.npcs.update()}},$.render=function(){$.Draw.clear(),$.map.render($.map_x,$.map_y),$.player.render(),$.quests.render(),$.chat.render(),$.npcs.render()},$.randomGlitch=function(){for(var t=$.util.randomIntInRange(1,199),a=$.util.randomIntInRange(1,124);a===parseInt($.map_y+$.player.y/20)&&t===parseInt($.map_x+$.player.x/20);)t=$.util.randomIntInRange(1,199),a=$.util.randomIntInRange(1,124);$.map.getData(t,a)!=$.gray&&$.map.setData(t,a,$.util.pickRandomFromObject($.colors))},$.generateRandomObjects=function(){$.entities=[],$.map=new $.Map(202,127,$.colors),$.player=new $.Player(409,249),$.npcs=new $.Npcs,$.npcs.addNpc("Gunnar",187,92),$.npcs.addNpc("The Hermit",15,15)},window.addEventListener("load",$.init,!1),window.addEventListener("keydown",function(t){return onkey(t,t.keyCode,!0)},!0),window.addEventListener("keyup",function(t){return onkey(t,t.keyCode,!1)},!1),$.Chat=function(){this.list=[],this.chatlines=0},$.Chat.prototype.addChat=function(t,a,e){this.list.push({who:t,text:a,color:e,fade:200}),this.chatlines++},$.Chat.prototype.render=function(){for(var t="",a=0;a<this.chatlines;a++)this.list[a].fade>0&&(t+="<div style='color: "+this.list[a].color+"; opacity:"+Math.min(this.list[a].fade,100)/100+";'>"+this.list[a].text+"</div><br />");t+="",document.getElementById("chat").innerHTML=t},$.Chat.prototype.update=function(t){for(var a=0;a<this.chatlines;a++)this.list[a].fade>0&&(this.list[a].fade-=.5)},$.Draw={clear:function(){$.ctx.clearRect(0,0,$.width,$.height)},rectFill:function(t,a,e,r,o){$.ctx.beginPath(),$.ctx.rect(t,a,e,r),$.ctx.fillStyle=o,$.ctx.fill()},rect:function(t,a,e,r,o){$.ctx.beginPath(),$.ctx.rect(t,a,e,r),$.ctx.strokeStyle=o,$.ctx.stroke()},putImageData:function(t,a,e){$.ctx.putImageData(t,a,e)},fillText:function(){$.ctx.font="20px",$.ctx.fillText("Hello World!",10,50)}},$.TILE_SIZE=20,$.Map=function(t,a,e){this.width=t,this.height=a,this.colors=e,this.offset=1,this.data=[t+1];for(var r=0;r<t;r++){this.data[r]=[a+1];for(var o=0;o<a-1;o++)this.data[0][o]=$.gray,this.data[r][o]=$.util.pickRandomFromObject($.colors),r>98&&r<104&&o>60&&o<65&&(this.data[r][o]=$.colors.yellow),101==r&&65==o&&(this.data[r][o]=$.colors.yellow),r>94&&r<102&&o>65&&o<68&&(this.data[r][o]=$.colors.yellow),100==r&&60==o&&(this.data[r][o]=$.colors.yellow),r>98&&r<101&&o>56&&o<60&&(this.data[r][o]=$.colors.yellow),103==r&&60==o&&(this.data[r][o]=$.colors.yellow),r>101&&r<105&&o>56&&o<60&&(this.data[r][o]=$.colors.yellow),98==r&&62==o&&(this.data[r][o]=$.colors.yellow),r>92&&r<98&&o>58&&o<65&&(this.data[r][o]=$.colors.yellow),r>108&&r<112&&o>68&&o<72&&(this.data[r][o]=$.colors.darkbrown),109==r&&69==o&&(this.data[r][o]=$.colors.purple),110==r&&71==o&&(this.data[r][o]=$.colors.nightblue),111==r&&71==o&&(this.data[r][o]=$.colors.darkgreen),110==r&&69==o&&(this.data[r][o]=$.colors.darkgreen),109==r&&71==o&&(this.data[r][o]=$.colors.nightblue),110==r&&70==o&&(this.data[r][o]=$.colors.pink),r>100&&r<106&&72==o&&(this.data[r][o]=$.colors.green),r>103&&r<108&&73==o&&(this.data[r][o]=$.colors.green),r>106&&r<113&&72==o&&(this.data[r][o]=$.colors.green),98==r&&o>67&&o<72&&(this.data[r][o]=$.colors.green),r>98&&r<102&&71==o&&(this.data[r][o]=$.colors.green),112==r&&o>68&&o<72&&(this.data[r][o]=$.colors.green),r>112&&r<118&&69==o&&(this.data[r][o]=$.colors.green),117==r&&o>69&&o<71&&(this.data[r][o]=$.colors.green),r>117&&r<126&&70==o&&(this.data[r][o]=$.colors.green),r>124&&r<133&&71==o&&(this.data[r][o]=$.colors.green),r>131&&r<137&&72==o&&(this.data[r][o]=$.colors.green),136==r&&o>72&&o<75&&(this.data[r][o]=$.colors.green),r>136&&r<139&&74==o&&(this.data[r][o]=$.colors.green),138==r&&o>74&&o<80&&(this.data[r][o]=$.colors.green),r>138&&r<144&&79==o&&(this.data[r][o]=$.colors.green),143==r&&o>79&&o<85&&(this.data[r][o]=$.colors.green),144==r&&o>83&&o<90&&(this.data[r][o]=$.colors.green),r>144&&r<152&&89==o&&(this.data[r][o]=$.colors.green),r>150&&r<153&&88==o&&(this.data[r][o]=$.colors.green),r>151&&r<160&&87==o&&(this.data[r][o]=$.colors.green),r>158&&r<165&&86==o&&(this.data[r][o]=$.colors.green),r>163&&r<170&&87==o&&(this.data[r][o]=$.colors.green),r>168&&r<172&&88==o&&(this.data[r][o]=$.colors.green),r>170&&r<175&&89==o&&(this.data[r][o]=$.colors.green),r>173&&r<178&&90==o&&(this.data[r][o]=$.colors.green),177==r&&o>90&&o<93&&(this.data[r][o]=$.colors.green),r>177&&r<182&&92==o&&(this.data[r][o]=$.colors.green),r>180&&r<184&&93==o&&(this.data[r][o]=$.colors.green),r>184&&r<196&&o>90&&o<96&&(this.data[r][o]=$.colors.yellow),184==r&&o>91&&o<95&&(this.data[r][o]=$.colors.yellow),196==r&&o>91&&o<95&&(this.data[r][o]=$.colors.yellow),r>185&&r<195&&90==o&&(this.data[r][o]=$.colors.yellow),r>185&&r<195&&96==o&&(this.data[r][o]=$.colors.yellow),r>176&&r<186&&o>30&&o<38&&(this.data[r][o]=$.colors.yellow),r>0&&r<45&&o>26&&o<36&&(this.data[r][o]=$.red),r>15&&r<45&&o>25&&o<35&&(this.data[r][o]=$.red),r>30&&r<46&&o>0&&o<35&&(this.data[r][o]=$.red);this.data[r][0]=$.gray,this.data[r][a-3]=$.gray}for(var o=0;o<a;o++)this.data[t-3][o]=$.gray},$.Map.prototype.getData=function(t,a){var e=parseInt(t),r=parseInt(a);return this.data[e][r]},$.Map.prototype.getDataFromPixel=function(t,a){return t<0?this.getData($.map_x-1,$.map_y+parseInt(a/$.TILE_SIZE)):a<0?this.getData($.map_x+parseInt(t/$.TILE_SIZE),$.map_y-1):this.getData($.map_x+parseInt(t/$.TILE_SIZE),$.map_y+parseInt(a/$.TILE_SIZE))},$.Map.prototype.setData=function(t,a,e){this.data[t][a]=e},$.Map.prototype.render=function(t,a){for(var e=t;e<t+40;e++)for(var r=a;r<a+25;r++)$.Draw.rectFill((e-t)*$.TILE_SIZE,(r-a)*$.TILE_SIZE,$.TILE_SIZE,$.TILE_SIZE,this.getData(e,r))},$.Map.prototype.isSolidAt=function(t,a){return this.isSolid(this.getData(parseInt(t/20),parseInt(a/20)))},$.Map.prototype.isSolid=function(t){return t===$.colors.nightblue||t===$.colors.darkbrown||t===$.colors.purple||t==$.gray||t===$.colors.darkgreen},$.Map.prototype.tile2pixel=function(t,a){return[t%40*TILE_SIZE,a%25*TILE_SIZE]},$.Map.prototype.clamp=function(t,a){return[parseInt(t/TILE_SIZE)*TILE_SIZE,parseInt(a/TILE_SIZE)*TILE_SIZE]},$.Npcs=function(){this.list=[],this.npcs=0,this.color="rgba(3, 3, 3, 1)",this.dimension=10},$.Npcs.prototype.addNpc=function(t,a,e){this.list.push({name:t,x:a,y:e}),this.npcs++},$.Npcs.prototype.render=function(){for(var t=0;t<this.npcs;t++)this.list[t].x>$.map_x&&this.list[t].x<$.map_x+40&&this.list[t].y>$.map_y&&this.list[t].y<$.map_y+25&&$.Draw.rect(20*(this.list[t].x-$.map_x)+5,20*(this.list[t].y-$.map_y)+5,this.dimension,this.dimension,this.color)},$.Npcs.prototype.overlap=function(){for(var t=0;t<this.npcs;t++)if(this.list[t].x>$.map_x&&this.list[t].x<$.map_x+40&&this.list[t].y>$.map_y&&this.list[t].y<$.map_y+25&&Math.abs($.player.x-15-20*(this.list[t].x-$.map_x)+5)<10&&Math.abs($.player.y-15-20*(this.list[t].y-$.map_y)+5)<10)return this.list[t].name;return"noone"},$.Npcs.prototype.update=function(){for(var t=0;t<this.npcs;t++)$.map.setData(this.list[t].x,this.list[t].y,$.colors.yellow)},$.Player=function(t,a){this.x=t,this.y=a,this.color="rgba(3, 3, 3, 1)",this.diameter=10,this.dimension=10,this.targetDimension=6,this.growthSpeed=1,this.left=!1,this.right=!1,this.jump=!1,this.direction=0,this.accel=2},$.Player.prototype.render=function(){$.Draw.rect(this.x-4,this.y-4,this.dimension,this.dimension,this.color)},$.Player.prototype.localGlitch=function(){for(var t=$.util.randomIntInRange(-5,5),a=$.util.randomIntInRange(-5,5);0===a&&0===t;)a=$.util.randomIntInRange(-5,5),t=$.util.randomIntInRange(-5,5);$.map.getData($.map_x+parseInt(this.x/20)+t,$.map_y+parseInt(this.y/20)+a)!=$.gray&&$.map.setData($.map_x+parseInt(this.x/20)+t,$.map_y+parseInt(this.y/20)+a,$.util.pickRandomFromObject($.colors))},$.Player.prototype.update=function(){var t=this.x,a=this.y;controls.left?t-=this.accel:controls.right?t+=this.accel:controls.up?a-=this.accel:controls.down?a+=this.accel:controls.x&&$.quest_state>0&&this.localGlitch(),$.map.isSolid($.map.getDataFromPixel(t-5,a-5))||$.map.isSolid($.map.getDataFromPixel(t+5,a+5))||$.map.isSolid($.map.getDataFromPixel(t-5,a+5))||$.map.isSolid($.map.getDataFromPixel(t+5,a-5))||(this.x=t,this.y=a),0!==$.hermit_chat||$.red!==$.map.getDataFromPixel(t-5,a-5)&&$.red!==$.map.getDataFromPixel(t+5,a+5)&&$.red!==$.map.getDataFromPixel(t-5,a+5)&&$.red!==$.map.getDataFromPixel(t+5,a-5)||(document.getElementById("death").innerHTML="Frank was brutally absorbed by the red sludge.<br />A few days later, the glitching stopped and normal living resumed - except for Frank, who was dead.",$.stop=!0),this.x<0?(this.x+=800,$.map_x-=40):this.x>800&&(this.x-=800,$.map_x+=40),this.y<0?(this.y+=500,$.map_y-=25):this.y>500&&(this.y-=500,$.map_y+=25)},$.Quests=function(){this.list=[],this.quests=0},$.Quests.prototype.addQuest=function(t,a,e,r){this.list.push({id:t,text:a,x:e,y:r,complete:!1,fade:100}),this.quests++},$.Quests.prototype.render=function(){for(var t="<ul>",a=0;a<this.quests;a++)this.list[a].fade>0&&(t+="<li style='color: "+$.colors.pink+"; opacity:"+this.list[a].fade/100+";'>"+this.list[a].text+"</li>");t+="</ul>",document.getElementById("quests").innerHTML=t},$.Quests.prototype.getAll=function(){return this.list},$.Quests.prototype.complete=function(t){for(var a=0;a<this.quests;a++)this.list[a].id==t&&(this.list[a].complete=!0)},$.Quests.prototype.update=function(t){for(var a=0;a<this.quests;a++)this.list[a].complete&&this.list[a].fade>0&&(this.list[a].fade-=.5)},$.RandomObj=function(t,a){this.x=t,this.y=a,this.dimension=40,this.targetDimension=$.util.randomInRange(40,40),this.growthSpeed=$.util.randomInRange(.5,2),this.color=$.util.pickRandomFromObject($.colors)},$.RandomObj.prototype.render=function(){$.Draw.rect(this.x,this.y,this.dimension,this.dimension,this.color)},$.RandomObj.prototype.update=function(){this.dimension<this.targetDimension&&(this.dimension+=this.growthSpeed)},$.util={},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),$.util.randomInRange=function(t,a){return Math.random()*(a-t)+t},$.util.randomIntInRange=function(t,a){return Math.floor(Math.random()*(a-t)+t)},$.util.pickRandomFromObject=function(t){var a=Object.keys(t);return t[a[a.length*Math.random()<<0]]},$.util.rndSeed=function(t){return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}},$.util.bound=function(t,a,e){return Math.max(a,Math.min(e,t))};