(()=>{"use strict";const t=({max:t,min:e})=>Math.floor(Math.random()*(t-e))+e,e={appElementID:"#app",wrapperElementID:"#wrapper",width:110,height:55,viewWidth:550,viewHeight:275,canvasWidth:1760,canvasHeight:880,gamemode:{title:{val:0,text:!0},playing:{val:1,text:!1},gameclear:{val:2,text:!0},gameover:{val:3,text:!0}},debugMode:!0,pixel:16,visibleRange:3};class i{constructor({x:t,y:e,height:i,width:s}){this.x=t,this.y=e,this.height=i,this.width=s,this.angle="u",this.prevAngle="u",this.color="yellow"}update(t){(t.keyboard.includes("r")||t.keyboard.includes("l"))&&this.updateAngle(t.keyboard),(t.keyboard.includes("u")||t.keyboard.includes("d"))&&(this.updateX(t.keyboard,t.stage.maxX,t.stage.minX,t),this.updateY(t.keyboard,t.stage.maxY,t.stage.minY,t)),t.stage.isInnerRoom(this.x,this.y,!0),t.stage.isInnerPath(this.x,this.y,this.angle,!0)}updateX(t,e,i,s){const o=this.x;"r"===this.angle&&t.includes("u")||"l"===this.angle&&t.includes("d")?this.x=this.x+1:("r"===this.angle&&t.includes("d")||"l"===this.angle&&t.includes("u"))&&(this.x=this.x-1),this.x>=e&&(this.x=e),this.x<=i&&(this.x=i),s.stage.hitWall(this.x,this.y)&&(this.x=o)}updateY(t,e,i,s){const o=this.y;"u"===this.angle&&t.includes("u")||"d"===this.angle&&t.includes("d")?this.y=this.y-1:("u"===this.angle&&t.includes("d")||"d"===this.angle&&t.includes("u"))&&(this.y=this.y+1),this.y>=e&&(this.y=e),this.y<=i&&(this.y=i),s.stage.hitWall(this.x,this.y)&&(this.y=o)}updateAngle(t){this.prevAngle=this.angle,t.includes("r")&&("u"===this.angle?this.angle="r":"r"===this.angle?this.angle="d":"d"===this.angle?this.angle="l":"l"===this.angle&&(this.angle="u")),t.includes("l")&&("u"===this.angle?this.angle="l":"r"===this.angle?this.angle="u":"d"===this.angle?this.angle="r":"l"===this.angle&&(this.angle="d"))}draw(t){this.drawCharacter(t.ctx)}drawCharacter(t){const i=this.x*e.pixel+this.width/2,s=this.y*e.pixel+this.width/2,o=this.width/2;let a=0;"r"===this.angle&&(a=90),"d"===this.angle&&(a=180),"l"===this.angle&&(a=270);const h=i-o*Math.cos((90+a)/180*Math.PI),n=s-o*Math.sin((90+a)/180*Math.PI),r=i-o*Math.cos((210+a)/180*Math.PI),l=s-o*Math.sin((210+a)/180*Math.PI),d=i-o*Math.cos((330+a)/180*Math.PI),c=s-o*Math.sin((330+a)/180*Math.PI);t.beginPath(),t.moveTo(h,n),t.lineTo(r,l),t.lineTo(d,c),t.closePath(),t.fillStyle=this.color,t.fill()}}class s extends i{constructor({x:t,y:e,height:i,width:s}){super({x:t,y:e,height:i,width:s}),this.color="red",this.speed=1,this.step=0,this.prevD=[]}update(e){let i=[["u"],["u","r"],["r"],["r","d"],["d"],["d","l"],["l"],["l","u"],[]],s=i[t({max:i.length-1,min:0})];this.step>0?(this.step-=1,s=this.prevD):(this.step=t({max:100,min:10}),this.prevD=s),this.updateX(s,e.stage.maxX,e.stage.minX,e),this.updateY(s,e.stage.maxY,e.stage.minY,e),this.updateAngle(s)}updateX(t,e,i,s){const o=this.x;t.find((t=>"r"===t))?this.x=this.x+1:t.find((t=>"l"===t))&&(this.x=this.x-1),this.x>=e&&(this.x=e),this.x<=i&&(this.x=i),s.stage.hitWall(this.x,this.y)&&(this.x=o)}updateY(t,e,i,s){const o=this.y;t.find((t=>"u"===t))&&(this.y=this.y-1),t.find((t=>"d"===t))&&(this.y=this.y+1),this.y>=e&&(this.y=e),this.y<=i&&(this.y=i),s.stage.hitWall(this.x,this.y)&&(this.y=o)}updateAngle(t){t.includes("r")||t.includes("l")||!t.includes("u")||t.includes("d")||(this.angle=0),t.includes("r")&&!t.includes("l")&&t.includes("u")&&!t.includes("d")&&(this.angle=45),!t.includes("r")||t.includes("l")||t.includes("u")||t.includes("d")||(this.angle=90),t.includes("r")&&!t.includes("l")&&!t.includes("u")&&t.includes("d")&&(this.angle=135),t.includes("r")||t.includes("l")||t.includes("u")||!t.includes("d")||(this.angle=180),!t.includes("r")&&t.includes("l")&&!t.includes("u")&&t.includes("d")&&(this.angle=225),t.includes("r")||!t.includes("l")||t.includes("u")||t.includes("d")||(this.angle=270),!t.includes("r")&&t.includes("l")&&t.includes("u")&&!t.includes("d")&&(this.angle=315)}draw(t){const e=t.stage.isInnerRoom(this.x,this.y),i=t.stage.isInnerPath(this.x,this.y,[]);(e&&e.visible||i&&i.visible)&&super.draw(t)}}class o{constructor(){this.divideX=t({max:5,min:2}),this.divideY=3,this.stageColor1="rgba(0, 0, 150, 1)",this.stageColor2="rgba(0, 0, 150, 0.5)",this.defaultVisible=!1,this.realms=[],this.connects=[],this.pathPositions=[],this.divide(),this.makeRoom(),this.makePath(),this.maxX=Math.max(...this.realms.map((t=>t.right)))-1,this.minX=Math.min(...this.realms.map((t=>t.left))),this.maxY=Math.max(...this.realms.map((t=>t.bottom)))-1,this.minY=Math.min(...this.realms.map((t=>t.top)))}divide(){let t,i,s,o;const a=new Array(this.divideX),h=new Array(this.divideY),n=e.canvasHeight,r=e.canvasWidth,l=Math.floor(n/e.pixel),d=Math.floor(r/e.pixel);for(t=0;t<this.divideX;t+=1)a[t]=0;for(t=0;t<this.divideY;t+=1)h[t]=0;for(o=this.divideX,t=o;t<d;t+=1)a[Math.floor(Math.random()*this.divideX)]+=1;for(o=this.divideY,t=o;t<l;t+=1)h[Math.floor(Math.random()*this.divideY)]+=1;let c=1,m=2;for(t=0;t<this.divideX;t+=1){for(i=0;i<this.divideY;i+=1)s={left:c,right:c+a[t],top:m,bottom:m+h[i],sizeX:a[t],sizeY:h[i],id:this.realms.length,connectID:[]},this.realms.push(Object.assign({},s)),m+=h[i];m=2,c+=a[t]}}makeRoom(){let e,i,s,o,a,h,n,r,l,d,c,m;i=0,s=0,o=0,n=0,r=0,m=0;const p=(t,e,i,s,o)=>(t.roomLeft=e,t.roomTop=i,t.roomSizeX=s,t.roomSizeY=o,t.roomRight=e+s-1,t.roomBottom=i+o-1,t.visible=this.defaultVisible,t.know=!1,t);for(e=0;e<this.realms.length;e++){const g=this.realms[e];if(g.sizeX*g.sizeY<25)this.realms[e]=p(g,g.left+2,g.top+2,g.sizeX-4,g.sizeY-4);else{for(i=0,c=!0;c;){if(i+=1,i>100){n=g.sizeX-4,r=g.sizeY-4;break}l=g.sizeX-4,d=g.sizeY-4,n=t({max:l,min:5}),r=t({max:d,min:5}),m=n*r/(g.sizeX*g.sizeY),c=!0,n*r<25&&(c=!1),m<.4&&(c=!1)}a=g.sizeX-n-4,s=a>0?t({max:a,min:2}):2,h=g.sizeY-r-4,o=h>0?t({max:h,min:2}):2,this.realms[e]=p(g,g.left+s,g.top+o,n,r)}}}makePath(){let t,e,i;for(t=0;t<this.realms.length;t+=1)e=this.getAdjacentRealmIndices(t),i=Math.floor(Math.random()*e.length),this.addConnect(this.realms[t],this.realms[e[i]]);for(const t of this.connects)this.drawConnect(null,t,!1)}makePathObject(t,e){let i=this.pathPositions.find((i=>i.x===t&&i.y===e));i||(i={x:t,y:e,visible:this.defaultVisible,know:!1},this.pathPositions.push(i))}addConnect(e,i){let s,o,a,h,n,r;if(this.connects.some((t=>t.fromId===e.id&&t.toId===i.id||t.fromId===i.id&&t.toId===e.id)))return;const l={fromId:e.id,toId:i.id},d=e=>t({max:e.roomBottom-2,min:e.roomTop+2}),c=e=>t({max:e.roomRight-2,min:e.roomLeft+2});e.left===i.right&&(s=e.roomLeft-1,o=d(e),a=i.roomRight+1,h=d(i),r=e.roomLeft-e.left,n=3),i.left===e.right&&(s=e.roomRight+1,o=d(e),a=i.roomLeft-1,h=d(i),r=e.right-e.roomRight,n=1),e.top===i.bottom&&(s=c(e),o=e.roomTop-1,a=c(i),h=i.roomBottom+1,r=e.roomTop-e.top,n=0),i.top===e.bottom&&(s=c(e),o=e.roomBottom+1,a=c(i),h=i.roomTop-1,r=e.bottom-e.roomBottom,n=2),l.startX=s,l.startY=o,l.endX=a,l.endY=h,l.middle=r,l.direction=n,this.connects.push(Object.assign({},l)),e.connectID.push(i.id),i.connectID.push(e.id)}getAdjacentRealmIndices(t){const e=[],i=this.realms[t];for(let s=0;s<this.realms.length;s+=1)t!==s&&this.isAdjacent(i,this.realms[s])&&e.push(s);return e}isAdjacent(t,e){if(t.left===e.right||e.left===t.right){if(t.top<=e.bottom&&t.top>=e.top)return!0;if(t.bottom>=e.top&&t.bottom<=e.bottom)return!0}if(t.top===e.bottom||e.top===t.bottom){if(t.left>=e.left&&t.left<=e.right)return!0;if(t.right>=e.left&&t.right<=e.right)return!0}return!1}update(t){for(const t of this.realms)t.visible=this.defaultVisible;for(const t of this.pathPositions)t.visible=!1}draw(t){this.drawScaleLine(t);for(const e of this.realms)this.drawRoom(t.ctx,e);for(const e of this.connects)this.drawConnect(t.ctx,e)}drawScaleLine(t){t.ctx.strokeStyle="rgba(250, 250, 250, 0.25)",t.ctx.lineWidth=1;const i=e.canvasHeight,s=e.canvasWidth,o=Math.floor(i/e.pixel),a=Math.floor(s/e.pixel);let h;for(h=0;h<=o;h+=1)t.ctx.beginPath(),t.ctx.moveTo(0,e.pixel*h),t.ctx.lineTo(s,e.pixel*h),t.ctx.stroke(),t.ctx.closePath();for(h=0;h<=a;h+=1)t.ctx.beginPath(),t.ctx.moveTo(e.pixel*h,0),t.ctx.lineTo(e.pixel*h,i),t.ctx.stroke(),t.ctx.closePath();t.ctx.strokeStyle="rgba(250, 250, 250, 1)",t.ctx.strokeRect(s,i,a*e.pixel,o*e.pixel)}drawRoom(t,i){t.lineWidth=2,t.strokeStyle=i.visible?this.stageColor1:this.stageColor2,t.fillStyle=i.visible?this.stageColor1:this.stageColor2,t.strokeRect(i.roomLeft*e.pixel,i.roomTop*e.pixel,i.roomSizeX*e.pixel,i.roomSizeY*e.pixel),(i.visible||i.know)&&t.fillRect(i.roomLeft*e.pixel,i.roomTop*e.pixel,i.roomSizeX*e.pixel,i.roomSizeY*e.pixel)}drawConnect(t,e,i=!0){var s,o,a,h,n;for(a=e.startX,h=e.startY,o=e.direction,n=e.middle,s=0;s<n;s+=1)i?this.drawPath(t,a,h):this.makePathObject(a,h),0===o&&(h-=1),1===o&&(a+=1),2===o&&(h+=1),3===o&&(a-=1);for(o%2==0?(n=Math.abs(e.startX-e.endX),e.startX>e.endX&&(o=3),e.startX<e.endX&&(o=1)):(n=Math.abs(e.startY-e.endY)+1,e.startY>e.endY&&(o=0),e.startY<e.endY&&(o=2)),s=0;s<n;s+=1)i?this.drawPath(t,a,h):this.makePathObject(a,h),s!==n-1&&(0===o&&(h-=1),1===o&&(a+=1),2===o&&(h+=1),3===o&&(a-=1));for(n=(o=e.direction)%2==0?Math.abs(h-e.endY):Math.abs(a-e.endX),s=0;s<n;s+=1)0===o&&(h-=1),1===o&&(a+=1),2===o&&(h+=1),3===o&&(a-=1),i?this.drawPath(t,a,h):this.makePathObject(a,h)}drawPath(t,i,s){const o=this.pathPositions.find((t=>t.x===i&&t.y===s));(o.visible||o.know)&&(t.fillStyle=o.visible?this.stageColor1:this.stageColor2,t.fillRect(e.pixel*i,e.pixel*s,e.pixel,e.pixel))}hitWall(t,e,i=["u"]){return!this.isInnerRoom(t,e)&&!this.isInnerPath(t,e,i)}isInnerRoom(t,e,i=!1){for(const s of this.realms)if(s.roomLeft<=t&&t<=s.roomRight&&s.roomTop<=e&&e<=s.roomBottom){if(i){s.visible=!0,s.know=!0;for(const t of this.pathPositions)t.x>=s.roomLeft-1&&t.x<=s.roomRight+1&&t.y>=s.roomTop-1&&t.y<=s.roomBottom+1&&(t.visible=!0,t.know=!0)}return s}return null}isInnerPath(t,i,s,o=!1){const a=s.length>0?s[0]:null,h=[];if("u"===a)for(let s=1;s<=e.visibleRange;s++)h.push({x:t,y:i-s});if("d"===a)for(let s=1;s<=e.visibleRange;s++)h.push({x:t,y:i+s});if("u"!==a&&"d"!==a||(h.push({x:t+1,y:i}),h.push({x:t-1,y:i})),"l"===a)for(let s=1;s<=e.visibleRange;s++)h.push({x:t-s,y:i});if("r"===a)for(let s=1;s<=e.visibleRange;s++)h.push({x:t+s,y:i});"l"!==a&&"r"!==a||(h.push({x:t,y:i+1}),h.push({x:t,y:i-1}));let n=null;for(const e of this.pathPositions)e.x===t&&e.y===i&&(o&&(e.visible=!0,e.know=!0),n=e),o&&h.some((t=>t.x===e.x&&t.y===e.y))&&(e.visible=!0,e.know=!0);return n}}class a{constructor(t){this.camera=new BABYLON.FreeCamera("camera",new BABYLON.Vector3(t.player.x,.5,e.height-t.player.y),t.scene),this.camera.rotation.y=0,new BABYLON.SpotLight("spotLight_main",new BABYLON.Vector3(0,5,0),new BABYLON.Vector3(0,-2,0),Math.PI,10,t.scene),this.light=new BABYLON.SpotLight("spotLight",new BABYLON.Vector3(t.player.x,2,e.height-t.player.y),new BABYLON.Vector3(0,-2,2),Math.PI/3,80,t.scene),this.light.diffuse=new BABYLON.Color3(1,1,1),this.light.specular=new BABYLON.Color3(1,1,1);const i=new BABYLON.StandardMaterial("m_ehead",t.scene);i.emissiveColor=new BABYLON.Color3(.99,.706,.443);const s=new BABYLON.StandardMaterial("m_ebody",t.scene);s.emissiveColor=new BABYLON.Color3(100,0,0),this.enemies=[];let o,a,h=0;for(const n of t.enemies)o=BABYLON.Mesh.CreateSphere("head"+h,32,.7,t.scene),o.position.y=1,o.material=i,a=BABYLON.Mesh.CreateCylinder("body"+h,2,0,1,24,1,t.scene),a.position.y=0,a.material=s,this.enemies[h]=BABYLON.Mesh.MergeMeshes([o,a],!0,!0,void 0,!1,!0),this.enemies[h].position.x=n.x,this.enemies[h].position.z=e.height-n.y,h++;const n=BABYLON.Mesh.CreateSphere("bhead",32,.7,t.scene);n.position.y=1,n.material=i;const r=new BABYLON.StandardMaterial("m_bbody",t.scene);r.emissiveColor=new BABYLON.Color3(1,.3,.3);const l=BABYLON.Mesh.CreateCylinder("bbody",2,0,1,24,1,t.scene);l.position.y=0,l.material=r,this.brother=BABYLON.Mesh.MergeMeshes([n,l],!0,!0,void 0,!1,!0),this.brother.position.x=t.brother.x,this.brother.position.z=e.height-t.brother.y}drawMap(t,i){let s,o,a;const h=new BABYLON.StandardMaterial("g-material",t.scene);h.diffuseTexture=new BABYLON.Texture("./assets/images/floor.png.jpg",t.scene),h.diffuseTexture.uScale=e.canvasWidth,h.diffuseTexture.vScale=e.canvasHeight,h.specularColor=new BABYLON.Color3(.2,.2,.2);let n,r;BABYLON.Mesh.CreateGround("ground",e.canvasWidth,e.canvasHeight,0,t.scene,!1).material=h;let l=!0;for(n=0;n<e.width;n++)for(r=0;r<e.height;r++)s=BABYLON.Mesh.CreateBox(`wall-${n}-${r}`,1,t.scene),s.position.x=n,s.position.z=r,s.material=h,o=BABYLON.Mesh.CreateBox(`wall-${n}-${r}-1`,1,t.scene),o.position.x=n,o.position.z=r,o.position.y=1,o.material=h,a=BABYLON.Mesh.CreateBox(`wall-${n}-${r}-2`,1,t.scene),a.position.x=n,a.position.z=r,a.position.y=2,s.material=h,l=!l;for(const h of i.realms)for(n=h.roomLeft;n<=h.roomRight;n++)for(r=h.roomTop;r<=h.roomBottom;r++)s=t.scene.getMeshByName(`wall-${n}-${e.height-r}`),s&&s.dispose(),o=t.scene.getMeshByName(`wall-${n}-${e.height-r}-1`),o&&o.dispose(),a=t.scene.getMeshByName(`wall-${n}-${e.height-r}-2`),a&&a.dispose();for({x:n,y:r}of i.pathPositions)s=t.scene.getMeshByName(`wall-${n}-${e.height-r}`),s&&s.dispose(),o=t.scene.getMeshByName(`wall-${n}-${e.height-r}-1`),o&&o.dispose()}update(t){"u"===t.player.angle?(this.camera.rotation.y=0,this.light.direction.z=2,this.light.direction.x=0):"r"===t.player.angle?(this.camera.rotation.y=Math.PI/2,this.light.direction.z=0,this.light.direction.x=2):"d"===t.player.angle?(this.camera.rotation.y=Math.PI,this.light.direction.z=-2,this.light.direction.x=0):"l"===t.player.angle&&(this.camera.rotation.y=Math.PI+Math.PI/2,this.light.direction.z=0,this.light.direction.x=-2),this.camera.position.x=t.player.x,this.camera.position.z=e.height-t.player.y,this.light.position.x=t.player.x,this.light.position.z=e.height-t.player.y;for(const i in this.enemies)this.enemies[i].position.x=t.enemies[i].x,this.enemies[i].position.z=e.height-t.enemies[i].y;this.brother.position.x=t.brother.x,this.brother.position.z=e.height-t.brother.y}draw(t){}}class h{constructor(){this.loadCount=0,this.gamemode=e.gamemode.title,this.keyboard=[],this.canvasEl=void 0,this.ctx=void 0,this.displayCtx=void 0,this.stage=void 0,this.initialized=!1,this.prevTime=performance.now();const t=document.querySelector(e.appElementID),i=document.querySelector(e.wrapperElementID);this._createCanvasEl(t,i,e.canvasWidth,e.canvasHeight),this.setKeyEvent(),this.initializeGame()}initializeGame(){this.stage=new o;const h=()=>{const e=this.stage.realms[t({max:this.stage.realms.length-1,min:0})];return[t({max:e.roomRight,min:e.roomLeft}),t({max:e.roomBottom,min:e.roomTop})]},[n,r]=h();this.player=new i({x:n,y:r,height:e.pixel,width:e.pixel});const l=t({max:10,min:3});let d,c;this.enemies=[];for(let t=0;t<l;t++)[d,c]=h(),this.enemies.push(new s({x:d,y:c,height:e.pixel,width:e.pixel}));const[m,p]=h();this.brother=new s({x:m,y:p,height:e.pixel,width:e.pixel}),this.stage.isInnerRoom(n,r,!0),this.stage.isInnerPath(n,r,["u"],!0);const g=document.querySelector(e.wrapperElementID);this.canvas3DEl&&g.removeChild(this.canvas3DEl),this.canvas3DEl=document.createElement("canvas"),[this.canvas3DEl.style.width,this.canvas3DEl.style.height]=[e.canvasWidth,e.canvasHeight],this.canvas3DEl.style.zIndex=0,g.appendChild(this.canvas3DEl),this.engine=new BABYLON.Engine(this.canvas3DEl),this.scene=new BABYLON.Scene(this.engine),this.scene.clearColor=new BABYLON.Color3(.659,.863,.925),this.threeDrawer=new a(this),this.threeDrawer.drawMap(this,this.stage),this.initialized=!0,this._draw()}setKeyEvent(){this.addKeyupEventListener(document,"keyup")}addKeyupEventListener(t,i,s=void 0){const o=t=>{const i=document.querySelector(e.wrapperElementID);if(this.textEl&&(i.removeChild(this.textEl),this.textEl=void 0),this.gamemode.text)return this.gamemode=e.gamemode.playing,void(this.initialized||this.initializeGame());this.keyboard=[this._adjustKeyCode(t.code)],this._draw()};s?t.addEventListener(i,(()=>o(s))):t.addEventListener(i,o)}run(){this._draw()}_adjustKeyCode(t){const e={l:["ArrowLeft"],r:["ArrowRight"],u:["ArrowUp"],d:["ArrowDown"]};for(const[i,s]of Object.entries(e))if(s.includes(t))return i;return t}_createCanvasEl(t,i,s,o){const[a,h]=[s,o];let n=a;[t.style.width,t.style.height]=[`${n}px`,`${h}px`],this.canvasEl=document.createElement("canvas"),[this.canvasEl.width,this.canvasEl.height]=[a,h],this.ctx=this.canvasEl.getContext("2d");const r=document.createElement("canvas");[r.style.width,r.style.height]=[`${e.viewWidth}px`,`${e.viewHeight}px`],[r.width,r.height]=[a,h],r.style.zIndex=1,this.displayCtx=r.getContext("2d"),i.appendChild(r),this.canvas3DEl=document.createElement("canvas"),this.canvas3DEl.id="3dcanvas",[this.canvas3DEl.style.width,this.canvas3DEl.style.height]=[a,h],this.canvas3DEl.style.zIndex=0,i.appendChild(this.canvas3DEl)}_draw(){let t="";this.gamemode.val===e.gamemode.title.val&&(t=[{text:"Run away from pied piper of Hamelin",size:16},{text:"",size:10},{text:"Rule: ",size:10},{text:"  You should find brother(Pink).",size:10},{text:"  If you are found by pied piper of hamelin(Red)...",size:10},{text:"Control: ",size:10},{text:"  Right/Left key: Change Direction",size:10},{text:"  Up Key: forward, Down Key: Back",size:10},{text:"",size:10},{text:"Press any key, You can start the game.",size:10}]),this.gamemode.val===e.gamemode.gameclear.val&&(t=[{text:"Congratulations!!!",size:24},{text:"",size:10},{text:"You could help your brother and run away!!",size:10},{text:"",size:10},{text:"Press any key, You can restart the game.",size:10}]),this.gamemode.val===e.gamemode.gameover.val&&(t=[{text:"Game over!!!",size:24},{text:"",size:10},{text:"You could not run away!!",size:10},{text:"",size:10},{text:"Press any key, You can restart the game.",size:10}]),this.gamemode.text?this.drawText(t):(this.update(),this.drawMap(),this.scene.render())}update(){this.stage.update(this),this.player.update(this);for(const t of this.enemies)t.update(this);this.brother.update(this),this.threeDrawer.update(this),this.enemies.some((t=>t.x===this.player.x&&t.y===this.player.y))&&(this.gamemode=e.gamemode.gameover,this.initialized=!1,this._draw()),this.brother.x===this.player.x&&this.brother.y===this.player.y&&(this.gamemode=e.gamemode.gameclear,this.initialized=!1,this._draw())}drawText(t){if(this.textEl)return;const i=document.querySelector(e.wrapperElementID);this.textEl=document.createElement("canvas"),[this.textEl.style.width,this.textEl.style.height]=[e.canvasWidth,e.canvasHeight],this.textEl.style.zIndex=9,i.appendChild(this.textEl);const s=this.textEl.getContext("2d");let o=30;for(const e of t)s.font=`${e.size}px serif`,s.fillStyle="rgba(200, 200, 200)",s.fillText(e.text,10,o),o+=e.size+1}drawMap(){this.ctx.save(),this.ctx.fillStyle="#205030",this.ctx.fillRect(0,0,e.canvasWidth,e.canvasHeight),this.stage.draw(this),this.brother.draw(this);for(const t of this.enemies)t.draw(this);this.player.draw(this),this.ctx.restore(),this.displayCtx.drawImage(this.canvasEl,0,0)}}class n extends h{constructor(t,i){const s=document.querySelector(e.appElementID),o=document.createElement("button");[o.style.width,o.style.height]=["50px",`${i}px`],o.innerText="<<<",o.id="leftbtn",s.appendChild(o);const a=document.createElement("button");[a.style.width,a.style.height]=["50px",`${i}px`],a.innerText=">>>",a.id="rightbtn",s.appendChild(a);const h=document.createElement("button");[h.style.width,h.style.height]=["50px",`${i}px`],h.innerText="UP",h.id="upbtn",s.appendChild(h);const n=document.createElement("button");[n.style.width,n.style.height]=["50px",`${i}px`],n.innerText="DOWN",n.id="downbtn",s.appendChild(n),super(t,i)}setKeyEvent(){const t=document.querySelector("#leftbtn"),e=document.querySelector("#rightbtn"),i=document.querySelector("#upbtn"),s=document.querySelector("#downbtn");["mousedown","touchstart"].forEach((o=>{this.addKeydownEventListener(t,o,{code:"l"}),this.addKeydownEventListener(e,o,{code:"r"}),this.addKeydownEventListener(i,o,{code:"u"}),this.addKeydownEventListener(s,o,{code:"d"})}))}}const r=[],l=()=>{let t;t=navigator.userAgent.match(/iPhone|Android.+Mobile/)?new n:new h,t.run()},d=navigator.userAgent.toLowerCase(),c=d.indexOf("iphone")>-1,m=d.indexOf("ipad")>-1,p=d.indexOf("android")>-1&&d.indexOf("mobile")>-1,g=d.indexOf("android")>-1&&-1==d.indexOf("mobile");(c||m)&&(window.onorientationchange=u),(p||g)&&(window.onresize=u);const x=u();function u(){return 90==Math.abs(window.orientation)?"横向き":"縦向き"}if((c||m||p||g)&&"縦向き"===x)document.getElementById("app").innerHTML="横向きにしてください";else{let t=0;0===r.length&&l();for(var y=0;y<r.length;++y)r[y].onload=function(){++t,t==r.length&&l()}}})();