(()=>{var i=(i,r)=>{var e=0;return r.map(r=>{i[e++]=r.x,i[e++]=r.y,i[e++]=r.z}),i},r=(i=0,r=0,e=0)=>({x:i,y:r,z:e}),e=(i,r,e,t)=>(i.x=r,i.y=e,i.z=t,i),t=(i,r)=>(i.x=r,i.y=r,i.z=r,i),a=i=>r(i.x,i.y,i.z),o=(i,r)=>(i.x+=r.x,i.y+=r.y,i.z+=r.z,i),n=(i,r,e)=>(i.x+=r.x*e,i.y+=r.y*e,i.z+=r.z*e,i),s=(i,r)=>(i.x-=r.x,i.y-=r.y,i.z-=r.z,i),v=(i,r,e)=>(i.x=r.x-e.x,i.y=r.y-e.y,i.z=r.z-e.z,i),c=(i,r)=>(i.x*=r.x,i.y*=r.y,i.z*=r.z,i),m=(i,r)=>(i.x*=r,i.y*=r,i.z*=r,i),y=(i,r)=>{var{x:e,y:t,z:a}=i,o=1/(r[3]*e+r[7]*t+r[11]*a+r[15]);return i.x=(r[0]*e+r[4]*t+r[8]*a+r[12])*o,i.y=(r[1]*e+r[5]*t+r[9]*a+r[13])*o,i.z=(r[2]*e+r[6]*t+r[10]*a+r[14])*o,i},p=(i,r)=>{var{x:e,y:t,z:a}=i,o=r.x,n=r.y,s=r.z,v=r.w,c=v*e+n*a-s*t,m=v*t+s*e-o*a,y=v*a+o*t-n*e,p=-o*e-n*t-s*a;return i.x=c*v+p*-o+m*-s-y*-n,i.y=m*v+p*-n+y*-o-c*-s,i.z=y*v+p*-s+c*-n-m*-o,i},l=(i,r)=>{var{x:e,y:t,z:a}=i;return i.x=r[0]*e+r[4]*t+r[8]*a,i.y=r[1]*e+r[5]*t+r[9]*a,i.z=r[2]*e+r[6]*t+r[10]*a,h(i)},d=(i,r)=>m(i,1/r),x=(i,r)=>i.x*r.x+i.y*r.y+i.z*r.z,f=i=>Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z),h=i=>d(i,f(i)||1),g=(i,r)=>m(h(i),r),b=(i,r,e)=>{var t=r.x,a=r.y,o=r.z,n=e.x,s=e.y,v=e.z;return i.x=a*v-o*s,i.y=o*n-t*v,i.z=t*s-a*n,i},z=(i,r)=>Math.sqrt(w(i,r)),w=(i,r)=>{var e=i.x-r.x,t=i.y-r.y,a=i.z-r.z;return e*e+t*t+a*a},M=(i,r)=>(i.x=r[12],i.y=r[13],i.z=r[14],i),j=(i,r)=>i.x===r.x&&i.y===r.y&&i.z===r.z,O=r(0,1,0),C=r(0,0,1),P=1.001,k=(i,r,e)=>{var t=x(i,r);t<0?t*=e:t/=e,n(i,r,-t)},A=r(),L=r(),W=r(),S=()=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),F=(i,r,e,t)=>(v(W,r,e),f(W)||(W.z=1),h(W),b(A,t,W),f(A)||(1===Math.abs(t.z)?W.x+=1e-4:W.z+=1e-4,h(W),b(A,t,W)),h(A),b(L,W,A),i[0]=A.x,i[4]=L.x,i[8]=W.x,i[1]=A.y,i[5]=L.y,i[9]=W.y,i[2]=A.z,i[6]=L.z,i[10]=W.z,i),R=(i,r,e)=>{var[t,a,o,n,s,v,c,m,y,p,l,d,x,f,h,u]=r,[g,b,z,w,M,j,O,C,P,k,A,L,W,S,F,R]=e;return i.set([t*g+s*b+y*z+x*w,a*g+v*b+p*z+f*w,o*g+c*b+l*z+h*w,n*g+m*b+d*z+u*w,t*M+s*j+y*O+x*C,a*M+v*j+p*O+f*C,o*M+c*j+l*O+h*C,n*M+m*j+d*O+u*C,t*P+s*k+y*A+x*L,a*P+v*k+p*A+f*L,o*P+c*k+l*A+h*L,n*P+m*k+d*A+u*L,t*W+s*S+y*F+x*R,a*W+v*S+p*F+f*R,o*W+c*S+l*F+h*R,n*W+m*S+d*F+u*R]),i},q=(i,r)=>{var e,[t,a,o,n,s,v,c,m,y,p,l,d,x,f,h,u]=r,g=p*h*m-f*l*m+f*c*d-v*h*d-p*c*u+v*l*u,b=x*l*m-y*h*m-x*c*d+s*h*d+y*c*u-s*l*u,z=y*f*m-x*p*m+x*v*d-s*f*d-y*v*u+s*p*u,w=x*p*c-y*f*c-x*v*l+s*f*l+y*v*h-s*p*h,M=t*g+a*b+o*z+n*w;if(0===M)return(e=i).set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e;var j=1/M;return i.set([g*j,(f*l*n-p*h*n-f*o*d+a*h*d+p*o*u-a*l*u)*j,(v*h*n-f*c*n+f*o*m-a*h*m-v*o*u+a*c*u)*j,(p*c*n-v*l*n-p*o*m+a*l*m+v*o*d-a*c*d)*j,b*j,(y*h*n-x*l*n+x*o*d-t*h*d-y*o*u+t*l*u)*j,(x*c*n-s*h*n-x*o*m+t*h*m+s*o*u-t*c*u)*j,(s*l*n-y*c*n+y*o*m-t*l*m-s*o*d+t*c*d)*j,z*j,(x*p*n-y*f*n-x*a*d+t*f*d+y*a*u-t*p*u)*j,(s*f*n-x*v*n+x*a*m-t*f*m-s*a*u+t*v*u)*j,(y*v*n-s*p*n-y*a*m+t*p*m+s*a*d-t*v*d)*j,w*j,(y*f*o-x*p*o+x*a*l-t*f*l-y*a*h+t*p*h)*j,(x*v*o-s*f*o-x*a*c+t*f*c+s*a*h-t*v*h)*j,(s*p*o-y*v*o+y*a*c-t*p*c-s*a*l+t*v*l)*j]),i},E=(i,r)=>i+Math.random()*(r-i),I=i=>i*(.5-Math.random()),D=(i=0,r=0,e=0,t=1)=>({x:i,y:r,z:e,w:t}),V=(i,r)=>(i.x=r.x,i.y=r.y,i.z=r.z,i.w=r.w,i),_=(i,r,e)=>{var t=e/2,a=Math.sin(t);return i.x=r.x*a,i.y=r.y*a,i.z=r.z*a,i.w=Math.cos(t),i},B=(i,r)=>{var e,t=r[0],a=r[4],o=r[8],n=r[1],s=r[5],v=r[9],c=r[2],m=r[6],y=r[10],p=t+s+y;return p>0?(e=.5/Math.sqrt(p+1),i.w=.25/e,i.x=(m-v)*e,i.y=(o-c)*e,i.z=(n-a)*e):t>s&&t>y?(e=2*Math.sqrt(1+t-s-y),i.w=(m-v)/e,i.x=.25*e,i.y=(a+n)/e,i.z=(o+c)/e):s>y?(e=2*Math.sqrt(1+s-t-y),i.w=(o-c)/e,i.x=(a+n)/e,i.y=.25*e,i.z=(v+m)/e):(e=2*Math.sqrt(1+y-t-s),i.w=(n-a)/e,i.x=(o+c)/e,i.y=(v+m)/e,i.z=.25*e),i},N=(i,r,e)=>{var t=((i,r)=>{return 2*Math.acos(Math.abs((e=T(i,r),Math.min(Math.max(e,-1),1))));var e})(i,r);if(!t)return i;var a=Math.min(1,e/t);return U(i,r,a),i},T=(i,r)=>i.x*r.x+i.y*r.y+i.z*r.z+i.w*r.w,U=(i,r,e)=>{if(0===e)return i;if(1===e)return V(i,r);var{x:t,y:a,z:o,w:n}=i,s=n*r.w+t*r.x+a*r.y+o*r.z;if(s<0?(i.w=-r.w,i.x=-r.x,i.y=-r.y,i.z=-r.z,s=-s):V(i,r),s>=1)return i.w=n,i.x=t,i.y=a,i.z=o,i;var v,c,m=1-s*s;if(m<=Number.EPSILON){var y=1-e;return i.w=y*n+e*i.w,i.x=y*t+e*i.x,i.y=y*a+e*i.y,i.z=y*o+e*i.z,(c=(i=>Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z+i.w*i.w))(v=i))?(c=1/c,v.x=v.x*c,v.y=v.y*c,v.z=v.z*c,v.w=v.w*c):(v.x=0,v.y=0,v.z=0,v.w=1),v}var p=Math.sqrt(m),l=Math.atan2(p,s),d=Math.sin((1-e)*l)/p,x=Math.sin(e*l)/p;return i.w=n*d+i.w*x,i.x=t*d+i.x*x,i.y=a*d+i.y*x,i.z=o*d+i.z*x,i},H=D(),K=S(),G=()=>({parent:void 0,children:[],components:[],position:r(),quaternion:D(),scale:r(1,1,1),matrix:S(),matrixWorld:S(),mVM:S(),visible:!0}),J=(i,r)=>{F(K,r,i.position,O),B(i.quaternion,K)},$=(i,r)=>(r.parent=i,i.children.push(r),i),Q=(i,r)=>{var e=i.children.indexOf(r);e>=0&&i.children.splice(e,1)},X=(i,r)=>((i,r,e)=>{var t,a,o,n,s,v,c,m,y,p;return _(H,r,e),t=i.quaternion,a=H,o=t.x,n=t.y,s=t.z,v=t.w,c=a.x,m=a.y,y=a.z,p=a.w,t.x=o*p+v*c+n*y-s*m,t.y=n*p+v*m+s*c-o*y,t.z=s*p+v*y+o*m-n*c,t.w=v*p-o*c-n*m-s*y,i})(i,O,r),Y=(i,r)=>{r(i),i.children.map(i=>Y(i,r))},Z=i=>{var r,e;(i=>{((i,r,e,t)=>{var{x:a,y:o,z:n,w:s}=e,v=a+a,c=o+o,m=n+n,y=a*v,p=a*c,l=a*m,d=o*c,x=o*m,f=n*m,h=s*v,u=s*c,g=s*m,b=t.x,z=t.y,w=t.z;i.set([(1-(d+f))*b,(p+g)*b,(l-u)*b,0,(p-g)*z,(1-(y+f))*z,(x+h)*z,0,(l+u)*w,(x-h)*w,(1-(y+d))*w,0,r.x,r.y,r.z,1])})(i.matrix,i.position,i.quaternion,i.scale)})(i),i.parent?R(i.matrixWorld,i.parent.matrixWorld,i.matrix):(r=i.matrixWorld,e=i.matrix,r.set(e)),i.children.map(Z)},ii=Math.PI/180,ri=S(),ei=i=>{var{near:r,far:e}=i,t=r*Math.tan(.5*ii*i.fov),a=-t,o=a*i.aspect,n=t*i.aspect,s=2*r/(n-o),v=2*r/(t-a),c=(n+o)/(n-o),m=(t+a)/(t-a),y=-(e+r)/(e-r),p=-2*e*r/(e-r);i.projectionMatrix.set([s,0,0,0,0,v,0,0,c,m,y,-1,0,0,p,0])},ti=r(.1,.1,.2),ai=r(1.5,2,2),oi=r(0,2,2),ni=r(2,.6,.3),si=r(2,2,0),vi=(i,r)=>({parent:void 0,update:i,...r}),ci=(i,r)=>(r.parent=i,i.components.push(r),i),mi=(i,...r)=>{i.components.map(i=>i.update(i,...r))},yi=(...i)=>i.reduceRight((i,r)=>(...e)=>i(r(...e)),i=>i),pi=i=>(...r)=>e=>i(e,...r),li=i=>i[Math.random()*i.length|0],di=new(window.AudioContext||webkitAudioContext),{sampleRate:xi}=di,fi=i=>2**((i-69)/12)*440,hi=(i,r=di.destination)=>{var e=di.createBufferSource();e.buffer=i,e.connect(r),e.start()},ui=(i,r,e)=>new Proxy({},{get(t,a){var o=t[a]||((i,r,e)=>{for(var t=r*xi,a=di.createBuffer(1,t,xi),o=a.getChannelData(0),n=0;n<t;n++)o[n]=i(n/xi,n,o)*e;return a})(i(fi(a)),r,e);return t[a]=o,o}}),gi=i=>r=>Math.sin(2*r*Math.PI*i),bi=i=>()=>r=>Math.exp(-r*i),zi=()=>{var i=0;return()=>{var r=I(1),e=(i+.02*r)/1.02;return i=e,3.5*e}},wi=(i,r)=>e=>{var t=i(e),a=r(e);return(i,r,e)=>t(i,r,e)+a(i,r,e)},Mi=(i,r)=>e=>{var t=i(e),a=r(e);return(i,r,e)=>t(i,r,e)*a(i,r,e)},ji=(i,r)=>e=>{var t=i(e);return(i,e,a)=>r*t(i,e,a)},Oi=(i,r)=>e=>(t,a,o)=>i(e+a/o.length*r)(t,a,o),Ci=(i,r,e)=>t=>(a,o,n)=>i(t+(a>e?r:0))(a,o,n),Pi=(i,r,e,t,a)=>{var o=i+r+e+t;return()=>e=>e<i?e/i:e<i+r?1-(e-i)/r*(1-a):e<o-t?a:e<o?(o-e)/t*a:0};addEventListener("click",()=>di.resume(),{once:!0});var ki,Ai,Li,Wi,Si,Fi,Ri,qi,Ei,Ii,Di,Vi,_i,Bi,Ni,Ti=i=>({a:i.a,b:i.b,c:i.c,color:a(i.color),vertexColors:i.vertexColors.map(a)}),Ui=r(),Hi=(i,r,t,a)=>(e(Ui,r,t,a),i.vertices.map(i=>o(i,Ui)),i),Ki=pi(Hi),Gi=pi((i,r,t,a)=>(e(Ui,r,t,a),i.vertices.map(i=>c(i,Ui)),i)),Ji=pi((i,r)=>{var e=i.vertices.length;return i.vertices.push(...r.vertices.map(a)),i.faces.push(...r.faces.map(i=>{var r=Ti(i);return r.a+=e,r.b+=e,r.c+=e,r})),i}),$i=pi(i=>{var r={vertices:[],faces:[]};return r.vertices=i.vertices.map(a),r.faces=i.faces.map(Ti),r}),Qi=r(),Xi=r(),Yi=r(),Zi=(i,r,a)=>{Array.isArray(r)?e(i,...r):"object"==typeof r?Object.assign(i,a,r):"number"==typeof r&&t(i,r)},ir=(i,r,e)=>(t(e,0),r.map(r=>o(e,i.vertices[r])),d(e,r.length),e),rr=pi((i,r)=>(ir(i,r,Qi),Hi(i,-Qi.x,-Qi.y,-Qi.z))),er=pi((i,r,e,t)=>(ir(i,r,Xi),ir(e,t,Yi),v(Qi,Xi,Yi),Hi(i,-Qi.x,-Qi.y,-Qi.z))),tr=(i,e=r())=>(r,...t)=>(t.map(([t,a])=>{Zi(Qi,a,e),t.map(e=>i(r.vertices[e],Qi))}),r),ar=pi(tr(o)),or=pi(tr(c,r(1,1,1))),nr=pi(((i,e=r())=>r=>(t,...a)=>(a.map(([a,o=e[r]])=>{Object.assign(Qi,e),Qi[r]=o,a.map(r=>i(t.vertices[r],Qi))}),t))(o)("y")),sr=pi((i,...e)=>(e.map(([e,t])=>{var a=r();Zi(a,t),i.faces.map(i=>e.map(r=>((i,r,e)=>{i.a===r&&(i.vertexColors[0]=e),i.b===r&&(i.vertexColors[1]=e),i.c===r&&(i.vertexColors[2]=e)})(i,r,a)))}),i)),vr=[2],cr=[3],mr=[6],yr=[7],pr=[0,1],lr=[2,3],dr=[4,5],xr=[6,7],fr=[0,2],hr=[1,3],ur=[4,6],gr=[5,7],br=[0,5],zr=[1,4],wr=[2,7],Mr=[3,6],jr=[0,1,4,5],Or=[2,3,6,7],Cr=[0,2,5,7],Pr=[1,3,4,6],kr=[0,1,2,3,4,5,6,7],Ar=i=>{var r=0,e=i,t=t=>{if((e+=t)-r>i)return!0};return t.reset=()=>r=e,t},Lr=()=>({color:r(1,1,1),specular:r(1/15,1/15,1/15),shininess:30,emissive:r()}),Wr=(i,r)=>({...G(),geometry:i,material:r}),Sr=(i,e,t)=>{var a=i/2,o=e/2,n=t/2;return((i,e,t)=>{var a,o=i.vertices.length;for(a=0;a<e.length;a+=3)i.vertices.push(r(e[a],e[a+1],e[a+2]));for(a=0;a<t.length;a+=3)i.faces.push({a:o+t[a],b:o+t[a+1],c:o+t[a+2],color:r(1,1,1),vertexColors:[]});return i})({vertices:[],faces:[]},[a,o,n,a,o,-n,a,-o,n,a,-o,-n,-a,o,-n,-a,o,n,-a,-o,-n,-a,-o,n],[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4])},Fr=r(),Rr=(i,...r)=>yi(...r)(Sr(...i)),qr=(...i)=>yi(...i.map(Ji))({vertices:[],faces:[]}),Er=(i,r,e)=>{var t=(r-i)/(e+1);return[...Array(e)].map((r,e)=>i+t*(e+1))},Ir=Sr(4,4,12),Dr=i=>ar([ur,{x:i/2}],[hr,{z:i/2}],[fr,{x:-i/2}],[gr,{z:-i/2}]),Vr=Rr([2,2,3]),_r=[[2,2,2],[4,1,0],[4,1,1]].map(i=>{var r=Lr();return e(r.color,...i),e(r.emissive,...i),r}),Br=r(0,-800,0),Nr=i=>{var r=24,e={x:.8},t=Rr([r,6,r],rr(Or),or([Or,[20/r,1,20/r]],[Pr,e])),a=Rr([r,26,r],or([Pr,e]),er(Or,t,jr),nr([zr,-6])),o=Rr([r,26,.5],sr([kr,[.1,.2,.2]]),Gi(.8,.8,1),er(Pr,a,Cr)),n=Rr([3,i?12:8,.5],sr([kr,i?[256,1,1]:[1,256,2]]),er(Pr,o,Cr));return qr(t,a,o,yi($i(),Ki(-4,2,0),...i?[nr([pr,-4],[xr,4])]:[])(n),yi($i(),Ki(4,2,0),...i?[nr([dr,-4],[lr,4])]:[])(n))},Tr=Nr(),Ur=Nr(!0),Hr=i=>{var r=i?Ur:Tr,e=Lr();return t(e.color,1.5),i&&(e.color.x=3),e.shininess=0,Wr(r,e)},Kr={},Gr=i=>{if(Kr[i])return Kr[i];var r=1.5,e=3,t=.8,a=5,o=qr(...i.split("").flatMap((o,n)=>{var s={C:[[1,4],[3,1],[3,1,0,4]],H:[[1,5],[1,1,1,2],[1,5,2]],J:[[1,5,2],[2,1,0,4]],L:[[1,5],[2,1,1,4]],M:[[1,5],[1,2,1],[1,5,2]],S:[[3,1],[1,1,0,1],[3,1,0,2],[1,1,2,3],[3,1,0,4]],T:[[3,1],[1,4,1,1]]}[o];return s?.map(([o,s,v=0,c=0])=>Rr([o,s,1],rr(dr),Ki(v+e*(n-i.length/2)+t*(n-1),a-c,0),Gi(r,r,1)))}).filter(Boolean));return Kr[i]=o,o},Jr=i=>{var r=Rr(i?[24,32,1]:[1,32,24],sr([kr,ti]));return qr(r,Rr(i?[24,2,2]:[2,2,24],i?er(zr,r,Mr):er(dr,r,xr),sr([kr,1.5])))},$r=r(),Qr=(i=r(1/0,1/0,1/0),e=r(-1/0,-1/0,-1/0))=>({min:i,max:e}),Xr=(i,r)=>(Object.assign(i.min,r.min),Object.assign(i.max,r.max),i),Yr=(i,r)=>{var e,t;return t=r,(e=i.min).x=Math.min(e.x,t.x),e.y=Math.min(e.y,t.y),e.z=Math.min(e.z,t.z),((i,r)=>{i.x=Math.max(i.x,r.x),i.y=Math.max(i.y,r.y),i.z=Math.max(i.z,r.z)})(i.max,r),i},Zr=(i,r)=>((i=>{i.min.x=i.min.y=i.min.z=1/0,i.max.x=i.max.y=i.max.z-=1/0})(i),((i,r)=>{Z(r),Y(r,r=>r.geometry?.vertices.map(e=>{Object.assign($r,e);y($r,r.matrixWorld);Yr(i,$r)}))})(i,r),i),ie=(i,r)=>i.min.x<=r.x&&r.x<=i.max.x&&i.min.y<=r.y&&r.y<=i.max.y&&i.min.z<=r.z&&r.z<=i.max.z,re=(i,r)=>!(i.max.x<=r.min.x||i.min.x>=r.max.x||i.max.y<=r.min.y||i.min.y>=r.max.y||i.max.z<=r.min.z||i.min.z>=r.max.z),ee=(i,r)=>(o(i.min,r),o(i.max,r),i),te=(i,e)=>ci(i,((i,e)=>vi((i,r)=>{n(i.parent.position,i.velocity,r)},{physics:e,boundingBox:Zr(Qr(),i),velocity:r(),collide(){}}))(i,e)),ae=i=>((i,r)=>i.components.find(r))(i,oe),oe=i=>i.physics,ne=i=>{var r=[];return Y(i,i=>{var e,t;r.push(...(e=i,t=oe,e.components.filter(t)))}),r},se=(ki=r(),(i,r,t,a)=>{var v=a.max.x-t.min.x,c=t.max.x-a.min.x,y=a.max.y-t.min.y,p=t.max.y-a.min.y,l=a.max.z-t.min.z,d=t.max.z-a.min.z,x=0;v>0&&c>0&&(x=v<c?v:-c);var u=0;y>0&&p>0&&(u=y<p?y:-p);var b=0;l>0&&d>0&&(b=l<d?l:-d);var z=Math.abs(x),w=Math.abs(u),M=Math.abs(b);z<w&&z<M?e(ki,x,0,0):w<M?e(ki,0,u,0):e(ki,0,0,b);var j=i.parent,O=r.parent;1===i.physics?(n(O.position,ki,-1.001),k(r.velocity,h(ki),P)):1===r.physics?(n(j.position,ki,P),k(i.velocity,h(ki),P)):(m(ki,.5),f(ki)<P&&g(ki,P),o(j.position,ki),s(O.position,ki))}),ve=(Ai=r(),Li=r(),(i,r,a,o,n)=>{if(re(o,n))return i.allsolid=!0,void(i.fraction=0);t(Ai,1/0),v(Li,a.velocity,r.velocity);var s=Li.x,c=Li.y,m=Li.z,y=n.max.x-o.min.x,p=o.max.x-n.min.x,l=n.max.y-o.min.y,d=o.max.y-n.min.y,x=n.max.z-o.min.z,f=o.max.z-n.min.z,h=0,u=1/0;if(s<0){if(y<0)return;y>0&&(u=Math.min(-y/s,u)),p<0&&(Ai.x=p/s,h=Math.max(Ai.x,h))}else if(s>0){if(p<0)return;p>0&&(u=Math.min(p/s,u)),y<0&&(Ai.x=-y/s,h=Math.max(Ai.x,h))}if(!(h>u)){if(c<0){if(l<0)return;l>0&&(u=Math.min(-l/c,u)),d<0&&(Ai.y=d/c,h=Math.max(Ai.y,h))}else if(c>0){if(d<0)return;d>0&&(u=Math.min(d/c,u)),l<0&&(Ai.y=-l/c,h=Math.max(Ai.y,h))}if(!(h>u)){if(m<0){if(x<0)return;x>0&&(u=Math.min(-x/m,u)),f<0&&(Ai.z=f/m,h=Math.max(Ai.z,h))}else if(m>0){if(f<0)return;f>0&&(u=Math.min(f/m,u)),x<0&&(Ai.z=-x/m,h=Math.max(Ai.z,h))}h>u||(i.fraction=h,Ai.x<Ai.y&&Ai.x<Ai.z?e(i.normal,Math.sign(s),0,0):Ai.y<Ai.z?e(i.normal,0,Math.sign(c),0):e(i.normal,0,0,Math.sign(m)))}}}),ce=(i,r)=>ee(Xr(i,r.boundingBox),r.parent.position),me=(()=>{var i=Qr(),r=Qr(),e=Qr();return t=>{for(var a=0;a<t.length;a++)for(var o=t[a],n=a+1;n<t.length;n++){var s,v,c=t[n];if((1!==o.physics||1!==c.physics)&&(4!==o.physics||4!==c.physics)&&(4!==o.physics&&4!==c.physics||(4===o.physics?(s=o,v=c):(s=c,v=o),ce(i,v),!ie(i,s.parent.position)||!1!==s.collide(v.parent)))&&(ce(r,o),ce(e,c),re(r,e))){if(!1===o.collide(c.parent)||!1===c.collide(o.parent))continue;se(o,c,r,e)}}}})(),ye=a(O),pe=()=>({allsolid:!1,fraction:1,endpos:r(),normal:r()}),le=(i,r)=>(i.allsolid=r.allsolid,i.fraction=r.fraction,Object.assign(i.endpos,r.endpos),Object.assign(i.normal,r.normal),i),de=(Wi=pe(),i=>(le(i,Wi),i)),xe=(()=>{var i=Qr(),e=Qr(),t=Qr(),a=r(),n=r(),s=pe();return(r,c,y,p)=>{de(c);var l,d,x,f,h=ne(r.scene).filter(i=>i!==r.body);Object.assign(a,r.body.velocity),v(n,p,y),Object.assign(r.body.velocity,n),ee(Xr(i,r.body.boundingBox),y),ee(Xr(t,r.body.boundingBox),p),Yr(t,i.min),Yr(t,i.max);for(var u=0;u<h.length;u++){var g=h[u];ee(Xr(e,g.boundingBox),g.parent.position),re(t,e)&&(ve(de(s),r.body,g,i,e),s.fraction<c.fraction&&le(c,s))}Object.assign(r.body.velocity,a),l=c.endpos,d=y,x=p,f=c.fraction,o(m(v(l,x,d),f),d)}})(),fe=(Fi=r(),Ri=[...Array(5)].map(()=>r()),qi=r(),Ei=pe(),Ii=r(),Di=r(),Vi=r(),(i,r)=>{r&&(Object.assign(Di,i.body.velocity),Di.y-=i.gravity*i.dt,i.body.velocity.y=.5*(i.body.velocity.y+Di.y),i.walking&&k(i.body.velocity,ye,P));var e,a=i.dt;for(i.walking?(Si=1,Object.assign(Ri[0],ye)):Si=0,Object.assign(Ri[Si],i.body.velocity),h(Ri[Si]),Si++,e=0;e<4;e++){if(Object.assign(Ii,i.object.position),n(Ii,i.body.velocity,a),xe(i,Ei,i.object.position,Ii),Ei.allsolid)return i.body.velocity.y=0,!0;if(Ei.fraction>0&&Object.assign(i.object.position,Ei.endpos),1===Ei.fraction)break;if(a-=a*Ei.fraction,Si>=5)return t(i.body.velocity,0),!0;var s;for(s=0;s<Si;s++)if(x(Ei.normal,Ri[s])>.99){o(i.body.velocity,Ei.normal);break}if(!(s<Si))for(Object.assign(Ri[Si],Ei.normal),Si++,s=0;s<Si;s++)if(!(x(i.body.velocity,Ri[s])>=.1)){Object.assign(qi,i.body.velocity),k(qi,Ri[s],P),r&&(Object.assign(Vi,Di),k(Vi,Ri[s],P));for(var v=0;v<Si;v++)if(v!==s&&!(x(qi,Ri[v])>=.1||(k(qi,Ri[v],P),r&&k(Vi,Ri[v],P),x(qi,Ri[s])>=0))){b(Fi,Ri[s],Ri[v]),h(Fi);var c=x(Fi,i.body.velocity);Object.assign(qi,Fi),m(qi,c),r&&(c=x(Fi,Di),Object.assign(Vi,Fi),m(Vi,c));for(var y=0;y<Si;y++)if(y!==s&&y!==v&&!(x(qi,Ri[y])>=.1))return t(i.body.velocity,0),!0}Object.assign(i.body.velocity,qi),r&&Object.assign(Di,Vi);break}}return r&&Object.assign(i.body.velocity,Di),0!==e}),he=(_i=r(),Bi=r(),i=>{if((i=>!(i.command.y<10||(i.jump?(i.command.y=0,1):(i.walking=!1,i.jump=!0,i.body.velocity.y=270,hi(ui(Mi(Oi(gi,fi(76)-fi(69)),Pi(.001,.1,.02,.27,1)),.4,.3)[69]),0))))(i))ue(i);else{ge(i);var r=i.command.z,e=i.command.x,a=be(i);i.viewForward.y=0,i.viewRight.y=0,k(i.viewForward,ye,P),k(i.viewRight,ye,P),h(i.viewForward),h(i.viewRight),t(_i,0),n(_i,i.viewForward,r),n(_i,i.viewRight,e),Object.assign(Bi,_i);var o=f(Bi);h(Bi),ze(i,Bi,o*=a,10),k(i.body.velocity,ye,P),(i.body.velocity.x||i.body.velocity.z)&&fe(i,!1)}}),ue=(()=>{var i=r(),e=r();return r=>{ge(r);var a=r.command.z,o=r.command.x,s=be(r);r.viewForward.y=0,r.viewRight.y=0,h(r.viewForward),h(r.viewRight),t(i,0),n(i,r.viewForward,a),n(i,r.viewRight,o),i.y=0,Object.assign(e,i);var v=f(e);h(e),ze(r,e,v*=s,1),r.walking&&k(r.body.velocity,ye,P),fe(r,!0)}})(),ge=(Ni=r(),i=>{var r=i.body.velocity;Object.assign(Ni,r),i.walking&&(Ni.y=0);var e=f(Ni);if(e<1)return r.x=0,void(r.z=0);var t=0;i.walking&&(t+=6*(e<100?100:e)*i.dt);var a=e-t;a<0&&(a=0),m(r,a/=e)}),be=i=>{var r=Math.max(Math.abs(i.command.x),Math.abs(i.command.y),Math.abs(i.command.z));if(!r)return 0;var e=f(i.command);return i.speed*r/(127*e)},ze=(i,r,e,t)=>{var a=e-x(i.body.velocity,r);if(!(a<=0)){var o=t*i.dt*e;o>a&&(o=a),n(i.body.velocity,r,o)}},we=(()=>{var i=r(),e=pe();return r=>{Object.assign(i,r.object.position),i.y-=.25,xe(r,e,r.object.position,i),1!==e.fraction?r.walking=!0:r.walking=!1}})(),Me=r(),je=r(),Oe=r(),Ce=r(),Pe=S(),ke=r(),Ae=r(),Le=(i=r(),e=r())=>({origin:i,direction:e}),We=Le(),Se=(i,e)=>{var t,n,s=[];q(Pe,e.matrixWorld),Fe((t=We,n=i,Object.assign(t.origin,n.origin),Object.assign(t.direction,n.direction),t),Pe);var{vertices:c,faces:p}=e.geometry;return p.map((t,n)=>{var p=c[t.a],l=c[t.b],d=c[t.c],f=((i,e,t,n,s,c)=>{if(((i,e,t,a,n)=>{v(je,t,e),v(Oe,a,e),b(Ce,je,Oe);var s=x(i.direction,Ce),c=1;if(!(s>0)&&s<0){c=-1,s*=-1,v(Me,i.origin,e);var y=c*x(i.direction,b(Oe,Me,Oe));if(!(y<0)){var p=c*x(i.direction,((i,r)=>{var{x:e,y:t,z:a}=i;return i.x=t*r.z-a*r.y,i.y=a*r.x-e*r.z,i.z=e*r.y-t*r.x,i})(je,Me));if(!(p<0||y+p>s)){var l=-c*x(Me,Ce);if(!(l<0))return((i,e,t=r())=>o(m(Object.assign(t,i.direction),e),i.origin))(i,l/s,n)}}}})(e,t,n,s,c))return Object.assign(Ae,c),y(Ae,i.matrixWorld),a(Ae)})(e,We,p,l,d,ke);f&&s.push({point:f,object:e,face:t,faceIndex:n,distance:z(i.origin,f)})}),s},Fe=(i,r)=>(y(i.origin,r),l(i.direction,r),i),Re=(i,r)=>r.flatMap(r=>Se(i,r)).sort((i,r)=>i.distance-r.distance),qe=S(),Ee=a(O),Ie=.001,De=Lr(),Ve=(()=>{var i={};return addEventListener("keydown",r=>i[r.code]=!0),addEventListener("keyup",r=>i[r.code]=!1),i})(),_e=1024,Be=D(),Ne=Le(),Te=r(),Ue=r(),He=r(32,192,192),Ke=i=>{return(r=d(i,32)).x=Math.round(r.x),r.y=Math.round(r.y),r.z=Math.round(r.z),r;var r},Ge=(i,r)=>{var e,t,a=1/0;return r.map(r=>{(t=w(r.position,i))<a&&(a=t,e=r)}),e},Je=(i,r,e)=>{var t=document.createElement("div");t.textContent=r,i.append(t),e&&setTimeout(()=>t.remove(),e)},$e=(i,r,e)=>{i.uniform1f(r,e)},Qe=(i,r,e)=>{i.uniformMatrix4fv(r,!1,e)},Xe=(i,r,e)=>{i.uniform3f(r,e.x,e.y,e.z)},Ye=canvas.getContext("webgl");Ye.clearColor(0,0,0,0),Ye.enable(2929),Ye.enable(2884),Ye.getExtension("OES_standard_derivatives");var Ze=!1,it=G();it.fC=r(),it.fN=1,it.fF=1e3;var rt=((i=60,r=1,e=.1,t=2e3)=>{var o={...G(),fov:i,near:e,far:t,aspect:r,up:a(O),matrixWorldInverse:S(),projectionMatrix:S()};return ei(o),o})(90),et=((i,s,c)=>{var y=G();$(s,y);var l=a(ti);Object.assign(s.fC,l);var d=((i=r(),e=1)=>({...G(),color:i,intensity:e,target:G()}))(r(1,1,1.2));d.intensity=1.5,e(d.position,256,512,256);var b=[d];b.map(i=>$(y,i));var w=i=>{var r=(i=>({...Wr(i.geometry,De),mesh:i}))(i);r.light=d,i.shadow=r},P=G();$(P,c),$(y,P),o(c.position,He),((i,r)=>{F(ri,i.position,r,i.up),B(i.quaternion,ri)})(c,r());var k=te(Hr(),2);w(k),$(y,k);var A=ae(k);A.update=()=>{};var L={object:k,body:A,scene:void 0,command:r(),dt:0,gravity:800,speed:320,viewForward:r(),viewRight:r(),jump:0,walking:!1};L.scene=y,$(y,(i=>{var r=G(),e=Rr([24,12,24],rr(Or),Dr(24),or([jr,.5])),o=Lr();t(o.emissive,.5);var n=[...Array(8)].map(()=>{var i=Wr(e,o);return $(r,i),i.visible=!1,i}),s=a(i.object.position);return ci(r,vi((r,e)=>{if(i.walking&&z(i.object.position,s)>48){var a=n.find(i=>!i.visible);a&&(t(a.scale,1),Object.assign(s,i.object.position),Object.assign(a.position,s),a.visible=!0)}n.map(i=>{i.visible&&(m(i.scale,1-4*e),f(i.scale)<.01&&(i.visible=!1))})}))})(L)),[Rr([672,128,_e],rr(jr),Ki(-112,0,0)),Rr([224,128,819.2],rr(jr),Ki(336,0,-102.4))].map(i=>{var r=te(Wr(i,Lr()),1);Object.assign(r.material.color,ai),$(y,r)});var W,S,R,q,D,V=(W=Rr([12,2,2]),S=Rr([2,2,12]),R=qr(...[[vr,1,1],[cr,1,-1],[mr,-1,-1],[yr,-1,1]].flatMap(([i,r,e])=>[W,S].map(yi($i(),rr(i),Ki(32*r/2,0,32*e/2))))),q=Lr(),t(q.emissive,1),Wr(R,q));V.visible=!1,$(y,V);var T=()=>{var[i,r]=li([[ni,"HTML"],[oi,"CSS"],[si,"JS"]]),a=(i=>{var r=Lr();return Object.assign(r.color,i),n(r.emissive,i,.2),Wr(Rr([28,32,2],rr(Or),Ki(0,4,0)),r)})(i),o=Gr(r),s=Gr(r),v=Lr();t(v.color,.2);var c=Wr(o,v),m=Wr(s,v);return e(m.scale,-1,1,-1),e(c.position,0,16,1),e(m.position,0,16,-1),$(a,c),$(a,m),w(a),a},U=T();U.position.x=-64,$(y,U);var H=[U],K=[[-96,0,128]].map(i=>{var r=te((()=>{var i=Rr([32,8,32],rr(Or)),r=Lr();return t(r.color,.3),Wr(i,r)})(),1);return r.geometry=Rr([72,8,72],rr(Or),Dr(72),or([jr,[.75,1,.75]])),w(r),e(r.position,...i),$(y,r),r}),Y=i=>(Ke(Object.assign(Te,i.position)),H.find(i=>j(Te,Ke(Object.assign(Ue,i.position)))));[[[-448,96,-196],[256,96,-196]],[[96,64,-512],[96,64,256]],[[-256,128,-512],[-256,128,432]]].flatMap(([i,e,a])=>((i,r,e=i.y)=>{v(Fr,i,r);var a=f(Fr),o=Fr.x,n=e-12-8,s=(a/128|0)-1,c=Rr(o?[a,12,64]:[64,12,a],rr(jr)),m=[...Array(s)].flatMap((i,r)=>{var e=128*(r+1),t=Rr(o?[24,8,64]:[64,8,24],er(jr,c,Or));return[t,Rr(o?[12,n,32]:[32,n,12],er(jr,t,Or),sr([jr,1],[Or,ti]))].map(o?Ki(e,0,0):Ki(0,0,e))});return[rr(o?dr:zr)(c),...m].map(r=>{var e=Lr();return t(e.color,1.5),Wr(Ki(i.x,i.y,i.z)(r),e)})})(r(...i),r(...e),a)).map(i=>{var r=te(i,1);w(r),$(y,r)});var ii,ei,mi=yi(rr(Or),sr([jr,1],[Or,ai]),i=>or([jr,{x:E(.9,.95),z:E(.9,.95)}])(i));[[[192,20,32],[256,0,192],mi],[[128,20,128],[-32,0,-384],mi]].map(([i,r,t=rr(Or)])=>{var a=te(Wr(Rr(i,t),Lr()),1);return e(a.position,...r),w(a),$(y,a),a}),[...(ei=Rr([192,128,256],rr(Or)),[ei,Rr([128,64,128],er(Mr,ei,zr))]).map(i=>[i,[352,0,-128]]),[Rr([256,320,320],rr(Or)),[-576,0,-64]],...(ii=Rr([64,96,64],rr(Or)),[ii,Rr([64,4,4],er(wr,ii,br)),Rr([4,4,64],er(xr,ii,dr)),Rr([4,4,64],er(lr,ii,pr))]).map(i=>[i,[96,0,288]]),[Rr([96,160,96],rr(Or)),[-256,0,464]],[Rr([768,160,128],rr(Or)),[-128,0,-576]]].map(([i,r])=>{var a=(i=>{var r=te(Wr(i,Lr()),1);return w(r),$(y,r),r})(i);e(a.position,...r),t(a.material.color,1.2)});var pi=Jr(1),di=Jr();[...Er(-64,96,2).flatMap(i=>Er(0,320,6).map(r=>[di,[-448,r,i]])),...Er(256,448,3).flatMap(i=>Er(0,128,2).map(r=>[pi,[i,r,0]])),...Er(-224,64,4).flatMap(i=>Er(0,160,2).map(r=>[pi,[i,r,-512]])),...[[128,64,288],[-208,128,464],[-208,64,464]].map(i=>[di,i])].map(([i,r])=>{var t=Wr(i,Lr());return e(t.position,...r),$(y,t),t});var xi,ki=-1,Ai=0,Li=i=>(Object.assign(Ne.origin,i.position),Ne.origin.y+=32,e(Ne.direction,0,-1,0),Re(Ne,xi)?.[0]),Wi=i=>(Z(i),M(Ne.origin,i.matrixWorld),v(Ne.direction,Ne.origin,d.position),Re(Ne,xi)?.[0]),Si=i=>{var r=(i=>{var r=G(),o=[...Array(16)].map(()=>{var i=Wr(Vr,li(_r));t(i.scale,E(1,8)),e(i.position,I(16),I(16),I(16)),$(r,i);var o=g(a(i.position),E(64,128));return J(i,o),o});return r=ci(r,vi((i,e)=>{var t=0;r.children.map((i,r)=>{n(i.position,n(o[r],Br,e),e),m(i.scale,1-8*e),f(i.scale)>.01&&t++}),t||Q(r.parent,r)}))})();Object.assign(r.position,i),r.position.y+=16,$(y,r)},Fi=Ar(.1),Ri=Ar(1.5),qi=Ar(4),Ei=Ar(2),Ii=0,Di=0;return ci(y,vi((i,r)=>{var a,o,l,d=ne(y);me(d),L.dt=r,t(L.command,0),(Ve.KeyW||Ve.ArrowUp)&&L.command.z++,(Ve.KeyS||Ve.ArrowDown)&&L.command.z--,(Ve.KeyA||Ve.ArrowLeft)&&L.command.x--,(Ve.KeyD||Ve.ArrowRight)&&L.command.x++,Ve.Space&&L.command.y++,m(L.command,127),e(L.viewForward,0,0,-1),e(L.viewRight,1,0,0),(i=>{i.command.y<10&&(i.jump=!1),we(i),i.walking?he(i):ue(i),we(i)})(L),((i,r,e)=>{i.x=r.x+e.x,i.y=r.y+e.y,i.z=r.z+e.z})(c.position,k.position,He),(L.command.z||L.command.x)&&(ki=Math.sign(L.command.z),Ai=Math.sign(L.command.x),_(Be,O,Math.atan2(Ai,-ki)),N(k.quaternion,Be,12*r)),xi=ne(s).filter(i=>1===i.physics).map(i=>i.parent),Object.assign(V.position,k.position),Ke(V.position),V.position.x+=Ai,V.position.z-=ki,a=V.position,m(a,32),V.position.y=k.position.y,V.visible=!0,!D&&(o=Ge(k.position,H))&&z(k.position,o.position)<64?Object.assign(V.position,o.position):D&&(l=Ge(k.position,K))&&z(k.position,l.position)<64?(Object.assign(V.position,l.position),V.position.y=Li(V)?.point.y||0):(V.position.y=Li(V)?.point.y||0,V.visible=z(V.position,k.position)<64),D&&(V.visible=V.visible&&!Y(V));var b=Y(K[0]);if(b&&(Ii||Je(text,"Uploading...",1e3),(Ii+=r)>1&&(Ii=0,hi(ui(Mi(Ci(gi,fi(37),.5),Pi(.2,.4,.5,.2,1)),1.5,.2)[48]),Je(text,"Uploaded!",2e3),Di++,score.textContent="Score: "+Di,H=H.filter(i=>i!==b),Q(y,b),b=ci(b,vi((i,r)=>{X(b,r),b.position.y+=100*r,b.position.y>1024&&Q(y,b)})),$(y,b))),Fi(r)&&!D&&(Ve.Enter||Ve.ShiftLeft)){Fi.reset(),hi(ui(Mi(Oi(gi,-400),Pi(.001,.01,.1,.2,1)),.4,.2)[76+li([-.5,0,.5])]);var M=Lr();e(M.emissive,1,1,2);var P=0,A=ci(te(Wr(Ir,M),4),vi((i,r)=>{(P+=r)>4&&Q(y,A)})),W=ae(A);p(Object.assign(Ue,C),k.quaternion),n(e(Te,I(1),I(1),I(1)),Ue,8),J(A,Te),p(Object.assign(Te,C),A.quaternion),Object.assign(A.position,k.position),A.position.y+=24,n(A.position,Te,16),n(W.velocity,Te,800),$(y,A),W.collide=()=>Q(y,A)}if(Ri(r)){Ri.reset();var S,F,R=2,q=!1,E=ci(te(Hr(!0),2),vi((i,r)=>{if(q&&E.position.y>-32){var e=Ge(E.position,[...H.filter(i=>i!==D&&!j(i.position,K[0].position)&&i.position.y<=E.position.y),k]);if(e){var t=v(Te,e.position,E.position),a=e===k?void 0:e;if(a&&f(t)<32)return hi(ui(Mi(wi(gi,ji(zi,.5)),bi(8)),.8,.5)[24]),Q(y,a),H=H.filter(i=>i!==a),Q(y,E),void Si(a.position);h(t);var o=F.velocity.y;F.velocity.y=0;var s=f(F.velocity),c=Math.max(s,100),m=Math.max(s-6*c*r,0);g(F.velocity,m);var p=x(F.velocity,t);F.velocity.y=o;var l=160-p;if(l>0){var d=Math.min(10*r*160,l);n(F.velocity,t,d),_(Be,O,Math.atan2(t.x,t.z)),N(E.quaternion,Be,12*r)}}}F.velocity.y-=800*r}));F=ae(E);var B=I(224),U=I(256);e(E.position,B+896*Math.sign(B)/4,1024,U+Math.sign(U)*_e/4),w(E),$(y,E),F.collide=i=>{var r=ae(i).physics;4===r&&(R--,hi(ui(Mi(wi(gi,ji(zi,.5)),bi(32)),.2,.5)[32]),clearTimeout(S),R<=0?(Si(E.position),Q(y,E)):(E.material.emissive.x=1,S=setTimeout(()=>E.material.emissive.x=0,100))),1===r&&(q=!0)},E.position.y>10240&&Q(y,E)}if(qi(r)){var G;qi.reset();var Z=ci(te(T(),2),vi((i,r)=>{G.physics&&(G.velocity.y-=800*r),Z.position.y>10240&&Q(y,Z)}));e(Z.position,I(896),1024,I(_e)),(G=ae(Z)).collide=i=>{1===ae(i).physics&&(G.physics=void 0,G.update=()=>{},H.push(Z))},$(y,Z)}if(Ei(r)){Ei.reset();for(var ii=[[96,96,292],[-256,160,480],[352,128,-48],[-256,160,-544]],ri=T(),ei=0;ei<4;){if(e(ri.position,...li(ii)),!Y(ri)){$(y,ri),H.push(ri);break}ei++}}[...H,k].map(i=>i.shadow.position.y=Wi(i)?.point.y||0),H.map(i=>X(i,r)),k.position.y<-1024&&(u.hidden=!1)})),addEventListener("keydown",i=>{"KeyE"===i.code&&V.visible&&(D?(Q(k,D),$(y,D),Object.assign(D.position,V.position),t(D.scale,1),D=void 0):(D=Y(V))&&(Q(y,D),$(k,D),e(D.position,16,24,16),t(D.scale,.5),hi(ui(Mi(Ci(gi,fi(83)-fi(76),.07),Pi(.001,.1,.1,.3,.5)),.6,.3)[76])))}),{ambient:l,directional:b}})(0,it,rt),tt=((i,r,e)=>{var t=i.createProgram(),a=(r,e)=>{var a=i.createShader(r);i.shaderSource(a,e),i.compileShader(a),i.attachShader(t,a)};return a(35633,"precision highp int;precision highp float;uniform mat4 mVM;uniform mat4 projectionMatrix;attribute vec3 position;varying vec3 vViewPosition;attribute vec3 color;varying vec3 vColor;varying vec3 fP;void main(){vColor=color;vec4 e=mVM*vec4(position,1.0);gl_Position=projectionMatrix*e;vViewPosition=-e.xyz;fP=e.xyz;}"),a(35632,e),i.linkProgram(t),t})(Ye,0,"#extension GL_OES_standard_derivatives : enable\nprecision highp float;precision highp int;\n#define R 0.31830988618\n#define s(a)clamp(a,0.0,1.0)\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;varying vec3 vColor;uniform vec3 fC;varying vec3 fP;uniform float fN;uniform float fF;uniform vec3 ambient;struct D{vec3 direction;vec3 color;};uniform D dL[NUM_DIR_LIGHTS];varying vec3 vViewPosition;void main(){vec3 dD=vec3(0);vec3 dS=vec3(0);vec3 c=diffuse*vColor;vec3 n=normalize(cross(dFdx(vViewPosition),dFdy(vViewPosition)));vec3 v=normalize(vViewPosition);for(int i=0;i<NUM_DIR_LIGHTS;i++){D d=dL[i];vec3 r=s(dot(n,d.direction))*d.color;dD+=r*R*c;vec3 h=normalize(d.direction+v);float L=s(dot(d.direction,h));dS+=r*(((1.0-specular)*(exp2((-5.55473*L-6.98316)*L))+specular)*(0.25*(R*(shininess*0.5+1.0)*pow(s(dot(n,h)),shininess))));}gl_FragColor=vec4(mix(dD+(ambient*R*c)+dS+emissive,fC,smoothstep(fN,fF,length(fP))),1);}".replace(/NUM_DIR_LIGHTS/g,et.directional.length));Ye.useProgram(tt);var at,ot=((i,r)=>{for(var e={},t=i.getProgramParameter(r,35721),a=0;a<t;a++){var o=i.getActiveAttrib(r,a),{name:n}=o;e[n]=i.getAttribLocation(r,n)}return e})(Ye,tt),nt=((i,r)=>{for(var e={},t=i.getProgramParameter(r,35718),a=0;a<t;a++){var o=i.getActiveUniform(r,a),{name:n}=o;e[n]=i.getUniformLocation(r,n)}return e})(Ye,tt),st=1/60,vt=0,ct=new WeakMap,mt=(i,r,e,t)=>{var a=ct.get(e)||{};ct.set(e,a);var o=a[i]||((i,r)=>{var e=i.createBuffer();return i.bindBuffer(34962,e),i.bufferData(34962,r,35044),e})(Ye,e[i]);a[i]=o,((i,r,e,t)=>{i.bindBuffer(34962,e),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,t,5126,!1,0,0)})(Ye,r,o,t)},yt=new WeakMap,pt=r=>{var{geometry:e,material:t}=r;Xe(Ye,nt.fC,it.fC),$e(Ye,nt.fN,it.fN),$e(Ye,nt.fF,it.fF),Xe(Ye,nt.diffuse,t.color),Xe(Ye,nt.specular,t.specular),$e(Ye,nt.shininess,t.shininess),Xe(Ye,nt.emissive,t.emissive),R(r.mVM,rt.matrixWorldInverse,r.matrixWorld),Qe(Ye,nt.mVM,r.mVM),Qe(Ye,nt.projectionMatrix,rt.projectionMatrix);var a,o=yt.get(e)||(a=(i=>{var r=[],e=[];return i.faces.map(t=>{r.push(i.vertices[t.a],i.vertices[t.b],i.vertices[t.c]);var{vertexColors:a}=t;if(3===a.length)e.push(...a);else{var{color:o}=t;e.push(o,o,o)}}),{vertices:r,colors:e}})(e),{position:i(new Float32Array(3*a.vertices.length),a.vertices),color:i(new Float32Array(3*a.colors.length),a.colors)});yt.set(e,o),mt("position",ot.position,o,3),mt("color",ot.color,o,3),Ye.drawArrays(4,0,o.position.length/3)},lt=r(),dt=()=>{Z(it),q(rt.matrixWorldInverse,rt.matrixWorld),Ye.clear(16640),Xe(Ye,nt.ambient,et.ambient),et.directional.map((i,e)=>{var t=r(),a=M(lt,i.matrixWorld);M(t,i.target.matrixWorld),l(s(a,t),rt.matrixWorldInverse);var o=m(Object.assign(t,i.color),i.intensity);Xe(Ye,nt[`dL[${e}].direction`],a),Xe(Ye,nt[`dL[${e}].color`],o)}),Y(it,i=>{if(i.visible&&i.geometry&&i.material&&(pt(i),i.shadow)){var{y:r}=i.shadow.position;i.shadow.position.y+=.001*(rt.position.y-r),((i,r)=>{var{y:e}=i.position,t=x(Ee,r)-e*Ie;qe.set([t-r.x*Ee.x,-r.y*Ee.x,-r.z*Ee.x,-Ie*Ee.x,-r.x*Ee.y,t-r.y*Ee.y,-r.z*Ee.y,-Ie*Ee.y,-r.x*Ee.z,-r.y*Ee.z,t-r.z*Ee.z,-Ie*Ee.z,-r.x*-e,-r.y*-e,-r.z*-e,t-Ie*-e]),R(i.matrixWorld,qe,i.mesh.matrixWorld)})(i.shadow,i.shadow.light.position),pt(i.shadow),i.shadow.position.y=r}})},xt=()=>{(()=>{var i=.001*(performance.now()||0);at||(at=i);var r=Math.min(i-at,.1);for(vt+=r,at=i;vt>=st;)Y(it,i=>{mi(i,st,it)}),vt-=st})(),dt(),Ze&&requestAnimationFrame(xt)},ft=(i,r)=>{canvas.width=i*(devicePixelRatio||1),canvas.height=r*(devicePixelRatio||1),canvas.style.width=i+"px",canvas.style.height=r+"px",Ye.viewport(0,0,canvas.width,canvas.height),rt.aspect=i/r,ei(rt)};ft(innerWidth,innerHeight),xt(),addEventListener("resize",()=>{ft(innerWidth,innerHeight),dt()}),addEventListener("keypress",i=>{"KeyP"===i.code&&((Ze=!Ze)?xt():document.exitPointerLock())}),addEventListener("click",()=>{Ze||(Ze=!0,xt())})})();