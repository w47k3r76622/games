function setVariables(){started=!1,ended=!1,reset_in=3,player={x:BORDER+20+PSIZE/2,y:MAP.h-BORDER-20-PSIZE/2,hp:10,angle:45,power:0,last_power:0,multiplier:0},enemy={x:MAP.w-BORDER-20-PSIZE/2,y:MAP.h-BORDER-20-PSIZE/2,hp:10,angle:135,power:0,last_power:0,multiplier:1,misses:0},e_shot={angle:0,power:0},bullet={x:0,y:0,dx:0,dy:0,color:COLOR.WHT,damage:10,active:!1,shooter:0},explosion={x:0,y:0,frames:0}}function timestamp(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()}function frame(){if(started){for(now=timestamp(),dt+=Math.min(1,(now-last)/1e3);dt>step;)dt-=step,update(step);last=now}render(),requestAnimationFrame(frame,canvas)}function renderTitle(){var e="Network Defense";draw(e,10,MAP.w/2-21*e.length,MAP.h/2-130);var t="Space to start";draw(t,4,MAP.w/2-8*t.length+5,MAP.h/2);var l="Up and down to change angle";draw(l,3,MAP.w/4-170,MAP.h/2+100),l="Hold space to shoot",draw(l,3,MAP.w/4-170,MAP.h/2+130),l="Hit powerups for damage boost",draw(l,3,MAP.w/4-170,MAP.h/2+160);var a="Green: 2x damage";draw(a,3,MAP.w/4*3-110,MAP.h/2+100,COLOR.GRN),a="Yellow: 3x damage",draw(a,3,MAP.w/4*3-110,MAP.h/2+130,COLOR.DRK_YLW),a="Red: 4x damage",draw(a,3,MAP.w/4*3-110,MAP.h/2+160,COLOR.RED)}function renderBackground(){var e=ctx.createRadialGradient(MAP.w/2,MAP.h/2,0,MAP.w/2,MAP.h/2,MAP.w/2);e.addColorStop(0,"#000"),e.addColorStop(1,"#444"),ctx.clearRect(0,0,MAP.w,MAP.h),ctx.fillStyle=e,ctx.fillRect(0,0,MAP.w,MAP.h),ctx.fillStyle=COLOR.BLK,ctx.fillRect(BORDER,BORDER,MAP.w-2*BORDER,MAP.h-2*BORDER)}function renderCannon(e){ctx.drawImage(images.cannon,e.x-PSIZE/2,e.y-PSIZE/2,PSIZE,PSIZE),e==player?(ctx.fillStyle=COLOR.WHT,ctx.fillRect(e.x-3,e.y-6,2,3),ctx.fillRect(e.x+1,e.y-6,2,3),ctx.fillRect(e.x-4,e.y,8,2),ctx.fillRect(e.x-5,e.y-1,2,2),ctx.fillRect(e.x+3,e.y-1,2,2)):(ctx.fillStyle=COLOR.WHT,ctx.fillRect(e.x-4,e.y-6,8,4),ctx.fillRect(e.x-2,e.y-2,5,3),ctx.fillStyle=COLOR.BLK,ctx.fillRect(e.x-3,e.y-5,2,2),ctx.fillRect(e.x+1,e.y-5,2,2),ctx.fillRect(e.x-1,e.y-1,1,2),ctx.fillRect(e.x+1,e.y-1,1,2)),ctx.strokeStyle=COLOR.WHT,ctx.lineWidth=3,ctx.beginPath(),ctx.arc(e.x,e.y,PSIZE,0,2*Math.PI),ctx.closePath(),ctx.stroke();var t=e.x+PSIZE*Math.cos(toRad(360-e.angle)),l=e.y+PSIZE*Math.sin(toRad(360-e.angle));ctx.fillStyle=COLOR.WHT,ctx.beginPath(),ctx.moveTo(e.x+PSIZE*Math.cos(toRad(350-e.angle)),e.y+PSIZE*Math.sin(toRad(350-e.angle))),ctx.lineTo(t+10*Math.cos(toRad(360-e.angle)),l+10*Math.sin(toRad(360-e.angle))),ctx.lineTo(e.x+PSIZE*Math.cos(toRad(370-e.angle)),e.y+PSIZE*Math.sin(toRad(360-e.angle+10))),ctx.closePath(),ctx.fill();var a=(MAP.w-BORDER)*e.multiplier;ctx.fillStyle=COLOR.BLK,ctx.fillRect(a+8,MAP.h-8,BORDER-16,-86),ctx.fillRect(a+14,MAP.h-94,8,-4);var r;r=e.hp>=8?COLOR.GRN:e.hp>=4?COLOR.YLW:COLOR.RED,ctx.fillStyle=r;for(var n=0;n<e.hp;n++)ctx.fillRect(a+12,MAP.h-12-8*n,12,-6);draw("HP",2,a+11,MAP.h-112);var o=(MAP.w-2*BORDER)*e.multiplier+BORDER;if(ctx.fillStyle=COLOR.BLK,ctx.fillRect(o,MAP.h-8,255-510*e.multiplier,-10),ctx.fillStyle=COLOR.WHT,ctx.fillRect(o,MAP.h-8,e.power-e.multiplier*(2*e.power),-10),e.last_power){var i=BORDER+e.last_power;e==enemy&&(i=MAP.w-i),ctx.fillStyle=COLOR.RED,ctx.fillRect(i,MAP.h-8,1,-10)}var s=e==player?BORDER:MAP.w-BORDER-42;draw("Power",2,s,MAP.h-32);var c="192.168.1."+e.power,d=e==player?BORDER+255-7*c.length:MAP.w-BORDER-255;draw(c,2,d,MAP.h-32)}function renderRouter(e){ctx.lineWidth=2,ctx.strokeStyle=COLOR.WHT,ctx.fillStyle=e.color,ctx.beginPath(),ctx.arc(e.x,e.y,e.size,0,2*Math.PI),ctx.closePath(),ctx.fill(),ctx.stroke(),ctx.fillStyle=COLOR.WHT,ctx.strokeStyle=COLOR.BLK,ctx.lineWidth=2,ctx.fillRect(e.x-10,e.y+7,4,-5),ctx.strokeRect(e.x-10,e.y+7,4,-5),ctx.fillRect(e.x-5,e.y+7,4,-8),ctx.strokeRect(e.x-5,e.y+7,4,-8),2==e.damage&&(ctx.fillStyle=COLOR.GRY),ctx.fillRect(e.x,e.y+7,4,-11),ctx.strokeRect(e.x,e.y+7,4,-11),3==e.damage&&(ctx.fillStyle=COLOR.GRY),ctx.fillRect(e.x+5,e.y+7,4,-14),ctx.strokeRect(e.x+5,e.y+7,4,-14)}function renderRouterReset(){var e=reset_in>1?"s":"";draw("Damage boosters will move in "+reset_in+" turn"+e,2,BORDER,20)}function renderBullet(){ctx.beginPath(),ctx.fillStyle=bullet.color,ctx.strokeStyle=COLOR.WHT,ctx.lineWidth=1,ctx.arc(bullet.x,bullet.y,BSIZE,0,2*Math.PI),ctx.closePath(),ctx.fill(),ctx.stroke()}function renderExplosion(){ctx.fillStyle=COLOR.RED,ctx.fillRect(explosion.x-2,explosion.y-10,4,20),ctx.fillRect(explosion.x-10,explosion.y-2,20,4),ctx.fillStyle=COLOR.YLW,ctx.fillRect(explosion.x-2,explosion.y-6,4,12),ctx.fillRect(explosion.x-6,explosion.y-2,12,4)}function renderGameOver(){ctx.fillStyle=COLOR.WHT,ctx.fillRect(MAP.w/2-200,MAP.h/2-3,150,6),ctx.fillRect(MAP.w/2-50,MAP.h/2-10,50,20),ctx.fillRect(MAP.w/2+50,MAP.h/2-90,120,180),ctx.fillStyle=COLOR.BLK,ctx.fillRect(MAP.w/2+95,MAP.h/2-15,30,30),ctx.fillRect(MAP.w/2+102,MAP.h/2-21,16,6),draw("Game Over",8,MAP.w/2-160,MAP.h/2-180),draw("You are disconnected",4,MAP.w/2-160,MAP.h/2+160),draw("Press space to try again",4,MAP.w/2-185,MAP.h/2+190)}function renderVictory(){ctx.drawImage(images.ie_icon,MAP.w/2-100,MAP.h/2-100,200,200),draw("Congratulations",8,MAP.w/2-250,MAP.h/2-180),draw("Your network is safe",4,MAP.w/2-162,MAP.h/2+160),draw("Press space to restart",4,MAP.w/2-168,MAP.h/2+190)}function render(){if(renderBackground(),started)if(ended)player.hp<=0?renderGameOver():renderVictory();else{renderCannon(player),renderCannon(enemy),renderRouterReset();for(var e=0;e<routers.length;e++)routers[e].active&&renderRouter(routers[e]);bullet.active&&renderBullet(),explosion.frames>0&&(renderExplosion(),explosion.frames--)}else renderTitle()}function toRad(e){return Math.PI*e/180}function start(){document.addEventListener("keydown",keyDown,!1),document.addEventListener("keyup",keyUp,!1),started=!0,now=last=timestamp(),generateRouters(),nextRound()}function restart(){document.removeEventListener("keypress",restart),document.removeEventListener("keydown",keyDown),document.removeEventListener("keyup",keyUp),document.addEventListener("keypress",spaceStart,!1),setVariables()}function nextRound(){turn=PLAYER,bullet.active=!1,reset_in--,0>=reset_in&&(reset_in=2,generateRouters())}function enemyTurn(){turn=ENEMY;var e=Math.floor(3*Math.random()),t=Math.max(2*e,15-2*enemy.misses-3*(player.hp-enemy.hp)),l=Math.floor(Math.random()*(t/3));l-=Math.floor(Math.random()*(t/3));var a=Math.floor(Math.random()*t);a-=Math.floor(Math.random()*t),e_shot.angle=180-routers[e].angle+l,e_shot.power=routers[e].power+a,bullet.active=!1}function onkey(e,t,l){switch(t){case KEY.UP:return player.angleUp=l,!1;case KEY.DOWN:return player.angleDown=l,!1;case KEY.SPACE:return player.fire=l,!1}}function fireBullet(e,t,l,a,r){bullet={x:t,y:l,dx:a,dy:r,color:COLOR.WHT,damage:1,active:!0,shooter:e},SOUNDS.SHOOT.play()}function generateRouters(){for(var e,t,l,a,r,n,o,i,s=[],c=0;c<routers.length;c++){do{e=enemy.x-player.x;do{t=Math.floor(75*Math.random()),i=75;for(var d=0;d<s.length;d++)diff=Math.abs(t-s[d]),i=Math.min(diff,i)}while(4>i);l=Math.sqrt(e*GRAVITY/Math.sin(toRad(2*t))),a=l/2,o=Math.pow(l,2)*Math.pow(Math.sin(toRad(t)),2)/(2*GRAVITY)}while(a>255||o>MAP.h-(MAP.h-player.y)-BORDER-routers[c].size-5);s.push(t),r=Math.floor(200*Math.random())+(MAP.w/2-100)-player.x,n=Math.tan(toRad(t))*r-GRAVITY/(2*Math.pow(l,2)*Math.pow(Math.cos(toRad(t)),2))*Math.pow(r,2),routers[c].x=r+player.x,routers[c].y=MAP.h-n-(MAP.h-player.y),routers[c].angle=t,routers[c].power=a,routers[c].active=!0}}function collisionDetection(){if(bullet.x<BORDER+BSIZE||bullet.x>MAP.w-BORDER-BSIZE||bullet.y<BORDER+BSIZE||bullet.y>MAP.h-BORDER-BSIZE)return void miss();for(var e=0;e<routers.length;e++){var t=bullet.x-routers[e].x,l=bullet.y-routers[e].y;Math.pow(t,2)+Math.pow(l,2)<Math.pow(BSIZE+routers[e].size,2)&&hitRouter(e)}if(bullet.shooter==PLAYER){var t=bullet.x-enemy.x,l=bullet.y-enemy.y;if(Math.pow(t,2)+Math.pow(l,2)<Math.pow(BSIZE+PSIZE,2))return void hitEnemy()}if(bullet.shooter==ENEMY){var t=bullet.x-player.x,l=bullet.y-player.y;if(Math.pow(t,2)+Math.pow(l,2)<Math.pow(BSIZE+PSIZE,2))return void hitPlayer()}}function update(e){if(!ended){if(ending)end_delay>0?end_delay--:(ending=!1,ended=!0,document.addEventListener("keypress",restart,!1));else if(enemy.hp<=0)ending=!0,end_delay=10;else if(player.hp<=0)ending=!0,end_delay=10;else if(bullet.active)bullet.y=bullet.y+e*bullet.dy,bullet.x=bullet.x+e*bullet.dx,bullet.dy=bullet.dy+e*GRAVITY,collisionDetection();else if(turn==PLAYER){if(player.fire&&!player.firing)player.power=0,player.firing=!0;else if(player.fire&&player.power<255)player.power+=1;else if(!player.fire&&player.firing){var t=Math.cos(toRad(player.angle))*player.power*2,l=2*-(Math.sin(toRad(player.angle))*player.power);fireBullet(PLAYER,player.x,player.y,t,l),player.last_power=player.power,player.firing=!1}}else if(enemy.angle<e_shot.angle-.2)enemy.angle<e_shot.angle-1?enemy.angle+=1:enemy.angle+=.2;else if(enemy.angle>e_shot.angle+.2)enemy.angle>e_shot.angle+1?enemy.angle-=1:enemy.angle-=.2;else if(enemy.firing)if(enemy.power<e_shot.power&&enemy.power<255)enemy.power+=1;else{var t=Math.cos(toRad(enemy.angle))*enemy.power*2,l=2*-(Math.sin(toRad(enemy.angle))*enemy.power);fireBullet(ENEMY,enemy.x,enemy.y,t,l),enemy.last_power=enemy.power,enemy.firing=!1}else enemy.power=0,enemy.firing=!0;player.angleUp&&player.angle<90?player.angle+=.5:player.angleDown&&player.angle>0&&(player.angle-=.5)}}function explode(){explosion.x=bullet.x,explosion.y=bullet.y,explosion.frames=30}function miss(){SOUNDS.MISS.play(),explode(),bullet.shooter==PLAYER?enemyTurn():(enemy.misses++,nextRound())}function hitEnemy(){SOUNDS.HIT.play(),explode(),enemy.hp=Math.max(enemy.hp-bullet.damage,0),enemyTurn()}function hitPlayer(){SOUNDS.HIT.play(),explode(),enemy.misses=0,player.hp=Math.max(player.hp-bullet.damage,0),nextRound()}function hitRouter(e){routers[e].damage>bullet.damage&&(SOUNDS.POWERUP.pause(),SOUNDS.POWERUP.play(),bullet.damage=routers[e].damage,bullet.color=routers[e].color)}function keyDown(e){return onkey(e,e.keyCode,!0)}function keyUp(e){return onkey(e,e.keyCode,!1)}function spaceStart(e){e.keyCode==KEY.SPACE&&(document.removeEventListener("keypress",spaceStart),start())}function load(){images.size++,images.size==IMAGES.size&&(document.addEventListener("keypress",spaceStart,!1),setVariables(),frame())}function loadImage(e,t){images[t]=document.createElement("img"),images[t].addEventListener("load",load,!1),images[t].src=e}var MAP={w:1200,h:600},BORDER=36,GRAVITY=9.8*12,PSIZE=20,BSIZE=4,PLAYER=1,ENEMY=2,COLOR={BLK:"#000",WHT:"#FFF",GRY:"#666",GRN:"#093",RED:"#F00",YLW:"#FF0",DRK_YLW:"#afaf00"},KEY={UP:38,DOWN:40,SPACE:32},IMAGES={CANNON:"images/cannon.png",IE_ICON:"images/ie_icon.png",size:2},SOUNDS={HIT:new Audio("sounds/hit.mp3"),MISS:new Audio("sounds/miss.mp3"),POWERUP:new Audio("sounds/powerup.mp3"),SHOOT:new Audio("sounds/shoot.mp3")},canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),images={size:0},started,ended,ending=!1,end_delay=0,turn=null,reset_in,icon=null,player,enemy,e_shot,bullet,explosion,routers=[{x:0,y:0,angle:0,power:0,damage:2,color:COLOR.GRN,size:30,active:!1},{x:0,y:0,angle:0,power:0,damage:3,color:COLOR.DRK_YLW,size:25,active:!1},{x:0,y:0,angle:0,power:0,damage:4,color:COLOR.RED,size:15,active:!1}];canvas.width=MAP.w,canvas.height=MAP.h;var fps=60,step=1/fps,dt=0,now,last=timestamp();loadImage(IMAGES.CANNON,"cannon"),loadImage(IMAGES.IE_ICON,"ie_icon");