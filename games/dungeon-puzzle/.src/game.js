let e,t,o,n,r,l,u,s,a="building",c="woods",f="cavern",{floor:d,ceil:m,max:h,abs:p}=Math,w=(e=1)=>Math.random()*e,g=e=>e[d(w(e.length))],b=e=>document.querySelector(e),T=e=>[...document.querySelectorAll(e)],v=!1,$=[],x=[],y=[],k={heroes:[],enemies:[]},z=[],Y=b(":root"),D=null,E=null,I=!1,M=.2,N=!1,S=document.body,W=b("#avaliable"),A=b("article"),L=b("article > div"),O=b("article > ul"),R=e=>Object.values(e).filter((e=>e)),j=0,B="defensive",F=!1,G=b("article div"),P={N:[["#####","   # "," # # "," # # ","   # "],["#####"," #   "," ### ","   # ","   # "],["#####","#####","   ##","## ##","## ##"],["#####","#   #","    #","#   #","## ##"],["#####","#   #","#   #","#   #","## ##"]],S:[["   # "," # # "," # # ","   # ","#####"],["   # ","   # "," ### "," #   ","#####"],["## ##","## ##","   ##","#####","#####"],["## ##","## ##","    #","##  #","#####"]],W:[["#  ##","#  # ","#  # ","#  # ","#  ##"],["#    ","#####","#    ","#  ##","#  ##"],["#  ##","# ## ","# #  ","# ## ","#  ##"]],E:[["    #","#####","    #","    #","    #"],["    #","  ###"," ## #","##  #","    #"],["    #","### #","    #","#####","    #"]],in:[["## ##","#   #","     ","#   #","## ##"],["#####","#   #","     ","#   #","#####"],["## ##","#   #","#   #","#   #","## ##"],["## ##","#   #","    #","#   #","## ##"],["## ##","#  ##","   ##","#  ##","## ##"],["     ","  #  "," ### ","  #  ","     "],["     "," # # ","     "," # # ","     "],["   # ","   # ","   # ","   # ","   # "],[" # # "," # # "," # # "," # # "," # # "],[" # # ","   # "," # # ","   # "," # # "],["   ##"," #  #"," #  #"," #  #","   ##"],["   # ","  ## ","  #  ","  ## ","   # "],["   # "," ### "," ##  "," ### ","   # "],["   # "," # # "," # # "," ### ","   # "],["   # "," ### "," # # "," # # ","   # "],["     ","     ","     ","     ","     "]]};function q(e,t={}){let o=e instanceof Element?e:document.createElement(e);return q.extend(o),Object.keys(t).forEach((e=>"text"===e?o.appendChild(document.createTextNode(t[e])):"parent"===e?t.parent.appendChild(o):"child"===e?t.child.forEach(((e,n)=>{n%2==0&&o.mkChild(e,t.child[n+1]||{})})):"css"===e?o.setStyle(t.css):e.match(/^on/)?o[e]=t[e]:o.setAttribute(e,t[e]))),o}function C(){s=new AudioContext,H()}function H(e=2,t=0,o=1,n=1,i,r,l){setTimeout((()=>{let t=s.currentTime,u=s.createOscillator(),a=s.createGain();u.frequency.value=0,u.frequency.setValueAtTime(e,t),u.frequency.linearRampToValueAtTime(i||e,t+(r||n)),a.gain.setValueAtTime(o,t),a.gain.linearRampToValueAtTime(0,t+(l||n)),u.connect(a),a.connect(s.destination),u.start(),setTimeout((()=>u.disconnect()),1e3*(l||n))}),1e3*t)}function K(){for(i=0;i<20;i++)H(900+i%2*400,i,(20-i)/500,.2),H(400,i+.1,(20-i)/200,.1)}function U(){for(i=0;i<15;i++)H(2e3,i/9.73,.4,1)}q.extend=function(e){return e.mkChild=(t,o)=>q(t,{...o,parent:e}),e.setStyle=t=>Object.entries(t).forEach((([t,o])=>e.style[t]=o)),e},window.mkEl=q;let _=()=>w()<.5?"m":"f";function J(o=-1,i,r){let[l,u,s,m]=(i||"").split("");if(-1===o&&w()<.666){let i=[];n[0].filter((e=>!e)).length&&i.push(0),n.map((t=>t[e-1])).filter((e=>!e)).length&&i.push(1),n[t-1].filter((e=>!e)).length&&i.push(2),n.map((e=>e[0])).filter((e=>!e)).length&&i.push(3),o=g(i)}if(!i){let e=e=>o==e?"-":_();l=e(0),u=e(1),s=e(2),m=e(3)}return r||(r=[a,c,c,f][d(w(4))]),V(l+u+s+m,r,Q(l,u,s,m,r==c?.8:r==f?.9:1))}function Q(e,t,n,i,r){let l,u="in";"-"==e&&(u="N"),"-"==n&&(u="S"),"-"==i&&(u="W"),"-"==t&&(u="E"),l=g(P[u]).map((e=>""+e));for(let e=0;e<5;e++)for(let t=0;t<5;t++){let n=l[t].split("");2==e&&0==t||2==e&&4==t||0==e&&2==t||4==e&&2==t||" "!=n[e]||!(w()<o)||(n[e]=w()<M?1+m(w(5)):1,l[t]=n.join(""))}return l.join("")}function V(e,t,o){let n=[[],[],[],[],[]];o=["       ",...o.replace(/(.{5})/g,"$1!").split("!").slice(0,5).map((e=>" "+e+" ")),"       "].map((e=>e.split("")));let i=q("p",{class:`N${e[0]} E${e[1]} S${e[2]} W${e[3]} ${t}`,child:["f","","map",{child:o.flatMap(((e,t)=>e.flatMap(((i,r)=>{0==r&&3==t&&"#"==e[1]&&(i="#"),6==r&&3==t&&"#"==e[5]&&(i="#"),3==r&&0==t&&"#"==o[1][3]&&(i="#"),3==r&&6==t&&"#"==o[5][3]&&(i="#");let l=i.match(/[1-9]/)&&parseInt(i);return r>0&&r<6&&t>0&&t<6&&(n[t-1][r-1]=l>0?l:i),[l>0?"e":"#"==i?"w":" "==i?"b":i,{class:l>0&&"e"+l,child:["i",""]}]}))))}]});return i.N=e[0],i.E=e[1],i.S=e[2],i.W=e[3],i.terrain=t,i.map=n,i.placePiece=ee,i.enablePiece=te,i.addEventListener("click",X),i}function X(e){let t=e.target;ae.x=5*t.x+e.layerX/20-.5,ae.y=5*t.y+e.layerY/20-.5,ae.onupdate(),ae.className="show",setTimeout((()=>ae.className=""),100)}let Z=()=>{n.every((e=>e.every((e=>e))))&&(ke("Lookout!!! The Lord of Death's gate will open!"),setTimeout((()=>D.openGrid()),1500))};function ee(e,t,o=!0){if(this.style.left=100*e+"px",this.style.top=100*t+"px",G.appendChild(this),this.x=e,this.y=t,this.removeOptBtns&&this.removeOptBtns(),n[t][e]=this,o){bt(1),this.classList.add("disabled"),this.enablePiece();let o=(x[t]||[])[e]||{};y=y.filter((e=>e!==o));let n=Tt(e,t);R(n).map((e=>e.enablePiece()));let i=R(n).filter((e=>e.terrain===this.terrain)),r=i.length;r&&ke(1===r?"You get a new warrior.":`You get ${r} new warriors.`),i.map((e=>{let t,o;for(;" "!==(e.map[o]||[])[t];)t=~~w(5),o=~~w(5);setTimeout((()=>{re(5*e.x+t,5*e.y+o).style.filter="brightness(99) blur(.5em) opacity(0)"}),1e3)}));for(let e=4;e<12;e++)H(10*e,0,1,.3)}else this.classList.add("disabled");return Z(),this}function te(){this.classList.contains("disabled")&&(this.classList.remove("disabled"),this.map.map(((e,t)=>e.map(((e,o)=>{let n=5*this.x+o,i=5*this.y+t,r=null;"#"==e&&oe(n,i,.5),"u"==e&&(r=re(n,i)),"m"==e&&(r=le(n,i)),e>0&&(r=ue(n,i,e))})))),this.querySelectorAll("u,m,e").forEach((e=>e.replaceWith(q("b")))))}let oe=(e,t,o)=>{let n={x:e+.5,y:t+.5,r:o};return y.push(n),n},ne={child:["i",""],parent:O,onupdate(){this.style.left=this.x+"em",this.style.top=this.y+"em"}},ie=(e,t,o,n=ne,i=2)=>{let r=q(e,{...n,css:{filter:"blur(.1em) grayscale(.9)",transition:"2s filter linear"}});return setTimeout((()=>r.style.filter="none"),100),r.v={x:0,y:0},r.x=t+.5,r.y=o+.5,r.r=(5+i)/14/2,r.size=i,r.lifeOrig=r.life="u"===e?9:"m"===e?3:7===i?20:8===i?30:9===i?40:i,r.classList.add("life6"),r.isHero="u"===e||"m"===e,"x"!==e&&(r.group=r.isHero?"heroes":"enemies",k[r.group].push(r)),r.tic=0,r.onupdate(),r};function re(e,t){return ie("u",e,t)}function le(e,t){return ie("m",e,t)}function ue(e,t,o){return ie("e",e,t,{class:"e"+o,...ne},o)}let se=[];for(let e=2;e<100;e+=4)for(let t=2;t<100;t+=4)se.push(`radial-gradient(at ${e+w(3)}% ${t+w(3)}%, #060, #673, transparent ${w(4)}%)`);q("style",{parent:document.head,text:`p.woods{background-image:${se.join(",\n")}}`});let ae=ie("x",1.5,1.5);function ce(){A.classList.remove("hide");let e=A.clientWidth,t=A.clientHeight,o=L.clientWidth,n=L.clientHeight,i=o/13,r=h(.2*i,(e-o)/2),l=h(.2*i,(t-n)/2);L.style.left=r+"px",L.style.top=l+"px",O.style.left=r+"px",O.style.top=l+"px"}ae.style.transition="",ae.onupdate(),window.addEventListener("resize",ce),window.addEventListener("load",ce);let fe=(e,t,o)=>{if(j<5)return ke("You have not enought gold.");ke("Repace "+e.terrain+" piece for 5 gold coins."),bt(-5),e.remove(),Le(J(),t,o)},de=(e,t,o)=>{if(j<1)return ke("You have not enought gold.");e.classList.add("turn90");let n=["","","","",""];for(let t=0;t<5;t++)for(let o=0;o<5;o++)n[4-o]+=e.map[t][o];setTimeout((()=>{let i=V(e.E+e.S+e.W+e.N,e.terrain,n.join(""));ke("Rotate "+e.terrain+" piece for 1 gold coins."),bt(-1),e.remove(),Le(i,t,o)}),500)};window.addEventListener("mouseup",pe),window.addEventListener("mousemove",we);let me=null;function he(e){me=this,me.style.transition="transform .6s",me.classList.add("dragging"),S.classList.add("dragging"),me.drag(e.pageX,e.pageY)}function pe(e){if(!me)return 0;if(N&&$t(me,...ge)){let{x:e,y:t}=me;me.btReplace.remove(),setTimeout((()=>Le(J(),e,t)),500),me.style.transition=null,me.removeEventListener("mousedown",he),me.placePiece(...ge)}else vt&&ke(vt),me.drag(),me.style.transition=".6s";me.classList.remove("dragging"),S.classList.remove("dragging"),me=null,ge=[]}function we(e){if(!me)return 0;me.drag(e.pageX,e.pageY)}let ge=[];function be(e,t,o){e.stopPropagation(),me?(ge=[t,o],$[o][t].className=$t(me,t,o)?"valid":"invalid"):$[o][t].className=""}window.addEventListener("mouseover",(e=>{ge=[]})),T(".act button").map((e=>e.onclick=()=>{T(".act button").map((e=>e.className="")),e.className="active",B=e.dataset.act})),b(".act button:nth-child(2)").click();let Te=b("#magic-rgn"),ve=b("#magic-frz"),$e=!0;Te.onclick=()=>{ut()&&(Te.disabled=!0,setTimeout((()=>Te.disabled=!1),3e4),$e&&(ze(3,"It will take a half clock turn until you can cast regenerate again."),$e=!1))};let xe=!0;ve.onclick=()=>{st()&&(ve.disabled=!0,setTimeout((()=>ve.disabled=!1),6e4),xe&&(ze(3,"It will take a clock turn until you can cast freeze again."),xe=!1))};let ye=45;setInterval((()=>ye=Math.min(ye+1,45)),1500);let ke=(e,t={})=>{let o=q("news",{text:e,parent:S});return o.style.top=(t.iniTop||0)+"vh",ye-=5,ye<25&&(ye=50),setTimeout((()=>{o.classList.add(t.class),o.setStyle({opacity:1,top:(t.top||ye)+"vh"})}),100),t.noRemove||(setTimeout((()=>o.style.opacity=0),1e3*(t.dur||4)),setTimeout((()=>o.remove()),1e3*(t.dur||4)+2e3)),o},ze=(e,t,o)=>setTimeout((()=>ke(t,o)),1e3*e),Ye=q("cp",{parent:b("clock")}),De=q("cp",{parent:b("clock"),class:"shadow"}),Ee=q("b",{parent:b("clock")}),Ie=()=>{u=l=Date.now(),Ne(),setTimeout(Se,3e4),K()},Me=0,Ne=()=>{Me++;let e=Date.now()-l,t=e/6e4;if(t<13){if(N&&setTimeout(Ne,500),Ee.innerText="Turn "+~~(t+1),t>12&&Me%2==0){let t=(e%6e4/12e4)**2;H(900+Me%4*200,0,t,.2),H(400,.1,t,.1)}}else Ee.innerText="Timeout",pt();Ee.style.color=t>12?"#A55":null,Ye.style.transform=De.style.transform=`rotate(${t}turn)`,e<6e4?btBuyTime.setAttribute("disabled",!0):btBuyTime.removeAttribute("disabled")},Se=()=>{N&&setTimeout(Se,1e4),bt(1)},We=5;function initMap(i){b("bg").className="hide",setTimeout((()=>b("bg").style.display="none"),4e3),r=i,"easy"==i?(e=5,t=5,o=.1):"medium"==i?(e=9,t=6,o=.15):"hard"==i?(e=12,t=7,o=.2):(e=h(5,parseInt(b("#conf-width").value)||13),t=h(5,parseInt(b("#conf-height").value)||7),o=parseInt(b("#conf-enemy-chance").value)/100||.1,r=`${e}x${t}`),n=Array(t).fill(0).map((t=>Array(e).fill(0))),Y.style.setProperty("--pW",e),Y.style.setProperty("--pH",t),ce(),V("-mf-","building","######mu ##uu  #   ### ##").placePiece(0,0),V("ff--","cavern","###########    #m #######").placePiece(0,t-1,!1),V("--ff","cavern","####### m#    ###########").placePiece(e-1,0,!1),V("mmmm","cavern","## ####3#  3811##111# 111").placePiece(e-3,t-3,!1),V("m-mm","cavern","#222###7 #1## #11###111##").placePiece(e-1,t-3,!1),V("mm-m","cavern","##1112##1127##12  #######").placePiece(e-3,t-1,!1),D=V("m--m","cavern","    # 9#1# ##1# 111######").placePiece(e-1,t-1,!1);let l=D.mkChild("grid"),u=[],s=5*(e-1),a=5*(t-1);for(let e=3.4;e>0;e-=.4)u.push(oe(s+e,a+.2,.3));for(let e=.6;e<3.6;e+=.4)u.push(oe(s+.2,a+e,.3));D.openGrid=()=>{l.setStyle({width:0,height:0,top:"1em"}),u.map(((e,t)=>setTimeout((()=>{H(60,0,1,.1),H(110,0,1,.1),H(200,0,.5,.1),H(60,.08,1,.1),H(110,.08,1,.1),H(200,.08,.5,.1),y=y.filter((t=>t!==e))}),170*(t+2))))},D.origEnablePiece=D.enablePiece,D.enablePiece=()=>{D.origEnablePiece(),E=O.querySelector(".e9"),queueMicrotask((()=>{for(let e=0;e<9;e++){let t=(e+1)/100;ue(s+e%3+1,a+3+t,1),ue(s+3+t,a+e%3+1,1)}}))};let c=5*e/2,f=5*t/2;oe(c-.5,-c,c),oe(c-.5,2*f+c-1,c),oe(-f,f-.5,f),oe(2*c+f-1,f-.5,f);for(let o=0;o<e;o++)for(let e=0;e<t;e++)if(!n[e][o]){let t=oe(5*o+2,5*e+2,2.5);x[e]||(x[e]=[]),x[e][o]=t,$[e]||($[e]=[]),$[e][o]=q("space",{parent:G,onmouseover(t){be(t,o,e)},css:{left:100*o+5+"px",top:100*e+5+"px"}})}Ae(),window.sheet=()=>{for(let o=0;o<e;o++)for(let i=0;i<t;i++)n[i][o]||((t,o)=>{setTimeout((()=>{0==t?J(3).placePiece(t,o):0==o?J(0).placePiece(t,o):12==t?J(1).placePiece(t,o):6==o?J(2).placePiece(t,o):J(9).placePiece(t,o)}),300*(o*e+t))})(o,i)},ze(10,"The Lord of Death's dungeon is southeastern corner of unknown lands.",{iniTop:90,top:48,dur:10}),ze(11,"You will recognize the Lord of Death by their emerald crown.",{iniTop:90,top:55,dur:11}),ze(12,"Don't confuse him with your generals, who wear a onyx crown.",{iniTop:90,top:62,dur:12}),ze(13,"Nor with his son, who wear the silver crown.",{iniTop:90,top:69,dur:13}),ze(14,"Kill the Lord of Death and all undead will vanish with him.",{iniTop:90,top:76,dur:14}),ze(50,"The woods told two more wizards are kidnapped!",{iniTop:90,top:50,dur:9}),ze(52,"You can find they on the other edges of unknown lands.",{iniTop:90,top:57,dur:9}),N=!0,bt(199+50*~~(e*t/20)),C(),Ie(),Je()}function Ae(){for(let e=0;e<2;e++)for(let t=0;t<5;t++){let o=t<2?a:e<1?c:f;Le(J(-1,0==t?`-${_()}${_()}f`:1==t?`m${_()}${_()}-`:"",o),e,t)}}function Le(e,t,o){e.x=t,e.y=o,e.drag=(t=0,o=0)=>{let n=W.getBoundingClientRect();e.style.left=(t?t-50-n.x:100*e.x)+"px",e.style.top=(o?o-50-n.y:90*e.y)+"px"},e.drag(),e.addEventListener("mousedown",he),W.appendChild(e),e.btRotate=q("button",{text:"⭯",title:"Rotate",parent:e,class:"hide",onmousedown(e){e.stopPropagation()},onclick(n){n.stopPropagation(),de(e,t,o)}}),e.btReplace=q("button",{text:"⇆",title:"Replace",parent:e,class:"hide replace",onmousedown(e){e.stopPropagation()},onclick(n){n.stopPropagation(),fe(e,t,o)}});let n=()=>{e.btRotate.classList.remove("hide"),e.btReplace.classList.remove("hide")},i=()=>{e.btRotate.classList.add("hide"),e.btReplace.classList.add("hide")};e.addEventListener("mouseover",n),e.addEventListener("mouseout",i),e.removeOptBtns=()=>{e.btRotate.remove(),e.btReplace.remove(),e.removeEventListener("mouseover",n),e.removeEventListener("mouseout",i)}}window.buyTime=()=>{let e=2*We;e>j?ke(`You have no enough gold.\nYou need ${e} gold coins to rollback one clock turn.`):confirm(`It will cost you ${e} gold coins.\nAre you sure?`)&&(ke(`Rollback one clock turn for ${e} gold coins.`),l+=6e4,bt(-e),We=e)};let Oe=(e,t)=>({x:t.x-e.x,y:t.y-e.y}),Re=e=>Math.sqrt(e.x**2+e.y**2),je=(e,t=1)=>{let o=Re(e);return{x:t*e.x/o,y:t*e.y/o}};window.forceGraphicUp=()=>{S.classList.remove("slow"),_e=Date.now(),Ke=0};let Be=!1,Fe=!0,Ge=!1,Pe=[],qe=!1,Ce=1/0,He=0,Ke=0,Ue=0,_e=0,Je=()=>{if(N&&setTimeout(Je,66),He++,He%8==0){let e=Date.now(),t=(e-Ce)/8;Ce=e,t>142&&(console.log("FPS is low:",1e3/t),_e<e-1e4&&u<e-4e4&&(b("#forceGraphBtn").classList.remove("show"),Ke++,Ke>3&&(S.classList.add("slow"),Ue=0))),t<70&&++Ue>10&&b("#forceGraphBtn").classList.add("show")}Be="cra"===B,Fe="def"===B,Ge="agg"===B;for(let e,t=0;e=k.heroes[t];t++)e.tic++,Xe(e);if(!F)for(let e,t=0;e=k.enemies[t];t++)e.tic++,Ve(e);ot(),Pe=[...k.heroes,...k.enemies];for(let o,n=0;o=Pe[n];n++)F&&!o.isHero||(it(o),rt(o),lt(o),o.life>0&&(o.size>6&&(o.v.x/=2,o.v.y/=2),o.v.x||(o.v.x=0),o.v.y||(o.v.y=0),o.x+=o.v.x,o.y+=o.v.y,(o.x<0||o.y<0||o.x>5*e||o.y>5*t)&&ct(o),o.onupdate()));qe&&H(600,0,1,.5,200),qe=!1},Qe=(e,t,o=10)=>{let n,i,r;for(let l,u=0;l=t[u];u++)if(p(l.x-e.x)<o&&p(l.y-e.y)<o){let t=Oe(e,l),o=Re(t);n?o<n&&(n=o,i=l,r=t):(n=o,i=l,r=t)}return[r,n,i]},Ve=o=>{let n=o===E?3:o.size>6?6:15,[i]=Qe(o,k.heroes,n);if(i){let e=je(i,.03);o.v.x+=e.x,o.v.y+=e.y}else if(o===E){let n=Oe(o,{x:5*(e-1)+1.5,y:5*(t-1)+1.5}),i=je(n,.03);o.v.x+=i.x,o.v.y+=i.y}else o.v.x*=.8,o.v.y*=.8},Xe=e=>{let[t,o,n]=Qe(e,k.enemies,10);if(!("M"===e.tagName?et(e,t,o,n):Ze())){if(t&&o<8){let o=je(t,.05);Be&&(e.v.x-=o.x,e.v.y-=o.y),Ge&&(e.v.x+=o.x,e.v.y+=o.y)}let n=Oe(e,ae),i=je(n,.03);Re(n)>2?(e.v.x+=i.x,e.v.y+=i.y):(e.v.x+=i.x/5,e.v.y+=i.y/5)}},Ze=e=>{},et=(e,t,o,n)=>{let i=!1;if(t){if(o<2){let o=je(t,.03);e.v.x-=o.x,e.v.y-=o.y,i=!0}e.tic%50==0&&tt(e,n)}return i},tt=(e,t)=>{let o=q("fb",{parent:O,onupdate(){this.style.left=this.x+.4+"em",this.style.top=this.y+.4+"em"}});return o.target=t,o.x=e.x,o.y=e.y,z.push(o),o.onupdate(),o},ot=()=>{for(let e,t=0;e=z[t];t++){let t=Oe(e,e.target),o=je(t,.3);e.style.setProperty("--dx",.7*-o.x+"em"),e.style.setProperty("--dy",.7*-o.y+"em"),e.x+=o.x,e.y+=o.y;for(let t,o=0;t=y[o];o++)if(t.r<3){let o=Oe(e,t);Re(o)<1.2*t.r&&nt(e)}Re(t)<e.target.r+.3&&(nt(e),ct(e.target)),e.onupdate()}},nt=e=>{z=z.filter((t=>t!==e)),e.classList.add("boom"),setTimeout((()=>e.remove()),2e3)},it=e=>{e!==E&&(e.v.x+=w(.06)-.03,e.v.y+=w(.06)-.03),Re(e.v)>.1&&(e.v=je(e.v,.1))},rt=e=>{for(let t,o=0;t=Pe[o];o++)if(e!==t){let o=Oe(e,t),n=Re(o),i=e.r+t.r;at(e,t)?n<i&&ct(t):n<1.5*i&&(o=je(o,.01),e.v.x-=o.x,e.v.y-=o.y),n<i&&(o=je(o,.03),e.v.x=-o.x,e.v.y=-o.y)}},lt=e=>{for(let t,o=0;t=y[o];o++){let o=Oe(e,t),n=Re(o),i=e.r+t.r;if(n<1.4*i){o=je(o,.06);let n=p(e.x-t.x),r=p(e.y-t.y);n>r&&n<i&&(e.v.x=-o.x),r>n&&r<i&&(e.v.y=-o.y)}}},ut=()=>{let e=k.heroes.filter((e=>"M"===e.tagName));if(0===e.length)return ke("You have no wizards."),!1;let t=0;return e.map((e=>{e.classList.add("cast-rgn"),setTimeout((()=>e.classList.remove("cast-rgn")),2e3),k.heroes.map((o=>{Re(Oe(e,o))<4&&o.life<o.lifeOrig&&(o.life++,ft(o),t++)}))})),ze(1,0===t?"No hero regenerated.":1===t?"One hero regenerated.":t+" heroes regenerated."),!0},st=()=>0===k.heroes.filter((e=>"M"===e.tagName)).length?(ke("You have no wizards."),!1):(F=!0,A.classList.add("frozen"),setTimeout((()=>{F=!1,A.classList.remove("frozen")}),5e3),!0),at=(e,t)=>{let o=[e.tagName,t.tagName].sort().join("");return"EU"===o||"EM"===o},ct=e=>{e.life<=0||(qe=!0,e.life--,ft(e),e.life<=0&&dt(e,!0))},ft=e=>{e.className=e.className.replace(/life./,"life"+(e.life<=0?0:1+~~(5*e.life/e.lifeOrig)))},dt=(e,t)=>{e.life=0,ft(e),queueMicrotask((()=>k[e.group]=k[e.group].filter((t=>t!==e)))),setTimeout((()=>e.parentNode&&e.remove()),4e4),"E"===e.tagName&&t&&bt(e.lifeOrig,!0),e===E&&mt()},mt=()=>{I=!0,ke("The Lord of Death has vanished, now all undead slaves will dismantle in the ground.");let e=0;k.enemies.map((t=>{t.life&&setTimeout((()=>dt(t)),333*++e)})),setTimeout(ht,333*e+2e3)},ht=()=>{if(!N)return;let e=660,t=100;for(let o=0;o<3;o+=1.1){for(let n=0;n<3;n++)H(e+(o+n)*t,o+.175*n,1,.25),H(5*(e+(o+n)*t),o+.175*n,.2,.25);H(e+(o+4)*t,o+.525,1,.8+o/4),H(5*(e+(o+4)*t),o+.525,.2,.8+o/4)}let o=Date.now()-u,n=~~(o/6e4),i=~~((o-6e4*n)/1e3),l=ke("Celebrate! You Win!",{noRemove:1,top:5,class:"win"}),s=escape(`I took ${n} minutes and ${i} seconds to finish the Dungeon Puzzle, on ${r} mode! https://js13kgames.com/entries/dungeon-puzzle #js13k`);l.innerHTML+=`<br>\n  <a target="_blank" href="https://twitter.com/intent/tweet?text=${s}">Share with your friends <b>🐦</b></a>\n  `,gt()},pt=()=>{wt("Your time is over."),U()},wt=e=>{N&&(ke(e),S.classList.add("gameover"),Pe.map((e=>{e.style.transition=1+w()+"s",e.style.transform=`translate(${w(4)-2}em,${w(4)-2}em)`})),T("article p").map((e=>{e.style.transition=1+w()+"s",e.style.transform=`translate(${w(.4)-.2}em,${w(.4)-.2}em) rotate(${w(.4)-.2}turn)`})),gt())},gt=()=>{N=!1,b("ctrl").style.pointerEvents="none",b("article").style.pointerEvents="none"};window.giveUp=()=>{confirm("Are you sure?")&&wt("I give up!")};let bt=(e=0,t)=>{if(t)for(let e=0;e<4;e++)H(2e3,.5+e/20,.6,.5),H(8e3,.5+e/20,.1,.5);j+=e,b("gold").innerHTML=`<b>🪙</b> ${j} coins`};function Tt(e,t){return{N:(n[t-1]||[])[e],S:(n[t+1]||[])[e],E:(n[t]||[])[e+1],W:(n[t]||[])[e-1]}}console.log("Hi smart user, you can run %c addGold(<num>) %c and buy more pieces.","background:#000;color:#FFF",""),window.addGold=bt;let vt="";function $t(o,i,r){if(vt="",void 0===i||void 0===r)return!1;if((n[r]||[])[i])return!1;let l=Tt(i,r);if(vt="Piece side must be flat to fit the puzle border.",0===i&&"-"!==o.W)return!1;if(i===e-1&&"-"!==o.E)return!1;if(0===r&&"-"!==o.N)return!1;if(r===t-1&&"-"!==o.S)return!1;if(vt="A flat side must not be faced inside the puzzle.",i>0&&"-"===o.W)return!1;if(i<e-1&&"-"===o.E)return!1;if(r>0&&"-"===o.N)return!1;if(r<t-1&&"-"===o.S)return!1;if(vt="This piece can NOT be connected here.",!xt(o,"S",l.S,"N"))return!1;if(!xt(o,"N",l.N,"S"))return!1;if(!xt(o,"E",l.E,"W"))return!1;if(!xt(o,"W",l.W,"E"))return!1;let u=R(l).map((e=>e.terrain));return o.terrain===a&&u.includes(f)||o.terrain===f&&u.includes(a)?(vt="You can NOT connect a building to a cavern.",!1):(vt="",!0)}function xt(e,t,o,n){return!(!e||o)||"fm"===[e[t],o[n]].sort().join("")}