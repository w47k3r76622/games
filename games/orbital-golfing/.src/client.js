(()=>{window.addEventListener("load",(async()=>{f(),k()}),!1);let e=e=>document.getElementById(e),t=(e,t)=>{e.style.display=t?"flex":"block"},n=e=>{e.style.display="none"},a=e=>document.createElement(e),l=(e,t)=>{e.innerHTML=t},i=(e,t)=>t?{blue:"#005",red:"#500",grey:"black",orange:"#563903",yellow:"brown",purple:"#340667",green:"#020"}[e]??e:{blue:"#bbf",red:"#fbb",green:"#bfb",purple:"#b52db5"}[e]??e,o=e=>`color: ${i(e,!0)}; background: ${i(e)}`,r=(e,t)=>{let{x:n,y:l}=me(e,t),i=Te();if(i){let e=a("div");e.className="expl",e.style.position="absolute",e.style.left=n-50+"px",e.style.top=l-50+"px",i.appendChild(e),setTimeout((()=>{e.remove()}),4e3)}},s=e=>{Se().innerHTML="ERROR: "+e,I()},c=[.75,1,1.25,1.5,1.75,2],d=()=>({angleDeg:te(),power:le(),ms:4e3}),h=()=>{let e=$();if(e){let t=z(e),{x:n,y:a}=me(t.x,t.y),l=Ye();_(n-l.width/2,-(a-l.height/2),.5)}},u=0,m=0,y=null,p=!1,g=+new Date,b=Math.PI,v=function(e,t){let n=W();n&&n.on(e,(e=>{let n=JSON.parse(e);t(n)}))},f=()=>{let e=console.shared,t=window.io({upgrade:!1,transports:["websocket"]});J(t),t.on("disconnect",(()=>{s("Disconnected!")})),t.on("error",(e=>{s("Socket error.")})),v(e.G_S_CONNECTED,(async e=>{V(e.socketId),Z(e.id),he({activePane:"menu"}),$e()})),v(e.G_S_LOBBIES_UPDATED,(e=>{ue(e.lobbies)})),v(e.G_S_GAME_STARTED,(e=>{let t=e.game;B(t);let n=Ye();n.width=t.width*U().G_SCALE*2,n.height=t.height*U().G_SCALE*2,he({lobbyId:"",activePane:"game"}),ze("start"),ne(0,!0),ie(1,!0),h(),$e(),(()=>{let e=+new Date,t=e;(n=>{u=+new Date,m=0,y=()=>{let n=$();if(n){e=+new Date;let a=e-t;t=e,U().simulate(n,{nowDt:a}),we(n),P(n)}},p=!0;let a=()=>{let e=+new Date;m=e-u,u=e,y&&y(),p&&requestAnimationFrame(a)};requestAnimationFrame(a)})()})()})),v(e.G_S_GAME_UPDATED,(e=>{$()&&Y(e.game)})),v(e.G_S_GAME_ROUND_COMPLETED,(e=>{let t=$();t&&(t.scorecard=e.game.scorecard,Ee().innerHTML="Angle 0",he({entityActive:!1,roundCompleted:!0}),$e())})),v(e.G_S_GAME_ROUND_STARTED,(e=>{let t=e.game;B(t);let n=Ye();n.width=t.width*U().G_SCALE*2,n.height=t.height*U().G_SCALE*2,he({entityActive:!1,roundCompleted:!1}),ne(0,!0),ie(1,!0),$e(),h()})),v(e.G_S_GAME_COMPLETED,(e=>{let t=$();t&&(t.scorecard=e.game.scorecard),ze("end"),he({activePane:"summary"}),$e()})),v(e.G_S_GAME_PLAYER_DISCONNECTED,(e=>{let t=$();if(t){let n=e.playerId,a=U().getEntity(t,n);a&&(a.disconnected=!0)}}))},w=async function(e,t){let n=e+"?"+Object.keys(t??{}).map((e=>encodeURIComponent(e)+"="+encodeURIComponent(t?.[e]??""))).join("&"),a={"Content-Type":"application/json",socketid:F()};return await fetch(n,{headers:a}).then((function(e){if(!e.ok)throw Error(e.statusText);return e})).then((e=>e.json())).catch((e=>({error:e.message})))},E={x:0,y:0,prevX:0,prevY:0,mx:0,my:0,scale:1,panning:!1,zooming:!1,touchStartX:0,touchStartY:0,touchDist:0},x="transform 200ms ease-out",_=async(e,t,n)=>{E.x=e,E.y=t,E.scale=1,D(),await new Promise((e=>setTimeout(e,200))),E.mx=window.innerWidth/2,E.my=window.innerHeight/2,C(n)},C=e=>{let[t,n]=S(E.mx,E.my);E.scale=e;let[a,l]=M(t,n),i=E.my-l;E.x-=E.mx-a,E.y+=i,D()},S=(e,t)=>{let n=window.innerWidth,a=window.innerHeight;return[Math.round((E.x+e-n/2)/E.scale),Math.round((E.y+a/2-t)/E.scale)]},M=(e,t)=>{let n=window.innerWidth,a=window.innerHeight;return[Math.round(n/2+E.scale*e-E.x),Math.round(a/2-E.scale*t+E.y)]},A=e=>{let{clientX:t,clientY:n}=e[1],{clientX:a,clientY:l}=e[0];return{center:((e,t,n,a)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,a)+Math.abs(a-t)/2}))(t,n,a,l),d:((e,t,n,a)=>Math.round(Math.sqrt(Math.pow(n-e,2)+Math.pow(a-t,2))))(t,n,a,l)}},k=()=>{let e=Re();e.style.transition=x,e.addEventListener("mousedown",(e=>{0===e.button&&(Re().style.transition="unset",e.preventDefault(),E.panning=!0,E.touchStartX=e.clientX,E.touchStartY=e.clientY,E.prevX=E.x,E.prevY=E.y,D())})),e.addEventListener("mouseup",(e=>{0===e.button&&(Re().style.transition=x,E.panning=!1,E.zooming=!1)})),e.addEventListener("mouseleave",(()=>{E.zooming=!1,E.panning=!1})),e.addEventListener("mousemove",(e=>{if(E.mx=e.clientX,E.my=e.clientY,E.panning){let t=e.clientY-E.touchStartY;E.x=E.prevX-(e.clientX-E.touchStartX),E.y=E.prevY+t,D()}})),e.addEventListener("touchstart",(e=>{e.preventDefault();let t=e.touches,n=t.length;if(n){if(Re().style.transition="unset",E.panning=!0,n>=2){E.zooming=!0;let{center:{x:e,y:n},d:a}=A(t);E.touchDist=a,E.touchStartX=e,E.touchStartY=n}else E.touchStartX=t[0].clientX,E.touchStartY=t[0].clientY;E.prevX=E.x,E.prevY=E.y,D()}})),e.addEventListener("touchend",(e=>{0===e.touches.length&&(Re().style.transition=x,E.panning=!1,E.zooming=!1)})),e.addEventListener("touchmove",(e=>{let t=e.touches;if(E.panning||E.zooming){let n=0,a=0;if(t.length>=2){let{center:{x:e,y:n},d:a}=A(t);if(Math.abs(a-E.touchDist)>2){let t=.042,l=E.scale+(a<E.touchDist?-t:t);l<.25?l=.25:l>1.5&&(l=1.5),E.mx=e,E.my=n,C(l),E.touchDist=a}}else if(!E.zooming){let t=e.touches[0];n=t.clientX-E.touchStartX,a=t.clientY-E.touchStartY,E.x=E.prevX-n,E.y=E.prevY+a,D()}}}));let t=e=>{let t=E.scale+(Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))<0?-.15:.15);t<.5?t=.5:t>1.5&&(t=1.5),C(t)};e.addEventListener("DOMMouseScroll",t,!1),e.addEventListener("mousewheel",t,!1)},D=()=>{let e=Re(),t=window.innerWidth,n=window.innerHeight;e.style.transform=`translate(${t/2-4e3-E.x}px, ${n/2-4e3+E.y}px) scale(${E.scale})`};document.addEventListener("touchmove",(function(e){void 0!==(e=e.originalEvent||e).scale&&1!==e.scale&&e.preventDefault()}),!1);let L,G,R,T=(e,t)=>{let n=H(e),a=z(n);a.active=!0,a.vx=55e3*t.power*Math.sin(U().toRadians(t.angleDeg)),a.vy=55e3*t.power*Math.cos(U().toRadians(t.angleDeg)),a.angle=t.angleDeg;let l=12;t.power>1&&(l=11),t.power>1.5&&(l=10);let i=[];for(let e=0;e<l;e++){U().simulate(n,{nowDt:75});let{x:e,y:t}=me(a.x,a.y);if(i.push([e,t]),n.collisions.length)break}return i},Y=e=>{let t=$();if(t){e.collisions.forEach((([e,n])=>{let a=U().getEntity(t,e),l=U().getEntity(t,n);a&&("flag"===l?.type?ze(1===a.shotCt?"holeInOne":"completed"):"coin"===l?.type?(e===Q()&&ze("coin"),r(l.x,l.y)):(ze("expl"),r(a.x,a.y)))}));for(let n in e.entityMap)t.entityMap[n]=e.entityMap[n];!z(t).active&&de().entityActive&&(he({entityActive:!1}),$e())}},P=e=>{},O=()=>{n(Ce()),n(Se()),n(Me()),n(Ae()),n(ke()),n(Re()),n(De()),n(Le()),n(Ge()),Oe().style.height="unset"},N=()=>{O(),t(Ce())},I=()=>{O(),t(Se())};G=.3,L=(e=1,t=.05,n=220,a=0,l=0,i=.1,o=0,r=1,s=0,c=0,d=0,h=0,u=0,m=0,y=0,p=0,g=0,b=1,v=0,f=0)=>{let w,E,x=Math,_=44100,C=2*x.PI,S=s*=500*C/_/_,M=n*=(1-t+2*t*x.random(t=[]))*C/_,A=0,k=0,D=0,L=1,T=0,Y=0,P=0;for(c*=500*C/_**3,y*=C/_,d*=C/_,h*=_,u=_*u|0,E=(a=_*a+9)+(v*=_)+(l*=_)+(i*=_)+(g*=_)|0;D<E;t[D++]=P)++Y%(100*p|0)||(P=o?1<o?2<o?3<o?x.sin((A%C)**3):x.max(x.min(x.tan(A),1),-1):1-(2*A/C%2+2)%2:1-4*x.abs(x.round(A/C)-A/C):x.sin(A),P=(u?1-f+f*x.sin(C*D/u):1)*(0<P?1:-1)*x.abs(P)**r*e*G*(D<a?D/a:D<a+v?1-(D-a)/v*(1-b):D<a+v+l?b:D<E-g?(E-D-g)/i*b:0),P=g?P/2+(g>D?0:(D<E-g?1:(E-D)/g)*t[D-g|0]/2):P),w=(n+=s+=c)*x.cos(y*k++),A+=w-w*m*(1-1e9*(x.sin(D)+1)%2),L&&++L>h&&(n+=d,M+=d,L=0),!u||++T%u||(n=M,s=S,L=L||1);return(e=R.createBuffer(1,E,_)).getChannelData(0).set(t),(n=R.createBufferSource()).buffer=e,n.connect(R.destination),n.start(),n},R=new(window.AudioContext||webkitAudioContext);let X=null,$=()=>X,B=e=>X=e,z=e=>U().getEntity(e,Q()),H=e=>JSON.parse(JSON.stringify(e)),U=()=>console.shared,j=null,W=()=>j,J=e=>j=e,q="",F=()=>q,V=e=>q=e,K="",Q=()=>K,Z=e=>K=e,ee=0,te=()=>ee,ne=(e,t)=>{ee=e,t&&(xe().value=e)},ae=0,le=()=>c[ae]??1,ie=(e,t)=>{ae=e,t&&(_e().value=e)},oe=[],re=e=>oe=e,se=e=>e.id===Q(),ce={lobbies:[],name:"Player",activePane:"loading",lobbyId:"",entityActive:!1,roundCompleted:!1},de=()=>ce,he=e=>{Object.assign(ce,e)},ue=e=>{he({lobbies:e}),["menu","lobby"].includes(ce.activePane)&&$e()},me=(e,t)=>{let{width:n,height:a}=(e=>{let t=Pe().canvas;{let{left:e,top:n}=t.getBoundingClientRect();return{left:e,top:n,width:t.width,height:t.height}}})();return{x:Math.round(e*U().G_SCALE+n/2),y:Math.round(-t*U().G_SCALE+a/2)}},ye=(e,t,n,a)=>{let l=Pe();l.beginPath(),l.arc(e,t,n,0,2*b,!1),l.fillStyle=a,l.fill()},pe={font:"monospace",color:"#fff",size:16,align:"center",strokeColor:""},ge=(e,t,n,a)=>{let{font:l,size:i,color:o,align:r,strokeColor:s}={...pe,...a||{}},c=Pe();c.font=`${i}px ${l}`,c.fillStyle=o,c.textAlign=r,c.textBaseline="middle",c.fillText(e,t,n),s&&(c.strokeStyle=s,c.lineWidth=.5,c.strokeText(e,t,n))},be=(e,t,n,a,l,i)=>{let o=Pe();if(o.save(),o.beginPath(),o.translate(e,t),o.fillStyle=l,void 0!==i){let e=n/2;o.translate(e,a/2),o.rotate(i*b/180),o.fillRect(-e,-a/1.5,n,a)}else o.fillRect(0,0,n,a);o.restore()},ve=+new Date,fe=0,we=e=>{let{players:t,planets:n,flags:a,coins:l}=e,o=Pe();o.clearRect(0,0,o.canvas.width,o.canvas.height),u-g>1e3&&(g=+new Date),(e=>{let t=U().G_SCALE;for(let n=0;n<e.length;n++){let{x:a,y:l,r:i,color:o}=e[n],{x:r,y:s}=me(a,l);ye(r,s,i*t,o)}})(n.map((t=>U().getEntity(e,t)))),(e=>{let t=U().G_SCALE;for(let n=0;n<e.length;n++){let a=e[n],{x:l,y:o,r:r,color:s,finished:c,disconnected:d}=a;if(c||d)continue;let h=a.angle;a.id===Q()&&(h=te());let{x:u,y:m}=me(l,o),y=2*r*t-10,p=y/2;ye(u,m,r*t,s),be(u-p,m-p,y,y,i(s,!0)),be(u-5,m-30,10,60,"white",U().getHeadingTowards(u,m,u+Math.sin(U().toRadians(h)),m-Math.cos(U().toRadians(h)))),ye(u,m,p/1.5,i(s)),ge(a.name,u,m-y-32,{size:32})}})(t.map((t=>U().getEntity(e,t)))),(e=>{let t=+new Date;t-ve>500&&(fe=(fe+1)%2,ve=t);let n=U().G_SCALE;for(let t=0;t<e.length;t++){let a=e[t],{x:l,y:i,r:o}=a,{x:r,y:s}=me(l,i),c=o*n;ye(r,s,c,"orange"),ye(r,s,c-4,"white"),be(r-c/6-10,s-c,c/3,2*c,"black");{let e=r-c/6-10,t=s-c,n=40,a=30;1===fe?(be(e,t,n,a,"black"),be(e+2,t+2,n-4,a-4,"orange")):(be(e,t,n,a,"black",359),be(e+2,t+2,n-4,a-4,"orange",359))}ge("Shoot here!",r,s-c-32,{size:32})}})(a.map((t=>U().getEntity(e,t)))),(e=>{let t=U().G_SCALE;for(let n=0;n<e.length;n++){let a=e[n],{x:l,y:i,r:o,removed:r}=a;if(r)continue;let{x:s,y:c}=me(l,i),d=o*t;ge("Shot -1",s,c-d-32,{size:32});let h=Pe();h.save(),1===fe&&(h.translate(s,c),h.scale(.5,1),h.translate(-s,-c)),ye(s,c,d,"black"),ye(s,c,d-2,"yellow"),ye(s,c,d-4,"brown"),ye(s,c,d-6,"yellow"),h.restore()}})(l.map((t=>U().getEntity(e,t))));let r=z(e);r.active||r.finished||(e=>{for(let t=0;t<e.length;t++){let[n,a]=e[t];ye(n,a,5,"rgba(255,255,255,0.25)")}})(oe)},Ee=()=>e("game-angle-label"),xe=()=>e("game-angle"),_e=()=>e("game-power"),Ce=()=>e("loading"),Se=()=>e("error"),Me=()=>e("menu"),Ae=()=>e("lobby"),ke=()=>e("game-ui"),De=()=>e("game-ui-top"),Le=()=>e("game-ui-mid"),Ge=()=>e("summary"),Re=()=>e("game"),Te=()=>e("game-inner"),Ye=()=>e("canv"),Pe=()=>Ye().getContext("2d"),Oe=()=>e("center"),Ne=t=>{let n=e("menu-lobbies");l(n,""),t.length?t.forEach((e=>{n.appendChild((e=>{let t=document.createElement("div");t.className="pane flex-hz pane-secondary";let n=document.createElement("button");return n.style.width="80%",n.className="secondary",n.innerText=`${e.name} (${e.players.length})`,n.onclick=()=>{ze("click"),(async(e,t)=>{N();let n=(await w(U().G_R_LOBBY_JOIN,{lobbyId:e,playerName:t})).data?.lobby;n?(he({activePane:"lobby",lobbyId:n.id}),$e()):(s("Lobby full."),setTimeout((()=>{he({activePane:"menu"}),$e()}),2e3))})(e.id,ce.name)},t.appendChild(n),t})(e))})):l(n,'<div style="text-align: center">There are no lobbies right now.</div>')},Ie=()=>{let i=$();if(!i)return;let r=z(i);ke().style.display=ce.entityActive||r.finished?"none":"block",e("game-shoot").onclick=()=>{ze("click"),(async()=>{he({entityActive:!0}),(await w(U().G_R_GAME_SHOOT,d())).error&&he({entityActive:!1}),$e()})(),$e()};let s=e("game-prev");s.onclick=()=>{ze("click"),(async()=>{await w(U().G_R_GAME_PREV),$e()})(),$e()},s.disabled=0===r.posHistoryI;let u=xe();u.oninput=e=>{let t=+e.target.value;ne(t),Ee().innerHTML="Angle "+t,re(T(i,d()))},u.onchange=()=>{(async()=>{await w(U().G_R_GAME_SET_ANGLE,{angleDeg:d().angleDeg})})()};let m=_e();m.max=c.length-1,m.oninput=e=>{ie(+e.target.value),re(T(i,d()))},re(T(i,d()));let y=De();l(y,"");let p=a("div");l(p,`You are the <span style="${o(r.color)}">${r.color.toUpperCase()}</span> Player.`),p.className="game-line",y.appendChild(p);let g=a("div");l(g,r.finished?"Finished!":`You are on shot number ${r.shotCt+1}.`),y.appendChild(g);let b=a("div");l(b,"Center on player."),b.className="link game-line",b.onclick=()=>{h()},y.appendChild(b);let v=Le();if(l(v,""),r.finished?t(v,!0):n(v),ce.roundCompleted){Xe(v);let e=a("div");l(e,"Next round starting soon..."),v.appendChild(e)}else{let e=a("div");l(e,`You shot a ${r.shotCt}.`),e.style["font-size"]="42px",v.appendChild(e)}},Xe=e=>{let t=$();if(!t)return;let n=a("table"),i=a("thead"),r=a("tr");for(let e=0;e<t.numRounds+2;e++){let n=a("th");l(n,e===t.numRounds+1?"Total":0===e?"Name":"Rd "+e),r.appendChild(n)}i.appendChild(r),n.appendChild(i),t.players.map((e=>U().getEntity(t,e))).forEach((e=>{if(e.disconnected)return;let i=a("tr"),r=t.scorecard[e.id],s=a("td");l(s,`<div style="${o(e.color)}">${e.name}</div>`),i.appendChild(s);let c=0;for(let e=0;e<t.numRounds;e++){let t=a("td");c+=r[e]??0,l(t,(r[e]??"_")+""),i.appendChild(t)}let d=a("td");l(d,c+""),i.appendChild(d),n.appendChild(i)})),e.appendChild(n)},$e=()=>{let n=de();switch(n.activePane){case"loading":N();break;case"menu":O(),t(Me()),(()=>{let t=de();Ne(t.lobbies);let n=e("menu-name");n.value=t.name,n.onblur=e=>{he({name:e.target.value})},e("menu-create").onclick=()=>{ze("click"),(async(e,t)=>{N();let n=(await w(U().G_R_LOBBY_CREATE,{lobbyName:e,playerName:t})).data?.lobby;n&&he({activePane:"lobby",lobbyId:n.id}),$e()})(de().name+"'s Game",de().name)}})();break;case"lobby":{let a=n.lobbies.find((e=>e.id===n.lobbyId));a&&(O(),t(Ae()),(t=>{e("lobby-name").innerHTML=t.name;let n=t.players.reduce(((e,t,n)=>e+((e,t)=>`<div class="pane pane-secondary">${t+1}. <span class="${se(e)?"underlined":""}">${e.name}</span></div>`)(t,n)),""),a=e("lobby-players");l(a,n);let i=e("lobby-start");i.disabled=!se(t.players[0]),i.onclick=()=>{ze("click"),(async()=>{N(),await w(U().G_R_LOBBY_START)})()},e("lobby-leave").onclick=()=>{ze("click"),(async()=>{N(),(await w(U().G_R_LOBBY_LEAVE)).error||he({activePane:"menu",lobbyId:""}),$e()})()}})(a));break}case"summary":O(),t(Ge()),(()=>{let t=e("summary-score");l(t,""),Xe(t),e("summary-next").onclick=()=>{ze("click"),he({activePane:"menu"}),$e()}})();break;case"game":O(),t(ke()),t(De()),t(Re(),!0),Oe().style.height="100%",Ie(),D()}},Be={click:[1.42,0,136,.01,.04,0,1,1.15,,,-520,,.02,,10,,.01,,.01,.15],cancel:[[2.32,0,188,.03,.03,0,1,1.11,,-.1,,,,,,.4,.19,.59,.02]],start:[2.06,0,280,.03,.21,.04,1,2.02,,,-820,.07,.23,.1,,.1,.33,,,.36],end:[1.99,0,734,.08,.06,.02,1,.03,,,-287,,.04,,,,.24,,.1],expl:[,0,499,,.22,.36,3,2.17,.5,,,,,.3,,.7,,.9,.02,.25],completed:[,0,1732,.08,,.02,,.26,,20,-402,.08,,,,,,.49,.03],holeInOne:[1.25,0,355,.18,.01,.15,2,.01,,53,-79,.18,,.7,-2.1,,.12,,.12,.02],coin:[1.01,0,1493,,.08,.24,1,.26,,,163,.08,,,,,,.51,.02,.12]},ze=e=>{let t=Be[e];t&&(G=.3,L(...t))}})();