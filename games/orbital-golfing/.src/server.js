(()=>{function e(){return console.shared}function t(e,t){H[e]=async(e,s)=>{try{let r=D(e.headers.socketid),a=await t({req:e,res:s,player:r},e.query);s.send({data:a})}catch(e){s.send({error:e.message})}}}var s=[{name:"test",holes:[{width:159573333e4,height:159573333e4,par:2,planets:[{x:8776533e4,y:-5585067e4,r:394944e6,mass:8850018724661703e16}],flags:[{x:61834667e4,y:71409067e4}],coins:[],start:[-801856e6,-753984e6]},{width:159573333e4,height:159573333e4,par:2,planets:[{x:-80855808e4,y:83187972e4,r:26529067e4,mass:38829152206245384e15},{x:6122829e4,y:-18130124e4,r:55078731e4,mass:1715163962187223e17}],flags:[{x:-61249033e4,y:-120413239e4}],coins:[{x:92552533e4,y:-98536533e4},{x:-127259733e4,y:126062933e4}],start:[50180528e4,118971349e4]},{width:223402667e4,height:223402667e4,par:2,planets:[{x:46509643e4,y:75234837e4,r:54201077e4,mass:1662415500999831e17},{x:81115913e4,y:-4943143e5,r:26728533e4,mass:39446663241074786e15},{x:-105727706e4,y:22240533e4,r:26130133e4,mass:37608354165744676e15},{x:-109683329e4,y:-118850019e4,r:30164746e4,mass:5082199597864638e16}],flags:[{x:112454121e4,y:-133976175e4}],coins:[{x:-4225196e5,y:-44824548e4},{x:159633572e4,y:164295108e4},{x:-10749525e4,y:-94846666e4},{x:-186761039e4,y:-40989868e4},{x:70744178e4,y:-165424356e4},{x:143616e6,y:531911e4}],start:[-113020606e4,122029318e4]},{width:127658667e4,height:319146667e4,par:2,planets:[{x:70236176e4,y:-263726841e4,r:26728533e4,mass:39446663241074786e15},{x:55200058e4,y:198633958e4,r:26130133e4,mass:37608354165744676e15},{x:-61521197e4,y:6745829e4,r:41334788e4,mass:9705354540538727e16}],flags:[{x:0,y:254785422e4}],coins:[{x:-70274343e4,y:285429779e4},{x:71276089e4,y:288295822e4}],start:[-82411402e4,-273115837e4]},{width:287232e7,height:223402667e4,par:2,planets:[{x:-235536224e4,y:168983971e4,r:33855477e4,mass:6456431467178306e16},{x:-159151062e4,y:102158848e4,r:30164746e4,mass:5082199597864638e16},{x:-91355733e4,y:4673688e5,r:32159412e4,mass:580558348755677e17},{x:-9175467e4,y:-3697945e4,r:38642677e4,mass:8466313736577377e16}],flags:[{x:27880254e4,y:170809091e4}],coins:[{x:-137464049e4,y:-178068082e4},{x:230643706e4,y:177060775e4},{x:-87876636e4,y:172704423e4},{x:240097628e4,y:-181946512e4},{x:335104e6,y:-176328533e4},{x:2249984e6,y:1595733e4},{x:-51861333e4,y:-1747328e6},{x:134839467e4,y:-173934933e4}],start:[-258232339e4,-117330881e4]}]}];let r=e=>s.find((t=>t.name===e)),a=[],i=e=>({...e,intervalMs:void 0,intervalId:void 0,broadcastMs:void 0,broadcastId:void 0,broadcastCt:void 0}),o=(e,t)=>{e.players.map(S).forEach((s=>{s?.socket&&I(s.socket,t,{game:i(e)})}))},l=t=>{let s={entityMap:{},id:t.id,i:t.broadcastCt,collisions:t.collisions,round:t.round,timestamp:+new Date};for(let e in t.entityMap){let r=t.entityMap[e];r.mark&&(s.entityMap[e]={...r,posHistory:void 0,mark:void 0},r.mark=!1)}(0!==Object.keys(s.entityMap).length||s.collisions.length)&&(t.broadcastCt++,t.players.map(S).forEach((t=>{t?.socket&&I(t.socket,e().G_S_GAME_UPDATED,{game:s})})))},n=(t,s)=>{let a=r(t.courseName);if(a){let r=a.holes[s];if(t.width=r.width,t.height=r.height,t.planets=[],t.flags=[],t.coins=[],!r)throw 0;t.round=s,r.planets.forEach((e=>{p(t,e.x,e.y,e.mass??25*10**30,e.r,e.color??"#243F72")})),r.flags.forEach((e=>{c(t,e.x,e.y)})),r.coins.forEach((e=>{h(t,e.x,e.y)})),t.players.map((s=>e().getEntity(t,s))).forEach(((e,t)=>{e.disconnected||(e.x=r.start[0]+t*e.r*4,e.y=r.start[1],e.active=!1,e.finished=!1,e.angle=0,e.posHistory=[[e.x,e.y]],e.posHistoryI=0,e.shotCt=0)}))}},d=e=>{let t=a.indexOf(e);(e=>{clearInterval(e.intervalId),clearInterval(e.broadcastId)})(e),t>-1&&(a.splice(t,1),e.players.map(S).forEach((e=>{e?.gameId&&(e.gameId="")})),x(e))},y=(t,s)=>{let r={id:s,type:"",x:0,y:0,r:e().fromPx(25),vx:0,vy:0,ax:0,ay:0,t:0,mass:1,mark:!0};return t.entityMap[r.id]=r,r},p=(e,t,s,r,a,i)=>{let o=y(e,"planet_"+L());o.type="planet",o.mass=r,o.x=t,o.y=s,o.r=a,o.mass=r,o.color=i,JSON.stringify(o,null,2),e.planets.push(o.id)},c=(t,s,r)=>{let a=y(t,"flag_"+L());a.type="flag",a.x=s,a.y=r,a.r=e().fromPx(30),JSON.stringify(a,null,2),t.flags.push(a.id)},h=(t,s,r)=>{let a=y(t,"coin_"+L());a.type="coin",a.x=s,a.y=r,a.r=e().fromPx(30),a.removed=!1,JSON.stringify(a,null,2),t.coins.push(a.id)},m=(t,s)=>{let r=e().getEntity(t,s.id);if(!r)throw 1;if(r.finished)throw 2;return r},f=(e,t)=>{if(e.roundFinished)throw 3;if(t.finished||t.active)throw 4},g=(e,t)=>{f(e,t);let s=t.posHistoryI,r=t.posHistory[s-1];r&&(t.posHistory.splice(s,1),t.posHistoryI--,t.x=r[0],t.y=r[1],t.shotCt++,t.mark=!0)},u=e=>a.find((t=>t.id===e)),x=e=>`Game { id=${e.id} }`,I=function(e,t,s){e.emit(t,JSON.stringify(s))},_=e=>{if(!e.player)throw 6;return e.player},b=[],E=()=>{var t,s;t=e().G_S_LOBBIES_UPDATED,s={lobbies:b.map((e=>({...e,playerIds:void 0,players:e.playerIds.map((e=>({...S(e),socket:void 0})))})))},k.forEach((e=>{e.socket&&I(e.socket,t,s)}))},w=e=>{let t=b.indexOf(e);if(!(t>-1))throw 8;b.splice(t,1),e.playerIds.forEach((e=>{let t=S(e);t&&(t.lobbyId="")})),O(e)},v=(e,t)=>{if(t.lobbyId)throw C(t),9;if(e.playerIds.length>=4)throw 10;e.playerIds.push(t.id),t.lobbyId=e.id,O(e),C(t),E()},M=(e,t)=>{let s=e.playerIds.indexOf(t.id);s>-1&&e.playerIds.splice(s,1),t.lobbyId="",O(e),C(t),0===e.playerIds.length&&w(e),E()},G=e=>b.find((t=>t.id===e)),O=e=>`Lobby { ${e.name} (id=${e.id}) [playerIds=${e.playerIds.join(",")}]}`,k=[],S=e=>k.find((t=>t.id===e)),D=e=>k.find((t=>t?.socket?.id===e)),N=(e,t)=>{if(t.length>12)throw 13;e.name=P(t)},C=e=>`Player { name=${e.name} (id=${e.id}) [socketId=${e?.socket?.id}] }`,T=e=>{let t=u(e.gameId);if(!t)throw 15;return t},A={};var R;R=t=>{let s=t.player;if(s){if(C(s),(e=>{let t=k.indexOf(e);if(C(e),!(t>-1))throw 12;k.splice(t,1)})(s),s.lobbyId){let e=G(s.lobbyId);e&&M(e,s)}if(s.gameId){let t=u(s.gameId);t&&(((t,s)=>{m(t,s).disconnected=!0,((t,s)=>{t.players.map(S).forEach((t=>{t?.socket&&I(t.socket,e().G_S_GAME_PLAYER_DISCONNECTED,{playerId:s})}))})(t,s.id)})(t,s),(e=>{let t=e.players.map(S);for(let e=0;e<t.length;e++)if(t[e]?.connected)return!0;return!1})(t)||d(t))}}},A.disconnect=(e,t)=>{try{R({socketId:e.id,player:D(e.id)})}catch(e){}},Object.assign(module.exports,{io:t=>{for(let e in A)t.on(e,(s=>A[e](t,s)));let s=((e,t)=>{let s=D(e.id);if(s)throw C(s),11;let r={id:L(),name:t||"",socket:e,gameId:"",lobbyId:"",connected:!0};return k.push(r),C(r),r})(t,L());I(t,e().G_S_CONNECTED,{id:s.id,socketId:t.id}),E(),C(s)}});let H={};t(e().G_R_LOBBY_CREATE,((e,t)=>{let s=_(e);return N(s,t.playerName),{lobby:((e,t)=>{if((e=e.trim()).length>20||0===e.length)throw 7;e=P(e);let s={id:"lobby_"+L(),playerIds:[],name:e};return O(s),b.push(s),v(s,t),s})(t.lobbyName,s)}})),t(e().G_R_LOBBY_START,(t=>{let s=_(t),p=null;if(s.lobbyId&&(p=G(s.lobbyId)),!p)throw C(s),16;let c=((t,s)=>{let p="test",c=r(p),h={id:L(),courseName:p,lobbyId:t,width:0,height:0,entityMap:{},scorecard:s.reduce(((e,t)=>(e[t]=[],e)),{}),timeCreated:+new Date,timeStarted:+new Date,players:[],planets:[],powerups:[],flags:[],coins:[],collisions:[],round:0,numRounds:c.holes.length,roundFinished:!1,intervalMs:25,intervalId:-1,broadcastMs:75,broadcastId:-1,broadcastCt:0};x(h),a.push(h);let m=B(["blue","red","green","yellow","purple","grey","orange"]);return s.forEach(((e,t)=>{let s=S(e);s&&(((e,t,s,r,a,i)=>{let o=y(e,t);o.type="player",o.name=s,o.angle=0,o.power=1,o.coins=0,o.color=i,o.finished=!1,o.active=!1,o.x=0,o.y=0,o.shotCt=0,o.ms=0,o.posHistory=[[0,0]],o.posHistoryI=0,JSON.stringify(o,null,2),e.players.push(t)})(h,e,s.name,0,0,m[t%m.length]),s.gameId=h.id)})),n(h,0),o(h,e().G_S_GAME_STARTED),(t=>{let s=+new Date,a=s;t.intervalId=setInterval((()=>{s=+new Date;let i=s-a;a=s,e().simulate(t,{nowDt:i}),t.collisions.forEach((([s,r])=>{let a=e().getEntity(t,s),i=e().getEntity(t,r);if(!i||"planet"===i.type)return a.active=!1,a.shotCt--,a.posHistoryI++,void g(t,a);if("coin"===i?.type){a.shotCt--,a.shotCt<0&&(a.shotCt=0);let e=a;a.active=!1,e.posHistory.push([e.x,e.y]),e.posHistoryI++,i.removed=!0,i.mark=!0}"flag"===i?.type&&(a.active=!1,a.finished=!0),a.mark=!0}));let y=t.players.map((s=>e().getEntity(t,s))),p=!y.map((e=>!(!e.finished&&!e.disconnected&&(e.active&&s-e.t>e.ms&&(e.active=!1,e.posHistory.push([e.x,e.y]),e.posHistoryI++,e.mark=!0),1)))).includes(!1);t.collisions.length&&(l(t),t.collisions=[]),p&&!t.roundFinished&&(x(t),t.roundFinished=!0,y.forEach((e=>{t.scorecard[e.id].push(e.shotCt)})),setTimeout((()=>{t.round++;let s=r(t.courseName);s&&t.round>=s.holes.length?(o(t,e().G_S_GAME_COMPLETED),d(t)):(n(t,t.round),o(t,e().G_S_GAME_ROUND_COMPLETED),setTimeout((()=>{t.roundFinished=!1,o(t,e().G_S_GAME_ROUND_STARTED)}),5e3))}),3e3))}),t.intervalMs),t.broadcastId=setInterval((()=>{l(t)}),t.broadcastMs)})(h),i(h)})(p.id,p.playerIds);return w(p),E(),{game:c}})),t(e().G_R_LOBBY_JOIN,((e,t)=>{let s=_(e),r=G(t.lobbyId);if(!r)throw 17;return N(s,t.playerName),v(r,s),{lobby:r}})),t(e().G_R_LOBBY_LEAVE,(e=>{let t=_(e),s=(e=>{let t=G(e.lobbyId);if(!t)throw 14;return t})(t);return M(s,t),{lobby:s}})),t(e().G_R_GAME_SET_ANGLE,((e,t)=>{let s=_(e),r=T(s),a=parseInt(t.angleDeg);if([a].map(isNaN).includes(!0))throw 18;return((e,t,s)=>{let r=m(e,t);r.angle=s,r.mark=!0})(r,s,a),{}})),t(e().G_R_GAME_SHOOT,((t,s)=>{let r=_(t),a=T(r),i=parseInt(s.ms),l=parseFloat(s.angleDeg),n=parseFloat(s.power);if([i,l,n].map(isNaN).includes(!0))throw 19;return((t,s,r)=>{let a=m(t,s);f(t,a),((e,t)=>{if(t.power<=.5||t.power>2)throw 5})(0,r),JSON.stringify(r,null,2),a.active=!0;let i=e().toRadians(r.angleDeg);a.vx=55e3*r.power*Math.sin(i),a.vy=55e3*r.power*Math.cos(i),a.angle=r.angleDeg,a.shotCt++,a.t=+new Date,a.ms=r.ms,o(t,e().G_S_GAME_SET_ACTIVE_STATE)})(a,r,{ms:i,angleDeg:l,power:n}),{}})),t(e().G_R_GAME_PREV,(async e=>{let t=_(e);return((e,t)=>{let s=m(e,t);g(e,s)})(T(t),t),await new Promise((e=>setTimeout(e,100))),{}})),Object.assign(module.exports,H);let L=()=>Math.random().toString(36).substr(2,9),P=e=>{let t={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};return e.replace(/[&"<>]/g,(e=>t[e]))},B=e=>{let t=[],s=[...e];for(;s.length;){let e=Math.floor(Math.random()*s.length);t.push(s[e]),s.splice(e,1)}return t}})();