var game,startScreenEl=document.querySelector(".screen-start"),levelEl=document.querySelector(".level"),canvas=document.querySelector("canvas");function startGame(){startScreenEl.classList.add("hidden"),levelEl.classList.remove("hidden"),game.loop()}window.onload=(()=>{canvas.width=document.body.offsetWidth,canvas.height=document.body.offsetHeight,game=new Game(canvas)});var scoreEl=document.querySelector(".score-level_total"),endEl=(levelEl=document.querySelector(".level"),document.querySelector(".end")),specialSreenEl=document.querySelector(".screen-special");class Game{get score(){return this._score}set score(e){this._score=e,scoreEl.innerText=this.score}constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.lvl=new Level(this),this.history=new History,this._score=0,this.isMenuShown=!1,this.showStoryending=!1,endEl.querySelector("button").addEventListener("click",()=>{this.showStoryending?(this.history.addGregToAll(),endEl.classList.add("hidden"),specialSreenEl.classList.remove("hidden")):this.resetLevel()}),specialSreenEl.querySelector("button").addEventListener("click",()=>{delete this.showStoryending,specialSreenEl.classList.add("hidden"),this.resetLevel()})}loop(){this.update(),this.draw(),requestAnimationFrame(()=>this.loop.call(this))}draw(){this.isMenuShown||(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.lvl.render())}update(){this.isMenuShown||this.lvl.update()}updateScore(e){this.score+=e,scoreEl.classList.add("pop"),scoreLevelEl.classList.add("pop"),setTimeout(()=>scoreLevelEl.classList.remove("pop"),1e3),setTimeout(()=>{scoreEl.classList.remove("pop")},210)}resetLevel(){this.score=0,this.lvl=new Level(this),levelEl.classList.remove("hidden"),endEl.classList.add("hidden"),setTimeout(()=>endEl.getElementsByClassName.visibility="hidden",300),this.isMenuShown=!1}gameOver(){this.history.set(this.score),this.history.get()[0].score===this.score?(this.showStoryending=!0,this.setEndButtonText("continue")):this.setEndButtonText("again"),endEl.querySelector("h2").innerText=this.score,endEl.querySelector(".history").innerHTML=this.getHistoryMarkup(),levelEl.classList.add("hidden"),endEl.getElementsByClassName.visibility="visible",endEl.classList.remove("hidden")}getHistoryMarkup(){let e="";return this.history.get().forEach(t=>{e+=`<div><span>${t.score} ${t.name?t.name:""}</span></div>`}),e}setEndButtonText(e){const t=endEl.querySelector("button");t.innerText=e,t.dataset.text=e}}class History{constructor(){this.localStorageKey="scores",this.init()}init(){localStorage.key(this.localStorageKey)||localStorage.setItem(this.localStorageKey,JSON.stringify([{name:"(Greg)",score:1e3}]))}get(){return JSON.parse(localStorage.getItem(this.localStorageKey))}set(e){const t=this.get()||[];e={score:e},4===t.length?t[3]=e:t.push(e),t.sort((e,t)=>t.score-e.score),localStorage.setItem(this.localStorageKey,JSON.stringify(t))}addGregToAll(){const e=this.get();e.forEach(e=>e.name="(Greg)"),localStorage.setItem(this.localStorageKey,JSON.stringify(e))}}var optionsEl=document.querySelector(".options");class OptionsGenerator{createOptions(e,t){let s="";e.options.forEach((e,t)=>{s+=this._makeOption(e,t)}),optionsEl.innerHTML=s,document.querySelectorAll(".option").forEach(e=>{e.addEventListener("click",t)})}_makeOption(e,t){return`\n    <button class="option" data-optionId=${t}>\n      <svg viewBox="0 0 200 200">\n        <rect\n          x="80"\n          y="20"\n          width="40"\n          height="40"\n          style="fill: #ffffff;"\n        />\n        <rect\n          x="80"\n          y="60"\n          width="40"\n          height="80"\n          style="fill: ${e.middle};"\n        />\n        <rect\n          x="80"\n          y="120"\n          width="40"\n          height="60"\n          style="fill: ${e.feet};"\n        />\n      </svg>\n    </button>\n    `}}class PartyGenerator{static generateParty(e){let t;switch(e){case 1:t={pattern:patterns[0]};break;case 2:t={pattern:patterns[2]};break;case 3:t={pattern:patterns[4]};break;default:t=PartyGenerator.ranomParty()}return t}static ranomParty(){const e={pattern:patterns[Utils.random(0,patterns.length-1)]};return Math.random()>.7&&(e.twist=Utils.random(0,2)),e}}var patterns=[[0,0,0],[0,1,0],[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0,0],[0,1,0,1,0],[0,1,2,1,0],[0,0,2,1,1],[0,1,1,1,0]];class Utils{static random(e,t){return Math.floor(Math.random()*(t-e+1)+e)}}var palette=["#993955","#ae76a6","#a3c3d9","#1A5E63","#3B3B58","#323031"];class Character{constructor(e){this.position=e,this.thickness=40,this.isPlaceholder=!1,this.alpha=1,this.colors={middle:palette[Utils.random(0,palette.length-1)],feet:palette[Utils.random(0,palette.length-1)]}}clone(){return Object.assign(Object.create(Object.getPrototypeOf(this)),this)}}class CharacterRenderer{constructor(e){this.ctx=e.ctx}render(e){if(e.isPlaceholder)return this.ctx.globalAlpha=e.alpha,this.ctx.fillStyle="#E9ECF5",this.ctx.fillRect(e.position[0]-e.thickness*e.alpha/2,e.position[1],e.thickness*e.alpha,e.thickness*e.alpha*4.5),void(this.ctx.globalAlpha=1);this.ctx.globalAlpha=e.alpha,this.ctx.fillStyle="#ffffff",this.ctx.fillRect(e.position[0]-e.thickness*e.alpha/2,e.position[1],e.thickness*e.alpha,e.thickness*e.alpha),this.ctx.fillStyle=e.colors.middle,this.ctx.fillRect(e.position[0]-e.thickness*e.alpha/2,e.position[1]+e.thickness*e.alpha,e.thickness*e.alpha,e.thickness*e.alpha*2),this.ctx.fillStyle=e.colors.feet,this.ctx.fillRect(e.position[0]-e.thickness*e.alpha/2,e.position[1]+e.thickness*e.alpha*3,e.thickness*e.alpha,e.thickness*e.alpha*1.5),this.ctx.globalAlpha=1}}var scoreRoundEl=document.querySelector(".score-level_round"),scoreLevelEl=document.querySelector(".score-level_text"),scoreOverlayEl=document.querySelectorAll(".score-level_indicator-overlay");class Level{constructor(e){this.game=e,this.puzzleGenerator=new PuzzleGenerator(e),this.optionsGenerator=new OptionsGenerator,this.renderer=new LevelRenderer(e,this),this.extras=[],this.isIntroPlaying=!1,this.rounds=0,this.nextRound()}nextRound(){this.rounds++,this.points=100,this.puzzle=this.puzzleGenerator.generate(PartyGenerator.generateParty(this.rounds)),this.optionsGenerator.createOptions(this.puzzle,this.handleOptionSelected.bind(this)),this.animateIntro()}reset(){this.rounds=0,this.extras=[],this.nextRound()}render(){this.renderer.render(this.puzzle)}update(){this.isIntroPlaying||this.points>0&&(this.points-=Math.log10(this.rounds+1),scoreLevelEl.innerText=Math.round(this.points),scoreOverlayEl[0].style=`transform: translateX(${100-Math.round(this.points)}%)`,scoreOverlayEl[1].style=`transform: translateX(-${100-Math.round(this.points)}%)`),this.extras.forEach((e,t)=>{e.velocity&&(e.position[0]+=e.velocity,e.position[1]=e.position[1]+5*Math.sin(e.position[0]/100*Math.PI),(e.position[0]<0||e.position[0]>this.game.canvas.width)&&this.extras.splice(t,1))})}handleOptionSelected(e){if(this.isIntroPlaying)return;const t=parseInt(e.target.dataset.optionid);this.puzzle.solutionPosition===t?(this.isIntroPlaying=!0,e.target.classList.add("correct"),this.puzzle.characters.find(e=>e.isPlaceholder).isPlaceholder=!1,this.game.updateScore(Math.round(this.points)),new Promise(e=>{this.renderer.addRenderHook(this.animateVictory(e),"victory")}).then(()=>new Promise(e=>{this.animateOutro(e)})).then(()=>this.nextRound())):(e.target.classList.add("incorrect"),this.triggerGameOver())}animateIntro(){this.isIntroPlaying=!0,Promise.all(this.addHooksForPreTeleportation()).then(()=>Promise.all(this.addHooksForTeleportation())).then(()=>{document.documentElement.style.cssText=`--placholderArrowPosition: ${this.puzzle.characters.find(e=>e.isPlaceholder).position[0]-optionsEl.getBoundingClientRect().x}px`,optionsEl.classList.remove("options-hidden"),scoreRoundEl.classList.remove("hidden"),this.isIntroPlaying=!1})}animateOutro(e){this.puzzle.characters.filter(e=>!e.isPlaceholder).forEach(e=>{this.extras.push(e),e.velocity=Math.sign(2*Math.random()-1)*Utils.random(15,20)}),optionsEl.classList.add("options-hidden"),scoreRoundEl.classList.add("hidden"),setTimeout(()=>e(),500)}animateVictory(e){let t=0,s=!1;return()=>{t<=0&&s&&(this.renderer.removeRenderHook("victory"),e()),t>=1&&(s=!0),s?(this.puzzle.characters.forEach(e=>{e.position[1]>=.35*this.game.canvas.height?e.position[1]=.35*this.game.canvas.height:e.position[1]+=20}),t-=.1):(this.puzzle.characters.forEach(e=>{e.position[1]-=20*Math.random()}),t+=.1)}}addHooksForPreTeleportation(){const e=[];return this.puzzle.characters.forEach((t,s)=>{e.push(new Promise(e=>{this.renderer.addRenderHook(this.renderer.drawTeleportationPlaceHolder(e,t,s),`portal${s}`)}))}),e}addHooksForTeleportation(){const e=[];return this.puzzle.characters.forEach((t,s)=>{t.alpha=0,e.push(new Promise(e=>{this.renderer.addRenderHook(this.showCharacter.bind(this,e,t,s),`character${s}`)}))}),e}showCharacter(e,t,s){t.alpha>.98&&(this.renderer.removeRenderHook(`portal${s}`),this.renderer.removeRenderHook(`character${s}`),e()),t.alpha+=.1*(1-t.alpha)}triggerGameOver(){this.isIntroPlaying=!0,this.game.gameOver(),this.animateOutro(()=>{})}}class LevelRenderer{constructor(e,t){this.level=t,this.ctx=e.ctx,this.isIntroPlaying=!1,this.renderHooks={},this.characteRenderer=new CharacterRenderer(e)}render(e){Object.values(this.renderHooks).forEach(e=>{e(this.ctx)}),e.characters.forEach(e=>this.characteRenderer.render(e)),this.level.extras.forEach(e=>this.characteRenderer.render(e))}drawTeleportationPlaceHolder(e,t){let s=0;return t.alpha=0,r=>{s>=.6&&e(),s+=.15*(1-s),r.fillStyle="#E9ECF5",r.fillRect(t.position[0]-t.thickness/2*s,t.position[1],t.thickness*s,4.5*t.thickness*s)}}addRenderHook(e,t){this.renderHooks[t]=e}removeRenderHook(e){delete this.renderHooks[e]}}class PuzzleGenerator{constructor(e){this.game=e}generate(e){const t=this._generateCharacters(e);let s,r=Utils.random(0,3),i=[];do{s=Utils.random(0,e.pattern.length-1)}while(1===e.pattern.filter(t=>e.pattern[s]===t).length);return i[r]=t[s].colors,i=this._generateRandomOptions(i),t[s].isPlaceholder=!0,{characters:t,options:i,solutionPosition:r}}_generateCharacters(e){let t,s;const{pattern:r}=e,i=[],o=[];for(let e=0;e<r.length;e++)t=[this.game.canvas.width/2-.4*r.length*100+100*e,.35*this.game.canvas.height],i[r[e]]?(s=i[r[e]].clone()).position=t:(s=new Character(t),i[r[e]]=s),o.push(s);if(e.twist)switch(e.twist){case 0:o.forEach(e=>e.colors.middle=o[0].colors.middle);break;case 1:o.forEach(e=>e.colors.feet=o[0].colors.feet)}return o}_generateRandomOptions(e){for(let t=0;t<4;t++){if(e[t])continue;let s;do{s={middle:palette[Utils.random(0,palette.length-1)],feet:palette[Utils.random(0,palette.length-1)]}}while(e.filter(e=>e.middle===s.middle&&e.feet===s.feet).length);e[t]=s}return e}}