const t={GRAVITY:2,JUMP_VELOCITY:-22,MAX_CANVAS_HEIGHT:760,MAX_CANVAS_WIDTH:1920,MAX_VELOCITY_X:12,MAX_VELOCITY_Y:18,TARGET_FPS:60,init(){t.Input.init(),t.Renderer.init(()=>{t.Renderer.changeLevel(new t.Level.Intro),t.Renderer.mainLoop()})},overlap(t,i){let s=Math.min(t.x+t.w,i.x+i.w)-Math.max(t.x,i.x);s=s<0?0:s;let e=Math.min(t.y+t.h,i.y+i.h)-Math.max(t.y,i.y);return e=e<0?0:e,s*e>Number.EPSILON}};window.addEventListener("load",()=>t.init()),t.Input={ACTION:{PAUSE:1,JUMP:2,RESPAWN:3,LEFT:10,UP:11,RIGHT:12,DOWN:13},PROMPTS:1,_gpButtons:{},_ignoreUntilReleased:{},_on:{gp_connect:[],gp_disconnect:[]},_onKeyDown:{},_onKeyUp:{},gamepads:{},isLinuxFirefox:!1,keystate:{},numGamepads:0,buildActionKeyMap(){this.ACTION_KEY_MAP={[this.ACTION.PAUSE]:{keyboard:["Escape"],gamepad:[9]},[this.ACTION.UP]:{keyboard:["ArrowUp","KeyW","KeyZ"],gamepad:[12]},[this.ACTION.LEFT]:{keyboard:["ArrowLeft","KeyA","KeyQ"],gamepad:[14]},[this.ACTION.DOWN]:{keyboard:["ArrowDown","KeyS"],gamepad:[13]},[this.ACTION.RIGHT]:{keyboard:["ArrowRight","KeyD"],gamepad:[15]},[this.ACTION.JUMP]:{keyboard:["Space","Enter"],gamepad:[0]},[this.ACTION.RESPAWN]:{keyboard:["Backspace"],gamepad:[this.isLinuxFirefox?2:3]}}},getDirections(){let t=0,i=0;if(this.isPressed(this.ACTION.LEFT)?t=-1:this.isPressed(this.ACTION.RIGHT)&&(t=1),this.isPressed(this.ACTION.UP)?i=-1:this.isPressed(this.ACTION.DOWN)&&(i=1),!t||!i){const s=.3;for(const e in this.gamepads){const h=this.gamepads[e];h.axes[0]&&Math.abs(h.axes[0])>s?t=h.axes[0]>0?1:-1:h.axes[2]&&Math.abs(h.axes[2])>s&&(t=h.axes[2]>0?1:-1),h.axes[1]&&Math.abs(h.axes[1])>s?i=h.axes[1]>0?1:-1:h.axes[3]&&Math.abs(h.axes[3])>s&&(i=h.axes[3]>0?1:-1)}}return{x:t,y:i}},getKeysForAction(t){return this.ACTION_KEY_MAP[t]},init(){const t=String(navigator.userAgent).toLowerCase();this.isLinuxFirefox=t.includes("linux")&&t.includes("firefox"),this.buildActionKeyMap(),this.registerEvents()},isPressed(t,i){const s=this.getKeysForAction(t);for(const t of s.keyboard)if(this.isPressedKey(t,i))return!0;for(const t of s.gamepad)if(this.isPressedGamepad(t,i))return!0;if(t===this.ACTION.LEFT)for(const t in this.gamepads){const s=this.gamepads[t];if(s.axes[6]&&s.axes[6]<=-.2)return!this._ignoreUntilReleased["axis6-"]&&(i&&(this._ignoreUntilReleased["axis6-"]=!0),!0)}else if(t===this.ACTION.RIGHT)for(const t in this.gamepads){const s=this.gamepads[t];if(s.axes[6]&&s.axes[6]>=.2)return!this._ignoreUntilReleased["axis6+"]&&(i&&(this._ignoreUntilReleased["axis6+"]=!0),!0)}else if(t===this.ACTION.UP||t===this.ACTION.JUMP)for(const t in this.gamepads){const s=this.gamepads[t];if(s.axes[7]&&s.axes[7]<=-.2)return!this._ignoreUntilReleased["axis7-"]&&(i&&(this._ignoreUntilReleased["axis7-"]=!0),!0)}else if(t===this.ACTION.DOWN)for(const t in this.gamepads){const s=this.gamepads[t];if(s.axes[7]&&s.axes[7]>=.2)return!this._ignoreUntilReleased["axis7+"]&&(i&&(this._ignoreUntilReleased["axis7+"]=!0),!0)}return!1},isPressedGamepad(t,i){for(const s in this.gamepads){const e=this.gamepads[s].buttons[t];if(e&&e.pressed)return!this._ignoreUntilReleased[t]&&(i&&(this._ignoreUntilReleased[t]=!0),!0)}return!1},isPressedKey(t,i){const s=this.keystate[t];return!(!s||!s.time)&&(i&&(s.time=0,s.waitForReset=!0),!0)},off(t,i){if("function"!=typeof i)return void(this._on[t]=[]);const s=this._on[t].indexOf(i);s>=0&&this._on[t].splice(s,1)},on(t,i){this._on[t].push(i)},onKeyDown(t,i){const s=this._onKeyDown[t]||[];s.push(i),this._onKeyDown[t]=s},onKeyUp(t,i){const s=this._onKeyUp[t]||[];s.push(i),this._onKeyUp[t]=s},registerEvents(){document.body.onkeydown=t=>{const i=this.keystate[t.code];i&&i.waitForReset||(this.keystate[t.code]={time:Date.now()},this._onKeyDown[t.code]&&this._onKeyDown[t.code].forEach(t=>t())),"Digit1"===t.code?this.PROMPTS=1:"Digit2"===t.code?this.PROMPTS=2:"Digit3"===t.code&&(this.PROMPTS=3)},document.body.onkeyup=t=>{this.keystate[t.code]={time:0},this._onKeyUp[t.code]&&this._onKeyUp[t.code].forEach(t=>t())},window.addEventListener("gamepadconnected",t=>{const i=String(t.gamepad.id).toLowerCase();i.includes("sony")||i.includes("dualshock")||i.includes("playstation")||i.includes("ps3")?this.PROMPTS=2:(i.includes("xbox")||i.includes("microsoft"))&&(this.PROMPTS=3),this.numGamepads++,this.gamepads[t.gamepad.index]=t.gamepad,this._on.gp_connect.forEach(t=>t())}),window.addEventListener("gamepaddisconnected",t=>{this.PROMPTS=1,this.numGamepads--,delete this.gamepads[t.gamepad.index],this._on.gp_disconnect.forEach(t=>t())})},update(){const t=navigator.getGamepads();for(const i of t)if(i){this.gamepads[i.index]=i;for(const t in this._ignoreUntilReleased)"axis6-"===t||"axis6+"===t?i.axes[6]||delete this._ignoreUntilReleased[t]:"axis7-"===t||"axis7+"===t?i.axes[7]||delete this._ignoreUntilReleased[t]:i.buttons[t]&&!i.buttons[t].pressed&&delete this._ignoreUntilReleased[t]}}};{class i{constructor(){this.objects=[],this.effects=[],this.scenery=[],this.limitsX=[0,1/0],this.timer=0,this.VIEWPORT_MAX_HEIGHT=t.MAX_CANVAS_HEIGHT,this.VIEWPORT_MAX_WIDTH=t.MAX_CANVAS_WIDTH}checkGoal(){if(!this.goal||this.state>0)return;const i={x:this.goal[0],y:this.goal[1],w:this.goal[2],h:this.goal[3]};t.overlap(this.player,i)&&(this.state=1,this.onGoal())}collisionDetection(t,i){const s={x:t.x,y:t.y},e={x:i.x,y:i.y},h={x:e.x,y:e.y};let l=Math.min(s.x,e.x),a=Math.max(s.x,e.x)+t.w,n=Math.min(s.y,e.y),r=Math.max(s.y,e.y)+t.h;const o=s.x+t.w,d=s.y+t.h,c=t.blocks;for(let i=0;i<this.objects.length;i++){const x=this.objects[i];if(x===t||!x.collision||x.gone)continue;let y=x.x,p=y+x.w,f=x.y,w=f+x.h;const u=f>n&&f<r;(w>n&&w<r||u)&&(y<o&&p>=o||y<=s.x&&p>s.x||y>=s.x&&p<=o)&&(u?s.y<h.y&&(c.b=x,h.y=f-t.h):s.y>h.y&&(c.t=x,h.y=w),e.y=h.y,n=Math.min(s.y,e.y),r=Math.max(s.y,e.y)+t.h);let m=y>l&&y<a;(p>l&&p<a||m)&&(f<d&&w>=d||f<=s.y&&w>s.y||f>=s.y&&w<=d)&&(m?s.x<h.x&&(c.r=x,h.x=y-t.w):s.x>h.x&&(c.l=x,h.x=p),e.x=h.x,l=Math.min(s.x,e.x),a=Math.max(s.x,e.x)+t.w)}if(c.b){const i=c.b,s=i.y-h.y-t.h;(i.gone||Math.abs(s)>=1||i.x>h.x+t.w||h.x>i.x+i.w)&&(c.b=null)}if(c.t){const i=c.t,s=i.y+i.h-h.y;(i.gone||Math.abs(s)>=1||i.x>h.x+t.w||h.x>i.x+i.w)&&(c.t=null)}if(c.l){const i=c.l,s=i.x+i.w-h.x;(i.gone||Math.abs(s)>=1||i.y>h.y+t.h||h.y>i.y+i.h)&&(c.l=null)}if(c.r){const i=c.r,s=i.x-h.x-t.w;(i.gone||Math.abs(s)>=1||i.y>h.y+t.h||h.y>i.y+i.h)&&(c.r=null)}t.x=h.x,t.y=h.y}draw(i){const s=t.Renderer.cnv.width,e=t.Renderer.cnv.height,h=this.getViewportOffset(s,e),l=h[0],a=h[1];this.drawBackground(i,e,s,l),i.setTransform(1,0,0,1,l,a),this.scenery.forEach(t=>this.drawIfVisible(i,-l,s,-a,e,t)),this.objects.forEach(t=>this.drawIfVisible(i,-l,s,-a,e,t)),this.effects.forEach(t=>this.drawIfVisible(i,-l,s,-a,e,t)),this.player&&(this.player.died?(i.setTransform(1,0,0,1,0,0),this.drawRespawnTransition(i)):(this.player.draw(i),this.drawGoal(i,-l,s,-a,e))),i.setTransform(1,0,0,1,0,0)}drawBackground(i,s,e,h){let l=Math.ceil(e/1504);const a=this.limitsX[1]-e-this.limitsX[0],n=(h-this.limitsX[0])/a,r=1504*l-e,o=Math.round(n*r);for(;l--;)i.drawImage(t.Renderer.sprite_m,0,0,32,16,o+1504*l,s-752,1504,752)}drawGoal(t,i,s,e,h){if(!this.goal)return;const l=this.goal[0],a=this.goal[2];if(l>i+s||l+a<i)return;const n=t.globalAlpha;t.globalAlpha=.4,t.fillStyle="rgba(144,192,224)",t.fillRect(l,this.goal[1],a,this.goal[3]);for(let i=1;i<8;i++)t.globalAlpha-=.05,t.fillRect(l-16*i,this.goal[1],16,this.goal[3]);t.globalAlpha=n}drawIfVisible(t,i,s,e,h,l){l.x>i+s||l.xe<i||l.draw(t)}drawRespawnTransition(i){const s=t.Renderer.cnv.width,e=t.Renderer.cnv.height,h=Math.ceil(e/2),l=this.timer-this.player.died,a=.1*t.TARGET_FPS,n=.2*t.TARGET_FPS;let r=1;l<=a?r=Math.min(1,l/a):l>n&&(r=1-Math.min(1,(l-n)/n)),i.fillStyle="#000",i.fillRect(0,0,s,h*r),i.fillRect(0,e-h*r,s,h)}getViewportOffset(t,i){const s=Math.round(t/2);return[Math.min(this.limitsX[0],Math.max(-(this.limitsX[1]-t),s-this.player.x)),0]}resetToCheckPoint(){if(!this.checkPoint)return;const t=this.checkPoint,i=this.player;i.x=t.x+Math.round(t.w-i.w)/2,i.y=t.y-i.h-1,i.nextPos.x=i.x,i.nextPos.y=i.y,i.velX=0,i.velY=0,this.objects.forEach(t=>{t.crumbleProgress=0,t.gone=!1,t.isCrumbling=0}),this.effects=[]}setCheckPoint(t){t&&2===t.type&&(this.checkPoint=t)}spawnEffect(i,s){const e=new t.LevelEffect(this,i,s);this.effects.push(e)}update(i){if(this.timer+=i,!(this.state>0))if(this.objects.forEach(t=>t.update(i)),this.scenery.forEach(t=>t.update(i)),this.effects.forEach(t=>t.update(i)),this.player.died)this.timer-this.player.died>=.45*t.TARGET_FPS?this.player.died=0:this.timer-this.player.died>=.2*t.TARGET_FPS&&this.resetToCheckPoint();else{if(this.checkPoint&&t.Input.isPressed(t.Input.ACTION.RESPAWN,!0))return void(this.player.died=this.timer);const s=t.Input.getDirections();if(this.player.update(i,s),this.player.nextPos.x<=this.limitsX[0]?(this.player.nextPos.x=this.limitsX[0],this.player.isWalking=!1):this.player.nextPos.x+this.player.w>=this.limitsX[1]&&(this.player.nextPos.x=this.limitsX[1]-this.player.w,this.player.isWalking=!1),this.collisionDetection(this.player,this.player.nextPos),this.player.y>t.Renderer.cnv.height+100||this.player.isOnSpikes())return void(this.player.died=this.timer);const e=this.player.blocks;this.player.isOnGround&&e.b&&(this.setCheckPoint(e.b),e.b.crumble()),this.player.isOnWall&&(e.l&&e.l.crumble(),e.r&&e.r.crumble()),this.checkGoal()}}}t.Level=i}{class i{constructor(t,i,s){this.data=s,this.level=t,this.timer=0,this.startTime=0,this.endTime=1/0,this._init(i)}_drawCrumbling(t){if(this.timer<this.startTime)return;const i=this.data,s=(this.timer-this.startTime)/(this.endTime-this.startTime),e=s*s,h=t.globalAlpha,l=Math.round(i.w/2);t.globalAlpha=1-e,t.fillStyle="#a2a2a2";const a=8*(1-s),n=10*Math.sin(4*s*Math.PI);let r=i.x-a/2;t.fillRect(Math.round(r+n),i.y-Math.round(40*s),a,a),r+=l,t.fillRect(Math.round(r+n),i.y-Math.round(40*s),a,a),r+=l,t.fillRect(Math.round(r+n),i.y-Math.round(40*s),a,a);const o=i.y+500*e,d=i.y+600*e;t.globalAlpha=1-e,t.drawImage(i.cnv,0,0,l,i.h,i.x,o,l,i.h),t.drawImage(i.cnv,l,0,l,i.h,i.x+l,d,l,i.h),t.globalAlpha=h}_drawJumpDust(t){let i=this.timer/this.endTime;const s=t.globalAlpha;t.globalAlpha=1-i*i;let e=Math.round(14*i),h=Math.round(e/2);t.fillStyle="#e4bd8a",t.fillRect(this.data.x-h,this.data.y-h,e,e),i>.3&&(i=(i-.3)/.7,e=Math.round(10*i),h=Math.round(e/2),t.fillStyle="#ffffff50",t.fillRect(this.data.x-h+10*this.data.dir,this.data.y-h,e,e)),t.globalAlpha=s}_init(i){1===i?(this.draw=this._drawCrumbling,this.startTime=1*t.TARGET_FPS,this.endTime=2*t.TARGET_FPS,this.x=this.data.x-10,this.xe=this.data.xe+10):2===i&&(this.draw=this._drawJumpDust,this.endTime=1*t.TARGET_FPS,this.x=this.data.x-40,this.xe=this.x+100)}update(t){if(this.timer+=t,this.timer>=this.endTime){const t=this.level.effects.indexOf(this);t>=0&&this.level.effects.splice(t,1)}}}t.LevelEffect=i}{class i{constructor(i,s){this.type=s.t||0,0===this.type?this.top="#70a030":2===this.type&&(this.color="#f0f0f0"),this.color=s.color||this.color||"#404047",this.spikes={},s.spikes&&(this.spikes.l=s.spikes.includes("l"),this.spikes.r=s.spikes.includes("r"),this.spikes.t=s.spikes.includes("t")),this.x=0,this.y=0,this.w=s.w||0,this.h=s.h||0;let e=this.h,h=this.w;this.spikes.t&&(e+=8),this.spikes.l&&(h+=8),this.spikes.r&&(h+=8),this.velX=0,this.velY=0,this.blocks={},this.collision=!0,this.level=i,this.type>=0&&(this.cnv=t.Renderer.toOffscreenCanvas(this,e,h)),this.x=s.x||0,this.y=s.y||0,this.xe=this.x+this.w,this.ye=this.y+this.h,this.nextPos={x:this.x,y:this.y}}crumble(){0!==this.type&&1!==this.type||this.isCrumbling||(this.isCrumbling=this.level.timer,this.level.spawnEffect(1,this))}draw(i){if(this.gone)return;const s=this.crumbleProgress||0;let e=this.x,h=this.y;if(s>.5&&(e+=Math.round(4*Math.random()-2),h+=Math.round(4*Math.random()-2)),this.cnv)i.drawImage(this.cnv,e,h);else{if(this.spikes.t&&(h+=8),this.spikes.l&&(e+=8),i.fillStyle=this.color,i.fillRect(e,h,this.w,this.h),0===this.type){const s=i.createPattern(t.Renderer.sprite_s,"repeat");i.fillStyle=s;let l=0,a=0;if(this.spikes.t&&(a+=8),this.spikes.l&&(l+=8),i.translate(l,a),i.fillRect(e-l,h-a,this.w,this.h),i.translate(-l,-a),i.strokeStyle="#838383",i.lineWidth=4,i.strokeRect(e+2,h+2,this.w-4,this.h-4),i.fillStyle="#fff",this.spikes.t){this.top=null;const t=this.w/4;for(let s=0;s<t;s+=2){const t=e+4*s;i.beginPath(),i.moveTo(t,h),i.lineTo(t+8,h),i.lineTo(t+4,h-8),i.fill()}}if(this.spikes.l){const t=this.h/4;for(let s=0;s<t;s+=2){const t=h+4*s;i.beginPath(),i.moveTo(e,t),i.lineTo(e,t+8),i.lineTo(e-8,t+4),i.fill()}}if(this.spikes.r){const t=this.w,s=this.h/4;for(let l=0;l<s;l+=2){const s=h+4*l+8;i.beginPath(),i.moveTo(e+t,s),i.lineTo(e+t,s-8),i.lineTo(e+t+8,s-4),i.fill()}}}else 2===this.type&&(h+=12,i.fillStyle="#e0e0e0",i.fillRect(e+8,h,6,this.h),i.fillRect(e+22,h,6,this.h),i.fillRect(e+36,h,6,this.h),i.fillRect(e+this.w-14,h,6,this.h),i.fillRect(e+this.w-28,h,6,this.h),i.fillRect(e+this.w-42,h,6,this.h));if(this.top){i.fillStyle=this.top,i.fillRect(e,h,this.w,4);for(let t=0;t<this.w/16;t++)i.fillRect(e+16*t,h+4,8,4)}}}update(i){if(this.isCrumbling&&!this.gone){const i=this.level.timer-this.isCrumbling;this.crumbleProgress=i/(1*t.TARGET_FPS),this.crumbleProgress>=1&&(this.crumbleProgress=1,this.gone=!0)}}}t.LevelObject=i}{class i extends t.LevelObject{constructor(t,i,s,e){super(t,{x:i,y:s,w:6*e,h:8*e,t:-1}),this.size=e,this.dirX=1,this.dirY=0,this.eyeBlink=0,this.frameX=0,this.lastOnGround=0}_updateDirection(t){t.x&&(this.dirX=t.x<0?-1:1),this.dirY=t.y>0?1:0}_updateFrameState(t,i){i&&!this.isJumpingUp()?this.frameX+=.2*t:this.frameX=0}_updateStates(t){this.isOnGround&&(this.lastOnGround=this.level.timer),this.isOnGround=!!this.blocks.b,this.isWalking=this.isOnGround&&t.x,this.isOnGround||!this.blocks.l&&!this.blocks.r?this.isOnWall=0:this.isOnWall||(this.isOnWall=this.level.timer)}_updateVelocity(i,s){if(this.isOnWall)return this.velX=0,s.y>0&&(this.isOnWall=0,this.blocks.l=null,this.blocks.r=null),void(this.level.timer-this.isOnWall>t.TARGET_FPS?this.velY=Math.min(this.velY+i*t.GRAVITY/8,t.MAX_VELOCITY_Y/4):s.y<0?this.velY=-1.25:this.velY=0);this.isOnGround||this.isInCoyoteTime()||(this.velY=Math.min(this.velY+i*t.GRAVITY,t.MAX_VELOCITY_Y)),this.isWalking||this.isFallingDown()||this.isJumpingUp()?s.x>0?this.velX=Math.min(this.velX+2*i,t.MAX_VELOCITY_X):s.x<0&&(this.velX=Math.max(this.velX-2*i,-t.MAX_VELOCITY_X)):this.velX=0}canJump(){return this.isOnGround||this.isOnWall||this.isInCoyoteTime()}draw(i){const s=this.size,e=s+s,h=e+s,l=h+e,a=h+h;let n=0;this.isOnGround&&!this.isOnWall&&(n=Math.round((Math.sin(.05*this.level.timer)+1)*s*.1));let r=this.dirX<0;this.isOnWall&&(r=!!this.blocks.r);let o=!0;const d=this.dirY>0?s:0,c=r?s:h,x=this.level.timer-this.eyeBlink;x<.1*t.TARGET_FPS?o=!1:x>=6*t.TARGET_FPS&&(this.eyeBlink=this.level.timer),i.fillStyle="#df7126",i.fillRect(this.x,this.y+n,a,a),r?this.isWalking?~~this.frameX%2?(i.fillRect(this.x+l,this.y+a,s,e),i.fillRect(this.x+e,this.y+a,s,s)):(i.fillRect(this.x+l,this.y+a,s,s),i.fillRect(this.x+e,this.y+a,s,e)):this.isOnWall?i.fillRect(this.x+l,this.y+a,s,e):(i.fillRect(this.x+l,this.y+a,s,e),i.fillRect(this.x+e,this.y+a,s,e)):this.isWalking?~~this.frameX%2?(i.fillRect(this.x,this.y+a,s,s),i.fillRect(this.x+h,this.y+a,s,e)):(i.fillRect(this.x,this.y+a,s,e),i.fillRect(this.x+h,this.y+a,s,s)):this.isOnWall?i.fillRect(this.x,this.y+a,s,e):(i.fillRect(this.x,this.y+a,s,e),i.fillRect(this.x+h,this.y+a,s,e)),o&&(i.fillStyle="#fff",i.fillRect(this.x+c,this.y+s+d+n,e,e))}isFallingDown(){return!this.isOnGround&&!this.isOnWall&&this.velY>0}isInCoyoteTime(){return this.level.timer-this.lastOnGround<2}isJumpingUp(){return!this.isOnGround&&!this.isOnWall&&this.velY<0}isOnSpikes(){return!(!this.isOnGround&&!this.isOnWall)&&(!(!this.blocks.b||!this.blocks.b.spikes.t)||(!(!this.blocks.r||!this.blocks.r.spikes.l)||!(!this.blocks.l||!this.blocks.l.spikes.r)))}jump(){this.isOnWall?(this.blocks.l?(this.velX-=t.JUMP_VELOCITY/2,this.dirX=1):this.blocks.r&&(this.velX+=t.JUMP_VELOCITY/2,this.dirX=-1),this.level.spawnEffect(2,{x:this.x+(this.dirX<0?this.w:0),y:this.y,dir:this.dirX})):this.level.spawnEffect(2,{x:this.x+(this.dirX<0?this.w:0),y:this.y+this.h,dir:this.dirX}),this.velY=t.JUMP_VELOCITY,this.isOnGround=!1,this.isOnWall=0,this.lastOnGround=0}update(i,s){this._updateStates(s),this._updateDirection(s),this._updateVelocity(i,s),this._updateFrameState(i,s.x),this.canJump()&&t.Input.isPressed(t.Input.ACTION.JUMP,!0)&&this.jump(),this.nextPos.x=this.x+Math.round(i*this.velX),this.nextPos.y=this.y+Math.round(i*this.velY)}}t.Character=i}{class i extends t.Level{constructor(){super(),this.hasStarted=!1,this.player=new t.Character(this,224,0,3),this.player.y=600-this.player.h,this.player.isOnGround=!0;[{x:-128,y:600,w:384,h:300,t:2},{x:256,y:600,w:128,h:64},{x:380,y:600,w:128,h:64},{x:504,y:600,w:128,h:64},{x:628,y:600,w:128,h:64},{x:752,y:600,w:128,h:64},{x:876,y:600,w:128,h:64},{x:1e3,y:600,w:128,h:64},{x:1320,y:600,w:128,h:64},{x:1640,y:600,w:128,h:64},{x:1960,y:600,w:128,h:64},{x:2280,y:600,w:128,h:64},{x:2600,y:536,w:128,h:300,t:2},{x:2920,y:600,w:384,h:64},{x:3300,y:408,w:64,h:256},{x:3300,y:216,w:64,h:192},{x:3040,y:32,w:64,h:192,spikes:"l"},{x:3040,y:272,w:64,h:128,spikes:"l"},{x:3300,y:152,w:256,h:64},{x:3684,y:152,w:64,h:64},{x:3748,y:152,w:192,h:1e3,t:2},{x:4004,y:500,w:128,h:64},{x:4200,y:200,w:64,h:320,spikes:"t"},{x:4200,y:-500,w:64,h:704,spikes:"t"},{x:4200,y:528,w:64,h:320},{x:4392,y:500,w:128,h:64},{x:4584,y:400,w:128,h:64},{x:4648,y:100,w:128,h:128},{x:4844,y:500,w:64,h:64},{x:4904,y:-500,w:64,h:1408,spikes:"t"},{x:5256,y:564,w:64,h:64},{x:5416,y:500,w:128,h:64},{x:5640,y:436,w:256,h:64},{x:5960,y:372,w:192,h:600,t:2},{x:6216,y:436,w:128,h:64,spikes:"t"},{x:6340,y:444,w:128,h:64},{x:6464,y:436,w:128,h:64,spikes:"t"},{x:6588,y:444,w:128,h:64},{x:6856,y:496,w:64,h:320,spikes:"t"},{x:6856,y:244,w:64,h:192,spikes:"t"},{x:6712,y:444,w:256,h:64},{x:6784,y:-64,w:128,h:320,spikes:"l"},{x:6964,y:444,w:256,h:64},{x:7676,y:320,w:192,h:600,t:2},{x:7420,y:384,w:64,h:64},{x:7612,y:t.Renderer.cnv.height-64,w:64,h:64}].forEach(i=>{const s=new t.LevelObject(this,i);this.objects.push(s)}),this.goal=[7848,0,20,320],this.limitsX=[0,7868]}draw(i){if(super.draw(i),this.hasStarted){if(1===this.state){const s=t.Renderer.cnv.width,e=t.Renderer.cnv.height,h=this.timer-this.reachedGoal,l=1-Math.min(1,h/(.3*t.TARGET_FPS));i.fillStyle="#000",i.fillRect(l*s,0,s,e)}}else{const s=t.Renderer.centerX,e=t.Renderer.centerY;i.fillStyle="#fff",i.font="bold 80px Arial, sans-serif",i.textAlign="center",i.textBaseline="alphabetic",t.Renderer.setShadowText(8),i.fillText("AND THEN IT WAS GONE",s,e),t.Renderer.resetShadow(),~~this.timer%200>30&&(i.font="32px Arial, sans-serif",i.fillText("Press [Space] to run from a crumbling world",s,e+58)),i.textBaseline="top",t.Input.numGamepads>0?(i.font="bold 20px Arial, sans-serif",i.fillText("Gamepad connected!",s,24)):(i.font="italic 20px Arial, sans-serif",i.fillText("No gamepad connected",s,24))}}onGoal(){this.reachedGoal=this.timer}update(i){this.hasStarted?(super.update(i),1===this.state&&this.reachedGoal&&this.timer-this.reachedGoal>=.45*t.TARGET_FPS&&t.Renderer.changeLevel(new t.Level.Climb)):(this.timer+=i,t.Input.isPressed(t.Input.ACTION.JUMP,!0)&&(this.hasStarted=!0))}}t.Level.Intro=i}{class i extends t.Level{constructor(){super(),this.VIEWPORT_MAX_HEIGHT=1080,this.VIEWPORT_MAX_WIDTH=1200,t.Renderer.resize(this.VIEWPORT_MAX_WIDTH,this.VIEWPORT_MAX_HEIGHT);const i=this.VIEWPORT_MAX_WIDTH,s=t.Renderer.cnv.height;this.player=new t.Character(this,632,0,3),this.player.y=s-128-this.player.h,this.player.isOnGround=!0;const e=Math.round(i/2);[{x:e-128,y:128,w:256,h:128,t:2},{x:-4,y:256,w:64,h:260,spikes:"r"},{x:i-68,y:256,w:64,h:260,spikes:"l"},{x:e-320,y:224,w:128,h:64},{x:e+192,y:224,w:128,h:64},{x:e-448,y:288,w:128,h:64},{x:e+320,y:288,w:128,h:64},{x:e-512,y:544,w:64,h:256},{x:e-512,y:736,w:64,h:192},{x:e-512,y:928,w:64,h:192},{x:e-512,y:1128,w:64,h:192,spikes:"t"},{x:e-448,y:1184,w:256,h:64},{x:e+448,y:544,w:64,h:256},{x:e+448,y:736,w:64,h:192},{x:e+448,y:928,w:64,h:192},{x:e+448,y:1128,w:64,h:192,spikes:"t"},{x:e+192,y:1184,w:256,h:64},{x:e-256,y:672,w:64,h:192},{x:e-256,y:872,w:64,h:192,spikes:"t"},{x:e-196,y:864,w:128,h:128},{x:e+192,y:672,w:64,h:192},{x:e+192,y:872,w:64,h:192,spikes:"t"},{x:e+68,y:864,w:128,h:128},{x:e-192,y:1120,w:64,h:64},{x:e+128,y:1120,w:64,h:64},{x:e-32,y:1152,w:64,h:192},{x:e-32,y:1388,w:64,h:128,spikes:"t"},{x:e-68,y:864,w:136,h:160,t:2},{x:e-290,y:1408,w:576,h:32},{x:e-512,y:1248,w:192,h:32},{x:e-592,y:1312,w:128,h:32},{x:e-592,y:1504,w:192,h:32},{x:e-252,y:1572,w:192,h:32},{x:e+320,y:1248,w:192,h:32},{x:e+464,y:1312,w:128,h:32},{x:e+400,y:1504,w:192,h:32},{x:e+60,y:1572,w:192,h:32},{x:e-64,y:1636,w:128,h:64,t:2},{x:e-64,y:1572,w:128,h:32},{x:e-320,y:1892,w:128,h:192},{x:e-448,y:2084,w:128,h:128},{x:e+192,y:1892,w:128,h:192},{x:e+320,y:2084,w:128,h:128},{x:e-32,y:1860,w:64,h:128},{x:e-128,y:2084,w:256,h:64},{x:e-32,y:2164,w:64,h:32}].forEach(i=>{i.y=s-i.y;const e=new t.LevelObject(this,i);this.objects.push(e)}),this.goal=[0,s-2324,this.VIEWPORT_MAX_WIDTH,60],this.limitsX=[0,this.VIEWPORT_MAX_WIDTH],this.limitsY=[s-2324,0]}drawBackground(i,s,e,h){const l=s-752;let a=Math.ceil(e/1504);for(;a--;)i.drawImage(t.Renderer.sprite_m,0,0,32,16,1504*a,l,1504,752)}drawGoal(t,i,s,e,h){if(!this.goal)return;const l=this.goal[1],a=this.goal[3];if(l>e+h||l+a<e)return;const n=t.globalAlpha;t.globalAlpha=.4,t.fillStyle="rgba(144,192,224)";for(let i=0;i<7;i++)t.globalAlpha-=.05,t.fillRect(this.goal[0],l+16*i,this.goal[2],16);t.globalAlpha=n}drawIfVisible(t,i,s,e,h,l){l.y>e+h||l.ye<e||l.draw(t)}getViewportOffset(t,i){const s=Math.round(t/2),e=Math.round(i/2);return[Math.min(this.limitsX[0],Math.max(-(this.limitsX[1]-t),s-this.player.x)),Math.min(-this.limitsY[0],Math.max(this.limitsY[1],e-this.player.y))]}onGoal(){t.Renderer.changeLevel(new t.Level.Outro)}}t.Level.Climb=i}{class i extends t.Level{constructor(){super(),this.VIEWPORT_MAX_WIDTH=window.innerWidth,this.VIEWPORT_MAX_HEIGHT=window.innerHeight,t.Renderer.resize(this.VIEWPORT_MAX_WIDTH,this.VIEWPORT_MAX_HEIGHT),this._hideWorld=0,this._textW=0,this.phase=1}draw(i){const s=t.Renderer.cnv.width,e=t.Renderer.cnv.height,h=Math.min(1,this.timer/(8*t.TARGET_FPS)),l=i.globalAlpha;if(i.globalAlpha=h,i.fillStyle="#000",i.fillRect(0,0,s,e),i.globalAlpha=l,1===this.phase)this.drawPlayer(i,h,e);else if(2===this.phase){i.fillStyle="#df7126",i.font="bold 92px Arial, sans-serif",i.textAlign="right",t.Renderer.setShadowText(10,"#a2a2a2");let s="WORLD NOT FOUND";if(!this._textW){const t=i.measureText(s);this._textW=t.width}this._hideWorld>this.timer&&(s="NOT FOUND"),i.fillText(s,t.Renderer.centerX+Math.round(this._textW/2),t.Renderer.centerY),t.Renderer.resetShadow()}}drawPlayer(i,s,e){const h=1-s,l=10*h,a=l+l,n=a+l,r=a+a,o=n+a,d=n+n,c=i.globalAlpha,x=e+d+r+100;i.globalAlpha=1-s,i.translate(t.Renderer.centerX-n,Math.round(x*h)-d-r),i.rotate(360*s*Math.PI/180),i.translate(-r,-r),i.fillStyle="#df7126",i.fillRect(0,0,d,d),i.fillRect(o,d,l,a),i.fillRect(a,d,l,a),i.globalAlpha=c,i.fillStyle="#fff",i.fillRect(l,l,a,a),i.setTransform(1,0,0,1,0,0)}update(i){this.timer+=i,this.timer>=9*t.TARGET_FPS&&(this.phase=2,this.timer>=9.5*t.TARGET_FPS&&this._hideWorld<this.timer&&Math.random()<.02&&(this._hideWorld=this.timer+t.TARGET_FPS*Math.random()))}}t.Level.Outro=i}t.Renderer={cnv:null,ctx:null,last:0,level:null,sprite_m:null,sprite_s:null,changeLevel(t){this.level=t,this.resize(t.VIEWPORT_MAX_WIDTH,t.VIEWPORT_MAX_HEIGHT)},clear(){this.ctx.fillStyle="#3e4968",this.ctx.fillRect(0,0,this.cnv.width,this.cnv.height)},draw(){this.clear(),this.level&&this.level.draw(this.ctx)},drawPause(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.cnv.width,this.cnv.height),this.setShadowText(),this.ctx.fillStyle="#a2a2a2",this.ctx.font="bold 128px Arial, sans-serif",this.ctx.textAlign="center",this.ctx.fillText("PAUSED",this.centerX,this.centerY),this.resetShadow(),this.ctx.fillStyle="#808080",this.ctx.font="48px Arial, sans-serif",this.ctx.fillText("Press [Esc] to continue.",this.centerX,this.centerY+80)},init(t){this.cnv=document.getElementById("c"),this.ctx=this.cnv.getContext("2d",{alpha:!1}),this.ctx.imageSmoothingEnabled=!1,this.registerEvents(),this.loadSprite(t)},loadSprite(t){let i=0;const s=new Image;s.onload=()=>{this.sprite_m=s,2==++i&&t()},s.src="m.gif";const e=new Image;e.onload=()=>{this.sprite_s=e,2==++i&&t()},e.src="s.gif"},mainLoop(i=0){if(t.Input.update(),i&&this.last){const s=(i-this.last)/(1e3/t.TARGET_FPS);if(this.ctx.imageSmoothingEnabled=!1,this.ctx.lineWidth=1,this.ctx.textBaseline="alphabetic",this.ctx.setTransform(1,0,0,1,0,0),this.isPaused)return void this.drawPause();this.level&&this.level.update(s),this.draw(s)}this.last=i,requestAnimationFrame(t=>this.mainLoop(t))},pause(){this.isPaused=!0},registerEvents(){window.addEventListener("resize",t=>this.resize()),this.resize();const i=t.Input.getKeysForAction(t.Input.ACTION.PAUSE);setInterval(()=>{this.isPaused&&t.Input.update(),i.gamepad.forEach(i=>{t.Input.isPressedGamepad(i,!0)&&this.togglePause()})},100);const s=()=>this.togglePause();i.keyboard.forEach(i=>t.Input.onKeyUp(i,s)),t.Input.on("gp_disconnect",()=>this.pause())},resetShadow(){this.ctx.shadowColor="#00000000"},resize(i,s){this.level&&(i=i||this.level.VIEWPORT_MAX_WIDTH,s=s||this.level.VIEWPORT_MAX_HEIGHT),this.cnv.height=Math.min(window.innerHeight,s||t.MAX_CANVAS_HEIGHT),this.cnv.width=Math.min(window.innerWidth,i||t.MAX_CANVAS_WIDTH),this.centerX=Math.round(this.cnv.width/2),this.centerY=Math.round(this.cnv.height/2),this.isPaused&&(clearTimeout(this._timeoutDrawPause),this._timeoutDrawPause=setTimeout(()=>this.drawPause(),100))},setShadowText(t=10,i="#df7126"){this.ctx.shadowOffsetX=t,this.ctx.shadowBlur=0,this.ctx.shadowColor=i},togglePause(){this.isPaused?this.unpause():this.pause()},toOffscreenCanvas(t,i,s){const e=document.createElement("canvas");e.width=s||t.w,e.height=i||t.h;const h=e.getContext("2d");return h.imageSmoothingEnabled=!1,t.draw(h),e},unpause(){this.isPaused&&(this.isPaused=!1,this.mainLoop())}},t.UI={};