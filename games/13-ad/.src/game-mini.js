const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");ctx.webkitImageSmoothingEnabled=!1,ctx.mozImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1;const scl=2;var key,px,py,i,j,temp,act,wOb,bgm,sfx,game,wt=5*scl,hex_w=26,hex_h=22,grid_x=16,grid_y=14,tGrid=0,xs=20,ys=15,p1x=3,p1y=9,arr=[],bol=!1,food=10,man=1,army=0,mNu=0,mItem=0,eBrk=0,kRd=0,msg="",msgX=0,ui=0,sWar=0,eWar=0,pWar=0,rWar=0,dWar=0,xWar=0,yWar=0,wAn=0,gTm=0,eTm=0,sId=1,lvl=0,glvl=["Easy","Normal","Hard","Super Hard","Great Battle"],song="cdfggfcc-fffaa-gbb-fcfacgggcde---fccfff",bgs2="dada-cfggcfgg--dada-cfggddeefgg--cdfggfcc-fffaa-gbb-fcfacgggcde---fccfff--",bgs="d-d-dd-d-d-cfggcfgg--cfggddeefgg--",lstSnd="eeeffaa-aaa",pic=new Image;function sn(r){(sfx=new snd(r,0)).play()}function sTr(r){var a;mNu=7,Clr(0,0,900,600),pNl(100,300,700,100),aPc(64,25,11,15,120+10*r,180,88,120),1<r&&sn("ga"),1==r&&(a="Oh no, our land is being attacked by the roman army"),2==r&&(a="We need you to lead the battle"),3==r&&(a="Get ready!! use SPACE and ARROW keys to control"),aTx(a,450,350,20),aTx("press SPACE to continue",700,420)}function Cvr(){kRd=0,grid_x=18,grid_y=19,xs=-15,ys=-5,arr=[],dRG(1),aEn(p1x,p1y),sAl(),dRG(2),aTx("13 A.D.",450,280,100),aTx("the great battle",450,320,35),pNl(340,20,220,40),Clr(350,30,200,20,"#5c412b"),aTx("Game by Wandah - JS13K 2021",450,45),bgm&&bgm.stop(),(bgm=new snd(song,1)).play(),mNu=6}function Clr(r,a,t,e,n=""){ctx.clearRect(r,a,t,e),ctx.fillStyle=""==n?"#4f5c52":n,ctx.fillRect(r,a,t,e)}function cMn(r){mmNu=6!=mNu&&1==man?2:r;var a=pHr();if(0<mNu&&mNu<7&&(39!=key&&40!=key||(++mItem>mmNu&&(mItem=1),console.log("mi = "+mItem)),37!=key&&38!=key||--mItem<1&&(mItem=mmNu),32==key&&0==kRd&&(12==(act=10*mNu+mItem)&&(4<food?(arr[a][2]=1,food-=5,4==arr[a][0]&&(arr[a][0]=2),arr[a][6]=arr[a][0]+cAR(p1x,p1y).a,1==man&&aMs("wait until the colony grow"),rst()):aMs("Need 5 foods, grow more!"),mNu=0),13==act&&(arr[a][2]=4,food+=3+arr[a][3]*(arr[a][0]+cAR(p1x,p1y).a),arr[a][0]=4,arr[a][3]=0,rst()),14==act&&(4<food?(arr[a][2]=2,food-=5,e=arr[a][3],arr[a][3]=0,4==arr[a][0]&&(arr[a][0]=2),arr[a][4]=e-1,aMs("Send Settler here to train an Army"),rst()):aMs("Need 5 foods, grow more!"),mNu=0),11==act&&(0<arr[a][9]?(arr[a][9]--,act=21):(aMs("Can't move anymore"),mNu=0)),22==act&&(19<food&&9<arr[a][3]?(arr[a][2]=3,food-=20,arr[a][3]-=10,arr[a][6]=2*arr[a][6],rst()):aMs("Need 20 foods & 10 Settler!"),mNu=0),21!=act&&31!=act&&41!=act&&42!=act||(temp=aRd(p1x,p1y),mNu=-1,mItem=0,kRd=1),62==act&&(kRd=1,bgm.stop(),sn(lstSnd),p1x=3,p1y=9,grid_x=16,grid_y=14,gTm=mNu=0,food=10,xs=20,ys=15,arr=[],init(),game=setInterval(run,50)),61==act&&(++lvl>glvl.length-1&&(lvl=0),Cvr()))),-1==mNu){for(39!=key&&40!=key||mItem++,37!=key&&38!=key||mItem--,mItem>temp.length-1&&(mItem=0),mItem<0&&(mItem=temp.length-1),dRG(),i=0;i<temp.length;i++){var t=temp[i],t=xYt(t[1],t[2]);drT(t.x,t.y,i==mItem?6:7)}r=temp[mItem];if(32==key&&0==kRd){var e=arr[r[0]];if(21!=act&&41!=act||(n=Math.floor(arr[a][3]/2),1!=arr[a][2]&&3!=arr[a][2]&&(n=arr[a][3]),1!=arr[a][2]&&3!=arr[a][2]||(arr[a][9]=3),n<1&&(n=1),(e[0]<3||4==e[0])&&0==e[4]&&(e[2]<2||3==e[2]||4==e[2])&&0==e[7]&&0==e[8]&&(e[3]+=n,e[9]=arr[a][9],e[1]=1,arr[a][3]-=n,arr[a][9]=0),3==e[0]&&(e[1]=1,arr[a][3]-=n,arr[a][9]=0,aMs("Settler drown and die")),2==e[2]&&(1<food?(arr[a][3]-=n,e[4]+=n,aMs("Troop trained")):aMs("Need more food!!")),p1x=r[1],p1y=r[2],rst()),31==act||42==act)if(1!=e[2]){if((e[0]<3||4==e[0])&&(e[2]<5&&1!=e[2]&&0==e[7]&&0==e[8]&&(e[4]+=arr[a][4]),5!=e[2]&&7!=e[2]||(e[4]+=arr[a][4],e[2]=0,food+=10+rnd(5),aMs("The area was plundered and pillaged")),6==e[2]||8==e[2]||0<e[7]||0<e[8])){if(0<sWar)return;sWar=10,eWar=r[0],pWar=arr[a][4],xWar=r[1],yWar=r[2]}3==e[0]&&(arr[a][4]=0,aMs("Troops drown and die")),e[1]=1,p1x=r[1],p1y=r[2];var n=cAR(r[1],r[2]).e;0<n&&3!=e[0]&&arr[n][7]+arr[n][8]>arr[a][4]&&(sWar=20,eWar=n,pWar=arr[a][4],e[4]=arr[a][4],xWar=r[1],yWar=r[2]),arr[a][4]=0,rst()}else rst()}}}function keydown(r){key=r.keyCode;r=arr[pHr()];0==mNu&&(39==key&&p1x<grid_x-1&&p1x++,37==key&&0<p1x&&p1x--,38==key&&0<p1y&&p1y--,40==key&&p1y<grid_y-1&&p1y++,32==key&&0==mNu&&(mItem=kRd=1,0<r[3]&&(0==r[2]||4==r[2])&&0==r[4]&&(mNu=1),1<r[3]&&1==r[2]&&(mNu=2),0<r[4]&&(mNu=3),3==r[2]&&(1<r[3]||0<r[4])&&(mNu=4)),dRG()),32==key&&0==kRd&&6<mNu&&(kRd=1,7==mNu?4==++sId?(mItem=1,Cvr()):sTr(sId):10==mNu&&(sfx.stop(),arr=[],clearInterval(game),mNu=6,mItem=1,Cvr())),(0<mNu&&mNu<7||-1==mNu)&&adM()}function rst(){mNu=0,dRG()}function adM(){var r,a=arr[pTl(p1x,p1y)];1==mNu&&(cMn(4),1!=a[2]&&3!=a[2]||(a[9]=3),btn("Move Settler ("+a[9]+"/3)",200,525,150,1),btn("Build Colony",360,525,150,2),1<man&&(4==a[0]?btn("Harvest Crops",520,525,150,3):btn("Build Farm",520,525,150,3)),1<man&&btn("Build Barrack",680,525,150,4)),2==mNu&&(cMn(2),btn("Move Settler",200,525,150,1),btn("Build Castle",360,525,150,2)),3==mNu&&(cMn(1),btn("Move Army",200,525,150,1)),4==mNu&&(r=0,1<a[3]&&r++,0<a[4]&&r++,cMn(r),1<a[3]&&btn("Move Settler",200,525,150,1),0<a[4]&&btn("Move Army",360,525,150,2)),-1==mNu&&cMn(6),6==mNu&&(cMn(2),btn("START BATTLE",350,350,200,2),btn("Game Level: "+glvl[lvl],350,400,200,1))}function keyup(r){kRd=0,key=null}function init(){dRG(1)}function pNl(r,a,t,e){for(aPc(241,0,5,5,r,a,wt,wt),aPc(251,0,5,5,r+t-wt,a,wt,wt),aPc(241,10,5,5,r,a+e-wt,wt,wt),aPc(251,10,5,5,r+t-wt,a+e-wt,wt,wt),i=1;i<Math.floor((t-wt)/wt);i++)aPc(246,0,5,5,r+i*wt,a,wt,wt),aPc(246,10,5,5,r+i*wt,a+e-wt,wt,wt);for(i=1;i<Math.floor((e-wt)/wt);i++)aPc(241,5,5,5,r,a+i*wt,wt,wt),aPc(251,5,5,5,r+t-wt,a+i*wt,wt,wt)}function btn(r,a,t,e,n){if(0!=mNu){var d=n==mItem?0:1;for(aPc(210+15*d,0,5,20,a,t,wt,20*scl),aPc(220+15*d,0,5,20,a+e-wt,t,wt,20*scl),i=1;i<Math.floor((e-wt)/wt);i++)aPc(215+15*d,0,5,20,a+i*wt,t,wt,20*scl);aTx(r,a+e/2,t+24)}}function aPc(r,a,t,e,n,i,d,c){ctx.drawImage(pic,r,a,t,e,n,i,d,c)}function aTx(r,a,t,e=14,n=0){ctx.textAlign="center",ctx.fillStyle="#f1f097",ctx.font=e+"px Times",ctx.textAlign=0==n?"center":"start",14<e&&(ctx.strokeStyle="#896913",ctx.lineWidth=Math.round(e/6),ctx.strokeText(r,a,t)),ctx.fillText(r,a,t)}function drT(r,a,t){aPc(t*hex_w,0,hex_w,hex_h,r,a,hex_w*scl,hex_h*scl)}function pHr(){return p1y+p1x*grid_y}function pTl(r,a){return r<0||a<0||grid_x-1<r||grid_y-1<a?-1:a+r*grid_y}function cTl(r){var a=Math.floor(r/grid_y);return{x:a,y:r-a*grid_y}}function xYt(r,a){return{x:xs+(hex_w*r+a%2*hex_w/2)*scl,y:ys+16*a*scl}}function dRG(r=0){tGrid=grid_x*grid_y,Clr(5,5,895,595);for(var a=0;a<grid_x;a++)for(var t=0;t<grid_y;t++){var e,n=xYt(a,t).x,i=xYt(a,t).y,d=t+a*grid_y,c=2;drT(n,i,c=1==r?(6==(e=Math.floor(15*Math.random()))&&(c=0),4==e&&(c=2),7==e&&(c=3),e<4&&(c=1),arr.push([c,0,0,0,0,0,0,0,0,0]),5):0==arr[d][1]?5:arr[d][0]),0<arr[d][1]&&(5==arr[d][2]?aPc(198,22,26,22,n,i,52,44):6==arr[d][2]?aPc(172,22,26,22,n,i,52,44):7==arr[d][2]?aPc(104,0,26,22,n,i,52,44):8==arr[d][2]&&aPc(130,22,26,22,n,i,52,44),0<arr[d][8]?8!=arr[d][2]&&aPc(157,22,15,18,n+8,i+2,30,36):0<arr[d][7]&&8!=arr[d][2]&&aPc(75,22,12,18,n+12,i,24,36),1==arr[d][2]?aPc(0,22,26,22,n,i,52,44):3==arr[d][2]?aPc(104,22,26,22,n,i,52,44):2==arr[d][2]?aPc(26,22,26,22,n,i,52,44):0<arr[d][4]?aPc(64,25,11,15,n+16,i+5,22,30):0<arr[d][3]&&aPc(55,25,9,15,n+18,i+5,18,30))}var o=xYt(p1x,p1y);1==r&&(aEn(grid_x-3-rnd(4),2+rnd(3)),lvl==glvl.length-1&&6!=mNu&&aEn(grid_x-3-rnd(4),7+rnd(3)),arr[pHr()]=[2,1,0,1,0,750,0,0,0,1],drT(o.x,o.y,2),aPc(55,25,9,15,o.x+18,o.y+5,18,30),aMs("Select area and press SPACE")),cRw();var m=arr[pHr()];(ui=0)<m[3]&&(aPc(55,25,9,15,110,530,18,30),aTx("x "+m[3],150,550)),1!=m[2]&&3!=m[2]||(ui=pHr(),1==m[2]&&aPc(0,22,26,22,40,530,56,44),3==m[2]&&aPc(104,22,26,22,40,530,56,44)),0<m[4]&&(3==m[2]?(aPc(64,25,11,15,210,530,22,30),aTx("x "+m[4],250,550)):(aPc(64,25,11,15,110,530,22,30),aTx("x "+m[4],150,550))),2==m[2]&&aPc(26,26,26,22,40,530,56,44),pNl(0,0,900,600),2!=r&&(pNl(15,505,870,80),-1<mNu&&drT(o.x,o.y,6),aPc(90,25,15,15,40,485,20,20),aTx("x "+food,75,495,16),aPc(55,25,9,15,100,482,14,20),aTx("x "+man,132,495,16),aPc(64,25,11,15,160,482,14,20),aTx("x "+army,192,495,16))}function cRw(){if(!(5<mNu)){var r=eBrk=army=man=0;for(i=0;i<tGrid-1;i++)man+=arr[i][3],army+=arr[i][4],r+=arr[i][7],r+=arr[i][8],6==arr[i][2]&&eBrk++;10<gTm&&(man<=0&&(mNu=10,sAl(),dRG(),aTx("DEFEATED",450,300,60),sfx.stop(),sn(bgs2)),r<=0&&(mNu=10,sAl(),dRG(),aTx("VICTORY",450,300,60),sfx.stop(),sn(bgs2)))}}function sAl(){for(i=0;i<tGrid;i++)arr[i][1]=1}function aRd(r,a){var t=[[[1,0],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1]],[[1,0],[1,-1],[0,-1],[-1,0],[0,1],[1,1]]],e=1&a,n=[];for(i=0;i<6;i++){var d=r+t[e][i][0],c=a+t[e][i][1];-1<(j=pTl(d,c))&&n.push([j,d,c])}return n}function cAR(r,a,t=0){var e=aRd(r,a),n=0,d=0,c=0;for(i=0;i<e.length;i++){var o=arr[e[i][0]];if(null==o)return;0==t&&(o[1]=1),3==o[0]&&(n=1),(0<o[7]||0<o[8])&&(d=e[i][0]),(0<o[2]&&o[2]<5||0<o[3]||0<o[4])&&(c=e[i][0])}return{a:n,e:d,p:c}}function aMs(r){""==msg&&(msg=r,msgX=50,sn("-ga"))}function rnd(r){return Math.floor(Math.random()*r)}function aEn(r,a){for(i=0;i<4+rnd(3);i++)arr[pTl(r+rnd(3)-rnd(3),a+rnd(3)-rnd(3))]=[1,0,5,0,0,0,0,0,0],arr[pTl(r+rnd(3)-rnd(3),a+rnd(3)-rnd(3))]=[1,0,6,0,0,0,0,0,0],arr[pTl(r+rnd(3)-rnd(3),a+rnd(3)-rnd(3))]=[1,0,7,0,0,0,0,0,0],arr[pTl(r+rnd(2)-rnd(2),a+rnd(2)-rnd(2))]=[1,0,7,0,0,0,0,0,0],i<4&&(arr[pTl(r+rnd(4)-rnd(4),a+rnd(4)-rnd(4))]=[rnd(3),0,0,0,0,0,0,4+rnd(5),0]),i<3&&(arr[pTl(r+rnd(4)-rnd(4),a+rnd(4)-rnd(4))]=[rnd(3),0,0,0,0,0,0,0,2+rnd(5)]);arr[pTl(r,a)]=[2,1,8,0,0,0,0,5,2]}function mvE(r,a){0<sWar||(0<arr[a][4]?arr[a][4]>arr[r][7]+1.4*arr[r][8]&&rnd(10)<5||(sWar=10,eWar=r,pWar=arr[a][4],xWar=cTl(a).x,yWar=cTl(a).y,aMs("Enemy attacking"),dRG()):(arr[a][7]+=arr[r][7],arr[a][8]+=arr[r][8],arr[r][7]=0,arr[r][8]=0,4==arr[a][2]&&(arr[a][2]=0,arr[a][0]=1,(food-=3+rnd(2))<0&&(food=0),aMs("farm field plundered")),(1==arr[a][2]||0<arr[a][3])&&(arr[a][2]=0,arr[a][3]=0,arr[a][0]=1,aMs("colony plundered")),dRG()))}function findPBase(){var r={x:-1,y:0};for(i=0;i<tGrid-1;i++)if(1==arr[i][2]||3==arr[i][2]||0<arr[i][3])return r=cTl(i);return r}function eAI(){0==mNu&&eTm++,tGrid-1<eTm&&(eTm=0);var r,a,t,e,n=-1;6==arr[eTm][2]&&1e4-300*lvl<gTm&&13==rnd(15)&&(arr[eTm][7]=3+lvl+rnd(4+lvl)),6==arr[eTm][2]&&1e4-300*lvl<gTm&&14==rnd(25)&&(arr[eTm][8]=2+lvl+rnd(3+lvl)),8==arr[eTm][2]&&0==eBrk&&4e3<gTm&&(arr[eTm+1][2]=6),(0<arr[eTm][7]||0<arr[eTm][8])&&8!=arr[eTm][2]&&rnd(10)<5&&(n=eTm),-1<n&&(t=cAR((e=cTl(n)).x,e.y,1).p,r=aRd(e.x,e.y),0<t?mvE(n,t):gTm<8e3||(a=-1)!=(t=findPBase()).x&&(t.x<e.x&&t.y<e.y&&(a=2),t.x>e.x&&t.y<e.y&&(a=1),t.x>e.x&&t.y>e.y&&(a=5),t.x<e.x&&t.y>e.y&&(a=4),2==rnd(4)&&(a=t.x<e.x?3:0),1==rnd(4)&&(a=t.y<e.y?2:5),-1!=a&&r.length-1>=a&&(3!=(e=arr[r[a][0]])[0]&&e[2]<5&&0==e[7]&&0==e[8]&&(mvE(n,r[a][0]),eTm+=3))))}function run(){if(gTm++,eAI(),""!=msg&&(Clr(250,478,595,25),msgX-=5,aTx("> "+msg,280+Math.max(msgX,0),495,14,1),msgX<-150&&(msg="",Clr(250,478,595,25))),0<sWar&&0==--sWar){for(mNu=9,wAn=1,wOb=[],i=0;i<pWar;i++)wOb.push([1,120+i*(5+rnd(10)),520+rnd(3),2+rnd(1),520+rnd(3)]);for(0==arr[eWar][7]&&0==arr[eWar][8]&&(arr[eWar][7]=1+rnd(5)),i=0;i<arr[eWar][7];i++)wOb.push([2,780-i*(5+rnd(10)),520+rnd(3),-2-rnd(1),520+rnd(3)]);for(i=0;i<arr[eWar][8];i++)wOb.push([3,820-i*(5+rnd(10)),523+rnd(3),-2-rnd(2),523+rnd(3)]);var r=pWar*(1+rnd(5)/10),a=pTl(xWar,yWar),t=arr[eWar][7]*(1+rnd(4)/10)+arr[eWar][8]*(1.2+rnd(5)/10);3==arr[a][2]&&(r+=3),8==arr[a][2]&&(t+=3),rWar=t<r?1:2,dWar=0;a=cTl(eWar),t=xYt(a.x,a.y);6!=arr[eWar][2]&&8!=arr[eWar][2]&&drT(t.x,t.y,arr[eWar][0]),aPc(225,25,16,13,(t=xYt(xWar,yWar)).x+10,t.y+8,32,26),sn(bgs)}if(1==wAn||2==wAn)for(200<++dWar&&(wAn=2),250<dWar&&(wAn=3),Clr(28,518,842,58),i=0;i<wOb.length;i++){var e=wOb[i];1==wAn&&(0<e[3]&&e[1]<730&&(e[1]+=e[3]),e[3]<0&&170<e[1]&&(e[1]+=e[3])),e[2]=e[4],1==rnd(3)&&(e[2]=e[4]+rnd(3)),2==wAn&3==rnd(8)&&(e[2]=e[4]+rnd(6)),1==e[0]&&aPc(64,25,11,15,e[1],e[2],22,30),2==e[0]&&aPc(75,22,12,18,e[1],e[2],24,36),3==e[0]&&aPc(157,22,15,18,e[1],e[2],30,36),Math.abs(e[1]-450)<5&&(1==e[0]&&(2==rWar&&(e[1]=1e4),1==rWar&&i<wOb.length-pWar&&(e[1]=1e4)),1<e[0]&&(1==rWar&&(e[1]=1e4),2==rWar&&pWar<i&&i<2*pWar&&(e[1]=1e4)))}if(3==wAn&&(r=arr[eWar],a=pTl(xWar,yWar),wAn=(1==rWar?(r[4]=pWar-Math.floor(r[7]+1.5*r[8]),r[4]<1&&(r[4]=1),r[7]=0,r[8]=0,4<r[2]&&(r[2]=0),a!=eWar&&(arr[a][7]=0,arr[a][8]=0,arr[a][4]=0,4<arr[a][2]&&(arr[a][2]=0)),aMs("Victory!!")):(0==r[7]&&0<r[8]&&(r[8]-=Math.floor(.8*pWar),r[8]<1&&(r[8]=1)),0<r[7]&&0==r[8]&&(r[7]-=pWar,r[7]<1&&(r[7]=1)),0<r[7]&&0<r[8]&&((t=pWar-r[7])<0&&(t=0),r[7]-=pWar,r[7]<1&&(r[7]=1),r[8]-=t,r[8]<1&&(r[8]=1)),r[4]=0,r[2]<5&&(r[2]=0),a!=eWar&&(arr[a][7]=r[7],arr[a][8]=r[8],arr[a][4]=0,r[7]=0,r[8]=0,r[4]=0,arr[a][2]<5&&(arr[a][2]=0)),aMs("Defeated!!")),sn(lstSnd),0),rst()),!(8<mNu))for(0<ui&&Clr(28,518,.842*arr[ui][5],3,"#1bdf49"),i=0;i<tGrid-1;i++)1!=arr[i][2]&&3!=arr[i][2]||(arr[i][5]+=arr[i][6],1e3<arr[i][5]&&(arr[i][5]=0,arr[i][3]<10*arr[i][2]?0<food?(food--,arr[i][3]++,aMs("citizen grow")):aMs("citizen need food"):aMs("citizen need more space"),0==mNu&&dRG()))}pic.src="hex1.png",pic.onload=function(){sTr(1),addEventListener("keydown",keydown),addEventListener("keyup",keyup)};var scale={c:261.63,d:293.66,e:329.63,f:349.23,g:392,b:493.88,a:440};function snd(e,r=0){var n=new AudioContext,i=0,d=r;this.play=function(){this.inter=setInterval(function(){var r,a,t=e.charAt(i),t=scale[t];(i+=1)>=e.length&&1==d?i=0:stop(),t&&(r=n.createGain(),a=n.createOscillator(),r.connect(n.destination),r.gain.setValueAtTime(0,n.currentTime),r.gain.linearRampToValueAtTime(.01,n.currentTime+1/300),r.gain.linearRampToValueAtTime(0,n.currentTime+260/300),a.frequency.value=t/2,a.type="square",a.connect(r),a.start(0),setTimeout(function(){a.stop(0),a.disconnect(r),r.disconnect(n.destination)},260))},250)},this.stop=function(){clearInterval(this.inter)}}