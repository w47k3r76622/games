var MAP={tw:64,th:24},TILE=32,METER=TILE,GRAVITY=9.8*6,MAXDX=10,MAXDY=60,ACCEL=.5,FRICTION=1/6,IMPULSE=1500,FPS=60,STEP=1/FPS,COLOR={GREY:"#333",LIGHTS_ON:"rgb(218, 218, 218)",LIGHTS_OFF:"rgb(24, 24, 24)"},KEY={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,R:82,F:70};TIME_SWITCH_LIGHTS_OFF=3E3;CREDITS_TIME=5E3;LANTERN_RADIUS=6;LEVEL_MAX=5;function timestamp(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()}
function bound(a,c,b){return Math.max(c,Math.min(b,a))}function get(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){4==b.readyState&&200==b.status&&c(b)};b.open("GET",a,!0);b.send()}function overlap(a,c,b,d,e,f,g,h){return!(a+b-1<e||e+g-1<a||c+d-1<f||f+h-1<c)}var t2p=function(a){return a*TILE},p2t=function(a){return Math.floor(a/TILE)},cell=function(a,c){return tcell(p2t(a),p2t(c))},tcell=function(a,c){return Cells[a+c*MAP.tw]};
function getOrCreateImage(a,c){var b=document.getElementById(a);if(b)return b;b=document.getElementById("hiddenDiv");var d=document.createElement("img");d.id=a;d.src=c;b.appendChild(d);return d}
function printTutorial(){var a=document.createElement("p");a.innerHTML="There is a blackout! Look for the fuse box and turn the lights back on<br/><br/>Use arrows to move<br/>Press Space to jump<br/>Press R to restart level<br/>Press F to use the lantern (only one use per level)";var c=document.querySelector("title");c.parentNode.insertBefore(a,c)}function removeTutorial(){var a=document.querySelector("p");a.parentNode.removeChild(a)}
function credits(){TheEnd=!0;var a=document.querySelector("#canvas");a.parentNode.removeChild(a);var c=document.createElement("h2");c.setAttribute("class","credits-titles");c.innerHTML="Developer & Game Designer";var b=document.createElement("h1");b.setAttribute("data-heading","Alejandro Molina Salazar");b.setAttribute("class","credits-names");b.innerHTML="Alejandro Molina Salazar";a=document.querySelector("title");a.parentNode.insertBefore(b,a);a.parentNode.insertBefore(c,b);setTimeout(function(){c.innerHTML=
"Game Artist";b.setAttribute("data-heading","Beatriz Ia\u00f1ez Bustamante");b.innerHTML="Beatriz Ia\u00f1ez Bustamante";ClickSound.play();setTimeout(function(){b.setAttribute("data-heading","The End");b.innerHTML="The End";c.parentNode.removeChild(c);ClickSound.play();setTimeout(function(){b.parentNode.removeChild(b);LightsSound.play()},CREDITS_TIME)},CREDITS_TIME)},CREDITS_TIME)}
var Canvas=document.getElementById("canvas"),ctx=Canvas.getContext("2d"),Width=Canvas.width=MAP.tw*TILE,Height=Canvas.height=MAP.th*TILE,Player={},Treasure=[],Traps=[],Cells=[],Level=1,MapTransparency=1,TutorialPrinted=!1,TutorialRemoved=!1,FrameCalled=!1,LightsTimeout,LevelDataLoaded=!1,LevelDoc,LanternActive=!1,LanternUsed=!1,TheEnd=!1,TreasureCatched=!1,FootStepsSound=new Audio("./assets/foot-steps.mp3"),ClickSound=new Audio("./assets/click.mp3"),LightsSound=new Audio("./assets/lights-sound.mp3");
function restartLevel(){Player={};Traps=[];Treasure=[];Cells=[];MapTransparency=1;FrameCalled=!0;LanternActive=TreasureCatched=!1;ctx.clearRect(0,0,Canvas.width,Canvas.height)}var TRAP_IMG="./assets/trap.png",PLAYER_LEFT_IMG="./assets/player-left.png",PLAYER_RIGHT_IMG="./assets/player-right.png",SWITCH_IMG="./assets/switch.png",PlayerFacing={RIGHT:0,LEFT:1},playerLastMovement=PlayerFacing.RIGHT;
function render(a,c,b,d,e,f){a.clearRect(0,0,d,e);renderMap(a,b,f);renderTreasure(a,c);renderPlayer(a,b);renderTraps(a,b)}
function renderMap(a,c,b){var d;a.globalAlpha=b;if(LanternActive)for(a.globalAlpha=1,d=0;d<MAP.th;d++)for(b=0;b<MAP.tw;b++){var e=tcell(b,d);renderLantern(Player,c,LANTERN_RADIUS);e&&Math.sqrt((b-p2t(Player.x))*(b-p2t(Player.x))+(d-p2t(Player.y))*(d-p2t(Player.y)))<LANTERN_RADIUS&&(a.fillStyle=COLOR.GREY,a.fillRect(b*TILE,d*TILE,TILE,TILE))}else{for(d=0;d<MAP.th;d++)for(b=0;b<MAP.tw;b++)if(e=tcell(b,d))a.fillStyle=COLOR.GREY,a.fillRect(b*TILE,d*TILE,TILE,TILE);a.globalAlpha=1}}
function refreshPlayerLastMovement(){Player.right&&!Player.left?playerLastMovement=PlayerFacing.RIGHT:!Player.right&&Player.left&&(playerLastMovement=PlayerFacing.LEFT)}function renderLantern(a,c,b){ctx.beginPath();ctx.arc(a.x+a.dx*c,a.y+a.dy*c,b*TILE,0,2*Math.PI);ctx.strokeStyle="yellow";ctx.stroke()}
function renderPlayer(a,c){a.fillStyle=COLOR.GREY;refreshPlayerLastMovement();switch(playerLastMovement){case PlayerFacing.RIGHT:var b=getOrCreateImage("playerRight",PLAYER_RIGHT_IMG);break;case PlayerFacing.LEFT:b=getOrCreateImage("playerLeft",PLAYER_LEFT_IMG);break;default:b=getOrCreateImage("playerRight",PLAYER_RIGHT_IMG)}a.drawImage(b,Player.x+Player.dx*c,Player.y+Player.dy*c,TILE,TILE)}
function renderTraps(a,c){var b;var d=0;for(b=Traps.length;d<b;d++){var e=Traps[d];a.drawImage(getOrCreateImage("trap"+d,TRAP_IMG),e.x+e.dx*c,e.y+e.dy*c,TILE,TILE)}}function renderTreasure(a,c){a.globalAlpha=.25+tweenTreasure(c,240);var b;var d=0;for(b=Treasure.length;d<b;d++){var e=Treasure[d];TreasureCatched||a.drawImage(getOrCreateImage("switch",SWITCH_IMG),e.x,e.y+TILE/3,TILE,2*TILE/3)}a.globalAlpha=1}function tweenTreasure(a,c){var b=c/2;pulse=a%c;return pulse<b?pulse/b:1-(pulse-b)/b}
function onkey(a,c,b){if(!TheEnd)switch(c){case KEY.LEFT:return Player.left=b,a.preventDefault(),!1;case KEY.RIGHT:return Player.right=b,a.preventDefault(),!1;case KEY.SPACE:return Player.jump=b,a.preventDefault(),!1;case KEY.R:return restartLevel(),loadLevel(),a.preventDefault(),!1;case KEY.F:return LanternUsed||(setTimeout(function(){LanternActive=!1;LanternUsed=!0},TIME_SWITCH_LIGHTS_OFF),LanternActive=!0),!1}}function update(a){updatePlayer(a);updateTraps(a);checkTreasure()}
function updatePlayer(a){updateEntity(Player,a)}function updateTraps(a){var c;var b=0;for(c=Traps.length;b<c;b++)updateTrap(Traps[b],a)}function updateTrap(a,c){updateEntity(a,c);overlap(Player.x,Player.y,TILE,TILE,a.x,a.y,TILE,TILE)&&killPlayer(Player)}function checkTreasure(){var a;var c=0;for(a=Treasure.length;c<a;c++){var b=Treasure[c];!TreasureCatched&&overlap(Player.x,Player.y,TILE,TILE,b.x,b.y,TILE,TILE)&&(collectTreasure(b),ClickSound.play())}}
function killPlayer(a){a.x=a.start.x;a.y=a.start.y;a.dx=a.dy=0;restartLevel();loadLevel()}function collectTreasure(a){TreasureCatched=!0;Level++;LevelDataLoaded=!1;loadLevel()}
function updateEntity(a,c){var b=0>a.dx,d=0<a.dx,e=a.falling,f=a.friction*(e?.5:1),g=a.accel*(e?.5:1);a.ddx=0;a.ddy=a.gravity;a.left?a.ddx-=g:b&&(a.ddx+=f);a.right?a.ddx+=g:d&&(a.ddx-=f);!a.jump||a.jumping||e||(a.ddy-=a.impulse,a.jumping=!0);a.player&&!a.jumping&&(b||d)&&-16!=a.dx?FootStepsSound.play():a.player&&(FootStepsSound.pause(),FootStepsSound.currentTime=0);a.x+=c*a.dx;a.y+=c*a.dy;a.dx=bound(a.dx+c*a.ddx,-a.maxdx,a.maxdx);a.dy=bound(a.dy+c*a.ddy,-a.maxdy,a.maxdy);if(b&&0<a.dx||d&&0>a.dx)a.dx=
0;b=p2t(a.x);d=p2t(a.y);e=a.x%TILE;f=a.y%TILE;g=tcell(b,d);var h=tcell(b+1,d),k=tcell(b,d+1),l=tcell(b+1,d+1);if(0<a.dy){if(k&&!g||l&&!h&&e)a.y=t2p(d),a.dy=0,a.falling=!1,a.jumping=!1,f=0}else 0>a.dy&&(g&&!k||h&&!l&&e)&&(a.y=t2p(d+1),a.dy=0,g=k,h=l,f=0);if(0<a.dx){if(h&&!g||l&&!k&&f)a.x=t2p(b),a.dx=0}else 0>a.dx&&(g&&!h||k&&!l&&f)&&(a.x=t2p(b+1),a.dx=0);a.falling=!(k||e&&l);a.y>Width&&killPlayer(a)}
function setup(a){window.DOMParser?(parser=new DOMParser,xmlDoc=parser.parseFromString(a,"text/xml")):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async=!1,xmlDoc.loadXML(a));LevelDoc=xmlDoc;LevelDataLoaded=!0;loadData(LevelDoc)}
function loadData(a){restartLevel();var c=a.getElementsByTagName("map")[0].getElementsByTagName("data")[0].childNodes[0].nodeValue;a=a.getElementsByTagName("map")[0].getElementsByTagName("objectgroup")[0].getElementsByTagName("object");var b;for(b=0;b<a.length;b++){var d=a[b];var e=setupEntity(d);switch(d.getAttribute("type")){case "player":Player=e;break;case "treasure":Treasure.push(e);break;case "trap":Traps.push(e)}}Cells=c.split(",").map(function(a){return parseInt(a)})}
function setupEntity(a){var c={};c.x=parseInt(a.getAttribute("x"));c.y=parseInt(a.getAttribute("y"));c.dx=0;c.dy=0;c.gravity=METER*GRAVITY;c.maxdx=METER*MAXDX;c.maxdy=METER*MAXDY;c.impulse=METER*IMPULSE;c.accel=c.maxdx/ACCEL;c.friction=c.maxdx/FRICTION;a=a.getAttribute("type");c.trap="trap"==a;c.player="player"==a;c.treasure="treasure"==a;c.start={x:c.x,y:c.y};return c}var counter=0,dt=0,now,last=timestamp();
function frame(){now=timestamp();for(dt+=Math.min(1,(now-last)/1E3);dt>STEP;)dt-=STEP,update(STEP);render(ctx,counter,dt,Width,Height,MapTransparency,MAP);last=now;counter++;requestAnimationFrame(frame,Canvas)}
function loadLevel(){Level>LEVEL_MAX?credits():(document.getElementsByTagName("body")[0].style.background=COLOR.LIGHTS_ON,LanternUsed=!0,2!=Level||TutorialRemoved||(removeTutorial(),TutorialRemoved=!0),MapTransparency=1,LevelDataLoaded?loadData(LevelDoc):get("levelsData/level"+Level+".xml",function(a){setup(a.responseText)}),FrameCalled||(frame(),FrameCalled=!0),LightsTimeout&&clearTimeout(LightsTimeout),LightsTimeout=setTimeout(function(){1!=Level||TutorialPrinted||(printTutorial(),TutorialPrinted=
!0);LanternUsed=!1;MapTransparency=0;LightsSound.play();document.getElementsByTagName("body")[0].style.background=COLOR.LIGHTS_OFF},TIME_SWITCH_LIGHTS_OFF))}
(function(){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)});document.addEventListener("keydown",function(a){return onkey(a,a.keyCode,!0)},!1);document.addEventListener("keyup",function(a){return onkey(a,a.keyCode,!1)},!1);FootStepsSound.load=!0;loadLevel()})();