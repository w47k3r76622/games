(()=>{var e={t:"Aaarrrrggg!!",i:{o:"I",s:"W"},m:{p:"N",l:"E",g:"S",h:"W"},v:{u:10},A:{S:2,_:3,M:4,T:5,$:6,j:7,I:10}};const t={};var a={N:{o:"I",O:"NEW",P:"TURN",D:"WORLD",R:"NEXT",G:"KEY",H:"UPD",L:"SET",B:"CHANGE",U:"SAIL",Y:"REP",k:"UP",I:"BOMB"},on(e,a){((e,a)=>{t[e]=(t[e]||[]).concat([a])})(e,a)},emit(e,a){(t[e]||[]).forEach(e=>e(a))}};const{emit:r,N:i}=a,{m:n,A:o}=e,s=e=>t=>{const a=t.find(t=>t.event===e);if(a){const{event:e,...t}=a;r(e,t)}},m=e=>t=>{t.find(t=>t.event===i.U&&t.direction===e)&&r(i.U,e)};var d={keyThrottle:(e,t)=>{let a,r;return i=>{if("Space"===i.code&&i.target===document.body&&i.preventDefault(),!a||i.code!==r){if(Element.prototype.scrollIntoViewIfNeeded){const e=document.querySelector(`e[gid="${o.T}"]`);e&&e.scrollIntoViewIfNeeded()}e(i.code),a=!0,setTimeout(()=>{a=!1},t)}r=i.code}},ArrowUp:m(n.p),ArrowDown:m(n.g),ArrowLeft:m(n.h),ArrowRight:m(n.l),KeyB:s(i.I),KeyN:()=>r(i.O),KeyR:s(i.Y),KeyU:s(i.k),Space:()=>r(i.P)},p={map:(e={},t=(e=>e))=>Object.entries(e).map(([e,a])=>({[e]:t(a,e)})).reduce((e,t)=>({...e,...t}),{}),find:(e={},t=(()=>!1))=>e[Object.keys(e).find(a=>t(e[a],a))],reduce:(e={},t=(e=>e),a={})=>Object.entries(e).reduce((e,[a,r])=>t(e,r,a),a),filter:(e={},t=(()=>!0))=>Object.entries(e).filter(([e,a])=>t(a,e)).reduce((e,[t,a])=>({...e,[t]:a}),{}),filterValues:(e={},t=(()=>!0))=>Object.keys(e).filter(a=>t(e[a],a)).map(t=>e[t]),range:e=>[...Array(e).keys()]};const{layers:l=[],width:y,height:c,tilewidth:g,tileheight:x}={height:20,layers:[{data:[0,0,0,0,0,0,0,0,0,0,0,9,10,10,10,10,10,10,10,10,0,0,4,5,6,0,0,0,0,0,0,14,3,10,10,10,2,3,10,10,5,5,8,10,7,5,5,5,5,6,0,0,14,15,15,15,16,14,3,10,10,10,10,10,10,10,10,10,10,7,5,5,6,0,0,0,0,0,9,10,3,10,10,10,10,2,3,10,10,10,10,10,11,0,0,0,0,0,14,15,14,15,15,15,15,16,14,15,15,15,15,15,16,0,0,0,0,0,0,0,0,0,0,4,5,5,5,6,0,0,0,0,0,0,0,0,0,0,4,5,0,0,4,8,10,10,10,7,6,0,0,0,0,4,5,6,0,4,8,10,0,4,8,10,10,10,10,10,7,6,0,4,5,8,10,11,0,9,10,10,0,9,10,10,10,10,10,10,10,7,5,8,10,10,10,7,5,8,10,10,0,9,10,10,2,3,10,10,10,10,10,10,10,10,10,10,10,10,10,10,0,14,15,15,16,9,10,10,10,10,10,2,15,3,10,2,3,10,10,10,5,6,0,0,0,14,15,15,3,10,2,16,0,14,15,16,14,3,10,10,10,7,6,0,0,0,0,0,14,15,16,0,0,0,0,0,0,9,10,10,10,10,7,6,0,4,5,5,6,0,0,0,0,4,5,6,0,14,3,10,10,10,10,11,0,9,10,10,7,6,0,0,4,8,10,11,0,0,9,10,10,10,2,16,0,9,10,10,10,7,5,5,8,10,10,7,5,6,14,15,10,2,16,0,0,9,10,10,10,10,10,10,10,10,10,10,10,11,0,0,10,7,5,6,0,14,15,15,15,15,3,10,2,3,10,10,2,16,0,0,10,10,10,11,0,0,0,0,0,0,14,15,16,14,15,15,16,0,0,0],height:20,name:"Terrain",opacity:1,type:"tilelayer",visible:!0,width:20,x:0,y:0},{draworder:"topdown",name:"Entities",objects:[{id:50,template:"ta0.json",x:896,y:384},{id:51,template:"ta1.json",x:0,y:576},{id:10,template:"te0.json",x:1216,y:384},{id:12,template:"te0.json",x:704,y:192},{id:13,template:"te0.json",x:64,y:832},{id:17,template:"tp.json",x:0,y:64},{id:19,template:"te0.json",x:448,y:128},{id:22,template:"tep0.json",x:1088,y:64},{id:23,template:"te1.json",x:512,y:448},{id:24,template:"te2.json",x:1088,y:1024},{id:25,template:"ta2.json",x:1216,y:1216},{id:26,template:"tap0.json",x:768,y:640},{id:27,template:"tep2.json",x:448,y:1152},{id:29,template:"tep1.json",x:128,y:640},{id:30,template:"te1.json",x:192,y:832},{id:31,template:"te1.json",x:512,y:896},{id:32,template:"tb.json",x:64,y:1152},{id:33,template:"te2.json",x:704,y:1280},{id:34,template:"te2.json",x:320,y:1280},{id:35,template:"te1.json",x:768,y:896},{id:36,template:"tep1.json",x:640,y:768}],opacity:1,type:"objectgroup",visible:!0,x:0,y:0}],tileheight:64,tilewidth:64,width:20},h={"tp.json":{gid:5,name:"player",visible:!0,armor:50,damage:35,hp:50,maxArmor:50,maxHp:50},"tb.json":{gid:2,name:"boss",visible:!0,aggressive:!0,armor:200,damage:150,hp:150,maxArmor:200,maxHp:150},"tap0.json":{gid:6,name:"Small Ally Port",visible:!0,aggressive:!0,damage:45,hp:70,armor:80,maxArmor:100,maxHp:100},"tap1.json":{gid:6,name:"Medium Ally Port",visible:!0,aggressive:!0,armorUp:200,damage:75,hp:150,armor:150,maxArmor:150,maxHp:150},"tap2.json":{gid:6,name:"Big Ally Port",visible:!0,aggressive:!0,armorUp:300,damage:150,hp:200,armor:200,maxArmor:200,maxHp:200},"tep0.json":{gid:7,name:"Small Enemy Port",visible:!0,aggressive:!0,armorUp:100,damage:45,hp:100,armor:100,maxArmor:100,maxHp:100},"tep1.json":{gid:7,name:"Medium Enemy Port",visible:!0,aggressive:!0,armorUp:200,damage:74,hp:150,armor:150,maxArmor:150,maxHp:150},"tep2.json":{gid:7,name:"Big Enemy Port",visible:!0,aggressive:!0,armorUp:300,damage:110,hp:200,armor:200,maxArmor:200,maxHp:200},"ta0.json":{gid:4,name:"Weak Ally",visible:!0,aggressive:!0,armor:50,damage:35,hp:50,maxArmor:50,maxHp:50},"ta1.json":{gid:4,name:"Medium Ally",visible:!0,aggressive:!0,armor:66,damage:77,hp:77,maxArmor:66,maxHp:77},"ta2.json":{gid:4,name:"Strong Ally",visible:!0,aggressive:!0,armor:150,damage:100,hp:110,maxArmor:150,maxHp:110},"te0.json":{gid:3,name:"weak enemy",visible:!0,aggressive:!0,armor:50,damage:35,hp:50,maxArmor:50,maxHp:50},"te1.json":{gid:3,name:"Medium Enemy",visible:!0,aggressive:!0,armor:66,damage:77,hp:77,maxArmor:66,maxHp:77},"te2.json":{gid:3,name:"Strong Enemy",visible:!0,aggressive:!0,armor:150,damage:100,hp:110,maxArmor:150,maxHp:110}},{m:v}=e,u=l.find(e=>"Terrain"===e.name)||{},f=l.find(e=>"Entities"===e.name)||{};var E={minX:0,minY:0,maxX:0+y-1,maxY:0+y-1,world:{width:y,terrain:u.data,entities:((e=[])=>e.reduce((e,t)=>({...e,[t.id]:(e=>({...e,y:e.y-1}))((({template:e,x:t,y:a,...r})=>({...r,x:t/g,y:a/x}))({...t,...h[t.template]}))}),{}))(f.objects)},coords:e=>({x:e%y,y:Math.floor(e/y)}),position:(e,t)=>t*y+e,directionCoords:({x:e,y:t,direction:a})=>({[v.p]:{x:e,y:t-1},[v.g]:{x:e,y:t+1},[v.l]:{x:e+1,y:t},[v.h]:{x:e-1,y:t}})[a]};const{find:A,reduce:S}=p,{directionCoords:b}=E,{A:_,m:M}=e,T=({entities:e,x:t,y:a,filter:r=(()=>!0)})=>A(e,e=>e.x===t&&e.y===a&&r(e)),$=e=>void 0===e.hp||e.hp>0,j=e=>e.gid===_.T;var w={toObj:e=>e.reduce((e,t)=>({...e,[t.id]:t}),{}),playerEntity:e=>A(e,j),entityAt:T,entityWillBeAt:({entities:e,x:t,y:a,filter:r=(()=>!0)})=>A(e,e=>r(e)&&$(e)&&!(e=>e.gid===_.I)(e)&&(e.destX===t&&e.destY===a||void 0===e.destX&&void 0===e.destY&&e.x===t&&e.y===a)),entitiesNearby:({entities:e,x:t,y:a,filter:r=(()=>!0)})=>S(M,(i,n)=>[...i,...(i=>{const{x:n,y:o}=b({direction:i,x:t,y:a}),s=T({entities:e,x:n,y:o,filter:$});return s&&r(s)?[s]:[]})(n)],[]),isPort:e=>[_.$,_.j].includes(e.gid),isAlliedPort:e=>e.gid===_.$,isPlayer:j,isBoss:e=>e.gid===_.S,isEnemyShip:e=>e.gid===_._,areOpposed(e,t){const a=[_.T,_.M,_.$],r=[_.S,_._,_.j];return a.includes(e.gid)&&r.includes(t.gid)||r.includes(e.gid)&&a.includes(t.gid)},newId:e=>S(e,(e,t)=>Math.max(e,t.id),0)+1};const{A:I}=e,{newId:N}=w,{minX:O,maxX:P,minY:D,maxY:R,position:G}=E,{v:H,m:L}=e;var B={terrainAt:({terrain:e,x:t,y:a})=>e[G(t,a)],locationAt:({x:e,y:t},a)=>({[L.p]:{x:e,y:t>D?t-1:t},[L.g]:{x:e,y:t<R?t+1:t},[L.l]:{x:e<P?e+1:e,y:t},[L.h]:{x:e>O?e-1:e,y:t}})[a]||{x:e,y:t},isLand:e=>e===H.u};const{find:U}=p,{m:Y}=e,{N:k}=a,{entitiesNearby:V,playerEntity:W,entityAt:C,isAlliedPort:X,isEnemyShip:q}=w,{terrainAt:K,isLand:F,locationAt:z}=B,J=(e,t)=>e<t?0:e-t,Q=(e,t,a)=>Math.min(e+t<a?0:e+t-a,e),Z=(e,t=[])=>t.findIndex(t=>e<t),ee=(e,t)=>e<=0?Math.floor(t/10):0;var te={roundOutcome(e,t){const{hp:a,damage:r,armor:i}=e,{hp:n,damage:o,armor:s}=t,m=Q(a,i,o),d=Q(n,s,r);return{hp1:m,hp2:d,damage1:r+ee(d,o),armor1:J(i,o),armor2:J(s,r),damage2:o+ee(m,r)}},playerActions({state:e}={}){if(!e)return[{event:k.O}];if(e.gameOver||e.victory)return[{event:k.O}];const t=e.entities,a=e.world.terrain,{x:r,y:i,armor:n,maxArmor:o,id:s}=W(t);return[...(({terrain:e,entities:t,x:a,y:r})=>Object.keys(Y).reduce((i,n)=>[...i,...(({terrain:e,entities:t,x:a,y:r,direction:i})=>{const{x:n,y:o}=z({x:a,y:r},i),s=K({terrain:e,x:n,y:o}),m=C({entities:t,x:n,y:o,filter:e=>e.hp>0||e.timeout>0});return F(s)?[]:m?[]:[{event:k.U,direction:i}]})({terrain:e,entities:t,x:a,y:r,direction:Y[n]})],[]))({terrain:a,entities:t,x:r,y:i}),...(({entities:e,x:t,y:a})=>[{event:k.I,x:t,y:a}])({entities:t,x:r,y:i}),...(({entities:e,x:t,y:a,armor:r,maxArmor:i,id:n})=>{const o=i-r,s=V({entities:e,x:t,y:a,filter:X}),m=U(e,e=>e.enemyId===n&&e.hp>0&&q(e))||o<=0?[]:s.map(e=>({event:k.Y,portId:e.id}));return[...s.filter(e=>e.armorUp>i).map(e=>({event:k.k,portId:e.id})),...m]})({entities:t,x:r,y:i,armor:n,maxArmor:o,id:s})]},hpDamage:Q,armorDamage:J,damageLevel:Z,percentOfLevel:(e,t=[])=>{const a=Z(e,t),r=t[a-1]||0;return 100*(e-r)/(t[a]-r)}};const{playerActions:ae}=te,{i:re}=e,{playerActions:ie}=te,{i:ne}=e,{playerEntity:oe}=w,{playerEntity:se,entityAt:me}=w,{terrainAt:de,locationAt:pe,isLand:le}=B,{playerActions:ye}=te,{playerEntity:ce}=w,{A:ge}=e,{toObj:xe,entitiesNearby:he,isBoss:ve,isPlayer:ue}=w,{filterValues:fe,find:Ee}=p,{hpDamage:Ae,armorDamage:Se}=te;var be=e=>{const t=e.entities,a=fe(t,e=>e.gid===ge.I&&e.visible);return a.length?(a=>{const r=a.reduce((e,a)=>({...e,...a.timeout?(e=>({[e.id]:{...e,timeout:e.timeout-1}}))(a):(e=>{const{id:a,x:r,y:i,damage:n}=e,o=he({entities:t,x:r,y:i,filter:e=>e.hp>0}).map(e=>({...e,hp:Ae(e.hp,e.armor,n),armor:Se(e.armor,n)}));return{[a]:{...e,visible:!1},...xe(o)}})(a)}),{}),i=Ee(r,e=>ue(e)&&e.hp<=0),n=Ee(r,e=>ve(e)&&e.hp<=0);return{...e,gameOver:e.gameOver||i,victory:e.victory||n,entities:{...t,...r}}})(a):{}};const{filter:_e,map:Me}=p,{filterValues:Te}=p,{roundOutcome:$e}=te,{entitiesNearby:je,areOpposed:we,isPlayer:Ie,isBoss:Ne}=w;const{filterValues:Oe}=p,{isPort:Pe,isPlayer:De,entityWillBeAt:Re}=w;const{playerEntity:Ge}=w;const{playerEntity:He}=w,{damageLevel:Le}=te,{A:Be}=e,{toObj:Ue,isPort:Ye}=w,{filterValues:ke}=p;var Ve=e=>{const t=e.entities,a=ke(t,e=>Ye(e)&&e.hp<=0).map(e=>({...e,gid:(e=>e===Be.j?Be.$:Be.j)(e.gid),hp:e.maxHp,armor:e.maxArmor,enemyId:void 0}));return{...e,entities:{...t,...Ue(a)}}};const{map:We,filter:Ce}=p,{entityAt:Xe}=w;var qe,Ke=(e={})=>{const t=e.entities||{},a=We(Ce(t,e=>e.hp>0),e=>{const{id:a,name:r,destX:i,destY:n}=e;return void 0===i||void 0===n?e:Xe({entities:t,x:i,y:n,filter:e=>e.hp>0})?e:{...e,x:i,y:n,destX:void 0,destY:void 0}});return{...e,entities:{...t,...a}}};const Fe=(e={},t=[])=>t.reduce((e,t)=>({...e,...t(e)}),e);(qe=(({oldState:e,state:t,config:a,sound:r})=>Fe({...e,...t},[t=>(({state:e={},oldState:t={}})=>{const a=e.entities||{},r=t.entities||{},i=_e(a,e=>void 0!==e.hp),n=Me(i,e=>{const t=i[e.enemyId]||{};return{...e,visible:!(e.hp<=0&&r[e.id].hp<=0),enemyId:t.hp>0?t.id:void 0}});return{...e,entities:{...a,...n}}})({state:t,oldState:e}),be,t=>(({state:e={},oldState:t={}}={})=>Oe(e.entities||{},e=>e.hp>0&&e.enemyId&&!Pe(e)&&!De(e)).reduce((e,a)=>({...e,...(({state:e,entity:a})=>{const r=e.entities||{},i=t.entities||{},{id:n,name:o,x:s,y:m,enemyId:d}=a,p=i[d],l=t=>({...e,entities:{...r,[a.id]:{...a,...t}}});return r[d].hp<=0?l({enemyId:void 0}):Math.abs(p.x-s)>1||Math.abs(p.y-m)>1?l({enemyId:void 0}):l(Re({entities:r,x:p.x,y:p.y})?{enemyId:void 0}:{destX:p.x,destY:p.y})})({state:e,entity:a})}),e))({state:t,oldState:e}),e=>(({state:e={},sound:t})=>{const a=e.entities||{},{sounds:r,play:i}=t;return Te(a,e=>e.hp>0&&e.aggressive).reduce((e,t)=>({...e,...(({state:e,entity:t})=>{const a=e.entities||{},{id:n,name:o,x:s,y:m}=t,d=je({entities:a,x:s,y:m,filter:e=>we(e,t)});if(!d.length)return e;const p=d[0],{hp1:l,armor1:y,damage1:c,hp2:g,armor2:x,damage2:h}=$e(t,p);i(r.cannons);const v=e=>e.hp>0?e.id:void 0;return{...e,gameOver:e.gameOver||Ie(p)&&g<=0,victory:e.victory||Ne(t)&&l<=0||Ne(p)&&g<=0,entities:{...a,[t.id]:{...t,hp:l,armor:y,damage:c,destX:void 0,destY:void 0,enemyId:v(p)},[p.id]:{...p,hp:g,armor:x,damage:h,destX:void 0,destY:void 0,enemyId:v(t)}}}})({state:e,entity:t})}),e)})({state:e,sound:r}),Ke,t=>(({state:e={},oldState:t={},config:a={},sound:r})=>{const{sounds:i,play:n}=r,o=e.entities||{},s=t.entities||{},m=He(o)||{},{damage:d}=He(s)||{},p=Le(m.damage,a.damageLevels),l=Le(d,a.damageLevels);return{...e,...p>l?(()=>{n(i.upgrade);const e=m.maxHp+a.hpPerLevel;return{entities:{...o,[m.id]:{...m,hp:e,maxHp:e,armor:m.maxArmor}}}})():{}}})({state:t,oldState:e,config:a,sound:r}),e=>(({state:e={},config:t={}})=>{const a=e.entities||{},r=Ge(a)||{},i=r.hp>0?{entities:{...a,[r.id]:{...r,hp:(({hp:e,maxHp:t},a)=>e<t?Math.min(e+a,t):e)(r,t.hpPerTurn)}}}:{};return{...e,...i}})({state:e,config:a}),Ve]))).combinedReducers=Fe;const{map:ze}=p,{A:Je}=e,{N:Qe}=a,{t:Ze}=e,et={[Qe.O]:()=>({text:"New game (N)"})};var tt=({state:e})=>`\n    ${(e.actions||[]).filter(e=>et[e.event]).map(t=>{const{text:a,data:r=""}=et[t.event]({...t,entities:e.entities}),i="object"==typeof r?JSON.stringify(r):`"${r}"`;return`<button onclick='emit("${t.event.toString()}", ${i})'>${a}</button>`}).join("")}\n    <h1>${Ze}</h1>\n`;const{range:at}=p;const{damageLevel:rt}=te,{isPort:it}=w,nt=(e,t)=>e>0?100*e/t:0,ot=({className:e,valuePercent:t})=>`<bar class="${e}" style="width:${t}%"></bar>`,{v:st}=e,{coords:mt}=E,{entityAt:dt,playerEntity:pt}=w,{filter:lt}=p,yt={[st.V]:"w",[st.u]:"l"};const{playerEntity:ct}=w,{percentOfLevel:gt}=te;var xt=({state:e,config:t})=>{const{damage:a}=ct(e.entities)||{},r=e.gameOver?"<game-over>Game Over</game-over>":"",i=e.victory?"<victory>Victory</victory><grats>YOU'VE SUNK THE BASTARD!</grats>":"";return`\n    ${`<bar class="dmg" style="width:${gt(a,t.damageLevels)}%"></bar>`}\n    \n    <world ${e.gameOver||e.victory?"game-over":""}>${(({state:e,config:t})=>{const a=lt(e.entities,e=>e.visible),r=pt(a);return(e.world.terrain||[]).map((e,i)=>{const n=yt[e]||yt[st.V],o=e===st.V?"":` gid=${e}`,{x:s,y:m}=mt(i),d=dt({entities:a,x:s,y:m})||{};return`<${n}${o}>${d.gid?(({props:e={},player:t,config:a={}})=>{const{hp:r,maxHp:i,armor:n,maxArmor:o,gid:s,name:m,timeout:d,damage:p,armorUp:l,enemyId:y}=e,c=rt(p,a.damageLevels),g=-1===c?"":` level=${c}`,x=void 0===y?"":` enemy=${y}`,h=l&&l>t.maxArmor?` [ upgrade: armor(${l}) ]`:"",v=m?` title="${m}${void 0!==r?` [ ${r} hp + ${n}, dmg: ${p} ]`:""}${h}"`:"",u=h?` armor-up=${l}`:"",f=void 0===d?"":` timeout=${d+1}`,E=!it(e)&&r<=0?" sink":"",A=nt(r,i),S=nt(n,o);return`<e gid=${s}${g}${x}${u}${E}${v}${f}>${void 0===r?"":ot({className:"hp",valuePercent:A})}${void 0===n?"":ot({className:"armor",valuePercent:S})}</e>`})({props:d,player:r,config:t}):""}</${n}>`}).join("")})({state:e,config:t})}</world>\n\n    ${r}\n    ${i}\n    \n    <menu>${e.gameOver||e.victory?tt({state:e}):""}</menu>\n  `};const{emit:ht,on:vt,N:ut}=a,{i:ft,A:Et}=e;let At={};var St={SoundEffect:e=>{let t,a,r,i,n,o,s,m,d,p;const l=()=>{t=0,a=100/(e.p_base_freq*e.p_base_freq+.001),r=100/(e.p_freq_limit*e.p_freq_limit+.001),i=e.p_freq_limit>0,n=1-.01*Math.pow(e.p_freq_ramp,3),o=1e-6*-Math.pow(e.p_freq_dramp,3),s=.5-.5*e.p_duty,m=5e-5*-e.p_duty_ramp,d=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),p=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1===e.p_arp_speed&&(p=0)};l();let y=parseInt(e.wave_type),c=.1*Math.pow(e.p_lpf_freq,3),g=1!==e.p_lpf_freq,x=1+1e-4*e.p_lpf_ramp,h=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+c);h>.8&&(h=.8);let v=.1*Math.pow(e.p_hpf_freq,2),u=1+3e-4*e.p_hpf_ramp,f=.01*Math.pow(e.p_vib_speed,2),E=.5*e.p_vib_strength,A=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],S=e.p_env_punch,b=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(b=-b);let _=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(_=-_);let M=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0===e.p_repeat_speed&&(M=0);const T=Math.exp(e.sound_vol)-1,$=e.sample_rate,j=e.sample_size;return{getRawBuffer(){let e=0,w=0,I=0,N=Array(32).fill().map(()=>2*Math.random()-1),O=0,P=0,D=0,R=0,G=0,H=Array(1024).fill(0),L=0;const B=[];let U=0,Y=0,k=Math.floor(44100/$);for(let $=0;0!==M&&++t>=M&&l(),0!==p&&$>=p&&(p=0,a*=d),!((a*=n+=o)>r&&(a=r,i));++$){let t=a;E>0&&(t=a*(1+Math.sin(D+=f)*E));let r,i=Math.floor(t);if(i<8&&(i=8),(s+=m)<0&&(s=0),s>.5&&(s=.5),++P>A[O]&&(P=0,++O>2))break;let n=P/A[O];switch(O){case 0:r=n;break;case 1:r=1+2*(1-n)*S;break;case 2:r=1-n}b+=_;let o=Math.abs(Math.floor(b));o>1023&&(o=1023),0!==u&&((v*=u)<1e-5&&(v=1e-5),v>.1&&(v=.1));let d=0;for(let t=0;t<8;++t){let t=0;if(++R>=i&&(R%=i,3===y))for(let e=0;e<32;++e)N[e]=2*Math.random()-1;const a=R/i;switch(y){case 0:t=a<s?.5:-.5;break;case 1:t=a<s?2*a/s-1:1-2*(a-s)/(1-s);break;case 2:t=Math.sin(2*a*Math.PI);break;case 3:t=N[Math.floor(32*R/i)]}let n=e;(c*=x)<0&&(c=0),c>.1&&(c=.1),g?(w+=(t-e)*c,w-=w*h):(e=t,w=0),I+=(e+=w)-n,H[1023&G]=t=I-=I*v,t+=H[G-o+1024&1023],G=G+1&1023,d+=t*r}U+=d,++Y<k||(Y=0,d=U/k,U=0,d=d/8*1,d*=T,8===j?((d=Math.floor(128*(d+1)))>255?(d=255,++L):d<0&&(d=0,++L),B.push(d)):((d=Math.floor(32768*d))>=32768?(d=32767,++L):d<-32768&&(d=-32768,++L),B.push(255&d),B.push(d>>8&255)))}return{buffer:B,clipped:L}},bitsPerChannel:j,sampleRate:$}},normalized:(e,t)=>e.map(e=>2*e/Math.pow(2,t)-1)},bt={};const{SoundEffect:_t,normalized:Mt}=St,Tt=["wave_type","p_env_attack","p_env_sustain","p_env_punch","p_env_decay","p_base_freq","p_freq_limit","p_freq_ramp","p_freq_dramp","p_vib_strength","p_vib_speed","p_arp_mod","p_arp_speed","p_duty","p_duty_ramp","p_repeat_speed","p_pha_offset","p_pha_ramp","p_lpf_freq","p_lpf_ramp","p_lpf_resonance","p_hpf_freq","p_hpf_ramp"];bt.paramsFromArray=(e=>e.reduce((e,t,a)=>({...e,[Tt[a]]:"wave_type"===Tt[a]?t:t/1e4}),{})),bt.toWebAudio=((e,t)=>{if(!e||!t)return;const{getRawBuffer:a,bitsPerChannel:r,sampleRate:i}=_t(e),n=Mt(a().buffer,r),o=t.createBuffer(1,n.length,i),s=o.getChannelData(0);n.forEach((e,t)=>{s[t]=e});const m=t.createBufferSource();return m.buffer=o,m});var $t={intro:[[1,1e4,1e4,0,1e4,4050,0,0,6128,9579,9314,-4912,-2620,8622,263,7399,363,-2813,6500,739,-467,1604,-27]],cannons:[[3,0,3857,7713,4644,2560,0,-3745,0,0,0,0,0,0,0,0,-2487,-706,1e4,0,0,0,0]],dropBomb:[[0,-719,8804,3824,1973,2731,0,-83,-4133,1335,8319,2828,-8407,-3975,4885,-257,-25,-38,5702,4342,-8580,22,0]],explode:[[3,0,3702,4627,1367,444,0,-3586,0,0,0,0,0,0,0,0,0,0,1e4,0,0,0,0]],sink:[[2,421,3900,-795,5890,580,0,1e4,-600,790,3500,-4900,3530,3876,1788,3260,1580,-4490,2110,-100,1550,1650,2210]],upgrade:[[2,1984,104,507,6465,4906,0,221,380,-1117,2443,4947,3165,-7701,2719,6174,-52,-5601,9067,179,8721,5203,-53]],repair:[[0,4438,86,2205,5432,-277,0,3166,1619,-6264,1086,908,46,7022,-1654,2633,-1618,460,9188,1323,-7364,-62,217]]};const{toWebAudio:jt,paramsFromArray:wt}=bt,{N:It,emit:Nt}=a,{world:Ot}=E,Pt=(()=>{const e=new(window.AudioContext||window.webkitAudioContext),t=[];return{play:a=>{if(!a||!a.length)return;const r=Math.floor(Math.random()*a.length),i=wt(a[r]);i.sample_rate=44100,i.sample_size=8,i.sound_vol=.25;try{const a=jt(i,e);a.connect(e.destination),a.start(0),t.push(a),a.onended=(()=>{const e=t.findIndex(e=>e===a);-1!==e&&t.splice(e,1)})}catch(e){}},stop:()=>{t.forEach(e=>{e.stop()})},sounds:$t}})();window.emit=Nt,(({config:e,root:t,world:a,sound:r})=>{const{sounds:i,play:n}=r,o=document.querySelector(t);document.addEventListener("keydown",d.keyThrottle(e=>{ht(ut.G,e)},e.throttleKeysMs)),vt(ut.G,e=>{const t=d[e];t&&t(At.actions)}),vt(ut.o,()=>{ht(ut.L,(()=>({stage:re.o,actions:ie()}))())}),vt(ut.O,()=>{ht(ut.L,(({entities:e,terrain:t,width:a})=>({stage:ne.s,entities:e,world:{terrain:t,width:a}}))(a)),ht(ut.R)}),vt(ut.I,({x:e,y:t})=>{n(i.dropBomb),ht(ut.P,(e=>(t,a)=>{const r=N(e.entities);return{entities:{...e.entities,[r]:{id:r,gid:I.I,name:"Time bomb",visible:!0,x:t,y:a,timeout:3,damage:150}}}})(At)(e,t))}),vt(ut.U,e=>{ht(ut.P,(e=>t=>{const a=e.entities,r=e.world.terrain,i=se(e.entities),{x:n,y:o}=pe({x:i.x,y:i.y},t),s=de({terrain:r,x:n,y:o}),m=me({entities:a,x:n,y:o,filter:e=>e.hp>0});return le(s)?{}:m?{}:{entities:{...e.entities,[i.id]:{...i,x:n,y:o,enemyId:void 0}}}})(At)(e))}),vt(ut.Y,()=>{n(i.repair),ht(ut.P,(e=>{const t=oe(e.entities);return{...e,entities:{...e.entities,[t.id]:{...t,armor:t.maxArmor}}}})(At))}),vt(ut.k,({portId:e})=>{n(i.upgrade),ht(ut.P,(e=>t=>{const a=ce(e.entities),r=e.entities[t],i=r.armorUp||a.maxArmor;return{...e,entities:{...e.entities,[a.id]:{...a,hp:a.maxHp,armor:i,maxArmor:i},[r.id]:{...r,armorUp:void 0}}}})(At)(e))}),vt(ut.P,(e={})=>{e.gameOver?ht(ut.H,(e=>({...e,actions:ae({state:e})}))(e)):ht(ut.D,e)}),vt(ut.D,t=>{ht(ut.H,qe({oldState:At,state:t,config:e,sound:r})),ht(ut.R)}),vt(ut.R,()=>{ht(ut.H,(e=>({actions:ye({state:e})}))(At))}),vt(ut.L,e=>{const t=At;At={...e},ht(ut.B,{state:At,oldState:t})}),vt(ut.H,e=>{const t=At;At={...At,...e},ht(ut.B,{state:At,oldState:t})}),vt(ut.B,({state:t,oldState:a})=>{o.innerHTML=(0,{[ft.o]:({state:e,config:t})=>{const a=t.flagFragmentWidthPx,r=t.flagFragments,i=a*r;return`\n    <intro>\n      <flag style="width: ${i}px; transform: scale(${.25*document.body.clientWidth/i})">\n        ${at(r).map(e=>`<span style="${`background-position-x: ${-e*a}px;`+`animation-delay: ${50*e}ms;`+`width: ${a}px`}"></span>`).join("")}\n      </flag>\n      \n      <menu>${tt({state:e})}</menu>\n      \n      <q>Be the outlaw -- step out of(f) line...</q>\n          \n    </intro>\n  `},[ft.s]:xt}[t.stage])({state:t,config:e}),(({oldState:e,state:t,sound:a})=>{const{sounds:r,play:i,stop:n}=a;e.stage?e.stage!==t.stage&&n():i(r.intro),ze(t.entities,({id:t,gid:a,hp:n,visible:o})=>{const s=(e.entities||{})[t],m=s&&a===Je.I&&s.visible&&!o;o&&void 0!==n&&n<=0&&i(r.sink),m&&i(r.explode)})})({oldState:a,state:t,sound:r})})})({config:{hpPerTurn:10,throttleKeysMs:100,flagFragmentWidthPx:25,flagFragments:8,hpPerLevel:50,damageLevels:[0,50,100,999]},root:"#app",world:Ot,sound:Pt}),Nt(It.o)})();