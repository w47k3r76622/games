function Map(){this.w=0,this.h=0,this.tiles=null,this.init(),this.addBlocks();for(var a=10;a<this.w;a+=40)for(var b=20;b<this.h;b+=40)this.addCaves(a,b)}function Terrain(a){this.size=M.pow(2,a)+1,this.max=this.size-1,this.map=new Float32Array(this.size*this.size)}function Tile(a,b,c){this.x=a,this.y=b,this.c=c,this.val=0,this.d={count:0,max:0},this.shakeDuration=0,this.sprite=document.createElement("canvas"),this.sprite.width=Map.TILE,this.sprite.height=Map.TILE+18,this.buffer=this.sprite.getContext("2d"),this.onShakeComplete=null,this.bypassHardness=!1,this.onDigComplete=void 0}function Death(a,b){this.x=a,this.y=b,this.delay=0,this.speed=30+8*M.random()}function Gain(a,b){this.x=a,this.y=b,this.delay=0}function Miner(a,b){Entity.init.call(this,a,b),this.digDelay=0,this.size=16,this.canJump=!0,this.canExplode=0,this.currentTile=new Tile,this.showHelpDelay=0,this.animatedDeath=!0,this.direction=0,this.speed=5}function Walker(a,b){Entity.init.call(this,a,b),this.size=20,this.f={x:.93,y:.93},this.follow=void 0,this.digDelay=0,this.currentTile=new Tile,this.animatedDeath=!0,this.follow=void 0,this.digDown=M.random()>.5}function colorLuminance(a,b){a=String(a).replace(/[^0-9a-f]/gi,""),a.length<6&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),b=b||0;var c,d,e="#";for(d=0;3>d;d++)c=parseInt(a.substr(2*d,2),16),c=Math.round(Math.min(Math.max(0,c+c*b),255)).toString(16),e+=("00"+c).substr(c.length);return e}function update(a){var b=(a-start)/1e3;start=a,Game.update(b),Game.render(),window.requestAnimationFrame(update)}function _drawSkyCanvas(a,b,c){a.save(),a.fillStyle="#FF8601",a.beginPath(),a.rect(0,0,b,c),a.fill(),a.clip(),a.fillStyle="#FFE7CA";var d=b/4;a.beginPath(),a.arc(b/2,c-(d+24)+.4*Camera.y,d,0,M.PI,!0),a.fill(),a.restore(),a.beginPath(),a.fillStyle="#202020";for(var e=40,f=[0,.7,.1,.3,.2,1,.3,.5,.35,.8,.42,.5,.55,.9,.7,.45,.8,1.1,.88,.4,1,.8],g=0;g<f.length;g+=2){var h=f[g]*b,i=.2*Camera.y-78+c-e*f[g+1];0===g?a.moveTo(h,i):a.lineTo(h,i)}a.lineTo(b,c),a.lineTo(0,c),a.fill(),a.restore(),a.save()}TILES={GRASS:30,DIRT1:31,DIRT2:26,CELL:27,SAND:112,REDWOOD:29,SPIKES:25,GHOST:36,BOMB1:35,BOMB2:33,WALKER:34,CRATE:22,data:[{c:"#B68956",h:3},{c:"#CFA26F",h:2},{c:"#E9BC89",h:2},{c:"#845724",h:1},{c:"#808752",h:2},{c:"#ca9607",h:2},{c:"#c57ea8",h:2},{c:"#54d0ba",h:2},{c:"#a93dd0",h:2},{c:"#2ca90d",h:2},{c:"#e1fb58",h:2},{c:"#D9835F",h:2}],get:function(a){return 0>=a?void 0:(this.data[a]&&void 0===this.data[a].y&&(this.data[a].y=0),this.data[a])}},TILES.data[TILES.GRASS]={p:0},TILES.data[TILES.DIRT1]={p:1},TILES.data[TILES.DIRT2]={p:5},TILES.data[TILES.REDWOOD]={p:2},TILES.data[TILES.CELL]={p:3},TILES.data[TILES.BOMB1]={p:3,y:1},TILES.data[TILES.BOMB2]={p:5,y:1},TILES.data[TILES.SPIKES]={p:6},TILES.data[TILES.CRATE]={h:6,p:4};var Camera={x:0,y:0,w:0,h:0,_follow:null,tile:{x:0,y:0},setDimension:function(a,b){this.w=a,this.h=b,this.tileHeight=this.h/Map.TILE,this.tileCountForWidth=~~(this.w/Map.TILE),this.tileCount=~~(this.w/Map.TILE*(this.h/Map.TILE))+6*Camera.tileCountForWidth},set follow(a){this._follow=a,this.x=this._follow.x-this.w/2,this.y=this._follow.y-this.h/2},update:function(a){this._follow&&(this.x=~~M.lerp(this.x,this._follow.x-this.w/2,4*a),this.y=~~M.lerp(this.y,this._follow.y-this.h/2,4*a)),this.x<0?this.x=0:this.x>Game.map.w*Map.TILE-this.w&&(this.x=Game.map.w*Map.TILE-this.w),this.y<96?this.y=96:this.y>Game.map.h*Map.TILE-this.h&&(this.y=Game.map.h*Map.TILE-this.h),this.tile.x=~~(this.x/Map.TILE),this.tile.y=~~(this.y/Map.TILE)},onCamera:function(a,b,c){return c=c||0,a>this.x+c&&b>this.y+c&&a<this.x+this.w-c&&b<this.y+this.h-c}},Input={keyMap:{37:"left",65:"left",81:"left",38:"up",90:"up",87:"up",83:"down",40:"down",39:"right",68:"right",32:"space",27:"esc",13:"enter"},keys:{},onKey:function(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&0===c&&(c=b.charCode);var d=this.keyMap[c];d&&(this.keys[d]=a)}};Map.TILE=32,Map.CAVE_WIDTH=9,Map.CAVE=[2,1,2,2,2,2,2,1,2,1,1,1,1,1,1,1,1,1,2,1,0,0,0,0,0,1,2,2,1,0,0,0,0,0,1,2,2,1,0,0,0,0,0,1,2,2,1,0,0,0,0,0,1,2,2,1,0,0,0,0,0,1,2,2,1,0,0,0,0,0,1,2,2,1,0,0,0,0,0,1,2,1,1,1,1,1,1,1,1,1,2,1,2,2,2,2,2,1,2],Map.BLOCK_SIZE=4,Map.blocks=[[1,1,1,1,1,0,1,1,27,0,27,1,1,33,1,1],[1,1,0,0,1,0,0,1,0,0,22,1,1,25,27,1],[1,1,0,0,1,0,0,25,0,0,25,1,1,25,1,1],[27,22,1,1,1,1,1,1,1,0,1,1,1,25,1,1],[27,0,1,1,1,0,1,1,1,0,1,1,1,25,1,1],[1,1,1,1,1,0,0,1,27,35,35,27,1,1,1,1],[1,1,1,1,1,34,27,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,0,1,1,22,27,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,34,27,1,1,1,33,22],[1,1,1,1,1,0,0,1,27,22,22,27,1,25,1,1]],Map.prototype={init:function(){function a(a,c,d){if(c===b.max||a===b.max)return 0;var e=2*b.max*b.roughness,f=M.abs(~~d)/e;return f=~~(10*f)+1}var b=new Terrain(9);b.generate(1.5);for(var c=0;c<b.size;c++)for(var d=0;d<b.size;d++){var e=b.get(d,c);e=a(d,c,e),b.set(d,c,e)}this.w=b.size,this.h=b.size,this.tiles=new Float32Array(this.w*this.h);for(var c=0;10>c;c++)for(var d=0;d<b.size;d++)this.tiles[d+b.size*c]=0;for(var c=10;11>c;c++)for(var d=0;d<b.size;d++)this.tiles[d+b.size*c]=TILES.GRASS;for(var c=11;c<this.h-10;c++)for(var d=0;d<b.size;d++)this.tiles[d+b.size*c]=b.get(d,c);for(var c=this.h-6;c<this.h;c++)for(var d=0;d<b.size;d++){var f=0;c===this.h-1?f=TILES.SPIKES:c===this.h-2&&M.random()<.6&&(f=TILES.SPIKES),this.tiles[d+b.size*c]=f}for(var c=11;21>c;c++)for(var d=0;d<b.size;d++)(13>=c||M.random()>.8*c/21)&&(M.random()>.3?this.tiles[d+b.size*c]=TILES.DIRT1:this.tiles[d+b.size*c]=TILES.DIRT2)},addBlocks:function(){for(var a=this.w/2,b=0;b<this.w;b+=Map.BLOCK_SIZE)for(var c=13;c<this.h;c+=Map.BLOCK_SIZE){var d=M.abs(a-b)/this.w,e=c/this.h/2;e>d&&(d=e),M.random()>.8-d&&this.addBlock(b,c)}},addBlock:function(a,b){for(var c=~~(M.random()*Map.blocks.length),d=Map.blocks[c],e=d.length,f=0,g=0,h=M.random()>.5;e--;){g=~~(e/Map.BLOCK_SIZE),f=e-g*Map.BLOCK_SIZE,h&&(f=Map.BLOCK_SIZE-f);var i=d[e];1!==i&&this.setTile(a+f,b+g,i)}},addCaves:function(a,b){a-=~~(Map.CAVE_WIDTH/2);for(var c=0,d=0,e=0,f=Map.CAVE.length;f--;)d=~~(f/Map.CAVE_WIDTH),c=f-d*Map.CAVE_WIDTH,e=Map.CAVE[f],1===e?this.setTile(a+c,b+d,TILES.REDWOOD):0===e&&this.setTile(a+c,b+d,0)},getTile:function(a,b){return this.isValidTile(a,b)?this.tiles[b*this.w+a]:void 0},setTile:function(a,b,c){this.isValidTile(a,b)&&(this.tiles[b*this.w+a]=c)},isTileSolid:function(a,b){if(!this.isValidTile(a,b))return!0;var c=this.tiles[b*this.w+a],d=TILES.get(c);return c===TILES.GHOST||void 0!==d},isDiggable:function(a,b){if(!this.isValidTile(a,b))return!0;var c=this.tiles[b*this.w+a],d=TILES.get(c);return c===TILES.GHOST||void 0!==d&&c!==TILES.CELL&&c!==TILES.SPIKES},isDiggableAndSafe:function(a,b){if(!this.isValidTile(a,b))return!0;var c=this.tiles[b*this.w+a],d=TILES.get(c);return c===TILES.BOMB1||c===TILES.BOMB2?!1:c===TILES.GHOST||void 0!==d&&c!==TILES.CELL&&c!==TILES.SPIKES},isValidTile:function(a,b){return a>=0&&b>=0&&a<this.w&&b<this.h},getIndexForTile:function(a,b){return b*this.w+a},getTileForIndex:function(a){var b=~~(a/this.w),c=a-b*this.w;return{x:c,y:b}},getCoordForTile:function(a,b){return{x:~~(a*Map.TILE),y:~~(b*Map.TILE)}}},Terrain.prototype.get=function(a,b){return 0>a||a>this.max||0>b||b>this.max?-1:this.map[a+this.size*b]},Terrain.prototype.set=function(a,b,c){this.map[a+this.size*b]=c},Terrain.prototype.generate=function(a){function b(c){var g,h,i=c/2,j=a*c;if(!(1>i)){for(h=i;h<f.max;h+=c)for(g=i;g<f.max;g+=c)d(g,h,i,M.random()*j*2-j);for(h=0;h<=f.max;h+=i)for(g=(h+i)%c;g<=f.max;g+=c)e(g,h,i,M.random()*j*2-j);b(c/2)}}function c(a){var b=a.filter(function(a){return-1!==a}),c=b.reduce(function(a,b){return a+b},0);return c/b.length}function d(a,b,d,e){var g=c([f.get(a-d,b-d),f.get(a+d,b-d),f.get(a+d,b+d),f.get(a-d,b+d)]);f.set(a,b,g+e)}function e(a,b,d,e){var g=c([f.get(a,b-d),f.get(a+d,b),f.get(a,b+d),f.get(a-d,b)]);f.set(a,b,g+e)}var f=this;f.roughness=a,this.set(0,0,f.max),this.set(this.max,0,f.max/2),this.set(this.max,this.max,0),this.set(0,this.max,f.max/2),b(this.max)},Tile.prototype={reset:function(){this.d.count=0,this.d.max=0,this.x=0,this.y=0,this.val=0,this.c=0},shake:function(a,b){this.onShakeComplete=b,this.shakeDuration=a},update:function(a){this.shakeDuration>0&&(this.shakeDuration-=a)<0&&(this.shakeDuration=0,this.onShakeComplete&&this.onShakeComplete())},dig:function(a,b,c){if(!Game.map.isDiggable(a,b))return this.reset(),!1;if(this.x===a&&this.y===b)(this.bypassHardness||this.d.count++>this.d.max)&&(this.val===TILES.BOMB1||this.val===TILES.BOMB2?Game.explode(a,b):this.val===TILES.CRATE&&Game.miner===c&&(Game.score+=1,Game.add(new Gain(this.x*Map.TILE+Map.TILE/2,this.y*Map.TILE+Map.TILE/2))),Game.map.setTile(this.x,this.y,0),this.val=0);else{this.val=Game.map.getTile(a,b);var d=TILES.get(this.val);d?(this.x=a,this.y=b,this.d.max=d.h||1,this.d.count=1):this.reset()}return!0},select:function(a,b){if(Game.map.isDiggable(this.x,this.y)){rx=~~(this.x*Map.TILE)-Camera.x,ry=~~(this.y*Map.TILE)-Camera.y;var c=this.d.count/this.d.max;a.fillStyle="rgba(0, 0, 0,"+.2*c+")",a.lineWidth=1,a.strokeStyle="white",a.beginPath(),Game.map.isTileSolid(this.x,this.y-1)?(a.fillRect(rx,ry,Map.TILE,Map.TILE),b&&a.rect(rx,ry,Map.TILE,Map.TILE)):(a.fillRect(rx,ry-18,Map.TILE,Map.TILE+18),b&&a.rect(rx,ry-18,Map.TILE,Map.TILE+18)),a.stroke()}},render:function(a){this.buffer.clearRect(0,0,Map.TILE,Map.TILE+18),this.buffer.fillStyle=this.c,this.buffer.fillRect(0,18,Map.TILE,Map.TILE),Game.map.isTileSolid(~~(this.x/Map.TILE),~~(this.y/Map.TILE)-1)||(this.buffer.fillStyle=colorLuminance(this.c,-.2),this.buffer.fillRect(0,0,Map.TILE,18)),a.save(),this.shakeDuration>0&&a.translate(~~(6*(.5-M.random())),~~(3*(.5-M.random()))),a.fillStyle="white",a.drawImage(this.sprite,~~(this.x-Camera.x),~~(this.y-Camera.y)-18),a.restore()}},Death.DELAY=6,Death.prototype={update:function(a){this.delay+=a,this.delay>Death.DELAY&&(this.delay=Death.DELAY,Game.remove(this)),this.y-=a*this.speed},render:function(a){a.globalAlpha=1-this.delay/Death.DELAY,a.drawImage(Game.sprite,96,25,16,16,this.x-16-Camera.x+30*M.sin(a.globalAlpha*Math.PI*10),this.y-Camera.y,32,32),a.globalAlpha=1}},Entity={XCAP:.3,YCAP:.7,init:function(a,b){this.tile={x:0,y:0},this.xr=0,this.yr=0,this.x=a,this.y=b,this.v={x:0,y:0},this.f={x:.91,y:.97},this.gravity=3,this.onGround=!1,this.moving=!1,Entity.updatePosition.call(this)},distance:function(a){return M.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))},overlaps:function(a){var b=this.size/2+a.size/2,c=(a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y);return b*b>=c},updatePosition:function(){this.tile.x=~~(this.x/Map.TILE),this.tile.y=~~(this.y/Map.TILE),this.xr=(this.x-this.tile.x*Map.TILE)/Map.TILE,this.yr=(this.y-this.tile.y*Map.TILE)/Map.TILE},update:function(a){for(this.onGround=!1,this.onLeft=!1,this.onRight=!1,this.v.x*=this.f.x,this.v.y*=this.f.y,this.xr+=this.v.x*a,Game.map.isTileSolid(this.tile.x-1,this.tile.y)&&this.xr<=Entity.XCAP&&(this.v.x=0,this.xr=Entity.XCAP,this.onLeft=!0),Game.map.isTileSolid(this.tile.x+1,this.tile.y)&&this.xr>=Entity.YCAP&&(this.v.x=0,this.xr=Entity.YCAP,this.onRight=!0);this.xr<0;)this.tile.x-=1,this.xr+=1;for(;this.xr>1;)this.tile.x+=1,this.xr-=1;for(this.v.y+=this.gravity,this.yr+=this.v.y*a,Game.map.isTileSolid(this.tile.x,this.tile.y-1)&&this.yr<=Entity.XCAP&&(this.v.y=0,this.yr=Entity.XCAP),Game.map.isTileSolid(this.tile.x,this.tile.y+1)&&this.yr>=Entity.YCAP&&(this.v.y=0,this.yr=Entity.YCAP,this.onGround=!0);this.yr<0;)this.tile.y-=1,this.yr+=1;for(;this.yr>1;)this.tile.y+=1,this.yr-=1;var b=this.x,c=this.y;this.x=~~((this.tile.x+this.xr)*Map.TILE),this.y=~~((this.tile.y+this.yr)*Map.TILE),this.moving=b!==this.x||c!==this.y}},Gain.DELAY=.6,Gain.prototype={update:function(a){this.delay+=a,this.delay>Gain.DELAY&&(this.delay=Gain.DELAY,Game.remove(this)),this.y-=70*a},render:function(a){a.globalAlpha=1-this.delay/Gain.DELAY,a.beginPath(),a.arc(this.x-Camera.x,this.y-Camera.y,6,0,2*Math.PI,!0),a.fillStyle="yellow",a.fill(),a.globalAlpha=1}},Miner.DIG_DELAY=.06,Miner.EXPLODE_DELAY=.8,Miner.HELP_DELAY=.8,Miner.prototype={update:function(a){Game.map.isTileSolid(this.tile.x,this.tile.y)?Game.remove(this):Game.map.getTile(this.tile.x,this.tile.y+1)===TILES.SPIKES&&Game.remove(this);var b=!1;(this.digDelay-=a)<0&&(this.digDelay=0),1!==this.direction&&1!==Input.keys.left||!Game.map.isTileSolid(this.tile.x-1,this.tile.y)?2!==this.direction&&1!==Input.keys.right||!Game.map.isTileSolid(this.tile.x+1,this.tile.y)?b=!0:(this.direction=2,this.showHelpDelay=Miner.HELP_DELAY,this.v.x=this.speed,0===this.digDelay&&this.onRight&&this.onGround&&(this.digDelay=Miner.DIG_DELAY,this.currentTile.dig(this.tile.x+1,this.tile.y,this)||(this.direction=0))):(this.direction=1,this.showHelpDelay=Miner.HELP_DELAY,this.v.x=-this.speed,0===this.digDelay&&this.onLeft&&this.onGround&&(this.digDelay=Miner.DIG_DELAY,this.currentTile.dig(this.tile.x-1,this.tile.y,this)||(this.direction=0))),3!==this.direction&&1!==Input.keys.down||!this.onGround?b&&(this.digDelay=Miner.DIG_DELAY,this.currentTile.reset()):(this.direction=3,this.showHelpDelay=Miner.HELP_DELAY,0===this.digDelay&&(this.digDelay=Miner.DIG_DELAY,this.currentTile.dig(this.tile.x,this.tile.y+1,this)||(this.direction=0))),Entity.update.call(this,a),this.moving?this.showHelpDelay=Miner.HELP_DELAY:this.showHelpDelay=this.showHelpDelay>0&&(this.showHelpDelay-=a)<0?0:this.showHelpDelay},render:function(a){this.currentTile.select(a,!0);var b=null;if(Game.map.isTileSolid(this.tile.x,this.tile.y+1)?b=1:Game.map.isTileSolid(this.tile.x,this.tile.y+2)?b=2:Game.map.isTileSolid(this.tile.x,this.tile.y+3)&&(b=3),b&&(a.fillStyle="rgba(0, 0, 0, 0.3)",Canvas.drawEllipse(a,this.x-Camera.x-this.size/2,(this.tile.y+b)*Map.TILE-Camera.y-.43*Map.TILE,this.size,6)),a.beginPath(),a.arc(this.x-Camera.x,this.y-Camera.y-.3*Map.TILE,this.size/2,2*M.PI,!1),a.fillStyle="#FF0000",a.fill(),0===this.showHelpDelay){var c=!0;Game.map.isDiggableAndSafe(this.tile.x,this.tile.y+1)&&(c=!1,a.drawImage(Game.sprite,16,50,16,16,this.tile.x*Map.TILE-Camera.x,(this.tile.y+1)*Map.TILE-Camera.y,32,32)),Game.map.isDiggableAndSafe(this.tile.x-1,this.tile.y)&&(c=!1,a.drawImage(Game.sprite,0,50,16,16,(this.tile.x-1)*Map.TILE-Camera.x,this.tile.y*Map.TILE-Camera.y,32,32)),Game.map.isDiggableAndSafe(this.tile.x+1,this.tile.y)&&(c=!1,a.drawImage(Game.sprite,32,50,16,16,(this.tile.x+1)*Map.TILE-Camera.x,this.tile.y*Map.TILE-Camera.y,32,32)),c&&(Game.stuck=!0,Game.remove(this))}}},Walker.DIG_DELAY=.1,Walker.prototype={update:function(a){Entity.update.call(this,a),Game.map.isTileSolid(this.tile.x,this.tile.y)?Game.remove(this):Game.map.getTile(this.tile.x,this.tile.y+1)===TILES.SPIKES&&Game.remove(this),Entity.overlaps.call(this,Game.miner)&&Game.remove(Game.miner),(this.digDelay-=a)<0&&(this.digDelay=0);var b=Entity.distance.call(this,Game.miner);if(void 0===this.follow&&140>b&&(this.follow=Game.miner),this.follow&&192>b){var c=this.follow.tile.x,d=this.follow.tile.y,e=c-this.tile.x,f=d-this.tile.y;e=e>0?1:0>e?-1:0,f=f>0?1:0>f?-1:0,this.v.x=e,this.onGround&&0===this.digDelay&&(this.digDelay=Walker.DIG_DELAY,this.digDown?f>0?this.currentTile.dig(this.tile.x,this.tile.y+1,0):this.onLeft&&0>e?Game.map.isDiggable(this.tile.x-1,this.tile.y)?this.currentTile.dig(this.tile.x-1,this.tile.y,0):this.currentTile.dig(this.tile.x,this.tile.y+1,0):this.onRight&&e>0&&(Game.map.isDiggable(this.tile.x+1,this.tile.y)?this.currentTile.dig(this.tile.x+1,this.tile.y,0):this.currentTile.dig(this.tile.x,this.tile.y+1,0)):this.onLeft&&0>e?Game.map.isDiggable(this.tile.x-1,this.tile.y)?this.currentTile.dig(this.tile.x-1,this.tile.y,0):this.currentTile.dig(this.tile.x,this.tile.y+1,0):this.onRight&&e>0?Game.map.isDiggable(this.tile.x+1,this.tile.y)?this.currentTile.dig(this.tile.x+1,this.tile.y,0):this.currentTile.dig(this.tile.x,this.tile.y+1,0):f>0&&this.currentTile.dig(this.tile.x,this.tile.y+1,0))}},render:function(a){this.currentTile.select(a,!1),Game.map.isTileSolid(this.tile.x,this.tile.y+1)&&(a.fillStyle="rgba(0, 0, 0, 0.3)",Canvas.drawEllipse(a,this.x-Camera.x-this.size/2,(this.tile.y+1)*Map.TILE-Camera.y-.43*Map.TILE,this.size,6)),a.beginPath(),a.arc(this.x-Camera.x,this.y-Camera.y-.3*Map.TILE,this.size/2,2*M.PI,!1),a.fillStyle="#000",a.fill()}};var Stats=function(){var a=Date.now(),b=a,c=0,d=1/0,e=0,f=0,g=1/0,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),s(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",l.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");for(n.id="fpsGraph",n.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",l.appendChild(n);74>n.children.length;){var o=document.createElement("span");o.style.cssText="width:1px;height:30px;float:left;background-color:#113",n.appendChild(o)}var p=document.createElement("div");p.id="ms",p.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",k.appendChild(p);var q=document.createElement("div");q.id="msText",q.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",q.innerHTML="MS",p.appendChild(q);var r=document.createElement("div");for(r.id="msGraph",r.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",p.appendChild(r);74>r.children.length;)o=document.createElement("span"),o.style.cssText="width:1px;height:30px;float:left;background-color:#131",r.appendChild(o);var s=function(a){switch(j=a){case 0:l.style.display="block",p.style.display="none";break;case 1:l.style.display="none",p.style.display="block"}};return{REVISION:12,domElement:k,setMode:s,begin:function(){a=Date.now()},end:function(){var j=Date.now();c=j-a,d=Math.min(d,c),e=Math.max(e,c),q.textContent=c+" MS ("+d+"-"+e+")";var k=Math.min(30,30-30*(c/200));return r.appendChild(r.firstChild).style.height=k+"px",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",k=Math.min(30,30-30*(f/100)),n.appendChild(n.firstChild).style.height=k+"px",b=j,i=0),j},update:function(){a=this.end()}}};"object"==typeof module&&(module.exports=Stats),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),document.onkeyup=function(a){Input.onKey(0,a)},document.onkeydown=function(a){Input.onKey(1,a)},document.onkeypress=function(a){};var start=0;M=Math,window.onload=function(){Game.canvas=document.getElementById("game"),Game.ctx=Game.canvas.getContext("2d"),Game.ctx.imageSmoothingEnabled=!1,Game.ctx.mozImageSmoothingEnabled=!1,Game.ctx.oImageSmoothingEnabled=!1,Game.ctx.msImageSmoothingEnabled=!1,Game.width=Game.canvas.width,Game.height=Game.canvas.height,Camera.setDimension(Game.canvas.width,Game.canvas.height),Game.load(function(){window.requestAnimationFrame(update)})};var Game={EXPLOSION_SIZE_1:7,EXPLOSION_1:[0,0,0,1,0,0,0,0,0,1,2,1,0,0,0,1,2,3,2,1,0,1,2,3,4,3,2,1,0,1,2,3,2,1,0,0,0,1,2,1,0,0,0,0,0,1,0,0,0],EXPLOSION_SIZE:9,EXPLOSION:[0,0,0,0,1,0,0,0,0,0,0,0,1,2,1,0,0,0,0,0,1,2,3,2,1,0,0,0,1,2,3,4,3,2,1,0,1,2,3,4,5,4,3,2,1,0,1,2,3,4,3,2,1,0,0,0,1,2,3,2,1,0,0,0,0,0,1,2,1,0,0,0,0,0,0,0,1,0,0,0,0],ctx:null,es:[],_toRemove:!1,width:0,height:0,checkGravityDelay:.2,terrain:null,gameOver:!1,stuck:!1,sprite:document.getElementById("sprite"),load:function(a){this.score=0,this.es=[],this.map=new Map,this.miner=new Miner(~~(this.map.w/2)*Map.TILE+Map.TILE/2,9*Map.TILE+Map.TILE/2),this.add(this.miner),Camera.follow=this.miner,this.shake=0,this.dialogContainer=document.getElementById("dialog-container"),this.dialog=document.getElementById("dialog"),a&&a()},explode:function(a,b){for(var c=~~(Game.EXPLOSION_SIZE/2),d=Game.EXPLOSION.length,f=0,g=0;d--;){g=~~(d/Game.EXPLOSION_SIZE),f=d-g*Game.EXPLOSION_SIZE;var h=a+f-c,i=b+g-c;0!==Game.EXPLOSION[d]&&Game.map.isTileSolid(h,i)&&setTimeout(function(a,b){return function(){var c=Game.map.getCoordForTile(a,b),d=Game.map.getIndexForTile(a,b),e=TILES.get(Game.map.tiles[d]);if((Game.map.tiles[d]===TILES.BOMB1||Game.map.tiles[d]===TILES.BOMB2)&&(Game.map.setTile(a,b,TILES.GHOST),Game.explode(a,b)),e){Game.map.setTile(a,b,TILES.GHOST);var f=Game.add(new Tile(c.x,c.y,e.c));f.shake(.2,function(a,b,c){return function(){Game.map.setTile(b,c,0),Game.remove(a)}}(f,a,b))}}}(h,i),40*(6-Game.EXPLOSION[d]))}d=this.es.length,e=void 0;for(var j=4;d--;)e=this.es[d],e.tile&&e.tile.x>a-(c-j/2)&&e.tile.x<a+Game.EXPLOSION_SIZE-j&&e.tile.y>b-(c-j/2)&&e.tile.y<b+Game.EXPLOSION_SIZE-j&&Game.remove(e)},add:function(a){return this.es.push(a),a},remove:function(a){this._toRemove=!0,a._toRemove=!0,a===this.miner&&(this.gameOver=!0)},update:function(a){Camera.update(a),(this.shake-=a)<0&&(this.shake=0);var b=0,c=0;if(this.checkGravityDelay=this.checkGravityDelay-a,this.checkGravityDelay<0){this.checkGravityDelay=.2;for(var d=0,e=0,f=0;f<Camera.tileCount;f++)d=f%Camera.tileCountForWidth,Camera.tile.x>0&&(d+=Camera.tile.x),e=~~(f/Camera.tileCountForWidth),Camera.tile.y>0&&(e+=Camera.tile.y),b=this.map.getTile(d,e),b===TILES.CELL||b===TILES.BOMB1||b===TILES.BOMB2||b===TILES.SPIKES||b===TILES.CRATE?this.map.isTileSolid(d,e+1)||(this.map.setTile(d,e,0),this.map.setTile(d,e+1,b)):b===TILES.WALKER&&(this.add(new Walker(d*Map.TILE,e*Map.TILE)),this.map.setTile(d,e,0))}if(this._toRemove){this._toRemove=!1;var g=[],h=this.es.length;for(c=0;h>c;c++){var i=this.es[c];i._toRemove!==!0?g.push(i):i.animatedDeath&&g.push(new Death(i.x,i.y-i.size))}this.es=g}for(c=this.es.length;c--;)Camera.onCamera(this.es[c].x,this.es[c].y)&&this.es[c].update(a)},render:function(){if(this.ctx.fillStyle="#202020",this.ctx.fillRect(0,0,this.width,this.height),Camera.y>10*Map.TILE){var a=this.ctx.createRadialGradient(this.miner.x-Camera.x,this.miner.y-Camera.y,200,this.miner.x-Camera.x,this.miner.y-Camera.y,30);a.addColorStop(0,"#0A1419"),a.addColorStop(1,"#11232c")}else _drawSkyCanvas(this.ctx,this.width,10*Map.TILE-Camera.y);this.shake>0&&(this.ctx.save(),this.ctx.translate(~~(6*(.5-M.random())),~~(3.4*(.5-M.random()))));for(var b=new Array,c=0,d=0,e=0,f=0,g=0,h=0;h<Camera.tileCount;h++){d=h%(Camera.tileCountForWidth+2),Camera.tile.x>0&&(d+=Camera.tile.x),e=~~(h/(Camera.tileCountForWidth+2)),Camera.tile.y>0&&(e+=Camera.tile.y),c=this.map.getIndexForTile(d,e);var i=this.map.tiles[c];if(void 0!==i){var j=TILES.get(i);if(j)if(f=~~(d*Map.TILE)-Camera.x,g=~~(e*Map.TILE)-Camera.y,void 0!==j.p){var k=j.p,l=j.y;(i===TILES.BOMB1||i===TILES.BOMB2)&&b.push({x:f,y:g,tx:d,ty:e}),this.map.isTileSolid(d,e-1)?this.ctx.drawImage(Game.sprite,16*k,25*l+9,16,16,f,g,32,32):this.ctx.drawImage(Game.sprite,16*k,25*l,16,25,f,g-18,32,50)}else this.ctx.fillStyle=j.c,this.ctx.fillRect(f,g,Map.TILE,Map.TILE),this.map.isTileSolid(d,e-1)||(this.ctx.fillStyle=colorLuminance(j.c,-.2),this.ctx.fillRect(f,g-18,Map.TILE,18)),this.ctx.beginPath(),this.ctx.globalAlpha=.1,this.ctx.strokeStyle="#000",this.ctx.rect(f,g,Map.TILE,Map.TILE),this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle="#000"}for(var m=b.length;m--;){var n=b[m];this.map.isTileSolid(n.tx,n.ty-1)?this.ctx.drawImage(Game.sprite,0,34,48,16,n.x-Map.TILE,n.y,96,32):this.ctx.drawImage(Game.sprite,0,25,48,25,n.x-Map.TILE,n.y-18,96,50),this.map.isTileSolid(d,e+1)||(this.ctx.globalCompositeOperation="overlay",this.ctx.fillStyle="rgb(0, 0, 0, 0.3)",this.ctx.fillRect(f,g+Map.TILE-1,Map.TILE,1),this.ctx.globalCompositeOperation="source-over")}for(c=this.es.length;c--;)Camera.onCamera(this.es[c].x,this.es[c].y)&&this.es[c].render(this.ctx);this.gameOver&&(this.dialogContainer.style.display="block",this.dialog.innerHTML=this.stuck?"STUCK":"GAME OVER",Input.keys.space&&(this.load(),this.dialogContainer.style.display="none",this.gameOver=!1,this.stuck=!1)),this.ctx.beginPath(),this.ctx.arc(18,22,6,0,2*Math.PI,!0),this.ctx.fillStyle="yellow",this.ctx.fill(),this.ctx.font="24px Arial, sans-serif",this.ctx.fillStyle="white",this.ctx.fillText(this.score,32,30)}},Canvas={drawEllipse:function(a,b,c,d,e){var f=.5522848,g=d/2*f,h=e/2*f,i=b+d,j=c+e,k=b+d/2,l=c+e/2;a.beginPath(),a.moveTo(b,l),a.bezierCurveTo(b,l-h,k-g,c,k,c),a.bezierCurveTo(k+g,c,i,l-h,i,l),a.bezierCurveTo(i,l+h,k+g,j,k,j),a.bezierCurveTo(k-g,j,b,l+h,b,l),a.fill()}};Math.lerp=function(a,b,c){return(1-c)*a+c*b},Math.sqrtDistance=function(a,b,c,d){return(a-c)*(c-a)+(d-b)*(d-b)},Math.angle=function(a,b,c,d){return Math.atan2(d-b,c-a)},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();