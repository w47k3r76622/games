(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))h(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&h(c)}).observe(document,{childList:!0,subtree:!0});function l(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function h(n){if(n.ep)return;n.ep=!0;const o=l(n);fetch(n.href,o)}})();function Me(t){return Math.floor(t*Math.random())}function Ve(t){for(var i=t.length;i;){var l=Me(i),h=t[--i];t[i]=t[l],t[l]=h}}const Bt=3,Dt=[...Array(Bt).keys()].map(t=>t+1),Se=9,Je=[...Array(Se).keys()].map(t=>t+1);function Mt(t){return t===1||t===9}const X=Dt.reduce((t,i)=>(t.push(...Je.map(l=>Ze(i,l))),t),[]),$e=X[X.length-1];function Ze(t,i){return(Se+1)*(t-1)+i}function x(t){return Math.ceil(t/(Se+1))}function L(t){return t%(Se+1)}function pe(t){return Mt(L(t))}function J(t){if(t.length<2)return!1;const i=t[0];for(let l=1;l<t.length;l++)if(t[l]!==i)return!1;return!0}function F(t){if(t.length<2)return!1;const i=t[0];for(let l=1;l<t.length;l++)if(t[l]!==i+l)return!1;return!0}function Ye(t){return pe(t[0])||pe(t[t.length-1])}function Lt(t,i){return t.length==1||J(t)?[...t,i]:F(t)?i<t[0]?[i,...t]:[...t,i]:[t[0],i,t[1]]}function Ne(t,i){let l=t.length-i.length;if(l)return l;for(let h=0;h<t.length;h++)if(l=t[h]-i[h],l)return l;return 0}function ue(t){const i=Array($e+1).fill(0);for(const l of t)i[l]++;return i}function*he(t,i=t.reduce((h,n)=>h+=n,0),l=[]){if(i===1){const n=t.indexOf(1);n>0&&(yield[...l,[n],[n]]);return}else if(i==4){const n=t.findIndex(o=>o>=2);if(n>0){if(t[n]===4)return;const o=t.indexOf(2,n+1);if(o>0){yield[...l,[n,n],[o,o],[o]],yield[...l,[o,o],[n,n],[n]];return}const c=t.slice();c[n]-=2;const s=c.indexOf(1);if(s>0){const S=c.indexOf(1,s+1);if(S>0&&x(S)===x(s))if(S==s+1){const T=L(S);T===2?yield[...l,[n,n],[s,S],[S+1]]:T===9?yield[...l,[n,n],[s,S],[s-1]]:yield[...l,[n,n],[s,S],[s-1,S+1]]}else S==s+2&&(yield[...l,[n,n],[s,S],[s+1]])}}}else if(i===13){const n=t.reduce((o,c,s)=>(c===2&&o.push([s,s]),o),[]);if(n.length===6){const o=t.indexOf(1);o>0&&(yield[...n,[o],[o]])}}const h=l.length?l[l.length-1][0]:0;for(const n of X){if(n<h)continue;const o=t[n];if(o){if(o>=3){l.push([n,n,n]);const s=t.slice();s[n]-=3,yield*he(s,i-3,l),l.pop()}const c=n+1;if(t[c]){const s=n+2;if(t[s]&&x(n)===x(s)){l.push([n,c,s]);const S=t.slice();S[n]--,S[c]--,S[s]--,yield*he(S,i-3,l),l.pop()}}}}}function Gt(t){const i=new Set;for(const l of he(t))for(const h of l[l.length-1])t[h]<4&&i.add(h);return i}function Pt(t,i){const l=new Map;e:for(const h of t.reduce((n,o,c)=>(o&&n.push(c),n),[])){const n=t.slice();n[h]--;const o=new Set;for(const c of he(n))for(const s of c[c.length-1]){if(i[s])continue e;t[s]<4&&o.add(s)}o.size&&l.set(h,o)}return l}const xe=1,Be=2,et=3,He=1,je=2,De=3,tt=4,nt=1,st=2,it=3,lt=4,at=5,rt=6,ot=7,ct=8,dt=9,ft=10,ut=11,ht=12,gt=13,mt=14,Tt=15,pt=16,St=17,Le=18,yt=19,It=20,Rt=21,Ct=22,bt=23,At=new Map([[nt,{name:"Reach",score:1}],[st,{name:"Double Reach",score:2}],[it,{name:"One Shot",score:1}],[lt,{name:"Last Stock",score:1}],[at,{name:"Last Discard",score:1}],[rt,{name:"Win from Stock",score:1}],[ot,{name:"All Middles",score:1}],[ct,{name:"All Sequences",score:1}],[dt,{name:"Pure Double Sequences",score:1}],[ft,{name:"Mixed Triple Sequences",score:2}],[ut,{name:"Pure Straight",score:2}],[ht,{name:"Seven twins",score:2}],[gt,{name:"All Triplets",score:2}],[mt,{name:"Three Closed Triplets",score:2}],[Tt,{name:"Mixed Triple Triplets",score:3}],[pt,{name:"All Outside",score:3}],[St,{name:"Pure Double Sequences",score:3}],[Le,{name:"Full Flush",score:0}],[yt,{name:"All Terminals",score:13}],[It,{name:"Blessing of Heaven",score:13}],[Rt,{name:"Blessing of Earth",score:13}],[Ct,{name:"Four Closed Triplets",score:13}],[bt,{name:"Nine Gates",score:13}]]);function Ot(t){return At.get(t).name}function Et(t,i){switch(t){case Le:return 2+Math.floor(i/3);default:return At.get(t).score}}function vt(t,i,l,h,n,o){const c=new Set;for(const T of he(t)){if(!T[T.length-1].includes(i))continue;const W=T.slice(0,T.length-2);if(W.length===6){c.add(ht);continue}const k=T[T.length-2];F(k)&&!Ye(k)&&W.slice(0,W.length-1).every(p=>F(p))&&c.add(ct);const m=[Lt(k,i),...W];m.sort(Ne),m.every(p=>Ye(p))&&c.add(pt),m.every(p=>J(p))&&c.add(gt);const O=W.reduce((p,R)=>p+(R.length>=3&&J(R)?1:0),0)+(n&&k.length===2&&J(k)?1:0);O===3?c.add(mt):O===4&&c.add(Ct);e:for(let p=1;p<m.length-1;p++)if(!Ne(m[p],m[p+1])){for(let R=p+1;R<m.length-1;R++)if(!Ne(m[R],m[R+1])){c.add(St);break e}c.add(dt);break}e:for(let p=1;p<m.length-2;p++){const R=m[p];if(F(R)&&L(R[0])===1){const w=x(R[0]);for(let b=p+1;b<m.length-1;b++){const A=m[b];if(F(A)&&L(A[0])===4&&x(A[0])===w)for(let _=b+1;_<m.length;_++){const E=m[_];if(F(E)&&L(E[0])===7&&x(E[0])===w){c.add(ut);break e}}}}}e:for(let p=1;p<m.length-2;p++){const R=m[p];if(F(R)&&x(R[0])===1){const w=L(R[0]);for(let b=p+1;b<m.length-1;b++){const A=m[b];if(F(A)&&x(A[0])===2&&L(A[0])===w)for(let _=b+1;_<m.length;_++){const E=m[_];if(F(E)&&x(E[0])===3&&L(E[0])===w){c.add(ft);break e}}}}}e:for(let p=1;p<m.length-2;p++){const R=m[p];if(J(R)&&x(R[0])===1){const w=L(R[0]);for(let b=p+1;b<m.length-1;b++){const A=m[b];if(J(A)&&x(A[0])===2&&L(A[0])===w)for(let _=b+1;_<m.length;_++){const E=m[_];if(J(E)&&x(E[0])===3&&L(E[0])===w){c.add(Tt);break e}}}}}}h&&(h===De?c.add(nt):h===tt&&c.add(st),l===et&&c.add(it)),n?l===xe?c.add(It):l===Be?c.add(Rt):(o||c.add(lt),c.add(rt)):o||c.add(at);const s=t.slice();s[i]++,s.every((T,C)=>!T||!pe(C))?c.add(ot):s.every((T,C)=>!T||pe(C))&&c.add(yt);const S=x(i);return t.every((T,C)=>!T||x(C)===S)&&(Je.every(T=>s[Ze(S,T)]>=[3,1,1,1,1,1,1,1,3][T-1])?c.add(bt):c.add(Le)),[...c].sort((T,C)=>T-C)}class Ke{constructor(){this.playerIndex=-1,this.concealedTiles=[],this.discardedTiles=[],this.turnState=0,this.reachState=0,this.reachableMap=new Map,this.reachedDiscardedIndex=-1,this.winnableSet=new Set,this.matchScore=0,this.gameScore=0,this.place=0}isReachable(){return this.reachState===He}isReaching(){return this.reachState===je}setReaching(i){this.reachState=i?je:He}isReached(){return this.reachState>=De}isTileReachable(i){return this.reachableMap.has(i)}updateReachable(){this.isReached()||(this.winnableSet.has(this.concealedTiles[this.concealedTiles.length-1])?this.reachableMap.clear():this.reachableMap=Pt(ue(this.concealedTiles),ue(this.discardedTiles)),this.reachState=this.reachableMap.size?He:0)}updateReached(){this.isReaching()?(this.reachState=this.turnState?tt:De,this.reachedDiscardedIndex=this.discardedTiles.length-1,this.turnState=et):this.turnState=0}updateWinnableSet(){this.winnableSet=Gt(ue(this.concealedTiles))}sortTiles(){this.concealedTiles.sort((i,l)=>i-l)}}class Qe{constructor(){this.stockTiles=[],this.bases=[],this.currentBaseIndex=-1,this.winnerBaseIndex=-1,this.loserBaseIndex=-1,this.readyTiles=null,this.winningTile=0,this.winningHands=null,this.handsScore=0}getCurrentBase(){return this.bases[this.currentBaseIndex]}dealTiles(i){this.stockTiles.push(...X,...X,...X,...X),Ve(this.stockTiles);for(const l of this.bases)l.concealedTiles.push(...this.stockTiles.splice(0,i)),l.updateWinnableSet(),l.sortTiles();this.stockTiles=this.stockTiles.slice(0,14*this.bases.length)}pickTile(){return this.stockTiles.pop()}drawTile(i){this.currentBaseIndex=(this.currentBaseIndex+1)%this.bases.length;const l=this.getCurrentBase();l.concealedTiles.push(i),l.updateReachable()}discardTile(i){const l=this.getCurrentBase();l.discardedTiles.push(...l.concealedTiles.splice(l.concealedTiles.lastIndexOf(i),1)),l.updateReached(),l.updateWinnableSet(),l.sortTiles()}canWin(i,l){return this.bases[i].winnableSet.has(l)}think(){const i=Array($e+1).fill(0),l=ue(this.getCurrentBase().concealedTiles),h=[0,1,2,3,4,5,4,3,2,1];for(const c of X){const s=L(c);let S=l[c]*5+h[s];s>=2&&(l[c-1]&&(S+=10),s>=3&&l[c-2]&&(S+=5)),s<=8&&(l[c+1]&&(S+=10),s<=7&&l[c+2]&&(S+=5)),i[c]=S}let n=Number.MAX_SAFE_INTEGER,o=[];for(const c of X){if(!l[c])continue;const s=i[c];s<=n&&(s<n?(n=s,o=[c]):s===n&&o.push(c))}return o[Me(o.length)]}}const ze=["You","Alice","Bob","Carol"];class Wt{constructor(i){this.name=i}}class kt{constructor(){this.playerCount=0,this.dealCount=0,this.roundCount=0,this.players=null,this.games=null}getCurrentGame(){return this.games[this.games.length-1]}startGame(){this.manualPlayerIndex=Me(this.playerCount);let i=ze.slice(1);Ve(i),i=i.slice(0,this.playerCount-1),i.splice(this.manualPlayerIndex,0,ze[0]),this.players=[],this.games=[];const l=new Qe;for(let h=0;h<this.playerCount;h++){const n=new Wt(i[h]);this.players.push(n);const o=new Ke;o.playerIndex=h,o.turnState=h===0?xe:Be,l.bases.push(o)}l.dealTiles(this.dealCount),this.games.push(l)}nextGame(){const i=this.getCurrentGame(),l=new Qe;for(let h=0;h<this.playerCount;h++){const n=i.bases[(h+1)%this.playerCount],o=new Ke;o.playerIndex=n.playerIndex,o.matchScore=n.matchScore+n.gameScore,o.turnState=h===0?xe:Be,l.bases.push(o)}l.dealTiles(this.dealCount),this.games.push(l)}winGame(i,l,h){const n=this.getCurrentGame();n.winnerBaseIndex=i;const o=n.bases[i],c=l<0;c?(n.readyTiles=o.concealedTiles.slice(),n.winningTile=n.readyTiles.pop()):(n.readyTiles=o.concealedTiles,n.winningTile=h),n.winningHands=vt(ue(n.readyTiles),n.winningTile,o.turnState,o.reachState,c,n.stockTiles.length),n.handsScore=n.winningHands.reduce((T,C)=>(T+=Et(C,this.dealCount),T),0),console.log(n.readyTiles,n.winningTile,o.turnState,o.reachState,c,n.stockTiles.length,n.winningHands,n.handsScore);const s=n.handsScore*Math.max(this.playerCount-1,1);if(o.gameScore=s,c)for(let T=1;T<this.playerCount;T++){const C=n.bases[(i+T)%this.playerCount];C.gameScore=-n.handsScore}else{n.loserBaseIndex=l;const T=n.bases[l];T.gameScore=-s}const S=n.bases.slice().sort((T,C)=>C.matchScore+C.gameScore-T.matchScore-T.gameScore||T.playerIndex-C.playerIndex);for(let T=0;T<S.length;T++)S[T].place=T+1}isFinalGame(){return this.games.length>=this.playerCount*this.roundCount}}function V(t,i,l){t.addEventListener(i,h=>{h.cancelable&&h.preventDefault(),h.stopPropagation(),l(h)})}function fe([t,,i]){return t+i/2}function K([,t,,i]){return t+i/2}function Q([t,i,l,h],[n,o]){return n>=t&&n<t+l&&o>=i&&o<i+h}V(window,"DOMContentLoaded",()=>{const t=document.querySelector("canvas"),i=[1,0,0,1,0,0];let l,h,n,o,c,s;const S=0,T=1,C=2,W=3,k=4;let m;const O=[1,2,3,4],p=[4,7,10,13],R=[0,1,2,4];let w,b,A,_,E,te,ne,se,ie,d,ge,q,le;const ae=1.2,me=7;let N,z,re,$,Y,v,M,P,U,oe,ye,Ie,j;const Ge=new Set;let Z,Te,Pe;const Oe="smallmahjong",H=JSON.parse(localStorage.getItem(Oe))||{};H.playerSelectedIndex in O||(H.playerSelectedIndex=1),H.dealSelectedIndex in O||(H.dealSelectedIndex=1),H.roundSelectedIndex in O||(H.roundSelectedIndex=1);function Re(){return d.isFinalGame()?"Final":`${Math.ceil(d.games.length/d.playerCount)} - ${(d.games.length-1)%d.playerCount+1}`}function Ce(e,a,g,y,u){e.save();try{e.textBaseline="bottom",e.fillText(a,y,u),e.textBaseline="top",e.fillText(g,y,u)}finally{e.restore()}}function ce(e,a,g,y,u,r,f,D,I){e.save();try{if(e.translate(g,y),f&&e.rotate(f),e.fillStyle=a?I?"#ccc":D?"#ff0":"#fff":"#fd0",e.fillRect(-u/2,-r/2,u,r),a){e.font=Math.ceil(u*.5)+'px "Courier New", monospace';const G=x(a);e.fillStyle=["#f00","#090","#00f"][G-1],e.textAlign="center",Ce(e,["▲","■","◉"][G-1],L(a),0,0)}e.strokeStyle="#000",e.strokeRect(-u/2,-r/2,u,r)}finally{e.restore()}}function wt(e){const a=3*s,g=(1-d.playerCount)*a/2,y=d.games.length;let u=-((3+y)*s)/2;e.font=Math.ceil(s*.8)+"px sans-serif",e.textAlign="right";for(let r=0;r<d.playerCount;r++)e.fillText(d.players[r].name,g+a*(1+r),u);u+=s;for(let r=0;r<y;r++){const f=d.games[r];e.fillText(r+1,g,u);for(const D of f.bases)e.fillText(D.gameScore,g+a*(1+D.playerIndex),u);u+=s}e.fillText("Total",g,u);for(const r of d.games[d.games.length-1].bases){const f=g+a*(1+r.playerIndex);e.fillText(r.matchScore+r.gameScore,f,u),e.fillText("#"+r.place,f,u+s)}}function _t(e){const a=d.getCurrentGame(),g=a.winningHands.length;let u=-(U+(5+g+d.playerCount)*s)/2+s;e.font=Math.ceil(s*.8)+"px sans-serif",e.fillStyle="white",e.fillText(Re()+": "+d.players[a.bases[a.winnerBaseIndex].playerIndex].name+" won from "+(a.loserBaseIndex>=0?d.players[a.bases[a.loserBaseIndex].playerIndex].name:"Stock"),0,u),u+=s+U/2;for(let r=0;r<a.readyTiles.length;r++)ce(e,a.readyTiles[r],P*(-d.dealCount/2+r),u,P,U);ce(e,a.winningTile,P*(d.dealCount/2),u,P,U),u+=U/2+s,e.textAlign="right";for(let r=0;r<g;r++){const f=a.winningHands[r];e.fillText(Ot(f),s,u),e.fillText(Et(f,d.dealCount),3*s,u),u+=s}e.fillText("Total",s,u),e.fillText(a.handsScore,3*s,u),u+=2*s;for(const r of a.bases){const f=u+r.playerIndex*s;e.fillText(d.players[r.playerIndex].name,-4*s,f),e.fillText(r.matchScore,-2*s,f),e.fillText((r.gameScore>0?"+":"")+r.gameScore+" = ",2*s,f),e.fillText(r.matchScore+r.gameScore,4*s,f),e.fillText("#"+r.place,6*s,f)}}function Nt(e){const a=-4*s,g=K(w);e.fillText("Players",a,g);for(let r=0;r<O.length;r++){const f=w[0]+b*r;r===H.playerSelectedIndex&&e.strokeRect(f,g-w[3]/2,b,w[3]),e.fillText(O[r],f+b/2,g)}const y=K(A);e.fillText("Tiles",a,y);for(let r=0;r<p.length;r++){const f=A[0]+_*r;r===H.dealSelectedIndex&&e.strokeRect(f,y-A[3]/2,_,A[3]),e.fillText(p[r],f+_/2,y)}const u=K(E);e.fillText("Rounds",a,u);for(let r=0;r<R.length;r++){const f=E[0]+te*r;r===H.roundSelectedIndex&&e.strokeRect(f,u-E[3]/2,te,E[3]),e.fillText(R[r],f+te/2,u)}e.strokeRect(...ne),e.fillText("Start",fe(ne),K(ne)),e.strokeRect(...se),e.fillText("Reload",fe(se),K(se)),e.strokeRect(...ie),e.fillText("Source",fe(ie),K(ie)),e.font=Math.ceil(s*2)+"px sans-serif",e.fillText("Small Mahjong",0,-6*s)}function Ht(e){if(e.fillStyle="#060",e.fillRect(h,n,o,c),e.font=Math.ceil(s*.8)+"px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.strokeStyle="#fff",m===S){Nt(e);return}if(m===W){_t(e);return}if(m===k){wt(e);return}const a=d.getCurrentGame();e.font=Math.ceil(z*.5)+"px sans-serif",Ce(e,Re(),a.stockTiles.length,0,M),e.strokeRect(...Ie);for(let r=0;r<a.bases.length;r++){const f=a.bases[r],D=d.players[f.playerIndex],[I,G]=[[0,M+2.5*N],[2.5*N,M],[0,M-2.5*N],[-2.5*N,M]][ge[f.playerIndex]];e.fillStyle=r===a.currentBaseIndex?"#0ff":"#fff",Ce(e,D.name,f.matchScore,I,G)}const g=a.bases.findIndex(r=>r.playerIndex===d.manualPlayerIndex),y=a.bases[g];for(let r=0;r<y.concealedTiles.length;r++){const f=y.concealedTiles[r],D=P*(-d.dealCount/2+r),I=oe+U/2;ce(e,f,D,I,P,U,0,r===q||g===a.winnerBaseIndex,y.isReaching()&&!y.isTileReachable(f))}for(let r=0;r<a.bases.length;r++){const f=a.bases[r];e.save();try{e.translate(0,M);const D=ge[f.playerIndex];if(D){e.rotate([0,1.5*Math.PI,Math.PI,.5*Math.PI][D]);for(let I=0;I<f.concealedTiles.length;I++){const G=N*(-d.dealCount/2+I),ee=(v-z)/2;ce(e,m===C?f.concealedTiles[I]:0,G,ee,N,z,0,r===a.winnerBaseIndex)}}for(let I=0;I<f.discardedTiles.length;I++){let G=N*(-3+I%me);f.isReached()&&I>=f.reachedDiscardedIndex&&Math.floor(I/me)===Math.floor(f.reachedDiscardedIndex/me)&&(G+=(I>f.reachedDiscardedIndex?1:.5)*(z-N));const ee=N*3.5+z*(.5+Math.floor(I/me));ce(e,f.discardedTiles[I],G,ee,N,z,I===f.reachedDiscardedIndex?-.5*Math.PI:0,r===a.loserBaseIndex&&I===f.discardedTiles.length-1)}}finally{e.restore()}}const u=a.getCurrentBase();if(u&&u.playerIndex===d.manualPlayerIndex&&((u.isReachable()||u.isReaching())&&!u.isReached()&&(e.fillStyle=u.isReaching()?"#f0f":"#0ff",e.fillRect(...j),e.fillStyle="#000",e.fillText(u.isReachable()?"Reach?":"Cancel?",fe(j),K(j))),le&&(e.fillStyle="#ff0",e.fillRect(...j),e.fillStyle="#000",e.fillText("Win?",fe(j),K(j)))),Z){e.font=Math.ceil(s*1.2)+"px sans-serif";const r=e.measureText(Z).width+s*2,f=s*3,[D,I]=Pe[Te],G=D-r/2<re?re:D+r/2>re+Y?re+Y-r:D-r/2,ee=I-f/2<$?$:I+f/2>$+v?$+v-f:I-f/2;e.fillStyle="#fff",e.fillRect(G,ee,r,f),e.fillStyle="#000",e.fillText(Z,G+r/2,ee+f/2)}}function B(){requestAnimationFrame(e=>{if(e===l)return;const a=t.getContext("2d");a.save();try{a.clearRect(0,0,t.width,t.height),a.setTransform(...i),Ht(a)}finally{a.restore()}})}function be(){const e=t.getBoundingClientRect();if(t.width=e.width*devicePixelRatio,t.height=e.height*devicePixelRatio,o=t.width,c=t.height,h=-o/2,n=-c/2,s=Math.min(o/20,c/20),i[0]=i[3]=Math.min(t.width/o,t.height/c),i[4]=t.width/2,i[5]=t.height/2,w=[0,-4*s,s*8,s*2],b=w[2]/O.length,A=[0,-s,s*8,s*2],_=A[2]/p.length,E=[0,2*s,s*8,s*2],te=E[2]/R.length,ne=[-o/4,5*s,o/2,s*3],se=[-o/2,5*s,o/4,s*3],ie=[o/4,5*s,o/4,s*3],d){const g=o/15*ae;Y=Math.min(o,c-g-s),v=Y,N=Y/(14+2*ae),z=N*ae,P=Math.min((o-s)/(d.dealCount+1),(c-v-s)/ae),U=P*ae,ye=U+s,oe=(v+ye)/2-ye,re=-Y/2,$=oe-v,M=$+v/2,Pe=[[0,M+v/2],[Y/2,M],[0,M-v/2],[-Y/2,M],[0,M]],Ie=[-1.5*N,M-1.5*N,3*N,3*N],j=[P*(d.dealCount+1)/2-4*s,oe-2.5*s,4*s,2*s]}}new ResizeObserver(()=>{be(),B()}).observe(t),be(),V(t,"mousedown",Fe),V(t,"mousemove",Xe),V(t,"mouseup",qe),V(t,"touchstart",Fe),V(t,"touchmove",Xe),V(t,"touchend",qe);function de(e,a){return new Promise(g=>{Ge.add(g);const y=d.players[e];y?(Z=y.name+": "+a,Te=ge[e]):(Z=a,Te=4),B(),setTimeout(()=>{Ge.delete(g)&&(Z="",Te=-1,B(),g())},1500)})}function ve(){d.isFinalGame()?(m=k,B()):(d.nextGame(),ke())}async function Ae(){const e=d.getCurrentGame();d.winGame(e.currentBaseIndex,-1,0),le=!1,await de(e.getCurrentBase().playerIndex,"Win from Stock"),m=C,B()}async function Ee(e){le=!1;const a=d.getCurrentGame(),g=a.getCurrentBase(),y=g.isReaching();a.discardTile(e),y&&await de(a.getCurrentBase().playerIndex,"Reach");for(let u=1;u<d.playerCount;u++){const r=(a.currentBaseIndex+u)%d.playerCount,f=a.bases[r];if(f.isReached()&&a.canWin(r,e)){d.winGame(r,a.currentBaseIndex,e),await de(f.playerIndex,"Win from "+d.players[g.playerIndex].name),m=C,B();return}}if(!a.stockTiles.length){m=C,await de(-1,"Draw");return}B(),setTimeout(()=>{We()},100)}function We(){const e=d.getCurrentGame(),a=e.pickTile();e.drawTile(a),B();const g=e.getCurrentBase(),y=e.canWin(e.currentBaseIndex,a);if(g.isReached()){y?Ae():setTimeout(()=>{Ee(a)},100);return}if(g.playerIndex!==d.manualPlayerIndex){y?Ae():setTimeout(()=>{const u=e.think();g.isTileReachable(u)&&g.setReaching(!0),Ee(u)},100);return}le=y}async function ke(){q=-1,m=T,await de(-1,Re()),We()}function xt(){d=new kt,d.playerCount=O[H.playerSelectedIndex],d.dealCount=p[H.dealSelectedIndex],d.roundCount=R[H.roundSelectedIndex],d.startGame(),ge=[...Array(d.playerCount).keys()].map(e=>(e-d.manualPlayerIndex+d.playerCount)%d.playerCount),localStorage.setItem(Oe,JSON.stringify(H)),be(),ke()}function we(){m=S,B()}function _e(e){const a=e.changedTouches?e.changedTouches[0]:e,g=t.getBoundingClientRect();return[((a.clientX-g.left)*devicePixelRatio-i[4])/i[0],((a.clientY-g.top)*devicePixelRatio-i[5])/i[3]]}function Ue([e,a]){if(a>=oe){const g=Math.floor((e+P*(d.dealCount+1)/2)/P);if(g>=0&&g<=d.dealCount)return g}return-1}function Fe(e){if(m===S){const a=_e(e);if(Q(ne,a)){xt();return}else if(Q(se,a)){location.reload();return}else if(Q(ie,a)){location.href="https://github.com/usumerican/smallmahjong";return}Q(w,a)?H.playerSelectedIndex=Math.floor((a[0]-w[0])/b):Q(A,a)?H.dealSelectedIndex=Math.floor((a[0]-A[0])/_):Q(E,a)&&(H.roundSelectedIndex=Math.floor((a[0]-E[0])/te)),B();return}if(m===T){const a=_e(e);if(Q(Ie,a)){confirm("Quit game?")&&we();return}const g=d.getCurrentGame().getCurrentBase();if((g==null?void 0:g.playerIndex)===d.manualPlayerIndex){if(Q(j,a)){g.isReachable()||g.isReaching()?(g.setReaching(!g.isReaching()),B()):le&&Ae();return}q=Ue(a),B()}return}if(m===C){d.getCurrentGame().winnerBaseIndex>=0?(m=W,B()):ve();return}if(m===W){ve();return}if(m===k){we();return}}function Xe(e){m===T&&q>=0&&(q=Ue(_e(e)),B())}function qe(){if(m===T&&q>=0){const e=d.getCurrentGame().getCurrentBase();if(e.playerIndex===d.manualPlayerIndex){const a=e.concealedTiles[q];(!e.isReaching()||e.isTileReachable(a))&&Ee(a)}q=-1,B()}}we()});
