import{createServer as e}from"http";import{readFile as t}from"fs";var o={connection:"keep-alive","content-type":"text/event-stream","cache-control":"no-cache"},c={"content-type":"application/json"},n={"content-type":"text/html;charset=utf-8","cache-control":"no-cache"},r={"cache-control":"no-cache"},a={"content-type":"font/ttf","cache-control":"max-age=86400"},f=1,l=new Map;setInterval(()=>{for(let[,e]of l)(performance.now()-e.t>5e3||!h(e,1,""))&&s(e)},1e3);var p=(e,t)=>`id:${e}\ndata:${t}\n\n`,h=(e,t,o)=>e.o.write(p(e.p++,t+o),t=>t&&s(e)),m=(e,t,o)=>{for(let[c,n]of l)c!=e&&h(n,t,o)},s=e=>{try{e.o.write(p(-1,"")),e.o.end()}catch{}l.delete(e.h),m(e.h,4,"-"+e.h)},i=(e,o,c)=>t("."+e,(e,t)=>{o.writeHead(e?404:200,c),o.end(t)}),y=(e,t)=>{t.writeHead(500),t.end()},$={G:{"/":(e,t)=>i("/index.html",t,n),_(e,t){t.writeHead(200,o);let c=[...l.keys()],n=f++,r={h:n,t:performance.now(),o:t,p:0};l.set(n,r),c.unshift(n),e.on("close",()=>s(r)),h(r,2,""+c),m(n,4,""+n)},l:(e,t)=>i(e.url,t,n),f:(e,t)=>i(e.url,t,a),s:(e,t)=>i(e.url,t,r)},P:{_:(e,t)=>(async e=>{let t=[];for await(let o of e)t.push(o);return JSON.parse(Buffer.concat(t).toString())})(e).then(e=>{e||(t.writeHead(500),t.end());let o=l.get(e[0]);if(o){o.t=performance.now();let n=0;for(let t of e[1]){let e=l.get(t[1]);e&&h(e,3,JSON.stringify(t)),++n}t.writeHead(200,c),t.end(""+n)}else t.writeHead(404),t.end()}).catch(()=>{})}};e((e,t)=>{($[e.method[0]][e.url.at(-1)]??y)(e,t)}).listen(+process.env.PORT||8080);