"use strict";
// Define requestAnimFrame
window.requestAnimFrame = (function(callback) {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
    function(callback) {
    window.setTimeout(callback, 1000 / 60);
    };
})();

var root=document.documentElement;var canvas=root.querySelector("canvas");var context=canvas.getContext("2d");var width=window.innerWidth;var height=window.innerHeight;var dimention=Math.min(width,height);width=dimention;height=dimention;canvas.width=width;canvas.height=height;var rect;var options=getGameOptions();var margin=40;var cellWidth;var cellHeight;var dw;var dh;var padding;calculateDimensions();var gameIsOver=false;var mouseX,mouseY;var frame=0;var backgroundColor="#6B2212";
var textColor="#D1C17E";var buttonTextColor="#ffd41b";var hoverColor="#D1C17E";var startCellColor="Maroon";var pathCellColor="Goldenrod";var rightCellColor="green";var halfrightCellColor="cyan";var wrongCellColor="red";
function Button(x,y,label,callback,drawMode){this.x=x;this.y=y;this.text=label;context.font=this.font;this.width=context.measureText(this.text).width;switch(drawMode){case "center":this.offset=-this.width/2;break;case "right":this.offset=-this.width;break;case "left":default:this.offset=0}this.callback=callback;this.color=buttonTextColor}Button.prototype.height=24;Button.prototype.font="Bold Italic 20px Comic Sans MS";
Button.prototype.checkMouseOver=function(){if(this.x+this.offset<mouseX&&this.x+this.width+this.offset>mouseX&&this.y<mouseY&&this.y+this.height>mouseY){this.active=true;this.color=hoverColor}else{this.active=false;this.color=buttonTextColor}};Button.prototype.show=function(){context.save();context.textBaseline="top";context.font=this.font;context.fillStyle=this.color;context.fillText(this.text,this.x+this.offset,this.y);context.restore()};
function Cell(x,y){this.id=0;this.x=x;this.y=y;this._x=x*cellWidth+margin;this._y=y*cellHeight+1.5*margin;this.width=0;this.height=0;this.visited=false;this.weight=null;this.satartDraw=false;this.finishedDraw=false;this.notClicked=true;this.color=startCellColor}Cell.prototype.reset=function(){this.startDraw=false;this.finishedDraw=false;this.width=0;this.height=0};
Cell.prototype.draw=function(){this.width=this.width+dw>=cellWidth-2*padding?cellWidth-2*padding:this.width+dw;this.height=this.height+dh>=cellHeight-2*padding?cellHeight-2*padding:this.height+dh;if(this.color!==wrongCellColor){context.fillStyle=this.color;context.strokeStyle="#000";context.roundRect(this._x-this.width/2+cellWidth/2,this._y-this.height/2+cellHeight/2,this.width,this.height,this.width/8).fill()}else{context.lineCap="round";context.lineWidth=this.width/8;context.strokeStyle="#f00";
context.drawError(this._x-this.width/2+cellWidth/2,this._y-this.height/2+cellHeight/2,this.width,this.height).stroke()}if(this.width>=cellWidth-2*padding&&this.height>=cellHeight-2*padding)this.finishedDraw=true};Cell.prototype.checkMouseOver=function(){if(this._x<mouseX&&this._x+this.width>mouseX&&this._y<mouseY&&this._y+this.height>mouseY)return true;else return false};var scene=[];var buttons=[];var clickEventListener=[];var cells=[];var _path=[];var startCell;var endCell;var gameCreated=false;
var timeOutArray=[];var gameAfter="";var gameAfterInterval;var pathIsDrawed=false;function drawGrid(){context.fillStyle="#000";context.fillRect(0,0,width,height);for(var i=0;i<cells.length;i++)cells[i].draw()}
function drawPath(){gameAfter="";var $jscomp$loop$3={};var i=0;for(;i<_path.length;$jscomp$loop$3={$jscomp$loop$prop$c$4:$jscomp$loop$3.$jscomp$loop$prop$c$4},i++){$jscomp$loop$3.$jscomp$loop$prop$c$4=cells[_path[i]];setTimeout(function($jscomp$loop$3){return function(i){$jscomp$loop$3.$jscomp$loop$prop$c$4.reset();$jscomp$loop$3.$jscomp$loop$prop$c$4.color=pathCellColor;if(options.sound)aa.play("drawCell")}}($jscomp$loop$3),i*300)}pathIsDrawed=true;setTimeout(function(){gameAfter=options.hideAfter;
gameAfterInterval=setInterval(function(){gameAfter--;gameAfter=gameAfter>0?gameAfter:"Go Back!";if(options.sound)aa.play("countDown")},1E3)},_path.length*300);timeOutArray.push(setTimeout(function(){clearInterval(gameAfterInterval);gameAfter="Go Back!";if(options.sound)aa.play("startGame");for(var i$0=0;i$0<_path.length;i$0++){var c$1=cells[_path[i$0]];c$1.reset(_path.length-i$0);c$1.color=startCellColor}},options.hideAfter*1E3+_path.length*300))}
function setWeights(endCell){var x=endCell.x;var y=endCell.y;var j=Math.max(endCell.x,endCell.y,options.gridDimension-endCell.x,options.gridDimension-endCell.y)+1;for(var i=0;i<j;i++){var n=[];for(var a=-1*i;a<=i;a++)for(var b=-1*i;b<=i;b++){var c=getCell(x+a,y+b);if(c&&c.id!=endCell.id)n.push(c)}for(var k=0;k<n.length;k++)if(n[k].weight===null)n[k].weight=i}}
function getPath(_cell){_cell.visited=true;var nbrs=getNbrs(_cell);if(nbrs.length!==0){var next=nbrs[Math.floor(Math.random()*nbrs.length)];_path.push(next.id);if(next.weight==1)return false;getPath(next)}else{var id=_path.pop();getPath(cells[id])}}
function createGame(){cells=[];_path=[];pathIsDrawed=false;for(var i=0;i<timeOutArray.length;i++)clearTimeout(timeOutArray[i]);for(var j=0;j<options.gridDimension;j++)for(var i$2=0;i$2<options.gridDimension;i$2++){var c=new Cell(i$2,j);c.id=i$2+j*options.gridDimension;cells.push(c)}startCell=cells[0];endCell=cells[cells.length-1];startCell.color="royalblue";endCell.color="royalblue";startCell.visited=true;endCell.visited=true;startCell.notClicked=false;endCell.notClicked=false;setWeights(endCell);
getPath(startCell);gameCreated=true}function drawBackground(){context.save();context.clearRect(0,0,width,height);context.fillStyle=backgroundColor;context.fillRect(0,0,width,height);context.restore()}function drawButtons(){for(var i=0;i<buttons[currentScene].length;i++){buttons[currentScene][i].checkMouseOver();buttons[currentScene][i].show()}}
CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){if(w<2*r)r=w/2;if(h<2*r)r=h/2;this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();return this};CanvasRenderingContext2D.prototype.drawError=function(x,y,w,h){var dif=5;context.beginPath();context.moveTo(x+dif,y+dif);context.lineTo(x+w-dif,y+h-dif);context.moveTo(x+w-dif,y+dif);context.lineTo(x+dif,y+h-dif);return this};
function setGameOptions(options){localStorage.removeItem("ms_gobackgame_options");localStorage["ms_gobackgame_options"]=JSON.stringify(options)}function getGameOptions(){if(localStorage&&"ms_gobackgame_options"in localStorage)return JSON.parse(localStorage["ms_gobackgame_options"]);else return{gridDimension:4,crazy:false,hideAfter:3,sound:true}}
function calculateDimensions(){cellWidth=(width-2*margin)/options.gridDimension;cellHeight=(height-2*margin)/options.gridDimension;dw=cellWidth/10;dh=cellHeight/10;padding=cellWidth/25}function getCell(i,j){if(i<0||i>=options.gridDimension||j<0||j>=options.gridDimension)return false;return cells[i+j*options.gridDimension]}
function getNbrs(_cell){var n=[];var i=_cell.x;var j=_cell.y;var o=options.crazy?-1:0;for(var a=o;a<2;a++)for(var b=o;b<2;b++){var c=getCell(i+a,j+b);if(c&&c.id!=_cell.id)n.push(c)}n=n.filter(function(_c){return!_c.visited});return n}
canvas.addEventListener("mousemove",function(e){rect=canvas.getBoundingClientRect();mouseX=e.clientX-rect.left;mouseY=e.clientY-rect.top;canvas.style.cursor="default";for(var i=0;i<buttons[currentScene].length;i++)if(buttons[currentScene][i].active==true)canvas.style.cursor="pointer"});
function renderText(text,c,offsetx,offsety,sz){var offsetx,offsety,color,size;offsetx=offsetx==undefined?0:offsetx;offsety=offsety==undefined?0:offsety;color=!c?textColor:c;size=sz==undefined?80:sz;context.save();context.font="bold "+size+"px Comic Sans MS";context.fillStyle=color;context.textAlign="center";context.fillText(text,offsetx,offsety);context.restore()}
function changeScene(toScene){clearInterval(gameAfterInterval);gameCreated=false;canvas.removeEventListener("click",clickEventListener[currentScene]);currentScene=toScene;canvas.addEventListener("click",clickEventListener[currentScene])}function checkEvents(){for(var i=0;i<buttons[currentScene].length;i++)if(buttons[currentScene][i].active==true){buttons[currentScene][i].callback();break}}
var helpText=["When you start the game,","a path of yellow cells will be drawn, ","after "+options.hideAfter+" seconds, it will disappear","you have to go back from the last cell to the first one","but on the same path","if you choose the right cell, it will turn to green","if you choose a cell on the path but not the next one,","it will turn to light blue",'if you choose the wrong one, it will turn to "X"',"you can always get a hint .. there is no time limits"];
scene={start:function(){drawBackground();renderText("GO BACK!",false,width/2,140);drawButtons()},help:function(){drawBackground();renderText("How to play",false,width/2,100,60);for(var i=0;i<helpText.length;i++)renderText(helpText[i],false,width/2,150+25*i,18);drawButtons()},options:function(){drawBackground();renderText("Options!",false,width/2,100);renderText("Crazy :",false,width/2-30,200,20);renderText("Grid Size :",false,width/2-48,250,20);renderText(options.gridDimension,false,width/2+50,250,
20);renderText("Hide after :",false,width/2-54,300,20);renderText(options.hideAfter+"s",false,width/2+50,300,20);renderText("Sound :",false,width/2-30,350,20);drawButtons()},play:function(){if(!gameCreated)createGame();else drawGrid();if(!pathIsDrawed&&cells.every(function(x){return x.finishedDraw}))drawPath();drawButtons();renderText(gameAfter,"#555",width/2,30,24)}};
buttons={start:[new Button(width/2,height-200,"Play",function(){changeScene("play")},"center"),new Button(width/2,height-150,"Options",function(){changeScene("options")},"center"),new Button(width/2,height-100,"How to play",function(){changeScene("help")},"center")],help:[new Button(width/2,height-200,"Play",function(){changeScene("play")},"center"),new Button(width/2,height-150,"Option",function(){changeScene("options")},"center")],options:[new Button(width/2,height-200,"Play",function(){changeScene("play")},
"center"),new Button(width/2,height-150,"How to play",function(){changeScene("help")},"center"),new Button(width/2+30,185,options.crazy?"yes":"no",function(){options.crazy=!options.crazy;this.text=options.crazy?"yes":"no";setGameOptions(options)},"center"),new Button(width/2+20,235,"-",function(){options.gridDimension=options.gridDimension-1<3?3:options.gridDimension-1;calculateDimensions();setGameOptions(options)},"center"),new Button(width/2+80,235,"+",function(){options.gridDimension++;calculateDimensions();
setGameOptions(options)},"center"),new Button(width/2+20,285,"-",function(){options.hideAfter=options.hideAfter-1<2?2:options.hideAfter-1;setGameOptions(options)},"center"),new Button(width/2+80,285,"+",function(){options.hideAfter=options.hideAfter+1>10?10:options.hideAfter+1;setGameOptions(options)},"center"),new Button(width/2+30,335,options.sound?"yes":"no",function(){options.sound=!options.sound;this.text=options.sound?"yes":"no";setGameOptions(options)},"center")],play:[new Button(50,20,"Options",
function(){changeScene("options")},"left"),new Button(width-50,20,"Hint",function(){if(gameAfter!=="Go Back!")return;var c=cells[_path.pop()];if(c){c.color=rightCellColor;c.notClicked=false}else gameAfter="Seriously!!"},"right")]};
clickEventListener={start:function(e){checkEvents()},help:function(e){checkEvents()},options:function(e){checkEvents()},play:function(){checkEvents();var c=null;for(var i=0;i<cells.length;i++)if(cells[i].checkMouseOver()){c=cells[i];break}if(c&&c.notClicked){if(gameAfter!=="Go Back!")return;c.notClicked=false;c.reset();if(c.id==_path[_path.length-1]){if(options.sound)aa.play("right");_path.pop();c.color=rightCellColor;if(_path.length==0)setTimeout(function(){alert("Well Done! \n try the next Level!");
options.gridDimension++;calculateDimensions();setGameOptions(options);createGame()},300)}else if(_path.some(function(x){return x==c.id})){if(options.sound)aa.play("halfright");c.color=halfrightCellColor;c.notClicked=true}else{if(options.sound)aa.play("wrong");c.color=wrongCellColor}}}};var currentScene="start";canvas.addEventListener("click",clickEventListener[currentScene]);function animate(){frame++;scene[currentScene]();requestAnimFrame(animate)}animate();
function ArcadeAudio(){this.sounds={}}ArcadeAudio.prototype.add=function(key,count,settings){this.sounds[key]=[];settings.forEach(function(elem,index){this.sounds[key].push({tick:0,count:count,pool:[]});for(var i=0;i<count;i++){var audio=new Audio;audio.src=jsfxr(elem);this.sounds[key][index].pool.push(audio)}},this)};
ArcadeAudio.prototype.play=function(key){var sound=this.sounds[key];var soundData=sound.length>1?sound[Math.floor(Math.random()*sound.length)]:sound[0];soundData.pool[soundData.tick].play();soundData.tick<soundData.count-1?soundData.tick++:soundData.tick=0};var aa=new ArcadeAudio;aa.add("right",10,[[0,,.0647,.3889,.4497,.6461,,,,,,.2855,.6416,,,,,,1,,,,,.5]]);
aa.add("halfright",5,[[0,.0312,.1251,.3346,.2725,.6769,,.004,.137,,.0955,.0011,.0612,9E-4,-.0493,.0015,.0605,-.062,.9649,-.035,.0461,.0049,.0184,.5]]);aa.add("wrong",3,[[2,,.2298,.1574,.3461,.6438,.0229,-.4772,,,,,,.7991,-.5284,,.127,-.0129,1,,,.1038,,.23]]);aa.add("drawCell",3,[[0,,.0296,.3414,.302,.4656,,,,,,.5,.5336,,,,,,1,,,,,.23]]);aa.add("countDown",3,[[1,,.2255,,.2307,.4077,,.1789,,,,,,,,.7881,,,1,,,,,.23]]);aa.add("startGame",3,[[0,,.2972,,.1213,.4026,,.4318,,,,,,.5843,,.4127,,,1,,,,,.23]]);