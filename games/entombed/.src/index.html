<html>
    <head>
        <title>ENTOMBED</title>
        <style>body{margin:0;background:#222}div{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}canvas{image-rendering:pixelated}</style>
    </head>
    <body>
        <div id="wrap"/>
        <script>class t{constructor(t){this.setSeed(t)}setSeed(t){this.seed=t,this.m=2147483648,this.a=1103515245,this.c=12345,this.state=t||Math.floor(Math.random()*(this.m-1))}randomInt(){return this.state=(this.a*this.state+this.c)%this.m}random(){return this.randomInt()/(this.m-1)}randomIntBetween(t,e){const n=e-t,i=this.randomInt()/this.m;return t+Math.floor(i*n)}randomItem(t){return t[this.randomIntBetween(0,t.length)]}randomChance(t){return this.random()<t/100}shuffle(t){let e=t.length;for(;e;){let n=Math.floor(this.random()*e--),i=t[e];t[e]=t[n],t[n]=i}return t}}class e{constructor(t,e,n,i=1){this.x=t,this.y=e,this.velocity={x:0,y:0},this.direction={x:0,y:0},null!==n&&(this.sprite=We[n],this.normalSprite=We[n],this.flashSprite=Ue[n]),this.scale=i,this.z=function(t){return 0-(1-t)/2}(i),this.static=!0,this.collision=!0,this.alive=!0,this.radius=.3}project(){const t=this.x-tn.x,e=this.y-tn.y,n=1/(hn.x*tn.direction.y-tn.direction.x*hn.y);this.transformX=n*(tn.direction.y*t-tn.direction.x*e)*-1,this.transformY=n*(-hn.y*t+hn.x*e),this.screenX=Math.round(yn/2*(1+this.transformX/this.transformY)),this.screenWidth=Math.abs(Math.round(pn/this.transformY))*this.scale,this.screenHeight=Math.abs(Math.round(pn/this.transformY))*this.scale}update(t){this.velocity&&(this.x+=this.velocity.x*t,this.y+=this.velocity.y*t,Gt(this))}collide(){}dropLoot(){}damage(t,e){this.health<=0||(this.health-=t,this.sprite=this.flashSprite,setTimeout(()=>{this.sprite=this.normalSprite,this.health<=0&&(this.kill(e),this.dropLoot())},50))}kill(){this.alive=!1}}class n extends e{constructor(t,e,n,i=1){super(t,e,n,i),this.health=50,this.static=!1,this.attackCooldown=1e3}update(t){g(this,t),function(t,e){if(!(oe(t,tn)<9))return function(t){t.target=null}(t);if(v(t,tn)){const e=ae(ie(re(tn,t)),t.attackDistance);t.target=re(tn,e),t.hasSeenPlayer=!0}if(t.target){Me(ge(nn,Math.floor(t.target.x),Math.floor(t.target.y)))||(t.target=b(t)),v(t,t.target)?(!function(t,e,n){const i=ae(ie(re(e,t)),t.speed);t.x+=i.x*n,t.y+=i.y*n}(t,t.target,e),function(t){return 0===t.attackCooldown}(t)&&t.attack(),function(t){const e=t.radius,n=Math.abs(t.target.x-t.x),i=Math.abs(t.target.y-t.y);return n<e&&i<e}(t)&&(t.target=null)):t.target=b(t)}else t.hasSeenPlayer&&(t.target=b(t))}(this,t),Gt(this)}kill(t){this.alive=!1,t===tn&&(I.mobsKilled++,Y.pacifist=!1)}collide(t,e){t instanceof h||et(this,e)}}class i extends e{constructor(t,e){super(t,e,1,.5),this.radius=.1,this.collectible=!0}collect(t){t.mana!==t.maxMana&&(jt(),this.kill(),t.mana=Math.min(t.mana+50,t.maxMana))}}class o extends e{constructor(t,e){super(t,e,9,.5),this.radius=.1,this.collectible=!0}collect(t){t.health!==t.maxHealth&&(jt(),this.kill(),t.health=Math.min(t.health+30,t.maxHealth))}}class r extends e{constructor(t,e){super(t,e,11,.3),this.radius=.1,this.collectible=!0}collect(){jt(),this.kill(),tn.hasKey=!0,F(nn.data).filter(Boolean).filter(t=>t.locked).forEach(t=>t.tooltip="E: Open")}}class a extends e{constructor(t,e){super(t,e,7),this.tooltip="E: climb",this.onInteract=_}}class s extends e{constructor(t,e){super(t,e,8,.5),this.z=.25,this.collision=!1}}class c extends n{constructor(t,e){super(t,e,0,.8),this.speed=1,this.radius=.3,this.health=120,this.flashSprite=Ge[0],this.attackDistance=4}attack(){qt(100,3,29,15,Ht(.4,this),1);const t=ie(re(tn,this)),e=Vt(ne(t),-.2),n=Vt(ne(t),.2);lt(this,e,y,3,500),lt(this,t,y,3,500),lt(this,n,y,3,500)}dropLoot(){M(new r(this.x,this.y))}}class l extends n{constructor(t,e){super(t,e,5,.5),this.speed=2,this.radius=.3,this.health=30,this.z=0,this.attackDistance=1.5}attack(){const t=ie(re(tn,this));qt(1426,-87,17,8,Ht(.2,this),1),lt(this,t,d,5,1e3)}dropLoot(){M(w(this))}}class h extends e{constructor(t,e,n,i,o){super(t,e,n,.3),this.z=0,this.radius=.1,this.speed=i,this.direction=o,this.static=!1,this.velocity={x:o.x*i,y:o.y*i}}collide(t,e){return J(this,t,e)}}class f extends h{constructor(t,e,n,i){super(t,e,2,n,i),this.strength=10}}class u extends h{constructor(t,e,n,i){super(t,e,null,n,i),this.strength=10,setTimeout(()=>this.kill(),50)}}class d extends h{constructor(t,e,n,i){super(t,e,10,n,i),this.strength=5}}class y extends h{constructor(t,e,n,i){super(t,e,12,n,i),this.strength=10}}class p extends e{constructor(t,e){super(t,e,3,.4),this.z=0}}class m extends e{constructor(t,e){super(t,e,4,.7),this.radius=0}}class x extends e{constructor(t,e){super(t,e,13,.7),this.radius=.3,this.health=10}kill(){super.kill(),I.urnsSmashed++}dropLoot(){M(w(this))}}function g(t,e){t.attackCooldown>0&&(t.attackCooldown-=1e3*e,t.attackCooldown<0&&(t.attackCooldown=0))}function w(t){const e=[null,null,null,null,i,i,o];tn.health<=20&&e.push(o);const n=sn.randomItem(e);return n?new n(t.x,t.y):null}function M(t){if(!t)return;const e=t.z;t.z=.2,U.create(t,"z",e,200),nn.entities.push(t)}function b(t){const e=we(on,t);if(!e)return null;const n=be(on,e.x,e.y).filter(Boolean),i=n.sort(O)[0];let o=n.filter(t=>t.weight===i.weight).sort(z)[0];return{x:o.x+.5,y:o.y+.5}}function v(t,e){let n,i=Math.floor(t.x),o=Math.floor(t.y),r=Math.floor(e.x),a=Math.floor(e.y),s=Math.abs(r-i),c=Math.abs(a-o),l=i<r?1:-1,h=o<a?1:-1,f=s-c,u=[];for(;;){const t=ge(nn,i,o);if(u.push(t),i===r&&o===a)break;(n=2*f)>-c&&(f-=c,i+=l),n<s&&(f+=s,o+=h)}return u.every(Me)}const S=()=>({almost:!1,explorer:!1,pacifist:!0,pugilist:!1,rampage:!1,unscathed:!0}),k=()=>({mobsKilled:0,urnsSmashed:0,shotsFired:0,punchesThrown:0,damageTaken:0,timeTaken:0}),X={rampage:"killed everything",pacifist:"killed nothing",pugilist:"only used melee",explorer:"found the secret room",unscathed:"took no damage",almost:"died with the key"};let Y=S(),I=k();function R(t,e,n){return Math.min(Math.max(t,e),n)}function E(t,e,n,i,o){return n-e==0?i:i+(t-e)*(o-i)/(n-e)}function C(t,e,n){return(1-n)*t+n*e}const z=(t,e)=>{return oe(tn,t)-oe(tn,e)};function F(t){return[].concat(...t)}function D(t,e){const n=document.createElement("canvas"),i=n.getContext("2d");return n.width=t,n.height=e,i.imageSmoothingEnabled=!1,[n,i]}function L(t,e,n="source-atop"){const[i,o]=D(t.width,t.height);return o.drawImage(t,0,0),o.globalCompositeOperation=n,o.fillStyle=e,o.fillRect(0,0,t.width,t.height),i}function A(t,e){for(let n=0;n<t;n++)e(n)}const T=(t,e)=>!1===t.top?ge(e,t.x,t.y-1):!1===t.bottom?ge(e,t.x,t.y+1):!1===t.left?ge(e,t.x-1,t.y):!1===t.right?ge(e,t.x+1,t.y):void 0,B=t=>3===[t.top,t.left,t.bottom,t.right].filter(t=>t).length,O=(t,e)=>t.weight-e.weight;function K(t){const e=function(t,e,n,r){const h=Math.floor(r/2),f=[];for(let t=0;t<n*r;t++)f[t]=Array.from(new Array(e*r),()=>null);const u=function(t,e,n,i,o){const r=function(t,e){const n=[];for(let i=0;i<e;i++){n[i]=[];for(let e=0;e<t;e++)n[i][e]={x:e,y:i,top:!0,left:!0,bottom:!0,right:!0,open:!0,weight:0,exit:!1}}return{width:t,height:e,data:n}}(e,n),a=r.data[o][i];a.open=!1,a.entrance=!0,r.entrance=a,r.width=e,r.height=n;const s=be(r,a.x,a.y);for(;s.length>0;){const e=t.randomIntBetween(0,s.length-1),n=s.splice(e,1)[0],i=be(r,n.x,n.y).filter(t=>!1===t.open),o=t.randomItem(i);n.x===o.x?n.y>o.y?(n.top=!1,o.bottom=!1):(n.bottom=!1,o.top=!1):n.x>o.x?(n.left=!1,o.right=!1):(n.right=!1,o.left=!1),n.open=!1,n.weight=o.weight+1,be(r,n.x,n.y).filter(t=>!0===t.open).forEach(t=>{s.includes(t)||s.push(t)})}const c=F(r.data).filter(B);t.shuffle(c),c.sort(O);let l=c[c.length-1],h=c[c.length-2],f=c[Math.floor(c.length/2)];return T(f,r).preSecret=!0,T(l,r).preExit=!0,l.exit=!0,h.key=!0,f.secret=!0,r.exit=l,r}(t,e,n,0,0),d=[],y={graph:u,width:e*r,height:n*r,cellSize:r,data:f,fog:[46,40,39],fogDistance:20,floor:5,entities:d},p=F(u.data);p.forEach(e=>{e.size=t.randomItem([5,7,7,9,9,9]),e.entrance&&(e.size=5),e.exit&&(e.size=7),e.key&&(e.size=9),e.secret&&(e.size=7),e.width=e.size,e.height=e.size,!1===e.top&&!1===e.bottom&&t.randomChance(30)&&(e.width=3,e.height=9,e.corridoor=!0),!1===e.left&&!1===e.right&&t.randomChance(30)&&(e.width=9,e.height=3,e.corridoor=!0);const n=e.x*r,i=e.y*r;e.centerX=n+h,e.centerY=i+h;let o=Math.floor((r-e.width)/2),a=Math.floor((r-e.height)/2);e.mapX=n+o,e.mapY=i+a;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const i=n+e.mapX,o=t+e.mapY;f[o][i]=j(i,o,ze)}if(!1===e.top){const t=e.centerX;for(let e=i;e<=i+h;e++)f[e][t]=j(t,e,ze)}if(!1===e.bottom){const n=e.centerX;for(let t=e.centerY;t<=i+r;t++)f[t][n]=j(n,t,ze);if(q(e,t)){const t=f[i+r-1][n];e.secret?t.type=ze:(H(t,"D"),e.bottomDoor=t)}}if(!1===e.left){const t=e.centerY;for(let e=n;e<=n+h;e++)f[t][e]=j(e,t,ze)}if(!1===e.right){const i=e.centerY;for(let t=e.centerX;t<=n+r;t++)f[i][t]=j(t,i,ze);if(q(e,t)){const t=f[i][n+r-1];e.secret?t.type=ze:(H(t,"d"),e.rightDoor=t)}}});const m=p.find(t=>t.secret),g=p.find(t=>t.exit);return p.forEach(e=>{let n,r;if(e.entrance)y.spawn=[e.mapX+.5,e.mapY+.5,.7,.7],n=0;else if(e.key)n=t.randomIntBetween(2,3),r=t.randomIntBetween(2,3),d.push(new c(e.centerX+.5,e.centerY+.5));else if(e.exit){const[i,o]=function(t){let e=t.centerX,n=t.centerY;!1===t.top&&(n+=2);!1===t.bottom&&(n-=2);!1===t.left&&(e+=2);!1===t.right&&(e-=2);return[e,n]}(e);d.push(new a(i+.5,o+.5)),n=t.randomIntBetween(2,3),f[e.centerY-2][e.centerX-2].type="-",f[e.centerY+2][e.centerX+2].type="-",f[e.centerY-2][e.centerX+2].type="-",f[e.centerY+2][e.centerX-2].type="-"}else if(e.secret)n=0,r=t.randomIntBetween(4,7),d.push(new i(e.centerX+.5,e.centerY+.5)),d.push(new o(e.centerX+1.5,e.centerY+.5));else if(e.preSecret){n=t.randomIntBetween(2,3);const[i]=P(e,m,y);i.type="X",i.damage=0}else if(e.preExit){const[t,n]=P(e,g,y);t.type=n===Be?"L":"l",t.locked=!0,t.tooltip="Locked",t.onInteract=tt}else!function(t,e,n){if(t.corridoor)return;if((5===t.size||7===t.size)&&n.randomChance(20))return void(e[t.centerY][t.centerX].type="-");if(7===t.size||9===t.size)switch(n.randomIntBetween(0,5)){case 0:e[t.centerY-2][t.centerX-2].type="-",e[t.centerY+2][t.centerX+2].type="-",e[t.centerY-2][t.centerX+2].type="-",e[t.centerY+2][t.centerX-2].type="-";break;case 1:e[t.centerY][t.centerX].type="-",e[t.centerY-1][t.centerX].type="-",e[t.centerY+1][t.centerX].type="-",e[t.centerY][t.centerX+1].type="-",e[t.centerY][t.centerX-1].type="-";break;case 2:e[t.centerY][t.centerX-1].type="-",e[t.centerY][t.centerX].type="-",e[t.centerY][t.centerX+1].type="-";break;case 3:e[t.centerY-1][t.centerX].type="-",e[t.centerY][t.centerX].type="-",e[t.centerY+1][t.centerX].type="-"}}(e,f,t,e.centerX,e.centerY),e.corridoor?n=t.randomIntBetween(0,2):(n=t.randomIntBetween(0,3),r=t.randomItem([0,0,1,2]));if(n){const i=function(t,e){const n=[];for(let i=0;i<t.height;i++)for(let o=0;o<t.width;o++){const r=o+t.mapX,a=i+t.mapY,s=e[a][r];s&&(Me(s)&&n.push(s))}return n}(e,f);A(n,()=>{const e=t.randomItem(i);d.push(new l(e.x+.5,e.y+.5))})}if(r){const n=function(t,e){const n=[];for(let i=0;i<t.width;i++)i+t.mapX!==t.centerX&&(n.push(e[t.mapY][i+t.mapX]),n.push(e[t.mapY+t.height-1][i+t.mapX]));for(let i=1;i<t.height-1;i++)i+t.mapY!==t.centerY&&(n.push(e[i+t.mapY][t.mapX]),n.push(e[i+t.mapY][t.mapX+t.width-1]));return n}(e,f);A(r,()=>{const e=t.randomItem(n);d.push(new x(e.x+.5,e.y+.5))})}t.randomChance(30)&&d.push(new s(e.mapX+.2,e.mapY+e.height-.2)),t.randomChance(30)&&d.push(new s(e.mapX+.2,e.mapY+.2)),t.randomChance(30)&&d.push(new s(e.mapX+e.width-.2,e.mapY+.2)),t.randomChance(30)&&d.push(new s(e.mapX+e.width-.2,e.mapY+e.height-.2))}),y}(t,5,5,11);for(let n=0;n<e.height;n++)for(let i=0;i<e.width;i++)$(e,i,n)&&(e.data[n][i]={x:i,y:n,type:t.randomChance(70)?"-":"~"});return e.rng=t,e}function $(t,e,n){if(null!==t.data[n][e])return;return be(t,e,n,!0).filter(t=>t&&t.type===ze).length>0}function q(t,e){return!(t.preSecret||t.exit||t.preExit)&&e.randomChance(50)}function P(t,e,n){return!1===e.top?[ge(n,t.centerX,t.mapY+t.height),Be]:!1===e.bottom?[ge(n,t.centerX,t.mapY-1),Be]:!1===e.left?[ge(n,t.mapX+t.width,t.centerY),Oe]:!1===e.right?[ge(n,t.mapX-1,t.centerY),Oe]:void 0}function j(t,e,n){return{x:t,y:e,type:n,offset:0}}function H(t,e){t.type=e,t.tooltip="E: Open",t.onInteract=tt}let W=[];const U={update:t=>{W.forEach(e=>{const{obj:n,prop:i,to:o,increment:r,callback:a}=e,s=r*t*1e3,c=n[i]+s;if(Math.abs(c-o)<Math.abs(s))return n[i]=o,e.dead=!0,a&&a();n[i]=c}),W=W.filter(t=>!t.dead)},create:(t,e,n,i,o)=>{const r=(n-t[e])/i;W.push({obj:t,prop:e,to:n,increment:r,callback:o})}},G=(t,e)=>{t.static&&et(tn,e)},N=t=>{t.collect(tn)},Z=()=>{nn.entities=nn.entities.filter(t=>!(t instanceof p)),Pe(Ae),it()},J=(t,e)=>{nt(t),e.damage(t.strength,t.source)},Q=(t,e)=>{nt(t),"X"===e.type&&(e.damage+=1,e.damage>=3?(nn.hasOpenedSecret=!0,Y.explorer=!0,e.type=ze,ye(Rn)):(e.flashing=!0,setTimeout(()=>{e.flashing=!1},50)))},V=(t,e,n)=>{et(t,n)},_=()=>{(()=>{const t=((+new Date-gn)/1e3).toFixed(0);I.timeTaken=t+" sec",Y.pugilist=0===I.shotsFired&&I.punchesThrown>0,Y.rampage=nn.entities.every(t=>!(t instanceof l||t instanceof c)),Y.almost=tn.health<=0&&tn.hasKey})(),pe(function(){const t=Mn.createLinearGradient(0,0,0,pn/2);t.addColorStop(0,"#7c9dbd"),t.addColorStop(1,"#a3b1bd");const e=[];for(let t=0;t<15;t+=2)for(let n=0;n<15;n+=2)e.push(new m(n+.5,t+.5));return{...me(["================","=~............~=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=..............=","=~............~=","================"]),name:"surface",spawn:[8.5,8.5,0,.9999],fog:[156,174,189],fogDistance:30,entities:e,sky:t,floor:7,graph:{data:[]}}}()),it(),Pe(Te)},tt=t=>{t.opening||t.locked&&!tn.hasKey||(t.opening=!0,qt(20,3,75,30,.05,1),U.create(t,"offset",1,2e3,()=>{t.locked&&(tn.hasKey=!1),t.type=".",ye(Rn)}))};function et(t,e){t.x+=e.normal.x*e.depth,t.y+=e.normal.y*e.depth,t.velocity.x=0,t.velocity.y=0}function nt(t){t.kill();const e=t.x-.1*tn.direction.x,n=t.y-.1*tn.direction.y,i=new p(e,n);Pt(i),t instanceof u||(Pt(i),nn.entities.push(i),setTimeout(()=>{i.kill()},100))}function it(){Ke=!1,setTimeout(()=>{Ke=!0},1e3)}let ot={x:170,y:70,originX:170,originY:70,offsetX:0,offsetY:0,flash:!1};const rt=300,at=5;function st(){ot.offsetX=-50,ot.offsetY=-50,tn.mana<=0||tn.attackCooldown>0||(I.shotsFired++,tn.mana-=at,lt(tn,tn.direction,f,10,rt),ot.flash=!0,setTimeout(()=>ot.flash=!1,20),qt(620,-80,20,15,.05),qt(520,-70,15,10,.05))}function ct(){tn.attackCooldown>0||(ot.offsetX=-50,ot.offsetY=-50,I.punchesThrown++,lt(tn,tn.direction,u,10,rt),qt(40,-3,15,10,.1,0))}function lt(t,e,n,i,o){const r=new n(t.x+.2*e.x,t.y+.2*e.y,i,ne(e));r.source=t,nn.entities.push(r),t.attackCooldown+=o}function ht(t,e,n,i){e.forEach((e,o)=>{ut(t,Je,e,n,i+10*o)})}function ft(t,e,n,i){const o=4*n.length;return ut(t,e,n,yn/2-o/2,i)}function ut(t,e,n,i,o){n.toUpperCase().split("").forEach((n,r)=>{const a=function(t){const e=t.charCodeAt(0);return e>=43&&e<59?3*(e-43):39===e?129:63===e?126:e>=65&&e<91?3*(e-64)+45:null}(n);if(null===a)return;const s=4*r;t.drawImage(e,a,0,3,5,i+s,o,3,5)})}const dt="KeyE",yt="KeyW",pt="KeyA",mt="KeyS",xt="KeyD",gt="KeyM",wt="ArrowLeft",Mt="ArrowUp",bt="ArrowRight",vt="ArrowDown",St="Minus",kt="Equal",Xt=1,Yt=3,It={},Rt={};let Et,Ct=[300,400,500,600,700,800,900,1e3,2e3,3e3,4e3,5e3,6e3,7e3,8e3],zt=8,Ft=!1;function Dt(t){zt=R(zt+t,0,14),Ft=!0,clearTimeout(Et),Et=setTimeout(()=>Ft=!1,800)}function Lt({code:t}){Rt[t]||(t===dt&&rn&&rn.onInteract(rn),t===gt&&(an=!an),t===St&&Dt(1),t===kt&&Dt(-1)),Rt[t]=!0}function At({code:t}){Rt[t]=!1}function Tt(t){It[t.which]=!0}function Bt(t){It[t.which]=!1}function Ot(t){return!!Rt[t]}function Kt(t){return!!It[t]}const $t=t=>{if(!On())return;if(qe!==Le)return;const{movementX:e}=t;let n=e/Ct[zt];0!==e&&Vt(tn.direction,n)};function qt(t,e,n,i,o,r=0){if(!xn)return;const a=xn.createOscillator();a.frequency.value=t,a.type=["square","sawtooth","triangle","sine"][r];const s=xn.createGain();s.gain.value=0,a.connect(s),s.connect(xn.destination),a.start();let c=0;const l=setInterval(function(){a.frequency.value=t+e*c,s.gain.value=(1-c/i)*o,++c>i&&(clearInterval(l),setTimeout(h,n+i))},n);function h(){a.stop()}}function Pt(t){qt(220,-10,10,35,Ht(.05,t))}function jt(){qt(222,-198,5,11,.3,2)}function Ht(t,e){return t*E(R(Qt(tn,e),0,100),0,100,1,.1)}function Wt(t){const{height:e,width:n}=t,i={width:n,height:e,data:[]};for(let o=0;o<e;o++){i.data[o]=[];for(let e=0;e<n;e++){const n=t.data[o][e];!n||n.type!==ze&&"D"!==n.type&&"d"!==n.type?i.data[o][e]=null:i.data[o][e]={x:e,y:o,weight:1/0,open:!0}}}return i}function Ut(t,e){let n=[];const i=t.data[e.y][e.x];if(i)for(i.weight=0,n.push(i);n.length;){const e=n.shift(),i=be(t,e.x,e.y);if(i.forEach(t=>{null!==t&&t.open&&(n.push(t),t.open=!1)}),0===e.weight)continue;const o=i.filter(Boolean).sort(O)[0];e.weight=o.weight+1}}function Gt(t){const e=Math.floor(t.x),n=Math.floor(t.y);t.x-t.radius<0&&(t.x=t.radius),t.x+t.radius>nn.width&&(t.x=nn.width-t.radius),t.y-t.radius<0&&(t.y=t.radius),t.y+t.radius>nn.height&&(t.y=nn.height-t.radius),[{x:e,y:n},...be(nn,e,n,!0)].filter(Boolean).forEach(({x:e,y:n})=>{const i=ge(nn,e,n);if(Me(i))return;const o=function(t,e){const n=function(t,e,n={x:0,y:0}){t.x<e.x?n.x=e.x:t.x>e.x+e.width?n.x=e.x+e.width:n.x=t.x;t.y<e.y?n.y=e.y:t.y>e.y+e.height?n.y=e.y+e.height:n.y=t.y;return n}(t,e);if(!Zt(n,t))return!1;const i=oe(n,t),o=t.radius-i,r=ie({x:t.x-n.x,y:t.y-n.y});0===r.x&&r.y;return{...n,normal:r,depth:o}}(t,function(t){let{x:e,y:n}=t,i=1,o=1;Se(t)&&(e+=.35,n+=t.offset,i=.3);ve(t)&&(e+=t.offset,n+=.35,o=.3);return{x:e,y:n,width:i,height:o}}(i));if(o){if(t instanceof h)return Q(t,i,o);V(t,i,o)}})}function Nt(t,e){if(t.static)return;if(!t.collision||!e.collision)return;if(t instanceof h&&e instanceof h)return;if(t instanceof h&&e.collectible)return;if(t.source===e)return;const n=function(t,e){const n=t.x-e.x,i=t.y-e.y,o=t.radius+e.radius,r=o*o;if((n*n+i*i).toFixed(5)>=r.toFixed(5))return!1;const a=function(t,e,n={x:0,y:0}){n.x=t.x,n.y=t.y,Zt(t,e)||(n.x-=e.x,n.y-=e.y,i=n,o=e.radius,ae(ie(i),o),n.x+=e.x,n.y+=e.y);var i,o;return n}(t,e),s=ie({x:n,y:i}),c=t.radius-oe(t,a);return{...a,normal:s,depth:c}}(t,e);n&&t.collide(e,n)}function Zt(t,e){const n=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return n*n+i*i<e.radius*e.radius}function Jt(t,e,n){const i=re(t,e),o=re(n,e),r={x:-t.direction.y,y:t.direction.x},a=se(o,r);if(Math.abs(a)<1e-6)return null;const s=function(t,e){return t.x*e.y-t.y*e.x}(o,i)/a,c=se(i,r)/a;return s>=0&&c>=0&&c<=1?s:null}const Qt=(t,e)=>(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y);function Vt(t,e){let n=t.x;return t.x=t.x*Math.cos(e)-t.y*Math.sin(e),t.y=n*Math.sin(e)+t.y*Math.cos(e),t}function _t(t,e){const n=e||{};return n.x=t.y,n.y=-t.x,n}function te(t){return 0===t.x&&0===t.y}function ee(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function ne(t){return{x:t.x,y:t.y}}function ie(t){if(te(t))return t;if(0===t.x)return t.y=t.y>0?1:-1,t;if(0===t.y)return t.x=t.x>0?1:-1,t;const e=ee(t);return t.x/=e,t.y/=e,t}function oe(t,e){return ee(re(t,e))}function re(t,e){return{x:t.x-e.x,y:t.y-e.y}}function ae(t,e){return t.x*=e,t.y*=e,t}function se(t,e){return t.x*e.x+t.y*e.y}function ce(t){let e=2*t/yn-1;return{x:tn.x,y:tn.y,direction:{x:tn.direction.x+hn.x*-e,y:tn.direction.y+hn.y*-e}}}function le(t){let e,n,i,o,r,a,s,c,l,h=!1,f=Math.floor(t.x),u=Math.floor(t.y),d=Math.abs(1/t.direction.x),y=Math.abs(1/t.direction.y);for(t.direction.x<0?(i=-1,r=(t.x-f)*d):(i=1,r=(f+1-t.x)*d),t.direction.y<0?(o=-1,a=(t.y-u)*y):(o=1,a=(u+1-t.y)*y);r<a?(r+=d,f+=i,n=0):(a+=y,u+=o,n=1),!(f<0||f>=nn.width||u<0||u>=nn.height);){if(s=ge(nn,f,u),ve(s)){const i=Jt(t,{x:f+s.offset,y:u+.5},{x:f+1,y:u+.5});if(!i)continue;e=i,n=1,h=!0;break}if(Se(s)){const i=Jt(t,{x:f+.5,y:u},{x:f+.5,y:u+1-s.offset});if(!i)continue;e=i,n=0,h=!0;break}if(!Me(s)){h=!0;break}}if(!h)return[];void 0===e&&(e=0===n?(f-t.x+(1-i)/2)/t.direction.x:(u-t.y+(1-o)/2)/t.direction.y),c=0===n?t.y+e*t.direction.y:t.x+e*t.direction.x;let p=ie(ne(t.direction));return l=0===n?e*t.direction.x/p.x:e*t.direction.y/p.y,c-=Math.floor(c),0===n&&t.direction.x<0&&(c=1-c),1===n&&t.direction.y>0&&(c=1-c),[s,e,l,n,c]}const he=3,fe=t=>Math.sign(t)*Math.round(Math.abs(t));let ue=!1;function de(t){Fn.clearRect(0,0,yn,pn),ue||(Fn.globalCompositeOperation="source-over"),ue||Fn.drawImage(En,0,0),ue||(Fn.globalCompositeOperation="source-in"),Fn.drawImage(In,0,0),ue||(Fn.globalCompositeOperation="source-over");const e=Math.floor(tn.x*he),n=Math.floor(tn.y*he);Fn.fillStyle="#30ca10",Fn.fillRect(e-1,n-1,3,3),Fn.fillRect(e+fe(2*tn.direction.x),n+fe(2*tn.direction.y),1,1),Fn.fillRect(e+fe(3*tn.direction.x),n+fe(3*tn.direction.y),1,1),ue&&function(t,e){const n=e.cellSize*he;t.save(),t.strokeStyle="#ffffff",t.strokeWidth=2,t.lineCap="square";for(let i=0;i<e.graph.height;i++)for(let o=0;o<e.graph.width;o++){const r=e.graph.data[i][o],a=o*n,s=i*n;r.entrance?(t.fillStyle="rgba(0,45,104,0.6)",t.fillRect(o*n,i*n,n,n)):r.secret?(t.fillStyle="rgba(7,122,0,0.6)",t.fillRect(o*n,i*n,n,n)):r.exit?(t.fillStyle="rgba(129,22,23,0.6)",t.fillRect(o*n,i*n,n,n)):r.key&&(t.fillStyle="rgba(129,86,15,0.6)",t.fillRect(o*n,i*n,n,n)),t.fillStyle="#FFFFFF",t.textBaseline="middle",t.textAlign="center",t.fillText(r.weight,a+n/2,s+n/2)}t.restore()}(Fn,nn),t.save(),t.globalAlpha=.3,t.fillStyle="#000000",t.fillRect(0,0,yn,pn);let i=nn.width*he,o=nn.height*he;t.translate(Math.floor(yn/2-i/2),Math.floor(pn/2-o/2-_e/2)),t.globalAlpha=.5,t.drawImage(zn,0,0),t.restore()}function ye(t){const e={".":"#6c6c6c","-":"#ffffff","~":"#ffffff",X:"#ffffff","=":"#555555",D:"#2c2420",d:"#2c2420",L:"#e6d800",l:"#e6d800"};for(let n=0;n<nn.height;n++)for(let i=0;i<nn.width;i++){const o=ge(nn,i,n);null!==o&&(t.fillStyle=e[o.type],t.fillRect(i*he,n*he,he,he))}const n=F(nn.graph.data),i=n.find(t=>t.secret),o=n.find(t=>t.preSecret);if(i&&!nn.hasOpenedSecret){t.clearRect(i.x*nn.cellSize*he,i.y*nn.cellSize*he,nn.cellSize*he,nn.cellSize*he);let e=o.x*nn.cellSize,n=o.y*nn.cellSize,r=nn.cellSize,a=nn.cellSize;!1===i.right?r=(nn.cellSize-(o.width+2))/2:!1===i.left?(r=(nn.cellSize-(o.width+2))/2,e+=o.width+2+r):!1===i.top?(a=(nn.cellSize-(o.height+2))/2,n+=o.height+2+a):!1===i.bottom&&(a=(nn.cellSize-(o.height+2))/2),t.clearRect(e*he,n*he,r*he,a*he)}}function pe(t){nn=t;const[e,n,i,o]=nn.spawn;tn.x=e,tn.y=n,tn.direction.x=i,tn.direction.y=o,Cn.clearRect(0,0,yn,pn),Rn.clearRect(0,0,yn,pn),ye(Rn),Ut(on=Wt(nn),{x:Math.floor(tn.x),y:Math.floor(tn.y)})}function me(t){return{height:t.length,width:t[0].length,data:t.map((t,e)=>t.split("").map((t,n)=>({x:n,y:e,type:t,offset:0})))}}const xe={"-":0,"=":1,"~":4,D:3,d:3,L:2,l:2,X:6};function ge(t,e,n){return t.data[n]&&t.data[n][e]}const we=(t,{x:e,y:n})=>ge(t,Math.floor(e),Math.floor(n));function Me(t){return!t||(t.type===ze||t.type===Ce)}function be(t,e,n,i=!1){const o=[];return e>0&&o.push(t.data[n][e-1]),e<t.width-1&&o.push(t.data[n][e+1]),n>0&&(o.push(t.data[n-1][e]),i&&(e>0&&o.push(t.data[n-1][e-1]),e<t.width-1&&o.push(t.data[n-1][e+1]))),n<t.height-1&&(o.push(t.data[n+1][e]),i&&(e>0&&o.push(t.data[n+1][e-1]),e<t.width-1&&o.push(t.data[n+1][e+1]))),o}const ve=t=>"D"===t.type||"L"===t.type,Se=t=>"d"===t.type||"l"===t.type,ke=t=>ve(t)||Se(t);function Xe(){var t,e;!function(){vn.fillStyle="#ffffff",vn.fillRect(0,0,yn,pn),kn.clearRect(0,0,yn,pn),Bn=new ImageData(yn,pn),nn.sky&&function(t,e){t.fillStyle=e,t.fillRect(0,0,yn,pn/2)}(Mn,nn.sky),Tn=[],_t(tn.direction,hn),ae(hn,ln/100*1.33);for(let e=0;e<yn;e+=1){const n=ce(e),[i,o,r,a,s]=le(n);if(!i){Tn.push(null);continue}Tn.push(o);let c=Math.abs(Math.floor(pn/o)),l=Math.floor((pn-c)/2),h=l+c;if(i.flashing)Mn.fillStyle="#ffffff",Mn.fillRect(e,l,1,c);else{const t=xe[i.type];let o=0;i.offset&&(0===a&&n.direction.x>0&&(o=i.offset),0===a&&n.direction.x<0&&(o=-i.offset),1===a&&n.direction.y>0&&(o=i.offset),1===a&&n.direction.y<0&&(o=-i.offset));let r=Math.floor((s+t+o)*cn);Mn.drawImage(Ve,r,0,1,cn,e,l,1,c)}nn.sky||1!==a||(vn.fillStyle="rgba(0, 0, 0, 0.3)",vn.fillRect(e,l,1,c));let f,u,d=1;if(nn.fog){const n=5,i=nn.fogDistance||30,o=E(R(r,n,i),n,i,0,1);d=(t=o)*(2-t);const[a,s,h]=nn.fog;kn.fillStyle=`rgba(${a}, ${s}, ${h}, ${d})`,kn.fillRect(e,l,1,c)}let y=0,p=0;Se(i)&&(y=.5),ve(i)&&(p=.5),0===a?n.direction.x>0?(f=i.x+y,u=i.y+s+p):(f=i.x+1-y,u=i.y+1-s+p):n.direction.y>0?(f=i.x+1-s+y,u=i.y+p):(f=i.x+s+y,u=i.y+1-p);for(let t=h;t<pn;t++){let i=pn/(2*t-pn)/o,r=i*f+(1-i)*n.x,a=i*u+(1-i)*n.y;const s=nn.floor;let c=Math.floor(r*cn)%cn+cn*s,l=Math.floor(a*cn)%cn;const h=4*(Ve.width*l+c);if(Re(An,h,Bn,4*(yn*t+e)),!nn.sky){Re(An,h,Bn,4*(yn*(pn-t-1)+e))}}}var t;Yn.clearRect(0,0,yn,pn),Yn.putImageData(Bn,0,0),Mn.drawImage(Xn,0,0),Mn.globalCompositeOperation="multiply",Mn.drawImage(bn,0,0),Mn.globalCompositeOperation="source-over",Mn.drawImage(Sn,0,0),nn.entities.forEach(t=>{!function(t,e){const{sprite:n,z:i,transformY:o,screenX:r,screenWidth:a,screenHeight:s}=e;if(!n)return;if(o<=0)return;const c=pn/o*i;let l=-s/2+pn/2-c,h=s/2+pn/2-c,f=Math.round(-a/2+r);f<0&&(f=0);let u=a/2+r;u>=yn&&(u=yn);for(let e=f;e<u;e++){const i=Math.floor(16*(e-(-a/2+r))/a),s=0,c=Tn[e];e>=0&&e<yn&&(null===c||c>o)&&t.drawImage(n,i,s,1,16,e,l,1,h-l)}}(Mn,t)})}(),qe===Fe&&(Mn.fillStyle="rgba(0,0,0,0.5)",Mn.fillRect(60,20,200,160),Mn.save(),Mn.scale(5,5),ut(Mn,He,"ENTOMBED",17,7),Mn.restore(),Ke&&ft(Mn,Je,"click to start",80),Ye(85,100)),qe===Te&&(Mn.fillStyle="rgba(0,0,0,0.5)",Mn.fillRect(30,15,260,170),Mn.save(),Mn.scale(5,5),ut(Mn,He,"YOU ESCAPED",11,6),Mn.restore(),Ke&&ft(Mn,Je,"click to restart",75),Ie(56,100),ut(Mn,Je,"achievements",t=150,e=100),Object.entries(Y).forEach(([n,i],o)=>{const r=i?`${n} - ${X[n]}`:`${n} - ???`;i||(Mn.globalAlpha=.4),ut(Mn,Je,r,t,e+14+10*o),Mn.globalAlpha=1})),qe===Ae&&(Mn.fillStyle="rgba(0,0,0,0.5)",Mn.fillRect(50,20,220,160),Mn.save(),Mn.scale(5,5),ut(Mn,je,"YOU DIED",17,7),Mn.restore(),Ke&&ft(Mn,Je,"click to return to title",80),Ie(76,100)),qe===De&&(Mn.fillStyle="rgba(0,0,0,0.5)",Mn.fillRect(60,20,200,160),Mn.save(),Mn.scale(5,5),ut(Mn,Je,"PAUSED",21,8),Mn.restore(),Ke&&ft(Mn,Je,"click to resume",80),Ye(85,100)),qe===Le&&(!function(t){t.drawImage(Qe,96,0,16,16,Math.floor(ot.x),Math.floor(ot.y),128,128),ot.flash&&t.drawImage(Qe,32,0,16,16,Math.floor(ot.x)-32,Math.floor(ot.y)-12,128,128)}(Mn),function(t){if(t.fillStyle="#777777",t.fillRect(0,pn-_e,yn,_e),!an){t.fillStyle="#FFFFFF";const e=yn/2,n=pn/2;t.fillRect(e-1,n,3,1),t.fillRect(e,n-1,1,3)}t.save(),t.translate(0,pn-_e),t.fillStyle="#5c5c5c",t.fillRect(2,2,86,9),ut(t,Je,"health",6,4),t.fillStyle="#57161c",t.fillRect(34,4,50,5);const e=E(tn.health,0,tn.maxHealth,0,50);t.fillStyle="#ba1826",t.fillRect(34,4,e,5),t.fillStyle="#5c5c5c",t.fillRect(92,2,80,9),ut(t,Je,"mana",96,4),t.fillStyle="#102746",t.fillRect(118,4,50,5);const n=E(tn.mana,0,tn.maxMana,0,50);t.fillStyle="#2474ba",t.fillRect(118,4,n,5),t.fillStyle="#5c5c5c",t.fillRect(294,2,24,9),t.drawImage(Ne[11],298,-6),tn.hasKey&&t.drawImage(We[11],298,-6),t.restore()}(Mn),rn&&rn.tooltip&&function(t,e,n="#000000"){let i=4*e.length+8;const o=(yn-i)/2,r=(pn-14)/2;t.fillStyle=n,t.fillRect(o,r,i,14),ft(t,Je,e,r+4)}(Mn,rn.tooltip,"#222423"),function(t){!function(t,e,n,i,o){t.fillStyle=o,t.beginPath(),t.arc(e,n,i,0,2*Math.PI),t.fill(),t.closePath()}(t,tn.x*he,tn.y*he,20,"#ffffff")}(Cn),an&&de(Mn)),Ft&&ut(Mn,Je,`mouse sensitivity: ${16-zt-1} / 15`,4,4),Ln.drawImage(wn,0,0,yn*mn,pn*mn)}function Ye(t,e){ht(Mn,["ARROWS / WASD : move","E : interact","left mouse : shoot","right mouse : melee","M : show map","ESC : pause","-/+ : adjust mouse sensitivity"],t,e)}function Ie(t,e){ut(Mn,Je,"stats",t,e),ht(Mn,Object.entries(I).map(([t,e])=>`${t.split(/(?=[A-Z])/).join(" ")} : ${e}`),t,e+14)}function Re(t,e,n,i){n.data[i]=t.data[e],n.data[i+1]=t.data[e+1],n.data[i+2]=t.data[e+2],n.data[i+3]=255}function Ee(){requestAnimationFrame(Ee);const t=function(){un=fn;let t=((fn=performance.now())-un)/1e3;return dn=1/t,t}();if(U.update(t),nn.entities.forEach(e=>{qe===Le&&e.update(t),e.project()}),qe!==Fe&&qe!==Te||Vt(tn.direction,.002),qe===Le){!function(){if(qe!==Le)return;const t=_t(tn.direction);t.x*=-1,t.y*=-1,tn.velocity.x=0,tn.velocity.y=0,(Ot(yt)||Ot(Mt))&&(tn.velocity.x+=tn.direction.x,tn.velocity.y+=tn.direction.y),(Ot(mt)||Ot(vt))&&(tn.velocity.x-=tn.direction.x,tn.velocity.y-=tn.direction.y),(Ot(pt)||Ot(wt))&&(tn.velocity.x-=t.x,tn.velocity.y-=t.y),(Ot(xt)||Ot(bt))&&(tn.velocity.x+=t.x,tn.velocity.y+=t.y),ie(tn.velocity),ae(tn.velocity,tn.speed),Kt(Xt)&&st(),Kt(Yt)&&ct()}(),tn.update(t);const e=Math.floor(tn.x),n=Math.floor(tn.y);e===tn.mapX&&n===tn.mapY||Ut(on=Wt(nn),{x:e,y:n}),tn.mapX=e,tn.mapY=n,function(t){let e=1,n=0,i=2;te(tn.velocity)||(e=4,n=4,i=4);let o=e*Math.sin(2*i*t),r=n*Math.sin(i*t);ot.offsetX=C(0,ot.offsetX,.1),ot.offsetY=C(0,ot.offsetY,.1),ot.x=ot.originX+r+ot.offsetX,ot.y=ot.originY+o+ot.offsetY}(fn/1e3),nn.entities.sort(z).reverse(),function(t){const e=t.filter(t=>!(t instanceof p));e.push(tn);for(let t=0;t<e.length;t++)for(let n=t+1;n<e.length;n++)Nt(e[t],e[n]),Nt(e[n],e[t])}(nn.entities),rn=function(t){const e=t.find(t=>{if(!t.onInteract||t.transformY<=0||t.transformY>1.5)return;const e=yn/2,n=t.screenWidth/2;return e>t.screenX-n&&e<t.screenX+n});if(e)return e;const[n,i]=le(ce(160));return i<1.5&&ke(n)?n:void 0}(nn.entities),nn.entities=nn.entities.filter(t=>t.alive)}Xe()}const Ce=" ",ze=".",Fe=0,De=1,Le=2,Ae=3,Te=4,Be=0,Oe=1;let Ke=!1,$e=null,qe=Fe;const Pe=t=>{$e=qe,qe=t};let je,He,We=[],Ue=[],Ge=[],Ne=[];const Ze=new Image;let Je,Qe,Ve;Ze.src="assets.png",Ze.addEventListener("load",()=>{let[t,e]=D(132,5),[n,i]=D(224,16),[o,r]=D(128,16);e.drawImage(Ze,0,32,132,5,0,0,132,5),i.drawImage(Ze,0,0,224,16,0,0,224,16),r.drawImage(Ze,0,16,128,16,0,0,128,16),Qe=n,Ve=o,je=L(Je=t,"#FF0000"),He=L(Je,"#ffa200"),An=function(t){const[,e]=D(t.width,t.height);return e.drawImage(t,0,0),e.getImageData(0,0,t.width,t.height)}(Ve);for(let t=0;t<Qe.width;t+=16){const[e,n]=D(16,16);n.drawImage(Qe,t,0,16,16,0,0,16,16),We.push(e),Ue.push(L(e,"#FFFFFF")),Ge.push(L(e,"#FF0000")),Ne.push(L(e,"#4a4a4a"))}Ke=!0,pe(en),requestAnimationFrame(Ee)});const _e=13,tn=new class extends e{constructor(){super(0,0,null),this.x=1,this.y=1,this.radius=.4,this.velocity={x:0,y:0},this.speed=4,this.direction={x:0,y:0},this.mapX=0,this.mapY=0,this.health=100,this.maxHealth=100,this.mana=100,this.maxMana=100,this.static=!1,this.attackCooldown=200,this.hasKey=!1}update(t){super.update(t),g(this,t)}damage(t){Y.unscathed=!1,I.damageTaken+=t,this.health-=t,this.health<=0&&Z()}collide(t,e){return t.collectible?N(t):G(t,e)}},en=(()=>({...me(["--~-~L--~--","~.........-","-.........-","~..-...-..~","-.........-","d.........d","~.........~","-..-...-..-","-.........~","-.........-","---~-D-----"]),name:"test map",spawn:[5.5,5.5,0,-.9999],fog:[100,100,100],fogDistance:10,floor:5,entities:[],graph:{data:[]}}))();let nn,on,rn=null,an=!1;const sn=new t,cn=16,ln=66,hn={x:0,y:0};let fn=0,un=0,dn=0;const yn=320,pn=200,mn=3;let xn,gn;const[wn,Mn]=D(yn,pn),[bn,vn]=D(yn,pn),[Sn,kn]=D(yn,pn),[Xn,Yn]=D(yn,pn),[In,Rn]=D(yn,pn),[En,Cn]=D(yn,pn),[zn,Fn]=D(yn,pn),[Dn,Ln]=D(yn*mn,pn*mn);wrap.appendChild(Dn);let An,Tn=[],Bn=new ImageData(yn,pn);Dn.addEventListener("mousedown",e=>{if(Ke)return qe!==Le&&e.stopPropagation(),On()||Dn.requestPointerLock(),qe===De?Pe($e):qe===Ae?(pe(en),Pe(Fe)):qe===Te?(pe(en),Pe(Fe)):qe===Fe?(xn=new window.AudioContext,tn.health=tn.maxHealth,tn.mana=tn.maxMana,S(),k(),gn=+new Date,pe(K(new t)),Pe(Le)):void 0});const On=()=>document.pointerLockElement===Dn;var Kn;document.addEventListener("pointerlockchange",()=>{On()||qe===Le&&Pe(De)}),(Kn=document).addEventListener("keydown",Lt),Kn.addEventListener("keyup",At),Kn.addEventListener("mousemove",$t),Kn.addEventListener("mousedown",Tt),Kn.addEventListener("mouseup",Bt);</script>
    </body>
</html>
