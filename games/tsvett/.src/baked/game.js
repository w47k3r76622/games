var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=document.body.offsetWidth;canvas.height=document.body.offsetHeight;canvas.style.left="0";canvas.style.top="0";canvas.style.position="fixed";document.body.appendChild(canvas);
var onMobile=!1,lineDashSupported=!1,synth=null,browserName=browserDetect(),hueUp=!1,hueDown=!1,saturationUp=!1,saturationDown=!1,lightnessUp=!1,lightnessDown=!1,isTapping=!1,dragStartPos={x:0,y:0},colorAreaInterval=canvas.width/3,lastTap=null,keysDown=[],fontLargeTitle,fontSmallerTitle,fontRegular,fontSmallRegular,fontLargeTitleInterval,fontSmallerTitleInterval,fontRegularInterval,fontSmallRegularInterval,instructionsArr=["Help Lucky cross the screen before time runs","out by matching the target color.",
"The closer you are the faster he goes!"],mobileInstructions=["Swipe up and down in the marked color areas","to increase/decrease hue, lightness, saturation."],targetColor={h:0,s:0,l:0,lab:null},playerColor={h:127,s:100,l:50},patternsArr=["circles","squares","vertbars","quadratic","lotus"],fadePattern=!1,patternKind="squares",patternElementsArr=[],screenAlpha=0,currentMode="main",finalScore=0,stageResultsArr=[],stage=1,elapsedTime=0,startTime=0,totalTime=0,timeLimit=30,timeLeft=30,modifier=0,explosionParticlesArr=
[];setFonts();setPlatformVars();window.requestAnimFrame=function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();function bindEvent(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)}bindEvent(window,"orientationchange",function(){setFonts()},!1);
function setPlatformVars(){0<=window.orientation&&(onMobile=!0,bindEvent(document.body,"touchstart",doTouchStart,!1),bindEvent(document.body,"touchend",doTouchEnd,!1),bindEvent(document.body,"touchmove",doTouchMove,!1));if("MSIE"!==browserName[0]){if("Chrome"===browserName[0]||"Opera"===browserName[0])lineDashSupported=!0;synth=new SfxrSynth;stateChangeSound=new Audio;stateChangeSound.src=synth.getWave("2,,0.1173,,0.08,0.56,,0.32,,,,,,0.5406,,,,,0.4,,,0.1,,0.5");shrinkingSound=new Audio;shrinkingSound.src=
synth.getWave("2,0.27,1,,1,0.21,,0.06,,,,,,0.5092,,,,,1,,,,,0.6");expandingSound=new Audio;expandingSound.src=synth.getWave("2,0.27,1,,1,0.24,,0.06,,,,,,0.5092,,,,,1,,,,,0.6");finishedSound=new Audio;finishedSound.src=synth.getWave("2,0.06,0.31,0.3329,0.4142,0.5103,,,,,,-0.26,0.5871,,,,,0.6799,0.77,,,,,0.5");tickSound=new Audio;tickSound.src=synth.getWave("1,,0.0249,0.03,0.155,0.37,,,,,,,,,,,0.36,0.26,0.16,-0.52,0.48,0.08,,0.27");explosionSound=new Audio;explosionSound.src=synth.getWave("3,,0.24,0.63,0.46,0.1408,,,,,,0.1399,,,,,0.2411,-0.1775,1,,,,,0.5")}}
function setFonts(){if(0==window.orientation||180==window.orientation||void 0===window.orientation)fontLargeTitle="bold 200px verdana",fontLargeTitleInterval=220,fontSmallerTitle="bold 100px verdana",fontSmallerTitleInterval=110,fontRegular="35px verdana",fontRegularInterval=40,fontSmallRegular="30px verdana",fontSmallRegularInterval=35,fontTiny=fontCredit="15px verdana";else if(90==window.orientation||-90==window.orientation)fontLargeTitle="bold 100px verdana",fontLargeTitleInterval=110,fontSmallerTitle=
"bold 50px verdana",fontSmallerTitleInterval=60,fontRegular="30px verdana",fontRegularInterval=30,fontSmallRegular="25px verdana",fontSmallRegularInterval=25,fontTiny=fontCredit="15px verdana"}function resizeCanvas(){var a=canvas.width-document.body.offsetWidth;canvas.width=document.body.offsetWidth;canvas.height=document.body.offsetHeight;lucky&&(lucky.updateMaxSpeed(),lucky.updatePos(lucky.pos.x-a,canvas.height/2))}
function browserDetect(){var a=navigator.appName,b=navigator.userAgent,c,d=b.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);d&&null!=(c=b.match(/version\/([\.\d]+)/i))&&(d[2]=c[1]);return d=d?[d[1],d[2]]:[a,navigator.appVersion,"-?"]}function randomFromTo(a,b){return Math.floor(Math.random()*(b-a+1)+a)}function shuffleArray(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a}
function hslToRgb(a,b,c){if(0==b)c=b=a=c;else{var d=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-c):a},e=0.5>c?c*(1+b):c+b-c*b,f=2*c-e;c=d(f,e,a+1/3);b=d(f,e,a);a=d(f,e,a-1/3)}return[255*c,255*b,255*a].map(Math.round)}
function rgbToXyz(a,b,c){a/=255;b/=255;c/=255;a=0.04045<a?Math.pow((a+0.055)/1.055,2.4):a/12.92;b=0.04045<b?Math.pow((b+0.055)/1.055,2.4):b/12.92;c=0.04045<c?Math.pow((c+0.055)/1.055,2.4):c/12.92;a*=100;b*=100;c*=100;X=0.4124*a+0.3576*b+0.1805*c;Y=0.2126*a+0.7152*b+0.0722*c;Z=0.0193*a+0.1192*b+0.9505*c;return[X,Y,Z]}
function xyzToLab(a,b,c){a/=95.047;b/=100;c/=108.883;a=0.008856<a?Math.pow(a,1/3):7.787*a+16/116;b=0.008856<b?Math.pow(b,1/3):7.787*b+16/116;c=0.008856<c?Math.pow(c,1/3):7.787*c+16/116;return[116*b-16,500*(a-b),200*(b-c)]}
function cie1994(a,b,c){a={l:a[0],a:a[1],b:a[2]};b={l:b[0],a:b[1],b:b[2]};labx=a;laby=b;var d,e;c?(d=0.014,e=0.048,c=2):(d=0.015,e=0.045,c=1);var f=Math.sqrt(a.a*a.a+a.b*a.b),g=Math.sqrt(b.a*b.a+b.b*b.b);d=1+d*f;e=1+e*f;var l=a.a-b.a,h=a.b-b.b,f=f-g;a=a.l-b.l;b=Math.sqrt(l*l+h*h-f*f);return Math.sqrt(Math.pow(a/(1*c),2)+Math.pow(f/(1*e),2)+Math.pow(b/(1*d),2))}bindEvent(window,"keydown",function(a){keysDown[a.keyCode]=!0},!1);
bindEvent(window,"keyup",function(a){delete keysDown[a.keyCode];if(synth)if(81===a.keyCode||87===a.keyCode||69===a.keyCode)expandingSound.pause(),expandingSound.currentTime=0;else if(65===a.keyCode||83===a.keyCode||68===a.keyCode)shrinkingSound.pause(),shrinkingSound.currentTime=0;360<playerColor.h?playerColor.h=360:0>playerColor.h&&(playerColor.h=0);100<playerColor.s?playerColor.s=100:0>playerColor.h&&(playerColor.s=0);100<playerColor.l?playerColor.l=100:0>playerColor.h&&(playerColor.l=0)},!1);
document.body.onkeypress=function(a){a="number"==typeof a.which?a.which:a.keyCode;13===a&&"main"!==currentMode?doNext():32===a&&(document.body.onkeydown=function(a){a="number"==typeof a.which?a.which:a.keyCode;81===a&&360>playerColor.h?playerColor.h+=1:65===a&&0<playerColor.h&&(playerColor.h-=1);87===a&&100>playerColor.s?playerColor.s+=1:83===a&&0<playerColor.s&&(playerColor.s-=1);69===a&&100>playerColor.l?playerColor.l+=1:68===a&&0<playerColor.l&&(playerColor.l-=1)})};var latestTap=null;
function doTouchStart(a){var b=(new Date).getTime()-latestTap;300>b&&0<b?"main"!==currentMode&&doNext():(b=a.changedTouches[0].pageX,a=a.changedTouches[0].pageY,isTapping=!0,dragStartPos.x=b,dragStartPos.y=a);latestTap=(new Date).getTime()}function doTouchEnd(a){lightnessDown=lightnessUp=saturationDown=saturationUp=hueDown=hueUp=isTapping=!1}
function doTouchMove(a){a.preventDefault();a=a.changedTouches[0].pageY;isTapping&&(dragStartPos.x<=1*colorAreaInterval?a<dragStartPos.y?hueUp=!0:(hueDown=!0,hueUp=!1):dragStartPos.x>1*colorAreaInterval&&dragStartPos.x<=2*colorAreaInterval?a<dragStartPos.y?saturationUp=!0:(saturationDown=!0,saturationUp=!1):dragStartPos.x>2*colorAreaInterval&&dragStartPos.x<=3*colorAreaInterval&&(a<dragStartPos.y?lightnessUp=!0:(lightnessDown=!0,lightnessUp=!1)))}
function update(){elapsedTime=parseInt((new Date-startTime)/1E3);var a=timeLeft;timeLeft=timeLimit-elapsedTime;checkScore();if("main"===currentMode&&(10>=timeLeft&&a>timeLeft&&synth&&tickSound.play(),0>=timeLeft)){if(0===explosionParticlesArr.length)for(synth&&explosionSound.play(),a=0;360>a;a+=Math.round(36)){var b=new explosionParticle;b.pos.x=lucky.pos.x;b.pos.y=lucky.pos.y;b.radius=randomFromTo(10,35);var c=randomFromTo(150,270);b.velocity.x=c*Math.cos(a*Math.PI/180);b.velocity.y=c*Math.sin(a*
Math.PI/180)}lucky=null}fadePattern?(screenAlpha+=5*modifier,1<=screenAlpha&&(fadePattern=!1,updatePlayerPattern())):0.05<screenAlpha?screenAlpha-=5*modifier:0.05>=screenAlpha&&(screenAlpha=0);checkControls()}
function checkControls(){81 in keysDown||hueUp?360>playerColor.h&&(synth&&expandingSound.play(),32 in keysDown||(playerColor.h+=Math.round(210*modifier))):(65 in keysDown||hueDown)&&0<playerColor.h&&(synth&&shrinkingSound.play(),32 in keysDown||(playerColor.h-=Math.round(210*modifier)));87 in keysDown||saturationUp?100>playerColor.s&&(synth&&expandingSound.play(),32 in keysDown||(playerColor.s+=Math.round(50*modifier))):(83 in keysDown||saturationDown)&&0<playerColor.s&&(synth&&shrinkingSound.play(),
32 in keysDown||(playerColor.s-=Math.round(50*modifier)));69 in keysDown||lightnessUp?100>playerColor.l&&(synth&&expandingSound.play(),32 in keysDown||(playerColor.l+=Math.round(50*modifier))):(68 in keysDown||lightnessDown)&&0<playerColor.l&&(synth&&shrinkingSound.play(),32 in keysDown||(playerColor.l-=Math.round(50*modifier)))}
function checkScore(){var a=0,a=hslToRgb(playerColor.h/360,playerColor.s/100,playerColor.l/100),a=rgbToXyz(a[0],a[1],a[2]),a=xyzToLab(a[0],a[1],a[2]),a=cie1994(a,targetColor.lab,!1),a=parseFloat((100-a).toFixed(2));stageResultsArr[stage-1]=a}
function render(){ctx.clearRect(0,0,canvas.width,canvas.height);drawPlayerColor();switch(currentMode){case "main":drawTimeDots();drawStageCounter();drawPlayerColorScales();break;case "menu":drawMenu();break;case "results":drawResults()}onMobile&&drawTouchGuides();fadePattern&&(ctx.fillStyle="rgba(255,255,255,"+screenAlpha+")",ctx.fillRect(0,0,canvas.width,canvas.height))}
function drawPlayerColor(){ctx.save();ctx.fillStyle="hsl("+playerColor.h+","+playerColor.s+"%,"+playerColor.l+"%)";switch(patternKind){case "circles":for(var a=0;a<patternElementsArr.length;a++){var b=patternElementsArr[a];ctx.beginPath();ctx.arc(b.x,b.y,b.radius,0,2*Math.PI,!1);ctx.closePath();ctx.fill()}break;case "squares":for(a=0;a<patternElementsArr.length;a++)b=patternElementsArr[a],ctx.fillRect(b.x,b.y,2*b.radius,2*b.radius);break;case "vertbars":for(a=0;a<patternElementsArr.length;a++)b=patternElementsArr[a],
ctx.fillRect(b.x,b.y,b.size.x,b.size.y);break;case "lotus":case "quadratic":for(a=0;a<patternElementsArr.length;a++)b=patternElementsArr[a],ctx.beginPath(),ctx.lineWidth=10,ctx.beginPath(),ctx.moveTo(b.startPos.x,b.startPos.y),ctx.quadraticCurveTo(b.curve1ControlPoint.x,b.curve1ControlPoint.y,b.endPos.x,b.endPos.y),ctx.quadraticCurveTo(b.curve2ControlPoint.x,b.curve2ControlPoint.y,b.startPos.x,b.startPos.y),ctx.closePath(),ctx.fill()}ctx.restore()}
function drawTimeDots(){var a=5,b=5;ctx.fillStyle="rgba(255, 255, 255, 0.5)";for(var c=0;c<timeLeft;c++)ctx.fillRect(a,b,15,15),a>=canvas.width-15-5?(b+=30,a=5):a+=30}function drawStageCounter(){var a=0;ctx.textBaseline="top";ctx.textAlign="center";onMobile&&(a=55);for(var b=5,a=canvas.height-50-5-a,c=0;c<stageResultsArr.length;c++)ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(b,a,50,50),ctx.fillStyle="#555",ctx.font=fontTiny,c!==stage-1&&ctx.fillText(stageResultsArr[c],b+25,a),b+=60}
function drawPlayerColorScales(){var a=360,b=0,c=0,d="hsl(0,100%,100%)",a=360,e=a/360;onMobile?(b=canvas.width-75-15,c=0):(b=canvas.width-75-15,c=canvas.height-a);for(var f=ctx.createLinearGradient(b+25,c+a,b,c),g=0;360>g;g+=e)d="hsl("+g+",100%,50%)",f.addColorStop(g/360,d);ctx.fillStyle=f;ctx.fillRect(b,c,25,a);ctx.fillStyle="#fff";d=c+a-playerColor.h;ctx.fillRect(b,d,25,10);a=100;e=a/100;b+=30;f=ctx.createLinearGradient(b+25,c+a,b,c);ctx.save();ctx.translate(0,c-a+100);ctx.scale(1,3.6);ctx.translate(0,
-(c-a+100));for(g=100;0.1<g;g-=0.1)d="hsl("+playerColor.h+","+g+"%,50%)",f.addColorStop(g/100,d);ctx.fillStyle=f;ctx.fillRect(b,c,25,a);ctx.fillStyle="#fff";d=c+a-playerColor.s*e;ctx.fillRect(b,d,25,10/3.6);b+=30;f=ctx.createLinearGradient(b+25,c+a,b,c);for(g=100;0<g;g-=e)d="hsl("+playerColor.h+",50%,"+g+"%)",f.addColorStop(g/100,d);ctx.fillStyle=f;ctx.fillRect(b,c,25,a);ctx.fillStyle="#fff";d=c+a-playerColor.l*e;ctx.fillRect(b,d,25,10/3.6);ctx.restore()}
function drawTouchGuides(){ctx.shadowBlur=0;ctx.fillStyle="hsl("+playerColor.h+",50%,50%)";ctx.fillRect(0,canvas.height-50,colorAreaInterval,50);ctx.fillStyle="hsl("+playerColor.h+","+playerColor.s+"%,50%)";ctx.fillRect(colorAreaInterval,canvas.height-50,colorAreaInterval,50);ctx.fillStyle="hsl("+playerColor.h+",50%,"+playerColor.l+")";ctx.fillRect(2*colorAreaInterval,canvas.height-50,colorAreaInterval,50);ctx.fillStyle="rgba(0,0,0,0.3)";ctx.fillRect(colorAreaInterval,canvas.height-300,2,300);ctx.fillRect(2*
colorAreaInterval,canvas.height-300,2,300);ctx.font=fontRegular;ctx.textAlign="center";var a=colorAreaInterval/2;ctx.fillText("HUE",a,canvas.height-fontRegularInterval);a+=colorAreaInterval;ctx.fillText("SATURATION",a,canvas.height-fontRegularInterval);a+=colorAreaInterval;ctx.fillText("LIGHTNESS",a,canvas.height-fontRegularInterval)}
function drawMenu(){ctx.textAlign="center";ctx.textBaseline="top";ctx.fillStyle="#fff";pos={x:canvas.width/2,y:0};ctx.strokeStyle="#333";ctx.lineWidth=3;ctx.save();ctx.shadowBlur=3;ctx.shadowColor="rgba(0,0,0,0.5)";ctx.font=fontLargeTitle;ctx.strokeText("TSVETT",pos.x,pos.y);ctx.fillText("TSVETT",pos.x,pos.y);ctx.font=fontRegular;pos.y+=fontLargeTitleInterval;for(var a=0;a<instructionsArr.length;a++){var b=instructionsArr[a];ctx.strokeText(b,pos.x,pos.y);ctx.fillText(b,pos.x,pos.y);pos.y+=fontRegularInterval}pos.y+=
fontRegularInterval/2;pos.x-=180;if(onMobile){ctx.save();pos.y+=5;pos.x=canvas.width/2;ctx.fillStyle="#fff";drawInstructionArrows(canvas.width/2,pos.y+35);ctx.fillRect(pos.x-375,pos.y,750,fontSmallRegularInterval*mobileInstructions.length+3);pos.y+=15;ctx.save();ctx.fillStyle="#000";ctx.shadowBlur=0;ctx.textBaseline="middle";ctx.font=fontSmallRegular;for(a=0;a<mobileInstructions.length;a++)b=mobileInstructions[a],ctx.fillText(b,pos.x,pos.y),pos.y+=fontSmallRegularInterval;ctx.restore();ctx.lineWidth=
2;ctx.strokeStyle="#000";pos.y+=50;ctx.strokeText("DOUBLE-TAP TO START",pos.x,pos.y);ctx.fillText("DOUBLE-TAP TO START",pos.x,pos.y)}else{ctx.save();ctx.shadowBlur=0;ctx.textBaseline="middle";ctx.lineWidth=2;ctx.font="bold 25px verdana";ctx.strokeStyle="#000";ctx.beginPath();ctx.rect(pos.x,pos.y,50,50);ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.fillText("A",pos.x+25,pos.y+25);pos.x+=55;var a=360,b=50,c=a/360;ctx.save();ctx.translate(pos.x-a+360,0);ctx.scale(255/a,1);ctx.translate(-(pos.x-
a+360),0);for(var d=ctx.createLinearGradient(pos.x,pos.y,pos.x+a,pos.y+b),e=0;360>e;e+=c)color="hsl("+e+",100%,50%)",d.addColorStop(e/360,color);ctx.fillStyle=d;ctx.fillRect(pos.x,pos.y,a,b);ctx.fillStyle="#fff";c=pos.x+playerColor.h;d=pos.y;ctx.fillRect(c,d,10,b);ctx.restore();pos.x-=55;pos.y+=60;ctx.beginPath();ctx.rect(pos.x,pos.y,50,50);ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.fillText("S",pos.x+25,pos.y+25);pos.x+=55;a=100;b=50;c=b/360;ctx.save();ctx.translate(pos.x-
a+100,0);ctx.scale(255/a,1);ctx.translate(-(pos.x-a+100),0);d=ctx.createLinearGradient(pos.x,pos.y,pos.x+a,pos.y+b);for(e=0;100>e;e+=c)color="hsl("+playerColor.h+","+e+"%,50%)",d.addColorStop(e/100,color);ctx.fillStyle=d;ctx.fillRect(pos.x,pos.y,a,b);ctx.fillStyle="#fff";c=pos.x+playerColor.s;d=pos.y;ctx.fillRect(c,d,255/a,b);ctx.restore();pos.x-=55;pos.y+=60;ctx.beginPath();ctx.rect(pos.x,pos.y,50,50);ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.fillText("D",pos.x+25,pos.y+
25);pos.x+=55;a=100;b=50;c=b/360;ctx.save();ctx.translate(pos.x-a+100,0);ctx.scale(255/a,1);ctx.translate(-(pos.x-a+100),0);d=ctx.createLinearGradient(pos.x,pos.y,pos.x+a,pos.y+b);for(e=0;100>e;e+=c)color="hsl("+playerColor.h+",50%,"+e+"%)",d.addColorStop(e/100,color);ctx.fillStyle=d;ctx.fillRect(pos.x,pos.y,a,b);ctx.fillStyle="#fff";c=pos.x+playerColor.l;d=pos.y;ctx.fillRect(c,d,255/a,b);ctx.restore();pos.x-=55;pos.y-=120;pos.x+=315;ctx.beginPath();ctx.rect(pos.x,pos.y,50,50);ctx.fillStyle="#fff";
ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.fillText("Q",pos.x+25,pos.y+25);pos.y+=60;ctx.beginPath();ctx.rect(pos.x,pos.y,50,50);ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.fillText("W",pos.x+25,pos.y+25);pos.y+=60;ctx.beginPath();ctx.rect(pos.x,pos.y,50,50);ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.fillText("E",pos.x+25,pos.y+25);pos.x=canvas.width/2;pos.y+=60;ctx.beginPath();ctx.rect(pos.x-250,pos.y,500,30);ctx.fillStyle="#fff";ctx.fill();
ctx.stroke();ctx.fillStyle="#000";ctx.fillText("Hold SPACE to increase precision",pos.x,pos.y+15);ctx.restore();pos.y+=50;ctx.strokeText("ENTER TO START",pos.x,pos.y);ctx.fillText("ENTER TO START",pos.x,pos.y)}ctx.restore();pos.y+=50;ctx.font=fontCredit;ctx.fillStyle="#000";ctx.fillText("By Liza Shulyayeva",pos.x,pos.y)}
function drawInstructionArrows(a,b){ctx.lineWidth=5;ctx.strokeStyle="#ff0000";ctx.beginPath();ctx.moveTo(colorAreaInterval/2,canvas.height);ctx.lineTo(colorAreaInterval/2,b);ctx.lineTo(a,b);ctx.stroke();ctx.strokeStyle="#00ff00";ctx.beginPath();ctx.moveTo(2*colorAreaInterval-colorAreaInterval/2,canvas.height);ctx.lineTo(2*colorAreaInterval-colorAreaInterval/2,b);ctx.stroke();ctx.strokeStyle="#0000ff";ctx.beginPath();ctx.moveTo(3*colorAreaInterval-colorAreaInterval/2,canvas.height);ctx.lineTo(3*colorAreaInterval-
colorAreaInterval/2,b);ctx.lineTo(a,b);ctx.stroke()}
function drawResults(){ctx.textAlign="center";ctx.textBaseline="top";ctx.fillStyle="#fff";var a=canvas.width/2,b=10;ctx.strokeStyle="#333";ctx.lineWidth=3;ctx.save();ctx.shadowBlur=3;ctx.shadowColor="rgba(0,0,0,0.5)";ctx.font=fontSmallerTitle;ctx.strokeText("GAME OVER",a,b);ctx.fillText("GAME OVER",a,b);ctx.font=fontRegular;b+=fontSmallerTitleInterval;a=canvas.width/2;ctx.save();ctx.shadowBlur=0;ctx.strokeStyle="#000";ctx.lineWidth=2;ctx.beginPath();ctx.rect(a-250,b,500,3*fontSmallRegularInterval+
3);ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.fillStyle="#000";ctx.font=fontSmallRegular;ctx.fillText("You kept Lucky alive for",a,b);b+=fontSmallRegularInterval;ctx.fillText(stage+" stages and "+totalTime+" seconds",a,b);b+=fontSmallRegularInterval;ctx.fillText("with an accuracy of "+finalScore+"%!",a,b);ctx.restore();b+=50;onMobile?(ctx.strokeText("Double-tap to play again",a,b),ctx.fillText("Double-tap to play again",a,b)):(ctx.strokeText("Press ENTER to play again",a,b),ctx.fillText("Press ENTER to play again",
a,b));ctx.font=fontCredit;ctx.fillStyle="#000";ctx.fillText("By Liza Shulyayeva",a,b+50);ctx.restore()}
function setTargetColor(){for(var a=randomFromTo(0,360);a<targetColor.h+10&&a>targetColor.h-10;)a=randomFromTo(0,360);targetColor.h=a;targetColor.s=randomFromTo(20,100);targetColor.l=randomFromTo(20,70);a=hslToRgb(targetColor.h/360,targetColor.s/100,targetColor.l/100);a=rgbToXyz(a[0],a[1],a[2]);targetColor.lab=xyzToLab(a[0],a[1],a[2]);document.body.style.backgroundColor="hsl("+targetColor.h+","+targetColor.s+"%,"+targetColor.l+"%)"}
function updatePlayerPattern(){var a,b,c,d,e,f,g,l;patternElementsArr.length=0;patternsArr=shuffleArray(patternsArr);patternKind=patternsArr[0];d=c=null;switch(patternKind){case "squares":case "circles":var h=randomFromTo(5,70);b=a=e=0;15>=h?(c=15,d=150):(c=5,d=90);for(var k=0;k<h;k++)e=randomFromTo(c,d),a=randomFromTo(0,canvas.width),b=randomFromTo(0,canvas.height),patternElementsArr.push({x:a,y:b,radius:e});break;case "vertbars":c=0;h=canvas.width/25;for(k=a=0;k<h;k++)c=randomFromTo(10,canvas.height),
a+=25,b=0,patternElementsArr.push({x:a,y:b,size:{x:25,y:c}});break;case "quadratic":h=randomFromTo(1,5);for(k=0;k<h;k++)g=randomFromTo(0,100),l=randomFromTo(0,canvas.height),e=randomFromTo(canvas.width-100,canvas.width),f=randomFromTo(0,canvas.height),c=randomFromTo(0,canvas.width),d=randomFromTo(0,canvas.height),a=randomFromTo(0,canvas.width),b=randomFromTo(0,canvas.height),patternElementsArr.push({startPos:{x:g,y:l},endPos:{x:e,y:f},curve1ControlPoint:{x:c,y:d},curve2ControlPoint:{x:a,y:b}});break;
case "lotus":h=randomFromTo(5,10);g=canvas.width/2;l=canvas.height;var m=0,p=canvas.height-100,q=randomFromTo(50,300),n=canvas.width/h;e=n;for(k=0;k<h;k++)f=randomFromTo(0,50),c=m,d=p,a=m+q,b=p-20,e+=n,m+=n,patternElementsArr.push({startPos:{x:g,y:l},endPos:{x:e,y:f},curve1ControlPoint:{x:c,y:d},curve2ControlPoint:{x:a,y:b}})}}function transitionColor(a,b,c,d){c||(c=d?0.05:5);a>b?a-=c:a<b&&(a+=c);return a}
function Lucky(){this.maxSpeed=this.speed=0;this.radius=45;this.color="#000";this.pos={x:0,y:canvas.height/2};this.eyePos={x:this.pos.x+35,y:this.pos.y-2*this.radius};this.baseline=canvas.height/2;this.bouncingUp=!0;this.bounceHeight=50;this.update=function(){var a=stageResultsArr[stage-1];this.speed=this.maxSpeed*a/100;90<a?this.speed=2*this.maxSpeed*a/100:50>a&&(this.speed=this.maxSpeed/2*a/100);this.pos.x+=this.speed*modifier;this.eyePos.x+=this.speed*modifier;this.pos.x>=canvas.width+this.radius&&
("main"===currentMode?doNext():this.updatePos(0,canvas.height/2));a=this.baseline-this.bounceHeight;this.bouncingUp?(this.pos.y-=this.speed*modifier,this.eyePos.y-=this.speed/2*modifier,this.pos.y<=a&&(this.bouncingUp=!1)):(this.pos.y+=this.speed*modifier,this.eyePos.y+=this.speed/2*modifier,this.pos.y>=this.baseline&&(this.bouncingUp=!0));this.draw()};this.draw=function(){"main"===currentMode&&(ctx.lineWidth=3,ctx.strokeStyle="#000",lineDashSupported&&ctx.setLineDash([15]),ctx.beginPath(),ctx.moveTo(0,
canvas.height/2+this.radius/1.5),ctx.lineTo(canvas.width,canvas.height/2+this.radius/1.5),ctx.stroke());ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,this.radius,0.7*Math.PI,0.3*Math.PI,!1);ctx.closePath();ctx.fill();ctx.beginPath();ctx.arc(this.eyePos.x,this.eyePos.y,this.radius/3,0,2*Math.PI,!1);ctx.closePath();ctx.fill();lineDashSupported&&ctx.setLineDash([3]);ctx.beginPath();ctx.strokeStyle="#000";ctx.moveTo(this.pos.x+15,this.pos.y);ctx.quadraticCurveTo(this.pos.x-15,
this.pos.y-this.radius-10,this.eyePos.x,this.eyePos.y);ctx.lineWidth=3;ctx.stroke();lineDashSupported&&ctx.setLineDash([0]);var a=stageResultsArr[stage-1];ctx.fillStyle="#ccc";ctx.beginPath();85<=a?(ctx.arc(this.eyePos.x,this.eyePos.y,this.radius/3.5,0,1*Math.PI,!0),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.fillStyle="#ccc",ctx.lineWidth=2,ctx.arc(this.pos.x+this.radius/2,this.pos.y,this.radius/2,0,1*Math.PI,!1)):85>a&&60<a?(ctx.arc(this.eyePos.x,this.eyePos.y,this.radius/3.5,0,2*Math.PI,!1),
ctx.closePath(),ctx.fill(),ctx.fillStyle="#000",ctx.beginPath(),ctx.arc(this.eyePos.x,this.eyePos.y,this.radius/7,0,2*Math.PI,!1),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.fillStyle="#ccc",ctx.lineWidth=2,ctx.arc(this.pos.x+this.radius/2,this.pos.y,this.radius/5,0,2*Math.PI,!1)):(ctx.arc(this.eyePos.x,this.eyePos.y,this.radius/3.5,0.7*Math.PI,1.9*Math.PI,!1),ctx.fill(),ctx.beginPath(),ctx.fillStyle="#ccc",ctx.lineWidth=2,ctx.arc(this.pos.x+this.radius/2,this.pos.y+5,this.radius/2,0,1*Math.PI,
!0));ctx.closePath();ctx.fill()};this.updatePos=function(a,b){0<=a&&(this.pos.x=a);0<=b&&(this.baseline=this.pos.y=b);this.eyePos={x:this.pos.x+35,y:this.pos.y-2*this.radius}};this.updateMaxSpeed=function(){this.maxSpeed=canvas.width/10}}
function explosionParticle(){this.pos={x:0,y:0};this.velocity={x:0,y:0};this.radius=20;this.color="#000";this.scaleSpeed=this.speed=50;this.direction={x:null,y:null};this.destinationPos={x:0,y:0};explosionParticlesArr.push(this);this.removeFromArray=function(a,b){var c=b.indexOf(a);b.splice(c,1)};this.update=function(){this.radius-=this.scaleSpeed*modifier;2>=this.radius&&(this.removeFromArray(this,explosionParticlesArr),0>=explosionParticlesArr.length&&gameOver());this.pos.x+=this.velocity.x*modifier;
this.pos.y+=this.velocity.y*modifier;this.draw()};this.draw=function(){ctx.save();0<this.radius&&(ctx.beginPath(),ctx.arc(this.pos.x,this.pos.y,this.radius,0,2*Math.PI,!0),ctx.closePath(),ctx.fillStyle=this.color,ctx.fill());ctx.restore()}}
function doNext(){fadePattern=!0;synth&&stateChangeSound.play();switch(currentMode){case "menu":currentMode="main";reset();break;case "main":lucky.updatePos(0,canvas.height/2);100===stageResultsArr[stage-1]?timeLimit*=2:91<stageResultsArr[stage-1]&&(timeLimit+=2*timeLeft*(10-(100-stageResultsArr[stage-1]))/100);stage++;setTargetColor();break;case "results":currentMode="menu",reset()}}
function gameOver(){totalTime=elapsedTime;for(var a=0,b=0;b<stageResultsArr.length;b++)a+=stageResultsArr[b];finalScore=(a/stageResultsArr.length).toFixed(2);synth&&finishedSound.play();currentMode="results";reset()}
function reset(){lucky=new Lucky;lucky.updateMaxSpeed();elapsedTime=0;"main"===currentMode?(lucky.updatePos(0,canvas.height/2),startTime=new Date,elapsedTime=0):"menu"===currentMode?(lucky.updatePos(0,canvas.height/2),totalTime=startTime=0,timeLeft=timeLimit=30):"results"===currentMode&&(lucky=null);"results"!==currentMode&&(stage=1,stageResultsArr.length=0,setTargetColor(),updatePlayerPattern())}
function main(){var a=Date.now(),b=a-then;window.requestAnimFrame(main);modifier=b/1E3;update();render();lucky&&lucky.update();for(b=0;b<explosionParticlesArr.length;b++)explosionParticlesArr[b].update();then=a}currentMode="menu";playerColor.h=randomFromTo(5,360);playerColor.s=randomFromTo(50,100);playerColor.l=randomFromTo(20,80);reset();var then=Date.now();resizeCanvas();window.requestAnimFrame(main);bindEvent(window,"resize",resizeCanvas,!1);