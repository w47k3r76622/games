'use strict';function h(a){return[...Array(a).keys()]}function k(a){return~~(Math.random()*a)}function n(a,b){const c=h(a);return h(b).map(()=>{const [d]=c.splice(k(c.length),1);return d})}function p(a,b){const c=a[0],d=b(c);return a.slice(1).reduce(([e,f],g)=>{const l=b(g);return l<f?[g,l]:[e,f]},[c,d])}function*q(...a){for(const b of a)yield*b}function r(a,b){const c=[];for(const d of a)c.push(b(d));return c};class t{constructor(){this.a=new Map}subscribe(a){this.a.set(a,void 0)}};function u(a){const b=new v;for(const c of a)w(b,c);return b}function w(a,b){a[0]+=b[0];a[1]+=b[1]}function x(a,b){return new v(a[0]*b,a[1]*b)}function y(a,b){a[0]*=b;a[1]*=b}function z(a){var b=new v(.995,1);a[0]*=b[0];a[1]*=b[1]}
class v extends Float32Array{constructor(a=0,b=0){super(2);this[0]=a;this[1]=b}get x(){return this[0]}get y(){return this[1]}set x(a){this[0]=a}set y(a){this[1]=a}add(a){return new v(this[0]+a[0],this[1]+a[1])}trim(a){const b=Math.sqrt(this[0]*this[0]+this[1]*this[1]);b>a&&y(this,a/b)}clone(){return new v(this[0],this[1])}};const A=1/60,C=32/A,D=new v(0,-64),E=new v(0,384),F=new v(-256,0),G=x(F,-1),H=new v(128,288),I=[64];function aa(a,b){console.log(`Generation ${b+1}/${a.a}`);a.o=+new Date}function ba(a){return a.map(([b])=>b).slice(0,10)}function ca(a){const [b,c]=n(a.length,2).map(f=>a[f]),d=k(b.length),e=new Float32Array(b.length);e.set(b.subarray(0,d),0);e.set(c.subarray(d),d);return e}function da(a){const b=n(a.length,~~(.05*a.length));for(const c of b)a[c]+=2*Math.random()-1}
function ea(a,b){const c=b.map(a.K.bind(a));b=c.slice(0,3);const d=c.slice(0,3).map(g=>new Float32Array(g)),e=h(a.M).map(()=>ca(c));for(var f of q(d,e))da(f);f=q(b,d,e);return r(f,a.J.bind(a))}function fa(a){a.sort(([,b],[,c])=>+c-+b)}function ha(a){var b=h(50).map(c=>a.h(c));for(let c=0;c<a.a;c++){aa(a,c);const d=a.j(b,c);fa(d);const [e,f]=d[0];a.b(c,e,f);c<a.a-1&&(b=ba(d),b=ea(a,b))}return b}function J(a){[a]=ha(a);return a}
class ia{constructor(a){this.o=+new Date;this.B=-Infinity;this.a=a;this.v=new t}get M(){return 44}b(a,b,c){const d=+new Date-this.o,e=+c,f=e-this.B;var g=this.v;b={I:b,m:a,N:this.A(a,c)};for(const l of g.a.keys())l(b);console.log(`Generation ${a+1}/${this.a} best score ${e} (improvement ${f}) took ${(d/1E3).toFixed(1)} seconds.`);this.B=e}};class K{constructor(a,b,c){this.O=a;this.left=b;this.right=c}}const L=[new K(!1,!1,!1),new K(!0,!1,!1),new K(!1,!0,!1),new K(!1,!1,!0),new K(!0,!0,!1),new K(!0,!1,!0)];function M(a,b){b*=a.c;return a.buffer.slice(b,b+a.c)}class N{constructor(a,b,c=null){this.rows=a;this.c=b;c?this.buffer=c:this.buffer=new Float32Array(a*b)}set(a){let b=0;for(const c of a)for(const d of c)this.buffer[b++]=d}}function ja(a,b){return new N(a.rows,a.c,a.buffer.map((c,d)=>c+b[d%a.c]))}function ka(a){return new N(a.rows,a.c,a.buffer.map(b=>1/(1+Math.exp(-b))))}function la(a){a=a.map(c=>Math.exp(c));const b=a.reduce((c,d)=>c+d,0);return a.map(c=>c/b)}
function ma(a){const b=new N(a.rows,a.c);h(a.rows).forEach(c=>{const d=la(M(a,c));b.buffer.set(d,c*b.c)});return b}function O(a){let b,c;for(const [d,e]of a.entries())if(void 0===b||e>c)b=d,c=e;return b}function P(a){const b=new Uint8Array(a.rows);for(let c=0;c<a.rows;c++)b[c]=O(M(a,c));return b};class Q{}class R extends Q{constructor(a){super();this.width=a}s(){return this.width}u(a){return a*this.width+this.width}G(a,b){this.b=new N(a,this.width,b.subarray(0,a*this.width));this.a=new Float32Array(this.width)}i(a){{var b=this.b;const c=new N(a.rows,b.c);for(let d=0;d<a.rows;d++)for(let e=0;e<b.c;e++){let f=0;for(let g=0;g<a.c;g++)f+=a.buffer[d*a.c+g]*b.buffer[g*b.c+e];c.buffer[d*c.c+e]=f}a=c}return ja(a,this.a)}}class S extends Q{s(a){return a}u(){return 0}G(){}}
class na extends S{i(a){return ka(a)}}class oa extends S{i(a){return ma(a)}}class pa{constructor(a,b,c=null){this.a=b;{let d=a,e=0;for(const f of b)e+=f.u(d),d=f.s(d);b=e}if(null===c){c=this.l=new Float32Array(b);for(let d=0,e=c.length;d<e;d++)c[d]=2*Math.random()-1}else this.l=c;c=0;for(const d of this.a)b=d.u(a),d.G(a,this.l.subarray(c,c+b)),c+=b,a=d.s(a)}i(a){return this.a.reduce((b,c)=>c.i(b),a)}};function T(a=null){var b=[];for(const c of I)b.push(new R(c)),b.push(new na);b.push(new R(L.length));b.push(new oa);return new pa(138,b,a)}class U extends ia{h(){return T()}K(a){return a.l}J(a){return T(a)}};function qa(a,b,c){var d=a.rows;if(d<=c)return[a,b];d=n(d,c);const e=new N(c,a.c),f=new N(c,b.c);for(let g=0;g<c;g++)e.buffer.set(M(a,d[g]),g*e.c),f.buffer.set(M(b,d[g]),g*f.c);return[e,f]};function ra(a,b){const c=P(a),d=P(b);return c.reduce((e,f,g)=>e+(f===d[g]?1:0),0)/a.rows};class sa{constructor(a,b){this.accuracy=a;this.C=b}valueOf(){return-this.C}}
class ta extends U{constructor(a,b,c,d){super(a);this.inputs=b;a=L.length;b=new N(c.length,a);for(let e=0;e<c.length;e++)b.buffer[e*a+c[e]]=1;this.labels=c=b;this.f=d}j(a){let b,c;void 0===this.f?[b,c]=[this.inputs,this.labels]:[b,c]=qa(this.inputs,this.labels,this.f);return a.map(d=>{{var e=c;const g=d.i(b);var f=ra(g,e);{let l=0;for(let m=0;m<g.buffer.length;m++)l+=-e.buffer[m]*Math.log(g.buffer[m]);e=l}f=new sa(f,e)}return[d,f]})}b(a,b,c){super.b(a,b,c);console.log(`Generation ${a+1} loss=${c.C} acc=${c.accuracy}`)}A(){return!1}}
;class V{constructor(a,b){this.position=a;this.o=b}get j(){return x(this.o,.5)}get b(){return this.j.x}get a(){return this.j.y}get left(){return this.position.x-this.b}set left(a){this.position.x=a+this.b}get right(){return this.position.x+this.b}set right(a){this.position.x=a-this.b}get top(){return this.position.y+this.a}set top(a){this.position.y=a-this.a}get bottom(){return this.position.y-this.a}set bottom(a){this.position.y=a+this.a}};const ua=new v(32,32);class va extends V{constructor(a){super(a,ua)}};class wa{constructor(a,b){this.a=new v(Math.cos(a)*b,Math.sin(a)*b)}getCurrentPosition(a){return a.position.add(this.a)}}function xa(){const a=2*Math.PI/20,b=h(20).map(d=>d*a),c=h(15).map(d=>32*(d+1));return b.map(d=>c.map(e=>new wa(d,e)))};function*ya(){for(const a of h(18))yield[0,a,0];for(const a of h(19))yield[a+1,0,1],yield[a+1,17,2]}function*za(a){const b=k(8)+3,c=k(2)+1;for(var d=1;d<b;d++)yield[a,17-d,3];yield[a,17-b,8];for(d=1;d<=c;d++)yield[a+d,17-b,d===c?9:8],yield[a-d,17-b,d===c?7:8]}function*Aa(a){const b=k(8)+3,c=k(2)+1;for(var d=1;d<b;d++)yield[a,d,3];yield[a,b,5];for(d=1;d<=c;d++)yield[a+d,b,d===c?6:5],yield[a-d,b,d===c?4:5]}
function*Ba(a){const b=k(3)+1,c=k(12)+3;1===b?yield[a,c,1]:2===b?(yield[a,c,2],yield[a+1,c,2],yield[a,c+1,1],yield[a+1,c+1,1]):(yield[a,c,0],yield[a-1,c,1],yield[a+1,c,1],yield[a,c-1,2],yield[a,c+1,1])}function*Ca(a){let b=20;for(;b<a-10;){const c=Math.random();.4>c?yield*za(b):.8>c?yield*Aa(b):yield*Ba(b);b+=k(8)+8}for(const c of h(a-20-10))yield[c+20,0,1],yield[c+20,17,2]}function*Da(a){for(const b of h(10))yield[a-10+b,0,1],yield[a-10+b,17,2]}function*Ea(a){yield*ya();yield*Ca(a);yield*Da(a)};function W(a,b){a=Object.create(a);a.position=b;return a}const Fa=new Map;function Ga(a,b,c){const d=[];b=~~(b/32)-1;for(c=~~(c/32)+1;b<c;b++){const e=a.a.get(b)||Fa;for(const f of e.values())d.push(f)}return d}function Ha(a,b){b.position=H.clone();y(b.g,0);a.b.push(b)}function Ia(a,b){return a.h.map(c=>c.findIndex(d=>{var e=d.getCurrentPosition(b);d=~~(e.y/32);d=(e=a.a.get(~~(e.x/32)))?e.get(d):void 0;return d})).map(c=>-1===c?null:c)}
function X(a,b,c=Ga(a,b.left,b.right)){return c.filter(d=>d.left<b.right&&d.right>b.left&&d.bottom<b.top&&d.top>b.bottom)}
function Ja(a,b){var c=Ia(a,b);const {O:d,left:e,right:f}=Ka(b,c);c=[D];d&&c.push(E);e&&c.push(F);f&&c.push(G);c=x(u(c),A);w(b.g,c);z(b.g);b.g.trim(C);c=b.position.add(x(b.g,A));var g=W(b,c);g=X(a,g);delete b.H;if(g.length){var l=b.position.clone();l=W(b,l);var m=X(a,W(l,new v(b.position.x,c.y)),g);m.length?([m]=p(m,B=>Math.abs(B.position.y-b.position.y)),b.position.y<m.position.y?b.top=m.bottom:b.bottom=m.top,b.g.y=0):b.position.y=c.y;a=X(a,W(l,new v(c.x,b.position.y)),g);a.length?([a]=p(a,B=>Math.abs(B.position.x-
b.position.x)),b.position.x<a.position.x?b.right=a.left:b.left=a.right,b.g.x=0):b.position.x=c.x;y(b.g,.95);b.H=!0}else b.position=c}function La(a){for(var b of a.b)Ja(a,b);b=a.b.map(c=>[c,c.position.x]);b.sort(([,c],[,d])=>d-c);return b.some(([,c])=>c>a.f)?b:null}class Y{constructor(a=320){this.h=xa();this.a=new Map;this.b=[];this.f=32*a;for(const [c,d,e]of Ea(a)){{a=c;var b=d;const f=new va(new v(32*(a+.5),32*(b+.5)),e);let g=this.a.get(a);g||(g=new Map,this.a.set(a,g));g.set(b,f)}}}};class Ma extends V{constructor(a,b){super(a,b);this.g=new v}};const Na=new v(64,32);class Oa extends Ma{constructor(){super(new v,Na);this.H=!1}};class Pa extends Array{constructor(a){super();this.w=a}push(...a){for(;this.length+a.length>this.w;)this.shift();return super.push(...a)}};function Qa(a,b,c){const d=new Float32Array(23);let e=0;for(const f of c)c=(null===f?15:f)/15,d[e++]=c;d[e++]=a.x/C;d[e++]=a.y/C;d[e++]=b.y/576;return d}function Ra(a){for(;a.length!==a.w;)a.unshift(a[0]);const b=new N(1,138);for(let c=0;6>c;c++)b.buffer.set(a[60*c],23*c);return b};function Ka(a,b){a.h.push(Qa(a.g,a.position,b));if(a.f.length)return a.f.shift();b=Ra(a.h);b=a.D.i(b);b=O(M(b,0));const c=L[b];a.f=h(10).map(()=>c);return c}class Sa extends Oa{constructor(a,b){super();this.f=[];this.D=a;this.h=new Pa(301);this.m=b}get name(){return`BACKUP-gen-${this.m+1}`}};class Ta{constructor(a,b){this.F=a;this.finished=b}valueOf(){return this.F}}
class Ua extends U{constructor(a,b){super(a);this.f=new Y;this.L=b}j(a,b){a=a.map(d=>new Sa(d,0));for(var c of a)Ha(this.f,c);b=600+3E3*b/(this.a-1);for(c=0;c<b;c++)if(null!==La(this.f)){console.log("Somebody won the race!");break}return a.map(d=>[d.D,new Ta(d.position.x,d.position.x>=this.f.f)])}b(a,b,c){super.b(a,b,c);c.finished?(console.log("Creating a new level"),this.f=new Y):this.f.b=[]}A(a,b){return a===this.a-1||b.finished||5E3<b.F}h(a){return 0===a?this.L:super.h(a)}};function Va(a,b){a=new N(b.length,138,a);return new ta(20,a,b,2E3)};const Z=self;Z.addEventListener("message",function(a){console.log("Worker received a message");var b=a.data;a=new Float32Array(b.inputs);b=new Uint8Array(b.labels);a=Va(a,b);a.v.subscribe(c=>{Z.postMessage({type:0,step:c.m,totalSteps:220})});a=J(a);a=new Ua(200,a);a.v.subscribe(c=>{let d;const e=20+c.m;c.N?d={type:1,weights:c.I.l,generation:e}:d={type:0,step:e,totalSteps:220};Z.postMessage(d)});J(a);console.log("Worker finished operation")});
