function gameStart(){play=true;clearKeys();generateGameMap();placePlayers();placeMonsters();display()}var play=false;setInterval("if(play)update()",100);setInterval("if(play)moveMonsters();",250);var height=50;var width=50;var chanceToStartAlive=.39;var deathlimit=3;var birthlimit=4;var cellMap=[];var visibility=3;var bushesToTreesRatio=.2;function generateGameMap(){do generateMap();while(!floodFill())}
function generateMap(){clearMap();for(var i=0;i<width;i++)for(var j=0;j<height;j++)if(Math.random()<chanceToStartAlive)cellMap[i][j]=1;else cellMap[i][j]=0;runSimulation();runSimulation();runSimulation();runSimulation();for(var i=0;i<5;i++)if(floodFill())break;else runSimulation();for(var i=0;i<width;i++)for(var j=0;j<height;j++)if(cellMap[i][j]==1)if(Math.random()<bushesToTreesRatio)cellMap[i][j]=4}function clearMap(){cellMap=[];for(var i=0;i<width;i++)cellMap[i]=[]}
function runSimulation(){var tempMap=[];for(var i=0;i<width;i++)tempMap[i]=[];for(var i=0;i<width;i++)for(var j=0;j<height;j++)if(i==0||j==0||i==width-1||j==height-1)tempMap[i][j]=1;else if(cellMap[i][j]==1)if(countAliveNeighbours(i,j)<deathlimit)tempMap[i][j]=0;else tempMap[i][j]=1;else if(countAliveNeighbours(i,j)>birthlimit)tempMap[i][j]=1;else tempMap[i][j]=0;cellMap=JSON.parse(JSON.stringify(tempMap))}
function countAliveNeighbours(x,y){var count=0;for(var i=x-1;i<=x+1;i++)for(var j=y-1;j<=y+1;j++)if(!(i==x&&j==y)&&cellMap[i][j]==1)count++;return count}
function floodFill(){var x;var y;var t;var queue=[];var tempMap=JSON.parse(JSON.stringify(cellMap));outerloop:for(var i=0;i<width;i++)for(var j=0;j<height;j++)if(cellMap[i][j]==0){queue.push([i,j]);break outerloop}while(queue.length>0){t=queue.pop();x=t[0];y=t[1];if(tempMap[x][y]==0){tempMap[x][y]=3;queue.push([x-1,y],[x+1,y],[x,y-1],[x,y+1])}}for(var i=0;i<width;i++)for(var j=0;j<height;j++)if(tempMap[i][j]==0)return false;return true}
function getVisibleMap(x,y){var visibleMap=[];var tempx;var tempy;for(var i=0;i<2*visibility+1;i++)visibleMap[i]=[];for(var i=0;i<2*visibility+1;i++)for(var j=0;j<2*visibility+1;j++){tempx=x-visibility+i;tempy=y-visibility+j;if(tempx<0||tempy<0||tempx>=width||tempy>=height)visibleMap[i][j]=1;else visibleMap[i][j]=cellMap[tempx][tempy]}return visibleMap}
function displayVisibleMap(pnum){var canvas=document.getElementById("pl"+pnum);var ctx=canvas.getContext("2d");var visiMap=getVisibleMap(playerPosition[pnum][0],playerPosition[pnum][1]);var sprite=new Image;sprite.src="src/lost.png";ctx.fillStyle="#0c4d19";ctx.fillRect(0,0,canvas.width,canvas.height);var l=canvas.width/(2*visibility+1);for(var i=0;i<2*visibility+1;i++)for(var j=0;j<2*visibility+1;j++)if(visiMap[i][j]==1)ctx.drawImage(sprite,0,0,32,32,i*l,j*l,l,l);else if(visiMap[i][j]==0)ctx.drawImage(sprite,
32,0,32,32,i*l,j*l,l,l);else if(visiMap[i][j]==3)ctx.drawImage(sprite,128,0,32,32,i*l,j*l,l,l);else if(visiMap[i][j]==4)ctx.drawImage(sprite,96,0,32,32,i*l,j*l,l,l);else ctx.drawImage(sprite,64,0,32,32,i*l,j*l,l,l);var grad=ctx.createRadialGradient(canvas.width/2,canvas.height/2,20,canvas.width/2,canvas.height/2,canvas.width/1.75);grad.addColorStop(0,"transparent");grad.addColorStop(1,"#03000d");ctx.fillStyle=grad;ctx.fillRect(0,0,canvas.width,canvas.height)}
function display(){displayVisibleMap(0);displayVisibleMap(1)}function gameOver(opt){play=false;var g=document.getElementById("g");g.style.display="none";var e=document.getElementById("e");e.style.display="block";if(opt)e.innerHTML="<br><br><br><br><h2>You were killed by a tree monster</h2>";else e.innerHTML="<br><br><br><br><h2>Finally together</h2>";e.innerHTML+="<br><br><h3>Press ENTER to restart</h3>"}
function clearDiv(){document.getElementById("e").innerHTML="";var g=document.getElementById("g");g.style.display="block";var e=document.getElementById("e");e.style.display="none"}var pressedKeys=[];
document.onkeydown=function(e){if(e.keyCode==87)pressedKeys["87"]=true;else if(e.keyCode==83)pressedKeys["83"]=true;else if(e.keyCode==65)pressedKeys["65"]=true;else if(e.keyCode==68)pressedKeys["68"]=true;else if(e.keyCode==38)pressedKeys["38"]=true;else if(e.keyCode==40)pressedKeys["40"]=true;else if(e.keyCode==37)pressedKeys["37"]=true;else if(e.keyCode==39)pressedKeys["39"]=true;else if(e.keyCode==13){var m=document.getElementById("m");var e=document.getElementById("e");var g=document.getElementById("g");
if(m.style.display!="none"){g.style.display="block";m.style.display="none";gameStart()}else if(e.style.display!="none"){gameStart();clearDiv()}}};
document.onkeyup=function(e){if(e.keyCode==87)pressedKeys["87"]=false;else if(e.keyCode==83)pressedKeys["83"]=false;else if(e.keyCode==65)pressedKeys["65"]=false;else if(e.keyCode==68)pressedKeys["68"]=false;else if(e.keyCode==38)pressedKeys["38"]=false;else if(e.keyCode==40)pressedKeys["40"]=false;else if(e.keyCode==37)pressedKeys["37"]=false;else if(e.keyCode==39)pressedKeys["39"]=false};
function update(){if(pressedKeys[87])movePlayer(0,"u");if(pressedKeys[83])movePlayer(0,"d");if(pressedKeys[65])movePlayer(0,"l");if(pressedKeys[68])movePlayer(0,"r");if(pressedKeys[38])movePlayer(1,"u");if(pressedKeys[40])movePlayer(1,"d");if(pressedKeys[37])movePlayer(1,"l");if(pressedKeys[39])movePlayer(1,"r");display()}function clearKeys(){pressedKeys=[]}var playerPosition=[];var monsterPosition=[];var numberOfMonsters=9;var initialDistance=2E3;
function placePlayers(){playerPosition=[];var p=getRandomPoint();do var q=getRandomPoint();while(calculateDistance(p[0],p[1],q[0],q[1])>initialDistance);playerPosition.push(p);playerPosition.push(q);cellMap[playerPosition[0][0]][playerPosition[0][1]]=2;cellMap[playerPosition[1][0]][playerPosition[1][1]]=2}function placeMonsters(){monsterPosition=[];for(var i=0;i<numberOfMonsters;i++){var p=getRandomPoint();monsterPosition.push(p);cellMap[monsterPosition[i][0]][monsterPosition[i][1]]=3}}
function movePlayer(player,direction){var tempx=playerPosition[player][0];var tempy=playerPosition[player][1];var newx=tempx;var newy=tempy;switch(direction){case "u":newy-=1;break;case "d":newy+=1;break;case "l":newx-=1;break;case "r":newx+=1;break}if(cellMap[newx][newy]==2){otherPlayer=player==0?1:0;if(playerPosition[otherPlayer][0]==newx&&playerPosition[otherPlayer][1]==newy){cellMap[newx][newy]=0;gameOver(0)}}else if(cellMap[newx][newy]==3){cellMap[tempx][tempy]=0;cellMap[newx][newy]=0;gameOver(1)}else if(cellMap[newx][newy]==
0){cellMap[tempx][tempy]=0;cellMap[newx][newy]=2;playerPosition[player]=[newx,newy]}}
function moveMonsters(){for(var i=0;i<numberOfMonsters;i++){var tempx=monsterPosition[i][0];var tempy=monsterPosition[i][1];var newx=tempx;var newy=tempy;var dir=getRandomNumber(5);switch(dir){case 0:newy-=1;break;case 1:newy+=1;break;case 2:newx-=1;break;case 3:newx+=1;break}if(cellMap[newx][newy]==2){if(playerPosition[0][0]==newx&&playerPosition[0][1]==newy||playerPosition[1][0]==newx&&playerPosition[1][1]==newy){cellMap[newx][newy]=0;gameOver(1)}}else if(cellMap[newx][newy]==0){cellMap[tempx][tempy]=
0;cellMap[newx][newy]=3;monsterPosition[i]=[newx,newy]}}}function calculateDistance(x1,y1,x2,y2){return(x1-x2)*(x1-x2)+(y1-y2)*(y1-y2)}function getRandomPoint(){do{var x=getRandomNumber(width);var y=getRandomNumber(height)}while(cellMap[x][y]!=0);return[x,y]}function getRandomNumber(max){return Math.floor(Math.random()*max)};
