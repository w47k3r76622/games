<title>Deep13</title><style>body,html{width:100%;height:100%;margin:0;padding:0;overflow:hidden;background:#000}canvas{background:#000}#DIV{text-align:center;background:rgba(0,0,0,.5);position:fixed;padding:4px;width:100%;top:5px;left:5px;font:24px monospace;color:#aaa}</style><canvas id=C></canvas><div id=DIV>Generating WORLD...please wait</div><script>for(var i in KEYS={},KEYSP={},MOUSE={pos:[0,0],delta:[0,0],wheel:0,buttons:0,prevb:0},gl=0,DOC=document,BODY=DOC.body,F=0,BODY.onkeydown=BODY.onkeyup=function(e){var t="keydown"==e.type,o="Key"==e.code.substr(0,3)?e.code.substr(3):e.code;KEYSP[o]=t&&!KEYS[o],KEYS[o]=t,window.ONKEY&&ONKEY(e)},D2R=.0174532925,maths=Object.getOwnPropertyNames(Math),maths)window[maths[i].toUpperCase()]=Math[maths[i]];function _INITGL(){gl.ext={},gl.getSupportedExtensions().forEach((e=>gl.ext[e]=gl.getExtension(e))),QUAD=MESH(PLANEG),QUADSHADER=PROGRAM(quad_vs,"in vec2 _uv;IN S2D tex;void main(){fragColor=texture(tex,_uv);;}"),FLATSHADER=PROGRAM(_vs,_fs).uniforms({psize:1})}CLAMP=(e,t,o)=>MIN(MAX(e,t),o),SAT=e=>CLAMP(e,0,1),F32=Float32Array,UINT8=Uint8Array,F32P=F32.prototype,IDM4=new F32([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),ARP=Array.prototype,V3=e=>new F32(e||3),M4=e=>V3(e||IDM4),VP_DATA=V3(4),ZERO=V3(),UP=V3([0,1,0]),TIME=()=>.001*performance.now(),LERP=(e,t,o)=>e*(1-o)+t*o,ILERP=(e,t,o)=>(o-e)/(t-e),REMAP=(e,t,o,a,r)=>LERP(a,r,ILERP(t,o,e)),RAND=(e=1,t=0)=>RANDOM()*e+t,FRACT=e=>e-FLOOR(e),ADD=(e,t,o,a=1)=>(e[0]=t[0]+o[0]*a,e[1]=t[1]+o[1]*a,e[2]=t[2]+o[2]*a,e),SUB=(e,t,o)=>(e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e),SCALE=(e,t,o)=>(e=e||V3(),o.length?(e[0]=t[0]*o[0],e[1]=t[1]*o[1],e[2]=t[2]*o[2]):(e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e),DOT=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],CROSS=(e,t,o)=>{var a=t[0],r=t[1],n=t[2],s=o[0],i=o[1],l=o[2];return e[0]=r*l-n*i,e[1]=n*s-a*l,e[2]=a*i-r*s,e},LEN=e=>SQRT(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),ROTY=(e,t,o)=>{e=e||V3();var a=COS(o),r=SIN(o),n=t[0],s=t[2];return e[0]=a*n-r*s,e[1]=t[1],e[2]=r*n+a*s,e},LERPV3=(e,t,o,a)=>{for(var r=0;r<e.length;++r)e[r]=t[r]*(1-a)+o[r]*a;return e},NORM=(e,t)=>{var o=t[0],a=t[1],r=t[2],n=o*o+a*a+r*r;return n>0&&(n=1/SQRT(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e},DIST=(e,t)=>{var o=t[0]-e[0],a=t[1]-e[1],r=t[2]-e[2];return SQRT(o*o+a*a+r*r)},TMAT4=(e,t)=>(e.set(IDM4),e[12]=t[0],e[13]=t[1],e[14]=t[2],e),RMAT4=(e,t,o)=>{e.set(IDM4);var a,r,n,s=o[0],i=o[1],l=o[2],E=SQRT(s*s+i*i+l*l);return E<1e-4?null:(s*=E=1/E,i*=E,l*=E,a=SIN(t),n=1-(r=COS(t)),e[0]=s*s*n+r,e[1]=i*s*n+l*a,e[2]=l*s*n-i*a,e[4]=s*i*n-l*a,e[5]=i*i*n+r,e[6]=l*i*n+s*a,e[8]=s*l*n+i*a,e[9]=i*l*n-s*a,e[10]=l*l*n+r,e)},SMAT4=(e,t)=>((e=e||M4()).set(IDM4),t.toFixed&&(t=[t,t,t]),e[0]=t[0],e[5]=t[1],e[10]=t[2],e),APPLYTRANS=(e,t,o)=>{var a=TMAT4(M4(),o);return MULTMAT4(e||a,t,a)},APPLYROT=(e,t,o,a)=>{var r=RMAT4(M4(),o,a);return MULTMAT4(e||r,t,r)},APPLYSCALE=(e,t,o)=>{var a=SMAT4(M4(),o);return MULTMAT4(e||a,t,a)},COLOR=(e,t=255)=>[e>>16&255,e>>8&255,255&e,t].MUL(1/255),TRS=(e,t,o,a,r)=>{e=e||M4();var n=TMAT4(M4(),t),s=M4();o&&(o[0]&&APPLYROT(s,s,o[0],[1,0,0]),o[1]&&APPLYROT(s,s,o[1],[0,1,0]),o[2]&&APPLYROT(s,s,o[2],[0,0,1]));var i=SMAT4(M4(),a);return MULTMAT4(e,r||M4(),n),MULTMAT4(e,e,s),MULTMAT4(e,e,i)},MULTMAT4=(e,t,o)=>{var a=t[0],r=t[1],n=t[2],s=t[3],i=t[4],l=t[5],E=t[6],S=t[7],A=t[8],P=t[9],L=t[10],R=t[11],f=t[12],T=t[13],I=t[14],D=t[15],N=o[0],v=o[1],p=o[2],c=o[3];return e[0]=N*a+v*i+p*A+c*f,e[1]=N*r+v*l+p*P+c*T,e[2]=N*n+v*E+p*L+c*I,e[3]=N*s+v*S+p*R+c*D,N=o[4],v=o[5],p=o[6],c=o[7],e[4]=N*a+v*i+p*A+c*f,e[5]=N*r+v*l+p*P+c*T,e[6]=N*n+v*E+p*L+c*I,e[7]=N*s+v*S+p*R+c*D,N=o[8],v=o[9],p=o[10],c=o[11],e[8]=N*a+v*i+p*A+c*f,e[9]=N*r+v*l+p*P+c*T,e[10]=N*n+v*E+p*L+c*I,e[11]=N*s+v*S+p*R+c*D,N=o[12],v=o[13],p=o[14],c=o[15],e[12]=N*a+v*i+p*A+c*f,e[13]=N*r+v*l+p*P+c*T,e[14]=N*n+v*E+p*L+c*I,e[15]=N*s+v*S+p*R+c*D,e},LOOKAT=(e,t,o,a)=>{e.set(IDM4);var r=0,n=0,s=0,i=0,l=0,E=0,S=0,A=0,P=0,L=0,R=t[0],f=t[1],T=t[2],I=a[0],D=a[1],N=a[2],v=o[0],p=o[1],c=o[2];return ABS(R-v)<1e-4&&ABS(f-p)<1e-4&&ABS(T-c)<1e-4||(S=R-v,A=f-p,P=T-c,r=D*(P*=L=1/SQRT(S*S+A*A+P*P))-N*(A*=L),n=N*(S*=L)-I*P,s=I*A-D*S,(L=SQRT(r*r+n*n+s*s))?(r*=L=1/L,n*=L,s*=L):(r=0,n=0,s=0),i=A*s-P*n,l=P*r-S*s,E=S*n-A*r,(L=SQRT(i*i+l*l+E*E))?(i*=L=1/L,l*=L,E*=L):(i=0,l=0,E=0),e[0]=r,e[1]=i,e[2]=S,e[4]=n,e[5]=l,e[6]=A,e[8]=s,e[9]=E,e[10]=P,e[12]=-(r*R+n*f+s*T),e[13]=-(i*R+l*f+E*T),e[14]=-(S*R+A*f+P*T)),e},PERSP=(e,t,o,a,r)=>{var n=1/TAN(t*D2R/2),s=0;return e[0]=n/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(s=1/(a-r),e[10]=(r+a)*s,e[14]=2*r*a*s):(e[10]=-1,e[14]=-2*a),e},ORTHO=(e,t,o,a,r,n,s)=>{var i=1/(t-o),l=1/(a-r),E=1/(n-s);return e[0]=-2*i,e[5]=-2*l,e[10]=2*E,e[12]=(t+o)*i,e[13]=(r+a)*l,e[14]=(s+n)*E,e},TRANS3D=(e,t,o)=>{var a=t[0],r=t[1],n=t[2],s=o[3]*a+o[7]*r+o[11]*n+o[15];return s=s||1,e[0]=(o[0]*a+o[4]*r+o[8]*n+o[12])/s,e[1]=(o[1]*a+o[5]*r+o[9]*n+o[13])/s,e[2]=(o[2]*a+o[6]*r+o[10]*n+o[14])/s,e},MAT4xV3=(e,t,o,a=1)=>{var r=o[0],n=o[1],s=o[2];return e[0]=t[0]*r+t[4]*n+t[8]*s+t[12]*a,e[1]=t[1]*r+t[5]*n+t[9]*s+t[13]*a,e[2]=t[2]*r+t[6]*n+t[10]*s+t[14]*a,e},VIEW_M4=M4(),PROJ_M4=M4(),VP_M4=M4(),MVP_M4=M4(),CAM_EYE=V3(),CAM_CENTER=V3(),CAM_FRONT=V3(),CAM_RIGHT=V3(),CAM_TOP=V3(),CAMERA=(e,t,o,a,r,n=.1,s=1e3,i=0)=>{CAM_EYE.set(e),CAM_CENTER.set(t),SUB(CAM_FRONT,CAM_CENTER,CAM_EYE),NORM(CAM_FRONT,CAM_FRONT),CROSS(CAM_RIGHT,CAM_FRONT,o),NORM(CAM_RIGHT,CAM_RIGHT),LOOKAT(VIEW_M4,e,t,o),i?ORTHO(PROJ_M4,-a*r,a*r,-a,a,n,s):PERSP(PROJ_M4,a,r,n,s),MULTMAT4(VP_M4,PROJ_M4,VIEW_M4),EXTRACTPLANES(VP_M4)},INIT=e=>{gl||(gl=e.getContext("webgl2",{}),_INITGL()),VIEWPORT(0,0,e.width,e.height)},INPUT=e=>{e.oncontextmenu=e=>!1,e.onmousedown=e.onmouseup=e.onmousemove=e=>{e.preventDefault(),MOUSE.delta[0]=e.pageX-MOUSE.pos[0]+e.movementX,MOUSE.delta[1]=e.pageY-MOUSE.pos[1]+e.movementY,MOUSE.pos[0]=e.pageX,MOUSE.pos[1]=e.pageY,MOUSE.buttons=e.buttons,window.ONMOUSE&&ONMOUSE(e)},BODY.onwheel=e=>MOUSE.wheel=e.deltaY},END=()=>{MOUSE.delta.fill(0),KEYSP={},MOUSE.wheel=0,MOUSE.prevb=MOUSE.buttons},VIEWPORT=(e,t,o,a)=>{VP_DATA.set([e,t,o,a]),gl.viewport(e,t,o,a)},SHADER=(e,t=0)=>{var o=gl.createShader(35632+t);if(gl.shaderSource(o,"#version 300 es\nprecision highp float;\n#define IN uniform\n#define S2D sampler2D\n#define NORM normalize\nin vec3 pos;\n"+(t?"":"out vec4 fragColor;\n")+e),gl.compileShader(o),!gl.getShaderParameter(o,gl.COMPILE_STATUS)){throw`Could not compile WebGL program. \n\n${gl.getShaderInfoLog(o)}`}return o},_vs="in vec2 uv;out vec2 _uv;IN float psize;IN mat4 viewp;IN mat4 model;void main(){_uv=uv;gl_Position = viewp*model*vec4(pos,1.0);gl_PointSize=psize;;}",_fs="IN vec4 color;void main(){fragColor=color;;}",_texfs="IN S2D tex;IN vec4 color;void main(){fragColor=color*texture(tex,_uv);;}",quad_vs="out vec2 _uv;void main(){ _uv=pos.xy*0.5+vec2(0.5);gl_Position=vec4(pos,1.0);;}",UNIFUNCS={5124:"1i",5125:"1ui",5126:"1f",35664:"2fv",35665:"3fv",35666:"4fv",35676:"Matrix4fv",35678:"1i"},PROGRAM=(e=_vs,t=_fs,o=[])=>{var a,r,n=o.map((e=>"#define "+e)).join("\n"),s=gl.createProgram(),i=gl.getProgramParameter.bind(gl);for(gl.attachShader(s,SHADER(n+e,1)),gl.attachShader(s,SHADER(n+t)),gl.linkProgram(s),s.unif={},s.attr={},a=0,r=i(s,35718);a<r;++a){var l=(E=gl.getActiveUniform(s,a)).name;l=l.substr(0,l.length-(E.size>1?3:0)),(s.unif[l]=E).loc=gl.getUniformLocation(s,l),E.func=gl["uniform"+UNIFUNCS[E.type]].bind(gl),E.set=35676==E.type?function(e){this.func(this.loc,!1,e)}:function(e){this.func(this.loc,e)}}for(a=0,r=i(s,35721);a<r;++a){var E=gl.getActiveAttrib(s,a);(s.attr[E.name]=E).loc=a}return s.bind=()=>gl.useProgram(s),s.uniforms=e=>{if(s.bind(),e)for(var t in e)s.unif[t]?.set(e[t]);return s},s.set=(e,t)=>s.unif[e]?.set(t),s},BUFFER=(e,t=3,o=35044)=>{var a=gl.createBuffer(),r=34962+(t?0:1);return e.constructor==Array&&(e=t?V3(e):new Uint16Array(e)),a.b=()=>gl.bindBuffer(r,a),a.update=e=>(e&&a.d.set(e),a.b(),gl.bufferData(r,a.d,o),a),a.bind=(e,o=0)=>{a.b(),null!=e&&(gl.vertexAttribPointer(e,t,5126,!1,0,0),gl.enableVertexAttribArray(e),gl.vertexAttribDivisor(e,o))},a.map=function(e){this.update(this.d.map(e))},a.size=e.length,a.num=t,a.d=e,a.b(),gl.bufferData(r,a.d,o),a},MESH=e=>{var t={};for(var o in e)e[o]&&(t[o]=BUFFER(e[o],"tris"==o?0:o.length));return t[0]=t.tris?t.tris.size:t.pos.size/3,t},TEX=(e,t,o=null,a=0)=>{var r,n=gl.createTexture();for(n.w=0|e,n.h=0|t,n.bind=(e=0)=>(gl.activeTexture(33984+e),gl.bindTexture(3553,n),n),n.param=(e,t)=>(n.bind(),gl.texParameteri(3553,10240+e,t),n),n.toVP=(e,t)=>{n.bind(),DRAW(QUAD,e||QUADSHADER,t||{tex:0})},n.mips=()=>{n.bind(),gl.generateMipmap(3553)},(n.update=o=>(n.bind(),gl.texImage2D(3553,0,a?33190:6408,0|e,0|t,0,a?6402:6408,a?5125:5121,o)))(o),r=0;r<4;++r)n.param(r,[9729,33071][r/2|0]);return n},FBO=(e,t)=>{var o=gl.createFramebuffer();o.tex=e;var a=o.w=e.w,r=o.h=e.h;return gl.bindFramebuffer(36160,o),gl.framebufferTexture2D(36009,36064,3553,e,0),o.depth=t||TEX(a,r,null,1),gl.framebufferTexture2D(36009,36096,3553,o.depth,0),o.bind=e=>(gl.bindFramebuffer(36160,e?o:null),VIEWPORT(0,0,e?a:C.width,e?r:C.height),o),o.bind(0),o},GLSET=(e,t=1)=>t?gl.enable(e):gl.disable(e),CLEAR=(e,t)=>{e&&gl.clearColor(e[0],e[1],e[2],e[3]),gl.clear((e?16384:0)|(t?256:0))},CULL=2884,ZTEST=2929,BLEND=3042,NEAREST=9728,LINEAR=9729,blendf={A:[770,771],B:[770,1]},BLENDFUNC=e=>{var t=blendf[e];gl.blendFunc(t[0],t[1]),GLSET(BLEND,1)},DEPTHW=(e=1)=>gl.depthMask(e),PLANE=(e=1)=>MESH({pos:[-e,0,-e,e,0,e,e,0,-e,e,0,e,-e,0,-e,-e,0,e],uv:[0,0,1,1,1,0,1,1,0,0,0,1]}),PLANEG={pos:[-1,-1,0,1,-1,0,1,1,0,-1,1,0],tris:[0,1,2,0,2,3]},QUAD=0,QUADSHADER=0,FLATSHADER=0,meshes={},DRAW=(e,t,o,a=4,r=1,n=0)=>{if(e&&e.length&&(e=meshes[e]),e&&e[0]){for(var s in(t=t||FLATSHADER).bind(),t.unif.viewp?.set(VP_M4),t.unif.ceye?.set(CAM_EYE),t.unif.cfront?.set(CAM_FRONT),t.uniforms(o),e)e[s].bind&&e[s].bind(t.attr[s]?.loc);if(n)for(var s in n)n[s].bind(t.attr[s].loc,1);e.tris?gl.drawElementsInstanced(a,e[0],5123,0,r):gl.drawArraysInstanced(a,0,e[0],r)}},EXTRACTPLANES=e=>{FPLANES=[];for(var t=0;t<6;++t){var o=t%2?1:-1,a=t>>1,r=V3([e[3]+o*e[a],e[7]+o*e[4+a],e[11]+o*e[8+a],e[15]+o*e[12+a]]),n=LEN(r);n||(n=1e-4);for(a=0;a<4;++a)r[a]/=n;FPLANES.push(r)}},PLANEOVERLAP=(e,t,o)=>{var a=ABS(o[0]*e[0])+ABS(o[1]*e[1])+ABS(o[2]*e[2]),r=DOT(e,t)+e[3];return r<=-a?0:r<=a?1:2},CAMTESTBOX=(e,t)=>{for(var o,a=0,r=0;r<6;++r){if(!(o=PLANEOVERLAP(FPLANES[r],e,t)))return 0;a+=2==o?1:0}return a?1:2};var ox,oy,oz,vs=`\nIN mat4 model;\nIN mat4 viewp;\nIN vec3 ceye;\nIN float time;\nIN vec4 color;\n#ifdef INST\nIN float scale;\nin vec4 offs;\n#endif\nout vec3 wpos;\nout vec4 vcol;\nvec3 ROTY(vec3 v,float a){vec2 t=vec2(sin(a),cos(a));return vec3(t.y*v.x-t.x*v.z,v.y,t.x*v.x+t.y*v.z);}\nfloat PI=${PI};\nvoid main(){\nwpos=pos;\nvcol=color;\nfloat id=float(gl_InstanceID);\n#ifdef INST\nwpos=ROTY(wpos,id);\nwpos*=offs.w*scale;\nwpos+=offs.xyz;\nvcol.xyz+=vec3(sin(wpos.y*0.2+wpos.z*0.3+wpos.x*0.1+cos(wpos.x*0.1)*0.5))*0.1;\n#endif\nwpos=(model*vec4(wpos,1.0)).xyz;\ngl_PointSize=(sin(float(gl_VertexID))*0.5+1.2);\ngl_Position=viewp*vec4(wpos,1.0);\n}\n`,fs="\nin vec3 wpos;\nin vec4 vcol;\nIN vec3 ceye;\nIN vec3 cfront;\nIN float spot;\nIN vec3 target;\nIN vec3 flare;\nvec3 scolor=vec3(.04,.06,.07);\nvec3 fcolor=vec3(.2,.5,.8);\nIN float time;\nIN float mat;\nIN vec4 emis;\nvoid main(){\nvec3 L=vec3(0,1,0);\nvec3 E=wpos-ceye;\nfloat dist = length(E);\nE/=dist;\n#ifdef POINTS\nvec3 N=-E;\n#else\nvec3 N=NORM(cross(dFdx(wpos),dFdy(wpos)));\n#endif\nvec4 C=vcol;\n#ifndef POINTS\nvec3 light = fcolor*max(0.0,(wpos.y-44.0)/20.0) * max(0.0,0.5 + 0.5 * (N.y+1.0)/2.0);//sky\nfloat fog = pow(clamp(dist/150.0,0.0,1.0),0.3);\nfloat spotatt = max(0.0,1.0 - clamp(dist/40.0,0.0,2.0));\nvec3 F=(cfront+vec3(0.0,-0.1,0.0));\nlight += vec3(0.6,0.7,0.8)*(dot(N,-F)*0.25+0.75)*smoothstep(0.92,0.99,max(0.0,dot(F,E)))*spotatt*spot;\nC.xyz=mix(C.xyz*light,scolor,fog);\nC.xyz+=vec3(0.2,0.5,0.3)*pow(clamp(1.0 - length(target-wpos)/15.0,0.0,1.0),2.5);\nC.xyz+=vec3(1.2,0.3,0.1)*pow(clamp(1.0 - length(flare-wpos)/5.0,0.0,1.0),2.5);\n#else\nC.a /= dist*1.2;\n#endif\nfragColor=C+emis;\n}\n",fx_fs="in vec2 _uv;IN S2D tex;IN S2D texB;IN float R;vec2 barrel(vec2 uv,float v){vec2 st=uv-0.5;float t=atan(st.x,st.y);float r=sqrt(dot(st,st));r*=1.0+v*(r*r);return 0.5+r*vec2(sin(t),cos(t));}\nvoid main(){\n    vec2 uv=_uv+(texture(texB,_uv).xy-vec2(0.5))*0.04;\n    float l=length(_uv-vec2(0.5));\n    if(l>R)discard;\n    if(l>R*0.98)fragColor=vec4(0.1);\n    else{\n    float vig=pow(1.0-l/0.45,0.5);\n    fragColor=vig*(texture(tex,barrel(uv,-1.2),2.0)*0.5+texture(tex,barrel(uv,-1.2),4.0)*0.5+texture(tex,barrel(uv,-1.2))*1.5);;}\n    }\n",final_fs="in vec2 _uv;IN S2D tex;IN float D;IN float V;IN float time;\nvoid main(){\n    float l=_uv.y+0.1*round(10.0*sin(_uv.x+time)*cos(_uv.x*0.3+time*1.2))*0.1;\n    vec4 C=texture(tex,_uv+vec2(0.0,l<D?sin(time*2.0)*0.01:0.0),l<D?3.0:0.0);\n    if(l<D){C.xy*=0.8;C.xyz+=vec3(l-D)*0.2;}\n    fragColor=C*V;;}\n",DEBUG=0,j=(i=0,0),k=0;ARP.p=ARP.push,SIM=(e,t,o)=>{l=e.length/3;for(var a=0,r=t.length;a<r;a+=3)t.p(t[a]+l,t[a+2]+l,t[a+1]+l);e.p(...e.map(((e,t)=>e*o[t%3])))},FETCH=(e,t)=>fetch(e).then((e=>e.arrayBuffer())).then(t),LOAD=(e,t,o,a,r)=>FETCH(e+".xbin",(o=>{for(var a,r=new Int8Array(o),n=new UINT8(o),s=[],i=n[0],l=1;l<=3*i;l+=3)s.p(r[l]/127,n[l+2]/255-.5,r[l+1]/127);a=Array.from(n.subarray(3*i+2)),t&&SIM(s,a,[-1,1,1]);meshes[e]=MESH({pos:s,tris:a})}));var fbo,fboView,fboSonar,fcolor=[.2,.5,.8,1],scolor=[.04,.06,.07,1],NOW=0,PREV=0,GTIME=0,V4=[0,0,0,0],INTRO=1;INPUT(C),INIT(C),sh=PROGRAM(vs,fs).uniforms({emis:V4}),sh_inst=PROGRAM(vs,fs,["INST"]),sh_points=PROGRAM(vs,fs,["POINTS"]),sh_sonar=PROGRAM("IN float time;IN vec3 ceye;IN mat4 viewp;IN mat4 model;out vec2 dist;void main(){vec4 p=model*vec4(pos,1.0);gl_Position=viewp*p;dist=vec2(length(p.xyz-ceye),sin(float(gl_VertexID)+time*10.0)*0.5+0.5);gl_PointSize=3.0;;}","in vec2 dist;IN vec4 color;void main(){fragColor=color*dist.y;;}"),sh_fx=PROGRAM(quad_vs,fx_fs),sh_final=PROGRAM(quad_vs,final_fs),meshes.plane=PLANE(),LOAD("head",1),NSIN=e=>SIN(2*e*PI);var SEED=30;HASH3D=(e,t,o)=>(e=50*FRACT(.3183099*e+.71),t=50*FRACT(.3183099*t+.113),o=50*FRACT(.3183099*o-.247),2*FRACT(1.375986*SEED+e*t*o*(e+t+o))-1),NOISE3D=(e,t,o)=>{let a=FLOOR(e),r=FLOOR(t),n=FLOOR(o),s=FRACT(e),i=FRACT(t),l=FRACT(o),E=s*s*(3-2*s);return LERP(LERP(LERP(HASH3D(a,r,n),HASH3D(a+1,r,n),E),LERP(HASH3D(a,r+1,n),HASH3D(a+1,r+1,n),E),i*i*(3-2*i)),LERP(LERP(HASH3D(a,r,n+1),HASH3D(a+1,r,n+1),E),LERP(HASH3D(a,r+1,n+1),HASH3D(a+1,r+1,n+1),E),i*i*(3-2*i)),l*l*(3-2*l))};var WSIZE=512,BSIZE=64,HSIZE=BSIZE+20,MAPDOTS=[],WORLD=0,BLOCKS=[];GENWORLD=()=>{GEN=(e,t,o)=>!t||!e||!o||e==WSIZE-1||o==WSIZE-1||NOISE3D(.1*e,.1*t-20,.1*o)+ABS(.005*(e-WSIZE/2))-1.3*SAT(1-LEN([224,4,348])/30)>0?1:0,WORLD=new UINT8(WSIZE*WSIZE*HSIZE);var e=new UINT8(WORLD);for(GETW=(e,t,o)=>t>=HSIZE?0:WORLD[(0|e)+(0|t)*WSIZE+WSIZE*HSIZE*(0|o)],SETW=(e,t,o,a)=>WORLD[e+t*WSIZE+o*(WSIZE*HSIZE)]=a,SETW2=(t,o,a,r)=>e[t+o*WSIZE+a*(WSIZE*HSIZE)]=r,x=0;x<WSIZE;x++)for(z=0;z<WSIZE;z++){let e=5*(NOISE3D(.02*x,0,.03*z)+1);for(y=0;y<HSIZE-e;y++)SETW(x,y,z,GEN(x,y,z))&&RAND()<.3&&MAPDOTS.push(x,y,z)}new UINT8(WORLD.length);for(e.set(WORLD),x=1;x<WSIZE-1;x++)for(y=1;y<HSIZE-1;y++)for(z=1;z<WSIZE-1;z++)GETW(x,y,z)&&GETW(x-1,y,z)&&GETW(x+1,y,z)&&GETW(x,y-1,z)&&GETW(x,y+1,z)&&GETW(x,y,z-1)&&GETW(x,y,z+1)&&SETW2(x,y,z,2);for(WORLD.set(e),CREATEBLOCK=(e,t)=>{var o=new F32(BSIZE*BSIZE*HSIZE*4),a=0;for(x=0;x<BSIZE;x++)for(y=0;y<HSIZE;y++)for(z=0;z<BSIZE;z++)1==GETW(x+e,y,z+t)&&(o.set([x+e+RAND(0),y+RAND(0,-1),z+t+RAND(0),2.2+RAND()],4*a),a++);BLOCKS.push({num:a,pos:[e+BSIZE/2,HSIZE/2,t+BSIZE/2],insts:BUFFER(o.subarray(0,4*a),4)})},GSIZE=WSIZE/BSIZE,i=0;i<GSIZE*GSIZE;i++)CREATEBLOCK(i%GSIZE*BSIZE,FLOOR(i/GSIZE)*BSIZE);MAPDOTS=BUFFER(MAPDOTS,3)},PBUFFER=BUFFER(new F32(768),3),PBUFFER.map((()=>RAND(8))),DBUFFER=BUFFER(new F32(30720),3,35048);var DMG=[],ADDPART=e=>DMG.length<10240?DMG.push({p:e,v:SUB(V3(),[RAND(.2,.4),RAND(-.2),0],e),t:3}):0,WPs=[[228,19,364],[247,29,371],[239,37,385],[245,39,398],[258,50,400],[271,61,399],[260,69,381],[261,84,357],[272,93,421],[290,73,391],[297,60,376],[288,51,369],[288,40,369],[277,40,361],[264,48,360],[240,50,359],[232,41,360],[237,32,360],[234,20,362]],start=[WSIZE/2,1.5*HSIZE,WSIZE/4],targets=[[182,20,329],[298,22,271]],flares=[[255,82,319],[219,81,218]],TRG=V3(),FLR=V3(),TRGdist=1e3,sonarbeep=0,out=0,WPBUFFER=BUFFER(WPs.flat(),3),HMODEL=M4(),AMODEL=M4(),UItex=0,totarget=V3(),PLY=0,level=0,isInside=0,signal=.1,alarm1=0,alarm2=0,spark=0,nrg=0,batt=0,shake=0,boom=0,gear=0,SNK={pos:V3(WPs[0]),index:0,ang:0,call:4,dist:1e4,tail:0};for(SNK.tail=BUFFER(new F32(200),4),SNK.part=e=>SNK.tail.d.subarray(4*e,4*e+3),i=1;i<50;++i)SNK.tail.d.set([SNK.pos[0]+i,SNK.pos[1],SNK.pos[2]+5,LERP(1.5,.2,i/50)],4*i);SNK.tail.update(),NEWCANVAS=()=>document.createElement("canvas").getContext("2d");let UIctx=NEWCANVAS(),GLASSctx=NEWCANVAS(),GLASS=0;GLASSctx.canvas.width=GLASSctx.canvas.height=512,GLASS=TEX(512,512,GLASSctx.canvas);var ACX,ADEST,AVOL,asea,abeep,asnk,asonar,ashake,aalarm,INRANGE=(e,t,o)=>e>=t&&e<o;let gradient;BREAKGLASS=e=>{let t=GLASSctx;if(e)GLASSctx.fillStyle="#777",GLASSctx.fillRect(0,0,512,512);else{for(t.save(),t.globalCompositeOperation="difference",t.strokeStyle="#111",t.fillStyle="#"+(0|RAND(16)).toString(16)+(0|RAND(16)).toString(16)+"0",t.beginPath(),t.moveTo(RAND(1e3,-100),RAND(1e3,-100)),i=0;i<5;++i)t.lineTo(RAND(512),RAND(512));t.fill(),t.stroke(),t.restore()}GLASS.update(GLASSctx.canvas),GLASS.mips()},BREAKGLASS(1),RESET=()=>{PLY={pos:V3(start),ang:0,nrg:1,spot:2,sonar:100,scan:1,hasTRG:0,cooldown:0,vel:V3(),dmg:.1,open:0,life:1.1,batt:1,speed:[0,0,0]},P=PLY.pos,TRG=V3(targets[level]),FLR=V3(flares[level]),DIV.style.fontSize="",GTIME=0,BREAKGLASS(1)},RESET(),CHANNEL=(e,t)=>{var o=ACX.createOscillator(),a=ACX.createBufferSource(),r=ACX.createBiquadFilter(),n=ACX.createGain();o.frequency.value=0,a.buffer=BUF,a.loop=!0,r.frequency.value=1e4,n.gain.value=0,o.connect(n),a.connect(r),r.connect(n),n.connect(AVOL);var s={osc:o,noise:a,filter:r,gain:n,volume:e=>n.gain.linearRampToValueAtTime(SAT(e),ACX.currentTime+.1),freq:e=>o.frequency.value=e};return e&&o.start(),t&&a.start(),s},STARTAUDIO=()=>{ACX=new AudioContext,ADEST=ACX.destination,(AVOL=ACX.createGain()).gain.value=.5,AVOL.connect(ADEST);var e=2*ACX.sampleRate;BUF=ACX.createBuffer(1,e,ACX.sampleRate),data=BUF.getChannelData(0);for(var t=0;t<e;t++)data[t]=2*RANDOM()-1;asea=CHANNEL(0,1),abeep=CHANNEL(1),asnk=CHANNEL(1),asonar=CHANNEL(0,1),ashake=CHANNEL(1),aalarm=CHANNEL(1),asea.filter.Q.value=15};var eye=V3(),target=V3(),front=V3(),IMP=V3();CAM_EYE.set([180,5,-250]),loop=()=>{requestAnimationFrame(loop),WORLD||GENWORLD(),NOW=TIME();var e=MIN(.1,NOW-PREV);PREV=NOW;var t=C.width=BODY.offsetWidth,o=C.height=BODY.offsetHeight,a=t>>2,r=o>>2;fbo&&fbo.h==r&&fbo.w==a||(fbo=FBO(TEX(a,r).param(0,NEAREST).param(1,9984))),fboView&&fboView.h==r||(fboView=FBO(TEX(r,r).param(0,NEAREST).param(1,9987))),(!fboSonar||fboSonar.tex.h!=r|0)&&(fboSonar=FBO(TEX(r,r).param(0,NEAREST))),GTIME+=e,sonarbeep=RAND()<.03+.5*SAT(1-TRGdist/100)?1:0,out=P[1]>2*HSIZE?1:0;let n="Explore the depths, find the origin of the signal. Dive near the flare.";if(INTRO?n="JS13K 2024":GTIME<10?n="Use WSAD to move, QE for elevation, F/1/2 to toggle displays":PLY.won?n="Mission Accomplished, Time: "+(0|PLY.time)+"s":PLY.life<=0?n="You drowned, press SPACE to restart":PLY.open>0?n="FIX LEAK, press G multiple times!!":!PLY.hasTRG&&TRGdist<10?n="Grab the strange object!":PLY.hasTRG&&(n="Carry it to the surface!"),DIV.innerText=n,ACX){asea.filter.frequency.value=(PLY.open>0?400:0)+out?1600:100+P[1]+ABS(PLY.speed[2]),asea.volume(out?.3*SIN(GTIME)+.4:.9);let e=FRACT(GTIME/SNK.call+.1*RAND());asnk.volume(1-e-SAT(SNK.dist/50)),asnk.freq(120-50*POW(e,.15)+0*e*SIN(10*GTIME*e)),abeep.volume(PLY.scan*signal/2),abeep.freq(440*sonarbeep),e=FRACT(GTIME/2),asonar.volume(PLY.sonar?.1*POW(1-e,2):0),asonar.filter.frequency.value=800-200*e,asonar.filter.Q.value=30+5*RAND(),ashake.volume(SAT(10*(shake+boom))),ashake.freq(RAND(140,50)),aalarm.freq(800+RAND(50)),aalarm.volume(.4*MAX(alarm1,alarm2))}let s,E=UIctx,S=E.canvas,A=r/7;if(E.imageSmoothingEnabled=!1,S.width=a,S.height=r,E.textAlign="center",E.font=(.2*A|0)+"px monospace",E.translate(0,r),E.scale(1,-1),FCOLOR=e=>E.strokeStyle=E.fillStyle=e,RECT=(e,t,o,a,r)=>{FCOLOR(r),E.fillRect(e,t,o,a)},CIRCLE=(e,t,o,a)=>{a&&FCOLOR(a),E.beginPath(),E.arc(e,t,o,0,2*PI),E.fill()},DIAL=(e,t,o,a,r,n,s=5,i=0)=>{CIRCLE(t,o,a+2,"#333"),CIRCLE(t,o,a,"#000"),E.save(),E.translate(t,o),FCOLOR("#4A6"),E.fillText(e||"",0,a/1.5),E.rotate(PI/2-(2==i?2*n*PI-PI/2:.95)),E.save(),FCOLOR("#620"),1==i&&(E.beginPath(),E.moveTo(0,0),E.arc(0,0,.9*a,0,.3),E.fill(),CIRCLE(0,0,.35*a,"#000")),FCOLOR("#0A4");for(let e=0;e<r+1;++e)E.fillRect(-1,.8*a,e%s?.5:2,4),e%s==0&&3!=i&&E.fillText(2==i?"ENESW"[e/s]:e,0,.7*a),E.rotate(2*PI*(2==i?1:.8)/r);E.restore(),E.rotate(2*SAT(n)*PI*(2==i?1:.8)),FCOLOR("#4C8"),E.fillRect(-1,0,2,.9*a),CIRCLE(0,0,.05*a),E.restore()},RECT(0,0,a,r,PLY.batt<=0||INTRO?"#000":"#111"),INTRO)E.fillStyle="#1F4",E.save(),E.scale(1,1.3),E.font=(2*A|0)+"px Arial Black",E.globalCompositeOperation="destination-out",E.fillText("DEEP13",a/2,r/2),E.font=(A/2.5|0)+"px Arial Black",E.globalAlpha=SAT(GTIME-4),E.fillText("by Tamat",a/2+3*A,r/1.75),E.restore(),E.globalAlpha=SAT(GTIME-5),E.fillText("click to start",a/2,r/1.25),E.globalAlpha=1;else{for(FCOLOR("#ccc"),E.fillText("by TAMAT",a-20,r-4),E.save(),E.translate(a/2-r/1.5,0),i=0;i<4;++i)RECT(r*-[.12,.06,.04,.02][i],0,.2*r/(i+1),r,["#000","#222","#333","#444"][i]);DIAL("BATT",0,r-1.1*A,A,30,batt),CIRCLE(0,r-.25*A,.1*A,alarm2?"red":"#000");let e=1-SAT(P[1]/170);for(DIAL("ATM",0,A+10,A,14,e+RAND(.2*SAT(e-.8)),1,1),CIRCLE(0,1.8*A+10,.1*A,alarm1?"red":"#000"),gear=LERP(PLY.open,gear,.99),E.translate(0,r/2),CIRCLE(0,0,8,"#111"),E.rotate(10*gear),j=0;j<3;++j){for(E.lineWidth=3-j,E.strokeStyle=["#210","#371911","#520"][j],E.beginPath(),i=0;i<8;++i)E.rotate(2*PI/8),E.moveTo(0,0),E.lineTo(-8.5,19),E.lineTo(7,20);E.stroke()}if(CIRCLE(0,0,3,"#111"),E.restore(),s=PLY.ang/(2*PI)%1,DIAL(0,a/2+r/1.3-A,r/1.8,.75*A,8,1-(s+(s<0?1:0)),2,2),DIAL("TANK",a/2-r/2.25,.1*r,.5*A,2,PLY.speed[1]/32+.5,.5,3),nrg=LERP(PLY.nrg/20,nrg,.99),DIAL("KWh",a/2-r/2.32,.9*r,.5*A,15,nrg+.02*SIN(GTIME),15,3),DIAL("AIR",a/2-r/1.8,.65*r,.4*A,15,PLY.life,15,3),E.save(),E.translate(a/2+r/1.7,r-1.1*A),CIRCLE(0,0,A+2,"#222"),CIRCLE(0,0,A,"#000"),PLY.scan){for(E.strokeStyle="#0F0",E.beginPath(),E.moveTo(0,0),i=0;i<1.5*A;++i)E.lineTo(i-.75*A,(RAND(4,-2)+sonarbeep*signal*RAND(A,-A/2)+spark*RAND(30,-15))*NSIN(i/A*.34));E.stroke(),E.restore()}}for(UItex&&UItex.w==a&&UItex.h==r?UItex.update(S):UItex=TEX(a,r,S),UItex.param(0,9728),INIT(C),fboView.bind(1),CLEAR(scolor,1),front[0]=SIN(PLY.ang),front[2]=COS(PLY.ang),INTRO&&(front[1]=-.2),ADD(eye,P,[.1*SIN(GTIME),RAND(.1)*isInside-(INTRO?MIN(1.5*GTIME,HSIZE/2):0),.1*COS(.97*GTIME)]),ADD(target,eye,front),i=0;i<3;++i)target[i]+=RAND(shake);for(b of(CAMERA(eye,target,UP,80,INTRO?t/o:1,.1,150),GLSET(ZTEST),GLSET(CULL,0),GLSET(BLEND,0),DRAW("plane",sh,{emis:V4,spot:0,target:[0,-1e3,0],color:[0,0,0,1],model:TRS(HMODEL,[eye[0],2*HSIZE,eye[2]],0,1e3)}),GLSET(CULL,1),BLOCKS))CAMTESTBOX(b.pos,[BSIZE,HSIZE,BSIZE])&&DRAW("head",sh_inst,{color:[.5,.6,.7,.1],target:TRG,flare:FLR,scale:1,emis:V4,spot:PLY.spot,model:AMODEL},4,b.num,{offs:b.insts});for(PLY.hasTRG&&ADD(TRG,eye,[front[0],front[1]-.7,front[2]],.75),DRAW("head",sh,{color:[.1,.1,.1,1],emis:[.2,.5,.3,0],spot:2*PLY.spot,model:TRS(HMODEL,TRG,0,1)}),DRAW("head",sh,{color:[.1,.1,.1,1],emis:[RAND(),RAND(.3),0,0],model:TRS(HMODEL,FLR,0,.2)}),BLENDFUNC("A"),i=0;i<4;++i)DRAW("head",sh_inst,{color:[.1,.1,.1,.2],scale:.5+i/4,emis:!i&&spark?[0,1,3,0]:[-.02,-.02,-.02,0],spot:2*PLY.spot,model:AMODEL},5,50,{offs:SNK.tail});if(!out)for(i=-2;i<=2;++i)for(j=-1;j<=1;++j)for(k=-2;k<=2;++k)DRAW({pos:PBUFFER,0:256},sh_points,{color:[.7,.8,.9,.3],emis:V4,model:TRS(HMODEL,[8*ROUND(P[0]/8+i),8*ROUND(P[1]/8+j),8*ROUND(P[2]/8+k)],0,1)},0);if(DEBUG&&WPs.length&&DRAW({pos:WPBUFFER,0:WPs.length},0,{color:[1,1,1,1],model:AMODEL},3),sh.uniforms({time:GTIME}),GLSET(ZTEST,0),GLSET(BLEND,0),fboView.bind(0),fboView.tex.mips(),fboSonar.bind(1),CLEAR(V4),ADD(target,P,[-front[2],front[1],front[0]],PLY.sonar),CAMERA(target,P,UP,60,1,PLY.sonar-3,PLY.sonar+3),GLSET(ZTEST,0),BLENDFUNC("B"),PLY.sonar&&(DRAW({pos:MAPDOTS,0:MAPDOTS.d.length/3},sh_sonar,{model:AMODEL,time:GTIME,ceye:P,color:[.02,1,.07,.4],model:AMODEL},0),DRAW("head",sh,{color:[0,0,0,1],emis:[0,1,.1,0],spot:0,model:TRS(HMODEL,ADD(V3(),P,[0,-1,0]),[0,PLY.ang],[8,4,8])},4),DRAW("head",sh_inst,{color:[.1,.1,.1,.5],scale:2,emis:[1,.3,0,0],spot:0,model:AMODEL},5,18,{offs:SNK.tail}),DRAW("head",sh,{emis:[.1,.5,1,0],model:TRS(HMODEL,TRG,0,2)})),GLSET(CULL,0),fboSonar.bind(0),fboSonar.tex.mips(),fbo.bind(1),GLSET(BLEND,1),BLENDFUNC("A"),UItex.toVP(),GLSET(BLEND,0),VIEWPORT(a/2-r/2,0,r,r),GLASS.bind(1),fboView.tex.toVP(sh_fx,{R:.5,texB:1}),VIEWPORT(a/2+r/2.3,r/1.8,r/2.2,r/2.2),fboSonar.tex.toVP(sh_fx,{R:.5}),DMG.length&&(VIEWPORT(0,0,a,r),DBUFFER.update(DMG.map((t=>(t.t-=e,t.v[1]-=.5*e,ADD(t.p,t.p,t.v,.5*e),t.p))).flat()),DMG=DMG.filter((e=>e.t>0&&e.p[1]>PLY.dmg-.55-RAND(.2))),CAMERA([0,0,1],[0,0,0],UP,45,1,0,10),BLENDFUNC("A"),DRAW({pos:DBUFFER,0:DMG.length},0,{color:[.5,.55,.6,.2],psize:5,model:AMODEL},0)),PLY.open>0)for(PLY.dmg+=.01*e,i=0,l=RAND(10,10)*PLY.open;i<l;++i)ADDPART([-.3+RAND(.01),RAND(.01)+.4,0]);if(fbo.bind(0),fbo.tex.mips(),GLSET(BLEND,0),VIEWPORT(0,0,t,o),INTRO?(GLSET(BLEND,0),fboView.tex.toVP(sh_final,{time:GTIME,D:-5,V:MIN(.2*GTIME,1)}),GLSET(BLEND,1),BLENDFUNC("A"),UItex.toVP()):fbo.tex.toVP(sh_final,{time:GTIME,D:1.5*PLY.dmg-.3,V:MIN(GTIME/2,PLY.life>.2?1:MAX(0,5*PLY.life))}),prevpos=V3(P),DEBUG?(KEYS.W&&ADD(P,P,front,50.5*e),KEYS.S&&ADD(P,P,front,50.5*-e),KEYS.E&&(PLY.pos[1]+=20.5*e),KEYS.Q&&(PLY.pos[1]-=20.5*e),KEYS.A&&(PLY.ang+=.75*e),KEYS.D&&(PLY.ang-=.75*e),KEYSP.F&&(PLY.spot=PLY.spot?0:2),KEYSP.Space&&(WPs.push([0|P[0],0|P[1],0|P[2]]),WPBUFFER=BUFFER(WPs.flat(),3)),KEYSP.Backspace&&(WPs.pop(),WPBUFFER=BUFFER(WPs.flat(),3)),KEYSP.P&&P.set(TRG)):!PLY.won&&PLY.life>0&&PLY.batt>0&&!INTRO&&(KEYS.W&&(PLY.speed[2]+=25*e),KEYS.S&&(PLY.speed[2]-=25*e),KEYS.E&&(PLY.speed[1]+=10.5*e),KEYS.Q&&(PLY.speed[1]-=10.5*e),KEYS.A&&(PLY.speed[0]+=1.5*e),KEYS.D&&(PLY.speed[0]-=1.5*e),KEYSP.F&&(PLY.spot=PLY.spot?0:2),KEYSP.G&&PLY.open>0&&(PLY.open-=.05),KEYSP.R&&PLY.hasTRG&&(PLY.hasTRG=0,ADD(TRG,P,front,2.5)),KEYSP.Digit1&&(PLY.sonar=PLY.sonar?50==PLY.sonar?100:0:50),KEYSP.Digit2&&(PLY.scan=PLY.scan?0:1),KEYS.Space&&SCALE(PLY.speed,PLY.speed,.99)),KEYSP.Space&&(PLY.life<=0||PLY.won)&&(PLY.won&&(level=1),RESET()),PLY.ang+=e*PLY.speed[0]*.2,ADD(P,P,PLY.vel,e),SCALE(IMP,front,PLY.speed[2]),ADD(IMP,IMP,UP,PLY.speed[1]-10*PLY.dmg),ADD(PLY.vel,PLY.vel,IMP,e),SCALE(PLY.vel,PLY.vel,.95),PLY.speed[0]*=.99,PLY.speed[2]*=.99,PLY.speed[1]=CLAMP(PLY.speed[1],-16,16),PLY.batt-=e*(PLY.nrg=4+PLY.sonar/50+2*PLY.spot+PLY.speed[2]/10+2*PLY.scan)*2e-4,PLY.batt<=0&&(PLY.life-=.02*e,PLY.spot=0,PLY.scan=0,PLY.sonar=0,PLY.nrg=0),PLY.dmg>=.9&&(PLY.life-=.1*e),P[1]<10&&RAND()<.001&&(PLY.open=1),P[1]<8&&RAND()<.005&&(BREAKGLASS(),boom=1),alarm1=ROUND(FRACT(1.5*GTIME))*(P[1]<11?1:0)*(PLY.batt>0?1:0),alarm2=ROUND(FRACT(1.5*GTIME))*(PLY.batt<=.2?1:0)*(PLY.batt>0?1:0),isInside=0,INRANGE(P[0],0,WSIZE)&&INRANGE(P[1],0,HSIZE)&&INRANGE(P[2],0,WSIZE)&&(isInside|=GETW(P[0],P[1],P[2])),isInside&&!DEBUG){let e=LEN(PLY.vel);P.set(prevpos),PLY.speed[2]=0,PLY.cooldown<=0&&(SCALE(PLY.vel,PLY.vel,-.5),RAND()<.1&&(PLY.open=1),shake+=.01*e,e>2&&BREAKGLASS()),PLY.cooldown=2}for(i=0;i<3;++i)P[i]=CLAMP(P[i],[5,1,5][i],[WSIZE-5,2*HSIZE+2,WSIZE-5][i]);SUB(totarget,TRG,P),totarget[1]=0,NORM(totarget,totarget),PLY.hasTRG=(TRGdist=DIST(TRG,P))<1.2,signal=SAT(1-.001*DIST(P,TRG))*POW(SAT(DOT(front,totarget)),4),SNK.dist=MIN(DIST(P,SNK.pos),DIST(P,SNK.part(10)),DIST(P,SNK.part(25)));let L=SNK.tail.d,R=SNK.pos,f=WPs[SNK.index];f||(WPs.reverse(),f=WPs[0],SNK.index=0),spark=RAND()<.008;let T=DIST(L,f);for(SUB(totarget,f,R),NORM(totarget,totarget),ADD(R,R,totarget,4*e),DIST(R,f)<2&&(SNK.index+=1),SNK.part(0).set(R),i=1;i<50;++i)R=ADD(V3(),SNK.part(i-1),[SIN(3*GTIME+i/5)/2,0,0],(i+1)/550),f=SNK.part(i),T=DIST(R,f),mind=(L[4*i-1]+L[4*i+3])/4,SUB(totarget,R,f),ADD(f,f,totarget,(T-mind)/T),L.set(f,4*i);SNK.tail.update(),SNK.dist<10&&spark&&(PLY.batt-=2*e,shake+=.1),batt=LERP(batt,PLY.batt,.01),shake*=.95,boom*=.8,PLY.cooldown>0&&(PLY.cooldown-=e),!PLY.won&&P[1]>=170&&PLY.hasTRG&&(PLY.won=1,PLY.time=GTIME,DIV.style.fontSize=120),END(),MOUSE.buttons&&!ACX&&(INTRO=0,GTIME=0,STARTAUDIO())},requestAnimationFrame(loop)</script>
