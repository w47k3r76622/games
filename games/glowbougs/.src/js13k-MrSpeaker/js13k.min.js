function makeSheet(t,i,e){return{w:i,h:e,cellW:Math.ceil(t.width/i),cellH:Math.ceil(t.height/e),render:function(s,h,n,a,r){s.drawImage(t,h*i,n*e,i,e,a,r,i,e)}}}var utils={snap:function(t,i){return Math.floor(t/i)*i},checkCollision:function(t,i,e){var s,h,n,a,r=t,e=e||"hit",o=i.length;for(s=0;o>s;s++)h=i[s],n=r.x+(r.xbb||0),a=h.x+(h.xbb||0),r!==h&&n+r.w>=a&&n<=a+h.w&&r.y+r.h>=h.y&&r.y<=h.y+h.h&&(r[e]&&r[e](h),h[e]&&h[e](r))},checkCollisions:function(t,i){var e,s,h,n,i=i||"hit",a=t.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]),r=a.length;for(e=0;r-1>e;e++)for(h=a[e],s=e+1;r>s;s++)n=a[s],h!==n&&h.x+h.w>=n.x&&h.x<=n.x+n.w&&h.y+h.h>=n.y&&h.y<=n.y+n.h&&(h[i]&&h[i](n),n[i]&&n[i](h))},createCanvas:function(t,i,e){var s=document.createElement("canvas"),h=s.getContext("2d");return h.imageSmoothingEnabled=!1,h.mozImageSmoothingEnabled=!1,h.webkitImageSmoothingEnabled=!1,h.w=t,h.h=i,s.setAttribute("height",i),s.setAttribute("width",t),e&&s.setAttribute("id",e),h},dist:function(t,i){var e=t[0]-i[0],s=t[1]-i[1];return Math.sqrt(e*e+s*s)},angleBetween:function(t,i){var e=t.x-i.x,s=t.y-i.y,h=Math.atan2(s,e);return h%Math.PI}};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;var COLOR={back_main:"#4b5d70",font_main:"#ffffff",tile:{dirt:"0x6b4d35",grass:"0x6aaa40",stone:"0x8f8c8d",water_splash:"0xffffff",water:"0x2781e8",lava_lines:"0xe12900",lava:"0xfe9b00",vine_leaves:"0x23b908",vine_ladder:"0xdea207"}};!function(){function t(t,i,e,s,h,n,a,r){t.gain.cancelScheduledValues(0),t.gain.setValueAtTime(0,i),t.gain.linearRampToValueAtTime(e,i+h),t.gain.linearRampToValueAtTime(e*a,i+h+n),t.gain.setValueAtTime(e*a,i+h+n+s),t.gain.linearRampToValueAtTime(0,i+h+n+s+r)}function e(){var t,e=s.createBuffer(1,.5*s.sampleRate,s.sampleRate),h=e.getChannelData(0);for(i=0;i<h.length;i++)h[i]=(2*Math.random()-1)/2;return t=s.createBufferSource(),t.buffer=e,t.loop=!0,t}var s;window.audio={jumpedat:Date.now(),sfx:{jump:function(){if(s&&!(Date.now()-audio.jumpedat<100)){audio.jumpedat=Date.now();var t=s.currentTime,i=s.createOscillator(),e=s.createBiquadFilter(),h=audio.createGain();i.connect(e),e.connect(h),h.connect(audio.master),h.gain.value=.35,e.frequency.value=2e3,e.Q.value=3,i.type="sine",i.frequency.value=0,i.frequency.setValueAtTime(300,t),i.frequency.linearRampToValueAtTime(400,t+.09),audio.start(i,t),audio.stop(i,t+.1)}},shoot:function(){if(s){var i=s.currentTime,e=audio.noise,h=s.createBiquadFilter(),n=audio.createGain();t(n,i,.7,.04,.01,.01,.1,.1);var a=0|2e3*Math.random()+500;h.Q.value=10,h.frequency.value=a,h.frequency.setValueAtTime(a,i),h.frequency.linearRampToValueAtTime(6e3,i+.04),e.connect(h),h.connect(n),n.connect(audio.master)}},pickup:function(){if(s){var t=s.currentTime,i=s.createOscillator(),e=s.createBiquadFilter(),h=audio.createGain();i.connect(e),e.connect(h),h.connect(audio.master),h.gain.value=.12,e.frequency.value=3e3,e.Q.value=10,i.type="sine",i.frequency.value=0,i.frequency.setValueAtTime(600,t),i.frequency.linearRampToValueAtTime(2600,t+.12),audio.start(i,0),audio.stop(i,t+.12)}},collect:function(){if(s){var t=s.currentTime,i=s.createOscillator(),e=s.createOscillator(),h=audio.createGain(),n=s.createBiquadFilter(),a=audio.createGain();i.type="sine",i.connect(n),n.connect(a),a.connect(audio.master),e.type="sine",e.frequency.value=10,h.gain.setValueAtTime(10,t),h.gain.linearRampToValueAtTime(200,t+1),e.connect(h),h.connect(i.frequency),a.gain.value=1,audio.start(e,t),audio.start(i,t),audio.stop(i,t+1)}},swiggle:function(){if(s){var t=s.currentTime,i=s.createOscillator(),e=s.createBiquadFilter(),h=audio.createGain();i.connect(e),e.connect(h),h.connect(audio.master),h.gain.value=.1,e.frequency.value=3e3,e.Q.value=10,i.type="square",i.frequency.value=0,i.frequency.setValueAtTime(50,t),i.frequency.linearRampToValueAtTime(600,t+.32),audio.start(i,0),audio.stop(i,t+.32)}},die:function(){if(s){var i=s.currentTime,e=audio.noise,h=s.createBiquadFilter(),n=audio.createGain();t(n,i,.6,.5,.01,.01,.4,.08);var a=0|2e4*Math.random()+500;h.Q.value=10,h.frequency.value=a,h.frequency.setValueAtTime(a,i),h.frequency.linearRampToValueAtTime(200,i+.5),e.connect(h),h.connect(n),n.connect(audio.master)}}},init:function(){return window.AudioContext?s=new AudioContext:window.webkitAudioContext&&(s=new webkitAudioContext),this.createGain=function(){var t=null;return s.createGain?t=s.createGain():s.createGainNode?t=s.createGainNode():this.ctx=s=null,t},this.start=function(t,i){t.start?t.start(i):t.noteOn?t.noteOn(i):this.ctx=s=null},this.stop=function(t,i){t.stop?t.stop(i):t.noteOff?t.noteOff(i):this.ctx=s=null},!s||this.createGain()&&s.createOscillator||(s=null),s?(this.noise=e(),this.start(this.noise,0),this.master=audio.createGain(),this.master.gain.value=1,this.master.connect(s.destination),void 0):(document.querySelector("#na").style.display="block",void 0)},stop:function(){this.osc.stop(s.currentTime)}}}(),function(){function t(t,i){this.parent=i,this.x=0,this.y=0,this.w=4,this.h=4,this.col=t.col,this.xSpeed=2*Math.random()-1,this.ySpeed=2*Math.random()-1-1}var i=function(){this.particles=null,this.running=!1};i.prototype={init:function(i,e){this.maxLife=i.life||40,this.life=this.maxLife,this.cb=e,this.col=i.col||"100, 0, 0",this.particles=[];for(var s=0;20>s;s++)this.particles.push(new t({col:this.col},this));return this},play:function(t,i){this.life=this.maxLife,this.x=t,this.y=i,this.running=!0,this.particles.forEach(function(t){t.reset()})},tick:function(){this.running&&(this.life-=1,this.particles.forEach(function(t){t.tick()}),this.life<0&&(this.running=!1,this.cb&&this.cb()))},render:function(t){var i=this;this.running&&this.particles.forEach(function(e){e.render(t,i.x,i.y)})}},t.prototype={reset:function(){this.life=this.parent.maxLife,this.x=0,this.y=0,this.xSpeed=2*Math.random()-1,this.ySpeed=2*Math.random()-1-3},tick:function(){this.x+=this.xSpeed,this.y+=this.ySpeed,this.ySpeed+=.2},render:function(t,i,e){t.fillStyle="rgba("+this.col+", "+(.3+this.parent.life/this.parent.maxLife)+")",t.fillRect(this.x+i,this.y+e,this.w,this.h)}},window.Particle=i}();var GEN={tiles:function(t,i){var e,s,h,n,a,r,o,l,c,u,f,d=20;for(s=utils.createCanvas(d*t,i),h=s.createImageData(s.w,s.h),e=0;d>e;e++)for(a=0;i>a;a++)for(n=0;t>n;n++){switch(r=4*n+4*a*s.w+4*e*t,u=255-(0|96*Math.random()),e){case 5:case 11:case 12:if(o=COLOR.tile.dirt,(3&3*n*n+41*n>>2)+8>a?o=COLOR.tile.grass:(3&3*n*n+41*n>>2)+9>a&&(u=2*u/3),11===e&&2>n&&2>a){c=Math.sqrt((2-n)*(2-n)+(2-a)*(2-a)),c>=1.8&&(o=-1);break}if(12===e&&n>17&&2>a){c=Math.sqrt((17-n)*(17-n)+(2-a)*(2-a)),c>=1.9&&(o=-1);break}break;case 7:o=COLOR.tile.dirt;break;case 6:o=COLOR.tile.stone;break;case 1:o=Math.random()<.15?COLOR.tile.vine_leaves:-1,(1==(n+16*(a>>2))%8||0==a%8)&&(o=COLOR.tile.vine_ladder);break;case 2:case 3:case 4:o=COLOR.tile.water,f=a%12-4*(e-2),0>f&&(f+=12),Math.abs(0|5*Math.sin(n/2))===f&&(o=COLOR.tile.water_splash);break;case 8:case 9:case 10:o=COLOR.tile.lava,f=a%4-(e-8),0>f&&(f+=4),Math.abs(0|2*Math.sin(n/2))===f&&(o=COLOR.tile.lava_lines),u=Math.min(255,1.4*u)}l=(255&o>>16)*u/255<<16|(255&o>>8)*u/255<<8|(255&o)*u/255,h.data[r+0]=-1==o?0:255&l>>16,h.data[r+1]=-1==o?0:255&l>>8,h.data[r+2]=-1==o?0:255&l,h.data[r+3]=-1==o?0:255}return s.putImageData(h,0,0),s.canvas},font:function(){var t,i=utils.createCanvas(720,24),e=utils.createCanvas(720,24),s="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!?.:;,'/-+'",h=s.split(""),n=function(t,i,e,s){return i.data[4*(e*i.width+s)+t]+i.data[4*(e*i.width+s+1)+t]+i.data[4*((e+1)*i.width+s+1)+t]+i.data[4*((e+1)*i.width+s+1)+t]/4};i.fillStyle=COLOR.font_main,i.font="24px courier new",h.forEach(function(t,e){i.fillText(t,16*e,16)});for(var a=i.getImageData(0,0,i.canvas.width,i.canvas.height),r=e.getImageData(0,0,e.canvas.width,e.canvas.height),o=1,l=0;l<a.height;l++)for(var c=0;c<a.width;c++)for(var u=2*Math.floor(l/2),f=2*Math.floor(c/2),d=[n(0,a,u,f),n(1,a,u,f),n(2,a,u,f),n(3,a,u,f)],p=0;o>p;p++)for(var y=l*o+p,m=0;o>m;m++)for(var w=c*o+m,g=0;4>g;g++)r.data[4*(y*r.width+w)+g]=d[g];return e.putImageData(r,0,0),t=makeSheet(e.canvas,16,24),function(i,e,s,n){e.split("").forEach(function(e,a){return" "!==e&&t.render(i,h.indexOf(e),0,s+16*a,n),!0})}}},BLOCKS={walkable:4,type:{LADDER:1,WATER:2,WATERRIGHT:3,WATERLEFT:4,LAVA:8}};window.BLOCKS=BLOCKS,function(){var t;window.Map={x:0,y:0,init:function(i,e){return this.sheet=i,this.camera=e,this.walkable=BLOCKS.walkable,this.cells=this.expandRoomMap(t,this.generateRoomMap()),this.cellH=this.cells.length,this.cellW=this.cells[0].length,this.h=this.cellH*i.h,this.w=this.cellW*i.w,this.pickups=this.addPickups(),this.pieces=this.addPieces(),this.camera.setBounds(this.w,this.h),this},generateRoomMap:function(){for(var t,i=[],e=8,s=0;15>s;s++){i.push([]);for(var h=0;20>h;h++)t=0|Math.random()*e,17!==s||3!==t?i[s].push(t):h--}for(s=0;8>s;s++)i[0][s]=e+1;return i[0][2]=e+2,i[0][4]=7,i},expandRoomMap:function(t,i){var e,s,h,n=[],a=i.length,r=i[0].length,o=t[0][0].length,l=t[0].length;for(h=0;a*l+2>h;h++)for(n.push([]),s=0;r*o>s;s++)a*l>h?(e=i[0|h/l][0|s/o],n[h].push(t[e][h%l][s%o])):n[h].push(6);return n},findFreeBlock:function(){for(var t,i,e=this.walkable+1;e>this.walkable;)t=0|Math.random()*this.cells[0].length,i=0|Math.random()*this.cells.length,e=this.cells[i][t];return[t,i]},addPickups:function(){var t,i,e=[];for(t=0;60>t;t++){for(i=this.findFreeBlock();i[1]<7;)i=this.findFreeBlock();e.push([i[0],i[1]])}return e.push([49,6]),e},addPieces:function(){for(var t,i=[],e=0;4>e;e++){for(t=this.findFreeBlock();t[1]<7;)t=this.findFreeBlock();i.push([t[0],t[1]])}return i},tick:function(){},getBlocks:function(t){return t.map(function(t){var i=0|t[1]/this.sheet.h,e=0|t[0]/this.sheet.w;return 0>i||i>this.cellH-1?null:this.cells[i][e]},this)},getBlockEdge:function(t,i){var e=i?this.sheet.h:this.sheet.w;return utils.snap(t,e)},render:function(t){var i,e,s,h=game.tw,n=game.th,a=this.sheet.cellW,r=0|this.camera.x/h,o=0|this.camera.y/n,l=r+(0|this.camera.w/h)+1,c=o+(0|this.camera.h/n)+1;for(i=o;c>=i;i++)if(!(0>i||i>this.cellH-1))for(e=r;l>=e;e++)e>this.cellW-1||(s=this.cells[i][e],0!==s&&(s>=2&&4>=s&&(s=(0|Date.now()/200%3)+2),s>=8&&10>=s&&(s=(0|Date.now()/400%3)+8),this.sheet.render(t,0|s%a,0|s/a,e*h,i*n)))}},t=[[[0,0,0,1,1,0,0,0,1,1,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[5,1,5,5,5,5,5,5,1,5,5]],[[0,0,0,0,0,0,0,0,0,0,0],[0,12,0,0,0,0,0,0,0,0,0],[5,8,12,0,0,0,0,0,6,1,6],[7,8,8,12,0,0,0,0,0,1,0],[7,8,8,8,12,0,0,0,0,1,0],[7,0,8,8,7,0,0,0,0,1,0],[0,0,5,5,5,5,5,5,5,1,5]],[[1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,6,6,6,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0],[0,0,6,0,0,0,0,0,6,0,0],[5,5,5,5,5,5,5,5,5,12,0],[7,7,7,7,7,7,7,7,7,7,1]],[[0,0,0,0,0,0,2,0,0,0,7],[0,0,0,0,0,0,2,0,0,11,7],[6,1,1,0,0,0,3,3,3,2,7],[0,1,1,0,0,0,7,7,7,2,7],[0,1,1,0,0,11,7,7,7,2,7],[5,1,1,5,5,7,7,2,4,4,7],[7,7,1,7,7,7,2,2,7,7,7]],[[7,0,0,0,0,0,0,0,0,0,1],[7,0,0,0,0,0,0,0,0,0,7],[7,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,5,12,0,0,0,0,0,5],[1,0,5,7,7,0,0,0,0,0,7],[1,5,7,7,7,0,5,5,5,1,7]],[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,11,5],[0,0,0,0,0,0,0,0,11,7,0],[0,0,0,0,0,0,11,5,7,0,0],[0,0,0,0,0,0,0,0,0,0,5],[0,0,11,5,12,0,0,0,0,0,7],[7,7,7,7,7,0,5,5,5,1,7]],[[0,0,0,0,5,5,5,0,0,0,0],[5,0,0,0,0,0,0,0,0,5,5],[0,0,0,0,0,0,0,0,5,7,0],[0,0,11,5,0,0,0,5,7,0,0],[0,0,0,0,5,12,0,0,0,0,5],[0,0,0,0,0,0,0,0,0,0,7],[0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,11,11,1,11,12,0,0,0],[0,0,0,7,7,1,7,7,12,0,0],[0,0,11,7,7,1,7,7,7,0,0],[5,5,7,7,7,1,7,7,7,5,5]],[[0,0,0,0,0,0,0,0,0,0,0],[0,11,12,0,0,0,0,0,0,0,0],[0,7,7,0,0,0,0,0,0,0,0],[0,7,7,0,0,0,0,0,11,12,0],[0,7,7,0,0,0,0,0,7,7,12],[0,7,7,0,0,0,0,0,7,7,7],[5,7,7,5,5,0,5,5,7,7,7]],[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5,5,5,5]],[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,11,12,0],[0,0,0,0,0,0,0,0,7,7,12],[0,0,0,0,0,0,0,0,7,7,7],[5,5,5,5,5,5,5,5,7,7,7]]]}();var Entity=function(){this.w=10,this.h=10,this.remove=!1,this.falling=!1,this.xo=0,this.yo=0};Entity.prototype={init:function(t,i){return this.x=t,this.y=i,this},hit:function(){},hitBlocks:function(){},tick:function(){return!this.remove},move:function(t,i,e){var s,h,n,a,r,o,l=!1,c=!1;return s=t,h=i,n=this.x+s,a=this.y+h,o=e.getBlocks([[this.x,a],[this.x,a+(this.h-1)],[this.x+(this.w-1),a],[this.x+(this.w-1),a+(this.h-1)]]),0>i&&(o[0]>e.walkable||o[2]>e.walkable)&&(h=e.getBlockEdge((0|a)+e.sheet.h,"VERT")-this.y,c=!0),i>0&&(o[1]>e.walkable||o[3]>e.walkable)&&(h=e.getBlockEdge(a+this.h,"VERT")-this.y-this.h,c=!0),this.y+=h,r=e.getBlocks([[n,this.y],[n,this.y+(this.h-1)],[n+(this.w-1),this.y],[n+(this.w-1),this.y+(this.h-1)]]),0>t&&(r[0]>e.walkable||r[1]>e.walkable)&&(s=e.getBlockEdge(n+e.sheet.w)-this.x,l=!0),t>0&&(r[2]>e.walkable||r[3]>e.walkable)&&(s=e.getBlockEdge(n+this.w)-this.x-this.w,l=!0),(l||c)&&this.hitBlocks(l?r:null,c?o:null),this.x+=s,o=e.getBlocks([[this.x-(this.dir>0?6:0),this.y+this.h],[this.x+(this.w-1)+(this.dir<0?6:0),this.y+this.h]]),this.wasFalling=this.falling,this.falling=o[0]<=e.walkable&&o[1]<=e.walkable?this.onLadder?!1:!0:!1,this.xo=0,this.yo=0,[s,h]},render:function(t){t.fillStyle="red",t.fillRect(this.x,this.y,this.w,this.h)}};var Ghoul=function(){this.w=15,this.h=22,this.dir=1,this.speed=1.1,this.angrySpeed=1.5,this.life=3,this.knockBack=0,this.xpValue=15,this.xpAttackValue=-8,this.isAngry=!1,this.foreverAngry=!1,this.visible=!1,this.notVisibleFor=0};Ghoul.prototype=new Entity,Ghoul.prototype.init=function(t,i,e,s){return this.x=t,this.y=i,this.level=s,this.speed=Math.random()+.6,this.angrySpeed=.5*Math.random()+1.2,this.dir=e||1,this.offs={headX:1,headY:-2,bodyX:0,bodyY:6},this},Ghoul.prototype.hit=function(t){t instanceof Spear&&!t.stuck&&(this.knockBack=t.dir===this.dir?3*t.dir:-7*this.dir,this.life--<=0&&(this.level.xp(this),this.remove=!0,this.level.explode(this.x+this.w/2,this.y+this.h))),(t instanceof Trap||t instanceof Player)&&(this.remove=!0,this.level.explode(this.x+this.w/2,this.y+this.h))},Ghoul.prototype.tick=function(t){var i,e=0,s=0;if(this.visible)this.notVisibleFor=0;else if(this.notVisibleFor++>2e3)return!1;if(this.isAngry){i=this.level.player;var h=utils.dist([this.x,this.y],[i.x,i.y]);(this.foreverAngry||350>h)&&(Math.abs(this.y-i.y)>2?e=this.angrySpeed*(this.y<i.y?1:-1):Math.abs(this.x-i.x)>5&&(this.dir=this.x<i.x?1:-1,s=this.angrySpeed*this.dir)),e+=Math.sin(Date.now()/100)/2}else e=Math.sin(Date.now()/100),s=this.speed*this.dir;return 0!==this.knockBack&&(s+=this.knockBack,this.knockBack=this.knockBack+(this.knockBack>0?-1:1)),this.isAngry?(this.x+=s,this.y+=e,this.visible&&(this.foreverAngry=!0)):this.visible&&this.move(s,e,t),!this.remove},Ghoul.prototype.hitBlocks=function(){this.dir*=-1},Ghoul.prototype.render=function(t){t.strokeStyle="#000",t.lineWidth=2,t.shadowColor="hsl(70, 100%, 50%)",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10;var i=2*Math.sin(Date.now()/300);t.fillStyle=this.isAngry?"hsl(10, 80%, 60%)":"hsl(180, 80%, 50%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY+i/2,12,15),t.strokeRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY+i/2,12,15),t.fillStyle=this.isAngry?"hsl(0, 80%, 60%)":"hsl(120, 30%, 40%)",t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY+i,6,10),t.strokeRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY+i,6,10),t.fillStyle=this.isAngry?"hsl(0, 80%, 60%)":"hsl(120, 30%, 40%)",t.fillRect(this.x+2,this.y+20,8,3),t.strokeRect(this.x+2,this.y+20,8,3),t.fillRect(this.x+(this.dir<0?6:4),this.y+11,8*this.dir,3)};var Pickup=function(){this.w=20,this.h=24,this.xpValue=11};Pickup.prototype=new Entity,Pickup.prototype.init=function(t,i){return this.x=t,this.y=i,this},Pickup.prototype.tick=function(){return!this.remove},Pickup.prototype.hit=function(){},Pickup.prototype.render=function(t){t.strokeStyle="#000",t.fillStyle="#a00",t.lineWidth=2,t.beginPath(),t.arc(this.x+this.w/2,this.y+this.h/2,this.w/3,0,2*Math.PI,!1),t.fill(),t.stroke()};var Piece=function(){this.w=20,this.h=24,this.xpValue=32};Piece.prototype=new Entity,Piece.prototype.init=function(t,i,e){return this.x=t,this.y=i,this.id=e,this},Piece.prototype.tick=function(){return!this.remove},Piece.prototype.hit=function(){},Piece.prototype.render=function(t){t.shadowColor="hsl(70, 100%, 50%)",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.strokeStyle="#ff0",t.fillStyle="#aa0",t.beginPath(),t.arc(this.x+this.w/2,this.y+this.h/2,this.w/3,0,2*Math.PI,!1),t.fill(),t.stroke()};var Player=function(){this.w=12,this.h=23,this.xp=0,this.vel=[0,0],this.acc=[0,0],this.grav=0,this.friction=.75,this.falling=!0,this.wasFalling=!1,this.onLadder=!1,this.wasOnLadder=!1,this.dir=1,this.numPickups=0,this.numTraps=0,this.pieces=[!1,!1,!1,!1],this.trapLaunch=-1,this.crouching=!1,this.deaded=!1,this.jumpHeight=-game.th-1,this.firing=0,this.everLaidTrap=!1,this.count=0};Player.prototype=new Entity,Player.prototype.init=function(t,i,e){return this.x=t,this.y=i,this.level=e,this.checkpoint=[this.x,this.y],this.initpos=[t,i],this.projectiles=[],this.traps=[],this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Player.prototype.complete=function(){var t=this.pieces;return t[0]+t[1]+t[2]+t[3]},Player.prototype.tick=function(t,i){if(this.count++,this.deaded)return this.tickDead(t,i),void 0;var e=.9;this.projectiles=this.projectiles.filter(function(t){return t.tick(i)}),this.traps=this.traps.filter(function(t){return t.tick(i)}),t.isDown("up")&&(this.inWater||this.onLadder&&!this.onTopOfLadder?this.acc[1]-=e:this.falling||this.wasFalling||(audio.sfx.jump(),this.jump())),t.wasDown("down")&&(this.crouching=!1),t.isDown("down")&&(this.falling||(this.crouching=!0),t.isDown("fire")&&this.numTraps>0?this.trapLaunch<0?(this.trapLaunch=20,audio.sfx.swiggle()):-1===--this.trapLaunch&&(this.trapLaunch=1e3,this.numTraps--,this.traps.push((new Trap).init(this.x,this.y-2-24)),this.everLaidTrap=!0,this.traps.forEach(function(t){t.setClosestPiece(this.level.pieces)},this)):(this.trapLaunch=-1,this.acc[1]+=e)),t.isDown("left")&&(this.acc[0]-=e,this.dir=-1),t.isDown("right")&&(this.acc[0]+=e,this.dir=1),t.pressed("fire")&&!this.crouching&&(this.firing=10,this.projectiles.push((new Spear).init(this.x,this.y,this.dir)),audio.sfx.shoot()),this.tickVelocity(),this.wasFalling=this.falling,this.move(this.xo,this.yo,i),this.x<5&&(this.x=5),this.y<-3&&(this.y=-3),this.x>i.w-5&&(this.x=i.w-5),this.checkBlocks(t,i),this.onLadder&&(this.crouching=!1)},Player.prototype.jump=function(){this.acc[1]=this.jumpHeight,this.vel[1]=0,this.falling=!0},Player.prototype.tickDead=function(){var t=this.x-this.checkpoint[0],i=this.y-this.checkpoint[1],e=10;Math.abs(t)<20&&Math.abs(i)<20&&(this.x=this.checkpoint[0],this.y=this.checkpoint[1],this.jump(),this.deaded=!1),this.x+=Math.abs(t)<20?0:this.x<this.checkpoint[0]?e:-e,this.y+=Math.abs(i)<20?0:this.y<this.checkpoint[1]?e:-e},Player.prototype.tickVelocity=function(){this.grav=Math.min(this.falling?this.grav+.23:0,2.3),this.vel=[this.vel[0]+this.acc[0],this.vel[1]+this.acc[1]+this.grav],this.vel=[this.vel[0]*this.friction,this.vel[1]*this.friction],this.acc=[0,0],Math.abs(this.vel[0])<.01&&(this.vel[0]=0),Math.abs(this.vel[1])<.01&&(this.vel[1]=0),this.xo+=this.vel[0],this.yo+=this.vel[1]},Player.prototype.hit=function(t){if(t instanceof Pickup)return t.remove=!0,this.level.xp(t),audio.sfx.pickup(),this.numTraps++,(0===this.numPickups++||this.everLaidTrap===!1&&this.count>6e3)&&this.level.firstPickup(),void 0;if(t instanceof Ghoul)return this.killed(t),void 0;if(t instanceof Piece){t.remove=!0;var i=this.pieces;return i[t.id]=!0,this.checkpoint=[this.x,this.y],this.level.xp(t),4===this.complete()?this.level.winsTheGame():(audio.sfx.collect(),1===this.complete()&&this.level.firstPiece(),this.traps.forEach(function(i){i.setClosestPiece(this.level.pieces.filter(function(i){return i!==t}))},this)),void 0}},Player.prototype.hitSpear=function(t){t.stuck?(this.onLadder=!0,this.falling=!1,this.y+this.h-t.y<10&&(this.onTopOfLadder=!0,this.y=t.y-this.h)):this.onTopOfLadder=!1},Player.prototype.isMoving=function(){return Math.abs(this.vel[0])>.3||!this.crouching&&Math.abs(this.vel[1])>.3},Player.prototype.killed=function(t){this.deaded||(t&&this.level.xp({xpValue:t.xpAttackValue}),this.level.explode(this.x+this.w/2,this.y+this.h),this.deaded=!0)},Player.prototype.hitBlocks=function(t,i){(t&&t.indexOf(BLOCKS.type.LAVA)>-1||i&&i.indexOf(BLOCKS.type.LAVA)>-1)&&this.killed()},Player.prototype.checkBlocks=function(t,i){this.wasOnLadder=this.onLadder;var e=i.getBlocks([[this.x,this.y],[this.x,this.y+(this.h-1)],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+(this.h-1)]]);this.onTopOfLadder=!1,e.indexOf(BLOCKS.type.LADDER)>-1?(this.wasOnLadder||e[0]!==BLOCKS.type.LADDER&&e[2]!==BLOCKS.type.LADDER&&(this.y=utils.snap(this.y,i.sheet.h)+(i.sheet.h-this.h),this.onTopOfLadder=!0,t.isDown("down")||(this.vel[1]=0)),this.onLadder=!0,this.falling=!1):this.onLadder=!1,this.inWater=!1,e.indexOf(BLOCKS.type.WATER)>-1&&(this.yo+=4,this.inWater=!0,this.falling=!1),e.indexOf(BLOCKS.type.WATERRIGHT)>-1&&(this.xo+=4,this.inWater=!0),e.indexOf(BLOCKS.type.WATERLEFT)>-1&&(this.xo-=4,this.inWater=!0)},Player.prototype.render=function(t){t.shadowBlur=0;var i=t.createLinearGradient(this.checkpoint[0]+game.tw/2,this.checkpoint[1],this.checkpoint[0]+game.tw/2,this.checkpoint[1]+game.th);i.addColorStop(0,"hsla(0, 0%, 0%, 0)"),i.addColorStop(.3*Math.random(),"hsla(0, 0%, 0%, 0)"),i.addColorStop(1,"hsla("+(0|130*Math.random()+40)+", 100%, 50%, 1)"),t.fillStyle=i,t.fillRect(this.checkpoint[0],this.checkpoint[1],game.tw,game.th-3),t.fillStyle="#dd0",t.fillRect(this.checkpoint[0],this.checkpoint[1]+game.th-3,game.tw,3),this.firing-->0&&!this.onLadder&&(t.fillStyle="hsl(55, 100%, 50%)",t.fillRect(this.x+4*-this.dir+6+-this.firing/5,this.y-2,2,5)),this.projectiles.forEach(function(i){return i.render(t)}),this.traps.forEach(function(i){return i.render(t)}),t.strokeStyle="#000",t.lineWidth=2,t.fillStyle="hsl(10, 70%, 30%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.strokeRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle="hsl(20, 30%, 40%)",this.onLadder?(t.fillRect(this.x+3,this.y+this.offs.headY,6,10),t.strokeRect(this.x+3,this.y+this.offs.headY,6,10)):(t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY+4*this.crouching,6,10),t.strokeRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY+4*this.crouching,6,10)),t.fillStyle="hsl(55, 100%, 50%)",this.isMoving()?0===(0|Date.now()/100)%2?this.onLadder?(t.fillRect(this.x-2,this.y+2,3,5),t.fillRect(this.x+11,this.y+8,3,5),t.fillRect(this.x+2,this.y+20,3,2),t.fillRect(this.x+8,this.y+20,3,4)):(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):this.onLadder?(t.fillRect(this.x-2,this.y+8,3,5),t.fillRect(this.x+11,this.y+2,3,5),t.fillRect(this.x+2,this.y+20,3,4),t.fillRect(this.x+8,this.y+20,3,2)):(t.fillRect(this.x+4,this.y+20,4,3),t.fillRect(this.x+5,this.y+11,3,5)):!this.onLadder||this.wasFalling?(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):(t.fillRect(this.x-2,this.y+8,3,5),t.fillRect(this.x+11,this.y+2,3,5),t.fillRect(this.x+2,this.y+20,3,4),t.fillRect(this.x+8,this.y+20,3,2))};var Spear=function(){this.w=15,this.h=4,this.speed=8,this.dir=-1,this.life=200,this.remove=!1,this.stuck=!1,this.x=0,this.y=0};Spear.prototype=new Entity,Spear.prototype.init=function(t,i,e){return this.x=t,this.y=i,this.dir=e,this},Spear.prototype.tick=function(t){if(!this.stuck){var i=this.speed*this.dir,e=this.move(i,this.yo,t);0===e[0]&&(this.stuck=!0)}return this.life--<0&&(this.remove=!0),!this.remove},Spear.prototype.hit=function(t){t instanceof Spear?this.stuck=!0:this.remove=!0},Spear.prototype.render=function(t){t.fillStyle="hsl(55, 100%, 50%)",t.strokeStyle="#000",t.lineWidth=1,t.fillRect(this.x,this.y+1,this.w,this.h-2),t.fillRect(this.x+(this.dir<0?10:this.w-12),this.y,2,this.h),t.strokeRect(this.x-1,this.y,this.w+2,this.h)};var Trap=function(){this.w=20,this.h=48,this.x=0,this.y=0,this.life=5,this.closest=null,this.activated=!1};Trap.prototype=new Entity,Trap.prototype.init=function(t,i){return this.x=t,this.y=i,this},Trap.prototype.tick=function(){return!this.remove},Trap.prototype.hit=function(t){t instanceof Ghoul&&(this.activated=!0,0===--this.life&&(this.remove=!0))},Trap.prototype.setClosestPiece=function(t){var i=this;this.closest=t.reduce(function(t,e){var s=utils.dist([i.x,i.y],[e.x,e.y]),h=utils.angleBetween(i,e);return h%=2*Math.PI,0>h&&(h+=2*Math.PI),!t[0]||s<t[1]?[e,s,h]:t},[null,-1,-1])},Trap.prototype.render=function(t){this.activated&&this.closest[0]&&(t.save(),t.translate(this.x+this.w/2,this.y+this.h/2),t.rotate(this.closest[2]+1.5*Math.PI),t.fillStyle="hsl(40, 50%, 10%)",t.strokeStyle="#ff0",t.beginPath(),t.moveTo(-5,0),t.lineTo(5,0),t.lineTo(2.4*Math.sin(Date.now()/350),-14),t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,5,0,2*Math.PI,!0),t.fill(),t.restore());var i=t.createLinearGradient(this.x+10,this.y,this.x+10,this.y+this.h);i.addColorStop(0,"hsla(0, 0%, 0%, 0)"),i.addColorStop(.3*Math.random(),"hsla(0, 0%, 0%, 0)"),i.addColorStop(1,"hsla("+(0|20*Math.random()+40)+", 100%, 50%, "+this.life/5+")"),t.fillStyle=i,t.fillRect(this.x,this.y,this.w,this.h),t.fillStyle="#a00",t.fillRect(this.x,this.y+this.h-3,this.w,3)};var Camera={x:0,y:0,xRange:80,yRange:100,zoom:1,init:function(t,i,e,s,h){return this.entity=t,this.w=s,this.h=h,this.x=i,this.y=e,this.track(t),this},setBounds:function(t,i){this.bounds=[t,i]},track:function(t){var i=t||this.entity;this.x=i.x-this.w/2+i.w/2,this.y=i.y-this.h/2,this.constrainToBounds()},constrainToBounds:function(){this.x<0&&(this.x=0),this.x>0&&this.bounds&&this.x+this.w>this.bounds[0]&&(this.x=this.bounds[0]-this.w),this.y<0&&(this.y=0),this.y>0&&this.bounds&&this.y+this.h>this.bounds[1]&&(this.y=this.bounds[1]-this.h)},tick:function(){var t=this.entity,i={x:this.x+this.w/2,y:this.y+this.h/2},e=this.xRange,s=this.yRange;t.x<i.x-e&&(this.x=t.x-this.w/2+e),t.x+t.w>i.x+e&&(this.x=t.x+t.w-this.w/2-e),t.y<i.y-s&&(this.y=t.y-this.h/2+s),t.y+t.h>i.y+s&&(this.y=t.y+t.h-this.h/2-s),this.constrainToBounds()},render:function(t,i){var e=this;t.save(),t.translate(-Math.round(this.x),-Math.round(this.y)),i.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]).filter(function(t){var i=t.repeat||!(t.x+t.w<e.x||t.y+t.h<e.y||t.x>e.x+e.w/e.zoom||t.y>e.y+e.h/e.zoom);return t.visible=i,i}).forEach(function(i){i.render(t,e)}),t.restore()}},Dialog=function(){this.count=0};Dialog.prototype={init:function(t,i){return this.renderfunc=t,this.donefunc=i,this},tick:function(){return this.count++,this.count>70&&Input.isDown("fire")?(this.donefunc&&this.donefunc.call(this),!1):!0},render:function(t){t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,game.ctx.w,game.ctx.h),this.renderfunc.call(this,t)}},window.Screen=window.Screen||{},Screen.title={count:0,stars:[1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7,8],init:function(){return this.tiles=makeSheet(game.res.tiles,game.tw,game.th),this},tick:function(t){this.count++,0===(this.count-1)%100&&(this.stars=this.stars.map(function(){return[0|Math.random()*game.ctx.w,0|Math.random()*game.ctx.h,0|7*Math.random()]})),this.stars=this.stars.map(function(t){return[t[0]+2*Math.random()-1,t[1],t[2]]}),this.count>50&&t.pressed("fire")&&game.setScreen(Screen.level)},render:function(t){t.fillStyle="hsla(211, 20%, 37%, 0.15)",t.fillRect(0,0,t.w,t.h),t.fillStyle="hsla(65, 40%, 70%, 0.2)",this.stars.forEach(function(i){t.beginPath(),t.arc(i[0],i[1],i[2],0,2*Math.PI,!1),t.fill()}),t.save(),t.scale(3,3);for(var i=0;12>i;i++){this.tiles.render(t,5,0,i*game.tw,100);for(var e=0;5>e;e++)this.tiles.render(t,7,0,i*game.tw,game.th*(e+1)+100)}game.res.font(t,"GLOWBOUGS",82+5*Math.sin(Date.now()/450),10+2*Math.cos(Date.now()/350)),game.res.font(t,"BY",5,84),game.res.font(t,"MR SPEAKER",5,115),t.restore()}},window.Screen=window.Screen||{},Screen.win={count:0,init:function(t){return this.tiles=makeSheet(game.res.tiles,game.tw,game.th),this.xp=t||0,audio.sfx.collect(),this},tick:function(t){this.count++,this.count>50&&t.pressed("fire")&&game.reset()},render:function(t){t.fillStyle="hsl("+(0|(this.count+80)/3%360)+", 60%, 40%)",t.fillRect(0,0,t.w,t.h),t.save(),t.scale(3,3);for(var i=0;12>i;i++){this.tiles.render(t,5,0,i*game.tw,100);for(var e=0;5>e;e++)this.tiles.render(t,7,0,i*game.tw,game.th*(e+1)+100)}game.res.font(t,"KING GLOWBOUG",15+5*Math.sin(Date.now()/300),10+2*Math.cos(Date.now()/200)),t.restore(),game.res.font(t,"YOU HAVE SAVED THE DAY AND DONE WELL.",50,140),game.res.font(t,"RECLAIMING THE GRAIL'S ENERGY GAVE YOU",50,170),game.res.font(t,this.xp+" YEARS OF REWARD.",50,200),game.res.font(t,"PLUS IT WAS QUITE FUN.",50,260)}},window.Screen=window.Screen||{},Screen.level={init:function(){var t=makeSheet(game.res.tiles,game.tw,game.th);this.player=(new Player).init(2*game.tw,5*game.th,this),this.camera=Camera.init(this.player,0,0,game.ctx.w,game.ctx.h),this.map=Map.init(t,this.camera),this.pickups=this.map.pickups.map(function(t){return(new Pickup).init(t[0]*game.tw,t[1]*game.th)}),this.pieces=this.map.pieces.map(function(t,i){return(new Piece).init(t[0]*game.tw,t[1]*game.th,i)}),this.ghouls=[],this.particles=[];for(var i=0;5>i;i++)this.particles.push((new Particle).init({}));return this},tick:function(t){if(this.camera.tick(),this.player.tick(t,this.map),this.ghouls=this.ghouls.filter(function(t){return t.tick(this.map)},this),this.pickups=this.pickups.filter(function(t){return t.tick()}),this.pieces=this.pieces.filter(function(t){return t.tick()}),this.particles.forEach(function(t){return t.tick()}),Math.random()<.01&&this.ghouls.length<35){for(var i,e,s=!1;!s;){i=0|Math.random()*(this.map.cellW-4),e=(0|Math.random()*(this.map.cellH-4-7))+2+7;var h=utils.dist([this.player.x,this.player.y],[i*game.tw,e*game.th]);if(h<600*(5-this.player.complete())){s=!0;for(var n=0;4>n;n++)if(this.map.cells[e][i+n]>this.map.walkable||this.map.cells[e-1][i+n]>this.map.walkable||this.map.cells[e+1][i+n]>this.map.walkable){s=!1;break}}}this.ghouls.push((new Ghoul).init((i+1)*game.tw,e*game.th,Math.random()<.5?1:-1,this)),Math.random()<.4*((this.player.complete()+1)/4)&&(this.ghouls[this.ghouls.length-1].isAngry=!0)}utils.checkCollisions([this.ghouls,this.player.projectiles]),utils.checkCollisions([this.ghouls,this.player.traps]),this.player.deaded||(utils.checkCollision(this.player,this.player.projectiles,"hitSpear"),utils.checkCollision(this.player,this.pieces),utils.checkCollision(this.player,this.pickups),utils.checkCollision(this.player,this.ghouls))},xp:function(t){this.player.xp+=t.xpValue},explode:function(t,i){for(var e=!1,s=0;s<this.particles.length;s++){var h=this.particles[s];h.running||(h.play(t,i),e=!0);break}e||this.particles[0].play(t,i),audio.sfx.die()},firstPickup:function(){game.dialog=(new Dialog).init(function(t){game.res.font(t,"HOLD DOWN AND FIRE TO ACTIVATE A",40,60),game.res.font(t,"GLOWBOUG TRAP.",40,100),game.res.font(t,"IT HAS A SHORT RANGE, SO BE CLOSE!",40,170),game.res.font(t,"TRY TO CATCH THEM FROM BELOW.",40,210),game.res.font(t,"GLOWBOUGS WILL LEAD YOU TO THE GRAIL.",40,250)})},firstPiece:function(){game.dialog=(new Dialog).init(function(t){game.res.font(t,"YOU HAVE FOUND A PIECE OF THE GRAIL.",40,60),game.res.font(t,"FIND THE REMAINING THREE PIECES TO",40,120),game.res.font(t,"COMPLETE YOUR QUEST.",40,150),game.res.font(t,"YOU WILL NOW RETURN HERE, IF YOU DIE.",40,220)})},winsTheGame:function(){game.setScreen(Screen.win,this.player.xp)},render:function(t){t.clearRect(0,0,t.w,t.h),this.camera.render(t,[this.map,this.pickups,this.pieces,this.ghouls,this.player,this.particles]),game.res.font(t,"GRAIL: "+this.player.complete()+"/4",20,20),game.res.font(t,"XP: "+this.player.xp,20,40),game.res.font(t,"TRAPS: "+this.player.numTraps,20,60)
}};var Input={keys:{37:{wasDown:!1,isDown:!1},38:{wasDown:!1,isDown:!1},39:{wasDown:!1,isDown:!1},40:{wasDown:!1,isDown:!1},32:{wasDown:!1,isDown:!1},13:{wasDown:!1,isDown:!1}},actions:{up:38,right:39,down:40,left:37,fire:32,escape:13},init:function(){function t(t,e){i.keys[t]&&(i.keys[t].wasDown=i.keys[t].isDown,i.keys[t].isDown=e)}var i=this;return document.addEventListener("keydown",function(i){t(i.keyCode,!0)},!1),document.addEventListener("keyup",function(i){t(i.keyCode,!1)},!1),this},reset:function(){for(var t in this.keys)this.keys[t].isDown=!1,this.keys[t].wasDown=!1},tick:function(){var t;for(t in this.keys)this.keys[t].wasDown=this.keys[t].isDown},isDown:function(t){return this.keys[this.actions[t]].isDown},wasDown:function(t){return this.keys[this.actions[t]].wasDown},pressed:function(t){return this.isDown(t)&&!this.wasDown(t)}},game={tw:20,th:24,dialog:null,screen:null,screenPrev:null,screenFade:0,init:function(){this.ctx=this.addMainCanvas(),this.res={tiles:GEN.tiles(this.tw,this.th),font:GEN.font()},this.input=Input.init(),audio.init(),this.reset(),this.run()},setScreen:function(t,i){this.screenPrev=this.screen,this.screen=t.init(i),this.screenFade=75},addMainCanvas:function(){var t=utils.createCanvas(720,405,"board");return t.canvas.backgroundColor=COLOR.back_main,document.querySelector("#b").appendChild(t.canvas),t},reset:function(){this.input.reset(),this.setScreen(Screen.title)},run:function(){this.dialog?this.dialog.tick(this.input)||(this.dialog=null):this.screen.tick(this.input),this.input.tick(),this.screen.render(this.ctx),this.screenFade-->0&&(this.ctx.globalAlpha=this.screenFade/75,this.screenPrev&&this.screenPrev.render(this.ctx),this.ctx.globalAlpha=1),this.dialog&&this.dialog.render(this.ctx),window.requestAnimationFrame(function(){game.run(Date.now())})}};