function drawTiledBackground(){for(var e=0;rowTileCount>e;e++)for(var r=0;colTileCount>r;r++)ctx.fillStyle="rgba(0, 0, 0, 1)",ctx.fillRect(r*tileSize,e*tileSize,tileSize,tileSize);for(var e=0;rowTileCount>e;e++)for(var r=0;colTileCount>r;r++){var t=groundLayer[e][r],a=t/imageNumTiles|0,i=t%imageNumTiles|0;ctx.drawImage(tilesetImage,i*tileSize,a*tileSize,tileSize,tileSize,(r-camera.x)*tileSize,(e-camera.y)*tileSize,tileSize,tileSize),t=topLayer[e][r];var o=0;(t==horse1||t==horse2||t==horse3||t==horse4)&&(o+=10),a=t/imageNumTiles|0,i=t%imageNumTiles|0,ctx.drawImage(tilesetImage,i*tileSize,a*tileSize,tileSize,tileSize,(r-camera.x)*tileSize,(e-camera.y)*tileSize-o,tileSize,tileSize)}}function createWorld(){return birthLimit=4,deathLimit=3,chanceToStartAlive=.4,numberOfSteps=2,world=generateMap()}function generateMap(){var e=[[]];initialiseMap(e);for(var r=0;numberOfSteps>r;r++)e=doSimulationStep(e);placeTreasure(e),e[0]=getFullRowWall(),e[rowTileCount-1]=getFullRowWall();for(var t=1;worldHeight-1>t;t++)e[t][0]=hardWallIndex,e[t][worldHeight-1]=hardWallIndex;var a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);for(e[t][a]=horse1,console.log("Horse 1 X:"+a+" Y:"+t),a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);e[t][a]==horse1;)a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);for(e[t][a]=horse2,console.log("Horse 2 X:"+a+" Y:"+t),a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);e[t][a]==horse1||e[t][a]==horse2;)a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);for(e[t][a]=horse3,console.log("Horse 3 X:"+a+" Y:"+t),a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);e[t][a]==horse1||e[t][a]==horse2||e[t][a]==horse3;)a=Math.floor(Math.random()*(colTileCount-2)+1),t=Math.floor(Math.random()*(rowTileCount-2)+1);return e[t][a]=horse4,console.log("Horse 4 X:"+a+" Y:"+t),e}function placeTreasure(e){for(var r=0,t=5,a=0;worldWidth>a;a++)for(var i=0;worldHeight>i;i++)if(0==e[a][i]){var o=countAliveNeighbours(e,a,i);if(o>=t){var l=[treasureIndex,healthPotionIndex],n=Math.floor(Math.random()*l.length);e[a][i]=l[n],r++}}}function initialiseMap(e){for(var r=0;worldWidth>r;r++){e[r]=[];for(var t=0;worldHeight>t;t++)e[r][t]=0}for(var r=0;worldWidth>r;r++)for(var t=0;worldHeight>t;t++)Math.random()<chanceToStartAlive&&(e[r][t]=destructibleWallIndex);return e}function doSimulationStep(e){for(var r=[[]],t=0;t<e.length;t++){r[t]=[];for(var a=0;a<e[0].length;a++){var i=countAliveNeighbours(e,t,a);r[t][a]=e[t][a]>0?deathLimit>i?0:destructibleWallIndex:i>birthLimit?destructibleWallIndex:0}}return r}function countAliveNeighbours(e,r,t){for(var a=0,i=-1;2>i;i++)for(var o=-1;2>o;o++){var l=i+r,n=o+t;0==i&&0==o||(0>l||0>n||l>=e.length||n>=e[0].length?a+=1:e[l][n]==destructibleWallIndex&&(a+=1))}return a}var STATES={MENU:"menuState",GAME:"gameState",WIN:"winState",LOSE:"loseState"},currentState=STATES.MENU,canvas=document.getElementById("myCanvas"),ctx=canvas.getContext("2d"),tileSize=32,rowTileCount=48,colTileCount=48,horsesPending=4,destructibleWallProbability=1,playerAlive=!0,camera={x:0,y:0},hero={speed:1,x:0,y:0,hp:10,attack:3},enemies=[],playerHasMoved=!1,canPressKey=!0,keysDown={};addEventListener("keydown",function(e){canPressKey&&(playerHasMoved=!1,keysDown[e.keyCode]=!0,canPressKey=!1)},!1),addEventListener("keyup",function(e){delete keysDown[e.keyCode],canPressKey=!0},!1);var groundLayer=[],topLayer=[[]],reset=function(){horsesPending=4,playerAlive=!0,enemies=[],hero={speed:1,x:0,y:0,hp:10,attack:3},groundLayer=generateBackground(),topLayer=createWorld(),generateEnemies(),enemies.forEach(function(e){topLayer[e.y][e.x]=0}),hero.x=1,hero.y=1,topLayer[hero.y][hero.x]=0},isHorse=function(e,r){var t=topLayer[e][r];return t==horse1||t==horse2||t==horse3||t==horse4?(topLayer[e][r]=0,horsesPending--,0>=horsesPending&&(currentState=STATES.WIN),!0):!1},isEnemy=function(e,r){var t=!1;return enemies.forEach(function(a){a.alive&&a.x==r&&a.y==e&&(t=!0,a.hp-=hero.attack,a.hp<=0&&(a.alive=!1))}),t},isTreasure=function(e,r){var t=topLayer[e][r];return t==treasureIndex?!0:!1},isHP=function(e,r){var t=topLayer[e][r];return t==healthPotionIndex?(hero.hp+=1,topLayer[e][r]=0,!0):!1},isHardWall=function(e,r){var t=topLayer[e][r];return t==hardWallIndex?!0:!1},isDestructibleWall=function(e,r){var t=topLayer[e][r];return t==destructibleWallIndex?!0:!1},moveToPlayer=function(e){if(e.alive&&playerAlive){var r=Math.abs(hero.x-e.x),t=Math.abs(hero.y-e.y),a=r+t;if(!(a>=15)){if(1==a)return hero.hp-=e.attack,void(hero.hp<=0&&(currentState=STATES.LOSE));if(t>r)if(hero.y>e.y){var i=e.y+1,o=e.x;isDestructibleWall(i,o)?topLayer[i][o]=0:e.y+=1}else{var i=e.y-1,o=e.x;isDestructibleWall(i,o)?topLayer[i][o]=0:e.y-=1}else if(hero.x>e.x){var i=e.y,o=e.x+1;isDestructibleWall(i,o)?topLayer[i][o]=0:e.x+=1}else{var i=e.y,o=e.x-1;isDestructibleWall(i,o)?topLayer[i][o]=0:e.x-=1}}}},KEY_UP=38,KEY_DOWN=40,KEY_LEFT=37,KEY_RIGHT=39,KEY_X=88,update=function(){if(currentState==STATES.MENU)return void(KEY_X in keysDown&&(currentState=STATES.GAME,player.src=jsfxr(sounds.start),player.play()));if(currentState==STATES.LOSE)return void(KEY_X in keysDown&&(currentState=STATES.MENU,reset()));if(currentState==STATES.WIN)return void(KEY_X in keysDown&&(currentState=STATES.MENU,reset()));if(KEY_UP in keysDown&&!playerHasMoved){var e=hero.y-1,r=hero.x;if(isDestructibleWall(e,r))topLayer[e][r]=0,player.src=jsfxr(sounds.dirt);else if(isTreasure(e,r)){var t=[1,2,1,1,1,1,1],a=Math.floor(Math.random()*t.length);hero.attack+=t[a],topLayer[e][r]=0,player.src=jsfxr(sounds.treasure)}else isHP(e,r)?player.src=jsfxr(sounds.hp):isHorse(e,r)?player.src=jsfxr(sounds.horse):isEnemy(e,r)?player.src=jsfxr(sounds.enemy):isHardWall(e,r)?player.src=jsfxr(sounds.move):(hero.y-=hero.speed,player.src=jsfxr(sounds.move));playerHasMoved=!0,enemies.forEach(moveToPlayer),player.play()}if(KEY_DOWN in keysDown&&!playerHasMoved){var e=hero.y+1,r=hero.x;if(isDestructibleWall(e,r))topLayer[e][r]=0,player.src=jsfxr(sounds.dirt);else if(isTreasure(e,r)){var t=[1,2,1,1,1,1,1],a=Math.floor(Math.random()*t.length);hero.attack+=t[a],topLayer[e][r]=0,player.src=jsfxr(sounds.treasure)}else isHP(e,r)?player.src=jsfxr(sounds.hp):isHorse(e,r)?player.src=jsfxr(sounds.horse):isEnemy(e,r)?player.src=jsfxr(sounds.enemy):isHardWall(e,r)?player.src=jsfxr(sounds.move):(hero.y+=hero.speed,player.src=jsfxr(sounds.move));playerHasMoved=!0,enemies.forEach(moveToPlayer),player.play()}if(KEY_LEFT in keysDown&&!playerHasMoved){var e=hero.y,r=hero.x-1;if(isDestructibleWall(e,r))topLayer[e][r]=0,player.src=jsfxr(sounds.dirt);else if(isTreasure(e,r)){var t=[1,2,1,1,1,1,1],a=Math.floor(Math.random()*t.length);hero.attack+=t[a],topLayer[e][r]=0,player.src=jsfxr(sounds.treasure)}else isHP(e,r)?player.src=jsfxr(sounds.hp):isHorse(e,r)?player.src=jsfxr(sounds.horse):isEnemy(e,r)?player.src=jsfxr(sounds.enemy):isHardWall(e,r)?player.src=jsfxr(sounds.move):(hero.x-=hero.speed,player.src=jsfxr(sounds.move));playerHasMoved=!0,enemies.forEach(moveToPlayer),player.play()}if(KEY_RIGHT in keysDown&&!playerHasMoved){var e=hero.y,r=hero.x+1;if(isDestructibleWall(e,r))topLayer[e][r]=0,player.src=jsfxr(sounds.dirt);else if(isTreasure(e,r)){var t=[1,2,1,1,1,1,1],a=Math.floor(Math.random()*t.length);hero.attack+=t[a],topLayer[e][r]=0,player.src=jsfxr(sounds.treasure)}else isHP(e,r)?player.src=jsfxr(sounds.hp):isHorse(e,r)?player.src=jsfxr(sounds.horse):isEnemy(e,r)?player.src=jsfxr(sounds.enemy):isHardWall(e,r)?player.src=jsfxr(sounds.move):(hero.x+=hero.speed,player.src=jsfxr(sounds.move));playerHasMoved=!0,enemies.forEach(moveToPlayer),player.play()}camera.x=hero.x-Math.floor(canvas.width/tileSize/2),camera.y=hero.y-Math.floor(canvas.height/tileSize/2)},drawHero=function(){ctx.drawImage(tilesetImage,3*tileSize,2*tileSize,tileSize,tileSize,(hero.x-camera.x)*tileSize,(hero.y-camera.y)*tileSize-10,tileSize,tileSize)},drawEnemy=function(e){if(e.alive){var r=0,t=0;switch(e.type){case redCentaurIndex:t=0,r=2;break;case blueCentaurIndex:t=3,r=1}ctx.drawImage(tilesetImage,t*tileSize,r*tileSize,tileSize,tileSize,(e.x-camera.x)*tileSize,(e.y-camera.y)*tileSize-10,tileSize,tileSize)}},generateFOW=function(){for(var e=[],r=0;rowTileCount>r;r++){for(var t=[],a=0;colTileCount>a;a++)t.push(0);e.push(t)}return e},drawFOW=function(){for(var e=generateFOW(),r=0;rowTileCount>r;r++)for(var t=0;colTileCount>t;t++){var a=Math.abs(hero.x-camera.x-t),i=Math.abs(hero.y-camera.y-r),o=a+i;e[r][t]=3>o?0:4>o?.3:5>o?.5:.7}for(var r=0;rowTileCount>r;r++)for(var t=0;colTileCount>t;t++)ctx.fillStyle="rgba(0, 0, 0,"+e[r][t]+")",ctx.fillRect(t*tileSize,r*tileSize,tileSize,tileSize)},render=function(){if(ctx.clearRect(0,0,canvas.width,canvas.height),currentState==STATES.GAME)bgReady&&(drawTiledBackground(),drawHero(),enemies.forEach(function(e){drawEnemy(e)}),drawFOW()),ctx.fillStyle="rgb(250, 250, 250)",ctx.font="24px Helvetica",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("HP: "+hero.hp+" A: "+hero.attack,32,0),ctx.fillText("Horses pending: "+horsesPending,480,0);else if(currentState==STATES.MENU){for(var e=[[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,0,0,0,.8,0,.8,0,.8,0,.8,0,0,.8,0,.8,.8,0,0,.8,.8,.8],[.8,0,.8,.8,.8,0,.8,0,.8,0,.8,0,.8,.8,0,.8,.8,0,.8,0,.8,.8],[.8,0,0,0,.8,0,0,0,.8,0,.8,0,0,.8,0,.8,.8,0,.8,0,.8,.8],[.8,.8,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,0,.8,.8,0,.8,0,.8,.8],[.8,0,0,0,.8,0,.8,0,.8,0,.8,0,0,.8,0,0,.8,0,0,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[0,0,0,0,0,.8,0,0,0,.8,0,.8,0,0,.8,.8,0,0,.8,0,0,0],[0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,0,.8,0],[0,.8,.8,.8,0,.8,0,0,0,.8,0,.8,0,.8,0,.8,0,0,.8,0,.8,0],[0,.8,.8,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,0,.8,0],[0,.8,.8,.8,0,.8,0,.8,0,.8,0,.8,0,0,.8,.8,0,0,.8,0,.8,0],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8]],r=0;r<canvas.height/tileSize;r++)for(var t=0;t<canvas.width/tileSize;t++){var a=hardWallIndex,i=a/imageNumTiles|0,o=a%imageNumTiles|0;ctx.drawImage(tilesetImage,o*tileSize,i*tileSize,tileSize,tileSize,t*tileSize,r*tileSize,tileSize,tileSize),ctx.fillStyle="rgba(0, 0, 0,"+e[r][t]+")",ctx.fillRect(t*tileSize,r*tileSize,tileSize,tileSize)}ctx.fillStyle="rgb(100, 177, 164)",ctx.font="24px Helvetica",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("– Press X to START your adventure – ",150,420),ctx.drawImage(tilesetImage,3*tileSize,2*tileSize,tileSize,tileSize,3*tileSize,13*tileSize,tileSize,tileSize)}else if(currentState==STATES.LOSE){for(var e=[[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,0,0,.8,.8,0,0,.8,0,0,0,.8,0,0,.8,.8,.8,.8,.8,.8,.8,.8],[.8,0,.8,0,.8,0,.8,.8,0,.8,0,.8,0,.8,0,.8,.8,.8,.8,.8,.8,.8],[.8,0,.8,0,.8,0,0,.8,0,0,0,.8,0,.8,0,.8,.8,.8,.8,.8,.8,.8],[.8,0,.8,0,.8,0,.8,.8,0,.8,0,.8,0,.8,0,.8,.8,.8,.8,.8,.8,.8],[.8,0,0,.8,.8,0,0,.8,0,.8,0,.8,0,0,.8,.8,0,.8,0,.8,0,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8]],r=0;r<canvas.height/tileSize;r++)for(var t=0;t<canvas.width/tileSize;t++){var a=hardWallIndex,i=a/imageNumTiles|0,o=a%imageNumTiles|0;ctx.drawImage(tilesetImage,o*tileSize,i*tileSize,tileSize,tileSize,t*tileSize,r*tileSize,tileSize,tileSize),ctx.fillStyle="rgba(0, 0, 0,"+e[r][t]+")",ctx.fillRect(t*tileSize,r*tileSize,tileSize,tileSize)}ctx.fillStyle="rgb(100, 177, 164)",ctx.font="24px Helvetica",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("– An honorable death... Press X to RETRY –",130,420)}else if(currentState==STATES.WIN){for(var e=[[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,0,.8,.8,.8,0,.8,0,.8,0,0,0,.8,0,.8,0,.8,0,.8,.8,.8],[.8,.8,0,.8,.8,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,.8],[.8,.8,0,.8,.8,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,.8],[.8,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,0,0,0,0,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,0,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8],[.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8,.8]],r=0;r<canvas.height/tileSize;r++)for(var t=0;t<canvas.width/tileSize;t++){var a=hardWallIndex,i=a/imageNumTiles|0,o=a%imageNumTiles|0;ctx.drawImage(tilesetImage,o*tileSize,i*tileSize,tileSize,tileSize,t*tileSize,r*tileSize,tileSize,tileSize),ctx.fillStyle="rgba(0, 0, 0,"+e[r][t]+")",ctx.fillRect(t*tileSize,r*tileSize,tileSize,tileSize)}ctx.fillStyle="rgb(100, 177, 164)",ctx.font="24px Helvetica",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("– You may enter Valhalla – ",200,420)}},main=function(){var e=Date.now(),r=e-then;update(r/1e3),render(),then=e,requestAnimationFrame(main)},redCentaurIndex=8,blueCentaurIndex=7,getEnemy=function(e){var r={speed:1,x:0,y:0,hp:0,attack:1,alive:!0};switch(r.type=e,r.x=Math.floor(Math.random()*(colTileCount-2)+1),r.y=Math.floor(Math.random()*(rowTileCount-2)+1),e){case redCentaurIndex:r.hp=9;break;case blueCentaurIndex:r.hp=10}return r},generateEnemies=function(){var e=[redCentaurIndex,blueCentaurIndex],r=15;for(i=0;r>i;i++){var t=Math.floor(Math.random()*e.length),a=getEnemy(e[t]);enemies.push(a)}},hardWallIndex=12,destructibleWallIndex=2,backgroundIndex=1,getBackgroundRow=function(){for(var e=[],r=0;colTileCount>r;r++)e.push(backgroundIndex);return e},generateBackground=function(){for(var e=[],r=0;rowTileCount>r;r++)e.push(getBackgroundRow());return e},getFullRowWall=function(){for(var e=[],r=0;colTileCount>r;r++)e.push(hardWallIndex);return e},bgReady=!1,tilesetImage=new Image;tilesetImage.src="js13k.png",tilesetImage.onload=function(){bgReady=!0};var imageNumTiles=4,world=[[]],worldWidth=rowTileCount,worldHeight=colTileCount,tileWidth=32,tileHeight=32,horse1=3,horse2=4,horse3=5,horse4=6,healthPotionIndex=15,treasureIndex=14,w=window;requestAnimationFrame=w.requestAnimationFrame||w.webkitRequestAnimationFrame||w.msRequestAnimationFrame||w.mozRequestAnimationFrame;var then=Date.now();reset(),main();