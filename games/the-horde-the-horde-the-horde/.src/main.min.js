window.addEventListener("load",function(){function la(c,b){this.x=c;this.y=b;this.radius=1;this.update=function(f,h){this.radius+=.05};this.attacked=function(){this.radius-=1.5;0>this.radius&&(this.radius=0)};this.render=function(){a.save();a.globalAlpha=.75;a.fillStyle="red";a.beginPath();a.moveTo(0,0);a.arc(0,0,this.radius,0,.5*Math.PI);a.closePath();a.fill();a.restore()}}function ma(c,b,f,h,B,na){this.x=c;this.y=b;this.speed=na;this.alive=!1;B?this.radius=B:(this.width=f,this.height=h);this.update=
function(oa){this.alive&&(0<this.x+this.width?this.x-=this.speed*oa:(this.alive=!1,this.x=cvs.width+this.width,10>E?I=1E3:10<E&&30>E?I=500:30<E&&(I=300),t=setTimeout(X,I)))};this.render=function(){a.drawImage(O,this.x,this.y)}}function pa(c,b,f,h){this.x=c;this.y=b;this.radius=f;this.angle=h;this.onBridge=this.wasRescued=this.isDead=this.reachedTarget=!1;this.imageIndex=u(0,7);this.speed=L(.1,.33);this.hasPanicked=!1;this.panicCountdown=3E3;this.panic=function(){this.hasPanicked||(this.hasPanicked=
!0,this.speed=2,this.angle=0==u(0,10)%2?L(.55*Math.PI,.9*Math.PI):L(.2,.4*Math.PI))};this.update=function(B){this.hasPanicked?(this.x+=this.speed*Math.cos(this.angle),this.y+=this.speed*Math.sin(this.angle)):this.y+=this.speed/(.2*this.radius)*B};this.render=function(){a.save();a.beginPath();a.drawImage(P,16*this.imageIndex,0,16,16,this.x-this.radius,this.y-this.radius,16,16);a.closePath();this.hasPanicked&&(a.fillStyle="red",a.font="italic 32px impact",a.fillText("!!!",this.x,this.y-this.radius));
a.restore()}}function qa(){for(var c=0,b=v.length;c<b;c++)v[c].y+=20;g=v.splice(0,4)}function ra(){for(var c=0,b=w.length;c<b;c++)w[c].y-=20;k=w.splice(0,4)}function Y(){for(var c=m.x,b=10,f=0;50>f;f++){for(var h=0;4>h;h++)v.push(new pa(c+10,e.y-b,u(4,10),0)),c+=20;c=m.x;b+=20}g=v.splice(0,4)}function sa(c,b,f,h){this.x=c;this.y=b;this.radius=f;this.angle=h;this.wasRescued=this.isDead=this.reachedTarget=!1;this.imageIndex=u(0,3);this.speed=.4;this.update=function(B){this.y-=this.speed/(.2*this.radius)*
B};this.render=function(){a.save();a.drawImage(Z,16*this.imageIndex,0,16,16,this.x-this.radius,this.y-this.radius,16,16);a.restore()}}function aa(){for(var c=n.x,b=m.y+m.height/2,f=0;50>f;f++){for(var h=0;4>h;h++)w.push(new sa(c+10,b,8,0)),c+=20;c=n.x;b+=20}k=w.splice(0,4)}function ta(c){F=!1}function ua(c){F=!1}function va(c){z||C||x||(F=!0)}function wa(c){switch(r){case "menu":80===c.keyCode?(r="game",M=!0,Q(),x=!0):84===c.keyCode&&(C=!0,r="game",N());break;case "gameover":77===c.keyCode&&(r="menu");
break;case "game":z?77===c.keyCode&&(r="menu",N()):C?80===c.keyCode?(r="game",Q()):77===c.keyCode&&(r="menu",N()):32===c.keyCode?(x=!x,M&&(M=!1)):81===c.keyCode&&x&&(r="menu",N())}}function xa(c){switch(r){case "game":if(!z&&!C&&!x){var b=ba-ca(c).x,f=b;if(!e.collision&&!e.isConnected)if(e.x-=f,0>=e.x&&(f=0,e.x=f),e.x+e.width>=G&&(f=G-e.width,e.x=f),H(e,{x:d.x,y:d.y-d.height,width:d.width,height:d.height}))e.x+=f;else for(var h=0,B=g.length;h<B;h++)g[h].onBridge&&(20>=Math.abs(b)?g[h].x-=f:(g[h].onBridge=
!1,g[h].isDead=!0,A++));f=b;if(!d.collision&&!d.isConnected)if(d.x+=f,0>=d.x&&(f=0,d.x=f),d.x+d.width>=G&&(f=G-d.width,d.x=f),H(e,{x:d.x,y:d.y-d.height,width:d.width,height:d.height}))d.x-=b;else for(b=0,h=k.length;b<h;b++)k[b].onBridge&&(k[b].x+=f)}}ba=ca(c).x}function ca(c){var b=cvs.getBoundingClientRect();return{x:c.clientX-b.left,y:c.clientY-b.top}}function u(c,b){c=Math.ceil(c);b=Math.floor(b);return Math.floor(Math.random()*(b-c+1))+c}function L(c,b){return Math.random()*(b-c)+c}function H(c,
b){return c.x<b.x+b.width&&c.x+c.width>b.x&&c.y<b.y+b.height&&c.height+c.y>b.y?!0:!1}function N(){e={x:440,y:p.height,width:80,height:40,isConnected:!1,collision:!1};d={x:n.x,y:l.y-40,width:80,height:40,isConnected:!1,collision:!1};t&&clearTimeout(t);E=0;I=500;t=null;z=x=!1;q=[];v=[];g=[];w=[];k=[];A=R=S=0;y&&(y.radius=0);for(var c=0;1>c;c++)Y(),aa()}function Q(){T.src="images/left-arrows.png";U.src="images/up-arrows.png";P.src="images/faces_mono.png";Z.src="images/shields_mono.png";J.src="images/tree.png";
K.src="images/bridge-1.png";da.src="images/bottom-dock-and-path.png";ea.src="images/top-dock-and-path.png";V.src="images/top-footpath.png";O.src="images/basic-damaged-boat-filled.png";cvs.addEventListener("mousedown",va,!1);document.addEventListener("mousemove",xa,!1);cvs.addEventListener("mouseup",ta,!1);cvs.addEventListener("mouseleave",ua,!1);document.addEventListener("keyup",wa,!1);F=x=C=z=!1;q=[];v=[];g=[];w=[];k=[];E=A=R=S=0;I=500;t=null;e={x:440,y:p.height,width:80,height:40,isConnected:!1,
collision:!1};d={x:n.x,y:l.y-40,width:80,height:40,isConnected:!1,collision:!1};y&&(y.radius=0);for(var c=0;20>c;c++){var b=u(288,376);q.push(new ma(1024+u(96,384),b,96,96,null,L(.06,.09)))}for(c=0;1>c;c++)Y(),aa();t=setTimeout(X,2E3);y=new la(0,0)}function ya(c){switch(r){case "game":if(!z&&!C&&!x){if(F){if(H(e,{x:d.x,y:l.y-d.height,width:d.width,height:d.height}))break;e.collision?(e.isConnected=!1,40<e.height&&(e.height-=4)):H({x:e.x+e.width/2-1,y:e.y+e.height,width:2,height:2},{x:m.x+m.width/
2-1,y:m.y,width:2,height:2})?e.isConnected=!0:(316>e.height&&(e.height+=2),e.isConnected=!1);d.collision?(d.isConnected=!1,40<d.height&&(d.height-=4)):H({x:d.x+d.width/2-1,y:l.y-d.height,width:2,height:2},{x:n.x+n.width/2-1,y:n.y+n.height-2,width:2,height:2})?d.isConnected=!0:(318>d.height&&(d.height+=2),d.isConnected=!1)}else e.isConnected=!1,d.isConnected=!1,40<e.height&&(e.height-=e.collision?4:1),40<d.height&&(d.height-=d.collision?4:1);for(var b=0,f=q.length;b<f;b++)q[b].update(c),!e.collision&&
H(q[b],e)&&(e.isConnected=!1,e.height-=u(5,15),e.collision=!0,F=!1,setTimeout(function(){e.collision=!1},3E3)),!d.collision&&H(q[b],{x:d.x,y:l.y-d.height,width:d.width,height:d.height})&&(d.isConnected=!1,d.height-=u(5,15),d.collision=!0,F=!1,setTimeout(function(){d.collision=!1},3E3));if(e.isConnected)for(b=0,f=g.length;b<f;b++)g[b].waitingToCross=!1,g[b].isDead||g[b].wasRescued||(g[b].panicCountdown=3E3,g[b].update(c),g[b].x>=e.x&&g[b].x<=e.x+e.width&&g[b].y>=e.y&&g[b].y<=e.y+e.height&&(g[b].onBridge=
!0),g[b].y>W&&(g[b].wasRescued=!0,S++));else{b=0;for(f=g.length;b<f;b++)g[b].isDead||g[b].wasRescued||(g[b].hasPanicked?(g[b].update(c),300<g[b].y&&(g[b].onBridge=!1,g[b].isDead=!0,A++)):g[b].y>e.y+e.height&&g[b].y-g[b].radius<m.y+m.height&&(g[b].onBridge=!1,g[b].isDead=!0,A++));b=0;for(f=g.length;b<f;b++)g[b].isDead||g[b].wasRescued||(g[b].waitingToCross=!0,5<=g[b].panicCountdown?g[b].panicCountdown-=5:g[b].panic())}if(d.isConnected)for(b=0,f=k.length;b<f;b++)k[b].isDead||k[b].wasRescued||(k[b].update(c),
k[b].onBridge=k[b].x>=d.x&&k[b].x<=d.x+d.width&&k[b].y>=d.y-d.height?!0:!1,105>=k[b].y&&(k[b].wasRescued=!0,za++,y.attacked()));else for(b=0,f=k.length;b<f;b++)!k[b].isDead&&!k[b].wasRescued&&k[b].y<=l.y-d.height&&(k[b].onBridge=!1,k[b].isDead=!0,R++);for(b=g.length-1;0<=b;--b)(g[b].isDead||g[b].wasRescued)&&g.splice(b,1);for(b=k.length-1;0<=b;--b)(k[b].isDead||k[b].wasRescued)&&k.splice(b,1);y.update(c,0);0===g.length&&qa();0===k.length&&ra();245<=y.radius?(z=!0,t&&clearTimeout(t)):35<A&&(z=!0,t&&
clearTimeout(t))}}}function fa(){a.drawImage(V,m.x,0);a.drawImage(V,n.x,m.y)}function ha(){a.drawImage(ea,n.x-32,n.y-44,144,64);a.drawImage(da,m.x-32,m.y,144,64)}function ia(){for(var c,b=220,f=0;11>=f;f++){c=0==f%2?-10:10;for(var h=0;6>=h;h++)a.drawImage(J,b,c),c+=30;b+=18}b=512;for(f=0;27>=f;f++){c=0==f%2?-10:10;for(h=0;6>=h;h++)a.drawImage(J,b,c),c+=30;b+=18}b=-16;for(f=0;5>=f;f++){c=0==f%2?l.y:l.y+10;for(h=0;4>=h;h++)a.drawImage(J,b,c),c+=30;b+=18}b=174;for(f=0;11>=f;f++){c=0==f%2?l.y:l.y+10;
for(h=0;4>=h;h++)a.drawImage(J,b,c),c+=30;b+=18}b=550;for(f=0;25>=f;f++){c=0==f%2?l.y:l.y+10;for(h=0;4>=h;h++)a.drawImage(J,b,c),c+=30;b+=18}}function ja(){var c=Date.now()-ka;ya(c);a.clearRect(0,0,cvs.width,cvs.height);switch(r){case "menu":a.fillStyle="#3cacd7";a.fillRect(D.x,D.y,D.width,D.height);a.fillStyle="#472d42";a.fillRect(p.x,p.y,p.width,p.height);a.fillRect(l.x,l.y,l.width,l.height);a.drawImage(K,e.x,e.y,e.width,e.height);a.drawImage(K,d.x,l.y-d.height,d.width,d.height);ha();fa();ia();
a.fillStyle="white";a.roundRect(256,170,512,300,[10]);a.fill();a.lineWidth=8;a.beginPath();a.strokeStyle="#e6482e";a.roundRect(251,165,522,310,[10]);a.stroke();a.strokeStyle="#f4b41b";a.beginPath();a.roundRect(256,170,512,300,[10]);a.stroke();a.restore();a.fillStyle="black";a.font="36px impact";a.fillText("The Horde! The Horde! The Horde!",268,210);a.font="20px impact";a.fillText("The Horde have destroyed nearby cities and ports. Our city",270,260);a.fillText("may be next! Help your fellow citizens flee to safety and get",
270,280);a.fillText("our mighty soldiers across the river to battle The Horde!",270,300);a.fillText("Alas, a cruel and cunning enemy spy destroyed the existing",270,340);a.fillText("bridges. Fear not! Some highly confident but, not so skilled,",270,360);a.fillText("citizens have built fancy extendable makeshift ones!",270,380);a.fillText("Press 'P' to Play or 'T' for a Tutorial...",370,428);break;case "game":a.fillStyle="#3cacd7";a.fillRect(D.x,D.y,D.width,D.height);a.fillStyle="#472d42";a.fillRect(p.x,
p.y,p.width,p.height);a.fillRect(l.x,l.y,l.width,l.height);c=0;for(var b=q.length;c<b;c++)q[c].render();a.fillStyle="grey";e.collision&&(a.fillStyle="red");a.fillRect(e.x,e.y,e.width,e.height);a.drawImage(K,e.x,e.y,e.width,e.height);a.fillStyle="grey";d.collision&&(a.fillStyle="red");a.fillRect(d.x,l.y-d.height,d.width,d.height);a.drawImage(K,d.x,l.y-d.height,d.width,d.height);ha();fa();c=0;for(b=v.length;c<b;c++)v[c].render();c=0;for(b=g.length;c<b;c++)g[c].render();c=0;for(b=w.length;c<b;c++)w[c].render();
c=0;for(b=k.length;c<b;c++)k[c].render();ia();y.render();a.strokeStyle="#f4b41b";a.strokeRect(e.x+e.width/2-1,e.y+e.height-2,2,2);a.strokeRect(m.x+m.width/2-1,m.y,2,2);a.strokeStyle="#e6482e";a.strokeRect(d.x+d.width/2-1,l.y-d.height,2,2);a.strokeRect(n.x+n.width/2-1,n.y+n.height-2,2,2);a.restore();x&&(a.save(),a.fillStyle="white",a.roundRect(380,255,300,200,[10]),a.fill(),a.restore(),a.save(),a.lineWidth=8,a.beginPath(),a.strokeStyle="#e6482e",a.roundRect(375,250,310,210,[10]),a.stroke(),a.strokeStyle=
"#f4b41b",a.beginPath(),a.roundRect(380,255,300,200,[10]),a.stroke(),a.restore(),a.save(),a.fillStyle="black",a.font="36px impact",a.fillText("PAUSED",468,300),a.font="24px impact",M?(a.fillText("Please place your cursor",408,338),a.fillText("here before starting!",408,364),a.fillText("SPACE to unpause",448,398),a.fillText("'Q' to quit",473,434)):(a.fillText("SPACE to unpause",448,348),a.fillText("'Q' to quit",473,394)),a.restore());C&&(a.drawImage(U,40,0,40,108,120,360,40,108),a.drawImage(T,48,0,
48,48,180,570,48,48),a.save(),a.fillStyle="white",a.roundRect(230,500,150,120,[10]),a.fill(),a.restore(),a.save(),a.lineWidth=8,a.beginPath(),a.strokeStyle="#e6482e",a.roundRect(230,500,150,120,[10]),a.stroke(),a.restore(),a.drawImage(U,0,0,40,108,460,290,40,108),a.drawImage(T,0,0,48,48,524,90,48,48),a.save(),a.fillStyle="white",a.roundRect(568,50,220,220,[10]),a.fill(),a.restore(),a.save(),a.lineWidth=8,a.beginPath(),a.strokeStyle="#f4b41b",a.roundRect(568,50,220,220,[10]),a.stroke(),a.restore(),
a.save(),a.fillStyle="white",a.roundRect(176,258,260,220,[10]),a.fill(),a.restore(),a.drawImage(O,925,285),a.save(),a.fillStyle="white",a.roundRect(800,380,210,150,[10]),a.fill(),a.restore(),a.save(),a.fillStyle="white",a.roundRect(48,16,160,120,[10]),a.fill(),a.restore(),a.save(),a.fillStyle="white",a.roundRect(760,560,240,50,[10]),a.fill(),a.restore(),a.save(),a.beginPath(),a.strokeStyle="#e6482e",a.roundRect(756,555,250,60,[10]),a.stroke(),a.restore(),a.save(),a.lineWidth=8,a.beginPath(),a.strokeStyle=
"#f4b41b",a.roundRect(760,560,240,50,[10]),a.stroke(),a.restore(),a.save(),a.fillStyle="black",a.font="16px impact",a.fillText("Press 'M' to return to Main Menu...",770,590),a.restore(),a.save(),a.font="16px impact",a.fillStyle="black",a.fillText("Beware The Horde!",60,40),a.fillText("They are deadly and",60,60),a.fillText("it will take many of",60,80),a.fillText("our mighty troops to",60,100),a.fillText("to defeat them!",60,120),a.restore(),a.save(),a.font="16px impact",a.fillStyle="black",a.fillText("Avoid hitting damaged ships",
814,408),a.fillText("set adrift from the attacked",814,428),a.fillText("city up river.",814,448),a.fillText("Moving a bridge too fast can",814,478),a.fillText("make people fall off and",814,498),a.fillText("drown!",814,518),a.restore(),a.save(),a.font="16px impact",a.fillStyle="black",a.fillText("Get our mighty",250,525),a.fillText("troops across as",250,545),a.fillText("fast as you can so",250,565),a.fillText("they can defeat",250,585),a.fillText("the Horde!",250,605),a.restore(),a.save(),a.font=
"16px impact",a.fillStyle="black",a.fillText("Hold the LEFT mouse button down to",190,290),a.fillText("extend and connect each bridge to",190,310),a.fillText("its opposite dock.",190,330),a.fillText("Citizens and troops automatically",190,360),a.fillText("start to move when their bridge",190,380),a.fillText("connects to their dock.",190,400),a.fillText("Move bridges LEFT or RIGHT by",190,430),a.fillText("moving the mouse LEFT or RIGHT.",190,450),a.restore(),a.save(),a.font="16px impact",a.fillStyle=
"black",a.fillText("Help fellow citizens escape",590,84),a.fillText("The Horde by getting them",590,104),a.fillText("safely across the river.",590,124),a.fillText("If left waiting too long they",590,154),a.fillText("will start to panic and try to",590,174),a.fillText("cross the river without the",590,194),a.fillText("bridge...and drown!",590,214),a.fillStyle="#7a444a",a.fillRect(660,250,16,16),a.drawImage(P,16,0,16,16,660,250,16,16),a.fillStyle="red",a.font="italic 32px impact",a.fillText("!!!",656,
248),a.restore());C||(a.font="36px impact",a.fillStyle="#472d42",a.fillRect(800,W-55,220,50),a.fillStyle="white",a.fillText("DROWNED: "+A,815,cvs.height-15));z&&(a.fillStyle="white",a.roundRect(256,170,512,240,[10]),a.fill(),a.lineWidth=8,a.beginPath(),a.strokeStyle="#e6482e",a.roundRect(251,165,522,250,[10]),a.stroke(),a.strokeStyle="#f4b41b",a.beginPath(),a.roundRect(256,170,512,240,[10]),a.stroke(),a.restore(),a.fillStyle="black",a.font="36px impact",a.fillText("GAME OVER!",430,210),a.font="20px impact",
245<=y.radius?(a.fillText("We are doomed! The Horde have overrun the landing dock!",274,260),a.fillText("You did not get enough of our mighty troops across to fight",274,290),a.fillText("them in delicious combat! Did you do it on purpose?",274,310),a.fillText("ARE YOU SECRETLY ONE OF THE HORDE?!",274,340),a.fillText("Press 'M' to return to the main menu...",360,378)):35<=A&&(a.fillText("WHAT?! "+A+" people died trying to cross the river! You were",274,260),a.fillText("meant to S-A-V-E your fellow citizens, not K-I-L-L them!",
274,280),a.fillText("Unless you secretly work for The Horde, in which case you",274,310),a.fillText("probably did a good job. But WE have to execute YOU now!",274,330),a.fillText("Press 'M' to return to the main menu...",360,378)))}ka=Date.now();window.requestAnimationFrame(ja)}var G=cvs.width,W=cvs.height,a=cvs.getContext("2d"),p={x:0,y:0,width:G,height:224},l={x:0,y:W-100,width:G,height:100},D={x:0,y:p.height,width:G,height:l.y},e={x:440,y:p.height,width:80,height:40,isConnected:!1,collision:!1},
n={x:100,y:p.height-20,width:80,height:20},d={x:n.x,y:l.y-40,width:80,height:40,isConnected:!1,collision:!1},m={x:440,y:l.y,width:80,height:20},y=null,E=0,q=[],X=function(){u(0,q.length-1);do var c=u(0,q.length-1);while(!0===q[c].alive);q[c].alive=!0;E++},g=[],v=[],k=[],w=[],F=!1,ba=cvs.width/2,x=!1,I=500,t=null,P=new Image,Z=new Image,K=new Image,da=new Image,ea=new Image,V=new Image,O=new Image,J=new Image,T=new Image,U=new Image,z=!1,r="menu",C=!1,M=!0,S=0,A=0,za=0,R=0,ka=Date.now();Q();window.requestAnimationFrame(ja)},
!1);