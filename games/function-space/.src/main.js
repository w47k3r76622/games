(()=>{"use strict";class t{constructor(){this.urlRecord={},this.pool={}}add(t,e){void 0===this.urlRecord[t]&&(this.urlRecord[t]=e)}async preload(){let t=Object.entries(this.urlRecord).map((([t,e])=>({key:t,value:e}))).map((t=>new e(t)));return(await Promise.all(t)).forEach((t=>{this.pool[t.key]=t.img})),!0}get(t){return this.pool[t]}}function e(t){return new Promise((function(e){let i=new Image;i.src=t.value,i.onload=s=>{e({key:t.key,img:i})}}))}const i=[];i.push({inputNodes:[{x:60,y:100,value:1},{x:60,y:200,value:2},{x:60,y:300,value:3}],outputNodes:[{x:400,y:100},{x:400,y:200},{x:400,y:300}],machineNodes:[{x:230,y:100},{x:230,y:200},{x:230,y:300}],lines:[{in:0,out:0,between:[0],target:2},{in:1,out:1,between:[1],target:5},{in:2,out:2,between:[2],target:9}],machines:[{type:1,param:3},{type:2,param:2},{type:3}]}),i.push({inputNodes:[{x:40,y:100,value:2},{x:40,y:300,value:4}],outputNodes:[{x:360,y:100},{x:360,y:300}],machineNodes:[{x:200,y:200}],lines:[{in:0,out:1,between:[0],target:4},{in:1,out:0,between:[0],target:8}],machines:[{type:1,param:2},{type:1,param:4},{type:2,param:2},{type:2,param:4}]}),i.push({inputNodes:[{x:50,y:200,value:6}],outputNodes:[{x:350,y:200}],machineNodes:[{x:200,y:100},{x:200,y:200},{x:200,y:300}],lines:[{in:0,out:0,between:[0,1,2],target:50}],machines:[{type:1,param:1},{type:3}]}),i.push({inputNodes:[{x:50,y:350,value:1}],outputNodes:[{x:350,y:150}],machineNodes:[{x:150,y:150},{x:250,y:350}],lines:[{in:0,out:0,between:[0,1],target:0}],machines:[{type:1,param:1},{type:5}]}),i.push({inputNodes:[{x:50,y:50,value:5}],outputNodes:[{x:400,y:400},{x:250,y:400}],machineNodes:[{x:150,y:150},{x:250,y:150},{x:250,y:250}],lines:[{in:0,out:0,between:[0,2],target:25},{in:0,out:1,between:[0,1,2],target:16}],machines:[{type:1,param:1},{type:3},{type:5}]}),i.push({inputNodes:[{x:150,y:50,value:3},{x:350,y:50,value:6}],outputNodes:[{x:150,y:400},{x:350,y:400}],machineNodes:[{x:150,y:150},{x:150,y:250}],lines:[{in:0,out:0,between:[0,1],target:1},{in:1,out:1,between:[0,1],target:2}],machines:[{type:2,param:.2},{type:2,param:.4},{type:2,param:.5},{type:4}]}),i.push({inputNodes:[{x:100,y:50,value:9}],outputNodes:[{x:250,y:200}],machineNodes:[{x:100,y:300},{x:400,y:300},{x:400,y:50},{x:250,y:50}],lines:[{in:0,out:0,between:[0,1,2,3],target:5}],machines:[{type:2,param:.5},{type:4},{type:5}]}),i.push({inputNodes:[{x:50,y:150,value:1},{x:50,y:250,value:2},{x:170,y:50,value:3},{x:290,y:50,value:4}],outputNodes:[{x:410,y:150},{x:410,y:250},{x:170,y:400},{x:290,y:400}],machineNodes:[{x:170,y:150},{x:290,y:150},{x:170,y:250},{x:290,y:250}],lines:[{in:0,out:0,between:[0,1],target:36},{in:1,out:1,between:[2,3],target:16},{in:2,out:2,between:[0,2],target:10},{in:3,out:3,between:[1,3],target:96}],machines:[{type:1,param:2},{type:1,param:5},{type:2,param:4},{type:2,param:6},{type:3}]}),i.push({inputNodes:[{x:120,y:20,value:13},{x:260,y:20,value:12},{x:400,y:20,value:10}],outputNodes:[{x:120,y:400},{x:260,y:400},{x:400,y:400}],machineNodes:[{x:120,y:120},{x:260,y:120},{x:400,y:120},{x:260,y:200},{x:400,y:200},{x:260,y:280}],lines:[{in:0,out:0,between:[0,3],target:6},{in:1,out:1,between:[1,3,5],target:5},{in:2,out:2,between:[2,4,5],target:2}],machines:[{type:1,param:-1},{type:2,param:.5},{type:4}]}),i.push({inputNodes:[{x:30,y:240,value:10},{x:30,y:30,value:-11}],outputNodes:[{x:400,y:210},{x:400,y:400}],machineNodes:[{x:100,y:100},{x:350,y:120},{x:300,y:360},{x:200,y:360},{x:90,y:320},{x:150,y:190}],lines:[{in:0,out:0,between:[0,1,2,3,4,5],target:2021},{in:1,out:1,between:[0,5,2],target:13}],machines:[{type:1,param:1},{type:2,param:2},{type:2,param:10},{type:3},{type:5}]});class s{constructor(t,e,i){this.sprite=t,this.clickListener=null!=i?i.bind(e):null}click(t){null!==this.clickListener&&this.sprite.isEnabled&&this.clickListener(t)}}class a{constructor(t,e,i){this.sprite=t,this.isHovered=!1,this.hoverListener=null!=i?i.bind(e):null}hover(t){this.sprite.isEnabled&&!this.isHovered&&this.toggleHovered(t,!0)}unhover(t){this.sprite.isEnabled&&this.isHovered&&this.toggleHovered(t,!1)}toggleHovered(t,e){this.isHovered=e,this.sprite.isInFocus=e,null!==this.hoverListener&&this.hoverListener(t,e)}}const h={amplitude:5,period:200};class n{constructor(t,e,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s,this.tag=0,this.rotateAngle=0,this.opacity=1,this.isVisible=!0,this.isAnchorCenter=!1,this.behaviorList=[],this.subSpriteList=[],this.parentSprite=null,this.behaviorBackup=[],this.autoRestart=!1,this.isPauseBehavior=!1,this.restartWaitTime=0,this.restartWaitedTime=0,this.blinkOpacity=0,this.blinkBehvaior=null,this.isEnabled=!0,this.cacheCanvas=document.createElement("canvas"),this.cacheCanvas.width=i,this.cacheCanvas.height=s,this.isDrawFromCache=!1,this.drawOnce=!1,this.drawn=!1,this.hasUpdate=!1,this.isInFocus=!1,this.clickableObject=null,this.hoverableObject=null}draw(t,e){this.isDrawFromCache?t.drawImage(this.cacheCanvas,0,0):(t.save(),this.drawItself(t,e),t.restore(),this.drawSubsprite(t,e))}drawFromCache(){let t=this.cacheCanvas.getContext("2d");this.isDrawFromCache=!1,this.draw(t),this.isDrawFromCache=!0}drawItself(t,e){}drawSubsprite(t,e){this.subSpriteList.length>0&&(t.save(),null===this.parentSprite&&t.translate(this.x,this.y),this.subSpriteList.forEach((function(i){i.isVisible&&(t.save(),t.translate(i.x,i.y),t.rotate(i.rotateAngle*Math.PI/180),!0===i.isAnchorCenter&&t.translate(-i.width/2,-i.height/2),t.globalAlpha=t.globalAlpha*i.opacity,i.draw(t,e),t.restore())}),this),t.restore())}update(t){let e=!1,i=this.subSpriteList.length;if(i>0)for(let s=0;s<i;s++)this.subSpriteList[s].update(t)&&(e=!0);let s=this.behaviorList.length;if(s>0){e=!0;for(let e=0;e<s;e++)this.behaviorList[e].execute(t);this.behaviorList=this.behaviorList.filter((function(t){return!t.finished}))}return this.isBehaviorDone()&&this.autoRestart&&(this.restartWaitedTime<this.restartWaitTime?this.restartWaitedTime+=t:this.restartBehavior()),this.hasUpdate&&(e=!0,this.hasUpdate=!1),e}clearBehavior(t=!1){this.behaviorList=[],t&&this.subSpriteList.forEach((function(e){e.clearBehavior(t)}),this)}addBehavior(t){t instanceof r&&(this.behaviorList.push(t),this.behaviorBackup.push(t))}addBehaviorWithDelay(t,e,i,s,a=0,h){setTimeout((()=>{let a=new t(this,e,i,s,h);this.addBehavior(a)}).bind(this),a)}stopBehavior(t){this.behaviorList.includes(t)&&t.stop(!1),this.autoRestart=!1}stopAllBehavior(t){this.behaviorList.forEach((function(e){e.stop(t)}),this),this.autoRestart=!1}restartBehavior(t=!1){this.restartWaitedTime=0,this.behaviorBackup.forEach((function(t){t.replay(),this.behaviorList.push(t)}),this),t&&this.subSpriteList.forEach((function(e){e.restartBehavior(t)}),this)}setAutoRestart(t=0){this.autoRestart=!0,this.restartWaitTime=t}isBehaviorDone(){return this.behaviorBackup.length>0&&0===this.behaviorList.length}addSubSprite(t,e=!0){t instanceof n&&(t.parentSprite=this,this.subSpriteList.push(t),e&&(this.width<t.x+t.width&&(this.width=t.x+t.width,this.cacheCanvas.width=this.width),this.height<t.y+t.height&&(this.height=t.y+t.height,this.cacheCanvas.height=this.height)))}removeSubSprite(t){let e=this.subSpriteList.indexOf(t);this.subSpriteList.splice(e,1)}clearSubSprite(t=!1){this.subSpriteList=[],t&&this.subSpriteList.forEach((function(e){e.clearSubSprite(t)}),this),this.hasUpdate=!0}placeSubSpriteTopToBottom(){this.subSpriteList.push(this.subSpriteList.shift())}clear(t=!0){this.clearSubSprite(t),this.clearBehavior(t)}click(t){this.clickableObject&&this.clickableObject.click(t)}hover(t){this.hoverableObject&&this.hoverableObject.hover(t)}unhover(t){this.hoverableObject&&this.hoverableObject.unhover(t)}setClickListener(t,e){this.clickableObject=new s(this,t,e)}setHoverListener(t,e){this.hoverableObject=new a(this,t,e)}setPos(t,e){this.x=t,this.y=e,this.hasUpdate=!0}setSize(t,e){this.width=t,this.height=e,this.hasUpdate=!0}isPointInside(t){let e=this.getRelativePos(t),i=e.x,s=e.y,a=i>0&&i<this.width,h=s>0&&s<this.height;return a&&h}setVisible(t){this.isVisible=t}isVisible(){return this.isVisible}setTop(){if(null!==this.parentSprite){let t=this.parentSprite.subSpriteList.indexOf(this);t!==this.parentSprite.subSpriteList.length-1&&(this.parentSprite.subSpriteList.splice(t,1),this.parentSprite.subSpriteList.push(this))}}setFadeInConfig({fromOpacity:t,beforeTime:e,fadeTime:i,dx:s=0,dy:a=0}){this.opacity=t,this.setFadeIn(t,e,i,s,a)}setFadeIn(t,e,i,s=0,a=0){let h=1-t;setTimeout((()=>{this.opacity=t,this.addBehaviorWithDelay(d,"opacity",h,i,0)}),e),0!==s&&(this.x-=s,this.addBehaviorWithDelay(u,"x",s,i,e)),0!==a&&(this.y-=a,this.addBehaviorWithDelay(u,"y",a,i,e))}blink(t){let e={};void 0!==t&&(e.repeatInterval=t),this.blinkBehvaior=this.addBehaviorWithDelay(l,"blinkOpacity",.5,-1,0,e)}stopBlink(){null!==this.blinkBehvaior&&(this.stopBehavior(this.blinkBehvaior),this.blinkBehvaior=null,this.blinkOpacity=0)}jellyShake(){let{amplitude:t,period:e}=h,i=new c(this,"width",t,e,h),s=new c(this,"height",-t,e,h);this.addBehavior(i),this.addBehavior(s)}getRelativePos(t){let e={x:t.x-this.x,y:t.y-this.y};return null!==this.parentSprite&&(e=this.parentSprite.getRelativePos(e)),e}getGlobalPos(){let t={x:this.x,y:this.y},e=this.parentSprite;for(;null!==e;)t.x+=e.x,t.y+=e.y,e=e.parentSprite;return t}}class r{constructor(t,e,i,s){this.sprite=t,this.variableName=e,this.changeFunction=i,this.isChangeFunctionIncremental=!1,this.interval=s,this.originalValue=this.sprite[this.variableName],this.passedTime=0,this.started=!1,this.finished=!1,this.lastChange=0,this.checkUnfinished=this.getCheckUnfinished().bind(this)}execute(t){if(!this.finished)if(this.passedTime+=t,this.checkUnfinished())if(this.isChangeFunctionIncremental)this.sprite[this.variableName]+=this.changeFunction(t);else{let t=this.changeFunction(this.passedTime);this.sprite[this.variableName]+=t-this.lastChange,this.lastChange=t}else this.stop(!0)}stop(t){this.finished=!0,t&&this.toEndValue()}toEndValue(){this.interval>0&&(this.sprite[this.variableName]=this.originalValue+this.changeFunction(this.interval))}getCheckUnfinished(){return this.interval>=0?function(){return this.passedTime<this.interval}:function(){return!0}}replay(){this.sprite[this.variableName]=this.originalValue,this.passedTime=0,this.lastChange=0,this.finished=!1}}class o extends r{constructor(t,e,i,s,a){super(t,e,(function(t){return t>=s?i:a(t/s)*i}),s)}}class l extends r{constructor(t,e,i,s,a){let h=2e3;void 0!==a&&void 0!==a.repeatInterval&&(h=a.repeatInterval);let n=void 0!==s&&s>0?s:h;super(t,e,(function(t){let e=t/n;return e%=1,(1-Math.cos(2*Math.PI*e))/2*i}),s)}}class c extends r{constructor(t,e,i,s,a){let h=1/a.period,n=i;super(t,e,(function(t){return t>=s?0:Math.sin(t*h*2*Math.PI)*n}),s)}}class d extends o{constructor(t,e,i,s){super(t,e,i,s,(t=>Math.pow(t,2)*(3-2*t)))}}class u extends o{constructor(t,e,i,s){super(t,e,i,s,(t=>t*(-1.6666666666666665*t+2.6666666666666665)))}}class p extends n{constructor(t,e,i,s,a,h="transparent"){super(t,e,i,s),this.width=i,this.height=s,this.color=a,this.borderColor=h,this.hasShadow=!1,this.borderWidth=1,this.lineJoin="bevel"}drawItself(t){t.save(),this.hasShadow&&(t.shadowColor="rgba(0, 0, 0, 0.6)",t.shadowBlur=5,t.shadowOffsetX=0,t.shadowOffsetY=0),t.lineWidth=this.borderWidth,t.lineJoin=this.lineJoin,t.strokeStyle=this.borderColor,t.strokeRect(0,0,this.width,this.height),t.restore(),t.fillStyle=this.color,t.fillRect(0,0,this.width,this.height),n.prototype.drawItself.apply(this,arguments)}setBGColor(t){this.color=t}setBorderWidth(t){this.borderWidth=t}toggleShadow(t){this.hasShadow=t}}class y extends n{constructor(t,e,i,s,a){super(t,e,i,s),this.imgName=a}drawItself(t,e){n.prototype.drawItself.apply(this,arguments);let i=e.get(this.imgName);t.drawImage(i,this.x,this.y,this.width,this.height)}}class g extends n{constructor(t,e,i,s,a){super(t,e,i,s),this.imgName=a}drawItself(t,e){n.prototype.drawItself.apply(this,arguments);let i=e.get(this.imgName),s=t.createPattern(i,"repeat");t.fillStyle=s,t.fillRect(0,0,this.width,this.height)}}let b="transparent",x="#333333",m="rgba(256, 256, 256, 0.4)",f="rgba(238, 238, 256, 0.4)",v="20px fantasy",S=30,L=0,w="bevel",C=0,I="#000000";class k extends n{constructor(t,e,i,s,a=""){super(t,e),this.width=i,this.height=s,this.textX=10,this.textY=0,this.textAlign="start",this.textBaseline="top",this.font=v,this.lineHeight=S,this.finalFillColor=b,this.finalTextColor=x,this.lineJoin=w,this.borderWidth=C,this.borderColor=I,this.textList=[],this.isLookDisabled=!1,void 0!==a&&this.textList.push(a)}drawItself(t){if(super.drawItself(t),t.save(),this.borderWidth>0&&(t.lineWidth=this.borderWidth,t.lineJoin=this.lineJoin,t.strokeStyle=this.borderColor,t.strokeRect(0,0,this.width,this.height)),t.fillStyle=this.finalFillColor,t.fillRect(0,0,this.width,this.height),this.isInFocus&&(t.fillStyle=m,t.fillRect(0,0,this.width,this.height)),this.blinkOpacity>0){t.save(),t.globalAlpha=t.globalAlpha*this.blinkOpacity;let e=t.createLinearGradient(0,0,this.width,0);e.addColorStop(0,f),e.addColorStop(.5,"transparent"),e.addColorStop(1,f),t.fillStyle=e,t.fillRect(0,0,this.width,this.height),t.fillStyle=f,t.fillRect(0,0,this.width,this.height),t.restore()}t.translate(L,L),t.fillStyle=this.finalTextColor,t.font=this.font,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline;for(let e=0;e<this.textList.length;e++){let i=this.textList[e];t.fillText(i,this.textX,this.textY+this.lineHeight*e)}this.isLookDisabled&&(t.fillStyle="rgba(255, 255, 255, 0.5)",t.fillRect(0,0,this.width,this.height)),t.restore()}setTextCenter(){this.textAlign="center",this.textX=this.width/2,this.setTextCenterY()}setTextCenterY(){this.textBaseline="middle",this.textY=this.height/2-(this.textList.length-1)*this.lineHeight/2}setTextAlign(t){if(["left","right","center"].includes(t)){switch(t){case"left":this.textX=0;break;case"right":this.textX=this.width;break;case"center":this.textX=this.width/2}this.textAlign=t}}setTextPos(t,e){this.textX=t,this.textY=e}setColor(t,e){this.finalFillColor=t,this.finalTextColor=e}setTextColor(t){this.finalTextColor=t}setBGColor(t){this.finalFillColor=t}setBorder(t,e){this.borderWidth=t,e&&(this.borderColor=e)}setFont(t){this.font=t}setFontSize(t){this.font=this.font.replace(/\d+/,t.toString()),this.setLineHeight(t)}setLineHeight(t){this.lineHeight=t}setLookDisabled(t){this.isLookDisabled=t,this.hasUpdate=!0}focus(t){this.isInFocus=t}appendText(...t){return!!t&&(t.forEach((t=>this.textList.push(t))),!0)}setText(t,e){if(void 0!==e&&"number"==typeof e||(e=0),e<this.textList.length)this.textList[e]=t;else{for(let t=this.textList.length;t<e;t++)this.textList.push("");this.textList.push(t)}return!0}setAllText(t){return!!t&&(t.forEach(((t,e)=>{e<this.textList.length?this.textList[e]=t:this.textList.push(t)})),!0)}}let T=400,B=1,F=.2,N=10,O=500,E=100,D=function(t){t.preventDefault();let e=this.getMousePos(t),i={globalPos:e},s=this.layerData.layerUI.subSpriteList.filter((t=>t.isVisible&&t.isEnabled));for(;s.length>0;){let t=s.shift();s=s.concat(t.subSpriteList.filter((t=>t.isVisible&&t.isEnabled))),void 0!==t.isPointInside&&null!==t.hoverableObject&&(this.hasUserInput=!0,t.isPointInside(e)?t.hover(i):t.unhover(i))}},A=function(t){if(t.preventDefault(),!this.isAllowInput)return;let e=this.getMousePos(t),i={globalPos:e},s=this.layerData.layerUI.subSpriteList.filter((t=>t.isVisible&&t.isEnabled));for(;s.length>0;){let t=s.shift();if(s=s.concat(t.subSpriteList.filter((t=>t.isVisible&&t.isEnabled))),void 0!==t.isPointInside&&t.isPointInside(e)&&null!==t.clickableObject){t.click(i),this.hasUserInput=!0;break}}};const P=class{constructor(t){this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d"),this.eventListeners=[],this.layerData={layerBackground:new n(0,0),layerMain1:new n(0,0),layerMain2:new n(0,0),layerUI:new n(0,0)},this.layerList=[],this.layerList.push(this.layerData.layerBackground),this.layerList.push(this.layerData.layerMain1),this.layerList.push(this.layerData.layerMain2),this.layerList.push(this.layerData.layerUI),this.layerUpdateList=[];for(let t=0;t<this.layerList.length;t++)this.layerUpdateList.push(!1);this.hasUserInput=!1,this.onlyDrawIfUpdate=!0,this.width=this.canvas.width,this.height=this.canvas.height,this.opacity=B,this.darkCurtainOpacity=0,this.isTransitionIn=!1,this.isTransitionOut=!1,this.isRunning=!1,this.isAllowInput=!1,this.parentGame=t,this.currentListeners={mousemove:{},mouseup:{}},this.setEventListener("mousemove",D),this.setEventListener("mouseup",A),this.bgm=null}setBg(t){let e=new p(0,0,this.canvas.width,this.canvas.height,t);this.addSpriteToLayer(this.layerData.layerBackground,e);let i=new g(0,0,this.canvas.width,this.canvas.height,"bg1");this.addSpriteToLayer(this.layerData.layerBackground,i)}changeScene(t){this.parentGame.changeScene(t)}pushScene(t){this.parentGame.pushScene(t)}backScene(){this.parentGame.backScene()}backSceneTillOne(){this.parentGame.backSceneTillOne()}getStorageManager(){return this.parentGame.storageManager}draw(){if(this.onlyDrawIfUpdate){let t=this.hasUserInput;if(this.hasUserInput=!1,this.layerUpdateList.every((t=>!1===t))&&!t&&this.darkCurtainOpacity<=0)return}this.ctx.save(),this.ctx.globalAlpha=this.opacity;let t=this.layerList.length;for(let e=0;e<t;e++)this.layerList[e].draw(this.ctx,this.parentGame.imagePool);this.darkCurtainOpacity>0&&(this.ctx.fillStyle=`rgba(100, 100, 100, ${this.darkCurtainOpacity})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)),this.ctx.restore()}update(t){let e=this.layerList.length;for(let i=0;i<e;i++){const e=this.layerList[i];this.layerUpdateList[i]=e.update(t)}this.isTransitionIn&&this.fadeIn(t)}startFadeIn(){this.darkCurtainOpacity=F,this.isTransitionIn=!0}fadeIn(t){this.elapsedTime||(this.elapsedTime=0),this.elapsedTime<T?(this.elapsedTime+=t,this.darkCurtainOpacity=F*(1-this.elapsedTime/T)):(this.elapsedTime=0,this.darkCurtainOpacity=0,this.isTransitionIn=!1)}toast(t="",e=0,i=1500){let s=new k(N,N,this.width-2*N);this.addSpriteToLayer(this.layerData.layerUI,s),s.opacity=0,s.setFontSize(20),s.setText(t),s.setFadeIn(0,e,O,0,E),setTimeout((()=>{s.setVisible(!1),this.layerData.layerUI.removeSubSprite(s)}).bind(this),i)}pause(t=!1){this.clearEventListeners(),this.pauseInput(),t||(this.isRunning=!1)}resume(){this.isRunning=!0,this.reAddEventListeners(),this.allowInput()}clearLayer(t){t.clear()}addSpriteToLayer(t,e){return t.addSubSprite(e),!0}addSpriteListToLayer(t,e){let i;for(i=0;i<e.length;i++)t.addSubSprite(e[i]);return!0}setLayerOrigin(t,e,i){return t.x=e,t.y=i,!0}pauseInput(t){this.isAllowInput=!1,void 0!==t&&setTimeout(function(){this.isAllowInput=!0}.bind(this),t)}resumeInput(){this.isAllowInput=!0}allowInput(t=0){setTimeout(function(){this.isAllowInput=!0,this.hasUserInput=!0}.bind(this),t)}setEventListener(t,e){this.currentListeners.hasOwnProperty(t)||(this.currentListeners[t]={}),e&&this.currentListeners[t]!==e&&(this.canvas.removeEventListener(t,this.currentListeners[t]),this.currentListeners[t]=e.bind(this),this.canvas.addEventListener(t,this.currentListeners[t]))}reAddEventListeners(){for(let t in this.currentListeners)this.currentListeners.hasOwnProperty(t)&&this.canvas.addEventListener(t,this.currentListeners[t])}clearEventListeners(){for(let t in this.currentListeners)this.currentListeners.hasOwnProperty(t)&&this.canvas.removeEventListener(t,this.currentListeners[t])}getMousePos(t){var e=this.canvas.getBoundingClientRect();return{x:(t.clientX-e.left)/(e.right-e.left)*this.canvas.width,y:(t.clientY-e.top)/(e.bottom-e.top)*this.canvas.height}}},M="#722f37",W="#EEE",U=W,R=M,j=M,V=W;class H extends k{constructor(t,e,i=80,s=40,a=""){super(t,e,i,s,a),this.setColor(U,R),this.setBorder(4,M),this.setTextCenter(),this.highlighted=!1,this.setHoverListener(this,((t,e)=>{e?this.setColor(j,V):this.setColor(U,R)}))}highlight(){this.highlighted||(this.appendText("✓"),this.setBorder(10,"#FF9"),this.highlighted=!0)}}class G extends n{constructor(t=null,e=0,i=0,s=60,a=60){super(e,i,s,a),this.func=null,this.param=t;let h=new y(0,0,s,a,"function_machine");super.addSubSprite(h),this.textBlock=new k(0,0,s-5,a,""),this.textBlock.setTextCenter(),this.textBlock.setText(this.getLabel()),super.addSubSprite(this.textBlock)}getLabel(){return""}setFunc(t){this.func=t}process(t){return this.func(t)}}class z extends G{constructor(){super(),this.func=t=>t}}class X extends G{constructor(t){super(t),this.param=t,this.func=e=>e+t}getLabel(){return this.param>0?"+"+this.param:this.param.toString()}}class J extends G{constructor(t){super(t),this.param=t,this.func=e=>e*t}getLabel(){return this.param>=0?"×"+this.param:`*(${this.param})`}}class Y extends G{constructor(){super(),this.func=t=>t*t}getLabel(){return"SQ"}}class _ extends G{constructor(){super(),this.func=t=>Math.floor(t)}getLabel(){return"⌊ ⌋"}}class q extends G{constructor(){super(),this.func=t=>-t}getLabel(){return"-"}}class $ extends n{constructor(t,e,i=60,s=60){super(t,e,i,s);let a=t+i/2,h=e+s/2,n=new p(a,h,i,s,"#CFC","#FFF"),r=new p(a,h+s/4,i,s/2,"#BFB");n.hasShadow=!0,n.isAnchorCenter=!0,r.isAnchorCenter=!0,this.rect1=n,this.rect2=r,super.addSubSprite(n),super.addSubSprite(r)}drawItself(t){super.drawItself(t)}jellyShake(){this.rect1.jellyShake(),this.rect2.jellyShake()}}class Q extends n{constructor(t,e,i=60,s=60){super(t,e,i,s),this.nodeLayer=new n(0,0),this.labelLayer=new n(0,0),super.addSubSprite(this.nodeLayer,!1),super.addSubSprite(this.labelLayer,!1),this.textBlock=new k(0,0,i,s,""),this.textBlock.setTextCenter(),this.labelLayer.addSubSprite(this.textBlock,!1)}setText(t){this.textBlock.setText(t)}}class K extends Q{constructor(t,e,i=null){super(t,e),this.nodeBase=new $(0,0,this.width,this.height,"#FFFFFF","#000000"),this.nodeLayer.addSubSprite(this.nodeBase,!1),this.setValue(i)}setValue(t){this.value=t,null!==t&&t.toString&&this.setText(t.toString())}getValue(){return this.value}jellyShake(){this.nodeBase.jellyShake()}}class Z extends Q{constructor(t,e,i){super(t,e),this.nodeBase=new $(0,0,this.width,this.height),this.nodeLayer.addSubSprite(this.nodeBase,!1),this.machineLayer=new n(0,0),super.addSubSprite(this.machineLayer,!1),void 0===i?this.functionMachine=new z:(this.functionMachine=i,this.machineLayer.addSubSprite(this.functionMachine))}setFunctionMachine(t){this.functionMachine=t,this.machineLayer.clearSubSprite(),this.machineLayer.addSubSprite(this.functionMachine)}process(t){return this.functionMachine.process(t)}}class tt{constructor(t,e){this.x=t,this.y=e}scalarMultiply(t){this.x*=t,this.y*=t}getNormal(){return new tt(-this.y,this.x)}normalize(){let t=this.getLength();this.x/=t,this.y/=t}getLength(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}}const et=tt,it={beltColors:["#99333380","#33339980","#33993380"],waitTime:[100,230,370],animationInterval:{replay:2500,once:1e3}};class st extends n{constructor(t,e,i=0,s=!0){let a=t.x+t.width/2,h=t.y+t.height/2,n=e.x+e.width/2,r=e.y+e.height/2;super(0,0),this.x1=a,this.y1=h,this.x2=n,this.y2=r,this.styleIndex=i,i>=it.beltColors.length&&(i=0),this.beltColor=it.beltColors[i]}startAnimation(t){t?this.setReplayAnimation(this.styleIndex,it.animationInterval.replay):this.setOnceAnimation(it.animationInterval.once)}setReplayAnimation(t,e){this.lerpT=.3;let i=new d(this,"lerpT",.4,e);this.addBehavior(i),this.arrowOpacity=0;let s=new l(this,"arrowOpacity",.8,e);this.addBehavior(s),this.setAutoRestart(it.waitTime[t])}setOnceAnimation(t){this.lerpT=.3;let e=new u(this,"lerpT",.3,t);this.addBehavior(e),this.arrowOpacity=0;let i=new d(this,"arrowOpacity",1,t);this.addBehavior(i)}drawItself(t){t.lineWidth=10,t.strokeStyle=this.beltColor,t.setLineDash([5,5]),t.beginPath(),t.moveTo(this.x1,this.y1),t.lineTo(this.x2,this.y2),t.stroke();let e=at(this.x1,this.x2,this.lerpT),i=at(this.y1,this.y2,this.lerpT),s=this.getDirUnitVector();s.scalarMultiply(3);let a=s.getNormal();t.strokeStyle="#333333",t.setLineDash([]),t.save(),t.globalAlpha=t.globalAlpha*this.arrowOpacity,t.beginPath(),t.moveTo(e,i),t.lineTo(e+a.x,i+a.y),t.lineTo(e+s.x,i+s.y),t.lineTo(e-a.x,i-a.y),t.closePath(),t.stroke(),t.restore()}getDirUnitVector(){let t=new et(this.x2-this.x1,this.y2-this.y1);return t.normalize(),t}}function at(t,e,i){return t*(1-i)+e*i}const ht={default:{textColor:"#333",borderColor:"#66666680",opacity:.5},success:{textColor:"#000",borderColor:"#339",opacity:1},dx:-10,dy:10,side:40,fontSize:20,bgColor:"#FFFFFF80",borderWidth:2,borderColor:"#66666680"};class nt extends n{constructor(t,e,i,s,a=0){super(0,0),this.target=s,this.isTargetMet=!1,this.beltLayer=new n(0,0),this.targetLayer=new n(0,0),super.addSubSprite(this.beltLayer),super.addSubSprite(this.targetLayer),this.inputNode=t,this.functionNodeList=i,this.outputNode=e,this.beltList=[],this.nodeList=[],this.nodeList.push(this.inputNode),this.nodeList=this.nodeList.concat(this.functionNodeList),this.nodeList.push(this.outputNode),this.targetBubble=function(t,e,i){let{x:s,y:a,width:h}=t,{dx:n,dy:r,side:o,bgColor:l,borderWidth:c,borderColor:d,fontSize:u}=e,y=new p(s+h+n,a-o+r,o,o,l,d);y.setBorderWidth(c),y.toggleShadow(!0);let g=new k(0,0,o,o,"="+i.toString());return g.setFontSize(u),g.setTextCenter(),y.addSubSprite(g),y}(e,ht,s),this.adjustTarget(!1),this.targetLayer.addSubSprite(this.targetBubble),this.setBelt(a)}setInputValue(t){this.inputNode.setValue(t)}setFunctionMachine(t,e){if(e>=this.functionNodeList.length)throw new Error("[AssemblyLine] Index out of bound");this.functionNodeList[e].setFunctionMachine(t)}setBelt(t=0){for(let e=0;e<this.nodeList.length-1;e++){let i=this.nodeList[e],s=this.nodeList[e+1],a=new st(i,s,t);this.beltList.push(a),this.beltLayer.addSubSprite(a)}}run(){let t=this.inputNode.getValue();for(let e=0;e<this.functionNodeList.length;e++)t=this.functionNodeList[e].process(t);let e=Math.round(10*t)/10,i=this.outputNode.getValue();this.outputNode.setValue(e),this.adjustTarget(this.target===e),null!==i&&e!==i&&this.outputNode.jellyShake(),this.hasUpdate=!0}adjustTarget(t){this.isTargetMet=t,t?this.setTargetBubbleColor(ht.success):this.setTargetBubbleColor(ht.default)}setTargetBubbleColor(t){this.targetBubble.subSpriteList[0].setTextColor(t.textColor),this.targetBubble.borderColor=t.borderColor,this.targetBubble.opacity=t.opacity}startBeltAnimation(){this.beltList.forEach((t=>t.startAnimation(!0)))}}const rt="#CCD",ot="#FFF",lt=20,ct="#FF9";class dt extends n{constructor(t,e,i,s,a){super(t,e,i,s),this.machineInventory=a,this.selectedIndex=null,this.background=new p(0,0,i,s,rt,"#FFF"),this.background.setBorderWidth(5),this.addSubSprite(this.background);let h=new g(0,0,i,s,"bg1");this.addSubSprite(h),this.machineIconList=[],a.machineList.forEach(((t,e)=>{let s=new p(0,lt+80*e,60,60,"#FFFFFF40",ot);s.setBorderWidth(3),s.x=(i-s.width)/2,s.addSubSprite(t),this.machineIconList.push(s),this.addSubSprite(s)})),this.setClickInventoryListener()}select(t){return t<this.machineIconList.length&&(this.machineIconList.forEach((t=>t.borderColor=ot)),this.machineIconList[t].borderColor=ct,this.selectedIndex=t,!0)}use(){return null!==this.selectedIndex&&this.machineInventory.use(this.selectedIndex)}setClickInventoryListener(){this.machineIconList.forEach(((t,e)=>{t.setClickListener(this,(t=>{this.select(e)}))}))}}class ut{constructor(t){this.capacity=t.length,this.machineList=[],this.parseMachineData(t)}use(t){return this.machineList[t]}parseMachineData(t){t.forEach((t=>{let e;switch(t.type){case 1:e=new X(t.param);break;case 2:e=new J(t.param);break;case 3:e=new Y;break;case 4:e=new _;break;case 5:e=new q}this.machineList.push(e)}))}}const pt=1e3,yt={canvasBGColor1:"#effae9",titleLabel:{x:0,y:0,width:300,height:200,textColor:"#633",fontSize:80,text:["Function","Space","Level"]},buttonPanel:{x:160,y:300,width:280,height:160,bgColor:"#f0f0fff0",borderColor:"#000",borderWidth:4,fontSize:40,text:"Level Clear!",textHeight:100,buttonWidth:110,buttonHeight:40,backButton:{x:20,y:100,text:"Select Level"},nextButton:{x:150,y:100,text:"Next"},fadeIn:{fromOpacity:0,beforeTime:1e3,fadeTime:500,dx:0,dy:-40}},nodeFadeIn:{fromOpacity:0,beforeTime:0,fadeTime:pt,dx:100,dy:0},lineFadeIn:{fromOpacity:0,beforeTime:0,fadeTime:pt,dx:0,dy:-100},fixedBackButton:{margin:10,height:40,text:"Back"}};let gt={commandApply:function(t){this.applyMachineToNode(t)},commandNext:function(t){this.changeScene(new bt(this.parentGame,t))},commandBack:function(){this.backScene()}};class bt extends P{constructor(t,e=0){super(t),this.levelNum=e,this.setBg(yt.canvasBGColor1),this.toast("Level "+(e+1).toString());let i=function(t,e){let i=new k(t.x,t.y,t.width,t.height);return i.setAllText(t.text.concat(e.toString())),i.setTextColor(t.textColor),i.setFontSize(t.fontSize),i.opacity=.05,i}(yt.titleLabel,e+1);this.addSpriteToLayer(this.layerData.layerBackground,i),this.fixedBackButton=function(t,e){let{margin:i,height:s,text:a}=t,h=new H(i,e.height-s-i);return h.setText(a),h.setClickListener(e,gt.commandBack),h}(yt.fixedBackButton,this);let s=9===e;this.buttonPanel=function(t,e,i,s){let{x:a,y:h,width:n,height:r,bgColor:o,borderColor:l,borderWidth:c,text:d,textHeight:u,fontSize:y}=t,b=new p(a,h,n,r,o,l);b.setBorderWidth(c);let x=new g(0,0,n,r,"bg3");b.addSubSprite(x);let m=new k(0,0,n,u,d);m.setFontSize(y),m.setTextCenter(),b.addSubSprite(m);let{buttonWidth:f,buttonHeight:v}=t;({x:a,y:h,text:d}=t.backButton);let S=new H(a,h,f,v,d);if(S.setClickListener(i,gt.commandBack),b.addSubSprite(S),!s){({x:a,y:h,text:d}=t.nextButton);let s=new H(a,h,f,v,d);s.setClickListener(i,function(t,e){return function(i){gt.commandNext.bind(t)(e)}}(i,e+1)),b.addSubSprite(s)}return b}(yt.buttonPanel,e,this,s);const a=t.getLevelData(e);this.processLevelData(a),setTimeout((()=>{this.addSpriteToLayer(this.layerData.layerUI,this.fixedBackButton),this.inventoryPanel&&this.addSpriteToLayer(this.layerData.layerUI,this.inventoryPanel),this.assemblyLineList&&this.assemblyLineList.forEach((t=>{t.startBeltAnimation()}))}).bind(this),pt)}processLevelData(t){let e=t.inputNodes.map((t=>new K(t.x,t.y,t.value))),i=t.outputNodes.map((t=>new K(t.x,t.y))),s=t.machineNodes.map((t=>new Z(t.x,t.y)));s.forEach((t=>{return t.setClickListener(this,(e=this,i=t,function(t){gt.commandApply.bind(e)(i)}));var e,i})),this.nodeList=e.concat(i).concat(s),this.assemblyLineList=t.lines.map(((t,a)=>{let h=e[t.in],n=i[t.out],r=t.between.map((t=>s[t]));return new nt(h,n,r,t.target,a)})),this.assemblyLineList.forEach((t=>t.run())),this.nodeList.forEach((t=>{t.setFadeInConfig(yt.nodeFadeIn),this.addSpriteToLayer(this.layerData.layerUI,t)})),this.assemblyLineList.forEach((t=>{t.setFadeInConfig(yt.lineFadeIn),this.addSpriteToLayer(this.layerData.layerMain1,t)})),this.machineInventory=new ut(t.machines);let a=.15*this.width;this.inventoryPanel=new dt(this.width-a,0,a,this.height,this.machineInventory)}selectMachine(t){this.inventoryPanel.select(t)}applyMachineToNode(t){let e=this.inventoryPanel.use();e&&(t.setFunctionMachine(e),this.refreshLine())}refreshLine(){this.assemblyLineList.forEach((t=>{t.run()})),this.assemblyLineList.every((t=>!0===t.isTargetMet))&&(this.disableGameplayInput(),this.getStorageManager().completeLevel(this.levelNum),this.buttonPanel.setFadeInConfig(yt.buttonPanel.fadeIn),this.addSpriteToLayer(this.layerData.layerUI,this.buttonPanel))}disableGameplayInput(){this.nodeList.forEach((t=>t.isEnabled=!1)),this.inventoryPanel.isEnabled=!1,this.fixedBackButton.isEnabled=!1}}const xt=bt;let mt={canvasBGColor1:"#effae9",titleLabel:{x:0,y:80,width:600,height:100,textColor:"#633",fontSize:60,text:["Function Space"],fadeIn:{fromOpacity:0,beforeTime:1200,fadeTime:250,dx:10,dy:0}},gameEndLabel:{x:0,y:380,width:600,height:100,textColor:"#633",fontSize:40,text:["Game Completed! Thank you!"],fadeIn:{fromOpacity:0,beforeTime:1200,fadeTime:250,dx:10,dy:0}},region:{width:500,height:200,buttonWidth:60,buttonHeight:60,rowCount:2,columnCount:5,y:200,borderColor:"#FFFFFF80",borderWidth:5,fadeIn:{fromOpacity:0,beforeTime:1500,fadeTime:250,dx:10,dy:0}},belts:[{x1:-20,y1:80,x2:620,y2:80,styleIndex:0},{x1:620,y1:180,x2:-20,y2:180,styleIndex:0},{x1:500,y1:-20,x2:620,y2:400,styleIndex:1},{x1:120,y1:500,x2:-20,y2:400,styleIndex:2}]},ft={commandSelectLevel:function(t){this.pushScene(new xt(this.parentGame,t))}},vt=function(t,e){return function(i){ft.commandSelectLevel.bind(t)(e)}};function St(t){let e=new k(t.x,t.y,t.width,t.height);return e.setAllText(t.text),e.setTextColor(t.textColor),e.setFontSize(t.fontSize),e.setTextCenter(),e}const Lt=class extends P{constructor(t){super(t),this.setBg(mt.canvasBGColor1);let e=St(mt.titleLabel);e.setFadeInConfig(mt.titleLabel.fadeIn),this.addSpriteToLayer(this.layerData.layerUI,e),this.levelSelectBorder=function(t,{y:e,width:i,height:s,borderColor:a,borderWidth:h}){let n=(t.width-mt.region.width)/2,r=new p(n,e,i,s,"transparent",a);return r.setBorderWidth(h),r}(this,mt.region),this.levelSelectRegion=function(t,{width:e,height:i,buttonWidth:s,buttonHeight:a,rowCount:h,columnCount:r}){let o=new n(0,0,e,i),l=(e-s*r)/(r+1),c=(i-a*h)/(h+1),d=t.getStorageManager().getCompletedLevels();for(let e=0;e<h*r;e++){let i=Math.floor(e/r),h=e%r,n=new H(l*(h+1)+s*h,c*(i+1)+a*i,s,a,(e+1).toString());n.level=e,n.setClickListener(t,vt(t,e)),o.addSubSprite(n),d.includes(e)&&n.highlight()}return o}(this,mt.region),this.levelSelectBorder.addSubSprite(this.levelSelectRegion),this.levelSelectBorder.setFadeInConfig(mt.region.fadeIn),this.addSpriteToLayer(this.layerData.layerUI,this.levelSelectBorder),mt.belts.forEach((t=>{let e=function({x1:t,y1:e,x2:i,y2:s,styleIndex:a}){let h=new n(t,e),r=new n(i,s),o=new st(h,r,a,!1);return o.opacity=.8,o}(t);e.startAnimation(!1),this.addSpriteToLayer(this.layerData.layerBackground,e)}))}resume(){super.resume();let t=this.getStorageManager().getCompletedLevels();this.levelSelectRegion.subSpriteList.forEach((e=>{void 0!==e.level&&t.includes(e.level)&&e.highlight()}));let e=mt.region.columnCount*mt.region.rowCount;t.length===e&&void 0===this.gameEndLabel&&(this.gameEndLabel=St(mt.gameEndLabel),this.gameEndLabel.setFadeInConfig(mt.gameEndLabel.fadeIn),this.addSpriteToLayer(this.layerData.layerUI,this.gameEndLabel))}},wt="functionSpace";class Ct{constructor(){void 0===localStorage[wt]?(this.storageObj={},this.storageObj.version=1,this.storageObj.passedLevels=[],It(this.storageObj)):this.storageObj=JSON.parse(localStorage[wt])}completeLevel(t){this.storageObj.passedLevels.includes(t)||(this.storageObj.passedLevels.push(t),It(this.storageObj))}getCompletedLevels(){return[].concat(this.storageObj.passedLevels)}}function It(t){localStorage[wt]=JSON.stringify(t),console.log("Save data updated.")}let kt=function(t,e=!0){t.resume(),e&&t.startFadeIn()},Tt=new class extends class{constructor(e){this.canvas=e,this.isSceneLoaded=!1,this.imagePool=new t,this.storageManager=new Ct}async startGameLoop(){this.isSceneLoaded||(await this.preloadImages(),this.loadScenes());let t=function(t){let e=null;return function i(s){let a=null===e?0:s-e;e=s,null!==t.currentScene&&(t.currentScene.update(a),t.currentScene.draw()),null!==t.modalScene&&(t.modalScene.update(a),t.modalScene.draw()),requestAnimationFrame(i)}}(this);requestAnimationFrame(t)}async preloadImages(){this.imagePool.add("function_machine","./img/function_machine.png"),this.imagePool.add("bg1","./img/bg1.png"),this.imagePool.add("bg3","./img/bg3.png"),await this.imagePool.preload()}loadScenes(){this.sceneStack=[],this.currentScene=null,this.modalScene=null,this.isSceneLoaded=!0}changeScene(t){this.backScene(),this.pushScene(t)}pushScene(t){this.currentScene&&this.currentScene.pause(),this.currentScene=t,this.sceneStack.push(t),kt(this.currentScene)}backScene(){this.currentScene.pause(),this.sceneStack.pop(),0===this.sceneStack.length?this.currentScene=null:(this.currentScene=this.sceneStack[this.sceneStack.length-1],kt(this.currentScene))}backSceneTillOne(){for(;this.sceneStack.length>1;)this.backScene()}setCanvasConfig(t){this.canvas&&(t.canvasWidth&&this.canvas.setAttribute("width",t.canvasWidth),t.canvasHeight&&this.canvas.setAttribute("height",t.canvasHeight))}addImageData(t,e){this.imgDataResource[t]=imageData}}{constructor(t){super(t),this.levelDataList=i}getLevelData(t){return this.levelDataList[t]}loadScenes(){super.loadScenes(),this.pushScene(new Lt(this))}}(document.getElementById("main_game"));Tt.setCanvasConfig({canvasWidth:600,canvasHeight:480}),Tt.startGameLoop()})();