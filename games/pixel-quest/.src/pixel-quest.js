window.PixelQuest=function(){var t=function(){this.game=new t.Game};return t.prototype.start=function(){var e=this;this.renderIntervalId=setInterval(function(){e.game.render(e.player),e.player&&e.socket&&e.socket.emit("player#update",e.player.object)},10),this.connectToServer(function(o){e.player=new t.Renderers.Player(o.id,o),e.game.addObject(e.player);var i=new t.Interaction(e.player,e.socket);i.bindKeyboardToPlayer()})},t.prototype.connectToServer=function(e){var o=this,i={uuid:function(e){t.Utils.setIdentifier(e),o.socket.emit("player#join",e)},"player#joined":e,"world#sync":o.onWorldSync.bind(o),"player#quit":function(t){o.game.removeObject(t)},"player#update":function(t){var e=o.game.getObject(t.id),i=["experience","achievements","x","y","hp","originalHp"];i.forEach(function(o){e.object.options[o]=t.options[o]})},"monster#killed":function(t){o.game.removeObject(t)},"player#experience":function(t,e){o.game.getObject(t.id).animateExperience(e)},"player#levelUp":function(t){o.game.getObject(t.id).animateLevelUp()},"player#update":function(t){var e=o.game.getObject(t.id),i=["experience","achievements","x","y","hp","originalHp"];i.forEach(function(o){e.object.options[o]=t.options[o]})},"player#hit":function(t,e){var i=o.game.getObject(t);i.animateHit(e)},"player#died":function(t){var e=o.game.getObject(t);e.animateDeath(function(){o.socket.emit("player#resurrect",t)})},"player#reset":function(t){o.game.getObject(t).resetStats()}};o.socket=io.connect("http://"+document.location.host),Object.keys(i).forEach(function(t){o.socket.on(t,i[t])})},t.prototype.onWorldSync=function(e,o){var i=t.Renderers[e],n=this;o.forEach(function(t){var e=n.game.getObject(t.id);e?e.update(t):(e=new i(t.id,t),n.game.addObject(e))})},t}(),window.PixelQuest.Utils={extend:function(t,e){var o={};return Object.keys(t).forEach(function(e){o[e]=t[e]}),Object.keys(e).forEach(function(t){o[t]=e[t]===Object(e[t])?PixelQuest.Utils.extend(o[t],e[t]):e[t]}),o},getIdentifier:function(){var t={};return(document.cookie||"").split(";").forEach(function(e){var o=e.split("=");o[0]&&(t[o[0].trim()]=o[1].trim())}),t.PixelQuestIdentifier},setIdentifier:function(t){document.cookie="PixelQuestIdentifier="+t+"; expires=Tue, 1 Jan 2030 00:00:00 UTC; path=/"},generateIdentifier:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),o="x"==t?e:8|3&e;return o.toString(16)})}},window.PixelQuest.Interaction=function(){var t=function(t,e){this.player=t,this.socket=e,this.movementDelta=5,this.activeKeys=[]};t.prototype.bindKeyboardToPlayer=function(){var t=this;document.onkeydown=function(e){e=e||window.event;var o=e.which||e.keyCode;-1===t.activeKeys.indexOf(o)&&t.activeKeys.push(o)},document.onkeyup=function(e){e=e||window.event;var o=e.which||e.keyCode,i=t.activeKeys.indexOf(o);-1!==i&&t.activeKeys.splice(i,1)},window.setInterval(function(){e.call(t)},this.player.object.options.movementDelay)};var e=function(){var t=this;this.activeKeys.forEach(function(e){switch(e){case 32:t.player.attack(o.bind(t));break;case 37:t.player.move("left");break;case 38:t.player.move("up");break;case 39:t.player.move("right");break;case 40:t.player.move("down")}})},o=function(){this.socket.emit("player#attack",this.player.id)};return t}(),window.PixelQuest.Renderers={},window.PixelQuest.Renderers.Monster=function(){"use strict";var t=function(t,e){this.id=t,this.monster=e};t.prototype.render=function(t){e.call(this,t),o.call(this,t),i.call(this,t),this.monster.options.hp!==this.monster.options.originalHp&&n.call(this,t),s.call(this,t)},t.prototype.toJSON=function(){var t=this.monster.options;return t.id=this.id,t},t.prototype.update=function(t){this.monster=t};var e=function(t){var e=this.monster.options.renderOptions.pixelSize,o=this.monster.options.y+this.monster.options.renderOptions.feet.offset;t.fillStyle=this.monster.options.color,t.fillRect(this.monster.options.x,o,this.monster.options.width,this.monster.options.height),t.fillStyle="#FFFFFF",t.fillRect(this.monster.options.x+e,o+e,e,e),t.fillRect(this.monster.options.x+this.monster.options.width-2*e,o+e,e,e),t.fillRect(this.monster.options.x+2*e,o+3*e,this.monster.options.width-4*e,.5*e),t.fillRect(this.monster.options.x+2*e+this.monster.options.renderOptions.face.toothX,o+3.5*e-1,e/2,.5*e)},o=function(t){var e=this.monster.options.renderOptions.pixelSize,o=this.monster.options.y+this.monster.options.renderOptions.feet.offset;t.fillStyle=this.monster.options.color,t.fillRect(this.monster.options.x-e,o+e,e+1,2*e),t.fillRect(this.monster.options.x-2*e,o+2*e,e+1,this.monster.options.width-2*e),t.fillRect(this.monster.options.x+this.monster.options.width-1,o+e,e+1,2*e),t.fillRect(this.monster.options.x+this.monster.options.width-1+e,o+2*e,e+1,this.monster.options.width-2*e)},i=function(t){var e=this.monster.options.renderOptions.pixelSize,o=this.monster.options.y+this.monster.options.renderOptions.feet.offset;t.fillStyle=this.monster.options.color,t.fillRect(this.monster.options.x+e,o+this.monster.options.height-1,e,3*e-this.monster.options.renderOptions.feet.offset),t.fillRect(this.monster.options.x+this.monster.options.width-2*e,o+this.monster.options.height-1,e,3*e-this.monster.options.renderOptions.feet.offset),t.fillRect(this.monster.options.x+1,o+this.monster.options.height+2*e-1-this.monster.options.renderOptions.feet.offset,e,e),t.fillRect(this.monster.options.x+this.monster.options.width-1-e,o+this.monster.options.height+2*e-1-this.monster.options.renderOptions.feet.offset,e,e)},n=function(t){var e=this.monster.options.renderOptions.pixelSize,o=this.monster.options.y+this.monster.options.renderOptions.feet.offset;~~((this.monster.options.width-e)/(e+2)),t.fillStyle="#FFFFFF",t.fillRect(this.monster.options.x+e,o+this.monster.options.height-4,(this.monster.options.width-2*e)*(this.monster.options.hp/this.monster.options.originalHp),2)},s=function(t){t.font="bold 12px sans-serif",this.monster.options.renderOptions.damages.forEach(function(e){var o=1-e.step/10;t.fillStyle="rgba(200, 0, 0, "+o+")",t.fillText("-"+e.damage,e.x,e.y-e.step)})};return t}(),window.PixelQuest.Renderers.Player=function(){"use strict";var t=function(t,e){this.id=t,this.object=e,this.renderOptions={levelUp:{levelUp:!1,step:0},death:{callback:null},attack:{callback:null}}};t.prototype.isActivePlayer=function(){return this.id===window.PixelQuest.Utils.getIdentifier()},t.prototype.resetStats=function(){this.object.options.renderOptions.colors.outline="#2c3e50",this.object.options.renderOptions.colors.opacity=1,this.object.options.renderOptions.feet.delta=.25},t.prototype.alive=function(){return this.object.options.hp>0},t.prototype.animateDeath=function(t){this.object.options.renderOptions.death.dead=!0,this.object.options.renderOptions.death.step=0,this.renderOptions.death.callback=t},t.prototype.animateExperience=function(t){var e=this.object.options.renderOptions.pixelSize;this.object.options.renderOptions.experience.push({value:t,step:0,x:this.object.options.x+Math.random()*this.object.options.renderOptions.width,y:this.object.options.y-2*e})},t.prototype.animateLevelUp=function(){this.renderOptions.levelUp.levelUp=!0,this.renderOptions.levelUp.step=0},t.prototype.animateHit=function(t){var e=this.object.options.renderOptions.pixelSize;this.object.options.renderOptions.damages.push({value:t,step:0,x:this.object.options.x+Math.random()*this.object.options.renderOptions.width,y:this.object.options.y-2*e})},t.prototype.update=function(t){this.object=t},t.prototype.render=function(t){this.alive()&&this.resetStats(),e.call(this,t),h.call(this,t),o.call(this,t),i.call(this,t),r.call(this,t),s.call(this,t),n.call(this,t),c.call(this,t),l.call(this,t)},t.prototype.move=function(t,e){if(this.alive())switch(e=e||this.object.options.stepSize,t){case"left":this.object.options.x=this.object.options.x-e,this.object.options.renderOptions.weapon.side="left";break;case"right":this.object.options.x=this.object.options.x+e,this.object.options.renderOptions.weapon.side="right";break;case"up":this.object.options.y=Math.max(230,this.object.options.y-e);break;case"down":this.object.options.y=this.object.options.y+e}},t.prototype.attack=function(t){this.object.options.attacking||(this.object.options.attacking=!0,this.renderOptions.attack.callback=t)};var e=function(t){if(!this.alive()){this.object.options.renderOptions.feet.delta=.05,this.object.options.renderOptions.colors.opacity=this.object.options.renderOptions.colors.opacity-.005;var e="rgba(255, 0, 0, "+this.object.options.renderOptions.colors.opacity+")";this.object.options.renderOptions.colors.opacity<=0?this.renderOptions.death.callback&&this.renderOptions.death.callback():this.object.options.renderOptions.colors.outline=e;var o=this.object.options.renderOptions.pixelSize,i=this.object.options.x+~~(this.object.options.renderOptions.width/2),n=this.object.options.y+2*o-this.object.options.renderOptions.death.step;t.font="bold 12px sans-serif",t.fillStyle=e,t.textAlign="center",t.fillText("I had",i,n),this.object.options.renderOptions.death.step>2*o&&t.fillText("bad",i,n+4*o),this.object.options.renderOptions.death.step>6*o&&t.fillText("luck!",i,n+8*o),this.object.options.renderOptions.death.step<14*o&&(this.object.options.renderOptions.death.step=this.object.options.renderOptions.death.step+.45)}},o=function(t){var e=this.object.options.renderOptions.pixelSize,o=this.object.options.y+~~this.object.options.renderOptions.feet.offset;t.fillStyle=this.object.options.renderOptions.colors.outline,t.fillRect(this.object.options.x,o,this.object.options.renderOptions.width,this.object.options.renderOptions.height),t.fillRect(this.object.options.x+e,o-e,this.object.options.renderOptions.width-2*e,e),t.fillRect(this.object.options.x+e,o+this.object.options.renderOptions.height,this.object.options.renderOptions.width-2*e,e),t.fillStyle=this.object.options.renderOptions.colors.face,t.fillRect(this.object.options.x+e,o,this.object.options.renderOptions.width-2*e,this.object.options.renderOptions.height-e),t.fillStyle=this.object.options.renderOptions.colors.outline,this.alive()?(t.fillRect(this.object.options.x+2*e,o+e,e,e),t.fillRect(this.object.options.x+this.object.options.renderOptions.width-3*e,o+e,e,e)):(t.font="normal 10px sans-serif",t.textAlign="left",t.fillText("x",this.object.options.x+1.5*e,o+3*e),t.fillText("x",this.object.options.x+this.object.options.renderOptions.width-3*e,o+3*e))},i=function(t){var e=this.object.options.renderOptions.pixelSize,o=this.object.options.y+~~this.object.options.renderOptions.feet.offset;t.fillStyle=this.object.options.renderOptions.colors.outline,t.fillRect(this.object.options.x-2*e,o+2*e,2*e,e),t.fillRect(this.object.options.x-2*e,o+e,e,e),t.fillRect(this.object.options.x+this.object.options.renderOptions.width,o+2*e,2*e,e),t.fillRect(this.object.options.x+this.object.options.renderOptions.width+e,o+e,e,e)},n=function(t){var e=this.object.options.renderOptions.pixelSize,o=this.object.options.y+~~this.object.options.renderOptions.feet.offset,i=~~((this.object.options.renderOptions.height+2*e)/2);t.fillStyle=this.object.options.renderOptions.colors.outline,t.fillRect(this.object.options.x+2*e,o+this.object.options.renderOptions.height,e,i-~~this.object.options.renderOptions.feet.offset),t.fillRect(this.object.options.x+this.object.options.renderOptions.width-3*e,o+this.object.options.renderOptions.height,e,i-~~this.object.options.renderOptions.feet.offset),this.object.options.renderOptions.feet.offset="up"===this.object.options.renderOptions.feet.direction?this.object.options.renderOptions.feet.offset+this.object.options.renderOptions.feet.delta:this.object.options.renderOptions.feet.offset-this.object.options.renderOptions.feet.delta,this.object.options.renderOptions.feet.offset>=~~(i/2)?this.object.options.renderOptions.feet.direction="down":this.object.options.renderOptions.feet.offset<=0&&(this.object.options.renderOptions.feet.direction="up")},s=function(t){var e=this,o=this.object.options.renderOptions.pixelSize,i=this.object.options.y+~~this.object.options.renderOptions.feet.offset;t.fillStyle=this.object.options.renderOptions.colors.outline,[[0,0],[-o,-o],[o,-o]].forEach(function(n){t.fillRect(e.object.options.x+~~((e.object.options.renderOptions.width-o)/2)+n[0],i-2*o+n[1],o,o)})},r=function(t){var e="sword";switch(e){case"sword":p.call(this,t)}},p=function(t){var e=this.object.options.renderOptions.pixelSize,o=e+("left"===this.object.options.renderOptions.weapon.side?this.object.options.x-3*e:this.object.options.x+this.object.options.renderOptions.width),i=this.object.options.y+~~this.object.options.renderOptions.feet.offset+e,n=("left"===this.object.options.renderOptions.weapon.side?-1:1)*this.object.options.renderOptions.weapon.angle;t.fillStyle=this.object.options.renderOptions.colors.outline,t.translate(o,i),t.rotate(n),t.fillRect(0,5*-e,e,5*e),t.fillRect(-e,2*-e,3*e,e),t.rotate(-n),t.translate(-o,-i),this.alive()&&this.object.options.attacking&&(this.object.options.renderOptions.weapon.angle="down"===this.object.options.renderOptions.weapon.direction?this.object.options.renderOptions.weapon.angle-.1:this.object.options.renderOptions.weapon.angle+.1,this.object.options.renderOptions.weapon.angle>=1.4?(this.object.options.renderOptions.weapon.direction="down",this.isActivePlayer()&&this.renderOptions.attack.callback&&(this.renderOptions.attack.callback(),this.renderOptions.attack.callback=null)):this.object.options.renderOptions.weapon.angle<=0&&(this.object.options.renderOptions.weapon.direction="up",this.object.options.attacking=!1))},c=function(t){var e=this;t.font="bold 12px sans-serif",this.object.options.renderOptions.experience=this.object.options.renderOptions.experience.sort(function(t,e){return t.value-e.value}).filter(function(o,i){if(0===i){o.step=o.step+.2;var n=1-o.step/10;return t.fillStyle="rgba(39, 139, 210, "+n+")",t.fillText("+"+o.value,o.x,o.y-o.step),o.step<10?!0:(e.object.options.renderOptions.experience.length>1&&(e.object.options.renderOptions.experience[1].x=e.object.options.x+Math.random()*e.object.options.renderOptions.width,e.object.options.renderOptions.experience[1].y=e.object.options.y),!1)}return!0})},h=function(t){if(this.renderOptions.levelUp.levelUp){this.renderOptions.levelUp.step=this.renderOptions.levelUp.step+.05;var e=this.object.options.renderOptions.pixelSize,o=this.object.options.x+~~(this.object.options.renderOptions.width/2),i=this.object.options.y-0*e;i-=this.renderOptions.levelUp.step*e,t.fillStyle=this.object.options.renderOptions.colors.outline,t.font="bold 12px sans-serif",t.textAlign="center",t.fillText("Lvl up!",o,i),this.renderOptions.levelUp.step>10&&(this.renderOptions.levelUp.levelUp=!1,this.renderOptions.levelUp.step=0)}},l=function(t){t.font="bold 12px sans-serif",this.object.options.renderOptions.damages=this.object.options.renderOptions.damages.filter(function(e){e.step=e.step+.2;var o=1-e.step/10;return t.fillStyle="rgba(192, 57, 43, "+o+")",t.fillText("-"+e.value,e.x,e.y-e.step),e.step<10})};return t}(),window.PixelQuest.Game=function(){"use strict";var t=function(){this.canvas=document.querySelector("canvas"),this.ctx=this.canvas.getContext("2d"),this.objects={},this.environment={sky:{},sun:{offset:0,direction:"decr"},grass:[]}};t.prototype.render=function(t){var s=this;this.setSize(),this.ctx.fillStyle="#FFE9DA",this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight),this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=0,this.ctx.shadowColor=null,o.call(this,240),i.call(this,240,"#ffffff",10),i.call(this,240,"#beaea2",9),i.call(this,240,"#d8c6b8",6),i.call(this,240,"#FFE9DA",3),n.call(this),Object.keys(this.objects).forEach(function(t){s.objects[t].render(s.ctx)}),e.call(this,t)},t.prototype.setSize=function(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight},t.prototype.addObject=function(t){this.objects[t.id]=t},t.prototype.getObject=function(t){return this.objects[t]},t.prototype.removeObject=function(t){var e="string"==typeof t?t:t.id;window.PixelQuest.Utils.getIdentifier()!==e&&delete this.objects[e]};var e=function(t){var e=window.innerHeight-40,o=e+28;if(this.ctx.fillStyle="#2980b9",this.ctx.fillRect(0,e,window.innerWidth,40),t){this.ctx.font="bold 22px sans-serif",this.ctx.fillStyle="#FFE9DA",this.ctx.textAlign="left";var i=["Level: "+t.object.options.experience.level,"HP: "+t.object.options.hp+"/"+t.object.options.originalHp,"XP: "+t.object.options.experience.current+"/"+t.object.options.experience.neededForLevelUp].join("      ");this.ctx.fillText(i,10,o),this.ctx.textAlign="right",this.ctx.fillText(["Quest:","Kill",t.object.options.achievements.current.needed-t.object.options.achievements.current.achieved,t.object.options.achievements.current.colorName,"monsters.",t.object.options.achievements.current.experience,"XP."].join(" "),window.innerWidth-10,o),this.ctx.textAlign="left"}},o=function(t){var e=["#4494c6","#4597cb","#479bce","#499ed3","#499bd5","#499cd6","#4899d9","#4898d9"],o=this;e.forEach(function(i,n){o.ctx.fillStyle=i,o.ctx.fillRect(0,n*t/e.length,window.innerWidth,t/e.length)})},i=function(t,e,o){var i=12,n=1,s=this;if(!this.environment.sky[e]){this.environment.sky[e]=[];for(var r=0,p=~~(window.innerWidth/i)+1;p>r;r++)Math.random()<.5?n++:Math.random()<.5&&n--,n=Math.max(0,Math.min(n,o)),this.environment.sky[e].push(n)}this.ctx.fillStyle=e,this.environment.sky[e].forEach(function(e,o){s.ctx.fillRect(o*i,t-e*i,i,e*i)})},n=function(){var t=12;this.environment.sun.offset>t?this.environment.sun.direction="decr":this.environment.sun.offset<-t&&(this.environment.sun.direction="incr"),this.environment.sun.offset="decr"===this.environment.sun.direction?this.environment.sun.offset-.05:this.environment.sun.offset+.05,this.ctx.fillStyle="#f1c40f",this.ctx.fillRect(3*t-this.environment.sun.offset/2,3*t-this.environment.sun.offset/2,6*t+this.environment.sun.offset,6*t+this.environment.sun.offset)};return t}();