var muri=function(){kontra.init("js13k-2017"),kontra.assets.imagePath="assets/images";var muri={};muri.ra=function(a){return a[Math.floor(Math.random()*a.length)]},muri.bg=function(room){return kontra.sprite({x:0,y:0,image:kontra.assets.images["room_"+room]})},muri.currentRoom="stasis",muri.modules=[],muri.rooms=[];var fetchObject=function(type){return function(name){for(var i in muri[type])if(muri[type][i].name===name)return muri[type][i]}};return muri.get=fetchObject("modules"),muri.room=fetchObject("rooms"),muri.changeRoom=function(room){var fromRoom=muri.currentRoom;muri.currentRoom=room,void 0!==muri.room(room).onEnter&&muri.room(room).onEnter(fromRoom)},muri.door=function(room,position){var doorAnimationSheet=kontra.spriteSheet({image:kontra.assets.images.door_sheet,frameWidth:13,frameHeight:22,animations:{closed:{frames:0},opened:{frames:5},open:{frames:"0..5",frameRate:6},close:{frames:"5..0",frameRate:6}}}),doorSprite=kontra.sprite({x:position[0],y:position[1],animations:doorAnimationSheet.animations});return muri.get("entity").create(room+".door",doorSprite).addCallback(function(){doorSprite.playAnimation("open"),setTimeout(function(){muri.changeRoom("lift")},1e3)})},muri.end=function(reason,again){muri.changeRoom("end"),muri.get("bubble").talk(reason,[20,20]).then(function(){again&&(document.getElementById("tryagain").style.display="block")})},muri.setup=function(){kontra.assets.load("room_stasis.png","room_engine.png","room_hydro.png","door_sheet.png","toggleSwitch_sheet.png","keycard.png","laser_sheet.png","stasis_lightSwitch.png","room_lift.png","lift_button.png").then(function(){document.getElementById("loading").style.display="none",muri.modules.forEach(function(m){void 0!==m.init&&m.init()}),muri.rooms.forEach(function(r){void 0!==r.init&&r.init()}),kontra.gameLoop({update:function(){var r=muri.room(muri.currentRoom);void 0!==r.update&&r.update(),muri.modules.forEach(function(m){void 0!==m.update&&m.update()}),muri.get("mouse").isClickReleased()||(muri.get("mouse").releaseClick(),muri.get("bubble").skip())},render:function(){var r=muri.room(muri.currentRoom);void 0!==r.render&&r.render(),muri.modules.forEach(function(m){void 0!==m.render&&"entity"!==m.name&&m.render()}),muri.get("entity").render()}}).start()})},muri}();window.onload=muri.setup,function(){var resolveFn,fragmentTimer,bubble={},dom=document.getElementById("bubble"),delayTimer=null,show=function(text,position){return new Promise(function(resolve){resolveFn=resolve,dom.innerHTML="",dom.style.left=8*position[0],dom.style.top=8*position[1]-18;var parts=text.split(" "),showFragment=function(){0!==parts.length?(dom.innerHTML+=parts.shift()+" ",fragmentTimer=setTimeout(showFragment,140)):delayTimer=setTimeout(resolve,1500)};showFragment()})};bubble.skip=function(what){clearTimeout(fragmentTimer),clearTimeout(delayTimer),dom.innerHTML="",resolveFn&&resolveFn(what||"line")},bubble.talk=function(texts,position){if(0!==texts.length){bubble.skip("talk");var text=texts.shift();return show(text,position||[5,46]).then(function(what){return"talk"===what?Promise.resolve(what):bubble.talk(texts,position)})}dom.innerHTML=""},bubble.story=function(talkList){if(0!==talkList.length){bubble.skip("story");var params=talkList.shift();return bubble.talk(params[0],params[1]).then(function(what){return"story"===what?Promise.resolve(what):bubble.story(talkList)})}dom.innerHTML=""},bubble.name="bubble",muri.modules.push(bubble);var entity={},allEntities=[];entity.get=function(name){for(var i in allEntities)if(allEntities[i].name===name)return allEntities[i];return!1},entity.create=function(name,sprite){var e={name:name,sprite:sprite,callbacks:[],addCallback:function(callback){return this.callbacks.push(callback),this},invisible:!1};return allEntities.push(e),e},entity.update=function(){var clickedOnASprite=!1;allEntities.forEach(function(e){e.name.split(".")[0]===muri.currentRoom&&(e.sprite.update(),muri.get("mouse").clickedOn(e.sprite)&&(clickedOnASprite=!0,e.callbacks.forEach(function(c){c()})))}),clickedOnASprite&&muri.get("mouse").releaseClick()},entity.render=function(){allEntities.forEach(function(e){e.name.split(".")[0]!==muri.currentRoom||e.invisible||e.sprite.render()})},entity.name="entity",muri.modules.push(entity);var mouse={},isEnabled=!0,canvas=document.getElementById("js13k-2017"),mouseSprite=kontra.sprite({x:-1,y:-1,width:1,height:1,color:"green"});canvas.addEventListener("click",function(evt){isEnabled&&(mouseSprite.x=Math.floor(evt.offsetX/8),mouseSprite.y=Math.floor(evt.offsetY/8))}),mouse.clickedOn=function(sprite){return sprite.collidesWith(mouseSprite)},mouse.isClickReleased=function(){return-1===mouseSprite.x&&-1===mouseSprite.y},mouse.releaseClick=function(){mouseSprite.x=-1,mouseSprite.y=-1},mouse.disable=function(){isEnabled=!1,mouse.releaseClick(),canvas.style.cursor="progress"},mouse.enable=function(){isEnabled=!0,canvas.style.cursor="pointer"},mouse.name="mouse",muri.modules.push(mouse);var ebackground,edoor,engine={},lasers=null,eroomState={firstVisit:!0,engineBroken:!0,laserStates:[0,0,0]},randomSounds=function(){var sound=muri.ra(["Brrz ...","EeeeKK!","Rrrrrm deng","Ponk, Ponk, Deng.","Uffz","Pok, Pok, Pok, ..."]),position=[30+Math.floor(50*Math.random()),12+Math.floor(20*Math.random())];muri.get("bubble").talk([sound],position).then(function(){eroomState.engineBroken&&"engine"===muri.currentRoom&&randomSounds()})},laser=function(i){var laserAnimationSheet=kontra.spriteSheet({image:kontra.assets.images.laser_sheet,frameWidth:5,frameHeight:10,animations:{0:{frames:0},1:{frames:1},2:{frames:2}}}),laserSprite=kontra.sprite({x:36+20*i,y:14,animations:laserAnimationSheet.animations});return muri.get("entity").create("engine.laser"+i,laserSprite).addCallback(function(){if(eroomState.engineBroken){var state=eroomState.laserStates[i]+1;state>2&&(state=0),laserSprite.playAnimation(state),eroomState.laserStates[i]=state,2==eroomState.laserStates[0]&&2==eroomState.laserStates[1]&&2==eroomState.laserStates[2]&&(eroomState.engineBroken=!1,muri.get("bubble").talk(["A huge beem light up and the whole ship vibrates.","You've made it, the engine is running again!"]))}})};engine.init=function(){ebackground=muri.bg("engine"),edoor=muri.door("engine",[8,10]),lasers=[laser(0),laser(1),laser(2)]},engine.onEnter=function(){edoor.sprite.playAnimation("close"),eroomState.firstVisit&&(eroomState.firstVisit=!1,muri.get("bubble").talk(["It smells like molted plastic and burned metal in here.","Something is broken here for sure.","I'm afraid that I need to fix this mess somehow ..."])),eroomState.engineBroken&&randomSounds()},engine.render=function(){ebackground.render()},engine.name="engine",engine.roomState=eroomState,muri.rooms.push(engine);var hbackground,hdoor,hydro={},keycard=null;hydro.init=function(){hbackground=muri.bg("hydro"),hdoor=muri.door("hydro",[38,9]),keycard=muri.get("entity").create("hydro.keycard",kontra.sprite({x:55,y:28,image:kontra.assets.images.keycard})).addCallback(function(){muri.get("bubble").talk(["Thats interesting ... ","The keycard from the captain.","That can be handy some day."]),muri.room("lift").roomState.bridgeAccessible=!0,muri.get("entity").get("hydro.keycard").invisible=!0})},hydro.onEnter=function(){hdoor.sprite.playAnimation("close")},hydro.render=function(){hbackground.render()},hydro.name="hydro",muri.rooms.push(hydro);var lbuttonSheet,lift={},lbackground=null,lbuttons=[],lroomState={bridgeAccessible:!1,hydroDoorBroken:!0},createButtonEntity=function(i,room){var e=muri.get("entity").create("lift.button"+i,kontra.sprite({x:59,y:2*i+8+2*i,animations:lbuttonSheet.animations})).addCallback(function(){if(lbuttons.forEach(function(b){b.sprite.playAnimation("off")}),"bridge"!==room)if("hydro"===room&&lroomState.hydroDoorBroken)muri.get("bubble").talk(["The hyperlift moved, but the door to the hydro deck does not open.","You can't access this deck with a broken door."]);else if("shot"!==room){muri.get("entity").get("lift.button"+i).sprite.playAnimation("on");var goMessage=muri.ra(["Sure, "+room,"Okay, straight to "+room,"Set "+room+" for destination",room+", okay"]),noMessage=muri.ra(["No, can't do that for you.","If you say please, than maybee.","What? Can't hear you.","I do not take orders from anyone!!","You? No!"]);Math.floor(10*Math.random())>4?muri.get("bubble").talk([noMessage]):muri.get("bubble").talk([goMessage]).then(function(){muri.changeRoom(room)})}else muri.end(["You stepped into a pressure shot ... ","Which is broken on this ship.","It takes no more than a second to drag you into space.","You are lost ... ....","... and die."],!0);else lroomState.bridgeAccessible?muri.end(["You've made it all the way to the bridge.","The engine is running fine.","You can finally head home and leave this rotten ship.","... ","You crank the throttle all the way up.","...","...","The ship burst apart.","You are lost.","Lost from the very beginning."],!1):muri.get("bubble").talk(["The bridge is not accessible.","You have no sufficient permission to do that."])});return e.sprite.playAnimation("off"),e};lift.init=function(){lbuttonSheet=kontra.spriteSheet({image:kontra.assets.images.lift_button,frameWidth:2,frameHeight:2,animations:{on:{frames:1},off:{frames:0}}}),lbackground=muri.bg("lift"),(lbuttons=[createButtonEntity(0,"bridge"),createButtonEntity(1,"hydro"),createButtonEntity(2,"stasis"),createButtonEntity(3,"shot"),createButtonEntity(4,"engine")])[2].sprite.playAnimation("on")},lift.onEnter=function(fromRoom){var welcomeMessage=muri.ra(["Welcome on board, where do you want?","Please specify your destination.","Insert desired deck on console.","What level please?"]);muri.get("bubble").talk([welcomeMessage])},lift.render=function(){lbackground.render()},lift.name="lift",lift.roomState=lroomState,muri.rooms.push(lift);var sdoor,stasis={},sbackground=null,liftBox=null,sroomState={isDoorOpen:!1,isLightOn:!1,isIntroRunning:!0,hydroDoorBroken:!0,liftSwitches:["off","off","off","off","off"]},toggleLiftSwitch=function(i){if(sroomState.hydroDoorBroken){var newState="on"==sroomState.liftSwitches[i]?"off":"on";muri.get("entity").get("stasis.liftSwitch"+i).sprite.playAnimation(newState),sroomState.liftSwitches[i]=newState}},liftSwitch=function(i){var switchAnimation=kontra.spriteSheet({image:kontra.assets.images.toggleSwitch_sheet,frameWidth:2,frameHeight:1,animations:{off:{frames:0},on:{frames:1}}}),liftSwitchSprite=kontra.sprite({x:95,y:16+2*i,animations:switchAnimation.animations});return muri.get("entity").create("stasis.liftSwitch"+i,liftSwitchSprite).addCallback(function(){toggleLiftSwitch(i);var randomSwitch=Math.floor(Math.random()*sroomState.liftSwitches.length);randomSwitch!==i&&toggleLiftSwitch(randomSwitch);var solved=!0;sroomState.liftSwitches.forEach(function(s){"off"===s&&(solved=!1)}),solved&&(muri.get("bubble").talk(["Once again, the ship shakes.","Something broke off inside the lift and metal scrapes against the hull.","Not sure if this is a good sign ..."]),muri.room("lift").roomState.hydroDoorBroken=!1,sroomState.hydroDoorBroken=!1)})};stasis.init=function(){sbackground=muri.bg("stasis"),muri.get("entity").create("stasis.lightSwitch",kontra.sprite({x:9,y:11,width:3,height:2,image:kontra.assets.images.stasis_lightSwitch})).addCallback(function(){sroomState.isIntroRunning||(sroomState.isLightOn?muri.get("bubble").talk(["No, I will not turn off the light again!"]):(sroomState.isLightOn=!0,muri.get("bubble").talk(["Ah, much better.","Looks like something happened to my stasis capsule."])))}),sroomState.isLightOn||muri.get("bubble").story([[["Beep","Bip, Bip"],[17,15]],[["Urgh ... ...","Where I am?","What happened?"],[40,35]],[["I can't see a thing ...","... need to turn on the light ..."],[40,35]]]).then(function(){sroomState.isIntroRunning=!1})},stasis.onEnter=function(prevRoom){sdoor.sprite.playAnimation("close")},stasis.update=function(){sroomState.isLightOn&&!sdoor&&(sdoor=muri.door("stasis",[76,11]),muri.get("entity").create("stasis.capsule",kontra.sprite({x:21,y:21,width:32,height:8})).addCallback(function(){muri.get("bubble").talk(["That's my stasis capsule.","It looks like the capsule itself is intact but had a malfunction.","I am not an engineer, so I have noe idea whats wrong here ..."])}).invisible=!0),muri.room("engine").roomState.engineBroken||liftBox||(liftBox=kontra.sprite({x:94,y:15,width:4,height:11,color:"#000"}),liftSwitch(0),liftSwitch(1),liftSwitch(2),liftSwitch(3),liftSwitch(4))},stasis.render=function(){sroomState.isLightOn&&(sbackground.render(),liftBox&&liftBox.render())},stasis.name="stasis",muri.rooms.push(stasis),muri.rooms.push({name:"end"})}();