(()=>{let a,b,c,d=!localStorage.getItem('cid'),e='arrows / wasd / zqsd = move<br>Space = shot<br>ctrl + move = precise move<br>Enter = chat<br>M = toggle music',f=(a)=>document.querySelector(a),g=(a)=>document.querySelectorAll(a),h=f('main'),i=f('.info'),j=f('.popup'),k=f('.ac'),l=f('.c'),m=f('.c ul'),n=f('.c form'),o=f('.l'),p=(c='',j)=>{a&&a.disconnect();let n=!0,o=localStorage.getItem('name');m.innerHTML=i.innerHTML='',k.classList.add('h'),l.classList.add('h');let v=()=>{document.body.classList.add('loading'),a=io({query:`name=${encodeURIComponent(o)}&cid=${w}&room=${c}&v=${localStorage.getItem('v')||0}`+(j?`&playersNr=${j}`:'')}),a.on('connect',()=>{document.body.classList.remove('loading'),h.classList.add('ready'),k.classList.remove('h'),l.classList.remove('h'),h.innerHTML='',s('s')}),a.on('disconnect',()=>{h.classList.remove('ready'),h.innerHTML=''}),a.on('error',()=>{h.classList.remove('ready'),h.innerHTML=''}),a.on('rooms',(a)=>{u('Join a room',`<label>Select room<select name="r" required>${a.map((a)=>`<option value="${a.room}|!!|${a.m}">${a.room} ${0<=a.p?a.p:''}${0<=a.m?'/'+a.m:''}</option>`).join('')}</select></label>`,!0).then((a)=>{let b=a.get('r').split('|!!|');p(b[0],b[1])})}),a.on('msg',(a)=>{let b=document.createElement('li');b.innerHTML=`<span class="${a.team}">${a.user}:</span> `+a.text,m.appendChild(b),b.animate([{background:'#000'},{background:'transparent'}],3e3)}),a.on('pong',(a)=>{f('.ping').innerHTML=`ping: ${a}`}),a.on('stats',(a)=>{u(`<h3 class="${a.w}">${a.t}</h3>`,`<table><thead><tr><th>Player</th>${Object.keys(a.p).map((a)=>`<th>${a}</th>`).join('')}<tr><thead><tbody></tbody></table>`);let b={};for(let c in a.p)for(let d in a.p[c]){if(!b[d]){let e=document.createElement('tr');e.classList.add(a.p[c][d].t),e.innerHTML=`<tr><td>${a.p[c][d].name}</td>${Object.keys(a.p).map((a)=>`<td class='${a}'>0</td>`).join('')}</tr>`,b[d]={el:e,vote:a.p.vote[d].v}}let e=a.p[c][d].v;b[d].el.querySelector('.'+c).innerHTML='vote'==c?e.toFixed(2):e}let c=[];for(let d in b)c.push(b[d]);c.sort((c,a)=>a.vote-c.vote),c.forEach((a)=>f('.popup tbody').appendChild(a.el))}),a.on('update',(c)=>{requestAnimationFrame(()=>{if(a&&a.connected){for(let a in c.patches?c.patches.forEach((a)=>{let c=a.k.split('.');b[c[0]][c[1]]||(b[c[0]][c[1]]={}),b[c[0]][c[1]][c[2]]=a.v}):b=c,z(b),b)for(let c in b[a]){let d=f(`#id_${b[a][c].id}`);if(!d){if(d=document.createElement('div'),d.classList.add(a),'p'==a){if(w==b[a][c].cid){d.classList.add('me');let a=document.createElement('div');a.classList.add('sh'),d.appendChild(a),q(d,20,4e3)}n||t(`${b[a][c].name} is now in the room`)}d.setAttribute('id',`id_${b[a][c].id}`),h.appendChild(d),y(b)}for(let e in b[a][c].deleted&&(d.remove(),'p'==a&&(y(b,!0),t(`${b[a][c].name} left`),delete b[a][c])),b[a][c]){let f=b[a][c][e],g=d.dataset[e],h=void 0==g;x(d,b,a,c,e,f,g,h,!h&&g+''!=f+'')}}n=!1}})})},x=(a,b,c,d,e,f,g,i,j)=>{if((i||j)&&(a.style.setProperty(`--${e}`,f),a.dataset[e]=f,'t'==c&&'color'==e&&document.body.style.setProperty(`--color-${b[c][d].id}`,f),'p'==c&&'dir'==e&&f&&a.style.setProperty('--player-rotate',({u:-90,d:90,l:180}[f]||0)+'deg'),'m'==c&&('name'==e&&y(b),('started'==e||'ended'==e)&&(h.classList.toggle(e,f),j&&(s('m'),setTimeout(()=>s('m',2),300),setTimeout(()=>s('m',3),800))))),j){if('t'==c&&'score'==e&&(q(a,20,4e3),r(h),s('g')),'ba'==c){let b=Math.abs(parseInt(f)-parseInt(g));a.animate([{transform:'scale(1)'},{transform:`scale(${4>=b?1.3:2})`},{transform:'scale(1)'}],100),s('b'+(4>=b?'':'l'))}if('p'==c&&('px'==e||'py'==e)&&b[c][d].cid==w){let a=document.createElement('div');a.classList.add('track'),a.classList.add(b[c][d].team),a.style.setProperty(`--px`,b[c][d].px),a.style.setProperty(`--py`,b[c][d].py),h.appendChild(a),a.animate([{opacity:0.5,transform:'scale(1)'},{opacity:0.5,transform:'scale(0.5)'},{opacity:0,transform:'scale(0.1)'}],{delay:200,duration:1500}).onfinish=()=>a.remove()}}},y=(a,b)=>{i.innerHTML='room: '+a.m._.name+` <span>${Object.keys(a.p).length-(b?1:0)}/${a.m._.maxp}</span>`},z=(a)=>{if('number'==typeof a.m._.time){let b=''+a.m._.time,c=b.split('');c.splice(b.length-1,0,'.'),a.m._.time=c.join(''),2==a.m._.time.length&&(a.m._.time='0'+a.m._.time)}};d?u('Welcome','You are about to join a training room<br>Your goal is to put the ball on the side with your color').then(()=>{d=!1,u('Controls',e).then(v)}):(u('vehicle selection',`<input type="hidden" name="v"></input><div class="v"><div class="p me" data-info=""><div class="sh"></div></div><div class="i"><p data-p="rec">energy recovery</p><p data-p="shot">shot power</p><p data-p="hit">hit power</p></div><div class="s">${V.map((a,b)=>`<a href='#${b}' data-i=${b}>${a.n}</a>`).join('')}</div></div>`).then((a)=>{let b=a.get('v');localStorage.setItem('v',b),v()}),g('.v a').forEach((a)=>{a.addEventListener('click',(a)=>{a.preventDefault();let b=a.target.dataset.i,c=f('.v .p');if(c.dataset.v!=a.target.dataset.i){s('v'),g('.sel').forEach((a)=>a.classList.remove('sel')),a.target.classList.add('sel'),f('[name="v"]').value=c.dataset.v=b,c.dataset.name=V[b].n,g('.v p').forEach((a)=>{a.style.setProperty(`--val`,V[b][a.dataset.p])});for(let a=0;7>a;a++)setTimeout(()=>c.dataset.info=V[b].n.split('').sort(()=>0.5-Math.random()).join(''),150*a);setTimeout(()=>c.dataset.info='',1500)}});let b=localStorage.getItem('v')||0;b==a.dataset.i&&a.click()}))},q=(a,b=20,c=1e3)=>{let d=[];for(let e=0;e<b;e++)d.push({opacity:e%2?0:1});a.animate(d,c)},r=(a,b=20,c=1e3)=>{let d=[];for(let e=0;e<b;e++)d.push({transform:e%2?'translateX(-4px)':'translateX(4px)'});a.animate(d,c)},s=(b,c=1)=>{let d=new Audio;d.src=jsfxr({s:[2,,0.6,,0.4,0.36,,-0.2,-0.6,0.02,-0.7,0.6,-0.4,0.2,0.01,0.4,0.4,-0.4,0.9,-0.3,-0.2,0.2,,0.5],b:[,,,,0.2,0.1+0.3*Math.random(),,-0.4,,,,,,0.5,,,,,1,,,,,0.5],bl:[2,,0.05,,0.2,0.7,,-0.4,,,,,,,,,,,1,,,,,0.5],p:[1,0.3,,,0.35,0.4,,,-0.1,,0.6,-0.7,0.8,-1,0.7,0.5,,,0.2,-0.2,,,,0.5],g:[1,,0.06,,0.5,0.45,,0.2,,,,,,,,0.5,,,1,,,,,0.5],v:[1,,0.4,,0.45,0.25,,0.13,,3*Math.random(),3*Math.random(),,,,,,,,1,,,,,0.3],m:[1,,0.2*c,,0.1,0.6,,,,,,,,,,,,,1,,,0.1,,0.5]}[b]),d.play()},t=(a)=>{if(window.SpeechSynthesisUtterance&&window.speechSynthesis){let b=new SpeechSynthesisUtterance(a);b.pitch=0.01,b.rate=0.5,speechSynthesis.speak(b)}},u=(a,b,c)=>new Promise((d)=>{j.innerHTML=`<form><p>${a}</p><br>${b}<br><button>OK</button>${c?'<button type="button">Cancel</button>':''}</form>`,j.classList.remove('h');let e=f('.popup button:nth-of-type(2n)');e&&f('.popup button:nth-of-type(2n)').addEventListener('click',(a)=>{a.preventDefault(),j.innerHTML='',j.classList.add('h')});let g=f('.popup form');g&&f('.popup form').addEventListener('submit',(a)=>{a.preventDefault(),j.innerHTML='',j.classList.add('h'),d(new FormData(a.target))});let h=f('.popup input, .popup select');h&&h.focus()});f('.fs').addEventListener('click',()=>{let a=document.documentElement,b=a.requestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullScreen;b.apply(a)}),f('.ct').addEventListener('click',()=>{u('Controls',e)}),f('.cr').addEventListener('click',()=>{u('Create room',`<label>Room name<input maxlength="14" pattern="[A-Za-z0-9]*" title="only letters and numbers" required autocomplete="off" name="r"></input></label> <label># players <select name="n">${[10,8,6,4,2].map((a)=>`<option value="${a}">${a/2} vs ${a/2}</option>`)}</select></label>`,!0).then((a)=>{p(a.get('r'),a.get('n'))})}),f('.jr').addEventListener('click',()=>{a&&a.emit('roomlist')}),o.addEventListener('submit',(a)=>{a.preventDefault(),f('section').animate([{opacity:1,transform:'scale(1)'},{opacity:0,transform:'scale(9)'}],777),setTimeout(()=>f('section').remove(),500),localStorage.setItem('name',o.querySelector('input').value),p()}),n.addEventListener('submit',(b)=>{b.preventDefault();let c=f('.c input');c.value&&(a.emit('msg',{text:c.value}),c.value=''),l.querySelector('input').blur()});let v={u:[38,90,87],r:[39,68],d:[40,83],l:[37,65,81]};window.addEventListener('keydown',(d)=>{if('INPUT'!=d.target.tagName&&'SELECT'!=d.target.tagName){let e=d.keyCode;if(a&&b&&!b.m._.sleeping){for(let b in v)if(v[b].includes(e)){let c=!d.ctrlKey&&!d.metaKey;a.emit('move',{dir:b,lock:c}),document.activeElement.blur()}32!=e||100!=b.p[a.id].energy||b.p[a.id].powerL||(a.emit('shot'),s('p')),84==e&&a.emit('switch')}13==e&&'BUTTON'!=d.target.tagName&&setTimeout(()=>{l.querySelector('input').focus()},10),77==e&&(c=!c)}});let w=localStorage.getItem('cid')||Math.ceil(1e16*Math.random());localStorage.setItem('cid',w),o.querySelector('input').value=localStorage.getItem('name');let x=new AudioContext,y=x.createScriptProcessor(0,0,1),z=0,A=[[0,1,,,1,0],[5,1,,,4,0],[1,4,,,5,0],[3,1,,,1,3]],B=0;y.onaudioprocess=(a)=>{let b=a.outputBuffer.getChannelData(0);for(let d,e=0;e<b.length;e++)d=2.2*(++z/x.sampleRate),0==z%(2*(0|7.27275*x.sampleRate))&&B++,b[e]=c?0:(Math.random()*((1-2*d%1)**5+8*(1-d/2%1)**16)+d*(32|12&d)*A[B%A.length][5&2*d]%1)/16},y.connect(x.destination)})();