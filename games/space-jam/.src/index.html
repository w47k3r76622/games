<html><head><link href="main.css" rel="stylesheet"></head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.01"><title>JS13k 2021</title><body class="full"><div id="root" class="full flex flex-centered fill-absolute"><canvas class="centered" id="canvas-pre"></canvas><canvas class="centered hide-intro" id="canvas-tiles"></canvas><canvas class="centered hide-intro" id="canvas-instruments"></canvas><canvas class="centered hide-intro" id="canvas-oscillators"></canvas><canvas class="centered hide-intro" id="canvas-audio"></canvas><canvas class="centered hide-intro" id="canvas-post"></canvas><canvas class="centered hide-intro" id="canvas-stats"></canvas><p class="hint" id="hint"></p><div class="full centered flex flex-centered" id="menu" style="visibility: hidden;"><h2 id="menu-notes">Notes:</h2><div class="full flex flex-col flex-centered" id="menu-col"><h1 id="osh" class="mb-2 mt-2">Oscillators</h1><p class="mb-2 text-large">Use oscillators to play instruments</p><div class="mb-5" class="flex flex-centered"><div id="os" class="flex"></div></div><h1 id="inh" class="mb-2">Instruments</h1><p class="mb-2 text-large" style="width: 50%">Use instruments to emit sounds and collect additional notes</p><div class="full" class="flex flex-centered"><div id="dr" class="flex flex-row flex-centered"><p class="row-label">Drums</p></div><div id="bs" class="flex flex-row flex-centered"><p class="row-label">Basic Synths</p></div><div id="cs" class="flex flex-row flex-centered"><p class="row-label">Complex Synths</p></div></div></div></div><div class="flex centered flex-centered" id="inspect" style="visibility: hidden;"><div id="inner-inspect" class="full flex flex-centered flex-col"><button id="close-inspect">✖</button><h1 class="mb-2" id="inspect-name">SnareSound</h1><div class="flex flex-centered"><p>Cost:&nbsp;</p><p class="pink" id="inspect-cost">50</p></div><div class="flex flex-centered mb-2"><p>Notes produced:&nbsp;</p><p class="green" id="inspect-notes">50</p></div><button class="flex flex-centered mb-2" id="sell-button"><p>Sell for&nbsp;</p><p class="green" id="inspect-sell">50</p></button></div></div><button class="mb-5 hide-intro" id="menu-button">✖</button><div id="intro" class="full flex flex-col flex-centered fill-absolute"><h1 id="title" class="mb-2">SPACE JAM</h1><p class="text-lg">You are the first to reach the planet Mixolydia,</p><p class="text-lg mb-2">where the only resource is sound...</p><p class="text-lg mb-5">What will you make of this new frontier?</p><div class="flex"><button disabled="disabled" id="start">Start</button></div></div></div><div id="templates" class="hidden"><div class="flex flex-col flex-centered m-1"><p class="mb-half"></p><button class="entity-button"><canvas class="full"></canvas></button><div class="flex"><span class="item-stats pink"><!-- cost # --> </span><span class="item-stats"><!-- / --> </span><span class="item-stats green"><!-- notes # --></span></div></div></div><script>(()=>{"use strict";var t={d:(s,e)=>{for(var i in e)t.t(e,i)&&!t.t(s,i)&&Object.defineProperty(s,i,{i:!0,get:e[i]})},t:(t,s)=>Object.prototype.hasOwnProperty.call(t,s)};t.d({},{a:()=>hs});const s="rgba(0,0,0,0)",e="#FFFFFF",i="#272838",n="rgba(189, 91, 255, .2)",h="#ff4c7a",o="#00f9ff",r="#00e19e",c="rgba(0, 225, 158, .2)",a="#B0C4DE",u={root:document.getElementById("root"),h:document.getElementById("canvas-tiles"),o:document.getElementById("canvas-pre"),u:document.getElementById("canvas-post"),l:document.getElementById("canvas-audio"),p:document.getElementById("canvas-stats"),m:document.getElementById("canvas-oscillators"),v:document.getElementById("canvas-instruments"),M:document.getElementById("menu"),g:document.getElementById("menu-button"),q:document.getElementById("menu-col"),k:document.getElementById("menu-notes"),hint:document.getElementById("hint"),T:document.getElementById("inspect"),A:document.getElementById("inner-inspect"),O:document.getElementById("close-inspect"),$:document.getElementById("inspect-name"),F:document.getElementById("inspect-cost"),S:document.getElementById("inspect-notes"),B:document.getElementById("inspect-sell"),P:document.getElementById("sell-button"),R:document.getElementById("intro"),start:document.getElementById("start")},l={C:u.h?.getContext("2d"),U:u.o?.getContext("2d"),L:u.u?.getContext("2d"),N:u.p?.getContext("2d"),j:u.l?.getContext("2d"),X:u.m?.getContext("2d"),Y:u.v?.getContext("2d")},p=2*Math.PI;class m{constructor({type:t,H:s=!1}={}){this.type=t,this.H=s}}class d{constructor(t=0,s=0){this.x=t,this.y=s}set(t,s){this.x=t,this.y=s}I(){return this.x+this.y}}const w=new class{constructor(t){this.canvas=t}V(t){return this.canvas.width*((t+1)/2)}D(t){return this.canvas.height*((t+1)/2)}width(t=1,s=!1){return this.canvas.width*t/(s?window.devicePixelRatio:1)}height(t=1,s=!1){return this.canvas.height*t/(s?window.devicePixelRatio:1)}}(u.h),y=t=>t-63,v=t=>t-63,f=t=>t+63,x=t=>t+63,M=t=>w.width(.5)+(t-Z.position.x)*w.width(.06)-w.width(.03),b=t=>w.height(.5)+(Z.position.y-t)*w.width(.06)-w.width(.03),g=t=>{const{left:s,right:e}=u.h.getBoundingClientRect();if(!(t<s||t>e)){const e=w.width()/w.width(.06),i=(t-s)/w.width(1,!0),n=-e/2+i*e+Z.position.x;return Math.round(n)}},q=t=>{const{top:s,bottom:e}=u.h.getBoundingClientRect();if(!(t<s||t>e)){const i=w.height()/w.width(.06),n=(e-t-s)/w.height(1,!0),h=-i/2+n*i+Z.position.y;return Math.round(h)}},k=t=>M(y(t)),T=t=>b(v(t)),E=t=>void 0===t,A=t=>{t.width=t.clientWidth*window.devicePixelRatio||1,t.height=t.clientHeight*window.devicePixelRatio||1},O=(t,s,e)=>Math.max(s,Math.min(t,e)),$=(t,s,e)=>t*e+s*(1-e),F=t=>{const s=t/1e6;if(s>1)return s.toFixed(2)+"M";const e=t/1e3;return e>1?e.toFixed(2)+"K":t+""},S=t=>new Float32Array(t),B=()=>Math.random(),P=(t,s,e=Y.context.currentTime)=>{s&&s.forEach((({value:s,time:i,exp:n=!1})=>{n?t.exponentialRampToValueAtTime(s,e+i):t.linearRampToValueAtTime(s,e+i)}))},R=t=>{let s;return s=t>0?2:.5,I*Math.pow(Math.pow(s,1/12),Math.abs(t))},C=(t=Y.context,s,e,i)=>{const n=t.createBiquadFilter();return n.frequency.value=e,n.type=s,i&&n.connect(i),n},U=t=>{const s=O((t.position.x-Z.position.x)/7,-1,1),e=O((t.position.y-Z.position.y)/7,-1,1),i=Math.sqrt(s**2+e**2);t.K.pan.pan.value=s,t.K.J(Math.abs(s)),t.K.G(O(1-i,0,1))},L=(t,s=256)=>{const e=100*t,i=new Float32Array(s),n=Math.PI/180;for(let t=0;t<s;t++){let h=2*t/s-1;i[t]=(3+e)*h*20*n/(Math.PI+e*Math.abs(h))}return i};class N{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}),this.context.suspend(),this.W=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,88200,44100),this.Z=this.context.createAnalyser(),this.Z.fftSize=64,this._=new Uint8Array(this.Z.frequencyBinCount),this.tt=this.context.createDynamicsCompressor(),this.tt.threshold.value=-24,this.tt.knee.value=24,this.tt.ratio.value=12,this.tt.attack.value=0,this.tt.release.value=.25,this.st=this.context.createGain(),this.st.connect(this.Z),this.Z.connect(this.context.destination),this.et=this.context.createConvolver(),this.et.connect(this.st)}async init(){const t=await this.it();this.et.buffer=t,this.et.connect(this.st)}async it(){return new Promise((t=>{const s=this.W.createGain();s.connect(this.W.destination),s.gain.setValueAtTime(1,0),s.gain.exponentialRampToValueAtTime(1e-4,2);const e=C(this.W,"lowpass",5e3,s),i=C(this.W,"highpass",500,e),n=this.W.createBufferSource();n.buffer=(t=>{const s=44100*t,e=S(s),i=S(s);for(let t=0;t<s;t++)e[t]=1-2*B(),i[t]=1-2*B();const n=Y.context.createBuffer(2,s,44100);return n.getChannelData(0).set(e),n.getChannelData(1).set(i),n})(2),n.connect(i),n.start(),this.W.startRendering(),this.W.oncomplete=s=>{t(s.renderedBuffer)}}))}}N.nt=196,N.ht=2,N.ot=44100;const j=class{constructor(){this.rt=[],this.ct=0}at(t,s){this.ct++;const e=this.ct,i=Y.context.createBuffer(1,1,44100),n=Y.context.createBufferSource();return n.buffer=i,n.connect(Y.context.destination),this.rt.push({id:e,time:t,type:"single",source:n}),n.onended=()=>{s(),this.cancel(e)},n.start(t-i.duration),e}ut(t){t.count++;const s=Y.context.createBufferSource();s.buffer=t.source.buffer,s.connect(Y.context.destination),s.onended=()=>{t.lt(),this.ut(t)},s.start(t.time+t.count*t.frequency-s.buffer.duration),t.source=s}dt(t,s,e){const i=Y.context.createBuffer(1,1,44100),n=Y.context.createBufferSource();n.buffer=i,n.connect(Y.context.destination);const h={id:++this.ct,count:0,time:t,frequency:s,type:"repeating",lt:e,source:n};return n.onended=()=>{e(),this.ut(h)},n.start(Math.max(0,t-i.duration)),this.rt.push(h),h.id}wt(t){return this.rt.find((s=>s.id===t))}clear(){this.rt.forEach((t=>{t.source.onended=null,t.source.stop(),t.source.disconnect()})),this.rt.length=0}cancel(t){const s=this.wt(t);if(s){s.source.onended=null;try{s.source.stop()}catch(t){}s.source.disconnect(),this.rt=this.rt.filter((t=>t.id!==s.id))}}},X=[0,4,5,7,10],Y=new N,H=new j,I=196,V="Tahoma, sans-serif",z=()=>{A(u.l),l.j.lineWidth=w.width(.006),l.L.strokeStyle=e,Y.Z.getByteFrequencyData(Y._);const t=Y._.reduce(((t,s)=>t+s))/Y.Z.frequencyBinCount;for(let s=0;s<5;s++)l.j.strokeStyle=`rgba(255,255,255,${1-(s+1)/5})`,l.j.arc(w.V(0),w.D(0),w.width(.42)+t*s/6,0,p),l.j.stroke()},Q=(t,s,e=!1,i=!0,n=l.C)=>{i&&n.strokeRect(t,s,w.width(.06),w.width(.06)),e&&n.fillRect(t,s,w.width(.06),w.width(.06))},D=t=>{t.beginPath(),t.arc(w.V(0),w.D(0),w.width(.42),0,p),t.clip()},K=(t,s,e)=>{t.save(),t.strokeStyle=s,t.lineWidth=w.width(.2),t.beginPath(),e.forEach((([s,e],i)=>{const n=w.V(s),h=w.D(e);0===i?t.moveTo(n,h):t.lineTo(n,h)})),t.stroke(),t.restore()},J=(t,s,e,i,n)=>{t.save(),t.translate(s,e),t.rotate(n),t.translate(-s,-e),t.beginPath(),t.moveTo(s,e-i/2),t.quadraticCurveTo(s,e,s+i/2,e),t.quadraticCurveTo(s,e,s,e+i/2),t.quadraticCurveTo(s,e,s-i/2,e),t.quadraticCurveTo(s,e,s,e-i/2),t.restore()};const G={yt:0,vt:{ft:!1,M:!0,escape:!1},xt:!0,Mt:!1,bt:!1},W={gt:0,qt:0},Z=new class extends m{constructor({type:t="camera",coords:s}){super({type:t}),this.coords=s,this.position=new d,this.kt=new d,this.Tt={Et:void 0,At:void 0,Ot:void 0,$t:void 0},this.Ft()}Ft(){const t=Math.round(this.position.x),s=Math.round(this.position.y);this.Tt={Et:Math.max(0,f(t-7)),At:Math.min(126,f(t+7)),Ot:Math.max(0,x(s-7)),$t:Math.min(126,x(s+7))}}St(){this.Ft(),A(u.h),l.C.fillStyle=i,l.C.strokeStyle=e,l.C.lineWidth=w.width(.006),D(l.C),l.C.fillRect(0,0,w.width(),w.height()),Z.Bt(((t,s,e)=>{Q(k(s),T(e))}))}Bt(t){for(let s=this.Tt.Et;s<=this.Tt.At;s++)for(let e=this.Tt.Ot;e<=this.Tt.$t;e++)t(_[s][e],s,e)}Pt(){(()=>{if(A(u.p),G.Mt)return;l.N.font=`${w.width(.11249999999999999)}px ${V}`,l.N.fillStyle=e,l.N.textAlign="center";const t="SPACE JAM",s=l.N.measureText(t);l.N.font=`${w.width(.11249999999999999)}px Impact`,l.N.fillText(t,w.V(0),w.D(-.78));const i="Notes: "+F(W.gt);l.N.font=`${w.width(.075)}px ${V}`,l.N.fillText(i,w.V(0),w.D(-.78)+s.actualBoundingBoxAscent);const n=`Camera: (x: ${Math.round(Z.position.x)}, y: ${Math.round(Z.position.y)})`;l.N.font=`${w.width(.0375)}px ${V}`,l.N.fillText(n,w.V(0),w.D(-.78)+1.75*s.actualBoundingBoxAscent),l.N.textAlign="right";const h="Score: "+F(W.qt);l.N.font=`${w.width(.0375)}px ${V}`;const o=l.N.measureText(h);if(l.N.fillText(h,w.V(.95),w.D(-1)+o.actualBoundingBoxAscent+w.width(.025)),G.vt.M){l.N.lineWidth=w.width(.006),l.N.strokeStyle=e,l.N.beginPath();const t="Main Menu";l.N.fillText(t,w.V(-.45)+l.N.measureText(t).width/2,w.D(.7)),l.N.moveTo(w.V(-.45),w.D(.725)),l.N.quadraticCurveTo(w.V(-.35),w.D(.825),w.V(-.15),w.D(.825)),l.N.moveTo(w.V(-.15),w.D(.825)),l.N.lineTo(w.V(-.2),w.D(.795)),l.N.moveTo(w.V(-.15),w.D(.825)),l.N.lineTo(w.V(-.2),w.D(.855)),l.N.stroke()}})(),this.Bt(((t,s,n)=>{const{Rt:h,state:o}=t;"instrument"===h?.type&&"playing"===o&&((t,s,n,h,o)=>{const r=s.width(.0165);t.fillStyle=i,t.globalAlpha=1,t.beginPath(),t.arc(n,h,r,0,p),t.fill(),t.globalAlpha=1,t.font=`${s.width(.01875)}px ${V}`,t.textAlign="center",t.fillStyle=e;const c="+"+o,a=t.measureText(c);t.fillText(c,n,h+a.actualBoundingBoxAscent/2)})(l.N,this.coords,M(y(s)+.5),b(v(n)-.5),h.Ct)})),A(u.m),l.X.lineCap="round",l.X.lineJoin="round",l.X.lineWidth=w.width(.006),D(l.X),Z.Bt((({Rt:t})=>{"oscillator"===t?.type&&t.Pt()})),A(u.v),l.Y.font=`${w.width(.01875)}px ${V}`,l.Y.textAlign="center",l.Y.fillStyle=i,l.Y.strokeStyle=e,l.Y.lineWidth=w.width(.006),l.Y.lineJoin="round",D(l.Y),Z.Bt((({Rt:t})=>{"instrument"===t?.type&&t.Pt()})),this.Ut?.Pt()}}({coords:w}),_=Array.from({length:127}).map((()=>Array.from({length:127},Object))),tt=new Array(100).fill(null).map((()=>[1-2*Math.random(),1-2*Math.random(),.001*(1+Math.random()),Math.random()*p])),st=new Array(2).fill(null).map((()=>new Array(10).fill(null).map(((t,s)=>[.5-Math.random(),2.2*s/9-1.1]))));class et extends m{constructor(t={}){super(t);const{x:s,y:e,Lt:i=!1,id:n=""}=t;this.id=n,this.Lt=i,this.position=new d(s,e),this.Nt=0,this.jt=a}}class it extends et{constructor(t){super(t),this.type="instrument",this.color=r}init(){this.Xt=(t=>{let s=0,e=0,i=0,n=0;return t.forEach((t=>{const[h,o]=t;h<s&&(s=h),h>i&&(i=h),o<e&&(e=o),o>n&&(n=o)})),{Yt:s,Ht:i,It:e,Vt:n}})(this.outline),this.shape=((t,s,e)=>{const{Yt:i,Ht:n,It:h,Vt:o}=e,r=[],c=new Path2D;((t,s)=>{for(let e=0;e<s.length;e++){const[i,n]=s[e];0===e?t.moveTo(i,n):t.lineTo(i,n)}})(c,s);for(let s=i;s<n;s++)for(let e=h;e<o;e++)t.isPointInPath(c,s+.5,e+.5)&&r.push([s,e+1]);return r})(l.Y,this.outline,this.Xt),this.zt=this.Xt.Ht-this.Xt.Yt,this.Qt=this.Xt.Vt-this.Xt.It,this.Lt||this.Dt(),this.Kt=Math.round(this.Jt/3),U(this)}Gt(){const{Et:t,At:s,Ot:e,$t:i}=Z.Tt,{x:n,y:h}=this.position,o=f(n),r=x(h),c=_[o][r],a=o>t&&o<s&&r>e&&r<i,u=Boolean(c.Rt),l=c.Wt||!1,p=this.shape.some((([t,s])=>_[o+t][r+s].Wt||Boolean(_[o+t][r+s].Rt)));return a&&!u&&!l&&!p}Dt(){this.Lt=!1;const t=f(this.position.x),s=x(this.position.y);_[t][s].Rt=this,this.shape.forEach((([e,i])=>{_[t+e][s+i].Wt=!0}))}Zt(){const t=f(this.position.x),s=x(this.position.y);_[t][s]=new Object,this.shape.forEach((([e,i])=>{_[t+e][s+i].Wt=!1}));for(let e=t-1;e<=t+1;e++)for(let t=s-1;t<=s+1;t++){const s=_[e][t];if("oscillator"===s?.Rt?.type){s.Rt._t()}}}Pt(t=l.Y,s=!0){t.save(),t.beginPath();for(let s=0;s<this.outline.length;s++){const[e,i]=this.outline[s],n=M(this.position.x+e),h=b(this.position.y+i);0===s?t.moveTo(n,h):t.lineTo(n,h)}t.closePath(),t.clip();const{Yt:n,Vt:h}=this.Xt,c=w.width(.06)*this.Qt,u=w.width(.06)*this.zt,m=M(this.position.x+n),d=b(this.position.y+h),y=t.createLinearGradient(m,d,m+u,d+c);if(y.addColorStop(0,r),y.addColorStop(1,o),t.fillStyle=this.disabled?a:y,t.fillRect(m,d,u,c),t.stroke(),s){const s=M(this.position.x+.5),n=b(this.position.y-.5);t.fillStyle=e,t.beginPath(),t.arc(s,n,w.width(.015),0,p),t.fill(),t.fillStyle=i;const h=this.display.substr(0,1),o=t.measureText(h);t.fillText(this.display.substr(0,2),s,n+o.actualBoundingBoxAscent/2)}t.restore()}}class nt{constructor(t={}){this.note=t.note,this.ts=0,this.pan=Y.context.createStereoPanner(),this.ss=Y.context.createGain(),this.es=Y.context.createGain(),this.ns=Y.context.createGain(),this.hs=0,this.os={baseVolume:.5,baseReverb:0,lpEnvQ:1.7,hpEnvQ:1.7}}play(t,s=this.rs()){}cs(){if(!this.us)return!1;let t=!1;for(let s in Object.values(this.us)){s.length>0&&(t=!0);break}return t}ls(){const t=(this.us?.filters||[]).map((({ps:t,type:s,frequency:e,gain:i})=>{const n=Y.context.createBiquadFilter();return n.type=s,t&&(n.Q.value=t),e&&(n.frequency.value=e),i&&(n.gain.value=i),n})),s=(this.us?.ds||[]).map((({threshold:t,attack:s,knee:e,ratio:i,release:n})=>{const h=Y.context.createDynamicsCompressor();return h.threshold.value=t,h.attack.value=s,h.knee.value=e,h.ratio.value=i,h.release.value=n,h})),e=[...(this.us?.ws||[]).map((t=>{const s=Y.context.createWaveShaper();return s.curve=t.curve,s})),...t,...s];return e.forEach(((t,s,e)=>{s!==e.length-1&&t.connect(e[s+1])})),e}J(t){E(t)||(this.hs=t),this.ss.gain.value=1-this.hs-this.os.baseReverb,this.es.gain.value=this.os.baseReverb+this.hs}G(t){E(t)||(this.ys=t),this.ns.gain.value=O(this.os.baseVolume*this.ys,0,1)}vs(t,s,e={}){const i=Y.context.createGain();P(i.gain,this.fs.amplitude),this.J();const n=Y.context.createBiquadFilter();n.type="lowpass",n.frequency.value=2e4,n.Q.value=this.xs("lpEnvQ",e.lpEnvQ);const h=Y.context.createBiquadFilter();h.type="highpass",h.frequency.value=20,h.Q.value=this.xs("hpEnvQ",e.hpEnvQ),this.G(),this.fs?.Ms&&P(n.frequency,this.fs.Ms),this.fs?.bs&&P(h.frequency,this.fs.bs);const{source:o,gain:r}=s;if(o.connect(r),r.connect(i),i.connect(n),n.connect(h),this.cs()){const t=this.ls(),s=t[0],e=t.pop();h.connect(s),e.connect(this.ns)}else n.connect(this.ns);this.ns.connect(this.pan),this.pan.connect(this.ss),this.pan.connect(this.es),this.ss.connect(Y.st),this.es.connect(Y.et),o.start(t),o.stop(t+this.duration),o.onended=()=>{o.disconnect()}}gs(t,s,e={}){let i;const n=Y.context.createGain(),h=this.rs(s);if("waveform"===t){const{qs:t}=e;i=Y.context.createOscillator(),i.type=t,i.frequency.value=R(h)}if("harmonics"===t){const{ks:t,qs:s}=e;if(i=Y.context.createOscillator(),i.type=s,E(t))throw new Error("harmonic option required");n.gain.value=.2/(1+Math.log2(t)),i.frequency.value=R(h)*t}if("waveform"!==t&&"harmonics"!==t||(this.duration=this.fs.amplitude?.map((({time:t})=>t)).reduce(((t,s)=>t+s))||0),"sample"===t){const{buffer:t}=e;i=Y.context.createBufferSource(),i.buffer=t,this.duration=t.duration}return{source:i,gain:n,note:s}}xs(t,s){return E(s)?this.os[t]:s}rs(t){return E(t)?E(this.note)?this.ts+X[Math.floor(Math.random()*X.length)]:this.ts+this.note:this.ts+t}}class ht extends nt{constructor(t={}){super(t),this.ts=-24,this.fs={amplitude:[{time:0,value:1},{time:.75,value:1e-4,exp:!0}]},this.us={ws:[{curve:L(.2)}]},this.os.baseVolume=.5}play(t,s){const e=this.gs("waveform",s,{qs:"sine"});this.vs(t,e)}}class ot extends it{constructor(t={}){super(t),this.Ts="dr",this.display="Kick",this.Jt=50,this.Ct=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new ht({note:0}),this.init()}}class rt extends nt{constructor(t={}){super(t),this.ts=0,this.fs={amplitude:[{time:0,value:0},{time:.015,value:1},{time:.45,value:1e-4,exp:!0}]},this.us={filters:[{type:"highpass",frequency:90,ps:1.7}]},this.os.baseReverb=.05,this.os.baseVolume=.25}play(t,s=this.rs()){const e=this.gs("waveform",s,{qs:"sine"});e.gain.gain.value=.3;const i=this.gs("sample",s,{buffer:Y.et.buffer});i.gain.gain.value=.5,this.vs(t,e),this.vs(t,i)}}class ct extends it{constructor(t={}){super(t),this.Ts="dr",this.display="Snare",this.Jt=25,this.Ct=2,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new rt({note:0}),this.init()}}class at extends et{constructor(t={}){super(t),this.type="oscillator",this.Es=[]}init(){this.Lt||this.Dt(),this.Kt=Math.round(this.Jt/3)}As(){return Y.context.currentTime%this.duration/this.duration}Gt(){const{Et:t,At:s,Ot:e,$t:i}=Z.Tt,{x:n,y:h}=this.position,o=f(n),r=x(h),c=_[o][r],a=o>t&&o<s&&r>e&&r<i,u=Boolean(c.Rt),l=c.Wt||!1;return a&&!u&&!l}Dt(){this.Lt=!1,_[f(this.position.x)][x(this.position.y)].Rt=this,this.Es.forEach((t=>{H.cancel(t)})),this._t()}Zt(){const t=f(this.position.x),s=x(this.position.y);_[t][s]=new Object,this.Os()}Pt(){const t=M(this.position.x+.5),s=b(this.position.y-.5);this.$s(t,s),this.Fs(t,s),this.Lt&&(l.X.globalAlpha=.5,this.Ss.forEach((t=>{const[s,e]=t;l.X.beginPath(),Q(M(this.position.x+s),b(this.position.y+e),!0,!1,l.X)})),l.X.globalAlpha=1)}Fs(t,s){l.X.moveTo(t,s);const e=this.As();let i,n;for(let t=0;t<this.Ss.length;t++){const s=(t+1)/this.Ss.length;if(e<s){const h=(s-e)*this.Ss.length;i=M(this.position.x+.5+$(this.Ss[t][0],this.Ss[(t+1)%this.Ss.length][0],h)),n=b(this.position.y-.5+$(this.Ss[t][1],this.Ss[(t+1)%this.Ss.length][1],h)),l.X.lineTo(i,n),l.X.stroke(),l.X.beginPath(),l.X.arc(i,n,w.width(.015),0,p),l.X.fill();break}}}$s(t,s){}Os(){this.Es.forEach((t=>{H.cancel(t)}))}_t(){this.Os();const t=f(this.position.x),s=x(this.position.y),e=Math.ceil(Math.max(this.As()||.1)*this.Ss.length),i=(t=>{const s=Y.context.currentTime/t;return(Math.floor(s)+1)*t})(this.interval);for(let n=0;n<this.Ss.length;n++){const h=i+n*this.interval,o=(n+e)%this.Ss.length,r=this.Ss[o],c=_[t+r[0]][s+r[1]];this.Es.push(H.dt(h,this.duration,(()=>{if("instrument"===c?.Rt?.type&&"playing"!==c.state){c.state="playing";const t=c.Rt,s=t.Ct;this.Nt+=s,W.gt+=s,W.qt+=s,t.Nt+=s,t.K.ys>0&&t.K.play(Y.context.currentTime),H.at(Y.context.currentTime+.5142857142857142,(()=>{c.state="stopped"}))}})))}}}class ut extends at{constructor(t={}){super(t)}init(){this.Ss=[[0,this.Bs],[this.Bs,0],[0,-this.Bs],[-this.Bs,0]],this.duration=this.interval*this.Ss.length,super.init()}$s(t,s,e=l.X,i=w.width(.048),n=w.width(.006),h=(this.disabled?this.jt:this.color)){e.strokeStyle=h,e.fillStyle=h,e.lineWidth=n,e.beginPath(),e.arc(t,s,i/2,0,p)}Fs(t,s){l.X.moveTo(t,s);const e=((t,s,e,i,n)=>({x:Math.cos(n)*(t-e)-Math.sin(n)*(s-i)+e,y:Math.sin(n)*(t-e)+Math.cos(n)*(s-i)+i}))(t+w.width(.06*this.Bs),s,t,s,p*this.As()-Math.PI/2);l.X.lineTo(e.x,e.y),l.X.stroke(),l.X.beginPath(),l.X.arc(e.x,e.y,w.width(.015),0,p),l.X.fill()}}class lt extends ut{constructor(t={}){super(t),this.display="Circle",this.Jt=25,this.Bs=1,this.color=h,this.interval=.8571428571428571,this.init()}}const pt={screenX:void 0,screenY:void 0,Ps:void 0,Rs:void 0},mt=new class{constructor(t,s){this.x=t,this.y=s}}(9,16),dt=t=>{let s;switch(t){case"menu":G.vt.M=!0;break;case"drag":s="Hint: click and drag the map to move around and build in new places",G.vt.ft=!0;break;case"escape":s="Hint: press `Escape` to cancel your placement.",G.vt.escape=!0;break;case"hide":Object.keys(G.vt).forEach((t=>G.vt[t]=!1)),s=""}u.hint.innerHTML=s},wt=()=>{G.vt.M&&(G.vt.M=!1),"hidden"===u.M.style.visibility?(u.M.style.visibility="visible",u.g.style.transform="rotate(0deg)",G.Mt=!0,ft(),G.bt&&yt(),Z.Ut=null,document.addEventListener("mousedown",gt)):(u.M.style.visibility="hidden",u.g.style.transform="rotate(45deg)",G.Mt=!1,document.removeEventListener("mousedown",gt))},yt=()=>{"hidden"===u.T.style.visibility?(u.T.style.visibility="visible",G.bt=!0,vt(),document.addEventListener("mousedown",gt)):(u.T.style.visibility="hidden",G.bt=!1,Z.Cs=null,document.removeEventListener("mousedown",gt))},vt=()=>{if(Z.Cs){const t=Math.round(Z.Cs.Jt/3);u.F.innerHTML=F(Z.Cs.Jt),u.$.innerHTML=Z.Cs.display,u.S.innerHTML=F(Z.Cs.Nt),u.B.innerHTML=F(t)}},ft=()=>{u.k.innerHTML="Notes: "+F(W.gt),document.querySelectorAll(".entity-button").forEach((t=>{parseInt(t.getAttribute("cost"))<=W.gt?t.disabled&&(t.disabled=!1):t.disabled||(t.disabled=!0)}))},xt=()=>{const t=document.querySelectorAll(".hide-intro");t.forEach((t=>{t.style.opacity="1"})),u.R.style.transform="translate(0, -100%)",window.setTimeout((()=>{hs(),t.forEach((t=>t.style.transitionDuration="0ms"))}),1e3)},Mt=()=>{Z.Cs&&(Z.Cs.Zt(),W.gt+=Z.Cs.Kt,W.qt+=Z.Cs.Kt,yt())},bt=()=>{A(u.o),l.U.fillStyle="white",l.U.strokeStyle="white",tt.forEach((([t,s,e,i])=>{l.U.lineWidth=w.width(e),J(l.U,w.V(t),w.D(s),w.width(6*e),i),l.U.fill(),l.U.stroke()})),K(l.U,n,st[0]),K(l.U,c,st[1]),(()=>{const t=l.L.createRadialGradient(w.V(0),w.D(0),w.width(.21),w.V(0),w.D(0),w.width(.42));t.addColorStop(0,s),t.addColorStop(.25,s),t.addColorStop(1,i),A(u.u),l.L.lineWidth=w.width(.006),l.L.strokeStyle=e,l.L.fillStyle=t,l.L.beginPath(),l.L.arc(w.V(0),w.D(0),w.width(.42),0,p),l.L.fill(),l.L.stroke()})(),Z.St()},gt=t=>{!G.Mt||u.M.contains(t.target)||u.g.contains(t.target)||wt(),G.bt&&!u.A.contains(t.target)&&yt()},qt=t=>{"Escape"===t.key&&G.Mt&&wt()},kt=t=>{"Escape"===t.key&&G.bt&&yt()},Tt=t=>{pt.screenX=t.x,pt.screenY=t.y,pt.Ps=g(t.x),pt.Rs=q(t.y)},Et=t=>{if(Y.context.resume(),!G.Mt&&!G.bt){const s=.06*u.h.clientWidth;let e=t.clientX,i=t.clientY;const{x:n,y:h}=Z.position,o=t=>{G.vt.ft&&dt("hide");const o=t.clientX-e,r=t.clientY-i;Z.position.set(n-o/s,h+r/s),Z.St();for(let t=Z.Tt.Et;t<=Z.Tt.At;t++)for(let s=Z.Tt.Ot;s<=Z.Tt.$t;s++){const e=_[t][s]?.Rt;"instrument"===e?.type&&U(e)}},r=()=>{document.removeEventListener("mousemove",o),document.addEventListener("mousemove",Tt)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r,{once:!0}),document.removeEventListener("mousemove",Tt)}},At=()=>{!Z.Cs||G.bt||Z.Ut||yt()},Ot=()=>{if(G.Mt||G.bt)return;if(E(pt.Ps)||E(pt.Rs))return;const t=f(pt.Ps),s=x(pt.Rs);if(E(t)||E(s))return;const e=_[t][s];return Z.Cs=e.Rt,e.Rt?u.p.style.cursor="pointer":Z.Ut||(u.p.style.cursor="grab"),e},$t=()=>{[u.h,u.o,u.u,u.l,u.p,u.m,u.v,u.M,u.T].forEach((t=>{(t=>{const s=t.parentElement;new ResizeObserver((()=>{const{width:e,height:i}=s.getBoundingClientRect(),n=Math.min(e/mt.x,i/mt.y),h=n*mt.x,o=n*mt.y,r=window.devicePixelRatio||1;t.width=h*r,t.height=o*r,t.style.width=h+"px",t.style.height=o+"px",Z.St()})).observe(s)})(t)})),u.start.addEventListener("click",xt),u.g.addEventListener("click",wt),u.O.addEventListener("click",yt),u.P.addEventListener("click",Mt),document.addEventListener("keydown",qt),document.addEventListener("keydown",kt),document.addEventListener("mousemove",Tt),document.addEventListener("mousemove",Ot),document.addEventListener("mousedown",Et),document.addEventListener("click",At);new ResizeObserver(bt).observe(u.root)};class Ft extends nt{constructor(t={}){super(t),this.ts=36,this.fs={amplitude:[{time:0,value:1},{time:.2,value:0}]},this.os.baseReverb=.25,this.os.baseVolume=.09,this.us={filters:[{type:"lowpass",frequency:1500,ps:.71},{type:"highpass",frequency:250,ps:1.2}]}}play(){[this.gs("waveform",X[0],{qs:"sine"}),this.gs("waveform",X[1],{qs:"sine"}),this.gs("waveform",X[3],{qs:"sine"}),this.gs("waveform",X[4],{qs:"sine"})].forEach(((t,s)=>{window.setTimeout((()=>{this.vs(Y.context.currentTime,t)}),.10714285714285714*s*1e3)}))}}class St extends it{constructor(t={}){super(t),this.Ts="cs",this.display="Cosmic Ray",this.Jt=5e3,this.Ct=75,this.outline=[[0,0],[1,0],[1,1],[2,1],[2,0],[2,-1],[1,-1],[0,-1],[0,-2],[-1,-2],[-1,-1],[-1,0]],this.K=new Ft,this.init()}}class Bt extends nt{constructor(t){super(t)}play(t,s){this.Us?.forEach((e=>{const i=this.gs("harmonics",s,{qs:"sine",ks:e});this.vs(t,i)})),this.Ls?.forEach((e=>{const i=this.gs("harmonics",s,{qs:"square",ks:e});this.vs(t,i)})),this.Ns?.forEach((e=>{const i=this.gs("harmonics",s,{qs:"sawtooth",ks:e});this.vs(t,i)}))}}class Pt extends Bt{constructor(t={}){super(t),this.Ns=[0,2,4],this.ts=-24,this.fs={amplitude:[{time:0,value:0},{time:.5,value:1},{time:.75,value:0}]},this.os.baseReverb=.2,this.os.baseVolume=.4}}class Rt extends it{constructor(t={}){super(t),this.Ts="cs",this.display="Harmonix",this.Jt=500,this.Ct=15,this.outline=[[0,0],[0,1],[1,1],[1,0],[2,0],[3,0],[3,-1],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-2,-1],[-2,0],[-1,0]],this.K=new Pt,this.init()}}class Ct extends nt{constructor(t={}){super(t),this.ts=0,this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.25,value:1e-4,exp:!0}]},this.us={filters:[{type:"highpass",frequency:350,ps:1.7},{type:"peaking",gain:-12,frequency:8780,ps:.85},{type:"lowpass",frequency:18e3,ps:.59}]},this.os.baseVolume=.1}play(t,s){const e=this.gs("sample",s,{buffer:Y.et.buffer});e.source.detune.value=2400,this.vs(t,e)}}class Ut extends it{constructor(t={}){super(t),this.Ts="dr",this.display="HiHat",this.Jt=5,this.Ct=1,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new Ct({note:0}),this.init()}}class Lt extends Bt{constructor(t={}){super(t),this.Us=[1,2,4,8],this.fs={amplitude:[{time:0,value:0},{time:.05,value:1},{time:.35,value:0}],Ms:[{time:.35,value:.001,exp:!0}]},this.os.baseReverb=.2,this.us={filters:[{type:"lowpass",frequency:2500,ps:.71},{type:"highpass",frequency:120,ps:.71}]}}}class Nt extends it{constructor(t={}){super(t),this.Ts="bs",this.display="Organ",this.Jt=25,this.Ct=2,this.outline=[[0,1],[0,0],[0,-1],[1,-1],[2,-1],[2,0],[1,0],[1,1]],this.K=new Lt,this.init()}}class jt extends Bt{constructor(t={}){super(t),this.ts=-12,this.Us=[0,2,4],this.Ls=[1],this.fs={amplitude:[{time:0,value:0},{time:.1,value:1},{time:.5,value:.7},{time:.95,value:1e-4,exp:!1}],Ms:[{time:0,value:0},{time:.25,value:3500},{time:1.75,value:1e-4,exp:!0}]},this.os.baseReverb=.5,this.os.baseVolume=.4,this.us={filters:[{type:"lowpass",frequency:1500,ps:.71},{type:"highpass",frequency:150,ps:1.2}]}}}class Xt extends it{constructor(t={}){super(t),this.Ts="cs",this.display="Plutonia",this.Jt=2500,this.Ct=25,this.outline=[[0,0],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[2,-1],[2,-2],[1,-2],[0,-2],[0,-1]],this.K=new jt,this.init()}}class Yt extends Bt{constructor(t={}){super(t),this.Ns=[1],this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.7,value:0}],Ms:[{time:0,value:0,exp:!1},{time:.15,value:5e3,exp:!1}]},this.os.baseReverb=.4,this.us={filters:[{type:"lowpass",frequency:1500,ps:1},{type:"highpass",frequency:120,ps:.71}]}}}class Ht extends it{constructor(t={}){super(t),this.Ts="bs",this.display="Saw",this.Jt=50,this.Ct=3,this.outline=[[0,0],[1,0],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-1,0]],this.K=new Yt,this.init()}}class It extends Bt{constructor(t={}){super(t),this.Us=[1,8,9,12,15],this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],Ms:[{time:.35,value:.001,exp:!0}]},this.os.baseReverb=.2,this.us={filters:[{type:"lowpass",frequency:2500,ps:.71},{type:"highpass",frequency:120,ps:.71}]}}}class Vt extends it{constructor(t={}){super(t),this.Ts="bs",this.display="Sine",this.Jt=75,this.Ct=4,this.outline=[[0,0],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0]],this.K=new It,this.init()}}class zt extends Bt{constructor(t={}){super(t),this.Us=[2,4,6],this.Ls=[1],this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.15,value:0}],Ms:[{time:.35,value:.001,exp:!0}]},this.os.baseReverb=.2,this.us={filters:[{type:"lowpass",frequency:1500,ps:.71},{type:"highpass",frequency:120,ps:.71}]}}}class Qt extends it{constructor(t={}){super(t),this.Ts="bs",this.display="Square",this.Jt=100,this.Ct=5,this.outline=[[0,0],[1,0],[2,0],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1]],this.K=new zt,this.init()}}class Dt extends nt{constructor(t={}){super(t),this.ts=-24,this.fs={amplitude:[{time:0,value:0},{time:.1,value:1},{time:.5,value:.7},{time:.95,value:1e-4,exp:!1}]},this.us={filters:[{type:"lowpass",frequency:2500,ps:1},{type:"highpass",frequency:90}],ws:[{curve:L(.5)}]},this.os.baseVolume=.2}play(t,s){const e=this.gs("waveform",s,{qs:"sine"});this.vs(t,e)}}class Kt extends it{constructor(t={}){super(t),this.Ts="cs",this.display="Thermal Bass",this.Jt=250,this.Ct=10,this.outline=[[0,0],[-1,0],[-1,1],[0,1],[1,1],[2,1],[2,0],[2,-1],[2,-2],[1,-2],[0,-2],[-1,-2],[-1,-1],[0,-1]],this.K=new Dt,this.init()}}class Jt extends nt{constructor(t={}){super(t),this.ts=0,this.fs={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this.os.baseReverb=.05}play(t,s){const e=this.gs("waveform",s,{qs:"sine"});e.gain.gain.value=.5,this.vs(t,e)}}class Gt extends it{constructor(t={}){super(t),this.Ts="dr",this.display="Tom",this.Jt=15,this.Ct=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new Jt,this.init()}}const Wt=[t=>new Ut(t),t=>new Gt(t),t=>new ct(t),t=>new ot(t),t=>new Nt(t),t=>new Ht(t),t=>new Vt(t),t=>new Qt(t),t=>new Kt(t),t=>new Rt(t),t=>new Xt(t),t=>new St(t)];class Zt extends at{constructor(t={}){super(t),this.width=1}$s(t,s,e=l.X,i=w.width(.06*this.width-.012),n=w.width(.006),h=(this.disabled?this.jt:this.color)){e.strokeStyle=h,e.fillStyle=h,e.lineWidth=n,e.beginPath(),e.strokeRect(t-i/2,s-i/2,i,i),e.stroke()}}class _t extends Zt{constructor(t={}){super(t),this.display="Square",this.interval=.21428571428571427,this.Jt=500,this.color=h,this.Ss=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],this.duration=this.interval*this.Ss.length,this.init()}}class ts extends at{constructor(t={}){super(t),this.width=1}$s(t,s,e=l.X,i=w.width(.06*this.width-.012),n=w.width(.006),h=(this.disabled?this.jt:this.color)){e.strokeStyle=h,e.fillStyle=h,e.lineWidth=n,e.beginPath(),((t,s,e,i)=>{const n=i*Math.sqrt(3)/2;t.beginPath(),t.moveTo(s,e-n/2),t.lineTo(s+i/2,e+n/2),t.lineTo(s-i/2,e+n/2),t.closePath()})(e,t,s,i),e.stroke()}}class ss extends ts{constructor(t={}){super(t),this.display="Triangle",this.interval=.5714285714285714,this.Jt=50,this.color=h,this.Ss=[[0,1],[1,-1],[-1,-1]],this.duration=this.interval*this.Ss.length,this.init()}}const es=[t=>new lt(t),t=>new ss(t),t=>new _t(t)],is=(t,s)=>{A(t);const e=t.getContext("2d"),i=s.id.substr(0,2);if("oscillator"===s.type&&(s.$s(t.width/2,t.height/2,e,t.width*("co"===i?.075:.3),t.width/15),e.stroke()),"instrument"===s.type){const i=s;t.width=u.v.width,t.height=u.v.height;const n=8/Math.max(i.zt,i.Qt),{x:h,y:o}=mt;e.save(),e.setTransform(n,0,0,n*o/h,-(n-1)*t.width/2,-(n*o/h-1)*t.height/2),s.Pt(e,!1),e.restore(),e.scale(1,o/h)}},ns=(t,s)=>{const{type:e,Jt:i}=t,n=document.getElementById("templates").firstElementChild.cloneNode(!0),h=n.querySelector("button");h.classList.add("entity-button"),h.setAttribute("cost",i.toString());const o=n.querySelector("canvas");n.querySelector("p").innerHTML=t.display;const r=n.querySelectorAll("span");r[0].innerHTML="-"+t.Jt,"instrument"===e&&(r[1].innerHTML="&nbsp;/&nbsp;",r[2].innerHTML="+"+t.Ct);const c="instrument"===e?t.Ts:"os";document.getElementById(c).append(n),h.onclick=e=>{e.stopPropagation(),wt(),((t,s)=>{let e,i;G.xt&&dt("escape"),t.position.set(pt.Ps,pt.Rs),Z.Ut=t,u.p.style.cursor="pointer";const n=()=>{const s=pt.Ps,e=pt.Rs;if(void 0!==s&&void 0!==e){t.position.set(s,e);const i=!t.Gt();t.disabled=i,u.p.style.cursor=i?"not-allowed":"pointer"}},h=o=>{const r=Math.abs(o.x-e),c=Math.abs(o.y-i);if(r>5||c>5)return document.addEventListener("click",h,{once:!0}),void(u.p.style.cursor="pointer");if(t.disabled)document.addEventListener("click",h,{once:!0});else{dt("hide"),G.yt+=1;const{x:e,y:i}=t.position;s({x:e,y:i}),W.gt-=Z.Ut.Jt,Z.Ut=null,document.removeEventListener("mousemove",n),u.p.style.cursor="grab",2===G.yt&&dt("drag")}};document.addEventListener("keydown",(s=>{"Escape"===s.key&&(dt("hide"),G.xt=!1,t.disabled=!0,Z.Ut=null,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",h),u.p.style.cursor="grab")})),document.addEventListener("mousedown",(t=>{u.p.style.cursor="grab",e=t.x,i=t.y})),document.addEventListener("mousemove",n),document.addEventListener("mouseup",h,{once:!0})})(t,s)};const a=()=>{A(o),is(o,t)},l=new ResizeObserver(a);window.addEventListener("resize",a),is(o,t),l.observe(h)},hs=()=>{Y.context.resume();let t=0;const s=()=>{z(),Z.Pt(),(G.Mt||G.bt)&&W.gt!==t&&(ft(),vt()),t=W.gt,window.requestAnimationFrame(s)};window.requestAnimationFrame(s)};(async()=>{await Y.init(),$t(),[...es,...Wt].forEach((t=>{const s=t({Lt:!0});ns(s,t)})),ft(),Z.St(),new ot({x:1,y:0}),new ct({x:-1,y:0}),new lt({x:0,y:0}),u.start.disabled=!1})()})();</script></body></html>