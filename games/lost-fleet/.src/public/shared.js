"use strict";function Arena({users:e,id_counter:t}){this.users={},this.units={},this.id_counter=t,this.asteroid_field=new AsteroidField(93454853);for(var i of e)new User(this,i)}function AsteroidField(e){let t=new RNG(e);this.block_size=300,this.x_coefficient=t.random_int(),this.y_coefficient=t.random_int(),this.i_coefficient=t.random_int(),this.constant=t.random_int(),this.asteroids={}}function Asteroid(e,{block:t,index:i}){this.field=e,this.block=t,this.index=i;let n=new RNG(e.x_coefficient*t[0]+e.y_coefficient*t[1]+e.i_coefficient*i);this.pos=[this.block[0]*this.field.block_size+mix(n.random(),0,e.block_size),this.block[1]*this.field.block_size+mix(n.random(),0,e.block_size)],this.stats=mix(n.random(),1400,2550),this.shape_id=Math.round(n.random()*Asteroid.asteroid_shapes.length-.5),this.rotation=2*n.random()*Math.PI}function in_rounded_rectangle(e,t,i,n){n||(n=i);let s=min(i[1],n[1]),a=max(i[1],n[1]),r=min(i[0],n[0]),o=max(i[0],n[0]),c=e[0],l=e[1];return r<c&&c<o?s-t<l&&l<a+t:s<l&&l<a?r-t<c&&c<o+t:Math.min(leng(sub(e,[r,s])),leng(sub(e,[o,s])),leng(sub(e,[r,a])),leng(sub(e,[o,a])))<t}function RNG(e){e<0&&(e*=-1),0===e&&(e=42),this.seed=e%2147483647}function make_picker(e){let t={};t.onchange=(()=>{});let i=ce("div"),n=i.ac(ce("table"));e=e.map(({name:e,stats:i})=>{let s=n.ac(ce("tr")).ac(ce("th").sr({colSpan:"2",innerText:e+" ▼"})),a=!0;return i=i.map(e=>{let i=n.ac(ce("tr")),s=(i.ac(ce("td").sr({innerText:e})),i.ac(ce("input").sr({type:"range",min:"0",max:"1",step:"any"})));return s.addEventListener("input",()=>t.onchange(t.get_value())),{name:e,get_value:()=>parseFloat(s.value),set_value:e=>{s.value=e},element:i}}),s.onclick=(()=>{a=!a,s.sr({innerText:e+(a?" ▼":" ▲")}),i.forEach(({element:e})=>{e.style.display=a?"table-row":"none"})}),{name:e,stats:i}});let s=[],a=i.ac(ce("table")),r=!0,o=()=>{for(;a.hasChildNodes();)a.removeChild(a.lastChild);let e=a.ac(ce("tr")),i=e.ac(ce("th").sr({colSpan:"2",innerText:"presets "+(r?"▼":"▲")}));if(i.cc("selectable"),i.onclick=(()=>{r=!r,o()}),!r)return;s.forEach(e=>{let i=ce("td").sr({style:{width:"100%"},innerText:e.name});i.cc("selectable"),i.onclick=(()=>{t.set_value(e.stats)});let n=ce("td").sr({innerText:"del"});n.cc("selectable"),n.onclick=(()=>{s.splice(s.indexOf(e),1),o()});let r=ce("tr");r.ac(i),r.ac(n),a.ac(r)});let n=ce("input").sr({type:"text",style:{width:"90%"}});n.addEventListener("keydown",e=>e.stopPropagation()),n.addEventListener("keyup",e=>e.stopPropagation()),n.addEventListener("keypress",e=>{e.stopPropagation(),"Enter"===e.key&&t.add_preset({name:n.value,stats:t.get_value()})});let c=ce("td");c.ac(n);let l=ce("td").sr({innerText:"save"});l.cc("selectable"),l.onclick=(()=>t.add_preset({name:n.value,stats:t.get_value()})),(e=ce("tr")).ac(c),e.ac(l),a.ac(e)};return t.add_preset=(e=>{s.push(e),o()}),t.get_value=(()=>{let t={};return e.forEach(e=>{let i={};e.stats.forEach(e=>{i[e.name]=e.get_value()}),t[e.name]=i}),t}),t.set_value=(i=>{e.forEach(e=>{e.stats.forEach(t=>{t.set_value(i[e.name][t.name])})}),t.onchange(t.get_value())}),t.element=i,t}function create_selected_stats(e,t){let i=[],n=()=>{let n=i.pop();if(n)return n;let s=ce("div");s.className="stat-cont";let a=!1;n={visible:t=>{t!=a&&(t?e.ac(s):e.removeChild(s),a=t)}};let r=ce("div");r.sr({className:"stat"}),n.health=((e,t)=>{r.style.background=t.health_color(),r.style.width=t.health/t.stats.cost*100+"%"}),s.ac(r);let o=ce("div");return o.sr({className:"stat"}),o.style.background="#0087CF",n.hold=((e,t)=>{o.style.width=t.hold/t.stats.misc.capacity*100+"%"}),s.ac(o),t.forEach(e=>{n[e.name]={},e.stats.forEach(t=>{let i=ce("div");i.sr({className:"stat"}),n[e.name][t]=(e=>{i.style.width=100*e+"%"}),s.ac(i)})}),n};return{update:e=>{if(i.forEach(e=>e.visible(!1)),!e)return;let s=[];e.values().sort((e,t)=>e.health-t.health).forEach(e=>{let i=n();t.forEach(t=>{t.stats.forEach(n=>{i[t.name][n](e.stats.norm_stats[t.name][n])})}),i.health(0,e),i.hold(0,e),i.visible(!0),s.push(i)}),i=i.concat(s)}}}function Unit(e,{id:t,owner_id:i,pos:n,stats:s,health:a,activated:r}){this.arena=e,this.id=void 0!==t?t:e.id_counter++,this.owner=e.users[i],this.owner.units[this.id]=this,e.units[this.id]=this,this.pos=n,this.dest=n,this.stats=new Stats(s),this.vel=[0,0],this.hold=0,this.health=a||0,this.activated=r||!1,this.command=null,this.shape_id=this.calc_ship_id(),this.rotation=scalar_angle(this.vel),this.events={hold_full:()=>{},out_of_range:()=>{},no_target:()=>{},done:()=>{}}}function User(e,{id:t,username:i,units:n,resources:s,color:a}){this.id=void 0!==t?t:e.id_counter++,e.users[this.id]=this,this.units={},this.username=i,this.resources=s||[2550,2550,2550];for(let t of n||[])new Unit(e,Object.assign({owner_id:this.id},t));this.color=a}Arena.prototype.serialize=function(){return{users:Object.values(this.users).map(e=>e.serialize()),id_counter:this.id_counter}},Arena.prototype.tick=function(){for(var e of Object.values(this.units))e.tick()},Arena.prototype.receive=function([e,...t]){console.log("arena receive",e,...t),Arena.handlers[e].call(this,...t)},Arena.handlers={},Arena.handlers.command_unit=function(e,...t){this.units[e]&&this.units[e].receive(...t)},Arena.handlers.make_baby=function(e,t,i){let n=new Unit(this,{owner_id:e,pos:t,stats:i});console.log(n,n.stats)},Arena.handlers.remove_user=function(e){console.log(this);for(let t of Object.values(this.users[e].units))t.destroy(!0);delete this.users[e]},AsteroidField.prototype.block=function(e,t){if(!this.asteroids[[e,t]+""]){this.asteroids[[e,t]+""]={};let i=0;for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){let a=((e,t)=>new RNG(this.x_coefficient*e+this.y_coefficient*t+this.constant))(e+n,t+s);a.random()>.93&&(i+=a.random()>.7?1:0)}for(;i-- >0;)this.asteroids[[e,t]+""][i]=new Asteroid(this,{block:[e,t],index:i})}return this.asteroids[[e,t]+""]},AsteroidField.prototype.asteroid=function(e,t,i){return this.block(e,t)[i]},AsteroidField.prototype.in_range=function(e,t,i,n){let s={};for(let a=Math.floor(t/this.block_size);a<Math.ceil(n/this.block_size);a++)for(let t=Math.floor(e/this.block_size);t<Math.ceil(i/this.block_size);t++)this.block(a,t).values().forEach(e=>s[[a,t]+":"+e.index]=e);return s},Asteroid.asteroid_shapes=[[[-1,-.75],[0,-.75],[0,1.25],[-1,.25]],[[.25,-1.5],[1.25,-.5],[.25,1.5],[-.75,1.5],[-.75,.5],[-1.75,-.5]],[[0,-1.5],[1,-.5],[1,.5],[-1,1.5],[-1,-.5]],[[-.5,-1.5],[.5,-1.5],[.5,-.5],[1.5,.5],[-.5,1.5],[-1.5,-.5]],[[0,-2.75],[2,-.75],[1,.25],[1,1.25],[0,2.25],[-1,2.25],[-2,.25],[-1,-.75],[-1,-1.75]],[[-.75,-1.75],[1.25,-1.75],[2.25,.25],[1.25,2.25],[.25,2.25],[-.75,1.25],[-2.75,.25]],[[.25,-2.25],[1.25,-.25],[1.25,.75],[.25,1.75],[-1.75,.75],[-.75,-1.25]],[[-.75,-2.25],[.25,-1.25],[1.25,-1.25],[2.25,.75],[1.25,1.75],[-.75,1.75],[-1.75,.75],[-1.75,-1.25]],[[-1,-1.5],[0,-1.5],[0,-.5],[1,-1.5],[2,-.5],[1,1.5],[0,1.5],[-1,.5],[-2,.5],[-2,-.5]],[[-1,-2],[0,-2],[1,-1],[2,1],[1,3],[1,3],[0,2],[0,1],[-1,1],[-2,2],[-2,0],[-1,-1]],[[-.25,-1.5],[.75,-.5],[.75,1.5],[-1.25,.5]],[[0,-1.5],[1,-.5],[0,1.5],[-1,.5],[-1,-.5]],[[-1.5,-1.75],[.5,-.75],[1.5,.25],[1.5,1.25],[.5,2.25],[-.5,.25],[-1.5,.25]],[[-.25,-1.75],[.75,-1.75],[.75,-.75],[1.75,-.75],[.75,.25],[.75,1.25],[-.25,1.25],[-1.25,.25],[-1.25,-.75],[-.25,-.75]]],Asteroid.prototype.get_index=function(){return[...this.block,this.index]},Asteroid.prototype.size=function(){return this.stats/100},Asteroid.prototype.shape=function(){return Asteroid.asteroid_shapes[this.shape_id].map(e=>add(this.pos,rotate(scale(e,this.size()),this.rotation)))},Asteroid.prototype.point_in=function(e){let t=0,i=this.shape();for(let n=0;n<i.length;n++)i[n][1]<=e[1]?i[(n+1)%i.length][1]>e[1]&&is_left(i[n],i[(n+1)%i.length],e)>0&&t++:i[(n+1)%i.length][1]<=e[1]&&is_left(i[n],i[(n+1)%i.length],e)<0&&t--;return 0!==t},Asteroid.prototype.destroy=function(){delete this.field.block(...this.block)[this.index]};let bind_game_stuff=e=>{let t,i,n,s,a,r={},o={},c=[0,0],l=()=>n.users[t],d={},h={mode:"NONE"},u=el("cost"),m=el("cap"),f=el("c"),p=f.getContext("2d"),g=(e,...t)=>e.addEventListener(...t),_=window,y=(e,t)=>{let i=t||c,n=[p.canvas.width,p.canvas.height],s=scale(n,.5),a=sub(e,i);return add(s,a)},v=(e,t)=>{let i=t||c,n=[p.canvas.width,p.canvas.height],s=scale(n,.5);return add(sub(e,s),i)};{let e=Unit.prototype.destroy;Unit.prototype.destroy=function(i){if(e.call(this),this.owner.id===t){for(let e of o.values())delete e[this.id];delete r[this.id]}i||1==n.users.values().length||(0===l().units.values().length?el("q").style.backgroundColor="#781A05":0===n.units.values().filter(e=>e.owner.id!=t).length&&(el("q").style.backgroundColor="#078219"))}}CanvasRenderingContext2D.prototype.circle=function(e,t){this.arc(...e,t,0,2*Math.PI)};let k=(e,...t)=>t.map(([t,i])=>[e*t,e*i]),w=[e=>[{body:{fillStyle:e.owner.color,strokeStyle:e.health_color(),lineWidth:3,paths:[k(e.radius(),[0,-1],[1,1],[-1,1])]},flames:{fillStyle:"orange",paths:[((e,t)=>[[0,e+t],[e/2,e],[-e/2,e]])(e.radius(),7*leng(e.current_acceleration||[0,0]))]},selected:{paths:r[e.id]?[k(1.8*e.radius(),[0,-1],[1,.8],[-1,.8])]:[],strokeStyle:"orange",lineWidth:1}}],e=>[{body:{fillStyle:e.owner.color,strokeStyle:e.health_color(),lineWidth:3,paths:[k(e.radius(),[0,-1],[1,1],[-1,1])]},flames:{fillStyle:"#FF8400",strokeStyle:"#FFC400",lineWidth:3,paths:((e,t)=>[[[3,e],[3+e/2,e+t],[e-3,e]],[[-3,e],[-e/2-3,e+t],[3-e,e]]])(e.radius(),7*leng(e.current_acceleration||[0,0]))},selected:{paths:r[e.id]?[k(1.8*e.radius(),[0,-1],[1,.8],[-1,.8])]:[],strokeStyle:"orange",lineWidth:1}}]];Unit.prototype.draw_lower=function(){let e=w[this.shape_id](this)[0];["flames","body","selected"].forEach(t=>{let i=e[t];i&&(p.beginPath(),i.paths.forEach(e=>{p.moveTo(...e.shift()),e.forEach(e=>p.lineTo(...e)),p.closePath()}),p.fillStyle=this.activated?i.fillStyle:"rgba(128, 128, 128, 0.5)",p.strokeStyle=this.activated?i.strokeStyle:"rgba(128, 128, 128, 0.5)",p.lineWidth=i.lineWidth,i.fillStyle&&p.fill(),i.strokeStyle&&p.stroke())})},Unit.prototype.draw_upper=function(){p.beginPath(),p.circle([0,0],5),p.closePath(),p.fillStyle="grey",p.fill()},Unit.prototype.draw=function(){this.radius();let e=y(this.pos);p.save(),p.translate(...e),p.rotate(this.rotation),this.draw_lower();if(this.command){if(p.restore(),this.laser){let t;switch(this.command.type){case"attack":t=this.arena.units[this.command.target_id],p.lineWidth=2,p.strokeStyle="#CF4800";break;case"mine":t=this.arena.asteroid_field.asteroid(...this.command.target_id),p.lineWidth=4,p.strokeStyle="#0087CF";break;case"transfer":case"construct":t=this.arena.units[this.command.target_id],p.lineWidth=3,p.strokeStyle="#20CF00"}t&&(p.beginPath(),p.lineWidth=2,p.moveTo(...e),p.lineTo(...y(t.pos)),p.stroke())}p.save(),p.translate(...e),p.rotate(this.rotation)}this.activated&&this.draw_upper(),p.restore()},Asteroid.prototype.draw=function(){p.beginPath(),p.save(),p.moveTo(...y(this.shape()[0])),this.shape().forEach(e=>p.lineTo(...y(e))),p.closePath();let e=Math.floor(this.stats/20),t=255-e;p.fillStyle="rgb("+[e,e,e]+")",p.strokeStyle="rgb("+[t,t,t]+")",p.lineWidth=3,p.fill(),p.stroke(),p.restore()};let b=(e,t,i,n)=>{let s=el(e),a=s.getContext("2d"),r=new RNG(15784+t+i+n),o=r.random_int(),l=r.random_int(),d=r.random_int();let h=null,u=()=>{s.width=window.innerWidth,s.height=window.innerHeight,h=null};g(_,"resize",u),u();let m=(e,t)=>i=>e(i/t)*t,f=m(Math.floor,200),p=m(Math.ceil,200);return()=>{if(h+""!=c+""){a.clearRect(0,0,s.width,s.height);let e=scale(c,t);for(let t=f(e[0]-s.width/2);t<p(e[0]+s.width/2);t+=200)for(let r=f(e[1]-s.height/2);r<p(e[1]+s.height/2);r+=200){let s=new RNG(o*t/200+l*r/200+d),c=Math.round(mix(s.random(),i,n));for(;c--;){let i=1+.5*s.random(),n=y([t+200*s.random(),r+200*s.random()],e);a.beginPath(),a.circle(n,i),a.fillStyle="white",a.fill()}}}h=c}},E=b("near_stars",.15,2,5),M=b("mid_stars",.1,3,7),x=b("far_stars",.05,2,5),A=()=>{f.width=window.innerWidth,f.height=window.innerHeight};g(_,"resize",A),A();let S=null,U=e=>{if(S){let t=e-S,i=[0,0];[["a",[-1,0]],["d",[1,0]],["w",[0,-1]],["s",[0,1]]].forEach(([e,t])=>{d[e]&&(i=add(i,t))}),c=add(c,scale(norm(i),t))}if(S=e,p.clearRect(0,0,p.canvas.width,p.canvas.height),E(),M(),x(),p.strokeStyle="white","SELECT"===h.mode&&p.strokeRect(...h.origin,...sub(i,h.origin)),n){n.units.values().forEach(e=>e.draw()),n.asteroid_field.in_range(c[1]-f.height,c[0]-f.width,c[1]+f.height,c[0]+f.width).values().forEach(e=>e.draw()),n.users.values().forEach(e=>{let t=sub(e.centroid(),c);(Math.abs(t[0])>f.width/2||Math.abs(t[1])>f.height/2)&&(p.beginPath(),p.moveTo(...add(scale(t,f.height/2/Math.abs(t[1])),[f.width/2-25,f.height/2])),p.lineTo(...add(scale(t,f.height/2/Math.abs(t[1])),[f.width/2+25,f.height/2])),p.strokeStyle=e.color,p.lineWidth=10,p.stroke(),p.beginPath(),p.moveTo(...add(scale(t,f.width/2/Math.abs(t[0])),[f.width/2,f.height/2-25])),p.lineTo(...add(scale(t,f.width/2/Math.abs(t[0])),[f.width/2,f.height/2+25])),p.strokeStyle=e.color,p.lineWidth=10,p.stroke(),p.beginPath())}),"CREATE"===h.mode&&Object.setPrototypeOf({owner:{color:"rgba(255, 255, 255, 0.5)"},rotation:Math.PI/2,pos:v(i),radius:()=>15,shape_id:1},Unit.prototype).draw(),a.update(r);let e=(r.values()||[]).map(e=>e.hold).reduce(nums.add,0);m.innerText=Math.floor(e)}window.requestAnimationFrame(U)},N=(...t)=>e.emit("command",["command_unit",...t]),T=(...t)=>e.emit("command",["make_baby",...t]);e.on("tick",function(e){for(var t of e)n.receive(t);n&&n.tick()});let C=el("create");C.onclick=(()=>{h={mode:"CREATE"}}),g(_,"contextmenu",e=>e.preventDefault()),g(f,"mousedown",e=>i=[e.x,e.y]),g(f,"mousemove",e=>i=[e.x,e.y]),g(f,"mouseup",e=>i=[e.x,e.y]),g(f,"mousedown",e=>{0===e.button&&d.p||1===e.button?h={mode:"PAN",origin:i,original_view_center:c}:0===e.button&&"NONE"===h.mode&&(h={mode:"SELECT",origin:i,additive:d.shift})}),g(f,"mousemove",e=>{"PAN"===h.mode&&(c=add(h.original_view_center,sub(h.origin,i)))}),g(f,"mouseup",e=>{let a=v(i);if("SELECT"===h.mode)h.additive||(r={}),(l()?l().units.values():[]).filter(e=>in_rounded_rectangle(e.pos,e.radius(),v(i),v(h.origin))).forEach(e=>r[e.id]=e),h={mode:"NONE"};else if("PAN"===h.mode)h={mode:"NONE"};else if("CREATE"===h.mode)T(v(i),s.get_value());else if(2===e.button){let e,s=[0,0],o="unit",l=n.units.values().find(e=>in_rounded_rectangle(e.pos,e.radius(),a));l?e=l.id:(o="asteroid",(l=n.asteroid_field.in_range(c[1]-f.height/2,c[0]-f.width/2,c[1]+f.height/2,c[0]+f.width/2).values().find(e=>e.point_in(a)))&&(e=l.get_index()));let d,h,u,m,p;d=((e,t,i)=>{e&&t&&(N(e.id,"set_command",{type:"move",dest:add(t.pos,scale(norm(sub(e.pos,t.pos)),.95*i))}),e.events.done=(()=>{N(e.id,"set_command",null)}))}),h=((e,t)=>{N(e.id,"set_command",{type:"construct",target_id:t}),e.events.out_of_range=(()=>{d(e,n.units[t],e.stats.construct.range),e.events.done=(()=>h(e,t))}),e.events.done=(()=>m(e,t))}),m=((e,t)=>{N(e.id,"set_command",{type:"transfer",target_id:t}),e.events.out_of_range=(()=>{d(e,n.units[t],e.stats.misc["transfer range"]),e.events.done=(()=>m(e,t))}),e.events.done=(()=>N(e.id,"set_command",null))}),u=((e,t)=>{N(e.id,"set_command",{type:"attack",target_id:t}),e.events.out_of_range=(()=>{d(e,n.units[t],e.stats.attack.range),e.events.done=(()=>u(e,t))}),e.events.done=(()=>N(e.id,"set_command",null))}),p=((e,t)=>{N(e.id,"set_command",{type:"mine",target_id:t}),e.events.out_of_range=(()=>{d(e,n.asteroid_field.asteroid(...t),e.stats.mine.range),e.events.done=(()=>p(e,t))}),e.events.done=(()=>N(e.id,"set_command",null))}),r.values().forEach(n=>{l?"unit"==o&&l.owner.id==t?h(n,e):"unit"==o?u(n,e):"asteroid"==o&&p(n,e):(d(n,{pos:add(v(i),s)},0),s=add(s,[36,0]))})}});let P={e:()=>r=Object.assign({},n.users[t].units),q:()=>r={},c:C.onclick," ":()=>{r.values()[0]&&(c=r.values()[0].pos)},Escape:e=>{e.preventDefault(),h={mode:"NONE"}}},z=!1,O=()=>{z||(z=!0,g(_,"keydown",e=>{d[e.key]=e;let t="";e.ctrlKey&&(t+="C-",d.ctrl=e),e.altKey&&(t+="M-",d.alt=e),e.shiftKey&&(t+="S-",d.shift=e),/^\d$/.test(e.key)?e.ctrlKey?o[e.key]=Object.assign({},r):r=Object.assign({},o[e.key]||{}):(t+=e.key,P[t]&&P[t](e))}),g(_,"keyup",e=>{delete d[e.key],e.shiftKey||delete d.shift,e.ctrlKey||delete d.ctrl,e.altKey||delete d.alt}))};e.on("create_arena",(e,i)=>{O(),el("room").style.display="none",el("game").style.display="block";let r=[{name:"attack",stats:["range","power","efficiency"]},{name:"mine",stats:["range","power","efficiency"]},{name:"construct",stats:["range","power","efficiency"]},{name:"misc",stats:["acceleration","capacity","defence","transfer range"]}];s=make_picker(r),el("pcks").appendChild(s.element),a=create_selected_stats(el("selected"),r),s.onchange=(e=>{console.log(e),u.innerText=new Stats(e).cost.num_pretty()}),s.set_value({attack:{range:.5,power:.5,efficiency:.5},mine:{range:.5,power:.5,efficiency:.5},construct:{range:.5,power:.5,efficiency:.5},misc:{acceleration:.5,capacity:.5,defence:.5,"transfer range":.5}}),s.add_preset({name:"fighter",stats:{attack:{range:.95,power:.95,efficiency:.2},mine:{range:0,power:0,efficiency:0},construct:{range:0,power:0,efficiency:0},misc:{acceleration:.8,capacity:0,defence:.7,"transfer range":.5}}}),s.add_preset({name:"miner",stats:{attack:{range:0,power:0,efficiency:0},mine:{range:.95,power:.95,efficiency:.95},construct:{range:0,power:0,efficiency:0},misc:{acceleration:.2,capacity:.4,defence:0,"transfer range":.5}}}),s.add_preset({name:"builder",stats:{attack:{range:0,power:0,efficiency:0},mine:{range:0,power:0,efficiency:0},construct:{range:.95,power:.95,efficiency:.95},misc:{acceleration:.2,capacity:.4,defence:0,"transfer range":.5}}}),s.add_preset({name:"tanker",stats:{attack:{range:0,power:0,efficiency:0},mine:{range:0,power:0,efficiency:0},construct:{range:0,power:0,efficiency:0},misc:{acceleration:.2,capacity:.95,defence:0,"transfer range":.5}}}),console.log(e),n=new Arena(e),t=i,c=l().centroid(),console.log("connected",n,t),window.requestAnimationFrame(U)}),e.on("error",()=>{console.log("error")})};const EPSILON=1;let is_server="undefined"!=typeof module,min=Math.min,max=Math.max,add=([e,t],[i,n])=>[e+i,t+n],inv=([e,t])=>[-e,-t],sub=(e,t)=>add(e,inv(t)),scale=([e,t],i)=>[i*e,i*t],leng=([e,t])=>Math.sqrt(e*e+t*t),norm=e=>{let t=leng(e);return 0!==t?scale(e,1/t):[0,0]},clamp=(e,t,i)=>void 0===i?Math.max(t||0,e):Math.min(i,Math.max(t||0,e)),mix=(e,t,i)=>t+(i-t)*e,normal=(e,t)=>Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t),towards=(e,t,i)=>e<t?min(e+i,t):max(t,e-i),scalar_angle=([e,t])=>Math.atan2(t,e)+.5*Math.PI,nums={multiply:(e,t)=>e*t,divide:(e,t)=>e/t,add:(e,t)=>e+t,subtract:(e,t)=>e-t},is_left=(e,t,i)=>(t[0]-e[0])*(i[1]-e[1])-(i[0]-e[0])*(t[1]-e[1]),rotate=(e,t)=>[e[0]*Math.cos(t)-e[1]*Math.sin(t),e[1]*Math.cos(t)+e[0]*Math.sin(t)],zip=(...e)=>e[0].map((t,i)=>e.map(e=>e[i])),dot=(e,t)=>zip(e,t).map(([e,t])=>e*t),to_html=e=>([[/_(.*?)_/g,"i"],[/\*(.*?)\*/g,"b"],[/^[+\-*] ?(.*?)$/gm,"li"],[/^\d+\. ?(.*?)$/gm,"oli"],[/^# (.*?)$/gm,"h1"],[/^## (.*?)$/gm,"h2"],[/^### (.*?)$/gm,"h3"],["\n\n<li>","\n\n<ul><li>",1],["</li>\n\n","</li></ul>\n\n",1],["\n\n<oli>","<ol><li>",1],["</oli>\n\n","</li></ol>\n\n",1],["<oli>","<li>",1],["</oli>","</li>",1]].forEach(([t,i,n])=>{e=e.replace(t,n?i:(e,t)=>"<"+i+">"+t+"</"+i+">")}),"<p>"+e.split("\n\n").join("</p><p>")+"</p>");Function.prototype.curry=function(...e){return(...t)=>this(...e.concat(t))},Array.prototype.num_pretty=function(){return this.map(e=>Math.floor(e)).join(", ")},Number.prototype.num_pretty=function(){return Math.floor(this)};let acceleration=(e,t,i,n)=>{let s=sub(t,e),a=scale(norm(s),n*(Math.sqrt(1+8*leng(s)/n)-1)/2);leng(s)<1&&leng(i)<n&&(a=[0,0]);let r=sub(a,i);return scale(norm(r),min(n,leng(r)))};RNG.prototype.random=function(){return(this.random_int()-1)/2147483647},RNG.prototype.random_int=function(){return this.seed=(this.seed*this.seed*59749+16087*this.seed)%2147483647},Object.prototype.values=function(){return Object.values(this)},Object.prototype.entries=function(){return Object.entries(this)},Array.prototype.sum=function(){return this.reduce(nums.add)},Array.prototype.zip=function(...e){return zip(this,...e)},Array.prototype.dot=function(...e){return dot(this,...e)};let el,ce;is_server||(el=(e=>document.getElementById(e)),ce=(e=>document.createElement(e)),window.addEventListener("load",function(){let e=el("instructions");e.innerHTML=to_html(e.innerHTML);let t=io({upgrade:!1,transports:["websocket"]}),i=0,n=(e,t)=>el(e).style.display=t?"block":"none";n("room",!1),t.on("new_users",e=>{e.forEach(([e,t])=>{n("room",++i>0),n("join",i<1),console.log("User joined:",t);let s=document.createElement("li");s.innerText=t,s.id="user-"+e,el("players").appendChild(s)})}),t.on("user_left",e=>{let t=el("user-"+e);t&&(n("room",--i>0),n("join",i<1),t.remove())}),bind_game_stuff(t);let s=el("username"),a=el("game_name");s.value=NAMES.sample(),a.value=Math.floor(1e6*Math.random()).toString(16).toUpperCase(),el("join_game").onclick=(()=>{t.emit("create_game",a.value,s.value),el("room_name").innerText="In room "+a.value+" as "+s.value+". Waiting for other players.",el("room").style.display="block",el("join").style.display="none"}),el("start").onclick=(()=>{i<=0||t.emit("start_game")})},!1));const NAMES=["Assyrians","Babylonians","Choson","Egyptians","Greeks","Hittites","Minoans","Persians","Phoenicians","Shang","Sumerians","Yamato","Carthaginians","Macedonians","Palmyrans","Romans","Terrans","Protoss","Zerg","United Earth Federation","Cybran Nation","Aeon Illuminate","Allies","Axis","Orcs","Hobbits","Empire","Rebels","Amazons","Dwarves","Elves","Ghouls","Ratmen","Skeletons","Sorcerers","Tritons","Giants","Halflings","Humans","Trolls","Wizards"];if(Array.prototype.sample=function(){return this.splice(Math.random()*this.length,1)[0]},!is_server){ce=(e=>document.createElement(e));let e=(t,i)=>(i.entries().forEach(([i,n])=>"object"==typeof n?e(t[i],n):t[i]=n),t);Node.prototype.ac=Node.prototype.appendChild,Node.prototype.sr=function(t){return e(this,t)};let t=(e,t)=>{e.classList.add(t)};Node.prototype.cc=function(e){t(this,e)}}is_server&&function(){let e=()=>"hsl("+360*(Math.random()+.618033988749895)%360+",50%,50%)",t={},i={},n=t=>{console.log("starting game...");let i={attack:{range:.7,power:.7,efficiency:.7},mine:{range:.7,power:.7,efficiency:.7},construct:{range:.7,power:.7,efficiency:.7},misc:{acceleration:.7,capacity:.7,defence:.7,"transfer range":.7}};console.log(i);let n=new Arena({users:t.map((t,n)=>{let s=[5e3*normal(Math.random(),Math.random()),5e3*normal(Math.random(),Math.random())];return t.id=n,{id:t.id,color:e(),username:t.username,units:[{pos:s,vel:[0,0],stats:i,health:new Stats(i).cost,activated:!0}]}}),id_counter:0}),s=[];t.forEach(e=>{let t=(t,...i)=>{void 0!==n.users[e.id].units[t]&&s.push(["command_unit",t,...i])},i=(t,i)=>{Object.setPrototypeOf(i,Object.prototype),s.push(["make_baby",e.id,t,i])};e.command_handler=((e,...n)=>{console.log("received command",e,...n),"command_unit"===e&&t(...n),"make_baby"===e&&i(...n)}),e.socket.emit("create_arena",n.serialize(),e.id)}),setInterval(()=>{let e=s;s=[];for(let t of e)console.log("executing command",t),n.receive(t);n.tick();for(let i of t)i.socket.emit("tick",e)},100)};module.exports=function(e){let s={socket:e,command_handler:()=>{},current_game:null};t[s.socket.id]=s,e.on("create_game",(t,n)=>{t=t.toLowerCase(),i[t]||(i[t]={}),s.current_game&&i[s.current_game]&&(i[s.current_game].values().forEach(e=>e.socket.emit("user_left",e.socket.id)),delete i[s.current_game][s.socket.id]),s.username=n,s.current_game=t,i[t].values().forEach(e=>{e.socket.emit("new_users",[[s.socket.id,n]])}),i[t][s.socket.id]=s,e.emit("new_users",i[t].values().map(e=>[e.socket.id,e.username]))}),e.on("start_game",()=>{n(i[s.current_game].values()),delete i[s.current_game]}),e.on("disconnect",()=>{console.log("Disconnected: ",s.id)}),e.on("command",e=>{console.log("command"),s.command_handler(...e)})}}();let Stats;(Stats=function(e){this.norm_stats=e,this.attack={range:1e3*e.attack.range,power:15*e.attack.power,efficiency:e.attack.efficiency},this.mine={range:500*e.mine.range,power:20*e.mine.power,efficiency:e.mine.efficiency},this.construct={range:350*e.construct.range,power:20*e.construct.power,efficiency:e.construct.efficiency},this.misc={acceleration:4*e.misc.acceleration,capacity:1e3*e.misc.capacity,defence:1-e.misc.defence,"transfer range":2e3*e.misc["transfer range"]},this.cost=100*e.attack.range*e.attack.power+500*e.attack.efficiency+100*e.mine.range*e.mine.power+100*e.mine.efficiency+100*e.construct.range*e.construct.power+150*e.construct.efficiency+100*e.misc.acceleration+100*e.misc.capacity+100*e.misc.defence+100*e.misc["transfer range"]}).prototype.serialize=function(){return this.norm_stats},Unit.prototype.calc_ship_id=function(){return this.stats.misc.acceleration<3?1:0},Unit.prototype.destroy=function(){delete this.arena.units[this.id],delete this.arena.users[this.owner.id].units[this.id],this.destroyed=!0},Unit.prototype.serialize=function(){return{id:this.id,owner_id:this.owner.id,pos:this.pos,stats:this.stats.serialize(),health:this.health,activated:this.activated}},Unit.prototype.receive=function(e,...t){Unit.handlers[e].call(this,...t)},Unit.prototype.radius=function(){return mix(this.stats.misc.defence,8,15)},Unit.prototype.health_color=function(){return this.health?"hsl("+mix(this.health/this.stats.cost,0,140)+",80%,50%)":""},Unit.prototype.tick=function(){this.activated&&(this.command&&Unit.tick_handlers[this.command.type].call(this,this.command),leng(this.vel)>.01&&(this.rotation=scalar_angle(this.vel)),this.pos=add(this.pos,this.vel))},Unit.tick_handlers={};let attack=(e,t)=>{if(leng(sub(e.pos,t.pos))<e.stats.attack.range){let i=min(e.stats.attack.power*t.stats.misc.defence,t.health);return console.log(i,t.health),t.health-=i,e.hold+=i*e.stats.attack.efficiency,e.hold=min(e.hold,e.stats.misc.capacity),0===t.health?(t.destroy(),e.events.done()):e.hold===e.stats.misc.capacity&&e.events.hold_full(),i}return e.events.out_of_range(),null};Unit.tick_handlers.attack=function({target_id:e}){let t=this.arena.units[e];if(!t)return this.events.no_target();this.laser=attack(this,t)};let mine=(e,t)=>{if(leng(sub(e.pos,t.pos))<e.stats.mine.range){let i=min(e.stats.mine.power,t.stats,(e.stats.misc.capacity-e.hold)/e.stats.mine.efficiency);return t.stats-=i,e.hold+=i*e.stats.mine.efficiency,0===t.stats?(t.destroy(),e.events.done()):e.hold===e.stats.capacity&&e.events.hold_full(),i}return e.events.out_of_range(),null};Unit.tick_handlers.mine=function({target_id:e}){let t=this.arena.asteroid_field.asteroid(...e);if(!t)return this.events.no_target();this.laser=mine(this,t)};let construct=(e,t)=>{if(leng(sub(e.pos,t.pos))<e.stats.construct.range){let i=min(e.stats.construct.power,e.hold)*e.stats.construct.efficiency,n=t.stats.cost-t.health,s=min(i,n);return t.health+=s,e.hold-=s/e.stats.construct.efficiency,t.health===t.stats.cost&&(t.activated=!0),0==n&&e.events.done(),s}return 0==t.stats.cost-t.health?e.events.done():e.events.out_of_range(),null};Unit.tick_handlers.construct=function({target_id:e}){let t=this.arena.units[e];if(!t)return this.events.no_target();this.laser=construct(this,t)};let transfer=(e,t)=>{if(leng(sub(e.pos,t.pos))<e.stats.misc["transfer range"]){let i=min(e.stats.misc["transfer range"]/50,e.hold,t.stats.misc.capacity-t.hold);return e.hold-=i,t.hold+=i,0===e.hold&&e.events.done(),t.hold===t.stats.misc.capacity&&(e.events.done(),t.events.hold_full()),i}return e.events.out_of_range(),null};Unit.tick_handlers.transfer=function({target_id:e}){let t=this.arena.units[e];if(!t)return this.events.no_target();this.laser=transfer(this,t)},Unit.tick_handlers.move=function({dest:e}){this.current_acceleration=this.acceleration(e),this.vel=add(this.vel,this.current_acceleration),"0,0"==this.vel&&this.events.done()},Unit.handlers={},Unit.handlers.set_command=function(e){this.command=e},Unit.prototype.acceleration=function(e){return acceleration(this.pos,e,this.vel,this.stats.misc.acceleration)},User.prototype.serialize=function(){return{id:this.id,color:this.color,username:this.username,units:Object.values(this.units).map(e=>e.serialize())}},User.prototype.mine_resource=function(e,t){[0,1,2].forEach(i=>this.resources[i]+=e[i]-t<0?e[i]:t)},User.prototype.subtracted_resources=function(e){return this.resources.map((t,i)=>t-e[i])},User.prototype.centroid=function(){let e=[0,0];return this.units.values().forEach(t=>{e=add(e,t.pos)}),scale(e,1/this.units.values().length)};
