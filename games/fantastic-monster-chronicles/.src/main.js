var START=0,GAME=2,DEAD=3,WIN=4,BETWEEN=5,currentState=START,canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),scaledImageReady=!1,scaledMap,xTiles=13,yTiles=13,started=!1,map=new Image;map.src="mvh.png",map.onload=function(){scaledMap=resize(map,scale),scaledImageReady=!0,init(),started=!0,Music.init()};var startLayer=[],deadLayer=[],winLayer=[],betweenLevelsLayer=[],backgroundLayer=[],foregroundLayer=[],gameObjects=[],walls=[],eggs=[],doors=[],rocks=[],chest,knights=[],swords=[],hero,init=function(){loadStart(),loadDead(),loadWin(),loadBetweenLevels(),loadLevel();var e=new TiledBackground(ctx,scaledMap,11,tileSize);foregroundLayer.push(e)},reset=function(){backgroundLayer=[],foregroundLayer=[],gameObjects=[],walls=[],eggs=[],doors=[],rocks=[],chest=null,knights=[],swords=[],hero=null},update=function(e){currentState==GAME&&updateLevel(e)},updateLevel=function(e){if(0!=started){if(hero.dead)return currentState=DEAD,Music.stop(),reset(),void loadLevel();if(hero.completedLevel)return reset(),currentLevel++,currentLevel>=levels.length?void(currentState=WIN):(loadLevel(),currentState=BETWEEN,void Music.stop());gameObjects.forEach(function(t){t.update(e)}),knights.forEach(function(t){t.update(e)}),swords.forEach(function(t){t.update(e)}),0==eggs.length&&(chest.openChest(),knights.forEach(function(e){e.unlock()})),0==chest.hasKey&&(doors.forEach(function(e){e.openDoor()}),knights.forEach(function(e){e.seal()}));var t=[];swords.forEach(function(e){e.alive&&t.push(e)}),swords=t}},loadStart=function(){var e=new TiledBackground(ctx,scaledMap,darkTile,tileSize),t=new Hero(ctx,scaledMap,tileSize,tileSize,190,300);startLayer.push(e),startLayer.push(t)},loadDead=function(){var e=new TiledBackground(ctx,scaledMap,darkTile,tileSize),t=new Hero(ctx,scaledMap,tileSize,tileSize,190,300);deadLayer.push(e),deadLayer.push(t)},loadWin=function(){var e=new TiledBackground(ctx,scaledMap,darkTile,tileSize),t=new Hero(ctx,scaledMap,tileSize,tileSize,190,300);winLayer.push(e),winLayer.push(t)},loadBetweenLevels=function(){var e=new TiledBackground(ctx,scaledMap,darkTile,tileSize),t=new Hero(ctx,scaledMap,tileSize,tileSize,190,300);betweenLevelsLayer.push(e),betweenLevelsLayer.push(t)},loadLevel=function(){var e=levels[currentLevel],t=new TiledBackground(ctx,scaledMap,ee,tileSize);backgroundLayer.push(t),hero=new Hero(ctx,scaledMap,tileSize,tileSize,e.x,e.y),gameObjects.push(hero);for(var r=0;yTiles>r;r++)for(var a=0;xTiles>a;a++){var n=e.world[r][a];if(n>=0&&10>=n){var o=new Sprite(ctx,scaledMap,n,tileSize,tileSize,a*tileSize,r*tileSize);backgroundLayer.push(o)}else if(n>=12&&20>=n){var i=new Wall(ctx,scaledMap,n,tileSize,tileSize,a*tileSize,r*tileSize);walls.push(i)}else if(n==DD){var d=new Door(ctx,scaledMap,n,tileSize,tileSize,a*tileSize,r*tileSize);doors.push(d)}else if(n==o_){var s=new Egg(ctx,scaledMap,n,tileSize,tileSize,a*tileSize,r*tileSize);eggs.push(s)}else if(n==r_){var c=new Rock(a*tileSize,r*tileSize);rocks.push(c)}else if(n==c_)chest=new Chest(ctx,scaledMap,n,tileSize,tileSize,a*tileSize,r*tileSize);else if(n==ku||n==kd){var l=new Knight(a*tileSize,r*tileSize,n);knights.push(l)}}rocks.forEach(function(e){e.eggCollisionGroup=eggs,e.addGroupToCollisionGroup(walls),e.addGroupToCollisionGroup(doors),e.addItemToCollisionGroup(chest),e.addRocksToCollisionGroup(rocks),e.addGroupToCollisionGroup(knights)}),hero.addRocksCollisionGroup(rocks),hero.eggCollisionGroup=eggs,hero.doorCollisionGroup=doors,hero.addChest(chest),hero.addCollisionGroup(walls),hero.knightCollisionGroup=knights},render=function(){ctx.clearRect(0,0,canvas.width,canvas.height),scaledImageReady&&(currentState==GAME?renderLevel():currentState==START?renderStart():currentState==DEAD?renderDead():currentState==WIN?renderWin():currentState==BETWEEN&&renderBetween())},renderLevel=function(){backgroundLayer.forEach(function(e){e.render()}),walls.forEach(function(e){e.render()}),eggs.forEach(function(e){e.render()}),doors.forEach(function(e){e.render()}),chest.render(function(e){e.render()}),rocks.forEach(function(e){e.render()}),knights.forEach(function(e){e.render()}),swords.forEach(function(e){e.render()}),gameObjects.forEach(function(e){e.render()}),draw("r to restart level",2,140,396)},renderStart=function(){startLayer.forEach(function(e){e.render()}),draw("Fantastic",5,120,150),draw("monster",5,130,190),draw("chronicles",5,110,230),draw("ehtd presents",2,160,100),draw("Z to start",2,170,350)},renderDead=function(){deadLayer.forEach(function(e){e.render()}),draw("not today",5,120,150),draw("What do we say to the god of death?",2,70,100),draw("Z to revive",2,160,350)},renderWin=function(){winLayer.forEach(function(e){e.render()}),draw("fantastic",5,120,150),draw("Game completed ",2,150,100),draw("You are ",2,180,120)},renderBetween=function(){betweenLevelsLayer.forEach(function(e){e.render()});var e=levels[currentLevel];draw(e.p1,5,120,150),draw(e.p2,2,50,230),draw(e.p3,2,50,250),draw(e.p4,2,50,270),draw("X to start chapter",2,140,350)},timestamp=function(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()},fps=60,step=1/fps,dt=0,now,last=timestamp(),loop=function(){for(now=timestamp(),dt+=Math.min(1,(now-last)/1e3);dt>step;)dt-=step,update(step);render(ctx,dt),last=now,requestAnimationFrame(loop)};document.addEventListener("keydown",function(e){return onkey(e,e.keyCode,!0)},!1),document.addEventListener("keyup",function(e){return onkey(e,e.keyCode,!1)},!1);var KEY={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,Z:90,R:82,X:88},onkey=function(e,t,r){switch(t){case KEY.LEFT:return hero.left=r,!1;case KEY.RIGHT:return hero.right=r,!1;case KEY.UP:return hero.up=r,!1;case KEY.DOWN:return hero.down=r,!1;case KEY.Z:return changeState(),!1;case KEY.R:return restartLevel(),!1;case KEY.X:return beginLevel(),!1}};window.addEventListener("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()},!1);var restartLevel=function(){currentState==GAME&&(reset(),loadLevel())},changeState=function(){currentState==START?currentState=BETWEEN:currentState==DEAD&&(currentState=GAME,Music.play())},beginLevel=function(){currentState==BETWEEN&&(currentState=GAME,Music.play())},resize=function(e,t){var r=e.width*t,a=e.height*t,n=document.createElement("canvas");n.width=e.width,n.height=e.height;var o=n.getContext("2d");o.drawImage(e,0,0);var i=o.getImageData(0,0,e.width,e.height),d=document.createElement("canvas");d.width=r,d.height=a;for(var s=d.getContext("2d"),c=s.getImageData(0,0,r,a),l=0;a>l;l++)for(var u=0;r>u;u++){var h=4*(Math.floor(l/t)*e.width+Math.floor(u/t)),w=4*(l*r+u);c.data[w]=i.data[h],c.data[w+1]=i.data[h+1],c.data[w+2]=i.data[h+2],c.data[w+3]=i.data[h+3]}return s.putImageData(c,0,0),d},w=window;window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}),reset(),loop();