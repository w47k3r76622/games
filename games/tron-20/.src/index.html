<!DOCTYPE html><html><head><style>body,html{margin:0;height:100vh;background:linear-gradient(-45deg, #333, #000);overflow:hidden;}#c{border: 3px solid #fff3;position:absolute;background:#04f1;left:50%;top:50%;border-radius:10px;transform:translate(-50%,-50%);}</style></head><body><canvas id=c></canvas><script>async function Draw(){if(!t){for(bctx=(buffer=document.createElement("canvas")).getContext("2d"),buffer.width=c.width,buffer.height=c.height,oXv2=oYv2=oZv2=0,oX=oY=oZ=0,Rl=Pt=Yw=0,Rn=Math.random,R=($,h,_,f)=>{let n;A=(M=Math).atan2,H=M.hypot,f&&(X+=oX,Y+=oY,Z+=oZ),X=S(n=A(X,Z)+_)*(d=H(X,Z)),Z=C(n)*d,X=S(n=A(X,Y)+$)*(d=H(X,Y)),Y=S(n=A(Y=C(n)*d,Z)+h)*(d=H(Y,Z)),Z=C(n)*d,X+=oXv2,Y+=oYv2,Z+=oZv2,f&&(Y+=0,Z+=4)},R2=($,h,_,f=!1)=>{A=(M=Math).atan2,H=M.hypot,f&&(X-=oX,Y-=oY,Z-=oZ),X=S(p=A(X,Y)+$)*(d=H(X,Y)),Y=S(p=A(Y=C(p)*d,Z)+h)*(d=H(Y,Z)),X=S(p=A(X,Z=C(p)*d)+_)*(d=H(X,Z)),Z=C(p)*d},Q=()=>[c.width/2+X/Z*700,c.height/2+Y/Z*700+mofy],Q2=()=>[c.width/2+X/Z*2400*tscl1+21.95*tmofx-480+mofx1,c.height/2+Y/Z*2400*tscl1+tmofy+mofy1],Q3=()=>[c.width/2+X/Z*1200*tscl2/1.33+21.95*tmofx+480+mofx2,c.height/2+Y/Z*1200*tscl2/1.33+tmofy+mofy2],Q2p=()=>[X/Z*2400*tscl1,Y/Z*2400*tscl1],Q3p=()=>[X/Z*1200*tscl2/1.33,Y/Z*1200*tscl2/1.33],Q4=()=>[c.width-155+X/Z*33.975,c.height-155+Y/Z*33.975],I=($,h,_,f,n,o,r,g)=>(K=((r-n)*(h-o)-(g-o)*($-n))/(J=(g-o)*(_-$)-(r-n)*(f-h)))>=0&&K<1&&(L=((_-$)*(h-o)-(f-h)*($-n))/J)>=0&&L<1?[$+K*(_-$),h+K*(f-h)]:0,Cube=$=>{for(CB=[],j=6;j--;CB=[...CB,b])for(b=[],i=4;i--;)b=[...b,[(a=[S(p=2*Math.PI/4*i+Math.PI/4),C(p),1.4142135623730951/2])[j%3]*(l=j<3?$/1.4142135623730951:-$/1.4142135623730951),a[(j+1)%3]*l,a[(j+2)%3]*l]];return CB},subbed=($,h,_,f)=>{for(let n=$;n--;)base=f,f=[],base.map($=>{switch(X1=$[l=0][0],Y1=$[l][1],Z1=$[l][2],X2=$[l=1][0],Y2=$[l][1],Z2=$[l][2],X3=$[l=2][0],Y3=$[l][1],Z3=$[l][2],$.length>3&&(X4=$[l=3][0],Y4=$[l][1],Z4=$[l][2],$.length>4&&(X5=$[l=4][0],Y5=$[l][1],Z5=$[l][2])),mx1=(X1+X2)/2,my1=(Y1+Y2)/2,mz1=(Z1+Z2)/2,mx2=(X2+X3)/2,my2=(Y2+Y3)/2,mz2=(Z2+Z3)/2,a=[],$.length){case 3:mx3=(X3+X1)/2,my3=(Y3+Y1)/2,mz3=(Z3+Z1)/2,X=X1,a=[...a,[X,Y=Y1,Z=Z1]],X=mx1,a=[...a,[X,Y=my1,Z=mz1]],X=mx3,f=[...f,a=[...a,[X,Y=my3,Z=mz3]]],a=[],X=mx1,a=[...a,[X,Y=my1,Z=mz1]],X=X2,a=[...a,[X,Y=Y2,Z=Z2]],X=mx2,f=[...f,a=[...a,[X,Y=my2,Z=mz2]]],a=[],X=mx3,a=[...a,[X,Y=my3,Z=mz3]],X=mx2,a=[...a,[X,Y=my2,Z=mz2]],X=X3,f=[...f,a=[...a,[X,Y=Y3,Z=Z3]]],a=[],X=mx1,a=[...a,[X,Y=my1,Z=mz1]],X=mx2,a=[...a,[X,Y=my2,Z=mz2]],X=mx3,f=[...f,a=[...a,[X,Y=my3,Z=mz3]]];break;case 4:mx3=(X3+X4)/2,my3=(Y3+Y4)/2,mz3=(Z3+Z4)/2,mx4=(X4+X1)/2,my4=(Y4+Y1)/2,mz4=(Z4+Z1)/2,cx=(X1+X2+X3+X4)/4,cy=(Y1+Y2+Y3+Y4)/4,cz=(Z1+Z2+Z3+Z4)/4,X=X1,a=[...a,[X,Y=Y1,Z=Z1]],X=mx1,a=[...a,[X,Y=my1,Z=mz1]],X=cx,a=[...a,[X,Y=cy,Z=cz]],X=mx4,f=[...f,a=[...a,[X,Y=my4,Z=mz4]]],a=[],X=mx1,a=[...a,[X,Y=my1,Z=mz1]],X=X2,a=[...a,[X,Y=Y2,Z=Z2]],X=mx2,a=[...a,[X,Y=my2,Z=mz2]],X=cx,f=[...f,a=[...a,[X,Y=cy,Z=cz]]],a=[],X=cx,a=[...a,[X,Y=cy,Z=cz]],X=mx2,a=[...a,[X,Y=my2,Z=mz2]],X=X3,a=[...a,[X,Y=Y3,Z=Z3]],X=mx3,f=[...f,a=[...a,[X,Y=my3,Z=mz3]]],a=[],X=mx4,a=[...a,[X,Y=my4,Z=mz4]],X=cx,a=[...a,[X,Y=cy,Z=cz]],X=mx3,a=[...a,[X,Y=my3,Z=mz3]],X=X4,f=[...f,a=[...a,[X,Y=Y4,Z=Z4]]];break;case 5:cx=(X1+X2+X3+X4+X5)/5,cy=(Y1+Y2+Y3+Y4+Y5)/5,cz=(Z1+Z2+Z3+Z4+Z5)/5,mx3=(X3+X4)/2,my3=(Y3+Y4)/2,mz3=(Z3+Z4)/2,mx4=(X4+X5)/2,my4=(Y4+Y5)/2,mz4=(Z4+Z5)/2,mx5=(X5+X1)/2,my5=(Y5+Y1)/2,mz5=(Z5+Z1)/2,X=X1,a=[...a,[X,Y=Y1,Z=Z1]],X=X2,a=[...a,[X,Y=Y2,Z=Z2]],X=cx,f=[...f,a=[...a,[X,Y=cy,Z=cz]]],a=[],X=X2,a=[...a,[X,Y=Y2,Z=Z2]],X=X3,a=[...a,[X,Y=Y3,Z=Z3]],X=cx,f=[...f,a=[...a,[X,Y=cy,Z=cz]]],a=[],X=X3,a=[...a,[X,Y=Y3,Z=Z3]],X=X4,a=[...a,[X,Y=Y4,Z=Z4]],X=cx,f=[...f,a=[...a,[X,Y=cy,Z=cz]]],a=[],X=X4,a=[...a,[X,Y=Y4,Z=Z4]],X=X5,a=[...a,[X,Y=Y5,Z=Z5]],X=cx,f=[...f,a=[...a,[X,Y=cy,Z=cz]]],a=[],X=X5,a=[...a,[X,Y=Y5,Z=Z5]],X=X1,a=[...a,[X,Y=Y1,Z=Z1]],X=cx,f=[...f,a=[...a,[X,Y=cy,Z=cz]]],a=[]}});return _&&(ip1=_,ip2=1-_,f=f.map($=>$=$.map($=>(X=$[0],d=Math.hypot(X,Y=$[1],Z=$[2]),X/=d,Y/=d,Z/=d,X*=h/2*ip1+d*ip2,[X,Y*=h/2*ip1+d*ip2,Z*=h/2*ip1+d*ip2])))),f},subDividedCube=($,h,_=0)=>subbed(h,$,_,Cube($)),stroke=($,h,_,f,n=1,o=!1)=>{$&&(x.strokeStyle=$,o&&x.closePath(),x.lineWidth=Math.min(200,50/(1+Z)*_),f&&(x.globalAlpha=.25*n,x.stroke(),x.lineWidth/=3),x.globalAlpha=1*n,x.stroke()),h&&(x.globalAlpha=1*n,x.fillStyle=h,x.fill())},toggleView=()=>{view++,view%=views},checkPath=($,h=0,_=0,f=0)=>{let n,o,r=!1;if(!($.path.length<2))return $.path.map((g,y)=>{y>2||(n=$.path.length-y,o=$.path.length-y-1,y?(X1=$.path[n][0],Y1=$.path[n][1],Z1=$.path[n][2]):(X1=$.X+h,Y1=$.Y+_,Z1=$.Z+f),X2=$.path[o][0],Y2=$.path[o][1],Z2=$.path[o][2],r||players.map((h,_)=>{(h.alive&&!y||_!=$.id)&&(o=h.path.length-1,X3=h.path[o][0],Y3=h.path[o][1],Z3=h.path[o][2],X4=h.X,Y4=h.Y,(l=I(X1,Z1,X2,Z2,X3,Z3,X4,Z4=h.Z))&&(l[2]=_,r=l)),r||h.path.map((f,g)=>{n=g,o=g-1,(_!=$.id||g!=y)&&g&&g<h.path.length-2&&(X3=h.path[n][0],Y3=h.path[n][1],Z3=h.path[n][2],X4=h.path[o][0],Y4=h.path[o][1],(l=I(X1,Z1,X2,Z2,X3,Z3,X4,Z4=h.path[o][2]))&&(l[2]=_,r=l))})}),r||perimeter.map(($,h)=>{h&&(n=h-1,o=h,X3=perimeter[n][0],Y3=perimeter[n][1],Z3=perimeter[n][2],X4=perimeter[o][0],Y4=perimeter[o][1],(l=I(X1,Z1,X2,Z2,X3,Z3,X4,Z4=perimeter[o][2]))&&(r=l))}))}),r},spawnPlayer=($=-1)=>(spawnG=.8*perG,X=(Rn()-.5)*spawnG,Y=0,Z=(Rn()-.5)*spawnG,theta=0,iPv=Math.min(playerMaxSpeed,2*playerMinSpeed),$==camSelected&&(oXv=-X,oYv=0,oZv=-Z,oX=-X,oY=0,oZ=-Z,Rl=0,Pt=-.5,Yw=0,Rlv=0,Ptv=-.5,Ywv=0),{X,Y,Z,theta,AITimer:0,score:void 0!==players[$]?players[$].score:0,AITurnTimer:0,speed:2*iPv,alive:!0,ox:X,oy:Y,oz:Z,path:[[X,Y,Z],[X,Y,Z]],keys:Array(128).fill(!1),keyTimers:Array(128).fill(0),name:void 0!==players[$]?players[$].name:0==$?"human":`AI player ${$}`,respawnPending:!1,id:-1==$?players.length:$}),spawnFlashNotice=($,h)=>{flashNotices=[...flashNotices,[$,h,2]]},drawLeaderboard=()=>{margin=5,x.globalAlpha=.7;let $=(2+players.length)*28;x.fillStyle="#001c",x.strokeStyle="#fff2",x.lineWidth=2,x.fillRect(margin,c.height-$-margin,400,$),x.strokeRect(margin,c.height-$-margin,400,$),x.globalAlpha=1,Y2=40,X1=400-(X2=80)-margin,Y1=c.height-$-3*margin,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",x.strokeRect(X1,20+Y1,X2,Y2),x.fillStyle="#000",x.fillRect(X1,20+Y1,X2,Y2),str="[L]",x.fillStyle="#fff",x.fillText(str,X1+X2/2,Y1+50),x.textAlign="left",x.font="28px monospace",x.fillStyle="#0FF",x.strokeStyle="#40F4",x.strokeText("LEADERBOARD",2*margin,c.height-2*margin-(players.length+1)*28+1.12),x.fillText("LEADERBOARD",2*margin,c.height-2*margin-(players.length+1)*28+1.12),x.fillStyle="#0F8",x.strokeStyle="#40F4",x.strokeText(" # SCORE  NAME",2*margin,c.height-2*margin-28*players.length+1.12),x.fillText(" # SCORE  NAME",2*margin,c.height-2*margin-28*players.length+1.12),x.fillStyle="#fff",x.strokeStyle="#8804",scores=[],players.map(($,h)=>{scores=[...scores,{score:(player=players[players.length-h-1]).score,name:player.name}]}),scores.sort(($,h)=>$.score-h.score),scores.map(($,h)=>{str=` ${scores.length-h}   ${$.score}    ${$.name}`,x.strokeText(str,2*margin,c.height-2*margin-28*h+1.12),x.fillText(str,2*margin,c.height-2*margin-28*h+1.12)}),x.textAlign="center"},drawOverview=()=>{x.globalAlpha=1,margin=5,x.fillStyle="#001c",x.strokeStyle="#40fc",x.lineWidth=2,x.fillRect(c.width-300-margin,c.height-300-margin,300,300),x.strokeRect(c.width-300-margin,c.height-300-margin,300,300),x.strokeStyle="#fff3",X2=80,Y2=40,X1=c.width-300-X2-3*margin,Y1=c.height-Y2-6*margin,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",x.strokeRect(X1,20+Y1,X2,Y2),x.fillStyle="#000",x.fillRect(X1,20+Y1,X2,Y2),str="[O]",x.fillStyle="#fff",x.fillText(str,X1+X2/2,Y1+50),cond=!0,players.map(($,h)=>{$.alive&&(X=$.X,Y=$.Y,Z=$.Z,R(0,-Math.PI/2,0,0),Z=32,l=Q4(),s=Math.min(1e3,2e3/Z*(.5+.25*S(99*t))),x.fillStyle=`hsla(${40+360/players.length*h+90},99%,50%,0.1)`,x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle=`hsla(${360/players.length*h+90},99%,50%,0.5)`,x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle="#fff",x.fillRect(l[0]-s/2,l[1]-s/2,s,s)),$.path=$.path.filter((h,_)=>$.path.length<maxPlayerLength||_),x.beginPath(),$.path.map((h,_)=>{l1=_,X1=X=$.path[l1][0],Y1=Y=cond?0:$.path[l1][1],Z1=Z=$.path[l1][2],(d1=Math.hypot(X-players[camSelected].X,Z-players[camSelected].Z))<500&&(R(0,-Math.PI/2,0,0),(Z=32)>0&&x.lineTo(...Q4()))}),col1=$.alive?`hsla(${360/players.length*h+90},99%,50%,1)`:"#888",Z=50,stroke(col1,col2="",2,!1)}),w_=160*(s=.33)*.9,h_=664*s*.95,x.fillStyle="#000",x.fillRect(c.width-w_,c.height-h_-316,.9*w_,h_),d=players[camSelected].speed/playerMaxSpeed,x.fillStyle=`hsla(${180-180*d}, 99%,50%,1)`,x.fillRect(c.width-w_,c.height-316,.9*w_,-h_*d),w_=160*s,h_=664*s,x.strokeStyle="#fff8",x.lineWidth=4,x.strokeRect(c.width-w_+4,c.height-h_-305,w_-8,h_-10),x.strokeStyle="#fff4",X2=40,Y2=21,X1=c.width-X2/2-28,Y1=c.height/2-18,x.lineWidth=10,x.font="20px monospace",x.textAlign="center",x.strokeRect(X1,Y1,X2,Y2),x.fillStyle="#000",x.fillRect(X1,Y1,X2,Y2),str="SPD",x.fillStyle="#fff",x.fillText(str,X1+X2/2,Y1+16)},(init=()=>{if(perG=200,perSp=2*(1.4142135623730951/2),camSelected=0,AIFreq=1/60*0,flashNotices=[],maxPlayerLength=500,showOverview=!0,showLeaderboard=!0,paused=!1,AIOpponents=4,AITurnInterval=1/60*10,cl=36,br=36,rw=1,iPv=Math.min(playerMaxSpeed=2,2*(playerMinSpeed=.05)),sp=1.333,keyTimerInterval=.25,views=3,view=1,keep=[8,11],mofx=mofy=0,tmofx=tmofy=0,scl1=view<=1?.5:1,scl2=(view>=1?.4:.66)/(.5+2*iPv),tscl1=scl1,tscl2=scl2,viewFrame=subDividedCube(1,1,0).filter(($,h)=>keep.filter($=>$==h).length).map($=>(s__=2.73,$.map($=>{$[0]*=16*s__,$[1]*=18*s__,$[2]*=0,$[1]+=4.5*s__}),$)),"undefined"==typeof players){players=[];for(let $=0;$<AIOpponents+1;$++)players=[...players,spawnPlayer($)]}iViewFrame=structuredClone(viewFrame)})(),sparks=[],iSparkv=.125,spawnSparks=($,h,_,f)=>{for(let n=300;n--;)v=Rn()**1*iSparkv,vx=S(f.theta)*f.speed/6+S(p=2*Math.PI*Rn()**.5)*S(q=.5>Rn()?Math.PI/2*Rn()**.5:Math.PI-Math.PI/2*Rn()**.5)*v,sparks=[...sparks,[$,h,_,vx,vy=C(q)*v/4,vz=C(f.theta)*f.speed/6+C(p)*S(q)*v,.5+Rn()/2]]},accel=$=>{$.alive&&($.speed+=.075,$.speed=Math.min(playerMaxSpeed,$.speed))},deccel=$=>{$.alive&&($.speed-=.1,$.speed=Math.max(playerMinSpeed,$.speed))},turnLeft=($,h=!1)=>{$.theta-=Math.PI/2,$.alive&&!h&&($.path=[...$.path,[$.X,$.Y,$.Z]],vx=S($.theta)*$.speed,vy=0,vz=C($.theta)*$.speed,$.X+=vx,$.Y+=vy,$.Z+=vz,$.path[$.path.length-1]=[$.X,$.Y,$.Z],(l=checkPath($))&&$.alive&&killPlayer($,l))},turnRight=($,h=!1)=>{$.theta+=Math.PI/2,$.alive&&!h&&($.path=[...$.path,[$.X,$.Y,$.Z]],vx=S($.theta)*$.speed,vy=0,vz=C($.theta)*$.speed,$.X+=vx,$.Y+=vy,$.Z+=vz,$.path[$.path.length-1]=[$.X,$.Y,$.Z],(l=checkPath($))&&$.alive&&killPlayer($,l))},window.onkeydown=$=>{console.log($.keyCode),players[0].keys[$.keyCode]=!0},window.onkeyup=$=>{players[0].keys[$.keyCode]=!1,players[0].keyTimers[$.keyCode]=0},window.onload=()=>c.focus(),resetGame=()=>{players[0]=spawnPlayer(0)},doKeys=$=>{$.keys.map((h,_)=>{if(h&&$.keyTimers[_]<=t)switch($.keyTimers[_]=t+keyTimerInterval,_){case 80:paused=!paused;break;case 76:showLeaderboard=!showLeaderboard;break;case 79:showOverview=!showOverview;break;case 32:$.alive||resetGame();break;case 37:paused||turnLeft($);break;case 38:paused||accel($);break;case 39:paused||turnRight($);break;case 40:paused||deccel($);break;case 86:toggleView()}})},base_shp=subDividedCube(sp,0,0).filter(($,h)=>1==h).map($=>($.map($=>{$[1]*=0}),$)),shapes=Array(cl*rw*br).fill().map(($,h)=>(X=(h%cl-cl/2+.5)*sp,Y=((h/cl|0)%rw-rw/2+.5)*sp,[X,Y,Z=((h/rw/cl|0)-br/2+.5)*sp,shp=structuredClone(base_shp)])),drawSparks=()=>{sparks=sparks.filter($=>$[6]>0);for(let $=1==view?2:1;$--;)cond=2!==view&&!$,sparks.map(h=>{omit=!1,$||(h[0]+=h[3],h[1]+=h[4],h[2]+=h[5]),X=h[0],Y=cond?0:h[1],Z=h[2],cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1==view&&($?(l[0]>c.width/2&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):(l[0]<c.width/2&&(omit=!0),l[0]=Math.max(c.width/2,l[0]))),!omit&&Z>0&&(s=Math.min(1e4,1200/Z*h[6]),x.fillStyle="#ff000006",x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle="#ff880012",x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle="#ffffffff",x.fillRect(l[0]-s/2,l[1]-s/2,s,s)),$||(h[6]-=.0025)})},AILookAhead=1+10*iPv,doAI=$=>{$.AITimer<=t&&($.AITimer=t+AIFreq,.01>Rn()&&(.4>Rn()?accel:deccel)($),vx=S((tplayer=structuredClone($)).theta)*tplayer.speed,d=Math.hypot(vx,vy=0,vz=C(tplayer.theta)*tplayer.speed),vx/=d,vy/=d,vz/=d,vx*=AILookAhead,vy*=AILookAhead,vz*=AILookAhead,l=tplayer.path.length-1,tplayer.path[l][0]+=vx,tplayer.path[l][1]+=vy,tplayer.path[l][2]+=vz,checkPath(tplayer)?.5>Rn()?(turnRight(tplayer,!0),vx=S(tplayer.theta)*tplayer.speed,d=Math.hypot(vx,vy=0,vz=C(tplayer.theta)*tplayer.speed),vx/=d,vy/=d,vz/=d,vx*=AILookAhead,checkPath(tplayer,vx,vy*=AILookAhead,vz*=AILookAhead)?turnLeft($):turnRight($)):(turnLeft(tplayer,!0),vx=S(tplayer.theta)*tplayer.speed,d=Math.hypot(vx,vy=0,vz=C(tplayer.theta)*tplayer.speed),vx/=d,vy/=d,vz/=d,vx*=AILookAhead,checkPath(tplayer,vx,vy*=AILookAhead,vz*=AILookAhead)?turnRight($):turnLeft($)):.0025>Rn()&&$.AITurnTimer<=t&&($.AITurnTimer=t+AITurnInterval,.5>Rn()?(turnRight(tplayer,!0),checkPath(tplayer)||turnRight($)):(turnLeft(tplayer,!0),checkPath(tplayer)||turnLeft($))))},killPlayer=($,h)=>{$.alive&&(spawnSparks(l1[0],0,l1[1],$),$.alive=!1,$.speed=playerMinSpeed,l2=$.path.length-1,$.X=l1[0],$.Y=0,$.Z=l1[1],$.path[l2][0]=l1[0],$.path[l2][1]=0,$.path[l2][2]=l1[1],"number"==typeof h[2]&&$.id!=h[2]&&players[h[2]].alive&&(players[h[2]].score++,spawnFlashNotice(`POINT!, ${players[h[2]].name}`,`hsla(${360/players.length*h[2]+90},99%,50%,1)`)))},drawPlayers=()=>{for(m=1==view?2:1;m--;)cond=2!==view&&!m,players.map(($,h)=>{$.path=$.path.filter((h,_)=>$.path.length<maxPlayerLength||_),$.path.map((_,f)=>{!f||(omit=!1,x.beginPath(),l1=f,l2=f-1,X1=X=$.path[l1][0],Y1=Y=cond?0:$.path[l1][1],Z1=Z=$.path[l1][2],!((d1=Math.hypot(X-players[camSelected].X,Z-players[camSelected].Z))<50)||(cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):(l[0]<c.width/2&&(omit=!0),l[0]=Math.max(c.width/2,l[0]))),Z>0&&x.lineTo(...l),omit||(X2=X=$.path[l2][0],Y2=Y=cond?0:$.path[l2][1],Z2=Z=$.path[l2][2],cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l),cond?(col1=$.alive?`hsla(${360/players.length*h+90},99%,50%,${1/(1+d1**10/1e14)})`:`hsla(${360/players.length*h+90},0%,50%,${1/(1+d1**10/1e14)})`,col2="",omit||stroke(col1,col2,2,!0)):omit||(X=X2,Y=Y2-1,Z=Z2,R(Rl,Pt,Yw,1),l=Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l),omit||(X=X1,Y=Y1-1,Z=Z1,R(Rl,Pt,Yw,1),l=Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l),col1="",col2=$.alive?`hsla(${360/players.length*h+90},99%,50%,${.5/(1+d1**10/1e14)})`:`hsla(${360/players.length*h+90},0%,50%,${.5/(1+d1**10/1e14)})`,omit||stroke(col1,col2,cond?2:1,!0))))))}),$.alive&&!paused&&!m&&(vx=S($.theta)*$.speed,vy=0,vz=C($.theta)*$.speed,tplayer=structuredClone($),tplayer.X+=vx,tplayer.Y+=vy,tplayer.Z+=vz,(l1=checkPath(tplayer))?$.alive&&killPlayer($,l1):(X=$.X+=vx,Y=$.Y+=vy,Z=$.Z+=vz,(X>perSp*perG/2||X<-perSp*perG/2||Z>perSp*perG/2||Z<-perSp*perG/2)&&killPlayer($,[$.X,$.Z]),(60*t|0)%(20/(1+20*$.speed)|0)?($.path[$.path.length-1][0]=X,$.path[$.path.length-1][1]=Y,$.path[$.path.length-1][2]=Z):$.path=[...$.path,[X,Y,Z]])),h||$.alive||(x.fillStyle="#18000688",x.fillRect(0,0,c.width,c.height),x.font=(fs=100)+"px monospace",x.fillStyle="#f02",x.strokeStyle="#000",x.lineWidth=16,x.strokeText("ded",c.width/2,c.height/2-1*fs),x.fillText("ded",c.width/2,c.height/2-1*fs),x.strokeText("hit the space key",c.width/2,c.height/2+1*fs),x.fillText("hit the space key",c.width/2,c.height/2+1*fs))})},drawBoards=()=>{for(m=1==view?2:1;m--;)(cond=2!==view&&!m)&&2!==view&&viewFrame.map(($,h)=>{0==h&&(x.beginPath(),$.map(($,_)=>{X=iViewFrame[h][_][0],Y=iViewFrame[h][_][1],Z=iViewFrame[h][_][2],(Z+=8)>0&&x.lineTo(...Q())}),stroke(col1="",col2="#000",5,!0))}),shapes.map(($,h)=>{if(nx=1+Math.round(h%cl/sp*2),ny=1+Math.round((h/cl|0)/sp*2),cnd=nx%3&&ny%3){for(tx=$[0],ty=$[1],tz=$[2];tx-players[camSelected].X>cl*sp/2;)tx-=cl*sp;for(;tx-players[camSelected].X<-cl*sp/2;)tx+=cl*sp;for(;tz-players[camSelected].Z>br*sp/2;)tz-=br*sp;for(;tz-players[camSelected].Z<-br*sp/2;)tz+=br*sp;$[3].map(($,_)=>{x.beginPath(),$.map($=>{X=$[0]+tx,Y=cond?0:$[1]+ty,Z=$[2]+tz,cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1!=view||m||(l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l)}),col1="",stroke(col1,col2=(h+(h/br|0)%4)%4?"#4400ff20":"#00ff8820",4,!1,oga=1/(1+Math.hypot(tx-players[camSelected].X,tz-players[camSelected].Z)**8/1e10))})}}),perimeter.map($=>{tx=$[0],ty=$[1],tz=$[2],(d1=Math.hypot(tx-players[camSelected].X,tz-players[camSelected].Z))<50&&(oga=1/(1+d1**10/1e14))>.025&&$[3].map($=>{x.beginPath(),$.map($=>{X=tx+$[0],Y=cond?0:ty+$[1],Z=tz+$[2],cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1!=view||m||(l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l)}),col2="#888",stroke(col1=2===view||m?"":"#888",col2,4,!1,oga)})}),x.globalAlpha=1},mofx1=mofy1=mofx2=mofy2=0,oX=oXv=-players[camSelected].X,oY=oYv=-players[camSelected].Y,oZ=oZv=-players[camSelected].Z,base_peri_shp=[],perimeter=[],i=4;i--;)X=S(p=2*Math.PI/4*i+Math.PI/4),a=[...a,[X,Y=C(p),Z=0]];for(base_peri_shp=[...base_peri_shp,a],b=[],i=perG;i--;)tx=(i-perG/2+.5)*perSp,ty=0,b=[...b,[tx,ty,tz=perG/2*perSp,shp=structuredClone(base_peri_shp)]];for(i=3,perimeter=[...perimeter,...b];i--;)(e=structuredClone(b)).map($=>{X=$[0],Y=$[1],Z=$[2],R(0,0,2*Math.PI/4*(i+1)),$[0]=X,$[1]=Y,$[2]=Z,$[3].map($=>{$.map($=>{X=$[0],Y=$[1],Z=$[2],R(0,0,2*Math.PI/4*(i+1)),$[0]=X,$[1]=Y,$[2]=Z})})}),perimeter=[...perimeter,...e];perimeter.map($=>{$[3].map($=>{$.map($=>{$[1]*=2,$[0],$[1]-=1*perSp,$[2]})})})}if(x.globalAlpha=1,x.fillStyle="#000e",x.fillRect(0,0,c.width,c.height),x.lineJoin=x.lineCap="butt",boardHoming=10,l=players[camSelected].path.length){el=players[camSelected].path[l-1];for(let $=2;$--;)X=el[0],Y=$?0:el[1],Z=el[2],$&&(R(Rl,-Math.PI/2,Yw,0),Z+=8,mofx2=-(l2=Q3p())[0]/1,mofy2=-l2[1]/1)}for(min=(.2+players[camSelected].speed)*1.1,oXv=-players[camSelected].X,oYv=-players[camSelected].Y,oZv=-players[camSelected].Z,oXv2=.2,oYv2=(view,0),oZv2=2==view?8:0,vx=(oXv-oX)/boardHoming,d2=Math.min(d1=Math.hypot(vx,vy=(oYv-oY)/boardHoming,vz=(oZv-oZ)/boardHoming)+1e-4,min),vx/=d1,vy/=d1,vz/=d1,vx*=d2,vy*=d2,vz*=d2,oX+=vx,oY+=vy,oZ+=vz,min=.05,d2=Math.min(d1=Math.abs(v=((Rlv=0)-Rl)/boardHoming)+1e-4,min),v/=d1,v*=d2,Rl+=v,d2=Math.min(d1=Math.abs(v=((Ptv=-.5)-Pt)/boardHoming)+1e-4,min),v/=d1,v*=d2,Pt+=v,d2=Math.min(d1=Math.abs(v=((Ywv=-players[camSelected].theta)-Yw)/boardHoming)+1e-4,min),v/=d1,v*=d2,Yw+=v,players.map($=>{doKeys($)}),homing=5,viewFrame.map(($,h)=>{x.beginPath(),$.map(($,_)=>{switch(view){case 0:s_=h?0:2,ofx=-8*s__;break;case 1:s_=1,ofx=0;break;case 2:s_=h?2:0,ofx=8*s__}X1=$[0]*s_+ofx,Y1=$[1],Z1=$[2],X2=iViewFrame[h][_][0],Y2=iViewFrame[h][_][1],Z2=iViewFrame[h][_][2],vx=X1-X2,d2=Math.min(d1=Math.hypot(vx,vy=Y1-Y2,vz=Z1-Z2)+.001,homing),vx/=d1,vy/=d1,vz/=d1,vx*=d2,vy*=d2,vz*=d2,X=iViewFrame[h][_][0]+=vx,Y=iViewFrame[h][_][1]+=vy,Z=iViewFrame[h][_][2]+=vz,(Z+=8)>0&&x.lineTo(...Q())}),stroke(col1="#0f8",col2="",2,!1)}),mofx=iViewFrame[1][0][0],mofy=0,drawBoards(),x.strokeStyle="#fff4",X1=40*mofx-60,Y1=0,X2=120,Y2=50,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",m=3;m--;){switch(lx=875*(m-1),x.strokeRect(960+X1+lx,20+Y1,X2,Y2),x.fillStyle="#000",x.fillRect(960+X1+lx,20+Y1,X2,Y2),m){case 0:str="3D";break;case 1:str="←v→";break;case 2:str="2D"}x.fillStyle="#fff",x.fillText(str,960+X1+60+lx,56)}scl1=view<=1?.25:.5,scl2=(view>=1?.4:.66)/2,tmofx+=(mofx-tmofx)/10,tmofy+=(mofy-tmofy)/10,tscl1+=(scl1-tscl1)/20,tscl2+=(scl2-tscl2)/20,players.map(($,h)=>{h&&!$.alive?$.respawnPending||($.respawnPending=!0,setTimeout(()=>{players[h]=spawnPlayer(h)},2e3)):!paused&&h&&$.alive&&doAI($)}),drawSparks(),drawPlayers(),showOverview&&drawOverview(),showLeaderboard&&drawLeaderboard(),flashNotices=flashNotices.filter($=>$[2]>0),flashNotices.length&&(x.fillStyle=flashNotices[l=flashNotices.length-1][1],x.globalAlpha=Math.min(1,flashNotices[l][2]),x.textAlign="center",x.fillRect(0,0,c.width,c.height),x.fillStyle="#fff8",x.font=(fs=100)+"px monospace",x.strokeStyle="#000a",x.lineWidth=10,x.strokeText(flashNotices[l][0],c.width/2,c.height/2+fs/4),x.fillText(flashNotices[l][0],c.width/2,c.height/2+fs/4),flashNotices[l][2]-=.05),x.globalAlpha=1,x.strokeStyle="#fff4",X2=paused?280:240,Y2=50,X1=-X2/2,Y1=c.height-Y2-10,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",x.strokeRect(960+X1,Y1,X2,Y2),x.fillStyle=paused?"#601":"#021",x.fillRect(960+X1,Y1,X2,Y2),str=paused?"unpause [p]":" pause [p] ",x.fillStyle="#fff",x.fillText(str,960,Y1+33),t+=1/60,requestAnimationFrame(Draw)}(c=document.querySelector("#c")).width=1920,c.height=1080,x=c.getContext("2d"),C=Math.cos,S=Math.sin,t=0,T=Math.tan,(rsz=window.onresize=()=>{let $=document.body,h=10,_,f=.5625;$.clientHeight/$.clientWidth>f?(c.style.width=`${(_=$.clientWidth)-2*h}px`,c.style.height=`${_*f-2*h}px`):(c.style.height=`${(_=$.clientHeight)-2*h}px`,c.style.width=`${_/f-2*h}px`)})(),Draw();</script></body></html>