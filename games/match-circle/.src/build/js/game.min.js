function init(a){var b,c,d,e=0;ctx=document.getElementById("canvas").getContext("2d"),document.getElementById("canvas").addEventListener("ontouchstart"in window?"touchstart":"mousedown",onTouchstart,!1),gameStatus.crntStage=a,crntMap=[];for(b=0;b<config.boardWidth*config.boardHeight;b++)crntMap.push(mapDB[a][b]);for(bg=new BackGround,mapToBoard=[],board=[],block=[],c=0;c<config.boardHeight;c++)for(b=0;b<config.boardWidth;b++)1===crntMap[b+config.boardWidth*c]?(d=Math.floor(e/2)%config.totalTypes,board.push(new Card({x:b*config.chrWidth,y:c*config.chrHeight+config.offsetY,w:config.chrWidth,h:config.chrHeight,i:b,j:c,type:d,selectable:!0,selected:!1})),mapToBoard.push(e),e++):2===crntMap[b+config.boardWidth*c]?(block.push(new Block({x:b*config.chrWidth,y:c*config.chrHeight+config.offsetY,w:config.chrWidth,h:config.chrHeight,i:b,j:c,selectable:!1})),mapToBoard.push(-1)):mapToBoard.push(-1);do shuffle();while(!canSolve());gameStatus.startTime=+new Date,loop()}function shuffle(){var a,b,c;for(b=0;b<board.length;b++)c=Math.floor(Math.random()*board.length),null!==board[b]&&null!==board[c]&&board[b].selectable&&board[c].selectable&&(a=board[b].type,board[b].type=board[c].type,board[c].type=a)}function isFinish(){var a,b=crntMap;for(a=0;a<b.length;a++)if(1===b[a])return!1;return!0}function canSolve(){var a,b,c,d,e;for(a=0;a<crntMap.length;a++)if(1===crntMap[a])for(b=a+1;b<crntMap.length;b++)if(1===crntMap[b]&&(c=getIJfromIdx(a),d=getIJfromIdx(b),e=isPath(c.i,c.j,d.i,d.j),isSameType(c.i,c.j,d.i,d.j)&&e))return e;return!1}function isSameType(a,b,c,d){return getChrAt(a,b)&&getChrAt(c,d)&&getChrAt(a,b).selectable&&getChrAt(c,d).selectable?getChrType(a,b)===getChrType(c,d):void 0}function isPath(a,b,c,d){var e,f,g,h,i=crntMap;if(null===getChrAt(a,b)||null===getChrAt(c,d)||!getChrAt(a,b).selectable||!getChrAt(c,d).selectable)return!1;if(isLine(a,b,c,d))return[{i:a,j:b},{i:c,j:d}];if(0===i[c+b*config.boardWidth]&&isLine(a,b,c,b)&&isLine(c,b,c,d))return[{i:a,j:b},{i:c,j:b},{i:c,j:d}];if(0===i[a+d*config.boardWidth]&&isLine(a,b,a,d)&&isLine(a,d,c,d))return[{i:a,j:b},{i:a,j:d},{i:c,j:d}];for(g=1;g<config.boardWidth;g++){if(e=a-g,e>=0&&e<config.boardWidth&&0===i[e+b*config.boardWidth]&&0===i[e+d*config.boardWidth]&&isLine(a,b,e,b)&&isLine(e,b,e,d)&&isLine(e,d,c,d))return[{i:a,j:b},{i:e,j:b},{i:e,j:d},{i:c,j:d}];if(e=a+g,e>=0&&e<config.boardWidth&&0===i[e+b*config.boardWidth]&&0===i[e+d*config.boardWidth]&&isLine(a,b,e,b)&&isLine(e,b,e,d)&&isLine(e,d,c,d))return[{i:a,j:b},{i:e,j:b},{i:e,j:d},{i:c,j:d}]}for(h=1;h<config.boardHeight;h++){if(f=b-h,f>=0&&f<config.boardHeight&&0===i[a+f*config.boardWidth]&&0===i[c+f*config.boardWidth]&&isLine(a,b,a,f)&&isLine(a,f,c,f)&&isLine(c,f,c,d))return[{i:a,j:b},{i:a,j:f},{i:c,j:f},{i:c,j:d}];if(f=b+h,f>=0&&f<config.boardHeight&&0===i[a+f*config.boardWidth]&&0===i[c+f*config.boardWidth]&&isLine(a,b,a,f)&&isLine(a,f,c,f)&&isLine(c,f,c,d))return[{i:a,j:b},{i:a,j:f},{i:c,j:f},{i:c,j:d}]}return!1}function isLine(a,b,c,d){var e,f,g=crntMap;if(a===c&&b===d||a!==c&&b!==d)return!1;if(a!==c&&b===d){if(c>a){for(e=a+1;c>e;e++)if(0!==g[e+b*config.boardWidth])return!1}else for(e=c+1;a>e;e++)if(0!==g[e+b*config.boardWidth])return!1}else if(d>b){for(f=b+1;d>f;f++)if(0!==g[a+f*config.boardWidth])return!1}else for(f=d+1;b>f;f++)if(0!==g[a+f*config.boardWidth])return!1;return!0}function getChrAt(a,b){return-1!==mapToBoard[a+config.boardWidth*b]?board[mapToBoard[a+config.boardWidth*b]]:void 0}function getChrIdx(a,b){return mapToBoard[a+config.boardWidth*b]}function getChrType(a,b){return-1!==mapToBoard[a+config.boardWidth*b]?board[mapToBoard[a+config.boardWidth*b]].type:void 0}function getIJfromIdx(a){return{i:a%config.boardWidth,j:Math.floor(a/config.boardWidth)}}function onTouchstart(a){if(a.offsetX){var b=a.offsetX,c=a.offsetY,d=Math.floor(b/config.chrWidth),e=Math.floor((c-config.offsetY)/config.chrHeight),f=[];if(a.preventDefault(),!(0>d||config.boardWidth<=d||0>e||config.boardHeight<=e)&&getChrAt(d,e)){if(!firstChoice)return firstChoice=getChrAt(d,e),void(firstChoice.selected=!0);if(d!==firstChoice.i||e!==firstChoice.j)if(f=isPath(firstChoice.i,firstChoice.j,d,e),isSameType(firstChoice.i,firstChoice.j,d,e)&&f){if(crntMap[firstChoice.i+firstChoice.j*config.boardWidth]=0,board[mapToBoard[firstChoice.i+firstChoice.j*config.boardWidth]]=null,crntMap[d+e*config.boardWidth]=0,board[mapToBoard[d+e*config.boardWidth]]=null,gameStatus.score+=config.matchPoint,isFinish())return;if(!canSolve())do shuffle();while(!canSolve());firstChoice=null}else firstChoice.selected=!1,firstChoice=getChrAt(d,e),firstChoice.selected=!0}}}function loop(){gameStatus.crntTime=+new Date-gameStatus.startTime,config.totalTime-gameStatus.crntTime<=0?drawEnd():isFinish()?drawEnd():(requestAnimationFrame(loop),drawAll(),gameStatus.crntTime<3e3&&drawStart())}function drawAll(){var a;for(ctx.clearRect(0,0,config.width,config.height),bg.draw(ctx),a=0;a<board.length;a++)board[a]&&board[a].draw(ctx);for(a=0;a<block.length;a++)block[a]&&block[a].draw(ctx)}function drawStart(){ctx.font="80px Accent",ctx.fillStyle="#FF9900",ctx.fillText("Stage : "+(gameStatus.crntStage+1),20,280),ctx.fillText("Game Start!",20,380),ctx.font="Bold 80px Accent",ctx.fillText(3-Math.floor(gameStatus.crntTime/1e3),220,480)}function drawEnd(){ctx.font="80px Accent",ctx.fillStyle="#FF9900",ctx.fillText("Game End!",20,380)}var config={width:520,height:720,totalTypes:8,colors:["#800080","#55D43F","#0000FF","#00FF00","#F4A460","#FF69B4","#FFA500","#006400"],boardWidth:10,boardHeight:10,chrWidth:50,chrHeight:50,offsetY:210,matchPoint:1,timePoint:2,totalTime:63e3},mapDB=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,2,2,0,1,0,0,0,0,1,0,2,2,0,1,0,0,0,0,1,0,2,2,0,1,0,0,0,0,1,0,2,2,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,2,2,0,1,0,0,0,0,1,0,2,2,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,2,2,2,2,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,2,2,2,2,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,2,2,2,2,1,0,0,0,0,1,2,2,2,2,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],gameStatus={score:0,crntStage:null,startTime:null,crntTime:null},BackGround=function(){};BackGround.prototype.draw=function(a){var b=Math.floor((config.totalTime-gameStatus.crntTime)/1e3);b=b>60?60:b,a.fillStyle="#3385FF",a.font="40px Verdana",a.fillText("Time : "+b+"Â s",260,50),a.fillStyle="#FF9900",a.fillRect(10,60,500*b/config.totalTime*1e3,5),a.fillStyle="rgb(200, 0, 50)",a.fillText("Score : "+gameStatus.score,10,50)};var Card=function(a){this.x=a.x,this.y=a.y,this.w=a.w,this.h=a.h,this.i=a.i,this.j=a.j,this.type=a.type,this.selectable=a.selectable};Card.prototype.draw=function(a){a.strokeStyle="#FFBB00";for(var b=0;b<config.boardHeight;b++)a.beginPath(),a.moveTo(35,235+config.chrHeight*b),a.lineTo(485,235+config.chrHeight*b),a.closePath(),a.stroke();for(var b=0;b<config.boardWidth;b++)a.beginPath(),a.moveTo(35+config.chrWidth*b,235),a.lineTo(35+config.chrWidth*b,685),a.closePath(),a.stroke();a.fillStyle=config.colors[this.type],a.beginPath(),a.arc(this.x+this.w/2,this.y+this.h/2,this.w/2,0,2*Math.PI,!1),a.closePath(),a.fill(),this.selected===!0&&(a.fillStyle="#FFFFFF",a.beginPath(),a.arc(this.x+this.w/2,this.y+this.h/2,this.w/4,0,2*Math.PI,!1),a.closePath(),a.fill())};var Block=function(a){this.x=a.x,this.y=a.y,this.w=a.w,this.h=a.h,this.i=a.i,this.j=a.j,this.selectable=a.selectable};Block.prototype.draw=function(a){a.fillStyle="#333333",a.fillRect(this.x,this.y,this.w,this.h)};var ctx,crntMap,mapToBoard,board,block,bg,firstChoice=!1;