function BaseClass(){}function playerKilled(a){for(var b=[],c=0;c<players.length;c++)physicalObjects[c].alive&&b.push(c);if(1===b.length){winner=b[0];for(var d in ArrowKeyHandler.keys)delete key;alert("Winner is opponent "+(~~b[0]+1)),document.getElementById("countdown").innerHTML="Refresh to play again!"}}function getPlayerCount(){for(var a=null;null==a||isNaN(a)||2>a||a>4;)a=prompt("How many opponents? (2-4)",4);return a}function getHumanCount(){for(var a=null;null==a||isNaN(a)||0>a||a>2;)a=prompt("How many players? (0-2)",1);return a}function addPlayers(a,b){2>a&&(a=2),a>4&&(a=4),b>4&&(b=4);for(var c=canvas.width/3,d=canvas.height/3,e=0;a>e;e++){if(b>=e+1)var f=new PixelShip(0,0,"");else var f=new AI(0,0,"");f.playerIndex=~~e,0==e&&(f.x=c,f.y=d,f.setColour(255,0,204,255)),1==e&&(f.x=2*c,f.y=d,f.setColour(204,255,0,255)),2==e&&(f.x=c,f.y=2*d,f.setColour(0,204,255,255)),3==e&&(f.x=2*c,f.y=2*d,f.setColour(204,0,255,255));var g=physicalObjects.push(f);playerObjects.push(f),players.push(g)}}BaseClass.prototype.construct=function(){},BaseClass.__asMethod__=function(a,b){return function(){var c=this["super"];this["super"]=b;var d=a.apply(this,arguments);return this["super"]=c,d}},BaseClass.extend=function(a){var b=function(){arguments[0]!==BaseClass&&this.construct.apply(this,arguments)},c=new this(BaseClass),d=this.prototype;for(var e in a){var f=a[e];f instanceof Function&&(f=BaseClass.__asMethod__(f,d)),c[e]=f}return c["super"]=d,b.prototype=c,b.extend=this.extend,b};var PhysicalObject=BaseClass.extend({construct:function(a,b,c,d,e){this.x=a,this.y=b,this.width=c,this.height=d,this.xVel=0,this.yVel=0,this.rotation=0,this.mass=1,this.maxSpeed=10,this.state="",this.alive=!0,this.type="",this.playerIndex=null,this.colour={red:255,green:255,blue:255,opacity:255},"red"==e&&(this.colour.red=255),"yellow"==e&&this.setColour(255,255,0,255),"green"==e&&(this.colour.green=255),"blue"==e&&(this.colour.blue=255)},getColour:function(){return"rgba("+this.colour.red+","+this.colour.green+","+this.colour.blue+","+this.colour.opacity+")"},setColour:function(a,b,c,d){this.colour.red=a,this.colour.green=b,this.colour.blue=c,this.colour.opacity=d},setXVel:function(a){this.xVel+=a},setYVel:function(a){this.yVel+=a},speed:function(){return Math.abs(this.xVel)+Math.abs(this.yVel)},angleTo:function(a,b){return 180*Math.atan2(this.y-b,this.x-a)/Math.PI},distanceTo:function(a){return Math.abs(a.x-this.x)+Math.abs(a.y-this.y)},closestShip:function(){for(var a=0,b=9999999,c=0;c<playerObjects.length;c++)this.distanceTo(playerObjects[c])<b&&playerObjects[c].playerIndex!==this.playerIndex&&playerObjects[c].alive&&(a=c,b=this.distanceTo(playerObjects[c]));return playerObjects[a]},pixelCount:function(){return this.width*this.height},shot:function(a){return!1},offscreen:function(){},processStep:function(){Math.abs(this.xVel)+Math.abs(this.yVel)>this.maxSpeed&&(this.xVel=this.maxSpeed*this.xVel/(Math.abs(this.xVel)+Math.abs(this.yVel)),this.yVel=this.maxSpeed*this.yVel/(Math.abs(this.xVel)+Math.abs(this.yVel))),this.x+=this.xVel,this.y+=this.yVel},destroy:function(){var a=objectPools[this.type],b=physicalObjects.indexOf(this);a.push(physicalObjects.splice(b,1)[0])}}),Particle=PhysicalObject.extend({construct:function(a,b,c,d,e){this["super"].construct.call(this,a,b,c,d,e),this.lifeTime=300,this.type="particle"},setKillTime:function(){this.killTime=new Date((new Date).getTime()+this.lifeTime)},processStep:function(){var a=this.killTime-new Date;this.colour.opacity=255*(a/this.lifeTime),0>a?this.destroy():this["super"].processStep.call(this)}}),HomingParticle=PhysicalObject.extend({construct:function(a,b,c,d,e){this["super"].construct.call(this,a,b,c,d,e),this.xDest=0,this.yDest=0,this.accuracy=10,this.power=3,this.maxSpeed=8,this.type="homingparticle"},setDestinationObject:function(a){this.destinationObject=a},offscreen:function(){return this.destroy(),!0},processStep:function(){if(this.x>physicalObjects[this.destinationObject].x-this.accuracy&&this.x<physicalObjects[this.destinationObject].x+this.accuracy&&this.y>physicalObjects[this.destinationObject].y-this.accuracy&&this.y<physicalObjects[this.destinationObject].y+this.accuracy)this.destroy();else{var a=this.angleTo(physicalObjects[this.destinationObject].x,physicalObjects[this.destinationObject].y);this.yVel+=-Math.sin(a*Math.PI/180)*this.power,this.xVel+=-Math.cos(a*Math.PI/180)*this.power,this["super"].processStep.call(this)}}}),Bullet=PhysicalObject.extend({construct:function(a,b,c,d,e){this["super"].construct.call(this,a,b,c,d,e),this.lifeTime=400,this.maxSpeed=1e3,this.homingPower=.1,this.type="bullet"},setKillTime:function(){this.killTime=new Date((new Date).getTime()+this.lifeTime)},processStep:function(){for(var a=0;a<physicalObjects.length;a++)this.x<physicalObjects[a].x+physicalObjects[a].width&&this.x+this.width>physicalObjects[a].x&&this.y<physicalObjects[a].y+physicalObjects[a].height&&this.height+this.y>physicalObjects[a].y&&"pixelShip"==physicalObjects[a].type&&this.playerIndex!==physicalObjects[a].playerIndex&&(this.destroy(),physicalObjects[a].shot(this.playerIndex));var b=this.closestShip(),c=this.angleTo(b.x,b.y);this.yVel+=-Math.sin(c*Math.PI/180)*this.homingPower,this.xVel+=-Math.cos(c*Math.PI/180)*this.homingPower;var d=this.killTime-new Date;0>d?this.destroy():this["super"].processStep.call(this)}}),PixelShip=PhysicalObject.extend({construct:function(a,b,c){this["super"].construct.call(this,a,b,10,10,c),this.type="pixelShip",this.drag=.01,this.smoothingValue=40,this.sightX=0,this.sightY=0,this.xVelSmoother=[],this.yVelSmoother=[];for(var d=0;d<this.smoothingValue;d++)this.xVelSmoother.push(0),this.yVelSmoother.push(0)},getSmootherValue:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b/a.length},setXVel:function(a){this.xVel+=a},setYVel:function(a){this.yVel+=a},sight:function(){var a=this.angleTo(this.x+this.sightX,this.y+this.sightY)+270;return[this.x+4*Math.sin(a*Math.PI/180)*(objectPools.bullet[0].lifeTime/1e3*60),this.y+4*-Math.cos(a*Math.PI/180)*(objectPools.bullet[0].lifeTime/1e3*60)]},shoot:function(){if(this.alive){for(var a=this.angleTo(this.x+this.sightX,this.y+this.sightY)+270,b=null;null===b||"bullet"!==b.type;)b=objectPools.bullet.pop();b.width=this.width/4,b.height=this.height/4,b.width=b.width<4?4:b.width,b.height=b.height<4?4:b.height,b.x=this.x+this.width/2-b.width/2,b.y=this.y+this.height/2-b.height/2,b.xVel=10*Math.sin(a*Math.PI/180)+(Math.random()-.5)+this.xVel,b.yVel=10*-Math.cos(a*Math.PI/180)+(Math.random()-.5)+this.yVel,b.colour=this.colour,b.playerIndex=this.playerIndex,b.setKillTime(),physicalObjects.push(b)}},shot:function(a){this.alive&&(this.width>2?this.shedLayer(~~a):(this.width=0,this.height=0,this.alive=!1,playerKilled(~~this.playerIndex)))},shedLayer:function(a){this.width-=2,this.height-=2,physicalObjects[~~a].width+=2,physicalObjects[~~a].height+=2;for(var b=2*this.width+2*this.height-4,c=0;b>c;c++){var d=360/b*c,e=objectPools.homingparticle.pop();e.x=this.x,e.y=this.y,e.xVel=10*Math.sin(d*Math.PI/180)+Math.random(),e.yVel=10*-Math.cos(d*Math.PI/180)+Math.random(),e.colour=this.colour,e.setDestinationObject(~~a),physicalObjects.push(e)}},processStep:function(){if(this.alive){this.pixelCount();0!==this.speed()&&(this.xVel*=1-this.drag,this.yVel*=1-this.drag),Math.abs(this.xVel)+Math.abs(this.yVel)>this.maxSpeed&&(this.xVel=this.maxSpeed*this.xVel/(Math.abs(this.xVel)+Math.abs(this.yVel)),this.yVel=this.maxSpeed*this.yVel/(Math.abs(this.xVel)+Math.abs(this.yVel))),this.sightX=this.xVel,this.xVelSmoother.unshift(this.xVel),this.xVelSmoother.pop();var a=this.getSmootherValue(this.xVelSmoother);this.sightY=this.yVel,this.yVelSmoother.unshift(this.yVel),this.yVelSmoother.pop();var b=this.getSmootherValue(this.yVelSmoother);this.x+=a,this.y+=b}}}),AI=PixelShip.extend({construct:function(a,b,c){this["super"].construct.call(this,a,b,10,10,c),this.minSpeed=2,this.maxSpeed=6,this.difficulty=.4},velocityBurst:function(a){a=a||1,this.setXVel((Math.random()-.5)*a),this.setYVel((Math.random()-.5)*a)},confrontShip:function(a){var b=this.angleTo(a.x,a.y),c=this.distanceTo(a);200>c&&this.velocityBurst(10),this.setYVel(-Math.sin(b*Math.PI/180)*this.difficulty*Math.random()),this.setXVel(-Math.cos(b*Math.PI/180)*this.difficulty*Math.random())},shipInRange:function(a){var b=this.angleTo(a.x,a.y),c=this.angleTo(this.x+this.sightX,this.y+this.sightY);return Math.abs(b-c)<30?!0:void 0},processStep:function(){var a=this.closestShip();this.confrontShip(a),this.shipInRange(a)&&winner===!1&&this.shoot(),this["super"].processStep.call(this)}});!function(){function a(){for(var c in b)for(var d in ArrowKeyHandler.keyMap)for(var e in ArrowKeyHandler.keyMap[d])c==ArrowKeyHandler.keyMap[d][e]&&("shoot"!=e||ArrowKeyHandler.sprayShoot)&&ArrowKeyHandler.callback(d,e);setTimeout(a,20)}ArrowKeyHandler={},ArrowKeyHandler.loopInterval=20,ArrowKeyHandler.callback=function(a,b){},ArrowKeyHandler.sprayShoot=!0,ArrowKeyHandler.keyMap={0:{left:37,up:38,right:39,down:40,shoot:32},1:{left:65,up:87,right:68,down:83,shoot:90},2:{left:74,up:73,right:76,down:75,shoot:77},3:{left:100,up:104,right:102,down:101,shoot:98}};var b={};document.onkeydown=function(a){b[a.which]=!0,a.preventDefault(),a.which!=ArrowKeyHandler.keyMap[0].shoot||ArrowKeyHandler.sprayShoot||ArrowKeyHandler.callback(0,"shoot"),a.which!=ArrowKeyHandler.keyMap[1].shoot||ArrowKeyHandler.sprayShoot||ArrowKeyHandler.callback(1,"shoot"),a.which!=ArrowKeyHandler.keyMap[2].shoot||ArrowKeyHandler.sprayShoot||ArrowKeyHandler.callback(2,"shoot"),a.which!=ArrowKeyHandler.keyMap[3].shoot||ArrowKeyHandler.sprayShoot||ArrowKeyHandler.callback(3,"shoot")},document.onkeyup=function(a){delete b[a.which],a.preventDefault()},ArrowKeyHandler.reset=function(){b={}},a()}();var win=window,d=document,e=d.documentElement,g=d.getElementsByTagName("body")[0],width=win.innerWidth||e.clientWidth||g.clientWidth,height=win.innerHeight||e.clientHeight||g.clientHeight,objectPools=[];objectPools.pixelShip=[],objectPools.particle=[];for(var i=0;1e4>i;i++){var particle=new Particle(1,1,1,1,"");objectPools.particle.push(particle)}objectPools.homingparticle=[];for(var i=0;1e4>i;i++){var homingparticle=new HomingParticle(1,1,1,1,"");objectPools.homingparticle.push(homingparticle)}objectPools.bullet=[];for(var i=0;1e4>i;i++){var bullet=new Bullet(1,1,1,1,"");objectPools.bullet.push(bullet)}var physicalObjects=[],playerObjects=[],players=[],winner=!1;window.onload=function(){var a=document.createElement("canvas");a.id="canvas",document.body.appendChild(a);var b=a.getContext("2d");a.width=width,a.height=height,render=function(){b.clearRect(0,0,width,height);for(var c=0;c<physicalObjects.length;c++)if(!(physicalObjects[c].x-physicalObjects[c].width/2>a.width&&(physicalObjects[c].x=-physicalObjects[c].width/2,physicalObjects[c].offscreen()))&&!(physicalObjects[c].x+physicalObjects[c].width/2<0&&(physicalObjects[c].x=a.width+physicalObjects[c].width/2,physicalObjects[c].offscreen()))&&!(physicalObjects[c].y-physicalObjects[c].height/2>a.height&&(physicalObjects[c].y=-physicalObjects[c].height/2,physicalObjects[c].offscreen()))&&!(physicalObjects[c].y+physicalObjects[c].height/2<0&&(physicalObjects[c].y=a.height+physicalObjects[c].height/2,physicalObjects[c].offscreen()))&&physicalObjects[c].alive){if(("pixelShip"==physicalObjects[c].type||"homingparticle"==physicalObjects[c].type)&&(b.fillStyle="rgba(255,255,255,50)",b.fillRect(physicalObjects[c].x-3,physicalObjects[c].y-3,physicalObjects[c].width+6,physicalObjects[c].height+6),b.fillStyle="rgba(255,255,255,50)",b.fillRect(physicalObjects[c].x-2,physicalObjects[c].y-2,physicalObjects[c].width+4,physicalObjects[c].height+4),b.fillStyle="rgba(255,255,255,50)",b.fillRect(physicalObjects[c].x-1,physicalObjects[c].y-1,physicalObjects[c].width+2,physicalObjects[c].height+2)),b.fillStyle=physicalObjects[c].getColour(),b.fillRect(physicalObjects[c].x,physicalObjects[c].y,physicalObjects[c].width,physicalObjects[c].height),"pixelShip"==physicalObjects[c].type){var d=physicalObjects[c].sight()[0],e=physicalObjects[c].sight()[1];b.beginPath(),b.strokeStyle=physicalObjects[c].getColour(),b.moveTo(d-20,e),b.lineTo(d+20,e),b.stroke(),b.beginPath(),b.strokeStyle=physicalObjects[c].getColour(),b.moveTo(d,e-20),b.lineTo(d,e+20),b.stroke()}physicalObjects[c].processStep()}},loopRender=function(){requestAnimationFrame(loopRender),render()},ArrowKeyHandler.callback=function(a,b){if("0"===a&&"shoot"===b){document.getElementById("desktop-intro").style.display="none";var c=getPlayerCount(),d=getHumanCount();addPlayers(c,d),ArrowKeyHandler.callback=function(a,b){"shoot"==b&&physicalObjects[a].shoot(),"up"==b&&physicalObjects[a].setYVel(-.3),"down"==b&&physicalObjects[a].setYVel(.3),"left"==b&&physicalObjects[a].setXVel(-.3),"right"==b&&physicalObjects[a].setXVel(.3)},render(),countdown=4,startInterval=setInterval(function(){countdown>1?(countdown--,document.getElementById("countdown").innerHTML=countdown):(clearInterval(startInterval),ArrowKeyHandler.reset(),document.getElementById("countdown").innerHTML="",loopRender())},1e3)}}};