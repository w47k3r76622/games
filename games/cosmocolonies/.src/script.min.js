let theSeed=10;function array2d(t,e){for(var i=new Array(t),l=0;l<t;l++)i[l]=new Array(e);return i}function clamp(t,e,i){return t<e?e:t>i?i:t}function rint(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}let noise=function(){let t={};function e(t,e,i){this.x=t,this.y=e,this.z=i}e.prototype.dot2=function(t,e){return this.x*t+this.y*e},g3=[new e(1,1,0),new e(-1,1,0),new e(1,-1,0),new e(-1,-1,0),new e(1,0,1),new e(-1,0,1),new e(1,0,-1),new e(-1,0,-1),new e(0,1,1),new e(0,-1,1),new e(0,1,-1),new e(0,-1,-1)];let l=[];for(;l.length<300;)l.push((rint(0,255)+rint(0,255))/2);function s(t){return t*t*t*(t*(6*t-15)+10)}function o(t,e,i){return(1-i)*t+i*e}return l=[...new Set(l)],perm=new Array(512),gP=new Array(512),t.seed=function(t){for(t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8),i=0;i<256;i++)v=0,1&i?v=l[i]^255&t:v=l[i]^t>>8&255,perm[i]=perm[i+256]=v,gP[i]=gP[i+256]=g3[v%12]},t.seed(0),t.perlin2=function(t,e){return X=Math.floor(t),Y=Math.floor(e),t-=X,e-=Y,X&=255,Y&=255,n00=gP[X+perm[Y]].dot2(t,e),n01=gP[X+perm[Y+1]].dot2(t,e-1),n10=gP[X+1+perm[Y]].dot2(t-1,e),n11=gP[X+1+perm[Y+1]].dot2(t-1,e-1),u=s(t),o(o(n00,n10,u),o(n01,n11,u),s(e))},t}();class Button{constructor(t,e,i,l,s,o){this.x=t,this.y=e,this.w=i,this.h=l,this.img=s,this.args=null==o?{}:o,this.args.data={},this.isHoveringOver=!1,this.tooltip=null}update(t,e){t.x>this.x&&t.x<this.x+this.w&&t.y>this.y&&t.y<this.y+this.h?(this.isHoveringOver||(this.args.hoverCallback&&this.args.hoverCallback(),this.isHoveringOver=!0),this.args.clickCallback&&e&&this.args.clickCallback()):this.isHoveringOver=!1}render(t,e){this.args.showbgRec&&(t.save(),t.fillStyle=this.args.bgRecColor,t.fillRect(this.x-this.args.bgRecExtraSize,this.y-this.args.bgRecExtraSize,this.w+2*this.args.bgRecExtraSize,this.h+2*this.args.bgRecExtraSize),t.restore()),this.isHoveringOver&&this.args.showhovRec&&(t.save(),t.fillStyle=this.args.hovRecColor,t.fillRect(this.x-this.args.hovRecExtraSize,this.y-this.args.hovRecExtraSize,this.w+2*this.args.hovRecExtraSize,this.h+2*this.args.hovRecExtraSize),t.restore()),t.drawImage(this.img,this.x,this.y,this.w,this.h),null!==this.tooltip&&this.tooltip.render(t,e)}}class TextButton{constructor(t,e,i,l,s,o){this.x=t,this.y=e,this.w=i,this.h=l,this.text=s,this.args=o,this.bgColor="#fff"}update(t,e){t.x>this.x&&t.x<this.x+this.w&&t.y>this.y&&t.y<this.y+this.h?(this.isHoveringOver=!0,this.args.hovBgColor&&(this.bgColor=this.args.hovBgColor),this.args.clickCallback&&e&&this.args.clickCallback()):(this.isHoveringOver=!1,this.bgColor=this.args.bgColor)}render(t){t.save(),t.fillStyle=this.bgColor,t.fillRect(this.x,this.y,this.w,this.h),t.fillStyle="#fff",t.font=this.args.fontSize+"px monospace",t.textAlign="center",t.fillText(this.text,this.x+this.w/2,this.y+1.05*this.args.fontSize),t.restore()}}class BuildingSelectionTooltip{constructor(t,e,i){this.x=t,this.y=e,this.w=256,this.h=128,this.buildingType=i,this.canDestroy=!1}render(t,e){let i=[];this.buildingType.cost&&i.push({icon:e.i_cost.el,value:this.buildingType.cost}),this.buildingType.opCostWk&&i.push({icon:e.i_op_cost.el,value:this.buildingType.opCostWk+"/wk"}),this.buildingType.eDemand&&i.push({icon:e.i_power.el,value:"-"+this.buildingType.eDemand}),this.buildingType.eOutput&&i.push({icon:e.i_power.el,value:this.buildingType.eOutput}),this.buildingType.o2Output&&i.push({icon:e.i_o2.el,value:this.buildingType.o2Output}),this.buildingType.h2oOutput&&i.push({icon:e.i_h2o.el,value:this.buildingType.h2oOutput}),this.h=64+48*i.length,t.save(),t.fillStyle="#0000ff",t.fillRect(this.x,this.y,this.w,this.h),t.fillStyle="#fff",t.fillText(this.buildingType.name,this.x+32,this.y+32);for(let e=0;e<i.length;e++){let l=i[e];t.drawImage(l.icon,this.x+22,this.y+44+48*e,24,24),t.fillText(l.value,this.x+52,this.y+64+48*e)}t.restore()}}class Explosion{constructor(t,e,i,l,s){this.x=t,this.y=e,this.w=i,this.h=l,this.img=s,this.destroyDelay=10,this.destroyTick=0,this.canDestroy=!1}update(){this.destroyTick<this.destroyDelay?this.destroyTick++:this.canDestroy=!0}render(t){t.drawImage(this.img,this.x,this.y,this.w,this.h)}}class Lander{constructor(t,e,i,l,s,o){this.x=t,this.y=e,this.w=i,this.h=l,this.img=s,this.args=o,this.state=0,this.vel={x:0,y:0},this.canDestroy=!1}update(){switch(this.state){case 0:0==this.args.orientation?this.x<this.args.target.x?this.vel.x=this.args.speed:this.x>this.args.target.x?this.vel.x=-this.args.speed:(this.state=1,this.vel.x=0,this.vel.x=0):this.y<this.args.ascendDecentHeight?this.vel.y=this.args.speed:this.y>this.args.ascendDecentHeight?this.vel.y=-this.args.speed:(this.state=1,this.vel.x=0,this.vel.y=0);break;case 1:this.y<this.args.landedY?this.vel.y=.5:(this.state=2,this.vel.x=0,this.vel.y=0);break;case 3:this.y>this.args.ascendDecentHeight?this.vel.y=-.5:(this.vel.y=0,rint(0,10)>5?this.vel.x=rint(0,10)>5?-this.args.speed:this.args.speed:this.vel.y=rint(0,10)>5?-this.args.speed:this.args.speed,this.state=4)}this.x+=this.vel.x,this.y+=this.vel.y}render(t){t.drawImage(this.img,this.x,this.y,this.w,this.h)}}window.addEventListener("DOMContentLoaded",()=>{let t=["btn_ore_insights","btn_buildings","btn_buildings_left","btn_buildings_right","i_power","i_ore","i_o2","i_h2o","i_cost","i_op_cost","t_rocket","t_dynamite","t_headquarters","t_tube","t_solar","t_oxygen_gen","t_water_tower","t_habitat","t_ore_sensor","t_mine","t_satdish","t_landing_pad","t_moon","o_explosion","o_lander","o_flare","o_title_lander"];for(let e=0;e<t.length;e++){let i=t[e],l=new Image;l.src="images/"+i+".png",t[i]={key:i,el:l}}let e=document.createElement("canvas");e.width=960,e.height=640;let i=e.getContext("2d");i.imageSmoothingEnabled=!1,document.body.appendChild(e);let l=0,s=!1,o=!1,h={x:0,y:0},n=null,a=-64,r=0,c=16,g=16,d={x:0,y:0},y={x:0,y:0},u=[];function p(){i.save(),i.fillStyle="#fff";for(let t=0;t<u.length;t++){let e=u[t];i.fillRect(e.x,e.y,e.size,e.size)}i.restore()}let f=0,x=array2d(Math.floor(e.width/c),Math.floor(e.height/g)),w=[],b=array2d(Math.floor(e.width/c),Math.floor(e.height/g)),m=[],_=[],k=1e3,v=0,C=[],T=[],S=[],O=rint(0,2e3),D=rint(0,2e3),R=x.length,M=x[0].length,E=Math.floor(R/2),I=Math.floor(M/2),P=1500,B=rint(2,3),z=0,W=0,Y=0,H=0,A=0,X=0,q=0,L=0,N=0,j=0,U=1,F=0,G=!1,J=0,K=!1,Q=!1,V={moon:{key:"t_moon",isSelectable:!1,cost:0},rocket:{key:"t_rocket",isSelectable:!1,cost:0,colonistCapacity:4,eOutput:5,o2Output:20,h2oOutput:10},dynamite:{name:"Dynamite",key:"t_dynamite",cost:50,freePlace:!0,canOverrideTile:!0},headquarters:{name:"Headquarters",key:"t_headquarters",cost:1e3,opCostWk:10,colonistCapacity:10,eDemand:50,eOutput:50,h2oOutput:50,o2Output:30},tube:{name:"Transport Tube",key:"t_tube",cost:10,opCostWk:2,eDemand:2,freePlace:!0},solar:{name:"Solar Panel",key:"t_solar",cost:50,opCostWk:5,eOutput:100},oxygen_gen:{name:"Oxygen Generator",key:"t_oxygen_gen",cost:550,opCostWk:100,o2Output:500},water_tower:{name:"Water Tower",key:"t_water_tower",cost:550,opCostWk:75,h2oOutput:500},habitat:{name:"Habitat",key:"t_habitat",cost:350,opCostWk:30,colonistCapacity:50,eDemand:50,h2oOutput:100,o2Output:100,timeTriggerWeekly:t=>{P+=50}},ore_sensor:{name:"Ore Sensor",key:"t_ore_sensor",cost:350,opCostWk:15,eDemand:10,freePlace:!0},mine:{name:"Mine",key:"t_mine",cost:1e3,opCostWk:150,eDemand:50,timeTriggerWeekly:t=>{let e=[];for(let i=t.x-3;i<t.x+4;i++)for(let l=t.y-3;l<t.y+4;l++){Math.pow(i-t.x,2)+Math.pow(l-t.y,2)<=Math.pow(3,2)&&b[i][l]&&e.push(b[i][l])}e.forEach(t=>{t.value>0&&(H+=rint(1,2),t.value-.001>0?t.value-=.001:t.value=0,P+=rint(1,2))})}},satdish:{name:"Satellite Dish",key:"t_satdish",cost:350,eDemand:20},landing_pad:{name:"Landing Pad",key:"t_landing_pad",cost:500,eDemand:20}},Z=null,$=null,tt=[],et=null,it=null,lt=0,st="",ot=!1;function ht(t,e){for(let i=0;i<t.length;i++)for(let l=0;l<t[0].length;l++){let s=t[i][l];s&&e(i,l,s)}}function nt(i){let l=Object.keys(V);for(let t=0;t<l.length;t++){let e=V[l[t]];null==e.isSelectable||e.isSelectable||l.splice(t,1)}let s=0;l.forEach((l,o)=>{if(o-1>=i&&o<=i+10){let i=V[l];(null==i.isSelectable||i.isSelectable)&&(btnBuilding=new Button(180+72*s,e.height-72,48,48,t[i.key].el,{clickCallback:()=>{st=l,Q=!1},hoverCallback:()=>{btnBuilding.tooltip=new BuildingSelectionTooltip(8192,8192,i)},showhovRec:!0,hovRecColor:"#7575ff",hovRecExtraSize:8,showbgRec:!0,bgRecColor:"#d1190d",bgRecExtraSize:8,buildingType:i}),tt.push(btnBuilding),s++)}})}function at(t,e){let i=null==e.clientX?e.changedTouches[0].clientX:e.clientX,l=null==e.clientY?e.changedTouches[0].clientY:e.clientY;var s=t.getBoundingClientRect();return{x:Math.round((i-s.left)/(s.right-s.left)*t.width),y:Math.round((l-s.top)/(s.bottom-s.top)*t.height)}}!function(){for(let t=0;t<100;t++)u.push({x:rint(0,e.width),y:rint(0,e.height),size:rint(1,2)})}(),function i(s){switch(l=s){case 0:n=new TextButton(e.width/2-128,380,256,64,"PLAY",{bgColor:"#4d3d87",hovBgColor:"#7c6fab",fontSize:48,clickCallback:()=>{i(1)}});break;case 1:!function(){let t=rint(10,20);for(let e=E-t;e<E+t;e++)for(let i=I-t;i<I+t;i++){let l=Math.pow(e-E,2)+Math.pow(i-I,2);noise.seed(O);let s=noise.perlin2(e/rint(24,26),i/rint(24,25));noise.seed(D);let o=noise.perlin2(e/10,i/10);o=clamp(o,.01,1),l<=Math.pow(t,2)+100*s&&s>.001&&(x[e][i]={id:f,x:e,y:i,type:V.moon},f++,b[e][i]={id:f,x:e,y:i,value:o},s>.05&&w.push({x:e,y:i}))}let e=w[rint(0,w.length-1)];x[e.x][e.y].type=V.rocket}(),Z=new Button(0,e.height-192,96,96,t.btn_ore_insights.el,{clickCallback:()=>{K=!K}}),$=new Button(0,e.height-96,96,96,t.btn_buildings.el,{clickCallback:()=>{ot=!0,Q=!Q}}),et=new Button(106,e.height-96,50,96,t.btn_buildings_left.el,{clickCallback:()=>{lt>0&&(lt--,tt.length=0,nt(lt))}}),it=new Button(e.width-50-10,e.height-96,50,96,t.btn_buildings_right.el,{clickCallback:()=>{lt<Object.keys(V).length-10-2&&(lt++,tt.length=0,nt(lt))}}),nt(0)}}(0),setInterval(u=>{switch(i.clearRect(0,0,e.width,e.height),hasClicked=!(s||!o),l){case 0:i.save(),i.fillStyle="#060214",i.fillRect(0,0,e.width,e.height),i.restore(),p();for(let l=-10;l<e.width/64+10;l++)for(let s=0;s<10;s++)i.drawImage(t.t_moon.el,64*l,e.height-320+s*(.05*s)*64,64,64);0==r?a>180?a-=2:r=1:a<220?a+=2:r=0,i.drawImage(t.o_title_lander.el,e.width/2-32,a,64,64),n.update(h,hasClicked),n.render(i),i.save(),i.fillStyle="#fff",i.textAlign="center",i.font="bold 64px monospace",i.fillText("COSMOCOLONIES",e.width/2,96),i.font="24px monospace",i.fillText("© 2020 JARED YORK",e.width/2,138),i.restore();break;case 1:if(z=0,W=0,Y=0,X=0,N=0,C.length=0,T.length=0,S.length=0,ht(x,(e,i,l)=>{"t_landing_pad"==l.type.key?C.push(l):"t_ore_sensor"==l.type.key?T.push(l):"t_satdish"==l.type.key?S.push(l):"t_dynamite"==l.type.key&&(x[e][i].type=V.moon,m.push(new Explosion(e*c,i*g,c,g,t.o_explosion.el))),l.type.eOutput&&(W+=l.type.eOutput),l.type.eDemand&&(z+=l.type.eDemand),l.type.o2Output&&(X+=l.type.o2Output),l.type.h2oOutput&&(N+=l.type.h2oOutput)}),Y=W-z,h2oOutput=0,A=0,q=X-(A=5*B),j=N-(L=2*B),C.length>0)if(_.forEach(t=>{if(2==t.state)if(t.args.landedDuration<t.args.landedMaxDuration)t.args.landedDuration++;else{switch(t.args.visitType){case 1:{let t=rint(1,3),e=rint(100,500);H-e>0&&(P+=e*t,H-=e);break}case 2:B+=rint(3,5);break;case 3:{let t=rint(3,5);B-t>5&&(B-=t);break}}t.state=3,t.targetPadId=null}}),k=S.length>0?150:1e3,v<k)v++;else{let i=C[rint(0,C.length-1)],l=!0;if(_.forEach(t=>{t.args.targetPadId==i.id&&(l=!1)}),l){let l=0,s=0,o=0,h=(rint(0,10),1);0==h?(l=rint(0,10)>=5?-c:e.width+c,o=s=i.y*g,s-=g/2):(l=i.x*c,s=rint(0,10)>=5?-g:e.height+g,o=i.y*c);let n=rint(0,3);_.push(new Lander(l,s,c,g,t.o_lander.el,{targetPadId:i.id,target:{x:i.x*c,y:i.y*g},visitType:n,ascendDecentHeight:i.y*g-g/2,landedY:o,orientation:h,speed:1,landedMaxDuration:rint(10,300),landedDuration:0}))}v=0}for(let t=0;t<_.length;t++){let i=_[t];i.update(),(i.x<-i.w||i.x>e.width+i.w||i.y<-i.h||i.y>e.height+i.h)&&(i.canDestroy=!0),i.canDestroy&&_.splice(t,1)}if(F<10)F++;else{if(++U%7==0&&(ht(x,(t,e,i)=>{i.type.opCostWk&&(P-=i.type.opCostWk),i.type.timeTriggerWeekly&&i.type.timeTriggerWeekly(i)}),0),ht(x,(t,e,i)=>{i.timeTriggerDaily&&i.timeTriggerDaily(i)}),Y>0&&q>0&&j>0){let t=0;ht(x,(e,i,l)=>{l.type.colonistCapacity&&(t+=l.type.colonistCapacity)});let e=rint(0,Math.ceil(.05*B));B+e<t&&rint(0,100)>95&&(B+=e)}else{let t=rint(0,Math.ceil(.1*B));B>0&&(B-=t)}F=0}d.x=Math.floor(h.x/c)*c,d.y=Math.floor(h.y/g)*g,y.x=clamp(d.x/c,0,R-1),y.y=clamp(d.y/g,0,M-1),Z&&Z.update(h,hasClicked),$&&$.update(h,hasClicked),Q&&(et.update(h,hasClicked),it.update(h,hasClicked),tt.forEach(function(t){t.update(h,hasClicked)})),p(),ht(x,(e,l,s)=>{i.drawImage(t[s.type.key].el,e*c,l*g,c,g)});for(let t=0;t<m.length;t++)m[t].update(),m[t].render(i),m[t].canDestroy&&m.splice(t,1);if(J>0&&(J-=.1),K){let t=[];for(let e=0;e<T.length;e++){let l=T[e],s=2;for(let e=l.x-s;e<l.x+(s+1);e++)for(let o=l.y-s;o<l.y+(s+1);o++){if(Math.pow(e-l.x,2)+Math.pow(o-l.y,2)<=Math.pow(s,2)&&b[e][o]){t.push({x:l.x,y:l.y});let s=1/b[e][o].value*10;i.save(),i.fillStyle="rgba("+(90+s)+","+(40+s)+","+s+",255)",i.globalAlpha=.75,i.fillRect(e*c,o*g,c,g),i.restore()}}}}if(st.length>0){i.save();let t=x[y.x][y.y],e=!1;if(t){let i=!1;if(V[st].freePlace)i=!0;else{let e=[];x[t.x][t.y-1]&&e.push(x[t.x][t.y-1]),x[t.x+1][t.y]&&e.push(x[t.x+1][t.y]),x[t.x][t.y+1]&&e.push(x[t.x][t.y+1]),x[t.x-1][t.y]&&e.push(x[t.x-1][t.y]),e.forEach(t=>{t&&"t_moon"!=t.type.key&&(i=!0)})}("t_moon"==t.type.key||V[st].canOverrideTile)&&i&&(e=!0),P<V[st].cost&&(e=!1),G||"t_headquarters"==V[st].key||(e=!1),"dynamite"==st&&"t_headquarters"==t.type.key&&(e=!1)}t&&e?(i.fillStyle="#34f000",o&&(x[y.x][y.y].type=V[st],P-=V[st].cost,"headquarters"==st&&(G=!0))):i.fillStyle="#ff0000",i.globalAlpha=.5,i.fillRect(d.x,d.y,c,g),i.restore()}_.forEach(t=>{t.render(i)}),Z&&Z.render(i),$&&$.render(i),i.save(),i.fillStyle=P>0?"#fff":"#ff0000",i.font="20px monospace",i.fillText("FUNDS: "+P,16,32),i.fillStyle=B>0?"#fff":"#ff0000",i.fillText("POPULATION: "+B,16,56),i.fillStyle="#fff",i.fillText("DAY: "+U,16,80),st.length>0?(i.drawImage(t[V[st].key].el,112,e.height-72,32,32),i.fillText("Building: "+V[st].name,112,e.height-16)):ot||i.fillText("<-- Click the build menu to select buildings",112,e.height-16),i.drawImage(t.i_power.el,e.width-180,16,24,24),i.fillStyle=Y>0?"#34f000":"#ff0000",i.fillText(Y,e.width-180+32,36),i.drawImage(t.i_o2.el,e.width-180,48,24,24),i.fillStyle=q>0?"#34f000":"#ff0000",i.fillText(q,e.width-180+32,68),i.drawImage(t.i_h2o.el,e.width-180,80,24,24),i.fillStyle=j>0?"#34f000":"#ff0000",i.fillText(j,e.width-180+32,100),i.drawImage(t.i_ore.el,e.width-180,112,24,24),i.fillStyle="#fff",i.fillText(H,e.width-180+32,132),Q&&(i.save(),i.fillStyle="#0000ff",i.fillRect(96,e.height-96,e.width-96,96),i.restore(),et.render(i),it.render(i),tt.forEach(function(l){P>=l.args.buildingType.cost?l.args.bgRecColor="#34f000":l.args.bgRecColor="#d1190d",G||"t_headquarters"==l.args.buildingType.key||(l.args.bgRecColor="#d1190d"),l.render(i,t),l.tooltip&&(l.tooltip.x=h.x,l.tooltip.y=h.y-l.tooltip.h,l.tooltip.x+l.tooltip.w>e.width&&(l.tooltip.x=e.width-l.tooltip.w),l.tooltip.y=e.height-96-l.tooltip.h)}))}s=o,0},33),onmousedown=function(t){h=at(e,t),s=o,o=!0},onmousemove=function(t){h=at(e,t)},onmouseup=function(t){h=at(e,t),o=!1}});