<html>
<head>
<meta name=viewport content="width=960">
<title>rec-rec</title>
</head>
<body style="width:960;margin-left:auto;margin-right:auto;background:black;color:#eee">
<canvas id=c width=960 height=540 style="background:linear-gradient(#00f,#f04)"></canvas>
<br><br>
Make a rap with loops!<br>
Tap anywhere on the canvas to <b>start</b>. The water surface shows the audio waveform, the bubbles show each track's spectrogram.<br>
Tap on any of the 4 <b>fish</b>, it will turn <span style="color:#fa0">orange</span> when selected. On the next loop, a white waveform will appear from the sound of the mic, and the fish will eat the sound. From the next loop, the fish will play back the sound.<br>
Tap the area above the water (at the top of the canvas) to <b>stop</b> at the end of the loop.
<br><br>
Microphone required for recording.<br>
Due to lack of support for the MediaRecorder API, <b>recording will not work on iOS/Safari/Edge</b>. It works on Android/Chrome/Firefox.
</body>
<script>
function fa(){function L(a){return Math.sin(6.283184*a)}var O=[L,function(a){return.5>a%1?1:-1},function(a){return a%1*2-1},function(a){a=a%1*4;return 2>a?a-1:3-a}],E,a,p,u,t;this.s=function(){var l={v:[{a:[0,255,116,1,0,255,116,0,1,0,4,6,35,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[1],f:[{n:[135,,135,,,,135,135,,,135,,,,135,,135,,135,,,,135,135,,,135,,,,135],h:[]}]},{a:[0,160,128,1,0,160,128,0,1,210,4,7,41,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[1],f:[{n:[,,,,135,,,,,,,,135,,,,,,,,135,,,,,,,,135],h:[]}]},
{a:[0,0,140,0,0,0,140,0,0,60,4,10,34,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],p:[1],f:[{n:[135,,135,,,,135,135,135,,135,,,,135,135,135,,135,,,,135,135,135,,135,,,,135],h:[]}]}],j:5513,i:32,m:0,u:3};E=l;a=l.m;p=0;u=l.j*l.i*(a+1)*2;t=new Int32Array(u)};this.o=function(){var l,e,q,d,z,B=new Int32Array(u),f=E.v[p],C=E.j,I=E.i,M=0,m=0,x;var b=!1;var F=[];for(e=0;e<=a;++e){var G=f.p[e];for(q=0;q<I;++q){if(z=G?f.f[G-1].h[q]:0)f.a[z-1]=f.f[G-1].h[q+I]||0,16>z&&(F=[]);var A=O[f.a[15]],P=f.a[16]/512,H=Math.pow(2,
f.a[17]-9)/C,Q=f.a[18],T=f.a[19],D=135.82764118168*f.a[20]/44100,ha=1-f.a[21]/255,h=1E-5*f.a[22],n=f.a[23]/32,k=f.a[24]/512,y=6.283184*Math.pow(2,f.a[25]-9)/C,Y=f.a[26]/255,V=f.a[27]*C&-2;z=(e*I+q)*C;for(d=0;4>d;++d)if(l=G?f.f[G-1].n[q+d*I]:0){if(!F[l]){var g=F;var J=l;var Z=x=void 0,r,v,w=f,aa=l,ia=O[w.a[0]],ja=w.a[1],ka=w.a[3],la=O[w.a[4]],ma=w.a[5],na=w.a[8],ba=w.a[9],N=w.a[10]*w.a[10]*4,U=w.a[11]*w.a[11]*4,W=w.a[12]*w.a[12]*4,oa=1/W,R=w.a[13],pa=C*Math.pow(2,2-w.a[14]),ca=new Int32Array(N+U+W),
da=0,ea=0;for(r=v=0;v<N+U+W;v++,r++){0<=r&&(R=R>>8|(R&255)<<4,r-=pa,Z=.003959503758*Math.pow(2,(aa+(R&15)+w.a[2]-128-128)/12),x=.003959503758*Math.pow(2,(aa+(R&15)+w.a[6]-128-128)/12)*(1+8E-4*w.a[7]));var K=1;v<N?K=v/N:v>=N+U&&(K-=(v-N-U)*oa);var S=Z;ka&&(S*=K*K);da+=S;var X=ia(da)*ja;S=x;na&&(S*=K*K);ea+=S;X+=la(ea)*ma;ba&&(X+=(2*Math.random()-1)*ba);ca[v]=80*X*K|0}g[J]=ca}J=F[l];l=0;for(g=2*z;l<J.length;l++,g+=2)B[g]+=J[l]}for(l=0;l<C;l++)d=2*(z+l),(g=B[d])||b?(b=D,Q&&(b*=A(H*d)*P+.5),b=1.5*Math.sin(b),
M+=b*m,g=ha*(g-m)-M,m+=b*g,g=3==T?m:1==T?g:M,h&&(g*=h,g=1>g?-1<g?L(.25*g):-1:1,g/=h),g*=n,b=1E-5<g*g,J=Math.sin(y*d)*k+.5,x=g*(1-J),g*=J):x=0,d>=V&&(x+=B[d-V+1]*Y,g+=B[d-V]*Y),B[d]=x|0,B[d+1]=g|0,t[d]+=x|0,t[d+1]+=g|0}}p++;return p/E.u};this.l=function(){var a=44+2*u-8,e=a-36,q=new Uint8Array(44+2*u);q.set([82,73,70,70,a&255,a>>8&255,a>>16&255,a>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,e&255,e>>8&255,e>>16&255,e>>24&255]);a=0;for(e=44;a<u;++a){var d=
t[a];d=-32767>d?-32767:32767<d?32767:d;q[e++]=d&255;q[e++]=d>>8&255}return q};this.getData=function(a,e){for(var l=2*Math.floor(44100*a),d=Array(e),z=0;z<2*e;z+=1){var u=l+z;d[z]=0<a&&u<t.length?t[u]/32768:0}return d}}
window.onload=function(){function L(){u=0;t=1;for(var a=0;5>a;++a)b[a].g?O(a):b[a].b.src&&(b[a].b.currentTime=m.currentTime-f+.1,b[a].b.play());p=0}function O(a){var D=m.createBufferSource();D.buffer=b[a].g;D.connect(b[a].c);D.start(0);a||(D.onended=function(){u?t=u=0:(f=m.currentTime,x&&e&&(l?(x.stop(),l=0,d.gain.setValueAtTime(1,m.currentTime),p=m.currentTime-f,b[e].of+=p):(d.gain.setValueAtTime(.1,m.currentTime),x.start(),l=1,b[e].of=p=m.currentTime-f)),L())})}function E(d){function D(b){b=Math.sin(2*
(x+b)*Math.PI);r=a.createRadialGradient(p+16,k-8*b,0,p+16,k-8*b,48);r.addColorStop(0,"rgba(191,255,255,0)");r.addColorStop(1,"rgba(191,255,255,1)");a.fillStyle=r;a.beginPath();a.moveTo(p,k);a.quadraticCurveTo(p+40,k-16-16*b,p+48,k-16*b);a.quadraticCurveTo(p+40,k+16-16*b,p,k);a.fill()}a.clearRect(0,0,c.width,c.height);a.lineWidth=1;for(var h=0;5>h;++h)if(!h||b[h].b.src){b[h].c.getByteFrequencyData(A);a.strokeStyle=u?"#000":F[h];a.beginPath();for(var n=A.length/2;0<=n;--n){var k=541-2*A[n];a.moveTo(15*
(n+1),k);a.lineTo(15*n,k)}a.stroke()}z.getByteTimeDomainData(G);a.fillStyle="#000";a.beginPath();a.moveTo(c.width,0);for(h=c.width;0<=h;--h)a.lineTo(h,G[h+32]/2);a.lineTo(0,0);a.fill();var y=((f-m.currentTime)/b[0].g.duration+1)*c.width;a.lineWidth=2;a.strokeStyle="#fff";a.beginPath();for(h=1;5>h;++h)if(k=P*(h-.5)+64,l&&h==e){b[5].c.getByteTimeDomainData(A);a.moveTo(y+64,k);var q=(y+64)/A.length;for(n=A.length-1;0<=n;--n)a.lineTo(q*n,k+(A[n]-128)/2)}else if(b[h].b.src)for(b[h].c.getByteTimeDomainData(A),
a.moveTo(y+64,k),n=A.length-1;0<=n;--n)a.lineTo(y-64+n,k+(A[n]-128)/4);a.stroke();var x=(m.currentTime-f)%(b[0].g.duration/4);n=Math.sin(2*x*Math.PI);q=80+4*n;var g=y-56,t=y-48,p=y+80;for(h=1;5>h;++h){k=P*(h-.5)+64;var r=a.createRadialGradient(y-32,k,0,y,k,80+4*n);r.addColorStop(0,"rgba(255,255,255,0)");r.addColorStop(1,h==e?F[5]:F[h]);a.fillStyle=r;a.beginPath();a.moveTo(y-64,k);a.lineTo(y-80,k-8);a.quadraticCurveTo(y,k-q,y+80,k);a.quadraticCurveTo(y,k+q,y-80,k+8);a.fill();var v=k-16-n;r=a.createRadialGradient(g,
v,0,g,v,16);r.addColorStop(0,"rgba(255,255,255,0)");r.addColorStop(1,"rgba(255,255,255,1)");a.fillStyle=r;a.beginPath();a.ellipse(g,v,8,12,0,0,2*Math.PI);a.fill();v=k-32-2*n;r=a.createRadialGradient(t+32,v-4*n,0,t+32,v-4*n,32);r.addColorStop(0,"rgba(255,255,191,0)");r.addColorStop(1,"rgba(255,255,191,1)");a.fillStyle=r;a.beginPath();a.moveTo(t,v);a.quadraticCurveTo(t+32,v-32-8*n,t+64,v-16-8*n);a.fill();D(0);D(1/3);D(2/3)}C++;984<d-I&&(M=C+"fps",I=d,C=0);a.fillStyle="#fff";a.fillText(M+(u?" stop":
""),1,12);requestAnimationFrame(E)}var a=c.getContext("2d");a.fillRect(0,0,c.width,64);a.font="12px sans-serif";var p,u,t,l,e,q,d,z,B,f,C=0,I=0,M="",m,x,b=[],F="#fff #f0f #ff0 #0ff #0f0 #fa0".split(" "),G=new Uint8Array(1024),A=new Uint8Array(128),P=(c.height-64)/4;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(a){B=a;x=new MediaRecorder(a);x.ondataavailable=function(a){b[e].b.src=URL.createObjectURL(a.data);p=m.currentTime-f;b[e].b.currentTime=.1+p+b[e].of;b[e].b.play();e=0}});for(var H=
0;6>H;++H)b[H]={},b[H].of=0,0<H&&(b[H].b=new Audio);var Q=new fa;Q.s();var T=setInterval(function(){(q=1<=Q.o())&&clearInterval(T)},0);c.onmousedown=function(a){if(m)(a=Math.ceil(((a.touches?a.touches[0].pageY:a.pageY)-c.offsetTop-64)/P))&&t?l||(e=e!=a?a:0):u?u=0:t?u=1:(f=m.currentTime,L());else if(B&&q){m=new (window.AudioContext||window.webkitAudioContext);z=m.createAnalyser();z.connect(m.destination);d=m.createGain();d.connect(z);for(a=0;6>a;++a)if(b[a].c=m.createAnalyser(),b[a].c.fftSize=2*A.length,
5>a&&b[a].c.connect(d),5==a){var p=m.createMediaStreamSource(B);p.connect(b[a].c)}else a&&(p=m.createMediaElementSource(b[a].b),p.connect(b[a].c));a=Q.l();m.decodeAudioData(a.buffer,function(a){b[0].g=a;f=m.currentTime;L();E(0)})}}};
</script>
</html>
