function is_done(t){var e=rotateCoords(t.components.tile.value[0],t.components.tile.value[1],map[0].length,global_view);return 0==build_time[e[0]][e[1]]}ECS.systems.updatebuild=function(t,e){var n=0,o=0,i=0,s=new PQueue;for(var a in t)if(entity=t[a],"build"==entity.components.type.value&&is_done(entity)){var l=entity.components.consumption.value;"on"===entity.components.status.value.top()&&(i+=l[2]*(l[2]>0)),s.insert(a,l[2]*(l[2]<0)),"off"!=entity.components.status.value.top()&&entity.components.status.value.pop()}power=i;for(var p=i;!s.isEmpty();){var u=s.pop();if(!(u[1]+p>=0))break;"off"!=t[u[0]].components.status.value.top()&&(t[u[0]].components.status.value.push("on"),p+=u[1])}for(var a in t)if(entity=t[a],"build"==entity.components.type.value&&"on"==entity.components.status.value.top()&&is_done(entity)){n-=(l=entity.components.consumption.value)[1],o-=l[0];var r=entity.components.tile.value,c=rotateCoords(r[0],r[1],map[0].length,global_view);5==buildings[c[0]][c[1]][0]&&(d_level-=.002),heat+=l[3]}console.log(heat),d_ore=o,d_water=n,ore=Math.max(ore+o,0),water=Math.max(water+n,0)},ECS.systems.select=function(t,e){for(var n in t)entity=t[n]},ECS.systems.userInput=function(t,e){},ECS.systems.render=function(t,e){for(var n in t)if(entity=t[n],"build"!=entity.components.type.value){img=entity.components.graphic.value,pos=entity.components.position.value;var o=screenPos(x_offset,y_offset,pos.x,pos.y,global_view);ct.fillStyle="rgb(0, 0, 0, 0.3)",ct.beginPath(),ct.ellipse(o.x,o.y,tilewidth/2,tilewidth/4,0,0,2*Math.PI),ct.fill(),entity.components.height.value>water_level&&ct.drawImage(img,o.x-tilewidth/2,o.y-img.height-entity.components.height.value*height)}};
