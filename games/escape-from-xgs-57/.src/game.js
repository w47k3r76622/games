function Game(){}var c=canvas.getContext("2d"),ct=canvas2.getContext("2d"),oc=ocean.getContext("2d"),c1=layer1.getContext("2d"),c2=layer2.getContext("2d"),c3=layer3.getContext("2d"),ol=overlay.getContext("2d");function init(){window.requestAnimationFrame(gameLoop),layer2.style.top=canvas.height-layer2.height+"px",drawMenu()}var count=0,render_count=0,frame_rate=60;MS_PER_UPDATE=1e3/frame_rate;for(var elapsed,lag=0,prev=Date.now(),state="menu",p_sc=!1,tilewidth=30,height=tilewidth/8*5,x_offset=200,y_offset_init=340,y_offset=y_offset_init,currentTile=[-1,-1],currentButton=-1,currentPanelButton=-1,currentEntity=null,hovered_building=null,selected_building=null,water_level=.1,d_level=0,temp_init=-3,temp=temp_init,heat=0,ore=6,d_ore=0,water=10,d_water=0,power=0,resource_font="12pt courier new",convert=[3,4,2,5],res=[12,8,10,2],returned=[0,0,0,0],select_orientation=0,global_view=0,buttonwidth=40,message_countdown=0,message_timer=2e3,selection=[[0,0],[0,0],[0,0],[0,0]],map=[[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-1,-1,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-1,0,1,1,0,1,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-1,0,1,1,1,1,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-1,0,1,1,1,2,2,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-1,0,1,2,4,2,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-1,0,4,2,2,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-1,0,2,2,2,-1,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-1,-1,2,2,2,-1,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-2,-1,0,0,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5],[-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5]],buildings=new Array(map.length),i=0;i<buildings.length;i++)buildings[i]=Array(map[0].length).fill([-1,"",-100]);var plats=new Array(map.length);for(i=0;i<plats.length;i++)plats[i]=Array(map[0].length).fill(-100);var build_time=new Array(map.length);for(i=0;i<build_time.length;i++)build_time[i]=Array(map[0].length).fill(0);buildables=[{name:"Generator",res:[1,0,1,0],build_time:300,index:0,size:11,color:"rgba(105, 105, 50, 1)"},{name:"Mine",res:[2,2,0,0],build_time:420,index:1,size:11,color:"rgba(50, 50, 50, 1)"},{name:"Pump",res:[1,1,1,0],build_time:340,index:2,size:12,color:"rgba(120, 100, 0, 1)"},{name:"Furnace",res:[5,0,2,0],build_time:480,index:3,size:11,color:"rgba(100, 20, 100, 1)"},{name:"Platform",res:[0,0,2,0],build_time:300,index:4,size:12,color:"rgba(255, 255, 255, 1)"},{name:"Fan",res:[1,0,2,0],build_time:500,index:5,size:11,color:"rgba(255, 255, 0, 1)"},{name:"Launchpad",res:[10,10,12,5],build_time:1200,index:6,size:33,color:"rgba(105, 105, 255, 1)"}],consumption=[[0,.1,.3,.5],[-.3,.1,-.1,.1],[0,-.3,-.1,.3],[.2,.1,-.2,1.2],[0,0,0,0],[0,0,-.3,-.2],[0,.5,-.5,0]];var current_build=null,units=[],entities={};function getTile(e,t,i){return depth_height=i*height,tileX=.5*(e+x_offset+2*(t-y_offset+depth_height)-tilewidth)/tilewidth,tileY=.5*(e+x_offset-2*(t-y_offset+depth_height)-tilewidth)/tilewidth,tileX=Math.floor(tileX+.5),tileY=Math.floor(tileY+.5),[tileX,tileY,i]}function inBounds(e,t){return e>=0&&e<map.length&&t>=0&&t<map[0].length}function select(e){var t=canvas.getBoundingClientRect(),i=e.clientX-t.left,l=e.clientY-t.top;for(depth=5;depth>-6;depth--)if(tempTile=getTile(i,l,Math.max(depth,water_level)),inBounds(tempTile[0],tempTile[1])&&map[tempTile[0]][tempTile[1]]==depth){currentTile=tempTile;var n=buildings[currentTile[0]][currentTile[1]];-1!=n[0]&&(hovered_building=n);break}}function select_panel(e){for(var t=layer2.getBoundingClientRect(),i=e.clientX-t.left,l=e.clientY-t.top,n=0;n<7;n++){var r=n%6,a=Math.floor(n/6);if(i<70+(buttonwidth+20)*r&&i>20+(buttonwidth+20)*r&&l<60*a+70&&l>60*a+20)return n}for(n=0;n<4;n++){r=n%6,a=Math.floor(n/6);if(i<770+(buttonwidth+20)*r&&i>720+(buttonwidth+20)*r&&l<60*a+70&&l>60*a+20)return n+10}return-1}function render(e){render_count+=1,oc.clearRect(0,0,ocean.width,ocean.height),c.clearRect(0,0,canvas.width,canvas.height),c2.clearRect(0,0,canvas.width,canvas.height),ct.clearRect(0,0,canvas2.width,canvas2.height),c.fillStyle="rgb(210, 220, 255)",c.fillRect(0,0,canvas.width,canvas.height);var t=(map.length+1)*tilewidth-x_offset,l=y_offset+-1*map.length*(tilewidth/2);for(column(t-tilewidth,l+(20-water_level)*height,rgb(20,10,85),20,oc,map.length*tilewidth),shimmer(t-tilewidth,l-water_level*height,ocean,oc),j=2*map[0].length-2;j>=0;j--)for(index=Math.max(0,j-map[0].length+1),i=index;i<=j-index;i++){var n=j-i,r=map[0].length-i-1,a=map[r][n],o=(t=(r+n+1)*tilewidth-x_offset,l=y_offset+tilewidth/2*(r-n),Math.floor(1.4*j));a<water_level?tile(t,l-a*height,rgb(170+o,130+o,70+o),c):(column(t,l-a*height,rgb(170+o,90+o,70+o),a-water_level,ct,tilewidth),tile(t,l-a*height,rgb(170+o,130+o,70+o),ct));var d=plats[r][n];d<water_level&&d>=a?tile(t,l-d*height,rgb(190+o,190+o,190+o),c):d>=water_level&&(column(t,l-d*height,rgb(170+o,170+o,170+o),1,ct,tilewidth),tile(t,l-d*height,rgb(190+o,190+o,190+o),ct));var u=in_selection(currentTile[0],currentTile[1],r,n,select_orientation);if(u[0]){var s=u[1];if(null!=current_build)"d"!=current_build?can_build(currentTile[0],currentTile[1],select_orientation,2==current_build.index||4==current_build.index)?tile(t,l-height*s,"rgb(0, 255, 0, 0.5)",ct):tile(t,l-height*s,"rgb(255, 0, 0, 0.5)",ct):map[currentTile[0]][currentTile[1]]>=water_level&&-1==buildings[currentTile[0]][currentTile[1]][0]?tile(t,l-height*s,"rgb(0, 255, 0, 0.5)",ct):tile(t,l-height*s,"rgb(255, 0, 0, 0.5)",ct);else{var h=Math.max(plats[currentTile[0]][currentTile[1]],currentTile[2]);tile(t,l-h*height,"rgb(255, 255, 0, 0.5)",ct)}}var g=buildings[r][n];if(-1!=g[0]){var b=build_time[r][n];if(0==b){if(4!=g[0]){var m=buildables[g[0]].color;"on"!=entities[g[1]].components.status.value.top()&&(m="rgba(255, 0, 0, 1)"),drawCube(ct,t,l-g[2]*height+tilewidth/4,tilewidth/2,tilewidth/2,tilewidth,m)}}else ct.strokeStyle="green",ct.lineWidth=3,ct.beginPath(),ct.rect(t-tilewidth/2,l-g[2]*height-tilewidth/2,30,30),ct.stroke(),ct.fillStyle="green",ct.beginPath(),ct.moveTo(t,l-g[2]*height),ct.arc(t,l-g[2]*height,tilewidth/4,0,2*Math.PI*b/buildables[g[0]].build_time),ct.lineTo(t,l-g[2]*height),ct.closePath(),ct.fill(),ct.lineWidth=1;ct.font="18px verdana",ct.fillStyle="white",ct.strokeStyle="black",ct.lineWidth=.5,ct.fillText(buildables[g[0]].name,t-tilewidth,l-g[2]*height-tilewidth/2),ct.strokeText(buildables[g[0]].name,t-tilewidth,l-g[2]*height-tilewidth/2)}}c3.fillStyle="black",c3.fillRect(0,0,canvas.width,30),c3.fillStyle="brown",c3.fillRect(0,30,canvas.width,25),c3.font=resource_font,c3.fillStyle="white",c3.fillText("Ore: "+Math.round(100*ore)/100+"("+Math.round(100*d_ore)/100+")",40,25),c3.fillText("Water: "+Math.round(100*water)/100+"("+Math.round(100*d_water)/100+")",160,25),c3.fillText("Power: "+Math.round(10*power)/10,340,25),c3.fillStyle="rgb(150, 150, 255)",c3.fillText("Water Level:"+Math.round(1e3*water_level)/100+" m ("+Math.round(1e3*d_level)/100+" m)",520,25),c3.fillStyle="rgb(255, 90, 90)",c3.fillText("Temperature:"+Math.round(10*temp)/10+" C ",800,25),c3.fillStyle="rgb(255, 255, 0)",c3.fillText("Steel: "+res[0],40,50),c3.fillText("Aluminum: "+res[1],180,50),c3.fillText("Plastic: "+res[2],320,50),c3.font="9pt courier new",c3.fillText("1 Steel = "+convert[2]+" ore, 1 Aluminum = "+convert[1]+" ore, 1 Plastic = "+convert[2]+" ore, 1 Dynamite = "+convert[3]+" ore  ",460,50);if(c2.fillStyle="gray",c2.fillRect(0,0,canvas.width-20,200),c2.fillStyle="rgb(50, 50, 50)",c2.fillRect(0,0,canvas.width-20,16),c2.font="9pt courier new",c2.fillStyle="white",c2.fillText("Construction",160,12),-1!=currentButton&&10!=currentButton){var f=consumption[currentButton],_=buildables[currentButton].res;c2.fillStyle="black",c2.fillText("Costs: ",80,80),c2.fillText("Steel: "+_[0]+", Aluminum: "+_[1]+", Plastic: "+_[2]+", Dynamite: "+_[3],80,95),c2.fillText("Effects: ",80,110),c2.fillText("Ore: "+f[0]+", Water: "+f[1]+", Power: "+f[2]+", Heat: "+f[3]+" C",80,125)}c2.fillStyle="rgb(20, 135, 0)",c2.fillRect(440,0,canvas.width-440,200),c2.fillStyle="rgb(5, 95, 0)",c2.fillRect(440,0,canvas.width-20,16),c2.font="9pt courier new",c2.fillStyle="white",c2.fillText("Building Panel",530,12),c2.fillStyle="orange",c2.fillRect(700,0,canvas.width-520,200),c2.fillStyle="rgb(155, 125, 0)",c2.fillRect(700,0,canvas.width-20,16),c2.font="9pt courier new",c2.fillStyle="white",c2.fillText("Gadgets",830,12),drawBuild(0,0),drawPanel(440,0,selected_building);m="gray";res[3]>0&&(m="white"),drawButton(c2,720,20,1,"Dynamite (x"+res[3]+")",m),currentButton>=10&&(c2.fillStyle="rgb(0, 255, 0, 0.4)",c2.fillRect(720+currentButton%10*60,20,50,50)),ECS.systems.render(ECS.entities,e)}building=new ECS.Entity,building.addComponent(new ECS.Components.Type("build")),building.addComponent(new ECS.Components.Consumption(consumption[0])),building.addComponent(new ECS.Components.Status),building.addComponent(new ECS.Components.Size(11)),building.addComponent(new ECS.Components.Tile([11,8])),buildings[11][8]=[0,building.id,2],entities[building.id]=building,building=new ECS.Entity,building.addComponent(new ECS.Components.Type("build")),building.addComponent(new ECS.Components.Consumption(consumption[2])),building.addComponent(new ECS.Components.Status),building.addComponent(new ECS.Components.Size(12)),building.addComponent(new ECS.Components.Tile([11,9])),buildings[11][10]=[2,building.id,2],buildings[11][9]=[2,building.id,2],entities[building.id]=building,ECS.entities=entities,tile=((e,t,i,l)=>{l.strokeStyle=i,l.beginPath(),l.moveTo(e-tilewidth,t),l.lineTo(e,t-tilewidth/2),l.lineTo(e+tilewidth,t),l.lineTo(e,t+tilewidth/2),l.closePath(),l.stroke(),l.fillStyle=i,l.fill()}),column=((e,t,i,l,n,r)=>{draw_height=l*height,n.strokeStyle="rgb(50, 50, 50)",n.beginPath(),n.moveTo(e-r,t),n.lineTo(e,t+r/2),n.lineTo(e,t+r/2+draw_height),n.lineTo(e-r,t+draw_height),n.closePath(),n.stroke(),n.fillStyle=i,n.fill(),n.beginPath(),n.moveTo(e,t+r/2),n.lineTo(e,t+r/2+draw_height),n.lineTo(e+r,t+draw_height),n.lineTo(e+r,t),n.closePath(),n.stroke(),n.fillStyle=i,n.fill()}),document.addEventListener("mousemove",function(e){select(e),currentButton=select_panel(e);var t=layer2.getBoundingClientRect(),i=e.clientX-t.left,l=e.clientY-t.top;currentPanelButton=-1;for(var n=0;n<5;n++){var r=n%4,a=Math.floor(n/4);i<510+(buttonwidth+20)*r&&i>460+(buttonwidth+20)*r&&l<60*a+70&&l>60*a+20&&(currentPanelButton=n)}if(null!=current_build){c1.clearRect(0,0,layer1.width,layer1.height);t=layer1.getBoundingClientRect(),i=e.clientX-t.left,l=e.clientY-t.top;c1.font="12px arial",c1.fillStyle="black","d"!=current_build?(c1.fillStyle="white",c1.fillRect(i,l,30,30),c1.fillText(current_build.name,i,l+10)):(c1.beginPath(),c1.moveTo(i-tilewidth/2,l-tilewidth/2),c1.lineTo(i+tilewidth/2,l+tilewidth/2),c1.lineWidth=10,c1.strokeStyle="red",c1.stroke(),c1.fillStyle="black",c1.fillText("Dynamite",i,l-10))}}),document.addEventListener("mousedown",function(e){null!=hovered_building&&(selected_building=hovered_building);var t,i=currentPanelButton;-1!=i&&4!=i&&null!=selected_building&&("on"!=(t=entities[selected_building[1]]).components.status.value.top()?message("The building is not operational!"):3==selected_building[0]?i<4&&ore>=convert[i]?(ore-=convert[i],res[i]+=1):ore<convert[i]&&message("Not enough ore!"):6==selected_building[0]&&0==i&&(res[0]>=10&&res[1]>=10&&res[2]>=10&&res[3]>=5?(state="end",drawEnd("rocket")):message("Not enough materials!")));4==i&&null!=selected_building&&("on"===(t=entities[selected_building[1]]).components.status.value.top()?t.components.status.value.push("off"):"off"===t.components.status.value.top()&&t.components.status.value.pop());if(-1!=currentButton&&null==current_build)if(10==currentButton)res[3]>0?(current_build="d",res[3]-=1,returned=[0,0,0,1]):message("You don't have any dynamite!");else if(build=buildables[currentButton],res[0]>=build.res[0]&&res[1]>=build.res[1]&&res[2]>=build.res[2]){res[0]-=build.res[0],res[1]-=build.res[1],res[2]-=build.res[2],returned=[build.res[0],build.res[1],build.res[2],0],current_build=build;var l=Math.floor(current_build.size/10)-1,n=current_build.size%10-1;selection[(global_view+2)%4]=[0,0],selection[(global_view+3)%4]=[n,0],selection[global_view]=[n,l],selection[(global_view+1)%4]=[0,l]}else message("Not enough materials!");else if(null!=current_build){if("d"===current_build){var r=currentTile[0],a=currentTile[1];map[r][a]>=water_level&&-1==buildings[r][a][0]&&(map[r][a]-=1,plats[r][a]-=-100,in_bound(r+1,c)&&(plats[r+1][c]=-100),in_bound(r,c+1)&&(plats[r][c+1]=-100),in_bound(r-1,c)&&(plats[r-1][c]=-100),in_bound(r,c-1)&&(plats[r][c-1]=-100))}else if(can_build(currentTile[0],currentTile[1],select_orientation,2==current_build.index||4==current_build.index)){current_build.size,Math.floor(current_build.size/10);building=new ECS.Entity,building.addComponent(new ECS.Components.Type("build")),building.addComponent(new ECS.Components.Consumption(consumption[current_build.index])),building.addComponent(new ECS.Components.Status),building.addComponent(new ECS.Components.Size(current_build.size)),building.addComponent(new ECS.Components.Tile([currentTile[0],currentTile[1]])),entities[building.id]=building;n=selection[0][0+select_orientation],l=selection[0][1-select_orientation];for(var o=-100,d=0;d<=l;d++)for(var c=0;c<=n;c++)in_bound(currentTile[0]+d,currentTile[1]+c)&&map[currentTile[0]+d][currentTile[1]+c]>o&&(o=map[currentTile[0]+d][currentTile[1]+c]),in_bound(currentTile[0]+d,currentTile[1]+c)&&plats[currentTile[0]+d][currentTile[1]+c]>o&&(o=plats[currentTile[0]+d][currentTile[1]+c]);for(d=0;d<=l;d++)for(c=0;c<=n;c++)4==current_build.index?map[currentTile[0]+d][currentTile[1]+c]<water_level&&(buildings[currentTile[0]+d][currentTile[1]+c]=[current_build.index,building.id,o],build_time[currentTile[0]+d][currentTile[1]+c]=current_build.build_time):(buildings[currentTile[0]+d][currentTile[1]+c]=[current_build.index,building.id,o],build_time[currentTile[0]+d][currentTile[1]+c]=current_build.build_time);selection=[[0,0]]}else can_build(currentTile[0],currentTile[1],select_orientation,2==current_build.index||4==current_build.index)||cancel();current_build=null,c1.clearRect(0,0,layer1.width,layer1.height)}}),document.addEventListener("keydown",function(e){if(65==e.keyCode)x_offset=Math.max(x_offset-10,0);else if(68==e.keyCode)x_offset=Math.min(x_offset+10,canvas.width/2);else if(83==e.keyCode)y_offset=Math.max(y_offset-10,0);else if(87==e.keyCode)y_offset=Math.min(y_offset+10,canvas.height);else if(81==e.keyCode)for(var t=0;t<3;t++)map=rotateMap(map),buildings=rotateMap(buildings),plats=rotateMap(plats),build_time=rotateMap(build_time),global_view=(global_view+1)%4;else 69==e.keyCode?(map=rotateMap(map),buildings=rotateMap(buildings),build_time=rotateMap(build_time),plats=rotateMap(plats),global_view=(global_view+1)%4):88==e.keyCode?select_orientation=(select_orientation+1)%2:67==e.keyCode?cancel():80==e.keyCode?(console.log(state),"play"===state?(state="pause",p_sc=!0):"pause"===state&&(state="play",ol.clearRect(0,0,overlay.width,overlay.height))):38==e.keyCode?water_level+=.1:40==e.keyCode&&(water_level-=.1)});var z=.1,dir=1;function update(e){.9==(z+=.01*dir)?dir=-1:0==z&&(dir=1),(message_timer-=message_countdown*e*MS_PER_UPDATE)<0&&(message_timer=2e3,message_countdown=0,c1.clearRect(0,0,layer1.width,layer1.height));for(var t=0;t<map.length;t++)for(var i=0;i<map[0].length;i++){build_time[t][i]=Math.max(build_time[t][i]-e,0);var l=buildings[t][i];4==l[0]&&(plats[t][i]=l[2])}count%frame_rate==0&&(d_level=.001*(Math.max(5,temp)-5),ECS.systems.updatebuild(ECS.entities,e),water_level+=d_level,temp=temp_init+heat,heat=0),water<=0&&(state="end",drawEnd("water")),water_level>2&&(state="end",drawEnd("water")),count+=1}function gameLoop(e){if("play"===state){for(e=Date.now(),elapsed=e-prev,prev=e,lag+=elapsed;lag>=MS_PER_UPDATE;)t1=Date.now(),update(1),t2=Date.now(),lag-=MS_PER_UPDATE;render(lag/MS_PER_UPDATE)}else"pause"===state?(drawPause(p_sc),p_sc=!1):"ins"==state&&drawIns();window.requestAnimationFrame(gameLoop)}
