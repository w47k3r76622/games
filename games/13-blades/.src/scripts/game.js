(()=>{var ee=()=>{};var ie={};function J(e,...t){(ie[e]||[]).map(i=>i(...t))}var O,Z,Dt={get(e,t){return t=="_proxy"?!0:ee}};function se(){return Z}function Yt(e,{contextless:t=!1}={}){if(O=document.getElementById(e)||e||document.querySelector("canvas"),t&&(O=O||new Proxy({},Dt)),!O)throw Error("You must provide a canvas element for the game");return Z=O.getContext("2d")||new Proxy({},Dt),Z.imageSmoothingEnabled=!1,J("init"),{canvas:O,context:Z}}var ft=class e{constructor({spriteSheet:t,frames:i,frameRate:s,loop:n=!0,name:r}){let{width:o,height:a,spacing:d=0,margin:l=0}=t.frame;Object.assign(this,{spriteSheet:t,frames:i,frameRate:s,loop:n,name:r,width:o,height:a,spacing:d,margin:l,isStopped:!1,_f:0,_a:0})}clone(){return new e(this)}start(){this.isStopped=!1,this.loop||this.reset()}stop(){this.isStopped=!0}reset(){this._f=0,this._a=0}update(t=1/60){if(!this.isStopped){if(!this.loop&&this._f==this.frames.length-1){this.stop();return}for(this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}}render({x:t,y:i,width:s=this.width,height:n=this.height,context:r=se()}){let o=this.frames[this._f]/this.spriteSheet._f|0,a=this.frames[this._f]%this.spriteSheet._f|0;r.drawImage(this.spriteSheet.image,this.margin+a*this.width+(a*2+1)*this.spacing,this.margin+o*this.height+(o*2+1)*this.spacing,this.width,this.height,t,i,s,n)}};function ae(){return new ft(...arguments)}var ne=/(jpeg|jpg|gif|png|webp)$/,he=/(wav|mp3|ogg|aac)$/,Ht=/^\//,re=/\/$/,Ot=new WeakMap,le="",oe="",de="";function tt(e,t){return new URL(e,t).href}function gt(e,t){return[e.replace(re,""),e?t.replace(Ht,""):t].filter(i=>i).join("/")}function mt(e){return e.split(".").pop()}function _t(e){let t=e.replace("."+mt(e),"");return t.split("/").length==2?t.replace(Ht,""):t}function ce(e){return{wav:e.canPlayType('audio/wav; codecs="1"'),mp3:e.canPlayType("audio/mpeg;"),ogg:e.canPlayType('audio/ogg; codecs="vorbis"'),aac:e.canPlayType("audio/aac;")}}var v={},B={},L={};function wt(){window.__k||(window.__k={dm:Ot,u:tt,d:L,i:v})}function ue(e){return wt(),new Promise((t,i)=>{let s,n,r;if(s=gt(le,e),v[s])return t(v[s]);n=new Image,n.onload=function(){r=tt(s,window.location.href),v[_t(e)]=v[s]=v[r]=this,J("assetLoaded",this,e),t(this)},n.onerror=function(){i("Unable to load image "+s)},n.src=s})}function fe(e){return new Promise((t,i)=>{let s=e,n,r,o,a;if(n=new Audio,r=ce(n),e=[].concat(e).reduce((d,l)=>d||(r[mt(l)]?l:null),0),!e)return i("cannot play any of the audio formats provided "+s);if(o=gt(oe,e),B[o])return t(B[o]);n.addEventListener("canplay",function(){a=tt(o,window.location.href),B[_t(e)]=B[o]=B[a]=this,J("assetLoaded",this,e),t(this)}),n.onerror=function(){i("Unable to load audio "+o)},n.src=o,n.load()})}function pe(e){wt();let t,i;return t=gt(de,e),L[t]?Promise.resolve(L[t]):fetch(t).then(s=>{if(!s.ok)throw s;return s.clone().json().catch(()=>s.text())}).then(s=>(i=tt(t,window.location.href),typeof s=="object"&&Ot.set(s,i),L[_t(e)]=L[t]=L[i]=s,J("assetLoaded",s,e),s))}function Lt(...e){return wt(),Promise.all(e.map(t=>{let i=mt([].concat(t)[0]);return i.match(ne)?ue(t):i.match(he)?fe(t):pe(t)}))}function ge(e){if(+e==e)return e;let t=[],i=e.split(".."),s=+i[0],n=+i[1],r=s;if(s<n)for(;r<=n;r++)t.push(r);else for(;r>=n;r--)t.push(r);return t}var pt=class{constructor({image:t,frameWidth:i,frameHeight:s,spacing:n=0,margin:r=0,animations:o}={}){if(!t)throw Error("You must provide an Image for the SpriteSheet");this.animations={},this.image=t,this.frame={width:i,height:s,spacing:n,margin:r},this._f=(t.width-r)/i|0,this.createAnimations(o)}createAnimations(t){let i,s;for(s in t){let{frames:n,frameRate:r,loop:o}=t[s];if(i=[],n==null)throw Error("Animation "+s+" must provide a frames property");[].concat(n).map(a=>{i=i.concat(ge(a))}),this.animations[s]=ae({spriteSheet:this,frames:i,frameRate:r,loop:o,name:s})}}};function R(){return new pt(...arguments)}var u=4,{canvas:p,context:c}=Yt(),_,Ut=function(){p.width=window.innerWidth,p.height=window.innerHeight,c.imageSmoothingEnabled=!1,c.scale(u,u),_=Math.max(0,p.height-480)/2/u,h&&(h.y=_)};Ut();window.addEventListener("resize",Ut);var Ct={},me=function(e){Ct[e.code]=!0},_e=function(e){Ct[e.code]=!1};window.addEventListener("keydown",me);window.addEventListener("keyup",_e);function A(e){return Ct[e]}var yt=class{constructor(t={}){Object.assign(this,{width:0,height:0,tilewidth:0,tileheight:0,tilesets:null,layerMap:{},layerCanvases:{},_sx:0,_sy:0}),Object.assign(this,t),this.mapwidth=this.width*this.tilewidth,this.mapheight=this.height*this.tileheight,this._canvas=document.createElement("canvas"),this._canvas.width=this.mapwidth,this._canvas.height=this.mapheight,this._ctx=this._canvas.getContext("2d"),this.tilesets.map(i=>{let{__k:s,location:n}=window,r=(s?s.dm.get(t):"")||n.href,{source:o}=i;if(o){if(!s)throw Error('You must use "load" or "loadData" to resolve tileset.source');let d=s.d[s.u(o,r)];if(!d)throw Error(`You must load the tileset source "${o}" before loading the tileset`);Object.keys(d).map(l=>{i[l]=d[l]})}let{image:a}=i;if(""+a===a){if(!s)throw Error('You must use "load" or "loadImage" to resolve tileset.image');let d=s.i[s.u(a,r)];if(!d)throw Error(`You must load the image "${a}" before loading the tileset`);i.image=d}}),c&&this._p()}get sx(){return this._sx}get sy(){return this._sy}set sx(t){let i=Math.max(0,this.mapwidth*c.getTransform().m11-p.width);this._sx=j(0,i,t)}set sy(t){let i=Math.max(0,this.mapheight*c().getTransform().m22-p().height);this._sy=j(0,i,t)}add(t){let i=this.objects||[];t.parent=this,i.push(t),this.objects=i}remove(t){let i=this.objects||[],s=i.indexOf(t);s>=0&&i.splice(s,1),t.parent=null}render(t=this._canvas,i=!0){let{_d:s,sx:n=0,sy:r=0}=this;s&&this._p();let{width:o,height:a}=p,d=Math.min(t.width,o),l=Math.min(t.height,a);c.drawImage(t,n,r,d,l,0,0,d,l),i&&(c.save(),(n||r)&&c.translate(-n,-r),this.objects.map(f=>f.render&&f.render()),c.restore())}_p(){let{_ctx:t,layers:i=[],layerMap:s}=this;this._d=!1,i.map(n=>{let{name:r,data:o,visible:a}=n;n._d=!1,s[r]=n,o&&a!=!1&&this._rl(n,t)})}_rl(t,i){let{opacity:s,data:n=[]}=t,{tilesets:r,width:o,tilewidth:a,tileheight:d}=this;i.save(),i.globalAlpha=s,n.map((l,f)=>{let m=2147483648,P=1073741824,ht=536870912;if(!l)return;let E=0,rt=0,$=l&m,N=l&P,lt=0,ot=0,q=0,Q=0,Et=0;E=$||N,l&=~(m|P),Et=l&ht,Et&&($&&N?q=1:$?lt=1:N?ot=1:Q=1,rt=lt||ot||q||Q,l&=~ht);let dt;for(let ut=r.length-1;ut>=0&&(dt=r[ut],!(l/dt.firstgid>=1));ut--);let{image:bt,spacing:ct=0,margin:Pt=0,firstgid:Qt,columns:Zt}=dt,Rt=l-Qt,It=Zt??bt.width/(a+ct)|0,Y=f%o*a,H=(f/o|0)*d,Jt=Pt+Rt%It*(a+ct),te=Pt+(Rt/It|0)*(d+ct);rt?(i.save(),i.translate(Y+a/2,H+d/2),ot||Q?i.rotate(-Math.PI/2):(lt||q)&&i.rotate(Math.PI/2),(q||Q)&&i.scale(-1,1),Y=-a/2,H=-d/2):E&&(i.save(),i.translate(Y+($?a:0),H+(N?d:0)),i.scale($?-1:1,N?-1:1),Y=E?0:Y,H=E?0:H),i.drawImage(bt,Jt,te,a,d,Y,H,a,d),(E||rt)&&i.restore()}),i.restore()}},C=class{constructor(t){this.init(t),this.initialize()}init(t){Object.assign(this,{x:0,y:0,dx:0,dy:0,ddx:0,ddy:0,anchor:{x:0,y:0},ttl:1/0,scaleX:1,scaleY:1,parent:null,visible:!0,world:{x:0,y:0,width:0,height:0,scaleX:t.scaleX||1,scaleY:t.scaleY||1}}),Object.assign(this,t),"animations"in t&&(this.animations=xe(t.animations),this.currentAnimation=this.animations[Object.keys(this.animations)[0]],this.width=this.currentAnimation.width,this.height=this.currentAnimation.height)}initialize(){}isAlive(){return this.ttl>0}addChild(t){let i=this.objects||[];t.parent=this,i.push(t),this.objects=i}removeChild(t){let i=this.objects||[],s=i.indexOf(t);s>=0&&i.splice(s,1),t.parent=null}update(t=y){this.advance(t)}advance(t=y){this.dx+=this.ddx*t,this.dy+=this.ddy*t,this.x+=this.dx*t,this.y+=this.dy*t,this.ttl--,this.currentAnimation?.update(t);let i=this.parent?.world||{x:0,y:0,width:0,height:0,scaleX:1,scaleY:1};this.world.scaleX=this.scaleX*i.scaleX,this.world.scaleY=this.scaleY*i.scaleY,this.world.x=this.x+i.x,this.world.y=this.y+i.y,this.world.width=this.width*i.scaleX,this.world.height=this.height*i.scaleY,this.world.dirty=!0,(this.objects||[]).forEach(s=>s.update&&s.update(t))}playAnimation(t){this.currentAnimation?.stop(),this.currentAnimation=this.animations[t],this.currentAnimation.start()}render(){if(this.visible){if(c.save(),(this.x||this.y)&&c.translate(this.x,this.y),c.save(),"currentAnimation"in this){let t=this.currentAnimation.frames[this.currentAnimation._f]/this.currentAnimation.spriteSheet._f|0,i=this.currentAnimation.frames[this.currentAnimation._f]%this.currentAnimation.spriteSheet._f|0,s="facing_dir"in this?this.facing_dir:-1;s>0?c.scale(-this.scaleX,this.scaleY):c.scale(this.scaleX,this.scaleY),this.flicker&&(c.filter="invert(1)"),c.translate(s*this.currentAnimation.width*this.anchor.x,-this.currentAnimation.height*this.anchor.y),c.drawImage(this.currentAnimation.spriteSheet.image,this.currentAnimation.margin+i*this.currentAnimation.width+(i*2+1)*this.currentAnimation.spacing,this.currentAnimation.margin+t*this.currentAnimation.height+(t*2+1)*this.currentAnimation.spacing,this.currentAnimation.width,this.currentAnimation.height,0,0,this.currentAnimation.width*s*-1,this.currentAnimation.height)}else"image"in this?(c.scale(this.scaleX,this.scaleY),c.translate(-this.image.width*this.anchor.x,-this.image.height*this.anchor.y),c.drawImage(this.image,0,0,this.image.width,this.image.height)):"color"in this&&(c.translate(-this.width*this.anchor.x,-this.height*this.anchor.y),c.fillStyle=this.color,c.fillRect(0,0,this.width,this.height));c.restore(),(this.objects||[]).forEach(t=>t.render&&t.render()),c.restore()}}},xt=class extends C{constructor(t){super(t)}pickup(){return!1}update(){if(nt(this,g)&&this.pickup())return;if(this.ttl!=0&&this.ttl<=240&&[].concat(W(25,25),W(25,75)).indexOf(Math.floor(this.ttl%100))>=0?this.flicker=!0:this.flicker=!1,this.ttl<=0){h.remove(this);return}let t=M(this,"ground");this.advance(),t=M(this,"ground"),t.down?(this.ddy=0,this.dy=0):this.ddy=K}},U=class{constructor(t){this.fps=60,Object.assign(this,t),this.isStopped=!0,this.accumulator=0,this.delta=1e3/this.fps,this.step=1/this.fps,this.last=null,this.rAF=null,this.dt=null,this.focused=!0,window.addEventListener("focus",()=>{this.focused=!0}),window.addEventListener("blur",()=>{this.focused=!1})}frame(){if(this.isStopped||(this.rAF=requestAnimationFrame(this.frame.bind(this)),!this.focused))return;let t=performance.now();if(this.dt=t-this.last,this.last=t,!(this.dt>1e3)){for(this.accumulator+=this.dt;this.accumulator>=this.delta&&(this.update(this.step),!this.isStopped);)this.accumulator-=this.delta;c.clearRect(0,0,p.width,p.height),this.render()}}start(){this.isStopped&&(this.last=performance.now(),this.isStopped=!1,this.rAF=requestAnimationFrame(this.frame.bind(this)))}stop(){this.isStopped=!0,cancelAnimationFrame(this.rAF)}update(){}fill_canvas(t,i="destination-under",s=null){c.save(),c.globalCompositeOperation=i,c.fillStyle=t,s?c.fillRect(s.x,s.y,s.width,s.height):c.fillRect(0,0,p.width,p.height),c.restore()}renderInside(){}render(){this.fill_canvas("#315282","source-over"),this.renderInside(),this.fill_canvas("#000000","source-over",{x:0,y:0,width:p.width,height:_}),this.fill_canvas("#000000","source-over",{x:0,y:_+480/u,width:p.width,height:_})}},z=class extends C{constructor(t){super(Object.assign({ai_state:"move",curHealth:3,attack_dmg:1,has_touch_dmg:!0,speed:30+k(-5,10),jumpspeed:40,jumping:!1,jumping_time:0,jumping_max_held:.2,ground_friction:4,air_friction:18,facing_dir:[-1,1][k(0,1)],ai_dt:2,immunity_cd:1,immunity_dt:0,stagger_dt:0,defense:0,state_transitions:{idle:[{method:"aiDeltaUpdate",args:[3]},{method:"stateChangeRandCheck",args:[0,1,1,"move"]}],move:[{method:"aiDeltaUpdate",args:[2]},{method:"stateChangeRandCheck",args:[0,1,1,"idle"]}]}},t))}playerInRange(t){let i=g.x-this.x,s=g.y-this.y;return i*i+s*s<=t*t}stateChangeRandCheck(t,i,s,n,r,o){let a=k(t,i);return a>=s?(this.changeState(n),!0):o&&a>=r?(this.changeState(o),!0):!1}aiDeltaUpdate(t){return this.ai_dt<=0&&(this.ai_dt+=t),this.ai_dt=Math.max(0,this.ai_dt-y),this.ai_dt<=0}handle_jump(){this.jumping&&this.jumping_time<this.jumping_max_held&&(this.jumping_time+=y),this.jumping_time>=this.jumping_max_held&&(this.jumping=!1,this.jumping_time=0)}jump(){this.dy-=this.jumpspeed,this.jumping=!0,this.jumping_time=0}move(){this.playAnimation("walk"),this.dx=j(this.dx+this.facing_dir*this.speed,-this.speed,this.speed);var t=M(this,"ground");if(this.advance(y),t=M(this,"ground"),t.down?(this.dy=0,this.ddy=0,this.jumping=!1):this.jumping?this.ddy=0:this.ddy=K,this.facing_dir==-1&&t.left&&t.down&&!t.top&&!this.jumping){let i=h.layerMap.ground;(i.data[t.left_tpos.c+(t.left_tpos.r-1)*h.width]==0||i.data[t.left_tpos.c+(t.left_tpos.r-2)*h.width]==0)&&i.data[t.up_tpos.c+t.up_tpos.r*h.width]==0&&i.data[t.up_tpos.c+(t.up_tpos.r-1)*h.width]==0&&this.jump()}else if(this.facing_dir==1&&t.right&&t.down&&!t.top&&!this.jumping){let i=h.layerMap.ground;(i.data[t.right_tpos.c+(t.right_tpos.r-1)*h.width]==0||i.data[t.right_tpos.c+(t.right_tpos.r-2)*h.width]==0)&&i.data[t.up_tpos.c+t.up_tpos.r*h.width]==0&&i.data[t.up_tpos.c+(t.up_tpos.r-1)*h.width]==0&&this.jump()}this.facing_dir==-1&&t.left&&t.down&&!this.jumping?(this.facing_dir=1,this.dx=0):this.facing_dir==1&&t.right&&t.down&&!this.jumping&&(this.facing_dir=-1,this.dx=0)}changeState(t){this.ai_state=t}idle(){this.playAnimation("idle"),this.clearXMovement(),this.applyGravity()}applyGravity(){var t=M(this,"ground");return this.advance(y),t=M(this,"ground"),t.down?(this.ddy=0,this.jumping=!1):this.jumping?this.ddy=0:this.ddy=K,!0}clearXMovement(){return this.dx=0,this.ddx=0,!0}facePlayer(){return this.facing_dir=Math.sign(g.x-this.x),!0}onDeath(){}takeDamage(t){if(!(this.immunity_dt>0)&&(t.damage=Math.max(0,t.damage-this.defense),this.curHealth=Math.max(0,this.curHealth-t.damage),this.immunity_dt=this.immunity_cd,this.stagger_dt+=t.staggerAmt,D([[0,6],[0,8],[0,7],[0,18],[0,19],[0,17]],400,.19,.18,.005,.2,.1,""),this.curHealth<=0)){let i=S.indexOf(this);S.splice(i,1),h.remove(this),Bt(this.x,this.y);let s=["health","big_health"][k(0,1)];if(s!=null){let n=ke[s]();n.x=this.x,n.y=this.y-1,h.add(n)}this.onDeath(),g.curRage=Math.min(g.maxRage,g.curRage+1)}}update(){if(this.immunity_dt=Math.max(0,this.immunity_dt-y),this.stagger_dt=Math.max(0,this.stagger_dt-y),this.immunity_dt!=0&&[].concat(W(25,25),W(25,75)).indexOf(Math.floor(this.immunity_dt*100%100))>=0?this.flicker=!0:this.flicker=!1,this.handle_jump(),this.stagger_dt<=0)this.ai_state in this&&this[this.ai_state](),(this.state_transitions[this.ai_state]||[]).every(i=>this[i.method](...i.args||[]));else{this.dx=0,this.dy=0,this.applyGravity();var t=M(this,"ground");this.advance(y),t=M(this,"ground")}this.has_touch_dmg&&nt(this,g)&&g.takeDamage({damage:this.attack_dmg})}},vt=class extends C{constructor(t){super(Object.assign({dy:-5,animations:at.animations,anchor:{x:.5,y:.5},rand_start:k(-3,3)},t))}update(t=y){this.x=Math.sin(this.rand_start+this.ttl*.2)*5,this.advance(t),this.ttl<=0&&this.parent.removeChild(this)}},g=null,G=null,b=null,it=null,F=null,h=null,x=null,I=null,zt=null,At=null,Mt=null,St=null,at=null,Ft=null,Wt=null,$t=null,w=null,T=0,X=1,y=1/60,K=9.8*15,j=function(e,t,i){return Math.min(Math.max(e,t),i)},k=function(e,t){let i=Math.ceil(e),s=Math.floor(t);return Math.floor(Math.random()*(s-i+1)+i)},we=function(e){return e/h.tileheight|0},ye=function(e){return e/h.tilewidth|0},W=function(e,t=0){return[...Array(25).keys()].map(i=>i+t)},xe=function(e){let t={};for(let i in e)t[i]=e[i].clone();return t},Nt=function(){let e=new xt({x:0,y:0,width:8,height:8,scaleX:.35,scaleY:.35,anchor:{x:.5,y:.5},animations:at.animations,facing_dir:-1,ttl:900,pickup:function(){return g.curHealth>=g.maxHealth?!1:(g.curHealth+=1,h.remove(this),D([[0,6],[0,10],[1,8],[1,4],[2,1]],400,.19,.18,.005,.1,.1,"triangle"),!0)}});return e.dy=-.1,e.playAnimation("filled"),e},ve=function(){let e=Nt();return e.scaleX=.5,e.scaleY=.5,e.pickup=function(){g.curHealth>=g.maxHealth||(g.curHealth=Math.min(g.curHealth+3,g.maxHealth),h.remove(this),D([[0,6],[0,10],[1,8],[1,4],[2,1]],400,.19,.18,.005,.1,.1,"triangle"))},e},ke={health:Nt,big_health:ve},D=function(e,t,i,s,n,r,o,a,d){let l=new AudioContext,f=l.createGain();for(d of e){let m=l.createOscillator();m.connect(f),f.connect(l.destination),m.start(d[0]*r),m.frequency.setValueAtTime(t*1.06**(13-d[1]),d[0]*r),m.type=a,f.gain.setValueAtTime(o,d[0]*r),f.gain.setTargetAtTime(1e-5,d[0]*r+s,n),m.stop(d[0]*r+i)}return l},Ce=function(e){if(!e)return{computed:0};let t=e.match(/(\d+)(\w+)/),i=+t[1],s=t[2];return{size:i,unit:s,computed:i}},V=function(){var e=Ce(this.font).computed;this.text.split(`
`).forEach((t,i)=>{c.save(),c.textBaseline="top",c.textAlign="left",c.fillStyle=this.color,c.font=this.font;let s=c.measureText(t);c.translate(this.x-s.width*this.anchor.x,this.y+e*i),c.fillText(t,0,0),c.restore()})},Bt=function(e,t){let i=new C({x:e,y:t,width:16,height:16,anchor:{x:.5,y:.5},animations:zt.animations,ttl:30,update:function(){this.advance(),this.ttl<=0&&h.remove(i)}});h.add(i)},Ae=function(){return new C({curHealth:5,maxHealth:5,curRage:0,maxRage:13,speed:50,jumpspeed:40,ground_friction:8,air_friction:4,scaleX:1,scaleY:1,x:100,y:40,animations:At.animations,width:4,height:8,anchor:{x:.5,y:.5},jumping:!1,jumping_time:0,jumping_max_held:.2,facing_dir:-1,attack_cd_base:.7,attack_cd:0,attack_dmg:1,stagger_dt:0,immunity_cd:1,immunity_dt:0,takeDamage:async function(e){this.immunity_dt>0||(this.curHealth=Math.max(0,this.curHealth-e.damage),this.immunity_dt=this.immunity_cd,D([[0,17],[0,18],[0,19]],400,.19,.18,.005,.2,.1,"sawtooth"),this.curHealth<=0&&(Bt(this.x,this.y),h.remove(this),D([[0,18],[1,18],[1,16],[1,17],[2,20],[3,20],[3,19],[3,18],[4,24],[5,24],[5,23],[5,22],[6,24],[7,24],[7,23],[7,22]],400,.19,.18,.005,.1,.1,"triangle"),await new Promise(t=>setTimeout(t,2e3)),x.stop(),Pe()))},onGround:function(){return this._lastGroundCheck},getActions:function(){return{leftpressed:A("KeyA")||A("ArrowLeft"),rightpressed:A("KeyD")||A("ArrowRight"),downpressed:A("KeyS")||A("ArrowDown"),jumppressed:A("KeyW")||A("ArrowUp"),attackpressed:A("Space")||A("KeyS")||A("ArrowDown")}},attack:function(e){this.attack_cd=this.attack_cd_base,this.stagger_dt=this.attack_cd_base/2,this.onGround()&&(this.dx=0);let t=e.downpressed?1:5,i=e.downpressed?5:1,s=e.downpressed?0:this.facing_dir*this.width*this.anchor.x+t/2*this.facing_dir,n=e.downpressed?this.height*this.anchor.y+i/2+1:0,r=new C({attack_dmg:this.attack_dmg+this.curRage/6,x:s,y:n,width:t,height:i,scaleX:1,scaleY:1,color:"#758694",anchor:{x:.5,y:.5},ttl:30,isDownAttack:e.downpressed,owner:this,update:function(){if(this.advance(),this.ttl<=0){g.removeChild(this);return}for(let o=0;o<S.length;o++){let a=S[o];nt(this,a)&&(a.takeDamage({damage:this.attack_dmg,staggerAmt:.5}),this.isDownAttack&&(this.owner.dy=-40))}}});g.addChild(r)},update:function(){this.attack_cd=Math.max(0,this.attack_cd-y),this.stagger_dt=Math.max(0,this.stagger_dt-y),this.immunity_dt=Math.max(0,this.immunity_dt-y),this.immunity_dt!=0&&[].concat(W(25,25),W(25,75)).indexOf(Math.floor(this.immunity_dt*100%100))>=0?this.flicker=!0:this.flicker=!1;let e=this.getActions(),t={x:0,y:0};if(e.leftpressed&&(this.stagger_dt<=0||!this.onGround())&&(t.x-=this.speed*.15,this.facing_dir=-1),e.rightpressed&&(this.stagger_dt<=0||!this.onGround())&&(t.x+=this.speed*.15,this.facing_dir=1),e.jumppressed&&this.onGround()&&this.stagger_dt<=0?(this.dy=-this.jumpspeed,this.jumping=!0,this.jumping_time=0):this.jumping&&e.jumppressed&&this.jumping_time<this.jumping_max_held&&(this.jumping_time+=y),this.jumping_time>=this.jumping_max_held&&(this.jumping=!1,this.jumping_time=0),this.jumping&&!e.jumppressed&&(this.jumping=!1),e.attackpressed&&this.attack_cd<=0&&this.attack(e),this.dx=j(this.dx+t.x,-this.speed,this.speed),t.x==0&&this.dx!=0){let s=Math.sign(this.dx);s>0?this.dx=Math.max(0,this.dx+-1*s*this.ground_friction):this.dx=Math.min(0,this.dx+-1*s*this.ground_friction),Math.abs(this.dx)<=1&&(this.dx=0)}Math.abs(this.dx)>1?this.playAnimation("walk"):this.playAnimation("idle");var i=M(this,"ground");this.advance(y),i=M(this,"ground"),i.down&&(!this.jumping||this.jumping&&this.jumping_time>=this.jumping_max_held)?(this.ddy=0,this.dy=0,this.jumping=!1,this._lastGroundCheck=!0):i.down?(this.ddy=0,this._lastGroundCheck=!0):this.jumping?(this.ddy=0,this._lastGroundCheck=!1):(this.ddy=K,this._lastGroundCheck=!1)}})},Me=function(e,t){return new z({x:e,y:t,animations:Mt.animations,anchor:{x:.5,y:.5},state_transitions:{idle:[{method:"aiDeltaUpdate",args:[.5]},{method:"toggleHelp"}],wait:[{method:"aiDeltaUpdate",args:[1]},{method:"changeState",args:["move"]}],move:[{method:"aiDeltaUpdate",args:[.5]},{method:"changeState",args:["hug"]}],hug:[{method:"applyGravity"},{method:"clearXMovement"},{method:"playerInRange",args:[8]},{method:"changeState",args:["hearts"]}],hearts:[{method:"aiDeltaUpdate",args:[.5]},{method:"spawnHeart"}]},ai_state:"idle",has_touch_dmg:!1,facing_dir:-1,heart_count:0,initialize:function(){let s=new C({x:-7,y:-6,animations:Ft.animations,anchor:{x:.5,y:.5}});this.addChild(s)},toggleHelp:function(){this.objects[0].visible=!this.objects[0].visible},wait:function(){this.objects[0].visible=!1},win:function(){x.stop(),x.actx.close(),Re()},hearts:function(){this.idle()},spawnHeart:function(){if(this.heart_count>=13){this.win();return}return this.heart_count+=1,this.addChild(new vt({x:0,y:-4,scaleX:.35,scaleY:.35,ttl:120})),!0}})},Vt=function(e,t){return new z({maxHealth:13,curHealth:13,speed:30,defense:.5,x:e,y:t,animations:St.animations,anchor:{x:.5,y:.5},state_transitions:{idle:[{method:"playerInRange",args:[10*h.tilewidth]},{method:"changeState",args:["show_health"]}],show_health:[{method:"changeState",args:["move"]}],move:[{method:"variableAiDeltaUpdate"},{method:"stateChangeRandCheck",args:[0,2,2,"jump_buildup",1,"charge_buildup"]}],jump:[{method:"changeState",args:["move"]}],jump_buildup:[{method:"aiDeltaUpdate",args:[.5]},{method:"changeState",args:["jump"]}],charge_buildup:[{method:"aiDeltaUpdate",args:[.5]},{method:"changeState",args:["charge"]}],charge:[{method:"aiDeltaUpdate",args:[.5]},{method:"changeState",args:["move"]}]},ai_state:"idle",has_touch_dmg:!0,facing_dir:-1,variableAiDeltaUpdate:function(){return this.curHealth>=7?this.aiDeltaUpdate(2):this.aiDeltaUpdate(1)},show_health:function(){F.visible=!0,x.actx.close(),x.song=1},onDeath:function(){F.visible=!1,G.changeState("wait"),x.actx.close(),x.song=0},jump_buildup:function(){this.immunity_dt=.5,this.idle()},charge_buildup:function(){this.immunity_dt=.5,this.playAnimation("charge"),this.clearXMovement(),this.applyGravity(),this.facePlayer()},charge:function(){this.playAnimation("charge"),this.dx=j(this.dx+this.facing_dir*this.speed*3.5,-this.speed*3.5,this.speed*3.5);var s=M(this,"ground");this.advance(y),s=M(this,"ground"),s.down?(this.dy=0,this.ddy=0,this.jumping=!1):this.jumping?this.ddy=0:this.ddy=K}})},Tt=function(e,t,i,s,n,r,o,a){for(let d=0;d<r;d++){let l=a+d;if(!(l<0||l>=i))for(let f=0;f<n;f++){let m=o+f;if(m<0||m>=t)continue;let P=s[f+d*n];P!=0&&(e[m+l*t]=P==-1?0:P)}}},Xt=function(e,t,i,s){for(let n=0;n<i;n++)if(e[s+n*t]!=0)return n;return-1},Kt=function(e,t,i,s,n){for(let r=n-1;r>=0;r--)if(e[s+r*t]!=0)return!1;return!0},Se=function(e,t,i,s,n){let r=[[s,n]],o={},a=[],d=function(l){return"x"+l[0]+"|y"+l[1]};for(;r.length>0;){let l=r.shift();if(o[d(l)]=!0,e[l[0]+l[1]*t]==0){if(Kt(e,t,i,l[0],l[1]))return[];a.push({x:l[0],y:l[1]}),!o[d([l[0]+1,l[1]])]&&e[l[0]+1+l[1]*t]==0&&r.push([[l[0]+1,l[1]]]),!o[d([l[0]-1,l[1]])]&&e[l[0]-1+l[1]*t]==0&&r.push([[l[0]-1,l[1]]]),!o[d([l[0],l[1]+1])]&&e[l[0]+(l[1]+1)*t]==0&&r.push([[l[0],l[1]+1]]),!o[d([l[0],l[1]-1])]&&e[l[0]+(l[1]-1)*t]==0&&r.push([[l[0],l[1]-1]])}}return a},Ee=function(e=160,t=24){let i=[0,1,1,4,4,7,7],s=[3,6,9,2,5,8],n=[1,4,7,3,6,9],r=[1,4,7,3,6,9,2,5,8],o=[10],a=[];for(let f=0;f<t;f++)for(let m=0;m<e;m++)f==t-1||m==0||m==e-1?a.push(o[0]):f<=t/3?a.push(0):f<=t*4/9?a.push(i[k(0,i.length-1)]):f<=t*5/9?a.push(n[k(0,n.length-1)]):f<=t*7/9?a.push(r[k(0,r.length-1)]):a.push(s[k(0,s.length-1)]);for(let f=0;f<13;f++){let m=k(1,e-25);Tt(a,e,t,[0,4,0,1,4,7],3,2,m,t/3-1)}Tt(a,e,t,[-1,-1,-1,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,-1,-1,-1,-1,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,-1,-1,10,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,-1,10,10,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],24,5,e-25,t/3-3);let d=Xt(a,e,t,1);for(let f=2;f<e-25;f++){let m=Xt(a,e,t,f);for(;d-m>2;)a[f-1+(d-1)*e]=n[k(0,n.length-1)],d-=1;for(;m-d>2;)a[f+(m-1)*e]=n[k(0,n.length-1)],m-=1;d=m}for(let f=t/3;f<=t*4/9;f++)for(let m=1;m<e-1;m++)a[m+f*e]==0&&!Kt(a,e,t,m,f)&&Se(a,e,t,m,f).forEach(E=>{a[E.x+E.y*e]=n[k(0,n.length-1)]});return new yt({tilewidth:8,tileheight:8,width:e,height:t,playerSpawn:{x:100,y:40},tilesets:[{firstgid:1,image:v["./assets/tiles_8x8.png"]}],layers:[{name:"ground",data:a}]})},st=function(e,t=0,i=16,s=!0,n=!1,r=!0){let o={x:t,y:i,healthChildren:[],rageChildren:[],visible:s,addHChild:function(a){this.healthChildren.push(a)},addRChild:function(a){this.rageChildren.push(a)},update:function(){this.x=(p.width-e.maxHealth*8)/2/u,this.healthChildren.forEach((a,d)=>{e.curHealth>d?a.playAnimation("filled"):a.playAnimation("empty")}),this.rageChildren.forEach((a,d)=>{e.curRage>d?a.color="#ff6361":a.color="#00202e"})},render:function(){this.visible&&(c.save(),(this.x||this.y)&&c.translate(this.x,this.y),this.healthChildren.forEach(a=>a.render()),this.rageChildren.forEach(a=>a.render()),c.restore())}};for(let a=0;a<e.maxHealth;a++)o.addHChild(new C({x:(a+1-e.maxHealth/2)*8,y:0,width:8,height:8,anchor:{x:.5,y:.5},animations:at.animations,flicker:n}));for(let a=0;a<e.maxRage;a++)o.addRChild(new C({x:(a+1-e.maxRage/2)*5,y:9,width:4,height:4,anchor:{x:.5,y:.5},color:"#00202e",flicker:n}));return o},jt=function(){return new U({song:0,update:function(){for(let e=0;e<h.objects.length;e++)h.objects[e].update();h.sx=Math.round(g.x)-p.width/2/u,h.xy=Math.round(g.y)-p.height/2/u,De(),it.update(),F.update(),this.soundId||(this.soundId=setInterval((()=>{if(this.isStopped){clearInterval(this.soundId);return}this.song==0?this.actx=D([[0,17],[2,18],[4,19],[6,20],[8,20],[10,19],[12,18],[14,17],[18,6],[20,5],[22,4],[24,3],[26,3],[28,4],[30,5],[32,6]],400,.19,.18,.005,.1,.1,""):this.actx=D([[0,21],[1,20],[2,19],[3,18],[4,18],[5,19],[6,20],[7,21],[8,21],[12,18],[9,21],[10,20],[11,19],[13,18],[14,19],[15,20],[16,21],[17,21],[18,21],[19,20],[20,19],[21,18],[22,18],[23,19],[24,20],[25,21],[26,21],[27,21],[28,20],[29,19],[30,18],[31,18],[32,19],[33,20],[34,21],[35,21]],400,.19,.18,.005,.1,.1,"")}).bind(this),3500))},renderInside:function(){c.save(),(h.x||h.y)&&c.translate(h.x|0,h.y|0),h.render(),it.render(),F.render(),c.restore()}})},be=function(){S=[],h=Ee();let e=Math.max(0,p.height-480)/2/u;h.y=e,h.x=0,g=Ae(),g.x=h.playerSpawn.x,g.y=h.playerSpawn.y,G=Me((160-2.5)*h.tilewidth,20),b=Vt((160-1.5)*h.tilewidth,20),h.add(g),h.add(G),h.add(b),S.push(b),it=st(g),F=st(b,0,448/u,!1,!0),x=jt(),x.start()},Pe=function(){S=[],g.curHealth=g.maxHealth,g.curRage=0,g.x=h.playerSpawn.x,g.y=h.playerSpawn.y,G.x=(160-2.5)*h.tilewidth,G.y=20,b=Vt((160-1.5)*h.tilewidth,20),h.objects=[],h.add(g),h.add(G),h.add(b),S.push(b),it=st(g),F=st(b,0,448/u,!1,!0),x=jt(),x.start()},kt=function(){let e=new C({image:v["./assets/logo.png"],anchor:{x:.5,y:.5},scaleX:2,scaleY:2});w.playAnimation("sword");let t={text:"press <space> to start",anchor:{x:.5,y:.5},font:"12px Courier New",color:"#ff8531",alpha:255,_dt:0,render:V,update:function(){this._dt+=y,Math.floor(this._dt%2)==1?this.alpha=Math.max(0,this.alpha-2):this.alpha=Math.min(255,this.alpha+2),this.color="#ff8531"+this.alpha.toString(16)}};x=new U({update:function(){t._dt>=.75&&A("Space")&&(this.stop(),be()),t.update(),t._dt>=15&&(this.stop(),qt())},renderInside:function(){w.x=p.width/2/u,w.y=_+240/u+32,w.render(),e.x=p.width/2/u,e.y=_+50,e.render(),t.x=p.width/2/u,t.y=_+420/u,t.render()}}),x.start()},qt=function(){let e={dt:0,update:function(){this.dt+=y}};w=new C({width:61,height:84,scaleX:2,scaleY:2,anchor:{x:.5,y:.5},animations:$t.animations});let t={text:"Hey babe, I'm back...",anchor:{x:.5,y:.5},font:"12px Courier New",color:"#ff8531",render:V},i=new C({width:18,height:20,scaleX:2,scaleY:2,animations:Wt.animations});x=new U({update:function(){e.update(),A("Space")&&(this.stop(),kt())},scenes:[[3,function(){w.x=p.width/2/u,w.y=_+240/u+42,w.render(),t.x=p.width/2/u,t.y=_+420/u,t.render()}],[5,function(){w.x=p.width/2/u,w.y=_+240/u+42,w.render(),i.x=p.width/2/u,i.y=_+20,i.render()}],[6,function(){w.x=p.width/2/u,w.y=_+240/u+42,w.render(),t.x=p.width/2/u,t.y=_+420/u,t.text="No...",t.render(),i.x=p.width/2/u,i.y=_+20,i.render()}],[7,function(){w.x=p.width/2/u,w.y=_+240/u+42,w.render(),t.x=p.width/2/u,t.y=_+420/u,t.text="No...no...",t.render(),i.x=p.width/2/u,i.y=_+20,i.render()}],[10,function(){w.x=p.width/2/u,w.y=_+240/u+42,w.render(),t.x=p.width/2/u,t.y=_+420/u,t.text="No...no...NO!!!",t.render(),i.x=p.width/2/u,i.y=_+20,i.render()}],[15,function(){w.x=p.width/2/u,w.playAnimation("sword"),w.y=_+240/u+32,i.x=p.width/2/u,i.y=_+20,i.render(),w.render(),t.text=`The 13 took her...
I'll make them regret it.`,t.x=p.width/2/u,t.y=_+360/u,t.render()}],[15,function(){x.stop(),kt()}]],renderInside:function(){this.scenes.length!=0&&(e.dt<this.scenes[0][0]?this.scenes[0][1]():(this.scenes.shift(),!this.scenes.length==0&&this.scenes[0][1]()))}}),x.start()},Re=function(){let e=new C({width:1,height:1,dt:0,update:function(t=y){this.advance(t),this.dt+=t}});e.addChild({text:"You Win.",x:0,y:61,anchor:{x:.5,y:.5},font:"8px Courier New",color:"#ff8531",render:V}),[{anim:0,sheet:I,name:"Duckie"},{anim:1,sheet:I,name:"Pogo"},{anim:2,sheet:I,name:"Snakes"},{anim:3,sheet:I,name:"Bert"},{anim:0,sheet:[St],name:"The Bull"},{anim:0,sheet:[At],name:"You"},{anim:0,sheet:[Mt],name:"May"}].forEach((t,i)=>{e.addChild(new z({x:0,y:(i+3)*32,animations:t.sheet[t.anim].animations,anchor:{x:0,y:.5},state_transitions:{wait:[]},ai_state:"wait",update:function(s=y){this.advance(s)}})),e.addChild({text:t.name,x:-2.5*c.measureText(t.name).width/u,y:(i+3)*32-3,anchor:{x:.5,y:.5},font:"8px Courier New",color:"#ff8531",render:V})}),e.addChild({text:"Thank You for Playing!",x:0,y:349,anchor:{x:.5,y:.5},font:"8px Courier New",color:"#ff8531",render:V}),x=new U({update:function(){e.update(),e.dt>=.75&&A("Space")&&(this.stop(),kt())},renderInside:function(){e.x=p.width/2/u,e.y=_+Math.max(e.dt*-10,-293),e.render()}}),x.start()},nt=function(e,t){let i=[{x:e.world.x-e.world.width*e.anchor.x*e.world.scaleX,y:e.world.y-e.world.height*e.anchor.y*e.world.scaleY},{x:e.world.x+e.world.width*(1-e.anchor.x)*e.world.scaleX,y:e.world.y+e.world.height*(1-e.anchor.y)*e.world.scaleY}],s=[{x:t.world.x-t.world.width*t.anchor.x*t.world.scaleX,y:t.world.y-t.world.height*t.anchor.y*t.world.scaleY},{x:t.world.x+t.world.width*(1-t.anchor.x)*t.world.scaleX,y:t.world.y+t.world.height*(1-t.anchor.y)*t.world.scaleY}];return s[T].x>i[X].x||s[X].x<i[T].x||s[T].y>i[X].y||s[X].y<i[T].y?null:s},et=function(e,t,i,s){let n=h.layerMap[s],r={x:e*h.tilewidth,y:t*h.tileheight};return n.data[e+t*h.width]!=0?nt(i,{world:{x:e*h.tilewidth,y:t*h.tileheight,width:h.tilewidth,height:h.tileheight,scaleX:1,scaleY:1},anchor:{x:0,y:0}}):null},M=function(e,t){let i={c:ye(e.x),r:we(e.y)},s=et(i.c-1,i.r,e,t),n=et(i.c+1,i.r,e,t),r=et(i.c,i.r-1,e,t),o=et(i.c,i.r+1,e,t),a={left:!1,right:!1,up:!1,down:!1,left_tpos:{c:i.c-1,r:i.r},right_tpos:{c:i.c+1,r:i.r},up_tpos:{c:i.c,r:i.r-1},down_tpos:{c:i.c,r:i.r+1}};return s&&(e.x=s[X].x+e.width*(1-e.anchor.x)*e.scaleX,Math.sign(e.dx)<0&&(e.dx=0),e.ddx=0,a.left=!0),n&&(e.x=n[T].x-e.width*(1-e.anchor.x)*e.scaleX,Math.sign(e.dx)>0&&(e.dx=0),e.ddx=0,a.right=!0),o&&(e.y=o[T].y-e.height*(1-e.anchor.y)*e.scaleY,e.jumping||(e.dy=0),e.ddy=0,a.down=!0),r&&(e.y=r[X].y+e.height*(1-e.anchor.y)*e.scaleY,e.dy=0,e.ddy=0,a.up=!0),e.y<0&&(e.y=0),e.y>h.height*h.tileheight&&(e.y=h.height*h.tileheight),e.x<0&&(e.x=0),e.x>h.width*h.tilewidth&&(e.x=h.width*h.tilewidth),a},Ie=10,S=[],Gt=160,De=function(){if(S.length>=Ie)return;let e=k(h.tilewidth,(h.width-25)*h.tilewidth);e-g.x>=0?e=Math.min(e+Gt,(h.width-26)*h.tilewidth):e=Math.max(e-Gt,h.tilewidth);let t=k(0,I.length-1),i=new z({x:e,y:40,animations:I[t].animations,anchor:{x:.5,y:.5},state_transitions:[{idle:[{method:"aiDeltaUpdate",args:[3]},{method:"stateChangeRandCheck",args:[0,1,1,"move"]}],move:[{method:"aiDeltaUpdate",args:[2]},{method:"stateChangeRandCheck",args:[0,1,1,"idle"]}]},{idle:[{method:"facePlayer"},{method:"aiDeltaUpdate",args:[3]},{method:"stateChangeRandCheck",args:[0,2,2,"move",1,"jump"]}],move:[{method:"aiDeltaUpdate",args:[2]},{method:"stateChangeRandCheck",args:[0,2,2,"idle",1,"jump"]}],jump:[{method:"changeState",args:["move"]}]},{idle:[{method:"facePlayer"},{method:"aiDeltaUpdate",args:[3]},{method:"stateChangeRandCheck",args:[0,1,1,"move"]}],move:[{method:"aiDeltaUpdate",args:[2]},{method:"stateChangeRandCheck",args:[0,1,1,"idle"]}]},{idle:[{method:"facePlayer"},{method:"aiDeltaUpdate",args:[3]},{method:"stateChangeRandCheck",args:[0,1,1,"move"]}],move:[{method:"facePlayer"},{method:"aiDeltaUpdate",args:[2]},{method:"stateChangeRandCheck",args:[0,1,1,"idle"]}]}][t],ai_state:"move"});h.add(i),S.push(i)};Lt("./assets/tiles_8x8.png","./assets/characters.png","./assets/explosion.png","./assets/logo.png","./assets/silhouette.png").then(function(){zt=R({image:v["./assets/explosion.png"],frameWidth:16,frameHeight:16,animations:{explode:{frames:[0,1,2,3],frameRate:8,loop:!1}}}),at=R({image:v["./assets/tiles_8x8.png"],frameWidth:8,frameHeight:8,animations:{filled:{frames:[10],frameRate:1},empty:{frames:[11],frameRate:1}}});let e=[{walk:[0,1,2,3],idle:[1]},{walk:[5,6,7,8],idle:[6]},{walk:[10,11,12,13],idle:[11]},{walk:[20,21,22,23],idle:[21]},{walk:[25,26,27,28],idle:[26],charge:[29]},{walk:[4,9,14,19],idle:[9,24]},{walk:[15,16],idle:[15,16]}].map(t=>R({image:v["./assets/characters.png"],frameWidth:4,frameHeight:8,animations:{walk:{frames:t.walk,frameRate:4},idle:{frames:t.idle,frameRate:1},charge:{frames:t.charge||[0],frameRate:1,loop:!1}}}));At=e[5],Mt=e[6],St=e[4],I=e.slice(0,4),Ft=R({image:v["./assets/characters.png"],frameWidth:8,frameHeight:8,animations:{default:{frames:[7],frameRate:1,loop:!1}}}),Wt=R({image:v["./assets/logo.png"],frameWidth:18,frameHeight:20,animations:{default:{frames:[0],frameRate:1}}}),$t=R({image:v["./assets/silhouette.png"],frameWidth:61,frameHeight:84,animations:{default:{frames:[1],frameRate:1},sword:{frames:[0],frameRate:1}}}),qt()});})();
