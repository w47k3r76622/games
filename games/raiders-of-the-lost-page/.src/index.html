<!DOCTYPE html><html><head><meta charset="utf-8"><title>Raiders of the Lost Page</title><style>.btn{border:none;background-color:transparent;border:1px solid #de02a7;padding:10px;border-radius:10px;color:#fd36ca;font-weight:500;font-size:1.01rem}.pause-btn{font-weight:800}.cc{z-index:9999}ul.menu{z-index:9999;list-style:none;padding-left:0;margin:auto;width:400px;position:absolute;top:30%;left:calc(50% - 200px)}ul.menu li{width:100%;display:block;margin:10px}ul.menu li button{width:200px;margin:auto;display:block}#tutorial{display:none;position:absolute;margin:auto;left:3%;height:90%;top:3%;width:90%;background-color:transparent;color:rgba(255,255,255,.8);padding:2%}#tutorial .tutorial-intro{text-align:center;margin:2rem 0}#tutorial .tutorial-intro:first-child{font-size:1.1em;font-style:italic}#tutorial ul li{list-style:none;display:flex;margin-bottom:10px;align-items:center}#tutorial canvas{border:1px solid #0f0;margin:0 20px}#esc-tutorial{margin:120px auto 0 auto;width:200px;display:block}body{background-color:#000;font-family:Arial,Helvetica,sans-serif}em{font-style:normal;color:#de02a7}h1{text-align:center;font-family:arial;display:inline-block;position:absolute;top:1em;font-size:4em;color:#de02a7;width:100%;-webkit-text-fill-color:#000;-webkit-text-stroke-width:2px;-webkit-text-stroke-color:#de02a7;filter:drop-shadow(0 0 .1rem #de02a7)}h1 em{-webkit-text-fill-color:#000;-webkit-text-stroke-width:2px;-webkit-text-stroke-color:#00d5ff;filter:drop-shadow(0 0 .1rem #00d5ff)}.sc{position:relative;margin:auto;margin-top:0}#stage{border:1px solid #000;position:absolute;top:0;background-color:rgba(204,204,204,.2);border:1px solid #0f0}.congratulations{border:1px solid #000;text-align:center;z-index:999999;top:0;margin:auto;color:#13e880;background-color:rgba(0,0,0,.1);display:none;flex-direction:column}.congratulations p{display:block;font-size:30px;font-weight:700}.congratulations button{margin-top:4em}.fls{border:1px solid #de02a7;position:absolute;width:100%;height:100%;display:none;align-items:center;justify-content:center}.fls p{display:block;font-size:30px;font-weight:700}.you-died-screen{text-align:center;z-index:999999;top:0;background-color:rgba(0,0,0,.1);opacity:0;color:#de02a7}.gameover-menu{text-align:center;z-index:999999;top:0;background-color:rgba(0,0,0,.1);opacity:0;color:rgba(0,213,255,.5);flex-direction:column}.gameover-menu p:first-child{color:rgba(21,2,53,.8);filter:drop-shadow(0 0 .1rem #00d5ff);font-size:4em;font-weight:600;margin:0}.gameover-menu p{font-size:.8em;margin:5em 0}.loading{border:1px solid #de02a7;text-align:center;z-index:999999;top:0;background-color:#000;opacity:1;display:flex;color:#de02a7}.fade-in-out{animation:fadeInOut ease 3s forwards;-webkit-animation:fadeInOut ease 3s forwards;-moz-animation:fadeInOut ease 3s forwards;-o-animation:fadeInOut ease 3s forwards;-ms-animation:fadeInOut ease 3s forwards}.fade-in-out-ff{animation:fadeInOut ease 3s infinite;-webkit-animation:fadeInOut ease 3s infinite;-moz-animation:fadeInOut ease 3s infinite;-o-animation:fadeInOut ease 3s infinite;-ms-animation:fadeInOut ease 3s infinite}.delay-1{animation-delay:250ms}.delay-2{animation-delay:750ms}@keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-moz-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-webkit-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-o-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-ms-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}.fade-in{animation:fadeIn ease 3s;-webkit-animation:fadeIn ease 3s;-moz-animation:fadeIn ease 3s;-o-animation:fadeIn ease 3s;-ms-animation:fadeIn ease 3s}@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-moz-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-webkit-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-o-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-ms-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}.fade-out{animation:fadeIn ease 1s forwards;-webkit-animation:fadeIn ease 1s forwards;-moz-animation:fadeIn ease 1s forwards;-o-animation:fadeIn ease 1s forwards;-ms-animation:fadeIn ease 1s forwards}@keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-moz-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-webkit-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-o-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-ms-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}body{margin:0;padding:0}.btn{border:none;background-color:transparent;border:1px solid #de02a7;padding:10px;border-radius:10px;color:#fd36ca;font-weight:500;font-size:1.01rem}.pause-btn{font-weight:800}.cc{z-index:9999}ul.menu{z-index:9999;list-style:none;padding-left:0;margin:auto;width:400px;position:absolute;top:30%;left:calc(50% - 200px)}ul.menu li{width:100%;display:block;margin:10px}ul.menu li button{width:200px;margin:auto;display:block}#tutorial{display:none;position:absolute;margin:auto;left:3%;height:90%;top:3%;width:90%;background-color:transparent;color:rgba(255,255,255,.8);padding:2%}#tutorial .tutorial-intro{text-align:center;margin:2rem 0}#tutorial .tutorial-intro:first-child{font-size:1.1em;font-style:italic}#tutorial ul li{list-style:none;display:flex;margin-bottom:10px;align-items:center}#tutorial canvas{border:1px solid #0f0;margin:0 20px}#esc-tutorial{margin:120px auto 0 auto;width:200px;display:block}body{background-color:#000;font-family:Arial,Helvetica,sans-serif}em{font-style:normal;color:#de02a7}h1{text-align:center;font-family:arial;display:inline-block;position:absolute;top:1em;font-size:4em;color:#de02a7;width:100%;-webkit-text-fill-color:#000;-webkit-text-stroke-width:2px;-webkit-text-stroke-color:#de02a7;filter:drop-shadow(0 0 .1rem #de02a7)}h1 em{-webkit-text-fill-color:#000;-webkit-text-stroke-width:2px;-webkit-text-stroke-color:#00d5ff;filter:drop-shadow(0 0 .1rem #00d5ff)}.sc{position:relative;margin:auto;margin-top:0}#stage{border:1px solid #000;position:absolute;top:0;background-color:rgba(204,204,204,.2);border:1px solid #0f0}.congratulations{border:1px solid #000;text-align:center;z-index:999999;top:0;margin:auto;color:#13e880;background-color:rgba(0,0,0,.1);display:none;flex-direction:column}.congratulations p{display:block;font-size:30px;font-weight:700}.congratulations button{margin-top:4em}.fls{border:1px solid #de02a7;position:absolute;width:100%;height:100%;display:none;align-items:center;justify-content:center}.fls p{display:block;font-size:30px;font-weight:700}.you-died-screen{text-align:center;z-index:999999;top:0;background-color:rgba(0,0,0,.1);opacity:0;color:#de02a7}.gameover-menu{text-align:center;z-index:999999;top:0;background-color:rgba(0,0,0,.1);opacity:0;color:rgba(0,213,255,.5);flex-direction:column}.gameover-menu p:first-child{color:rgba(21,2,53,.8);filter:drop-shadow(0 0 .1rem #00d5ff);font-size:4em;font-weight:600;margin:0}.gameover-menu p{font-size:.8em;margin:5em 0}.loading{border:1px solid #de02a7;text-align:center;z-index:999999;top:0;background-color:#000;opacity:1;display:flex;color:#de02a7}.fade-in-out{animation:fadeInOut ease 3s forwards;-webkit-animation:fadeInOut ease 3s forwards;-moz-animation:fadeInOut ease 3s forwards;-o-animation:fadeInOut ease 3s forwards;-ms-animation:fadeInOut ease 3s forwards}.fade-in-out-ff{animation:fadeInOut ease 3s infinite;-webkit-animation:fadeInOut ease 3s infinite;-moz-animation:fadeInOut ease 3s infinite;-o-animation:fadeInOut ease 3s infinite;-ms-animation:fadeInOut ease 3s infinite}.delay-1{animation-delay:250ms}.delay-2{animation-delay:750ms}@keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-moz-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-webkit-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-o-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}@-ms-keyframes fadeInOut{0%{opacity:0}25%{opacity:1}100%{opacity:0}}.fade-in{animation:fadeIn ease 3s;-webkit-animation:fadeIn ease 3s;-moz-animation:fadeIn ease 3s;-o-animation:fadeIn ease 3s;-ms-animation:fadeIn ease 3s}@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-moz-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-webkit-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-o-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}@-ms-keyframes fadeIn{0%{opacity:0}100%{opacity:1}}.fade-out{animation:fadeIn ease 1s forwards;-webkit-animation:fadeIn ease 1s forwards;-moz-animation:fadeIn ease 1s forwards;-o-animation:fadeIn ease 1s forwards;-ms-animation:fadeIn ease 1s forwards}@keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-moz-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-webkit-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-o-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}@-ms-keyframes fadeOut{100%{opacity:0}0%{opacity:1}}</style></head><body><div id="s-c" class="sc"><div id="pmc" class="cc"><button role="button" id="play-pause-btn" class="btn pause-btn">| |</button></div><div id="game-over-menu" class="cc gameover-menu fls"><p>Game Over</p><p>It's not the years, honey, it's the mileage.</p><button role="button" id="restart-btn-died" class="btn restart-btn">Back to main menu</button></div><div id="tutorial" class="cc"><p class="tutorial-intro">Welcome young <em>Browser</em>, are you ready to start this incredible quest?</p><p class="tutorial-intro">You will search the whole <em>Empire of the Internet</em> for the lost <em>Lost Pages</em>; but be aware, because enemies lurk in the shadows....</p><ul><li><canvas id="tutorial-404-canvas" width="40" height="40"></canvas><div>Collect all the <em>404 Pages</em> around the maze.</div></li><li><canvas id="tutorial-exit-close" width="40" height="40"></canvas><div>Each maze has at least one <em>204 Gate.</em></div></li><li><canvas id="tutorial-exit-open" width="40" height="40"></canvas><div>Once you have collected all the pages, the gate will open becoming a <em>200 Gate</em> that will bring you ouside the maze.</div></li><li><canvas id="tutorial-enemy-canvas" width="40" height="40"></canvas><div>Stay away from the <em>401 Guardians</em>, if you come too close they will start chasing you.</div></li><li><canvas id="tutorial-auth" width="40" height="40"></canvas><div>If you pick up a magic <em>Authentication Flower</em>, enemies will not bother you for few seconds.</div></li></ul><p class="tutorial-intro">Do not waste time, every second is important, as the <em>Mighty Indexer</em> will consume all the wall of the maze wall by wall</p><button role="button" id="esc-tutorial" class="btn">I'm ready</button></div><div id="mm-container" class="cc"><h1>R<em>4</em>iders of the L<em>0</em>st P<em>4</em>ge</h1><ul class="menu"><li><button role="button" id="mm-start" class="btn">Start New Game</button></li><li><button role="button" id="mm-continue" class="btn">Continue</button></li><li><button role="button" id="mm-continue-max" class="btn">Load last level</button></li><li><button role="button" id="mm-how-to" class="btn">How to play</button></li><li><button role="button" id="main-screen-size" class="btn">Change screen size</button></li><li><button role="button" id="mm-sound" class="btn"></button></li></ul></div><div id="congrats-screen" class="congratulations fls"><p>Congratulations!</p><p>It belongs in a museum!</p><button role="button" id="restart-btn-finished" class="btn restart-btn">Back to main menu</button></div><div class="you-died-screen fls"><p>Snakes. Why'd it have to be snakes?</p></div><div id="loading" class="loading fls"><p>loading<span class="fade-in-out-ff">.</span><span class="fade-in-out-ff delay-1">.</span><span class="fade-in-out-ff delay-2">.</span></p></div><canvas id="stage"></canvas></div><!-- init js --><script type="text/javascript">const oth=[];for(let t=0;t<100;t++){const e=Math.floor(t/10),n=t%10;let a=50;a=e<3?50:e<5?100:e<8?100:200;let r=Math.ceil(Math.ceil(t/10));t>20?r+=Math.floor(2*Math.random()):t>40?r+=Math.floor(2*Math.random())+2:t>100&&(r+=Math.floor(3*Math.random())+5);const o={cols:a,rows:a,entities:{404:{n:Math.ceil(Math.ceil(t/10)/2)+n},exit:{n:1},401:[],auth:{n:Math.floor(5*Math.random())+n}}};for(let t=0;t<r;t++){const e={n:n,speed:Math.min(5,Math.max(2,t)),updatePathEvery:15,maxDist:400,maxPath:200+75*t};o.entities[401].push({...e})}oth.push({...o})}const levels=[...oth],unlockedLevels=0,startingLives=3,tileSize=10;function initGameState(){const t=d1("#loading"),e=parseInt(localStorage.getItem("obi_serra_rotlp_maxLev")||"0",10),n=[viewportDims(),[1200,700],[800,600]],a=createState({audio:!0,d5Fps:!0,unlockedLevels:unlockedLevels,screenSizeAv:n,screenSize:n[0],maxReached:e,currentScreenSize:0,levels:levels,tileSize:tileSize,player:{lives:startingLives},loadingLetters:[]}),r=d1("#stage");return setStageDim(r,d1("#s-c"),n[0][0],n[0][1]),a.setState("canvas",r),a.setState("ctx",r.getContext("2d")),d2(t),a}function loadEntities(t){const e={404:create404Entity,auth:createAuthEntity,401:create401Entity,exit:createExitEntity};return t.map(t=>"function"==typeof e[t.type]?e[t.type]({...t}):null).filter(t=>!!t)}function loadLevel(t={},e=0){return n=>{const{canvas:a,maxReached:r}=n.gbk(["canvas","maxReached"]),o=d1("#loading");return n.updateGameStatus("loading"),d5(o,"flex"),setTimeout(()=>{const s=setVOF(generateMap(t.cols||100,t.rows||100,tileSize),a.width,a.height);n.setState("map",{...s,...generateMaze(s,n)});const i=gp2(n),l=loadEntities(generateEntities(n,n.getState("map"),t.entities)),c={resetPct:90,groupPct:60,wPct:40,nextT:600,nextRand:300,nextMin:200};d2(o);const d=Math.max(r,e);localStorage.setItem("obi_serra_rotlp_maxLev",d),n.updateGameStatus("play").updateState(t=>({...t,currentLevel:e,player:{...i,equip:{}},entities:[...l],levelConfig:c,maxReached:d}))},100),n}}function initGame(){const t=initGameState(),e=d1("#loading");t.updateGameStatus("init"),t.removeAllCtrls(),gameControllers(t);const n=t=>{const{currentLevel:e,levels:n}=t.gbk(["currentLevel","levels"]);if(e<n.length-1){const a=e+1;loadLevel(n[a],a)(t)}else t.updateGameStatus("finished")};t.updateState(t=>({...t,newLevel:n}));const a=t=>{t.updateState(t=>({...t,player:{lives:startingLives},entities:[]})),t.updateGameStatus("init")},r=initPauseMenu(t),o=initMainMenu(t,loadLevel(levels[0]),levels.map(loadLevel),a),s=initGameOverMenu(t,a);return d2(e),t.updateState(t=>({...t,menus:{pause:r,main:o,gameover:s}})),t}function a1(){const t={},e=new AudioContext;return t.context=e,t.masterGainNode=e.createGain(),t.masterGainNode.connect(e.destination),t}const notes=[{C:130.81,"C#":138.59,D:146.83,"D#":155.56,E:164.81,F:174.61,"F#":185,G:196,"G#":207.65,A:220,"A#":233.08,B:246.94},{C:261.63,"C#":277.18,D:293.66,"D#":311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,"A#":466.16,B:493.88}];function a2(t){const e=t.replace(/.*([0-9]+).*/g,"$1"),n=t.replace(/[0-9]/gi,""),a=notes[parseInt(e)][n];if(void 0!==a)return a;console.error(`Note ${t} not valid`)}function a3(t,e={}){const n={note:"A4",duration:.05,volume:.3,oscillator:"square",...e};if(n.note){const e=t.getState("audioCtrl"),{context:a,masterGainNode:r}=e;r.gain.setValueAtTime(n.volume,a.currentTime);const o=a.createOscillator(),s=a2(n.note);o.type=n.oscillator,o.frequency.setValueAtTime(s,a.currentTime),o.connect(a.destination),o.start(),o.stop(a.currentTime+n.duration)}return new Promise(t=>setTimeout(t,1e3*n.duration))}function createController(t={}){return{...t}}function addEventListener(t,e,n,a){t.updateState(r=>{const o=r.evts||{};removeEventListener(n,t);const s={};return s[n]=(n=>a(n,e,t)),document.addEventListener(n,s[n]),{...r,evts:{...o,...s}}})}function removeEventListener(t,e){e.updateState(e=>{const n=e.evts||{};return n[t]&&"function"==typeof n[t]&&(document.removeEventListener(t,n[t]),delete n[t]),{...e,evts:{...n}}})}function d1(t,e=document){return e.querySelector(t)}function d2(t){if(!t)return!1;t.style.display="none"}function hasClass(t,e){return!!t&&(t.classList?t.classList.contains(e):new RegExp("\\b"+e+"\\b").test(t.className))}function d3(t,e){if(!t)return!1;t.classList?t.classList.add(e):hasClass(t,e)||(t.className+=" "+e)}function d4(t,e){if(!t)return!1;t.classList?t.classList.remove(e):t.className=t.className.replace(new RegExp("\\b"+e+"\\b","g"),"")}function d5(t,e="block"){if(!t)return!1;t.style.display=e}function viewportDims(){return[document.documentElement.clientWidth-50,document.documentElement.clientHeight-50]}function setStageDim(t,e,n=800,a=600){return e.style.width=`${n}px`,e.style.height=`${a}px`,t.width=n,t.height=a,t}const loopSpeed=Math.round(1e3/75);function calcblk(t,e){const n={t:!1,r:!1,b:!1,l:!1},a=t.reduce((t,e)=>((void 0===t.tr||e.r>t.tr)&&(t.tr=e.r),(void 0===t.br||e.r<t.br)&&(t.br=e.r),(void 0===t.tc||e.c>t.tc)&&(t.tc=e.c),(void 0===t.bc||e.c<t.bc)&&(t.bc=e.c),t),{}),r=[a.bc-1,a.bc,a.tc+1,a.tc],o=[a.br-1,a.br,a.tr+1,a.tr];for(const t of r)for(const a of o){const s=e.getTile(t,a),i=isBorder(t,a,e.cols,e.rows);(s>0||i)&&(a!==o[0]||t!==r[1]&&t!==r[3]||(n.t=!0),a!==o[2]||t!==r[1]&&t!==r[3]||(n.b=!0),t!==r[0]||a!==o[1]&&a!==o[3]||(n.l=!0),t!==r[2]||a!==o[1]&&a!==o[3]||(n.r=!0))}return n}function elTiles(t,e){const n=t.ps.x/e.tsize,a=t.ps.y/e.tsize,r=[],o=Math.max(Math.round(t.r/e.tsize),1);for(let t=-o;t<o;t++)for(let e=-o;e<o;e++)r.push({c:Math.round(n+t),r:Math.round(a+e)});return r}const chance=t=>Math.floor(100*Math.random())<=t,updateWalls=(t,e)=>{const{mazepath:n}=t.gbk(["mazepath"]);for(const t in n)if(n.hasOwnProperty(t)){const e=reverseDirs(n[t]);n[t]=[...n[t],...e.filter(()=>chance(10))]}mazeBorders(e,n,e.sf),clearCenterMap(e,[Math.floor(e.cols/2),Math.floor(e.rows/2),10]),t.setState("mazepath",n)};function gameLoop(t){const e=t.getState("tick",0),n=+new Date,a=n-t.getState("lastTime",+new Date),r=Math.round(1e3/a);if(t.setState("actualFps",r),t.setState("tick",e+1),"play"===t.gameStatus()){let{player:n,map:a,levelConfig:r}=t.gbk(["player","map","levelConfig"]);if(n&&a){const o={c:n.ps.x/a.tsize,r:n.ps.y/a.tsize};if(n.currentTile=o,t.updateState(t=>({...t,map:{...t.map,centerTile:o}})),r&&e>r.nextT){const e=Math.floor(Math.random()*r.nextRand)+r.nextMin;t.setState("levelConfig",{...r,nextT:e}),t.setState("walls",updateWalls(t,a,r)),t.setState("tick",0)}(n=n.run(t,n)).currentTiles=elTiles(n,a),n.blk=calcblk(n.currentTiles,a),t.setState("player",n)}t.updateState(e=>({...e,entities:e.entities.map(e=>("function"==typeof e.run&&(e=e.run(t,e)),e&&(e.currentTiles=elTiles(e,a),e.blk=calcblk(e.currentTiles,a)),e)).filter(t=>!!t)}));const o=[...t.getState("entities")||[],t.getState("player")].filter(t=>!!t&&t.currentTiles).map(t=>(t.tilesIds=t.currentTiles.map(t=>"c"+t.c+"r"+t.r),t)).filter(t=>t.collide);for(const e of o)for(const n of o)e.id!==n.id&&e.tilesIds.some(t=>n.tilesIds.indexOf(t)>=0)&&"function"==typeof e.onCollide&&e.onCollide(t,e,n)}t.setState("lastTime",n),setTimeout(()=>gameLoop(t),loopSpeed)}function renderLoop(t){const e=(e,n)=>renderText(t,e,n,"lime",genFont({size:"10px"})),{ctx:n,canvas:a,map:r,player:o,levelConfig:s,tick:i}=t.gbk(["ctx","canvas","map","player","levelConfig","tick"]),l=`status-${t.gameStatus()}`;d4(a,"status-init"),d4(a,"status-play"),d4(a,"status-paused"),d4(a,"status-gameover"),d4(a,"status-died"),d3(a,l);const c=t.getState("lastTimeRender",+new Date),d=+new Date,u=d-c,p=Math.round(1e3/u);if(t.setState("actualFpsRender",p),n){n.clearRect(0,0,a.width,a.height),resetBlur(n);const l=t.gameStatus();if("play"===l&&r&&r.centerTile&&o){const e=r.centerTile,l={x:a.width/2,y:a.height/2},c={x:r.cols*e.c/r.cols*r.tsize,y:r.rows*e.r/r.rows*r.tsize},d={x:l.x-c.x,y:l.y-c.y};if(t.updateState(t=>({...t,map:{...t.map,pov:d}})),s){const t=50,e=i-s.nextT+t;e>=0&&(n.beginPath(),n.rect(0,0,a.width,a.height),n.fillStyle=`rgba(255,255,255, ${e/t})`,n.fill())}renderTiles(t),o&&"function"==typeof o.render&&o.render(t,o);const{startCol:u,endCol:p,startRow:f,endRow:h}=getTilesInView(r);t.getState("entities",[]).forEach(e=>{if("function"==typeof e.render&&e.ps){const n=Math.round(e.ps.x/r.tsize),a=Math.round(e.ps.y/r.tsize);(n>=u&&n<=p||a>=f&&a<=h)&&e.render(t,e,{x:e.ps.x+d.x,y:e.ps.y+d.y})}}),renderArrows(t)}if("loading"!==l){const{menus:n,ctrls:r}=t.gbk(["menus","ctrls"]);for(const e in n)if(n.hasOwnProperty(e)){const a=n[e];"function"==typeof a.render&&a.render(t)}for(const e in r)if(r.hasOwnProperty(e)){const n=r[e];"function"==typeof n.render&&n.render(t)}"play"===t.gameStatus()&&renderHUD(t),e(`${t.getState("actualFps")} FPS`,{x:30,y:a.height-50}),e(`${t.getState("actualFpsRender")} FPSR`,{x:30,y:a.height-35}),o.currentTile&&e(`c: ${o.currentTile.c}, r: ${o.currentTile.r}`,{x:30,y:a.height-20})}}t.setState("lastTimeRender",d),window.requestAnimationFrame(()=>renderLoop(t))}function createEntity(t){return{...{id:1e4*Math.random(),run:(t,e)=>e,render:()=>null},...t}}function removeEntityById(t,e){return{...e,entities:[...e.entities.filter(e=>e.id!==t)]}}const squareNote=t=>({...t,oscillator:"square"}),sectOctave=(t,e)=>`${t}${e}`,soundEnabled=(t,e)=>{if(t.getState("audio"))return e()};function pick404(t){soundEnabled(t,()=>{a3(t,squareNote({note:sectOctave("A",0),duration:.1})).then(()=>a3(t,squareNote({note:sectOctave("B",0),duration:.1}))).then(()=>a3(t,squareNote({note:sectOctave("G",1),duration:.1})))})}function pickExit(t){soundEnabled(t,()=>{a3(t,squareNote({note:sectOctave("A",0),duration:.1})).then(()=>a3(t,squareNote({note:sectOctave("B",0),duration:.1}))).then(()=>a3(t,squareNote({note:sectOctave("C#",1),duration:.1}))).then(()=>a3(t,squareNote({note:sectOctave("F#",1),duration:.1})))})}function lifeLost(t){soundEnabled(t,()=>{a3(t,squareNote({note:sectOctave("F#",1),duration:.1})).then(()=>a3(t,squareNote({note:sectOctave("C#",1),duration:.1}))).then(()=>a3(t,squareNote({note:sectOctave("B",0),duration:.1}))).then(()=>a3(t,squareNote({note:sectOctave("A",0),duration:.2})))})}function gameControllers(t){const e=createController({}),n=(n,a)=>addEventListener(t,e,n,a);n("keydown",(t,e,n)=>{const a=t.key;switch(a){case"ArrowUp":n.setState("moveV","up");break;case"ArrowDown":n.setState("moveV","down");break;case"ArrowLeft":n.setState("moveH","left");break;case"ArrowRight":n.setState("moveH","right");break;case"Escape":"play"===n.gameStatus()?n.updateGameStatus("paused"):"paused"===n.gameStatus()&&n.updateGameStatus("play");break;default:n.setState("key",a)}}),n("keyup",(t,e,n)=>{switch(t.key){case"ArrowUp":case"ArrowDown":n.setState("moveV",null);break;case"ArrowLeft":case"ArrowRight":n.setState("moveH",null);break;default:n.setState("key",null)}}),t.addCtrl("main",e)}const goTo=(t,e)=>{const{map:n,player:a}=t.gbk(["map","player"]),{ps:r,updatePathEvery:o,updatePath:s,maxPath:i,maxDist:l}=e,{auth:c=!1}=a.equip||{};if(c||a.ghost||dstBtw2Pnts(a.ps,r)>l)return e.path=[],e.updatePath=o+1,e;s>o?(e.path=findPath([Math.floor(e.ps.x/n.tsize),Math.floor(e.ps.y/n.tsize)],[Math.floor(a.currentTile.c),Math.floor(a.currentTile.r)],n,i),e.updatePath=0):e.updatePath++;const d=e.path&&e.path[0];if(d){const t=pntBtw2Pnts(r,tileps(d.coord[0],d.coord[1],n.tsize,{x:0,y:0}),e.speed);e.ps=t;const a=tileps(d.coord[0],d.coord[1],n.tsize,{x:0,y:0});Math.abs(Math.floor(t.x)-a.x)<5&&Math.abs(Math.floor(t.y)-a.y)<5&&e.path.splice(0,1)}return e};function movingEntitity(t,e,n,a=20,r=400,o=200){return{start:{...t},steps:[...e],step:0,ps:{...t},speed:n,easingSpeed:150,easingFunc:easeInOutCubic,lastVisited:0,easingTicks:0,direction:0,blk:{t:!1,r:!1,b:!1,l:!1},updatePath:Math.floor(10*Math.random()),updatePathEvery:a,maxDist:r,maxPath:o,run:goTo}}function createEnemyEntity(t){const{ps:e,speed:n=4,steps:a=[],updatePathEvery:r=20,maxDist:o=400,maxPath:s=200}=t;return createEntity({...movingEntitity(e,a,n,r,o,s),r:10,enemy:!0,collide:!0})}function create401Entity(t){const e=createEnemyEntity(t);return{...e,disabled:!1,run:(t,n)=>{const{player:a}=t.gbk(["player"]),{auth:r=!1}=a.equip||{};return r?(n.disabled=!0,n.collide=!1):(n.disabled=!1,n.collide=!0),e.run(t,n)},type:"401",render:render401}}function create404Entity(t){const{ps:e}=t;return createEntity({ps:e,fileType:(()=>{const t=["js","html","css"];return t[Math.round(Math.random()*(t.length-1))]})(),type:"404",r:10,collide:!0,render:render404})}function createExitEntity(t){return createEntity({...t,type:"exit",opened:!1,collide:!1,r:10,render:renderExit,onCollide:(t,e,n)=>{if(n.player&&e.opened){const{newLevel:e}=t.gbk(["newLevel"]);pickExit(t),e(t)}},run:(t,e)=>{return t.getState("entities",[]).some(t=>"404"===t.type)||(e.opened=!0,e.collide=!0),e}})}function createAuthEntity(t){return createEntity({...t,type:"auth",onCollide:()=>!0,collide:!0,r:6,ttl:5,onCollect:t=>({auth:{pickedOn:+new Date,ttl:1e3*t.ttl,rem:1e3*t.ttl,authenticated:!0,run:t=>{const e=+new Date-t.pickedOn;return t.ttl-e<=0?null:{...t,rem:t.ttl-e}}}}),render:renderAuth,run:(t,e)=>{return t.getState("entities",[]).some(t=>"404"===t.type)||(e.opened=!0),e}})}function createMenu(t,e){return e({},t)}function initMainMenu(t,e,n,a){return createMenu(t,(t,r)=>{const o=d1("#mm-container"),s=d1("#mm-start"),i=d1("#mm-continue"),l=d1("#mm-sound"),c=d1("#congrats-screen"),d=d1("#mm-how-to"),u=d1("#main-screen-size"),p=d1("#tutorial"),f=d1("#esc-tutorial"),h=d1("#mm-continue-max");return s.addEventListener("click",t=>{t.preventDefault(),e(r)}),i.addEventListener("click",t=>{t.preventDefault(),r.updateGameStatus("play")}),l.addEventListener("click",t=>{t.preventDefault(),r.setState("audio",!r.getState("audio"))}),d.addEventListener("click",t=>{t.preventDefault(),r.setState("prevState",r.gameStatus()),r.updateGameStatus("tutorial")}),f.addEventListener("click",t=>{t.preventDefault(),r.updateGameStatus(r.getState("prevState"))}),h.addEventListener("click",t=>{t.preventDefault(),n[r.getState("maxReached")](r)}),d1("#restart-btn-finished").addEventListener("click",t=>{t.preventDefault(),"gameover"!==r.gameStatus()&&"finished"!==r.gameStatus()||a(r)}),u.addEventListener("click",t=>{t.preventDefault();const{canvas:e,screenSizeAv:n,currentScreenSize:a}=r.gbk(["canvas","screenSizeAv","currentScreenSize"]);n[0]=viewportDims();const o=(a+1)%n.length;setStageDim(e,d1("#s-c"),n[o][0],n[o][1]),r.updateState(t=>({...t,canvas:e,currentScreenSize:o,screenSizeAv:n,map:setVOF(t.map,e.width,e.height)}))}),renderTutorialEnemy(d1("#tutorial-enemy-canvas")),renderTutorial404(d1("#tutorial-404-canvas")),renderTutorialExitOpen(d1("#tutorial-exit-open")),renderTutorialExitClose(d1("#tutorial-exit-close")),renderTutorialAuth(d1("#tutorial-auth")),{...t,...{render:t=>{const{audio:e,currentLevel:n,maxReached:a}=t.gbk(["audio","currentLevel","maxReached"]);switch(void 0!==n&&(i.innerText=`Continue Level ${n+1}`),a?(d5(h),h.innerText=`Load Level ${a+1}`):d2(h),l.innerText=e?"Disable Sound":"Enable Sound",t.gameStatus()){case"tutorial":d2(i),d2(o),d2(s),d5(p);break;case"paused":d5(i),d5(o),d5(s),d2(p);break;case"init":d2(i),d5(s),d5(o),d2(p),d2(c);break;case"finished":d2(i),d5(c,"flex"),d2(s),d2(o),d2(p);break;case"play":d2(o),d2(c),d2(p);break;default:d2(p),d2(o)}}}}})}function initPauseMenu(t){return createMenu(t,(t,e)=>{const n=d1("#play-pause-btn"),a=d1("#pmc"),r={d5:()=>d5(a),d2:()=>d2(a),el:a,button:n,render:t=>{const e=t.getState("canvas");a.style.position="absolute",a.style.top=`${e.height-60}px`,a.style.left=`${e.width-50}px`,"play"===t.gameStatus()?d5(a):d2(a)}};return n.addEventListener("click",t=>{t.preventDefault(),"paused"===e.gameStatus()?e.updateGameStatus("play"):e.updateGameStatus("paused")}),{...t,...r}})}function initGameOverMenu(t,e){return createMenu(t,(t,n)=>{const a=d1("#restart-btn-died"),r=d1("#game-over-menu"),o={el:r,button:a,render:t=>{"gameover"===t.gameStatus()?(d5(r,"flex"),d3(r,"fade-in")):(d3(r,"fade-out"),d2(r))}};return a.addEventListener("click",t=>{t.preventDefault(),"gameover"!==n.gameStatus()&&"finished"!==n.gameStatus()||e(n)}),{...t,...o}})}function renderFF(t,e,n){const{auth:a=!1}=n.equip||{},r=n.ghost?"0.5":"1",o=t.width/2,s=t.height/2,i=n.angle||0,l=i?i*Math.PI:0,c=e.createRadialGradient(o-1,s-2,1,o,s,10);c.addColorStop(0,`rgba(127, 0, 255, ${r})`),c.addColorStop(1,`rgba(127, 0, 255, ${r})`);const d=e.createRadialGradient(o,s-2,6,o+5,s,15);if(d.addColorStop(0,`rgba(255,165,0, ${r})`),d.addColorStop(1,`rgba(255,0,0, ${r})`),e.fillStyle=c,e.lineWidth=1,e.beginPath(),a&&(e.shadowBlur=3,e.shadowColor="orange"),e.arc(o,s,6,0,2*Math.PI),e.fill(),resetBlur(e),e.beginPath(),e.strokeStyle=d,e.lineWidth=6,a&&(e.shadowBlur=3,e.shadowColor="#e100ff"),e.arc(o,s,8,1.72*Math.PI+l,1.22*Math.PI+l),e.stroke(),resetBlur(e),a){if(a.rem<3e3){const t=Math.sin(a.rem/100);e.lineWidth=3+t,e.shadowBlur=10+t}else e.lineWidth=3,e.shadowBlur=10;e.beginPath(),e.strokeStyle="lime",e.shadowColor="lime",e.arc(o,s,13,1.72*Math.PI+l,1.22*Math.PI+l),e.stroke(),resetBlur(e)}}function cpp(t,e){return{...e,player:{...e.player,ps:{...t}}}}function cpl(t,e){return{...e,player:{...e.player,lives:t(e.player.lives)}}}function playerPickup404(t,e){return{...e,player:{...e.player,lastps:{...e.player.ps},pts:e.player.pts+t}}}function spg(t,e){return{...e,player:{...e.player,ghost:t}}}function gp1(t,e){if(e.ghost)return;const n=d1(".you-died-screen"),a=t.getState("canvas");e.lives>0?(t.updateGameStatus("died"),lifeLost(t),d5(n,"flex"),d3(n,"fade-in-out"),d3(a,"fade-in"),a.style.opacity=0,setTimeout(()=>{a.style.opacity=1,d4(a,"fade-in"),setTimeout(()=>{t.updateState(t=>spg(!1,t))},2e3)},3e3),setTimeout(()=>{t.updateState(t=>(d4(n,"fade-in-out"),compose(partial(cpl,t=>t-1),partial(cpp,t.player.lastps),partial(spg,!0))(t))),t.updateGameStatus("play"),d2(n)},2500)):t.updateGameStatus("gameover")}function gp2(t){const e=t.getState("player"),n=t.getState("map");if(n)return createEntity({...e,...{pxSpeed:.5,r:10,angle:0,ps:{x:n.cols/2*n.tsize,y:n.rows/2*n.tsize},lastps:{x:n.cols/2*n.tsize,y:n.rows/2*n.tsize},player:!0,movingTicks:0,pts:0,collide:!0,render:(t,e)=>{const{ctx:n,canvas:a}=t.gbk(["ctx","map","canvas"]);renderFF(a,n,e)},onCollide:(t,e,n)=>{e.ghost||("404"===n.type?(pick404(t),t.updateState(compose(partial(playerPickup404,1),partial(removeEntityById,n.id)))):n.enemy?gp1(t,e):"function"==typeof n.onCollect&&t.updateState(compose(t=>({...t,player:{...t.player,equip:{...t.player.equip,...n.onCollect(n)}}}),partial(removeEntityById,n.id))))},run:(t,e)=>{const{moveV:n,moveH:a,map:r}=t.gbk(["moveV","moveH","map"]),o=pxXSecond(r,e.pxSpeed),s=e.equip;for(const t in s)if(s.hasOwnProperty(t)){const n=s[t];n&&"function"==typeof n.run&&(e.equip[t]=n.run(n))}e.bc&&t.updateState(t=>{let e=t.map.cameraPos;return{...t,map:{...t.map,cameraPos:e}}});const i=e.blk;"up"===n&&"left"===a?e.angle=1.8:"up"===n&&"right"===a?e.angle=2.3:"down"===n&&"left"===a?e.angle=1.3:"down"===n&&"right"===a?e.angle=2.8:"up"===n?e.angle=0:"down"===n?e.angle=1:"left"===a?e.angle=1.5:"right"===a&&(e.angle=2.5);const l=Math.min(1,easeInOutCubic(e.movingTicks/2));return"up"!==n||"top"===e.bc||i.t?"down"!==n||"bottom"===e.bc||i.b||(e.ps.y+=o*l):e.ps.y-=o*l,"left"!==a||"left"===e.bc||i.l?"right"!==a||"right"===e.bc||i.r||(e.ps.x+=o*l):e.ps.x-=o*l,a||n?e.movingTicks++:e.movingTicks=0,e}}});console.error("Map not defined")}function pltToRgba(t,e=1){return`rgba(${[[253,54,202],[215,51,215],[0,213,255],[21,2,84],[19,232,128],[16,128,115],[242,52,101],[218,32,0]][t].join(",")}, ${e})`}function shCols(t,e,n=0){t.shadowColor=e,t.shadowBlur=n}function fdSt(t,e,n){t.strokeStyle=e,t.fillStyle=n}function drawEnemy(t,e,n,a,r=null){const o=t.shadowColor,s=t.shadowBlur;let i=0;r&&(shCols(t,"rgb(255,0,0)",20),i=angle2pts([e.x,e.y],r)),t.beginPath(),t.arc(e.x,e.y,n/2,0,2*Math.PI);for(let a=i,r=0;a<=360+i;a+=30,r++){const o=findPoint2Angle(a,e,n/2);t.moveTo(o.x,o.y);const s=findPoint2Angle(a,e,r%3==0?n-2:n+3);t.lineTo(s.x,s.y)}a?fdSt(t,pltToRgba(7,.5),pltToRgba(6,.2)):fdSt(t,pltToRgba(6,1),pltToRgba(7,.8)),t.lineWidth=1,t.stroke(),t.fill(),shCols(t,o,s)}function draw404(t,e,n){const a=n-2,r=n,o=t.shadowColor,s=t.shadowBlur;t.shadowColor=pltToRgba(2,1),t.shadowBlur=20,t.beginPath(),drawFile(t,{x:e.x-a,y:e.y-r},a,r,5),t.strokeStyle=pltToRgba(3,1),t.fillStyle=pltToRgba(2,.5),t.lineWidth=1,t.fill(),t.stroke(),shCols(t,o,s)}function render401(t,e,n){const{ctx:a,map:r}=t.gbk(["ctx","map"]),o=e.r;e.path=e.path||[];let s=null;if(e.path.length){const t=e.path[0];s=[t.coord[0]*r.tsize+r.pov.x,t.coord[1]*r.tsize+r.pov.y]}drawEnemy(a,n,o,e.disabled,s)}function renderTiles(t){const{ctx:e,map:n}=t.gbk(["ctx","map","levelConfig"]),{pov:a}=n,r=[],o=e.shadowColor,s=e.shadowBlur;e.beginPath(),e.fillStyle=pltToRgba(0,.3),e.strokeStyle=pltToRgba(1,1),e.lineWidth=.4,mapTileInView(n,(t,o)=>{const s=n.getTile(t,o),{x:i,y:l}=tileps(t,o,n.tsize,a);isBorder(t,o,n.cols,n.rows)&&r.push([t,o]),s>0&&e.rect(i,l,n.tsize,n.tsize)}),e.fill(),e.stroke(),e.beginPath(),e.fillStyle=pltToRgba(0,.3),e.strokeStyle=pltToRgba(1,1),r.forEach(([t,r])=>{const{x:o,y:s}=tileps(t,r,n.tsize,a);e.rect(o,s,n.tsize,n.tsize)}),e.fill(),e.stroke(),shCols(e,o,s)}function renderArrows(t){const{entities:e,player:n,ctx:a,map:r}=t.gbk(["entities","player","ctx","map"]),o=r.pov,s=a.shadowColor,i=a.shadowBlur;e.forEach(t=>{let e=!1;switch(a.beginPath(),t.type){case"404":a.strokeStyle=pltToRgba(2,.2),a.fillStyle=pltToRgba(2,.2),e=!0,a.shadowColor=pltToRgba(2,1),a.shadowBlur=10;break;case"exit":t.opened&&(e=!0,a.strokeStyle=pltToRgba(4,.2),a.fillStyle=pltToRgba(4,.2),a.shadowColor=pltToRgba(4,1),a.shadowBlur=10)}if(e){const e=rad2pts([t.ps.x,t.ps.y],[n.ps.x,n.ps.y]);a.arc(n.ps.x+o.x,n.ps.y+o.y,21,e-.4,e+.4);const r=pntBtw2Pnts(n.ps,t.ps,23);a.moveTo(r.x+o.x,r.y+o.y);const s=pntBtw2Pnts(n.ps,t.ps,25);a.lineTo(s.x+o.x,s.y+o.y),a.lineWidth=1,a.stroke(),a.fill()}}),shCols(a,s,i)}function render404(t,e,n){const{ctx:a}=t.gbk(["ctx"]);draw404(a,n,e.r)}function drawExit(t,e,n,a){const r=t.shadowColor,o=t.shadowBlur;t.beginPath(),a?(t.shadowColor=pltToRgba(4,1),t.shadowBlur=20,t.strokeStyle=pltToRgba(4,1),t.fillStyle=pltToRgba(5,1)):(t.strokeStyle=pltToRgba(4,.3),t.fillStyle=pltToRgba(5,.2)),t.lineWidth=1,t.arc(e.x,e.y,n,2*Math.PI,0),t.stroke(),t.fill(),shCols(t,r,o)}function renderExit(t,e,n){const{ctx:a}=t.gbk(["ctx","map","canvas"]);drawExit(a,n,e.r,e.opened)}function drawAuth(t,e,n){const a=t.shadowColor,r=t.shadowBlur;t.shadowColor=pltToRgba(4,.6),t.shadowBlur=10,t.beginPath(),t.fillStyle=pltToRgba(4,1),t.strokeStyle=pltToRgba(5,1),t.lineWidth=1,t.arc(e.x-n/2,e.y,n,0,1*Math.PI),t.arc(e.x+n/2,e.y,n,0,1*Math.PI),t.arc(e.x,e.y,n-n/2,0,1*Math.PI),t.arc(e.x,e.y-n/2,n,0,1*Math.PI),t.fill(),t.stroke(),shCols(t,a,r)}function renderAuth(t,e,n){const{ctx:a}=t.gbk(["ctx","map","canvas"]);drawAuth(a,n,e.r)}function renderTutorialEnemy(t){drawEnemy(t.getContext("2d"),{x:t.width/2,y:t.height/2},10,!1)}function renderTutorial404(t){draw404(t.getContext("2d"),{x:t.width/2,y:t.height/2},10)}function renderTutorialExit(t,e){drawExit(e.getContext("2d"),{x:e.width/2,y:e.height/2},10,t)}function renderTutorialExitOpen(t){renderTutorialExit(!0,t)}function renderTutorialExitClose(t){renderTutorialExit(!1,t)}function renderTutorialAuth(t){drawAuth(t.getContext("2d"),{x:t.width/2,y:t.height/2},4)}function pinkRadiant(t,e){const n=e.createRadialGradient(t.x,t.y,15,t.x,t.y,50);return n.addColorStop(0,pltToRgba(0,1)),n.addColorStop(1,pltToRgba(1,1)),n}function renderLivesHUD(t){const{canvas:e,ctx:n,player:a}=t.gbk(["canvas","ctx","player"]),r=a.lives,o="20px sans-serif";n.font=o;const s=n.measureText("❤");let i=[];const l=Math.floor(60/s.width);for(let t=0;t<r;t++){const e=Math.floor(t/l);i[e]||(i[e]=""),i[e]+=" ❤"}const c={x:e.width-100,y:30};n.font=o,n.strokeStyle=pinkRadiant(c,n),n.lineWidth=2.5,i.forEach((t,e)=>{n.strokeText(t,c.x,c.y+20*e)})}function renderCurrentLevelHUD(t){const{currentLevel:e,ctx:n}=t.gbk(["currentLevel","ctx"]),a=`Level: ${e+1}`;n.font="20px sans-serif";const r={x:30,y:30};n.fillStyle=pinkRadiant(r,n),n.fillText(a,r.x,r.y)}function renderHUD(t){const{canvas:e,ctx:n}=t.gbk(["currentLevel","canvas","ctx"]);n.beginPath(),n.rect(0,0,e.width,50),n.fillStyle="rgba(0,0,0,0.9)",n.fill(),renderLivesHUD(t),renderCurrentLevelHUD(t)}function isBorder(t,e,n,a){return 0===t||0===e||e===a-1||t===n-1}function getTilesInView(t){return t.centerTile?{startCol:Math.max(0,Math.round(t.centerTile.c-t.viewCols/2)),endCol:Math.min(t.cols,Math.round(t.centerTile.c+t.viewCols/2)),startRow:Math.max(0,Math.round(t.centerTile.r-t.viewRows/2)),endRow:Math.min(t.rows,Math.round(t.centerTile.r+t.viewRows/2))}:{}}function mapTileInView(t,e){const{startCol:n,endCol:a,startRow:r,endRow:o}=getTilesInView(t);for(var s=r;s<o;s++)for(var i=n;i<a;i++)e(i,s,{startRow:r,endRow:o,startCol:n,endCol:a})}function tileps(t,e,n,a){return{x:t*n+a.x,y:e*n+a.y}}function borders(t,e,n,a,r=[0,1,2,3]){if(!r.length)return;const o=e;for(let s=0;s<o;s++)for(let i=0;i<o;i++){let o=!1;r.indexOf(0)>=0&&i<=0?o=!0:r.indexOf(1)>=0&&s>=e-1?o=!0:r.indexOf(2)>=0&&i>=e-1?o=!0:r.indexOf(3)>=0&&s<=0&&(o=!0);const l=t[0]*e+s,c=t[1]*e+i;!isBorder(l,c,n.cols,n.rows)&&o&&n.setTile(l,c,a)}}function mazeBorders(t,e,n){for(const a in e)if(e.hasOwnProperty(a)){const[r,o]=a.split("-").map(t=>parseFloat(t,10)),s=e[a],i=reverseDirs(s);borders([r,o],n,t,0,s),borders([r,o],n,t,1,i)}}function clearCenterMap(t,e,n=10){for(let a=-n;a<n;a++)for(let r=-n;r<n;r++)t.setTile(e[0]+a,e[1]+r,0)}function pxXSecond(t,e){return e*t.tsize}function generateMap(t,e,n=4){let a=[];const r=t,o=e;for(let t=0;t<o;t++)for(let e=0;e<r;e++)isBorder(e,t,r,o)?a.push(1):a.push(0);const s={cols:r,rows:o,tsize:n,tiles:a,centerTile:{c:Math.round(r/2),r:Math.round(o/2)},getTile:(t,e)=>s.tiles[e*s.cols+t],setTile:(t,e,n)=>s.tiles[e*s.cols+t]=n,renderTile:()=>null,tCoords:()=>a.map((t,e)=>[Math.floor(e/r),e%o])};return s}function setVOF(t,e,n){if(!t)return void console.error("Map is null");const a={viewCols:Math.ceil(e/t.tsize),viewRows:Math.ceil(n/t.tsize)};return{...t,...a}}function dstBtw2Pnts(t,e){const n=t.x-e.x,a=t.y-e.y;return Math.sqrt(n*n+a*a)}function pntBtw2Pnts(t,e,n){const a=dstBtw2Pnts(t,e);if(a<n)return{...e};const r=a?n/a:0;return{x:t.x+r*(e.x-t.x),y:t.y+r*(e.y-t.y)}}function isCenterBlock(t,e,n){return t%(n.sf/2)==0&&e%(n.sf/2)==0}function surrounding(t,e,n){const a=[];for(let r=-n;r<n;r++)for(let o=-n;o<n;o++){const[n,s]=e;n>=0&&n<t.cols&&s>=0&&s<t.rows&&a.push([n+r,s+o])}return a}function nearTiles(t,e,n,a){return[[t[0],t[1]-1],[t[0]+1,t[1]],[t[0],t[1]+1],[t[0]-1,t[1]]].filter(t=>t[0]>=0&&t[0]<n&&t[1]>=0&&t[1]<a&&!e[`${t[0]}-${t[1]}`])}function relPos(t,e){return t[1]-1===e[1]?0:t[0]+1===e[0]?1:t[1]+1===e[1]?2:t[0]-1===e[0]&&3}function calcRoute(t,e,n){const a=[],r={};let o=0;let s=t;for(;`${s[0]}-${s[1]}`!==`${e[0]}-${e[1]}`&&o<1e4;){r[`${s[0]}-${s[1]}`]=!0;const t=nearTiles(s,r,n.cols,n.rows).filter(([t,e])=>!n.getTile(t,e)).sort((t,n)=>dstBtw2Pnts({x:e[0],y:e[1]},{x:t[0],y:t[1]})<dstBtw2Pnts({x:e[0],y:e[1]},{x:n[0],y:n[1]})?1:-1);if(t.length>0){const e=t[Math.floor(Math.random()*t.length)];a.push(s),s=e,o++}else a.pop(),s=a[a.length-1];if(void 0===s)return!1}return!0}function retracePath(t){let e=t;const n=[];for(;e.parent;)n.push(e),e=e.parent;return n.reverse()}function findPath(t,e,n,a=200){const r=n.tCoords().reduce((t,[e,n])=>{const a=`${e}-${n}`;return t[a]={label:a,coord:[e,n],parent:null,local:1/0,global:1/0},t},{}),o=r[`${e[0]}-${e[1]}`];if(!o)return;const s={},i=(t,e)=>dstBtw2Pnts({x:t[0],y:t[1]},{x:e[0],y:e[1]}),l=(t,e)=>t.global>e.global?1:-1;let c=r[`${t[0]}-${t[1]}`];c.global=i(t,e),c.local=0;let d=[c],u=0;for(;c&&u<a;){nearTiles([c.coord[0],c.coord[1]],s,n.cols,n.rows).filter(([t,e])=>0===n.getTile(t,e)).forEach(([t,n])=>{const a=r[`${t}-${n}`];c.local+1<a.local&&(a.parent=c,a.local=c.local+1,a.global=a.local+i(a.coord,e)),d.some(t=>t.label===a.label)||d.push(a)}),s[`${c.coord[0]}-${c.coord[1]}`]=!0,c.label===`${e[0]}-${e[1]}`?c=null:(d=d.filter(t=>t.label!==c.label).sort(l),c=d.splice(0,1)[0],u++)}return o.parent?retracePath(o):[]}function scaleTiles(t,e=10){return{...t,cols:t.cols/e,rows:t.rows/e,tsize:t.tsize*e}}function generateMaze(t,e){let n={...scaleTiles(t,10)};const a=[],r={},o=n.cols*n.rows;let s=[Math.floor(n.cols/2-t.tsize/10/2),Math.floor(n.rows/2-t.tsize/10/2)],i=[];const l=[];let c=!1;for(;Object.keys(r).length<o&&!c;){let t=[];if(a.length>0){const e=a[a.length-1],n=relPos(s,e),o=(n+2)%4;!1!==n&&(r[`${e[0]}-${e[1]}`].push(o),t.push(n))}r[`${s[0]}-${s[1]}`]||(r[`${s[0]}-${s[1]}`]=t);const e=nearTiles(s,r,n.cols,n.rows);if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];i.push(s),a.push(s),l.push(s),s=t}else a.pop(),s=a[a.length-1];s||(c=!0)}const d=[t.cols/2,t.rows/2];return mazeBorders(t,r,10),clearCenterMap(t,d,10),e.setState("mazepath",r),e.setState("mazestack",l),{...t,sf:10}}(()=>{const t=initGame();gameLoop(t),renderLoop(t)})();const t2p=(t,e)=>({x:t[0]*e,y:t[1]*e});function addEntities(t,e,n,a){const r=[];for(let o=0;o<n;o++){const n=Math.floor(Math.random()*e.length),o=e.splice(n,1)[0];r.push(a(t2p(o,t.tsize)))}return r}function generateEntities(t,e,n={}){const a=e.tCoords().filter(([t,n])=>!e.getTile(t,n)&&surrounding(e,[t,n],1).every(([t,n])=>0===e.getTile(t,n))),r=a.filter(([t,n])=>isCenterBlock(t,n,e)),o=r.filter(([t,n])=>{return dstBtw2Pnts({x:e.centerTile.c,y:e.centerTile.r},{x:t,y:n})>20}),s=n[404].n+n.exit.n+n.auth.n+n[401].map(t=>t.n).reduce((t,e)=>t+e,0).n,i=(t,e)=>{const n=[];for(let a=0;a<e;a++){const e=Math.floor(Math.random()*t.length);n.push(t.splice(e,1))}return n};let l=[...o];if(s>o.length&&s<o.length+r.length){const t=s-o.length;l=[...l,...i(r,t)]}else if(s>o.length+r.length){const t=s-(o.length+r.length);l=[...l,...r,...i(a,t)]}const c=l.filter(([t,n])=>!calcRoute([t,n],[e.cols/2,e.rows/2],e));t.updateState(t=>({...t,map:{...t.map,centers:l,blk:c}}));let d=[];return d=[...d,...addEntities(e,l,n[404].n,t=>({ps:t,type:"404"}))],d=[...d,...addEntities(e,l,n.exit.n,t=>({ps:t,type:"exit"}))],d=[...d,...addEntities(e,l,n.auth.n,t=>({ps:t,type:"auth"}))],d=[...d,...n[401].map(t=>addEntities(e,l,t.n,e=>{const{speed:n,updatePathEvery:a,maxDist:r,maxPath:o}=t;return{ps:e,type:"401",speed:n||3,updatePathEvery:a,maxDist:r,maxPath:o}})).flat()]}function resetBlur(t){t.shadowBlur=0}function genFont(t={}){const{name:e,size:n,style:a}={name:"arial",size:"14px",style:"",...t};return`${a} ${n} ${e}`}function setCtx(t,e={}){for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}function renderInCanvas(t,e,n={}){t.beginPath(),setCtx(t,n),e(t)}function renderText(t,e,n,a="black",r=r({size:"10px"})){const o=t.getState("ctx");if(!o)return!1;renderInCanvas(o,t=>t.fillText(e,n.x,n.y),{font:r,fillStyle:a})}function drawPolygon(t,e,n){t.moveTo(e.x,e.y),n.reduce((e,n)=>{const a={x:e.x+n[0],y:e.y+n[1]};return t.lineTo(a.x,a.y),a},e)}function drawFile(t,e,n,a,r){drawPolygon(t,e,[[2*n-r,0],[r,r],[0,2*a-r],[2*-n,0],[0,2*-a]])}function easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}function setState(t,e,n){const a={...t};return a[e]=n,a}function updateState(t,e){return e(t)}function getState(t,e,n=null){return void 0!==t[e]?t[e]:n}function createState(t={}){let e={...{entities:[],menus:{},ctrl:{},minFpsRender:1/0,minFps:1/0,audioCtrl:a1()},...t};const n=t=>{void 0!==e.ctrls[t]&&("function"==typeof e.ctrls[t].onRemove&&e.ctrls[t].onRemove(e.ctrls[t]),delete e.ctrls[t])},a={gbk:t=>{const n={};for(const a of t)void 0!==e[a]?n[a]=e[a]:n[a]=null;return n},gameStatus:()=>getState(e,"gameState"),updateGameStatus:t=>(e=setState(e,"gameState",t),a),setState:(t,n)=>(e=setState(e,t,n),a),getState:(t,...n)=>getState.apply(null,[e,t,...n]),updateState:t=>(e=updateState(e,t),a),addCtrl:(t,n)=>{const a={};a[t]=n,e={...e,ctrls:{...e.ctrls,...a}}},removeCtrl:n,removeAllCtrls:()=>{for(let t in e.ctrls)e.ctrls.hasOwnProperty(t)&&n(t)}};return a}function partial(t,e){return(...n)=>t(e,...n)}function compose(...t){return(...e)=>t.reduce((t,e)=>e(t),...e)}function toRadiant(t){return t*Math.PI/180}function findPoint2Angle(t,e,n){const a=toRadiant(t);return{x:e.x+n*Math.sin(a),y:e.y+n*Math.cos(a)}}function reverseDirs(t){return[0,1,2,3].filter(e=>t.indexOf(e)<0)}function angle2pts(t,e){return 180*rad2pts(t,e)/Math.PI}function rad2pts(t,e){return Math.atan2(t[1]-e[1],t[0]-e[0])}</script><!-- end js --></body></html>