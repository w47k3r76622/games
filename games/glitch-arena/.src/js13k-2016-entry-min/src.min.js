!function(a,b){"function"==typeof define&&define.amd?define(["exports"],b):b("object"==typeof exports&&"string"!=typeof exports.nodeName?exports:a.TinyMusic={})}(this,function(a){function b(a){a=a.split(f);this.frequency=b.getFrequency(a[0])||0;this.duration=b.getDuration(a[1])||0}function c(a,b,c){this.ac=a||new AudioContext;this.createFxNodes();this.tempo=b||120;this.loop=!0;this.staccato=this.smoothing=0;this.notes=[];this.push.apply(this,c||[])}var d=440*Math.pow(Math.pow(2,1/12),-9),e=/^[0-9.]+$/,
f=/\s+/,g=/(\d+)/,k={};"B#-C C#-Db D D#-Eb E-Fb E#-F F#-Gb G G#-Ab A A#-Bb B-Cb".split(" ").forEach(function(a,b){a.split("-").forEach(function(a){k[a]=b})});b.getFrequency=function(a){a=a.split(g);return d*Math.pow(Math.pow(2,1/12),k[a[0]])*Math.pow(2,(a[1]||4)-4)};b.getDuration=function(a){return e.test(a)?parseFloat(a):a.toLowerCase().split("").reduce(function(a,b){return a+("w"===b?4:"h"===b?2:"q"===b?1:"e"===b?.5:"s"===b?.25:0)},0)};c.prototype.createFxNodes=function(){var a=this.gain=this.ac.createGain();
return[["bass",100],["mid",1E3],["treble",2500]].forEach(function(b,c){c=this[b[0]]=this.ac.createBiquadFilter();c.type="peaking";c.frequency.value=b[1];a.connect(a=c)}.bind(this)),a.connect(this.ac.destination),this};c.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(a){this.notes.push(a instanceof b?a:new b(a))}.bind(this)),this};c.prototype.createCustomWave=function(a,b){b||(b=a);this.waveType="custom";this.customWave=[new Float32Array(a),new Float32Array(b)]};c.prototype.createOscillator=
function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this};c.prototype.scheduleNote=function(a,b){var c=60/this.tempo*this.notes[a].duration,d=c*(1-(this.staccato||0));return this.setFrequency(this.notes[a].frequency,b),this.smoothing&&this.notes[a].frequency&&this.slide(a,b,d),this.setFrequency(0,b+d),b+c};c.prototype.getNextNote=
function(a){return this.notes[a<this.notes.length-1?a+1:0]};c.prototype.getSlideStartDelay=function(a){return a-Math.min(a,60/this.tempo*this.smoothing)};c.prototype.slide=function(a,b,c){var d=this.getNextNote(a),e=this.getSlideStartDelay(c);return this.setFrequency(this.notes[a].frequency,b+e),this.rampFrequency(d.frequency,b+c),this};c.prototype.setFrequency=function(a,b){return this.osc.frequency.setValueAtTime(a,b),this};c.prototype.rampFrequency=function(a,b){return this.osc.frequency.linearRampToValueAtTime(a,
b),this};c.prototype.play=function(a){return a="number"==typeof a?a:this.ac.currentTime,this.createOscillator(),this.osc.start(a),this.notes.forEach(function(b,c){a=this.scheduleNote(c,a)}.bind(this)),this.osc.stop(a),this.osc.onended=this.loop?this.play.bind(this,a):null,this};c.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this};a.Note=b;a.Sequence=c});
drawing={calcShouldDrawX:function(a,b){return a>=-b&&a<=g_g.canvas.width+b},calcShouldDrawY:function(a,b){return a>=-b&&a<=g_g.canvas.height+b},calcShouldDraw:function(a,b,c){return drawing.calcShouldDrawX(a.x,b)&&drawing.calcShouldDrawY(a.y,c)},calcShouldDrawCircle:function(a,b){return drawing.calcShouldDraw(a,b,b)},drawCircle:function(a,b,c){drawing.calcShouldDrawCircle(a,b+g_g.ctx.lineWidth/2)&&(drawing.drawCircleForced(a,b),c())},drawCircleForced:function(a,b){g_g.ctx.beginPath();g_g.ctx.arc(a.x,
a.y,b,0,2*Math.PI,!1)}};EnemySystem=function(){this.enemies=[]};EnemySystem.prototype.update=function(){for(var a=0;a<this.enemies.length;++a)this.enemies[a].update()&&(g_g.increaseScore(10),g_g.enemyKilled(),this.enemies.splice(a,1))};EnemySystem.prototype.draw=function(){loopCall(this.enemies,"draw")};
EnemySystem.prototype.spawn=function(a){for(var b=0;b<a.objects.length;++b){var c=a.objects[b],d=Math.floor(g_g.glitchness.val-1+.25*Math.pow(g_g.settings.options.difficulty.current,2)),e;e="orb"==c.getTag()?d:.5*d;e=randomRange(1,2+e);for(var f=0;f<e;++f)this.enemies.push(new Enemy(c,500+randomRange(0,5*d),500+randomRange(0,50*d),25+d,4+randomRangeReal(0,d/2),1+randomRange(0,.4*d),1+randomRange(0,.3*d)))}};
Enemy=function(a,b,c,d,e,f,g){this.guard=a;this.guardRadius=b;this.awareness=c;this.radius=d;this.damage=f;this.hp=g;this.isGuarding=this.alive=!0;this.maxSpeed=e;this.speed=0;this.pos=this.destination=this.randomPos();this.active=!0;this.behavior=0;this.lastBehaviorChange=(new Date).getTime();this.behaviorChangeCooldown=2E3;this.dir=0};
Enemy.prototype.update=function(){if(!this.alive)return!0;this.isGuarding?this.guard.data.alive||(this.isGuarding=!1,this.active=!0,0!=this.behavior&&2!=this.behavior||this.setBehavior(3)):this.pos.disTo(this.guard.data.pos)<this.guardRadius&&(this.active=3E3>this.pos.disTo(g_g.player.pos));if(this.active){switch(this.behavior){case 0:this.pos.disTo(g_g.player.pos)<this.awareness?this.setBehaviorPursuing():this.dir=this.pos.dirTo(g_g.player.pos);break;case 1:var a=this.pos.disTo(g_g.player.pos);if(this.isGuarding&&
(600<a||750<this.pos.disTo(this.destination)))this.destination=this.randomPos(),this.dir=this.pos.dirTo(this.destination),this.setDonePursuing();else{var b=this.radius+g_g.player.radius;a<=b&&(this.pos=g_g.player.pos.calcMove(g_g.player.pos.dirTo(this.pos),b),g_g.player.hpDecrease(this.damage));this.dir=this.pos.dirTo(g_g.player.pos)}break;case 2:this.pos.disTo(g_g.player.pos)<this.awareness-200?this.setBehaviorPursuing():this.pos.disTo(this.destination)<this.speed&&this.setBehaviorGuarding();break;
case 3:this.pos.disTo(g_g.player.pos)<this.awareness+250?this.setBehaviorPursuing():(this.pos.disTo(this.destination)<=this.speed&&this.randomDestination(),this.dir=this.pos.dirTo(this.destination))}this.pos.moveDelta(this.dir,this.speed);for(a=0;a<g_g.player.bullets.length;++a)g_g.player.bullets[a].colliding(this.pos,this.radius)&&this.hpDecrease(g_g.player.bullets[a].damage)}return!this.alive};
Enemy.prototype.draw=function(){g_g.ctx.lineWidth=3;drawing.drawCircle(this.pos.calcSub(g_g.camera),this.radius,function(){g_g.ctx.fillStyle="#f00";g_g.ctx.strokeStyle="#b00";g_g.ctx.fill();g_g.ctx.stroke()});g_g.ctx.lineWidth=1};Enemy.prototype.randomPos=function(){return this.guard.data.pos.calcMove(trig.randomDir(),randomRange(Math.min(2*this.radius,.2*this.guardRadius),this.guardRadius))};Enemy.prototype.hpDecrease=function(a){this.hp-=a;return 0>=this.hp?(this.alive=!1,!0):!1};
Enemy.prototype.setBehavior=function(a){var b=(new Date).getTime();this.lastBehaviorChange+this.behaviorChangeCooldown<b&&(this.behavior=a,this.lastBehaviorChange=b)};Enemy.prototype.setBehaviorPursuing=function(){this.setBehavior(1);this.speed=this.maxSpeed};Enemy.prototype.setBehaviorGuarding=function(){this.setBehavior(0);this.speed=0};Enemy.prototype.setDonePursuing=function(){this.isGuarding?this.setBehavior(2):(this.setBehavior(3),this.randomDestination())};
Enemy.prototype.randomDestination=function(){this.destination=g_g.center.calcMove(trig.randomDir(),randomRange(0,.75*g_g.boundsDistance))};Level=function(){this.objects=[];this.neededDistance=1E3;this.enemySystem=new EnemySystem;this.pushOrb()};Level.prototype.update=function(){for(var a=0;a<this.objects.length;++a)if(this.objects[a].update()){var b=this.objects[a].getTag();this.objects[a].data.alive=!1;this.objects.splice(a,1);"orb"==b&&this.pushOrb()}this.enemySystem.update()};
Level.prototype.draw=function(){loopCall(this.objects,"draw");this.enemySystem.draw()};Level.prototype.pushObject=function(a,b){for(;;){var c=randomRangeReal(0,trig.TAU),d=randomRange(Math.min(2E3,500+300*g_g.glitchness.val),Math.min(g_g.boundsDistance-500,1500+300*g_g.glitchness.val)),c=trig.move(0,0,c,d);if(!(1E3>g_g.player.pos.disTo(c))){for(var d=!0,e=0;e<this.objects.length;++e)if(this.objects[e].data.pos.disTo(c)<this.neededDistance){d=!1;break}if(d)break}}this.objects.push(new a(c,b))};
Level.prototype.pushOrb=function(){this.neededDistance-=50;100>this.neededDistance&&(this.neededDistance=100);for(var a=g_g.glitchness.val,b=0;b<a;++b)this.pushObject(Level.Key);this.pushObject(Level.Orb,{keyNeed:a});this.enemySystem.spawn(this)};Level.Object=function(a,b){this.pos=a;this.radius=b;this.alive=!0};Level.Object.prototype.moveToPlayer=function(a,b){this.pos.disTo(g_g.player.pos)<a+g_g.player.radius&&this.pos.move(this.pos.dirTo(g_g.player.pos),b)};
Level.Key=function(a){this.circleRadius=5;this.data=new Level.Object(a,3*this.circleRadius);this.pullRadius=5*this.data.radius;this.rotation=0;this.getTag=function(){return"key"};this.update=function(){this.data.moveToPlayer(this.pullRadius,1);return g_g.player.calcInteraction(this.data)?(g_g.increaseScorePure(50),g_g.player.keyCount++,!0):!1};this.draw=function(){var a=this.data.pos.calcSub(g_g.camera);g_g.ctx.lineWidth=3;if(drawing.calcShouldDrawCircle(a,this.pullRadius)){drawing.drawCircleForced(a,
this.pullRadius);g_g.ctx.fillStyle="#000";g_g.ctx.strokeStyle="#f0f";g_g.ctx.fill();g_g.ctx.stroke();g_g.ctx.lineWidth=1;g_g.ctx.fillStyle="#fff";g_g.ctx.strokeStyle="#fff";for(var c=this.rotation,d=2*this.circleRadius,e=0;3>e;++e)c+=trig.TAU/3,drawing.drawCircleForced(a.calcMove(c,d),this.circleRadius),g_g.ctx.fill(),g_g.ctx.stroke()}g_g.ctx.lineWidth=1;this.rotation+=trig.TAU/(5*g_g.frameRate)};this.drawIcon=function(a,c){drawing.drawCircleForced(a,c);g_g.ctx.strokeStyle="#f0f";g_g.ctx.fill();g_g.ctx.stroke()}};
Level.Orb=function(a,b){this.circleRadius=25;this.pullRadius=2.5*this.circleRadius;this.data=new Level.Object(a,this.circleRadius);this.keyNeed=b.keyNeed;this.rotation=0;this.rotationSpeed=trig.TAU/180;this.getTag=function(){return"orb"};this.update=function(){this.rotation+=this.rotationSpeed;this.data.moveToPlayer(this.circleRadius,.5);return g_g.player.calcInteraction(this.data)&&this.hasKeys()?(g_g.increaseScorePure(100),g_g.glitchness.inc(1),g_g.player.upgrade(),g_g.player.keyCount-=this.keyNeed,
!0):!1};this.draw=function(){g_g.ctx.lineWidth=3;var a=this.data.pos.calcSub(g_g.camera);drawing.drawCircle(a,this.circleRadius,function(){this.hasKeys()?(g_g.ctx.fillStyle="#fff",g_g.ctx.strokeStyle="#0f0"):(g_g.ctx.fillStyle="#ccc",g_g.ctx.strokeStyle="#00a");g_g.ctx.fill();g_g.ctx.stroke();g_g.ctx.lineWidth=4;for(var b=0;b<g_g.player.keyCount;++b){var e=this.rotation+b/this.keyNeed*trig.TAU,f=a.calcMove(e,this.circleRadius),e=a.calcMove(e,this.pullRadius);g_g.ctx.beginPath();g_g.ctx.moveTo(f.x,
f.y);g_g.ctx.lineTo(e.x,e.y);g_g.ctx.stroke()}}.bind(this));g_g.ctx.lineWidth=1};this.drawIcon=function(a,b){g_g.ctx.beginPath();for(var e=0;10>e;e+=2){var f=trig.TAU/10,g=a.calcMove(e*f-Math.PI/2,b);0==e?g_g.ctx.moveTo(g.x,g.y):g_g.ctx.lineTo(g.x,g.y);f=a.calcMove((e+1)*f-Math.PI/2,.5*b);g_g.ctx.lineTo(f.x,f.y)}this.hasKeys()?g_g.ctx.strokeStyle="#0f0":g_g.ctx.strokeStyle="#fff";g_g.ctx.closePath();g_g.ctx.fill();g_g.ctx.stroke()};this.hasKeys=function(){return g_g.player.keyCount>=this.keyNeed}};
Button=function(a){this.text=a;this.rect=new trig.Rect(new trig.Coord(0,0),0,0);this.hover=!1};Button.prototype.update=function(){this.hover=this.rect.getIfHover(g_g.mouse)};Button.prototype.draw=function(){g_g.ctx.strokeStyle=this.hover?"#0f0":"#fff";g_g.ctx.textBaseline="middle";g_g.ctx.strokeRect(this.rect.pos.x,this.rect.pos.y,this.rect.width,this.rect.height);g_g.ctx.fillText(this.text,this.rect.pos.x+this.rect.width/2,this.rect.pos.y+this.rect.height/2);g_g.ctx.textBaseline="top"};
Button.prototype.conformSize=function(a,b){g_g.ctx.font=a.toString()+"px "+b;this.rect.width=2*g_g.ctx.measureText(this.text).width+8;this.rect.height=a+16};
TitleScreen=function(){this.titleY=.5;this.titleYDesired=.25;this.toBePlaying=this.playing=this.toBeDone=this.done=!1;this.buttonTextSize=34;this.buttonFont=this.buttonTextSize.toString()+"px Arial";this.buttons=[new Button("Settings"),new Button("Play"),new Button("Instructions")];g_g.ctx.font=this.buttonFont;this.buttonWidth=this.calcButtonText(0).width;for(var a=1;a<this.buttons.length;++a){var b=this.calcButtonText(a);b>this.buttonWidth&&(this.buttonWidth=b)}};
TitleScreen.prototype.update=function(){if(this.done){var a=2/3*g_g.canvas.height,b=g_g.canvas.width/2,c=this.buttonTextSize;this.buttons[0].rect.pos.x=b-2*this.buttonWidth-12;this.buttons[1].rect.pos.x=b-.5*this.buttonWidth-4;this.buttons[2].rect.pos.x=b+1*this.buttonWidth+4;for(b=0;b<this.buttons.length;++b)this.buttons[b].rect.pos.y=a,this.buttons[b].rect.width=this.buttonWidth+8,this.buttons[b].rect.height=c+16,this.buttons[b].update();g_g.mouseButtons.left.pressed?this.buttons[0].hover?screenChange(3):
this.buttons[2].hover?screenChange(4):this.playGame():TitleScreen.getActionPressed()&&this.playGame()}else TitleScreen.getActionPressed()&&(this.toBeDone=!0),this.titleY>this.titleYDesired?this.titleY-=.001:this.toBeDone=!0,this.toBeDone&&(this.titleY=this.titleYDesired)};
TitleScreen.prototype.draw=function(){var a=this.playing?"PAUSED":"GLITCH ARENA";g_g.ctx.fillStyle="#fff";g_g.ctx.textAlign="center";g_g.ctx.textBaseline="middle";drawResponsiveText(a,g_g.canvas.width/2,g_g.canvas.height*this.titleY,.5,"Arial Black");if(this.done){g_g.ctx.fillStyle="#fff";g_g.ctx.font=this.buttonFont;for(a=0;a<this.buttons.length;++a)this.buttons[a].draw();g_g.ctx.textBaseline="top"}else this.toBeDone&&(this.done=!0);this.toBePlaying&&(this.playing=!0,this.buttons[1].text="Continue")};
TitleScreen.prototype.playGame=function(){screenChange(1);this.playing||(this.toBePlaying=!0)};TitleScreen.prototype.calcButtonText=function(a){return g_g.ctx.measureText(this.buttons[a])};TitleScreen.getActionPressed=function(){return g_g.keys[g_g.keyBinds.spacebar].pressed||g_g.mouseButtons.left.pressed};
Instructions=function(){this.text="Your character follows the mouse.;Hold shift to aim away from your traveling direction.;Travel toward the keys (highlighted in pink) to collect them,;once you have all the keys, travel to the orb (indicated as a star).;Enemies will attack you, once you get the first orb you can;shoot at them by clicking or pressing space.;The top left number is your score and the number under it is your multiplier,;kill enemies without missing to increase it.;Press P or ESC to pause.".split(";");this.font=
"Georgia";this.size=0;this.buttonSize=30;this.textMargin=25;this.widthRatio=.6;this.y=0;this.buttonTopMargin=20;this.button=new Button("Exit");this.button.conformSize(this.buttonSize,this.font)};
Instructions.prototype.update=function(){for(var a=this.textMargin*(this.text.length-1),b=calcText(this.text[0],this.widthRatio,this.font),c=1;c<this.text.length;++c){var d=calcText(this.text[c],this.widthRatio,this.font);d.width>b.width&&(b=d)}this.size=b.size;a+this.text.length*this.size>.8*g_g.canvas.height&&(this.size=(.8*g_g.canvas.height-a)/this.text.length);b=g_g.canvas.height/2;a=a+(this.text.length+1)*this.size+this.buttonTopMargin;this.button.rect.pos.y=b+a/2-this.button.rect.height;a+=
this.button.rect.height;this.y=b-a/2;this.button.rect.pos.x=g_g.canvas.width/2-this.button.rect.width/2;this.button.update();g_g.mouseButtons.left.released&&this.button.hover&&screenChange(0)};
Instructions.prototype.draw=function(){var a=g_g.canvas.width/2;g_g.ctx.fillStyle="#fff";g_g.ctx.font=this.size.toString()+"px Georgia";g_g.ctx.textAlign="center";for(var b=0;b<this.text.length;++b)g_g.ctx.fillText(this.text[b],a,this.yInc());g_g.ctx.textAlign="center";g_g.ctx.font=this.buttonSize.toString()+"px Georgia";this.button.draw()};Instructions.prototype.yInc=function(){var a=this.y;this.y+=this.size+this.textMargin;return a};
Settings=function(){this.options={particles:new Settings.Option(3,1,3,"Particles"),difficulty:new Settings.Option(2,1,3,"Difficulty")};this.inOptions(function(a,b){var c=getCookie(b);""!=c&&(a.current=parseInt(c))});this.exit=new Button("Exit");this.exit.conformSize(30,"Georgia")};
Settings.prototype.update=function(){var a=g_g.canvas.width/2,b=.1*g_g.canvas.height;this.inOptions(function(c){c.updateDimensions(new trig.Coord(a,b),Math.min(50,.1*g_g.canvas.width),Math.min(25,.05*g_g.canvas.height));c.update();b+=100});this.exit.rect.pos.x=a-this.exit.rect.width/2;this.exit.rect.pos.y=b;this.exit.update();g_g.mouseButtons.left.released&&this.exit.hover&&(screenChange(0),this.inOptions(function(a,b){document.cookie=b+"="+a.current.toString()}))};
Settings.prototype.draw=function(){this.inOptions(function(a){a.draw()});this.exit.draw()};Settings.prototype.inOptions=function(a){for(var b in this.options)this.options.hasOwnProperty(b)&&a(this.options[b],b)};Settings.Option=function(a,b,c,d){this.current=a;this.min=b;this.max=c;this.name=d;this.marginX=4;this.marginY=10;this.buttons=[];for(a=this.min;a<=this.max;++a)this.buttons.push(new EmptyButton)};
Settings.Option.prototype.update=function(){for(var a=0;a<this.buttons.length;++a)this.buttons[a].update()&&(this.current=a+this.min)};
Settings.Option.prototype.draw=function(){for(var a=0;a<this.buttons.length;++a)this.buttons[a].draw(this.current-this.min==a);var a=this.buttons[0].rect,b=this.buttons[this.buttons.length-1].rect,c=a.pos.x-10,b=b.pos.x+b.width+10;g_g.ctx.fillStyle="#fff";g_g.ctx.font=a.height.toString()+"px Georgia";g_g.ctx.textAlign="right";g_g.ctx.fillText("Low",c,a.pos.y-3);g_g.ctx.textAlign="left";g_g.ctx.fillText("High",b,a.pos.y-3);g_g.ctx.textAlign="center";g_g.ctx.textBaseline="bottom";g_g.ctx.fillText(this.name,
c+(b-c)/2,a.pos.y-10);g_g.ctx.textBaseline="top"};Settings.Option.prototype.updateDimensions=function(a,b,c){for(var d=this.buttons.length,e=d/2,e=a.x-b*e-this.marginX*Math.floor(e),f=0;f<d;++f){var g=this.buttons[f].rect;g.pos.x=e+f*(b+this.marginX);g.pos.y=a.y;g.width=b;g.height=c}};EmptyButton=function(a){this.rect=new trig.Rect(new trig.Coord(0,0),0,0);this.hover=!1};EmptyButton.prototype.update=function(){return(this.hover=this.rect.getIfHover(g_g.mouse))&&g_g.mouseButtons.left.released?!0:!1};
EmptyButton.prototype.draw=function(a){g_g.ctx.fillStyle=a?"#0f0":"#fff";g_g.ctx.strokeStyle=this.hover?"#f0f":"#bbb";g_g.ctx.beginPath();g_g.ctx.rect(this.rect.pos.x,this.rect.pos.y,this.rect.width,this.rect.height);g_g.ctx.fill();g_g.ctx.stroke()};
ParticleSystem=function(){this.particlesFront=[];this.particlesBack=[];this.countFront=7;this.countBack=26;for(var a=0;a<this.countFront;++a)this.pushToFront();for(a=0;a<this.countBack;++a)this.pushToBack();g_g.glitchness.addCallback([ParticleSystem.glitchnessIncrease,this])};
ParticleSystem.prototype.update=function(){loopCall(this.particlesFront,"update");loopCall(this.particlesBack,"update");var a=g_g.settings.options.particles.current,b=this.countFront*a,a=this.particlesFront.length-this.countFront*a;0>a&&0==randomRange(0,10)?this.pushToFront():0<a&&this.particlesFront.splice(-1,a);b=this.particlesBack.length-b;0>b&&0==randomRange(0,10)?this.pushToBack():0<b&&this.particlesBack.splice(-1,b)};ParticleSystem.prototype.draw=function(){loopCall(this.particlesBack,"draw")};
ParticleSystem.prototype.drawLast=function(){loopCall(this.particlesFront,"draw")};ParticleSystem.prototype.increaseCount=function(){1<g_g.settings.options.particles.current&&(this.countFront+=1,this.countBack+=2)};ParticleSystem.glitchnessIncrease=function(a){a.increaseCount()};ParticleSystem.prototype.pushToFront=function(){this.particlesFront.push(new Particle(randomRangeReal(1,2)))};ParticleSystem.prototype.pushToBack=function(){this.particlesBack.push(new Particle(randomRangeReal(.25,1)))};
Particle=function(a){this.distance=a;this.init()};
Particle.prototype.init=function(){this.pos=new trig.Coord(randomRange(0,g_g.canvas.width),randomRange(0,g_g.canvas.height));this.height=this.width=1;this.randomSize();this.side=randomRange(0,2);this.bias=0==this.side?randomRange(0,20):randomRange(81,101);var a=[0,0,0];if(1==randomRange(1,3))a[randomRange(0,3)]=1;else for(var b=0;2>b;){var c=randomRange(0,3);0==a[c]&&(a[c]=1,b++)}this.color=new RgbColor(256*a[0]-20,256*a[1]-30,256*a[2]);this.deathTick=randomRange(100,1E3)};
Particle.prototype.update=function(){0==randomRange(0,2E3+500*g_g.glitchness.val)&&this.randomSize();--this.deathTick;0==this.deathTick&&this.init();0==randomRange(0,300)&&(randomRange(0,101)<this.bias?this.resize(function(){this.width+=1}):this.resize(function(){this.height+=1}))};
Particle.prototype.draw=function(){var a=this.pos.calcSub(g_g.camera);a.x*=this.distance;a.y*=this.distance;this.fixPos(a,"x","fullWidth","width");this.fixPos(a,"y","fullHeight","height");g_g.ctx.fillStyle=this.color.get();g_g.ctx.fillRect(a.x,a.y,this.fullWidth,this.fullHeight)};Particle.prototype.fixPos=function(a,b,c,d){for(;a[b]<=-this[c];)a[b]+=g_g.canvas[d];for(;a[b]>=g_g.canvas[d];)a[b]-=g_g.canvas[d]};
Particle.prototype.randomSize=function(){this.resize(function(){this.size=randomRange(2,2+4*g_g.glitchness.val)})};Particle.prototype.resize=function(a){a.bind(this)();this.fullWidth=this.size*this.width;this.fullHeight=this.size*this.height};
Player=function(){this.points=[];this.radius=50;this.pos=new trig.Coord(0,0);this.dirFacing=0;this.speedMax=6;this.movements=[new Movement(0,0)];this.speedInc=10/60/5;this.speedDec=10/60/5;this.speedRotate=trig.TAU/60;this.hp=this.hpMax=5;this.lastHit=(new Date).getTime();this.hitCooldown=500;this.inHit=!1;this.offset=this.upgradeCount=this.keyCount=0;this.offsetMax=Math.PI/5;this.points.push(Math.PI);for(var a=1;4>a;++a)this.points.push(Math.PI+a*this.offsetMax);this.mouthPoint=Math.PI+4*this.offsetMax;
this.canShoot=!1;this.lastShoot=(new Date).getTime();this.shootInterval=500;this.bullets=[];this.bulletSpeed=this.speedMax+10;this.bulletRadius=5;this.bulletDamage=1;this.upgradeName="";this.lastUpgrade=0;this.upgradeDrawTime=5E3};
Player.prototype.update=function(){var a=this.pos.calcSub(g_g.camera);if(a.disTo(g_g.mouse)>this.radius){var a=a.dirTo(g_g.mouse),b=a-this.dirFacing,c=this.speedRotate*g_g.delta;Math.abs(b)<=c||Math.abs(b+trig.TAU)<=c?this.dirFacing=a:(this.dirFacing=(b+trig.TAU)%trig.TAU>Math.PI?this.dirFacing-c:this.dirFacing+c,this.dirFacing=trig.normalizeDir(this.dirFacing))}g_g.keys[g_g.keyBinds.shift].released&&this.movements.splice(0,0,new Movement(this.dirFacing,0));g_g.keys[g_g.keyBinds.shift].down||(this.movements[0].dir=
this.dirFacing);for(a=0;a<this.movements.length;++a){b=this.movements[a];if(0==a)b.speed<this.speedMax&&(b.speed+=this.speedMax*this.speedInc),b.speed>this.speedMax&&(b.speed=this.speedMax);else if(0<b.speed&&(b.speed-=this.speedMax*this.speedDec),0>=b.speed){this.movements.pop(a,1);a--;continue}this.pos.moveDelta(b.dir,b.speed)}stayInGameBounds(this.pos,this.radius);for(a=0;a<this.bullets.length;++a)this.bullets[a].update()&&this.bullets.splice(a,1);a=(new Date).getTime();this.canShoot&&(g_g.keys[g_g.keyBinds.spacebar].down||
g_g.mouseButtons.left.down)&&this.lastShoot+this.shootInterval<a&&(this.lastShoot=a,this.shoot());this.offset+=Math.PI/200*.5*g_g.glitchness.val;this.offset>=this.offsetMax&&(this.offset-=this.offsetMax);a>this.lastHit+this.hitCooldown&&(this.inHit=!1)};
Player.prototype.draw=function(){var a=function(a){return this.points[a]+this.offset}.bind(this),b=[];b.push(this.radial(Math.PI));for(var c=0;c<this.points.length;++c)b.push(this.radial(a(c)));b.push(this.radial(this.mouthPoint));b.push(this.pos);b.push(this.radial(Math.PI+(Math.PI-this.mouthPoint)));for(c=this.points.length-1;0<=c;--c)b.push(this.radial(Math.PI+(Math.PI-a(c))));g_g.ctx.strokeStyle=this.inHit?"#f00":"#000";g_g.ctx.fillStyle="#fff";g_g.ctx.lineWidth=1;g_g.ctx.beginPath();g_g.ctx.moveTo(screenX(b[0].x),
screenY(b[0].y));for(c=1;c<b.length;++c)g_g.ctx.lineTo(screenX(b[c].x),screenY(b[c].y));g_g.ctx.lineTo(screenX(b[0].x),screenY(b[0].y));g_g.ctx.fill();g_g.ctx.stroke();g_g.ctx.lineWidth=1;var d,e,a=50+this.radius,b=300+a;d=200+b;e=3E3+d;for(c=0;c<g_g.level.objects.length;++c){var f=g_g.level.objects[c],g=this.pos.disTo(f.data.pos);if(g>b){var k=1,l=this.pos.dirTo(f.data.pos);if(g>e)g=7;else if(g>d)var h=(g-d)/(e-d),g=20-13*h;else h=(g-b)/(d-b),g=20,k=h;h=this.pos.calcSub(g_g.camera);h.move(l,a);g_g.ctx.globalAlpha=
k;g_g.ctx.lineWidth=2;g_g.ctx.fillStyle="#fff";f.drawIcon(h,g);g_g.ctx.globalAlpha=1;g_g.ctx.lineWidth=1}}loopCall(this.bullets,"draw");c=(new Date).getTime()-this.lastUpgrade;c<this.upgradeDrawTime&&(g_g.ctx.globalAlpha=1-c/this.upgradeDrawTime,g_g.ctx.textAlign="center",g_g.ctx.font="34px Arial",g_g.ctx.fillStyle="#f00",g_g.ctx.fillText(this.upgradeName,g_g.canvas.width/2,g_g.canvas.height/4));g_g.ctx.globalAlpha=1};
Player.prototype.radial=function(a){var b=0,c=this.hp/this.hpMax;randomRangeReal(0,1)>c&&(b=randomRange(0,20*(1-c)));return this.pos.calcMove(this.dirFacing+a,this.radius+b)};Player.prototype.calcInteraction=function(a){return this.pos.disTo(a.pos)<.75*this.radius+a.radius};Player.prototype.shoot=function(){this.bullets.push(new Bullet(this.pos.calcMove(this.dirFacing,.75*this.radius),this.dirFacing,this.bulletSpeed,this.bulletRadius,this.bulletDamage))};
Player.prototype.hpDecrease=function(a){this.inHit||(this.inHit=!0,this.lastHit=(new Date).getTime(),this.hp-=a,0>=this.hp&&gameOver())};Player.prototype.upgrade=function(){if(0==this.upgradeCount)this.canShoot=!0,this.upgradeName="Shooting enabled";else{var a=Player.upgradeList[randomRange(0,Player.upgradeList.length)];a.func(this);this.upgradeName=a.name}this.hp=this.hpMax;this.upgradeCount++;this.lastUpgrade=(new Date).getTime()};Player.upgradeFunction=function(a,b){this.name=a;this.func=b};
Player.upgradeList=[new Player.upgradeFunction("Speed increased",function(a){a.speedMax+=1;a.speedRotate+=trig.TAU/60;a.bulletSpeed+=1}),new Player.upgradeFunction("Damage increased",function(a){a.bulletRadius+=1;a.bulletDamage+=1}),new Player.upgradeFunction("HP increased",function(a){a.hpMax+=1})];Bullet=function(a,b,c,d,e){this.pos=a;this.dir=b;this.speed=c;this.radius=d;this.damage=e;this.alive=!0};
Bullet.prototype.update=function(){if(!this.alive)return!0;this.pos.moveDelta(this.dir,this.speed);return!drawing.calcShouldDrawCircle(this.pos.calcSub(g_g.camera),this.radius)||checkOutGameBounds(this.pos,this.radius)?(g_g.resetMultiplier(),!0):!1};Bullet.prototype.draw=function(){drawing.drawCircleForced(this.pos.calcSub(g_g.camera),this.radius);g_g.ctx.fillStyle="#fff";g_g.ctx.fill()};
Bullet.prototype.colliding=function(a,b){return this.pos.collidingCircles(this.radius,a,b)?(this.alive=!1,!0):!1};Movement=function(a,b){this.dir=a;this.speed=b};trig={};trig.TAU=2*Math.PI;trig.Coord=function(a,b){this.moveTo(a,b)};trig.Coord.prototype.moveTo=function(a,b){this.x=a;this.y=b};trig.Coord.prototype.resetPos=function(a){this.moveTo(a.x,a.y)};trig.Coord.prototype.move=function(a,b){this.x+=trig.moveX(a,b);this.y+=trig.moveY(a,b)};
trig.Coord.prototype.moveDelta=function(a,b){this.move(a,b*g_g.delta)};trig.Coord.prototype.calcMove=function(a,b){return new trig.Coord(this.x+trig.moveX(a,b),this.y+trig.moveY(a,b))};trig.Coord.prototype.dirTo=function(a){return trig.dirTo(this.x,this.y,a.x,a.y)};trig.Coord.prototype.disToSquared=function(a){return trig.disToSquared(this.x,this.y,a.x,a.y)};trig.Coord.prototype.disTo=function(a){return trig.disTo(this.x,this.y,a.x,a.y)};
trig.Coord.prototype.collidingCircles=function(a,b,c){return this.disTo(b)<=a+c};trig.Coord.prototype.add=function(a){this.x+=a.x;this.y+=a.y};trig.Coord.prototype.calcAdd=function(a){return new trig.Coord(this.x+a.x,this.y+a.y)};trig.Coord.prototype.calcSub=function(a){return new trig.Coord(this.x-a.x,this.y-a.y)};trig.Rect=function(a,b,c){this.pos=a;this.width=b;this.height=c};
trig.Rect.prototype.getIfHover=function(a){return a.x>=this.pos.x&&a.x<this.pos.x+this.width&&a.y>=this.pos.y&&a.y<this.pos.y+this.height};trig.toRads=function(a){return a*Math.PI/180};trig.toDegs=function(a){return 180/Math.PI*a};trig.dirWithin=function(a,b){return Math.abs(a)<=b||Math.abs(a+trig.TAU)<=b};trig.moveScalarX=function(a){return Math.cos(a)};trig.moveScalarY=function(a){return Math.sin(a)};trig.moveX=function(a,b){return b*trig.moveScalarX(a)};trig.moveY=function(a,b){return b*trig.moveScalarY(a)};
trig.move=function(a,b,c,d){return new trig.Coord(a+trig.moveX(c,d),b+trig.moveY(c,d))};trig.dirTo=function(a,b,c,d){a=Math.atan2(d-b,c-a);0>a&&(a+=2*Math.PI);return a};trig.disToSquared=function(a,b,c,d){return Math.pow(c-a,2)+Math.pow(d-b,2)};trig.disTo=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))};trig.normalizeDir=function(a){for(;a>=trig.TAU;)a-=trig.TAU;for(;0>a;)a+=trig.TAU;return a};trig.randomDir=function(){return randomRangeReal(0,trig.TAU)};var g_g={};
function main(){g_g.frameRate=60;g_g.fps=g_g.frameRate;g_g.thisTick=(new Date).getTime();g_g.lastTick=g_g.thisTick;g_g.delta=60/g_g.frameRate;g_g.canvas=document.getElementById("game");g_g.ctx=g_g.canvas.getContext("2d");setScreenSize();g_g.camera=new trig.Coord(0,0);g_g.mouse=new trig.Coord(0,0);g_g.mouseButtons={left:new Key,right:new Key};g_g.keys=[];for(var a=0;222>a;++a)g_g.keys.push(new Key);g_g.keyBinds={spacebar:32,shift:16,escape:27,key_p:80};g_g.glitchness={val:1,callbacks:[],inc:function(){this.incAmount(1)},
incAmount:function(a){this.val+=a;for(var c=0;c<this.callbacks.length;++c)this.callbacks[c][0](this.callbacks[c][1]);a--;0<a&&this.incAmount(a)},addCallback:function(a){this.callbacks.push(a)},reset:function(){this.val=1}};g_g.audioContext=new AudioContext;g_g.music=new TinyMusic.Sequence(g_g.audioContext,100,"C4 s;C4 s;Eb4 s;E4 s;G3 s;G3 s;G3 s;G3 s;D4 s;D4 s;F4 s;F4 s;G3 s;G3 s;G3 s;G3 s;Eb4 s;E4 s;G4 s;G4 s;Ab4 s;G4 s;A4 s;G4 s;A4 s;G4 s;A4 s;G4 s;Bb4 s;G4 s;E4 s;D4 s".split(";"));g_g.music.staccato=
.55;g_g.music.gain.gain.value=1;g_g.music.mid.frequency.value=800;g_g.music.mid.gain.value=3;g_g.playingMusic=!1;a=getCookie("high-score");""==a?(g_g.highScore=0,document.cookie="high-score=0"):g_g.highScore=parseInt(a);setInputCallbacks();loadMedia();g_g.screen=6;g_g.nextScreen=6;g_g.warningStart=(new Date).getTime();g_g.warningLength=5E3;g_g.titleScreen=new TitleScreen;g_g.startingMultiplier=3;g_g.nextMultiplier=g_g.startingMultiplier;g_g.instructions={};g_g.settings=new Settings;reset();"undefined"!=
typeof g_g.gameLoop&&clearInterval(g_g.gameLoop);g_g.gameLoop=setInterval(update,1E3/g_g.frameRate)}function screenChange(a){g_g.nextScreen=a;4==g_g.nextScreen&&(g_g.instructions=new Instructions)}function screenFinalize(){g_g.screen=g_g.nextScreen}function calcText(a,b,c){var d=12;g_g.ctx.font=d.toString()+("px "+c);a=g_g.ctx.measureText(a).width;d=d/a*g_g.canvas.width*b;return{width:a,size:d}}
function drawResponsiveText(a,b,c,d,e){d=calcText(a,d,e);g_g.ctx.font=d.size.toString()+"px "+e;g_g.ctx.fillText(a,b,c);return d}function reset(){g_g.glitchness.reset();g_g.center=new trig.Coord(0,0);g_g.boundsDistance=5E3;g_g.averageFps=g_g.frameRate;g_g.score=0;g_g.multiplier=1;g_g.currentMultiplierCount=0;g_g.nextMultiplier=g_g.startingMultiplier;g_g.player=new Player;g_g.particleSystem=new ParticleSystem;g_g.level=new Level}
function update(){g_g.thisTick=(new Date).getTime();g_g.fps=1E3/(g_g.thisTick-g_g.lastTick);g_g.delta=0==g_g.fps?0:60/g_g.fps;g_g.averageFps=.9*g_g.averageFps+g_g.fps*(1-.9);if(0==g_g.screen)g_g.playingMusic||(g_g.music.play(g_g.audioContext.currentTime),g_g.playingMusic=!0),g_g.titleScreen.update();else if(1==g_g.screen)g_g.keyPause()&&screenChange(5),g_g.player.update(),g_g.camera.x=g_g.player.pos.x-g_g.canvas.width/2,g_g.camera.y=g_g.player.pos.y-g_g.canvas.height/2,g_g.particleSystem.update(),
g_g.level.update();else if(2==g_g.screen)(new Date).getTime()>g_g.gameOverTime+1500&&TitleScreen.getActionPressed()&&(screenChange(1),reset());else if(3==g_g.screen)g_g.settings.update();else if(4==g_g.screen)g_g.instructions.update();else if(5==g_g.screen)g_g.titleScreen.update();else if(6==g_g.screen){var a=(new Date).getTime()-g_g.warningStart;(a>g_g.warningLength||1E3<a&&TitleScreen.getActionPressed())&&screenChange(0)}g_g.ctx.fillStyle="#000";g_g.ctx.fillRect(0,0,g_g.canvas.width,g_g.canvas.height);
if(0==g_g.screen)g_g.titleScreen.draw();else if(1==g_g.screen)g_g.particleSystem.draw(),g_g.level.draw(),g_g.player.draw(),g_g.center.disTo(g_g.player.pos)>g_g.boundsDistance-2E3&&(drawing.drawCircleForced(g_g.center.calcSub(g_g.camera),g_g.boundsDistance+4),g_g.ctx.strokeStyle="#0af",g_g.ctx.lineWidth=6,g_g.ctx.stroke(),g_g.ctx.lineWidth=1),g_g.particleSystem.drawLast(),g_g.ctx.font=(36).toString()+"px Arial",g_g.ctx.fillStyle="#fff",g_g.ctx.textAlign="left",g_g.ctx.textBaseline="top",g_g.ctx.fillText(g_g.score,
10,10),g_g.ctx.fillText("x "+g_g.multiplier.toString()+" ("+(g_g.nextMultiplier-g_g.currentMultiplierCount)+")",10,51),g_g.ctx.fillStyle="#f00",g_g.ctx.font="30px Arial",g_g.ctx.textAlign="right",g_g.ctx.fillText("Level "+g_g.glitchness.val.toString(),g_g.canvas.width-45,40);else if(2==g_g.screen){g_g.ctx.fillStyle="#f00";g_g.ctx.textAlign="center";g_g.ctx.textBaseline="middle";var a=1/3*g_g.canvas.height,b=.5*g_g.canvas.width,a=a+(drawResponsiveText("YOU DIED",b,a,.5,"Georgia").size+40);g_g.ctx.fillStyle=
"#fff";a+=drawResponsiveText("Score: "+g_g.score.toString(),b,a,.15,"Arial").size+40;a+=drawResponsiveText("Level: "+g_g.glitchness.val.toString(),b,a,.15,"Arial").size+40;drawResponsiveText("High Score: "+g_g.highScore.toString(),b,a,.125,"Arial");g_g.ctx.textBaseline="top"}else 3==g_g.screen?g_g.settings.draw():4==g_g.screen?g_g.instructions.draw():5==g_g.screen?g_g.titleScreen.draw():6==g_g.screen&&(g_g.ctx.fillStyle="#fff",g_g.ctx.textAlign="center",g_g.ctx.globalAlpha=1-((new Date).getTime()-
g_g.warningStart)/g_g.warningLength,drawResponsiveText("Do not play if you have a history of epilepsy",g_g.canvas.width/2,g_g.canvas.height/2,.3,"Georgia"),g_g.ctx.globalAlpha=1);g_g.mouseButtons.left.update();g_g.mouseButtons.right.update();loopCall(g_g.keys,"update");screenFinalize();g_g.lastTick=g_g.thisTick}function gameOver(){screenChange(2);g_g.gameOverTime=(new Date).getTime();g_g.score>g_g.highScore&&(g_g.highScore=g_g.score,document.cookie="high-score="+g_g.score.toString())}
function loadMedia(){}function setScreenSize(){g_g.canvas.width=Math.min(1920,window.innerWidth);g_g.canvas.height=Math.min(1080,window.innerHeight)}function screenX(a){return a-g_g.camera.x}function screenY(a){return a-g_g.camera.y}function realX(a){return a+g_g.camera.x}function realY(a){return a+g_g.camera.y}function stayInGameBounds(a,b){if(checkOutGameBounds(a,b)){var c=g_g.center.dirTo(a);a.resetPos(g_g.center.calcMove(c,g_g.boundsDistance-b))}}
function checkOutGameBounds(a,b){return g_g.center.disTo(a)+b>g_g.boundsDistance}RgbColor=function(a,b,c){this.r=a;this.g=b;this.b=c};RgbColor.prototype.get=function(){return"rgb("+this.r.toString()+","+this.g.toString()+","+this.b.toString()+")"};function randomRange(a,b){return Math.floor(randomRangeReal(a,b))}function randomRangeReal(a,b){return Math.random()*(b-a)+a}function loopCall(a,b){for(var c=0;c<a.length;++c)a[c][b]()}
function getCookie(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;c++){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return""}g_g.enemyKilled=function(){g_g.currentMultiplierCount++;g_g.currentMultiplierCount==g_g.nextMultiplier&&(g_g.nextMultiplier*=2,g_g.currentMultiplierCount=0,g_g.multiplier++)};g_g.resetMultiplier=function(){g_g.multiplier=1;g_g.nextMultiplier=g_g.startingMultiplier;g_g.currentMultiplierCount=0};
g_g.increaseScore=function(a){g_g.increaseScorePure(a*g_g.multiplier)};g_g.increaseScorePure=function(a){g_g.score+=a*g_g.settings.options.difficulty.current};Key=function(){this.down=this.released=this.pressed=!1};Key.prototype.press=function(){0==this.down&&(this.down=this.pressed=!0)};Key.prototype.release=function(){this.released=!0;this.down=!1};Key.prototype.update=function(){this.released=this.pressed=!1};
function getMouseButtonIsLeft(a){return a==("Microsoft Internet Explorer"==navigator.appName?1:0)}g_g.keyPause=function(){return g_g.keys[g_g.keyBinds.escape].pressed||g_g.keys[g_g.keyBinds.key_p].pressed};
function setInputCallbacks(){document.addEventListener("mousemove",function(a){var b=g_g.canvas.getBoundingClientRect();g_g.mouse.x=a.clientX-b.left;g_g.mouse.y=a.clientY-b.top},!1);window.onresize=function(){setScreenSize()};document.onmousedown=function(a){getMouseButtonIsLeft(a.button)?g_g.mouseButtons.left.press():g_g.mouseButtons.right.press()};document.onmouseup=function(a){getMouseButtonIsLeft(a.button)?g_g.mouseButtons.left.release():g_g.mouseButtons.right.release()};document.onkeydown=function(a){g_g.keys[a.which].press()};
document.onkeyup=function(a){g_g.keys[a.which].release()}}main();