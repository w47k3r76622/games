(function(f,e){"function"===typeof define&&define.amd?define(["exports"],e):"object"===typeof exports&&"string"!==typeof exports.nodeName?e(exports):e(f.TinyMusic={})})(this,function(f){function e(a){a=a.split(h);this.frequency=e.getFrequency(a[0])||0;this.duration=e.getDuration(a[1])||0}function d(a,b,c){this.ac=a||new AudioContext;this.createFxNodes();this.tempo=b||120;this.loop=!0;this.staccato=this.smoothing=0;this.notes=[];this.push.apply(this,c||[])}var k=440*Math.pow(Math.pow(2,1/12),-9),l=
/^[0-9.]+$/,h=/\s+/,m=/(\d+)/,g={};"B#-C C#-Db D D#-Eb E-Fb E#-F F#-Gb G G#-Ab A A#-Bb B-Cb".split(" ").forEach(function(a,b){a.split("-").forEach(function(a){g[a]=b})});e.getFrequency=function(a){a=a.split(m);return k*Math.pow(Math.pow(2,1/12),g[a[0]])*Math.pow(2,(a[1]||4)-4)};e.getDuration=function(a){return l.test(a)?parseFloat(a):a.toLowerCase().split("").reduce(function(a,c){return a+("w"===c?4:"h"===c?2:"q"===c?1:"e"===c?.5:"s"===c?.25:0)},0)};d.prototype.createFxNodes=function(){var a=this.gain=
this.ac.createGain();[["bass",100],["mid",1E3],["treble",2500]].forEach(function(b,c){c=this[b[0]]=this.ac.createBiquadFilter();c.type="peaking";c.frequency.value=b[1];a.connect(a=c)}.bind(this));a.connect(this.ac.destination);return this};d.prototype.push=function(){Array.prototype.forEach.call(arguments,function(a){this.notes.push(a instanceof e?a:new e(a))}.bind(this));return this};d.prototype.createCustomWave=function(a,b){b||(b=a);this.waveType="custom";this.customWave=[new Float32Array(a),new Float32Array(b)]};
d.prototype.createOscillator=function(){this.stop();this.osc=this.ac.createOscillator();this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square";this.osc.connect(this.gain);return this};d.prototype.scheduleNote=function(a,b){var c=60/this.tempo*this.notes[a].duration,d=c*(1-(this.staccato||0));this.setFrequency(this.notes[a].frequency,b);this.smoothing&&this.notes[a].frequency&&this.slide(a,b,d);this.setFrequency(0,b+
d);return b+c};d.prototype.getNextNote=function(a){return this.notes[a<this.notes.length-1?a+1:0]};d.prototype.getSlideStartDelay=function(a){return a-Math.min(a,60/this.tempo*this.smoothing)};d.prototype.slide=function(a,b,c){var d=this.getNextNote(a),e=this.getSlideStartDelay(c);this.setFrequency(this.notes[a].frequency,b+e);this.rampFrequency(d.frequency,b+c);return this};d.prototype.setFrequency=function(a,b){this.osc.frequency.setValueAtTime(a,b);return this};d.prototype.rampFrequency=function(a,
b){this.osc.frequency.linearRampToValueAtTime(a,b);return this};d.prototype.play=function(a){a="number"===typeof a?a:this.ac.currentTime;this.createOscillator();this.osc.start(a);this.notes.forEach(function(b,c){a=this.scheduleNote(c,a)}.bind(this));this.osc.stop(a);this.osc.onended=this.loop?this.play.bind(this,a):null;return this};d.prototype.stop=function(){this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null);return this};f.Note=e;f.Sequence=d});
