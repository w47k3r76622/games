const SAMPLE_RATE=44e3;function Square(_){let e=0,t=2**(_/12)*1.24;return function _(){let s=(e*t/2&128)/96-.75;if(!(++e>=8800))return .2*s*Math.pow(.99985,e)}}function Tri(_){let e=0,t=2**(_/12)/1.24;return function _(){let s=Math.tan(Math.cbrt(Math.sin(e*t/30)));if(!(++e>=44e3))return s*Math.pow(.9999,2*e)*.2}}const genNotes=_=>_.split(",").map(_=>{let e=_.split(" ").flatMap(_=>isNaN(parseInt(_))?[]:[parseInt(_)]);return e}),lowPart1="11 -1 11,,11 15 18,,-9 3,,11 15 18,,-2 10,,18 13 10 10,,3 -9,,18 13 10 10,,",lowPart2="10 -2 10,,13 9 4,,3 -9,,9 13 4,,3 -9,,10 13 6,,4 -8,,-6 6 10 13,",low=`${lowPart1}${lowPart1}${lowPart1}${lowPart2},11 -1,,11 15 18,,-9 3,,11 15 18,,-2 10,,18 13 10 10,,3 -9,,18 13 10 10,,${lowPart1}${lowPart1}${lowPart2}`,lowNotes={gen:Square,notes:genNotes(`${low},${low},,,`)},highPart1="17,18 6,19 7,20 8,21 9,,22 10,,23 11,,24 12,,25 13,,26 14,,27 15 26,,27 15 26,,27 15 26,,",highPart2="27 15 26,,27 15 26,,26 14,,25 13,,24 12,,5",highPart3="5 17 22 29,,5 17 20 29,,,,5 17 21 29,,0 12 21 29,,4 21 16 28,,3 21 15 27,,2 21 14 26,,4 12 24,,2 14 26,,1 13 25,,0 12 24,,3 -1 11 23,,0 12 24,,-2 10 22,,-2 10 22,,29 24 21 19 14,,29 21 19 14 24,,,,29 21 19 14,,29 14 19 21,,28 21 17 12,,27 21 16 11,,26 21 14,,-6 18,29 17,16 28,27 15,26 14,25 13,24 12,23 11,22 10,21 9,20 8,19 7,18 6,17 5,16 4,15 3,17 28 29,,17 29,,17 29,,17 29,,17 29,,28 15,,27 14,,26 13,,25 12,,24 11,,23 10,,22 9,,21 8,,22 10,,23 11,,24 12,,12 17 28 29 5,,28 17 12 5 29 24,,28 26 17 12 5 29,,28 17 12 5 29,,28 17 12 5 29,,4 16 28,,27 15,,26 14,,25 13,,,,19 8,,6,,5 17,,,,14",highNotes={gen:Tri,notes:genNotes(`5 9 ${highPart1} ${highPart2} ${highPart1} 26 15,,27 26 15,,27 26 15,,28 16,,28 16,,5 ${highPart1} ${highPart2} 17,18 6,19 7,20 8,21 9,,22 10,22 10,23 11,,24 12,,25 13,,26 14,,27 15 26,,27 15 26,,27 15 26,,27 26 15,,28 16,,28 16,,28 16,,28 16,,5 17 22 29,,5 17 20 29,,,,5 17 21 29,,0 12 21 29,,4 21 16 28,,3 21 15 27,,2 21 14 26,,4 12 24,,2 14 26,,1 13 25,,0 12 24,,3 -1 11 23,,0 12 24,,-2 10 22,,-2 10 22,,29 24 21 19 14,,29 21 19 14 24,,,,29 21 19 14,,29 14 19 21,,28 21 17 12,,27 21 16 11,,26 21 14,,-6 18,29 17,16 28,27 15,26 14,25 13,24 12,23 11,22 10,21 9,20 8,19 7,18 6,17 5,16 4,15 3,17 28 29,,17 29,,17 29,,17 29,,17 29,,28 15,,27 14,,26 13,,25 12,,24 11,,23 10,,22 9,,21 8,,22 10,,23 11,,24 12,,12 17 28 29 5,,28 17 12 5 29 24,,28 26 17 12 5 29,,28 17 12 5 29,,28 17 12 5 29,,4 16 28,,27 15,,26 14,,25 13,,,,19 8,,6,,5 17,,,,14,,,`)},speedUpNotes={gen:Tri,notes:genNotes("17 29,30 18,31 19,32 20,33 21,34 22,23 35,36 24")};let music=[highNotes,lowNotes],queue=[];const noteLength=5500,processNote=(_,e,t)=>{_=Math.round(_*e);let s=0;if((_|=0)%5500==0){for(let $ of t)if(void 0!==$.notes[_/5500]){let r=$.notes[_/5500];for(let n of r)queue.push($.gen(n))}}for(let o=0;o<queue.length;++o){let i=queue[o]();void 0!==i?s+=i:queue.splice(o,1)}return s/8},STATE_NORMAL=0,STATE_ONLY_LOW=1,STATE_WAITING=2;class MusicProcessor extends AudioWorkletProcessor{speedUp=!1;playbackRate=1;state=0;constructor(){super(),this.currentIndex=0,this.chunkSize=128,this.sampleCount=44e3*highNotes.notes.length/8,this.port.onmessage=this.handleMessage.bind(this)}handleMessage(_){let e=_.data;"speed-up"===e.name&&(this.speedUp=!0,this.currentIndex=0),"voices"!==e.name||(e.high&&1===this.state?this.state=2:e.high||(this.state=1,music=[lowNotes]))}process(_,e,t){let s=e[0][0],$=this.currentIndex,r=this.currentIndex+this.chunkSize,n=44e3/this.playbackRate;for(let o=$;o<r;o++)s[o-$]=processNote(o,this.playbackRate,this.speedUp?[speedUpNotes]:music);this.currentIndex=r,this.speedUp&&this.currentIndex>speedUpNotes.notes.length*n/8&&(this.currentIndex=0,this.speedUp=!1,this.playbackRate=1.2);let i=this.sampleCount/this.playbackRate;return this.currentIndex>i&&(this.currentIndex=0),(0===this.currentIndex||this.currentIndex>=i/4)&&2===this.state&&(this.currentIndex=0,this.state=0,music=[highNotes,lowNotes]),!0}}registerProcessor("music-processor",MusicProcessor);