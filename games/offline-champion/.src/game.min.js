var GAME={settings:{}};GAME.settings.FPS=60,GAME.settings.second=1e3,GAME.settings.res={x:256,y:144},GAME.settings.frameDelay=GAME.settings.second/GAME.settings.FPS,GAME.settings.scale=5,GAME.settings.soundVolume=.009,function(c){c.assets={},c.loadAssets=function(e,t){var n,s,a,r=e.length,i=0,o=function(){(i+=1)===r&&t()};for(n=0;n<r;n++)s=e[n],(a=new Image).src="assets/"+s.name+".png",a.addEventListener("load",o),s.spriteSheet=a,c.assets[s.name]=s}}(GAME),function(s){s.objects={},s.staticObjects={},s.objectSkipFrameCount={},s.createObject=function(e,t){var n=e.objectName;s.objects[n]={x:e.x,y:e.y,z:e.z,skipFrameCount:0,currentAsset:{loop:e.loop,frameIndex:0,asset:e.defaultAsset},nextFrame:function(e){this.currentAsset.frameIndex=e},setAsset:function(e,t){this.currentAsset={frameIndex:0,loop:t,asset:e},this.skipFrameCount=0}},t&&t(s.objects[n])}}(GAME),function(b){function n(e,t){return b.input.isKeyPressed(e.keys[t])}function s(e){return b.input.isKeyPressed(b.state.mode[e])}function x(e){return!e.cooldown&&!e.stunned&&b.input.isKeyPressed(e.keys.hit)}function S(e){var t=e.cooldown&&F(e);return{forward:!t&&n(e,"forward"),back:!t&&n(e,"back")}}function F(e){return e.defaultRestoreHitDelay/e.restoreHitDelay<=b.gameplay.hitFreeze}function a(e,t){e.currentAsset.asset!==t&&e.setAsset(t,!0)}function k(e){return e.hitA.width-e.idleA.width}function j(e,t,n){var s=e.currentAsset.asset,a=t.currentAsset.asset,r=t.x+a.width/2;return n?e.x<r:e.x+s.width>r}function I(e,t,n){return t.currentAsset.asset!==t.hitA&&j(e,t,n)}function O(e,t,n){e.cooldown=!0,n&&0<t.life&&(t.stunned=!0,t.life-=e.damage)}function u(e){e.prevX&&(e.x=e.prevX,delete e.prevX)}function C(e){var t=e.currentAsset.asset===e.hitA;(e.cooldown||e.stunned||t)&&(e.restoreHitDelay-=1,0===e.restoreHitDelay&&(e.restoreHitDelay=e.defaultRestoreHitDelay,e.cooldown=!1,e.stunned=!1,a(e,e.idleA),u(e)))}function E(e,t,n){var s=t.forward,a=t.back,r=l(t),i=e.currentAsset.asset,o=e.speed,c=e.x;return r?(u(e),s?c=e.x+o:a&&(c=e.x-o),(c+i.width>b.settings.res.x||c<0)&&(c=e.x)):i===e.walkA&&u(e),c}function l(e){return e.forward||e.back}function M(e,t){var n=e.currentAsset.asset;l(t)?a(e,e.walkA):(n===e.walkA||e.cooldown&&!F(e))&&(u(e),a(e,e.idleA))}function r(e,t,n){var s,a,r,i,o,c=x(e),u=S(e);b.state.isSinglePlayer()?(r=t,s||(r.cooldown?o=!F(r):r.stunned?o=!0:i=!0),s=function(e,t,n){var s,a={currentAsset:e.currentAsset,damage:e.damage,x:e.x-k(e)+b.AI.hitAdditionalSteps*e.speed};if(n.back&&!b.AI.currentHitChance&&(b.AI.hitChance=Math.floor(100*Math.random())),!e.cooldown&&!e.stunned&&j(a,t,!0))return e.cooldown=!0,s=b.AI.hitChance,b.AI.hitChance=null,s>b.AI.currentMissChance}(t,e,a={forward:o,back:i})):(s=x(t),a=S(t));var l,d,f,h,g,y,p,m,A,v=E(e,u),w=E(t,a);c?(e.setAsset(e.hitA,!0),O(e,t,I(e,t)),b.hitSound.unfreeze()):s?(t.currentAsset.asset!==t.hitA&&(t.setAsset(t.hitA,!0),t.prevX=t.x,t.x-=k(t)),O(t,e,I(t,e,!0)),b.hitSound.unfreeze()):(d=t,f=v,h=w,g=(l=e).currentAsset.asset.width,y=d.currentAsset.asset,p=b.gameplay.walkCollisionMod,m=f+g-g/p,A=h+y.width/p,m<A&&(l.x=f),m<A&&(d.x=h),M(e,u),M(t,a)),C(e),C(t)}function i(e,t,n){var s;e.life<=0?(b.state.over=!0,s=e):t.life<=0&&(b.state.over=!0,s=t);var a,r,i=s===t;(b.state.offlineFighter=s)&&(s.y<b.settings.res.y?s.y+=s.speed:(b.state.over=!1,b.state.offlineFighter=!1,c(),a=i,r=b.state.level,b.state.isSinglePlayer()&&((r+=1)<=b.state.maxLevel&&a?(b.state.level=r,b.objects.redFighter.life=b.gameplay.fightersBaseLife+10*r,b.AI.currentMissChance-=b.AI.missChanceStep):d())))}function o(){b.input.isKeyPressed(b.state.pauseKey)&&b.state.modeSelected?b.state.pauseKeyUnpressed&&(b.state.pauseKeyUnpressed=!1,b.state.gamePaused=!b.state.gamePaused):b.state.pauseKeyUnpressed=!0}function c(){b.createBlueFighter(),b.createRedFighter()}function d(){b.state.over=!1,b.state.level=1,b.state.modeSelected=!1,b.state.gamePaused=!1,b.AI.currentMissChance=b.AI.missChance,c()}b.updateObjects=function(e){var t=b.objects.blueFighter,n=b.objects.redFighter;o(),b.state.gamePaused||(s(1)?(d(),b.state.modeSelected=1):s(2)&&(d(),b.state.modeSelected=2),b.state.modeSelected&&!b.state.over&&r(t,n),i(t,n)),Object.values(b.objects).forEach(function(e){var t=e.currentAsset,n=t.asset,s=n.fps,a=n.frameCount-1,r=t.frameIndex,i=Math.round(b.settings.FPS/s);e.skipFrameCount>=i&&(r<a?r+=1:t.loop&&(r=0),e.nextFrame(r),e.skipFrameCount=1),e.skipFrameCount+=1})}}(GAME),function(u){function a(e,t,n,s,a,r){for(var i=s.gap,o=s.w,c=s.h,u=s.y,l=0;l<n;l++)a.fillStyle=t,a.fillRect(e,u,o,c),e=r?e-o-i:e+o+i}function l(e,t,n,s,a,r,i){i.font=t,i.fillStyle=n,i.textAlign=s,i.fillText(e,a,r)}u.drawGameOver=function(e){var t=u.staticObjects.gameOver,n=u.state.level===u.state.maxLevel,s=u.state.offlineFighter,a=u.objects.blueFighter,r=u.objects.redFighter,i=s===a,o=s===r,c=u.state.isSinglePlayer();u.state.over&&(c&&n&&o?l(t.tW,t.f,a.color,t.tA,t.x,t.y,e):c&&i?l(t.tL,t.f,r.color,t.tA,t.x,t.y,e):l(t.t,t.f,s.color,t.tA,t.x,t.y,e))},u.drawLevel=function(e){var t=u.staticObjects.level;u.state.isSinglePlayer()?l(t.t+" "+u.state.level,t.f,t.color,t.tA,t.x,t.y,e):u.state.isMultiPlayer()&&l(t.tM,t.f,t.color,t.tA,t.x,t.y,e)},u.drawPause=function(e){var t=u.staticObjects.pause;u.state.gamePaused&&l(t.t,t.f,t.color,t.tA,t.x,t.y,e)},u.drawGameInfo=function(t){var n=u.staticObjects.gameInfo;u.state.modeSelected||n.lines.forEach(function(e){l(e.t,n.f,n.color,n.tA,e.x,e.y,t)})},u.clearScreen=function(e){e.clearRect(0,0,u.settings.res.x,u.settings.res.y)},u.drawStaticLine=function(e){var t=u.staticObjects.line,n=t.x1,s=t.x2,a=t.y;e.beginPath(),e.moveTo(n,a),e.lineTo(s,a),e.strokeStyle=t.color,e.stroke()},u.drawLifeBars=function(e){var t=u.objects.blueFighter,n=u.objects.redFighter,s=u.staticObjects.lifeSeg;a(t.lifeSegX,t.color,t.life/s.q,s,e),a(n.lifeSegX,n.color,n.life/s.q,s,e,!0)},u.drawObject=function(e,t){var n=e.currentAsset,s=n.asset;t.drawImage(n.asset.spriteSheet,0,n.frameIndex*s.height,s.width,s.height,e.x,e.y,s.width,s.height)},u.drawObjects=function(t){Object.values(u.objects).sort(function(e,t){return e.z-t.z}).forEach(function(e){u.drawObject(e,t)})}}(GAME),function(i){i.update=function(e,t){i.updateObjects(e,t)},i.redraw=function(e){i.clearScreen(e),i.drawObjects(e),i.drawStaticLine(e),i.drawLifeBars(e),i.drawGameOver(e),i.drawLevel(e),i.drawPause(e),i.drawGameInfo(e)},i.start=function(s){var a=Date.now(),r=0;window.requestAnimationFrame(function e(){var t=Date.now(),n=i.settings.frameDelay;for(r+=t-a;n<=r;)i.update(s),i.playSound(),r-=n;i.redraw(s),a=t,window.requestAnimationFrame(e)})}}(GAME),function(t){var e=document.body;function n(e){return e.key.toLowerCase()}t.input={keys:{}},t.input.isKeyPressed=function(e){return e.find(function(e){return t.input.keys[e]})},e.addEventListener("keydown",function(e){t.input.keys[n(e)]=!0}),e.addEventListener("keyup",function(e){t.input.keys[n(e)]=!1})}(GAME),function(s){var f=new(window.AudioContext||window.webkitAudioContext),i=f.createGain();function h(a,e,r){e.forEach(function(e,t){var n,s=a[t];s&&(e.frequency.value=(n=s,Math.round(440*Math.pow(2,(n-49)/12))),r[t]=!0,e.connect(i))})}function g(e,n){e.forEach(function(e,t){n[t]&&e.disconnect(i),n[t]=!1})}function a(e){return s.input.isKeyPressed(s.sound.keys[e])}i.gain.value=s.settings.soundVolume,i.connect(f.destination),s.changeVolume=function(e){var t=i.gain,n=t.value+e;n<0?n=0:1<n&&(n=1),t.value=n},s.createSound=function(n,e,t,s){var a=function(e,t){for(var n=[],s=0;s<e;s++){var a=f.createOscillator();a.type=t,a.start(),n.push(a)}return n}(s,e),r=[],i=[1];n=n.reduce(function(e,t){return e.push(t),e.push(i),e},[]);var o=null,c=0,u=0,l=!1;function d(e){var t=n[c=e||0];o={value:t[0],notes:t.slice(1,t.length)}}return{loop:t,frozen:!1,play:function(){var e;if(!this.frozen){if(o){if(u>o.value)if(l=!1,u=0,n[e=c+1])d(e),g(a,r);else{if(!this.loop)return this.frozen=!0,void this.stop();this.stop(),d()}}else d();l||(l=!0,h(o.notes,a,r)),u+=1}},freeze:function(){this.frozen=!0},unfreeze:function(){this.frozen=!1},stop:function(){o=null,u=c=0,l=!1,g(a,r)}}},s.playSound=function(){var e=a("up"),t=a("down"),n=s.sound.volumeStep;e?s.changeVolume(n):t&&s.changeVolume(-1*n),s.hitSound.play(),s.bkgSound.play()}}(GAME),function(C){var e;function t(e){return{name:e,width:48,height:48,frameCount:4,fps:2}}function n(e){return{name:e,width:48,height:48,frameCount:2,fps:4}}function s(e){return{name:e,width:64,height:48,frameCount:1,fps:1}}C.loadAssets([t("blueFighterIdle"),n("blueFighterWalk"),s("blueFighterHit"),t("redFighterIdle"),n("redFighterWalk"),s("redFighterHit"),(e="crowd",{name:e,width:256,height:50,frameCount:2,fps:1})],function(){var t=C.assets.blueFighterIdle,n=C.assets.redFighterIdle;C.createObject({objectName:"crowd",defaultAsset:C.assets.crowd,loop:!0,x:0,y:94,z:3}),C.createBlueFighter=function(){C.createObject({objectName:"blueFighter",defaultAsset:t,loop:!0,x:25,y:35,z:1},function(e){e.color="#008BB8",e.lifeSegX=6,e.idleA=t,e.walkA=C.assets.blueFighterWalk,e.hitA=C.assets.blueFighterHit,e.defaultRestoreHitDelay=C.settings.FPS,e.restoreHitDelay=e.defaultRestoreHitDelay,e.damage=10,e.life=C.gameplay.fightersBaseLife,e.speed=1,e.keys={forward:["d"],back:["a","q"],hit:["s"]}})},C.createRedFighter=function(){C.createObject({objectName:"redFighter",defaultAsset:n,loop:!0,x:183,y:35,z:2},function(e){e.color="#FC4E51",e.lifeSegX=247,e.idleA=n,e.walkA=C.assets.redFighterWalk,e.hitA=C.assets.redFighterHit,e.defaultRestoreHitDelay=C.settings.FPS,e.restoreHitDelay=e.defaultRestoreHitDelay,e.damage=10,e.life=C.gameplay.fightersBaseLife,e.speed=1,e.keys={forward:["arrowright"],back:["arrowleft"],hit:["arrowdown"]}})};var e="#191970";C.staticObjects.line={color:e,x1:4,x2:252,h:1,y:83.5},C.staticObjects.lifeSeg={w:3,h:3,gap:3,y:6,q:10};var s="px monospace",a="center",r=128;C.staticObjects.gameOver={t:"OFFLINE",tW:"OFFLINE CHAMPION",tL:"YOU ARE OFFLINE",tA:a,f:16+s,x:r,y:72},C.staticObjects.level={t:"LEVEL",tM:"FIGHT",color:e,tA:a,f:8+s,x:r,y:11},C.staticObjects.pause={t:"PAUSE",color:e,tA:a,f:16+s,x:r,y:72},C.staticObjects.gameInfo={lines:[{t:"press '1' for singleplayer",x:r,y:18},{t:"press '2' for multiplayer",x:r,y:26},{t:"controls:",x:r,y:40},{t:"1st player: A(Q),S,D",x:r,y:52},{t:"2nd player: arrow keys",x:r,y:60},{t:"volume: I,O",x:r,y:68},{t:"pause: P",x:r,y:76},{t:"rules:",x:r,y:94},{t:"both players are standing 'online'",x:r,y:102},{t:"to win knock the other player 'offline'!",x:r,y:110}],color:e,tA:a,f:6+s},C.gameplay={fightersBaseLife:100,hitFreeze:1.5,walkCollisionMod:6},C.AI={missChance:70,currentMissChance:70,missChanceStep:10,hitAdditionalSteps:0},C.state={level:1,maxLevel:5,modeSelected:null,mode:{1:["1"],2:["2"]},gamePaused:!1,pauseKey:["p"],isSinglePlayer:function(){return 1===this.modeSelected},isMultiPlayer:function(){return 2===this.modeSelected},init:function(){C.createBlueFighter(),C.createRedFighter(),this.isSinglePlayer()&&(C.AI.currentMissChance=C.AI.currentMissChance-C.AI.missChanceStep*this.level,C.objects.redFighter.life=C.gameplay.fightersBaseLife+10*this.level)}},C.sound={volumeStep:.001,keys:{up:["o"],down:["i"]}};var i=60*C.settings.FPS/175,o=i/2,c=3*i,u=[49,54],l=[i].concat(u),d=[o].concat(u),f=[c].concat(u),h=[52,57],g=[i].concat(h),y=[o].concat(h),p=[56,61],m=[i].concat(p),A=[c].concat(p),v=[45,50],w=[i].concat(v),b=[o].concat(v),x=[42,47],S=[i].concat(x),F=[l,l,d,y,m,l,l,w,w,b,d,g,w,w,S,S,[o].concat(x),b,l,S,S],k=[g,l,g,A],j=[g,[i].concat([51,56]),[i].concat([47,52]),f],I=F.concat(k).concat(F).concat(j);C.bkgSound=C.createSound(I,"square",!0,2),C.hitSound=C.createSound([[o,25]],"square",!1,1),C.hitSound.freeze();var O=document.getElementById("game").getContext("2d");O.imageSmoothingEnabled=!1,O.scale(C.settings.scale,C.settings.scale),C.state.init(),C.start(O)})}(GAME);
