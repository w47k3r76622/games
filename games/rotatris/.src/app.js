/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

var requirejs,require,define;!function(t){function i(t,i){return w.call(t,i)}function e(t,i){var e,n,s,o,r,h,a,u,c,d,f,l=i&&i.split("/"),p=m.map,g=p&&p["*"]||{};if(t&&"."===t.charAt(0))if(i){for(t=t.split("/"),r=t.length-1,m.nodeIdCompat&&y.test(t[r])&&(t[r]=t[r].replace(y,"")),t=l.slice(0,l.length-1).concat(t),c=0;c<t.length;c+=1)if(f=t[c],"."===f)t.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((l||g)&&p){for(e=t.split("/"),c=e.length;c>0;c-=1){if(n=e.slice(0,c).join("/"),l)for(d=l.length;d>0;d-=1)if(s=p[l.slice(0,d).join("/")],s&&(s=s[n])){o=s,h=c;break}if(o)break;!a&&g&&g[n]&&(a=g[n],u=c)}!o&&a&&(o=a,h=u),o&&(e.splice(0,h,o),t=e.join("/"))}return t}function n(i,e){return function(){var n=v.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),c.apply(t,n.concat([i,e]))}}function s(t){return function(i){return e(i,t)}}function o(t){return function(i){l[t]=i}}function r(e){if(i(p,e)){var n=p[e];delete p[e],g[e]=!0,u.apply(t,n)}if(!i(l,e)&&!i(g,e))throw new Error("No "+e);return l[e]}function h(t){var i,e=t?t.indexOf("!"):-1;return e>-1&&(i=t.substring(0,e),t=t.substring(e+1,t.length)),[i,t]}function a(t){return function(){return m&&m.config&&m.config[t]||{}}}var u,c,d,f,l={},p={},m={},g={},w=Object.prototype.hasOwnProperty,v=[].slice,y=/\.js$/;d=function(t,i){var n,o=h(t),a=o[0];return t=o[1],a&&(a=e(a,i),n=r(a)),a?t=n&&n.normalize?n.normalize(t,s(i)):e(t,i):(t=e(t,i),o=h(t),a=o[0],t=o[1],a&&(n=r(a))),{f:a?a+"!"+t:t,n:t,pr:a,p:n}},f={require:function(t){return n(t)},exports:function(t){var i=l[t];return"undefined"!=typeof i?i:l[t]={}},module:function(t){return{id:t,uri:"",exports:l[t],config:a(t)}}},u=function(e,s,h,a){var u,c,m,w,v,y,b=[],x=typeof h;if(a=a||e,"undefined"===x||"function"===x){for(s=!s.length&&h.length?["require","exports","module"]:s,v=0;v<s.length;v+=1)if(w=d(s[v],a),c=w.f,"require"===c)b[v]=f.require(e);else if("exports"===c)b[v]=f.exports(e),y=!0;else if("module"===c)u=b[v]=f.module(e);else if(i(l,c)||i(p,c)||i(g,c))b[v]=r(c);else{if(!w.p)throw new Error(e+" missing "+c);w.p.load(w.n,n(a,!0),o(c),{}),b[v]=l[c]}m=h?h.apply(l[e],b):void 0,e&&(u&&u.exports!==t&&u.exports!==l[e]?l[e]=u.exports:m===t&&y||(l[e]=m))}else e&&(l[e]=h)},requirejs=require=c=function(i,e,n,s,o){if("string"==typeof i)return f[i]?f[i](e):r(d(i,e).f);if(!i.splice){if(m=i,m.deps&&c(m.deps,m.callback),!e)return;e.splice?(i=e,e=n,n=null):i=t}return e=e||function(){},"function"==typeof n&&(n=s,s=o),s?u(t,i,e,n):setTimeout(function(){u(t,i,e,n)},4),c},c.config=function(t){return c(t)},requirejs._defined=l,define=function(t,e,n){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");e.splice||(n=e,e=[]),i(l,t)||i(p,t)||(p[t]=[t,e,n])},define.amd={jQuery:!0}}(),define("../bower_components/almond/almond",function(){}),define("utils",[],function(){return{rand:function(t){return Math.floor(Math.random()*t)},colorCodeToRGB:function(t){var i=[42,34,6,37,8,2,40,10][t];return[0,0,0].map(function(t,e){return(i>>(e<<1)&3)<<7})},blendColors:function(t){var i=[0,0,0],e=t.length;return t.forEach(function(t){i[0]+=t[0],i[1]+=t[1],i[2]+=t[2]}),i.map(function(t){return Math.round(t/e)})},pressAnyKey:function(t){function i(s){s.stopPropagation(),e.removeEventListener("click",i,!0),e.removeEventListener("keydown",i,!0),n(window.anyKey),t()}var e=document.body;this.show(window.anyKey);var n=this.hide;e.addEventListener("click",i,!0),e.addEventListener("keydown",i,!0)},show:function(t){t.classList.remove("hidden")},hide:function(t){t.classList.add("hidden")},extend:function(t,i){for(var e in i)t[e]=i[e]},loadScript:function(t,i,e,n){var s,o=t.getElementsByTagName(i)[0];t.getElementById(e)||(s=t.createElement(i),s.id=e,s.src=n,o.parentNode.insertBefore(s,o))}.bind(null,document,"script")}}),define("model/queue",["utils"],function(t){function i(t){this.size=t||16,this.q=[],this.idx=0}return t.extend(i.prototype,{push:function(t){this.q.push(t),this.q.length>2*this.idx&&this.idx>this.size&&(this.q=this.q.slice(this.idx),this.idx=0)},pull:function(){return this.q[this.idx++]},isEmpty:function(){return this.q.length===this.idx}}),i}),define("model/stream",["model/queue","utils"],function(t,i){function e(){this.listeners=[]}return i.extend(e.prototype,{push:function(t){this.listeners.forEach(function(i){i(t)})},on:function(t){return this.listeners.push(t),this},map:function(t){var i=new e;return this.on(function(e){i.push(t(e))}),i},append:function(t){t.on(this.push.bind(this))},cooldown:function(i){function n(){o.isEmpty()?r=!1:(r=!0,s.push(o.pull()),setTimeout(n,i))}var s=new e,o=new t,r=!1;return this.on(function(t){o.push(t),r||n()}),s},nth:function(t){var i=new e,n=0,s=[];return this.on(function(e){s.length<t?s.push(e):(i.push(s[n]),s[n]=e,n++,n%=t)}),i},reduce:function(t,i){var n=new e;return this.on(function(e){void 0===i?i=e:n.push(i=t(i,e))}),n}}),e.join=function(){var t=new e,i=t.push.bind(t);return[].forEach.call(arguments,function(t){t.on(i)}),t},e}),define("model/matrix",["model/stream","utils"],function(t,i){function e(i){this.size=i,this.streams={set:new t,collapse:new t,color:new t}}function n(t){return this._get.apply(this,t)}function s(t,e){if(t!==e&&e){var s,o,r;for(s=1-e;e>s;s++)this.move(s,t,s,e),this.move(s,-t,s,-e),this.move(t,s,e,s),this.move(-t,s,-e,s);var h=[1,1,-1,-1,1];for(o=0;4>o;o++){var a=h[o],u=h[o+1];for(r=[[t*a,t*u]],s=e;t>s;s++)r.push([s*a,t*u],[t*a,s*u]);var c,d=r.map(n,this).filter(Boolean),f=d.length>t-e;c=f?i.blendColors(d):0,c&&this.streams.color.push(c),d.length&&(this.event.merge.push({from:r,to:[e*a,e*u],color:c}),r.forEach(function(t){this._set(t[0],t[1],0)},this),this._set(e*a,e*u,c))}}}function o(){var t,i=[];this.event={remove:t=[],move:[],merge:[]};var e,n=0,o=0;for(e=1;e<=this.size;e++)this.isFullLayer(e)&&i.push(e);for(e=1;e<=this.size;e++){if(e===i[n]){n++;var r=this.getLayer(e);t.push.apply(t,r),r.forEach(function(t){this._set(t[0],t[1],0)},this)}else o++;s.call(this,e,o)}return this.event.layers=i,i.length}function r(t){function i(){return Array.apply(null,{length:2*t+1}).map(function(){return 0})}var n;this._get=function(i,e){return n[t-e][t-i]},this._set=function(i,e,s){n[t-e][t-i]=s},this._reset=function(){n=[i()];for(var e=0;t>e;e++)n.push(i(),i())},e.call(this,t)}return i.extend(e.prototype,{get:function(t,i){return Math.abs(i)>this.size?0:Math.abs(t)>this.size?0:this._get(t,i)},set:function(t,i,e){if(Math.abs(i)>this.size)throw new RangeError("y is out of range");if(Math.abs(t)>this.size)throw new RangeError("x is out of range");this.streams.set.push([t,i,e]),this._set(t,i,e)},move:function(t,i,e,n){var s=this._get(t,i);s&&(this._set(e,n,s),this._set(t,i,0),this.event.move.push([t,i,e,n]))},isFullLayer:function(t){return this.getLayer(t).every(function(t){return this._get(t[0],t[1])},this)},collapse:function(){for(var t=[];o.call(this);)t.push(this.event);t.forEach(function(i,e){i.wave=e+1,i.totalWaves=t.length,this.streams.collapse.push(i)},this)},getConstraints:function(){var t,i,e=0,n=0,s=0,o=0;for(t=this.size;t>0;t--)for(i=-this.size;i<=this.size;i++)!s&&this.get(i,t)&&(s=t),!e&&this.get(-t,i)&&(e=t),!n&&this.get(t,i)&&(n=t),!o&&this.get(i,-t)&&(o=t);return[s,n,o,e]},getLayer:function(t){var i,e=[[t,t],[-t,t],[t,-t],[-t,-t]];for(i=1-t;t>i;i++)e.push([i,t]),e.push([t,i]),e.push([i,-t]),e.push([-t,i]);return e},toString:function(){var t,i,e=[];for(i=-this.size;i<=this.size;i++){var n=[];for(t=-this.size;t<=this.size;t++)n.push(+!!this._get(t,i));e.push(n.join(""))}return e.join("\n")}}),i.extend(r.prototype,e.prototype),r}),define("model/game",["model/matrix","model/stream","utils"],function(t,i,e){function n(e){this.size=e,this.model=new t(e),this.streams={position:new i,size:new i,drop:new i,misc:new i}}var s=[0,1,0,-1,0];return e.extend(n.prototype,{next:function(t){this.figure=t,this.distance=this.size+(this.size>>2),this.position=0,this.streams.position.push()},handleDropDistance:function(){var t=this.dropDistance;t.hard=Math.min(t.hard,this.size),t.soft=Math.min(t.soft,this.size-t.hard),this.streams.drop.push(t),this.dropDistance={hard:0,soft:0}},getFigurePoints:function(){if(!this.figure)return[];var t=s[this.direction],i=s[this.direction+1],e=this.position,n=this.distance+1;return this.figure.list.map(function(s){return{x:(s.x+e)*i+(s.y+n)*t,y:(s.y+n)*i-(s.x+e)*t}})},dropConnect:function(){this.handleDropDistance(),this.getFigurePoints().forEach(function(t){try{this.model.set(t.x,t.y,this.figure.color)}catch(i){this.over||(this.streams.misc.push("over"),this.over=!0)}},this),this.figure=null,this.model.collapse(),this.constraints=this.model.getConstraints(),this.streams.size.push(Math.max.apply(null,this.constraints))},doesFigureIntersect:function(){return this.getFigurePoints().some(function(t){return this.model.get(t.x,t.y)},this)},reset:function(){this.model._reset(),this.dropDistance={hard:0,soft:0},this.over=!1,this.direction=this.angle=0,this.position=0,this.streams.size.push(0),this.constraints=[0,0,0,0]},tick:function(t){this.over||(this.distance--,t||this.dropDistance.soft++,this.doesFigureIntersect()&&(t||this.dropDistance.soft--,this.distance++,this.dropConnect()),this.streams.position.push())},drop:function(){for(;!this.doesFigureIntersect();)if(this.dropDistance.hard++,this.distance--,this.distance<-this.constraints[this.direction+2&3]-this.figure.sizes[1]){this.streams.misc.push("fallthrough");break}this.distance++,this.dropDistance.hard--,this.dropConnect(),this.streams.position.push()},left:function(t){var i=this.angle,e=this.position,n=this.direction,s=this.direction+3&3;if(this.position===Math.max(-this.size,1-this.figure.sizes[0]-this.constraints[s])?(this.angle--,this.position=Math.min(this.size-this.figure.sizes[0]+1,this.constraints[this.direction]),this.direction=s):this.position--,this.doesFigureIntersect())this.angle=i,this.position=e,this.direction=n;else if(!t)return this.streams.position.push()},right:function(t){var i=this.angle,e=this.position,n=this.direction,s=this.direction+1&3;this.position===this.constraints[s]?(this.position=Math.max(-this.size,1-this.figure.sizes[0]-this.constraints[this.direction]),this.angle++,this.direction=s):this.position++,this.doesFigureIntersect()?(this.angle=i,this.position=e,this.direction=n):t||this.streams.position.push()},LEFT:function(){var t,i=this.direction;do t=this.position,this.left(!0);while(this.direction==i&&this.position!==t);this.direction===i?this.streams.position.push():this.right()},RIGHT:function(){var t,i=this.direction;do t=this.position,this.right(!0);while(this.direction==i&&this.position!==t);this.direction===i?this.streams.position.push():this.left()},rotate:function(){var t=this.angle,i=this.position,e=this.direction,n=this.direction;this.direction=this.direction+1&3,this.angle++;var s=this.direction+1&3;this.position=Math.max(-this.size,1-this.figure.sizes[0]-this.constraints[n],Math.min(this.position,this.constraints[s],this.size-this.figure.sizes[0]+1)),this.doesFigureIntersect()?(this.angle=t,this.position=i,this.direction=e):this.streams.position.push()},corotate:function(){var t=this.angle,i=this.position,e=this.direction,n=this.direction;this.direction=this.direction+3&3,this.angle--;var s=this.direction+3&3;this.position=Math.max(-this.size,1-this.figure.sizes[0]-this.constraints[s],Math.min(this.position,this.constraints[n],this.size-this.figure.sizes[0]+1)),this.doesFigureIntersect()?(this.angle=t,this.position=i,this.direction=e):this.streams.position.push()}}),n}),define("model/figure",["utils"],function(t){function i(t,i){var e,n,s=0,o=0,r=[];for(n=0;4>n;n++)for(e=0;4>e;e++)t>>(n<<2)+e&1&&(r.push({x:e,y:n}),s=Math.max(s,e),o=Math.max(o,n));this.list=r,this.sizes=[s+1,o+1],this.color=i}var e=[65575,66098,65650,65841,131185,131347,131143,131874,196631,197393,196724,197155,262243,262450,327734,328241,393231,397585,458803];return i.get=function(n){var s=e[n];return new i(65535&s,t.colorCodeToRGB(s>>16))},i}),define("Keyboard",["model/stream"],function(t){var i=new t,e=!0;return i.disable=function(){e=!1},i.enable=function(){e=!0},document.onkeydown=function(t){if(e){var n=t.keyCode,s=t.shiftKey,o=t.ctrlKey||t.metaKey;switch(n){case 13:case 32:i.push("drop");break;case 37:o?i.push("corotate"):s?i.push("LEFT"):i.push("left");break;case 39:o?i.push("rotate"):s?i.push("RIGHT"):i.push("right");break;case 40:i.push("tick");break;case 38:i.push("rotate");break;case 80:i.push("pause")}}},i}),define("model/ticker",["model/stream","utils"],function(t,i){function e(){this.stream.push(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.tick,this.interval),this.lastStart=n()}function n(){return window.performance?window.performance.now():Date.now?Date.now():+new Date}function s(){this.running=!1,this.interval=1e3,this.stream=new t,this.lastStart=0,this.passed=0,this.timer=0,this.tick=e.bind(this)}return i.extend(s.prototype,{start:function(){if(!this.running){if(this.running=!0,this.passed>this.interval)return this.tick();this.timer=setTimeout(this.tick,this.interval-this.passed),this.lastStart=n()-this.passed}},stop:function(){this.running&&(this.running=!1,clearTimeout(this.timer),this.timer=0,this.passed=n()-this.lastStart)},setInterval:function(t){this.interval=t,this.running&&(this.stop(),this.start())}}),s}),define("view-dom",["utils"],function(){function t(t,i){return 1&Math.max(Math.abs(t),Math.abs(i))}function i(i,e){function n(t,i,n){t.left=(e+i<<4)+"px",t.top=(e-n<<4)+"px"}var s=2*e+1<<4;i.style.width=s+"px",i.style.height=s+"px";var o=0,r={};this.ANIMATION_TIME=250,this.rotate=function(t){var e=i.style;e.WebkitTransform=e.MozTransform=e.transform="rotate("+t+"deg)"},this.paint=function(e,s,o){var h,a,u=e+"_"+s;if(o){if(r[u])return void(r[u].style.background="rgb("+o+")");h=document.createElement("div"),r[u]=h,a=h.style,n(a,e,s),h.className="cell cell"+t(e,s),a.transition="all "+this.ANIMATION_TIME+"ms ease-out",a.background="rgb("+o+")",i.appendChild(h)}},this.burn=function(t,e){var n=t+"_"+e,s=r[n];if(s){var o=document.createElement("div"),h=o.style;s.appendChild(o),h.opacity=0,h.background="white",h.height="100%",h.transition="all "+this.ANIMATION_TIME+"ms ease-out",setTimeout(function(){h.opacity=1,h.boxShadow="0 0 10px white"},0),setTimeout(function(){i.removeChild(s),r[n]=null},this.ANIMATION_TIME)}},this.clear=function(){o=0,r={},i.innerHTML=""},this.move=function(i,e,s,o){var h=i+"_"+e,a=r[h];a&&(n(a.style,s,o),setTimeout(function(){r[h]=null,r[s+"_"+o]=a,a.className="cell cell"+t(s,o)},this.ANIMATION_TIME))},this.merge=function(t){var e=t.from.map(function(t){return r[t.join("_")]}).filter(Boolean),s=t.to;e.forEach(function(t){var i=t.style;n(i,s[0],s[1]),i.opacity=0}),setTimeout(function(){t.from.forEach(function(t){r[t.join("_")]=null}),e.forEach(i.removeChild.bind(i)),t.color&&this.paint(s[0],s[1],t.color)}.bind(this),this.ANIMATION_TIME/2)},this.fillRings=function(t){var n;for(n=o-1;n>=t;n--)i.removeChild(document.getElementById("ring"+n));for(n=o;t>n;n++){var s=document.createElement("div");s.id="ring"+n,s.className="ring";var r=s.style;r.left=r.top=16*(e-n)-1+"px",r.width=r.height=(n<<5)+15+"px",i.appendChild(s)}o=t},this.drawBitmap=function(t,i){var e,n,s,o=i.offset||0,r=i.getXY||function(t,i){return[t,i]},h=i.getColor||function(){return[255,255,255]},a=t.length,u=t.reduce(function(t,i){return t|i}).toString(2).length;for(n=0;n<t.length;n++)for(e=0;u>e;e++)t[n]>>u-e-1&1&&(s=r(e-(u>>1),o+a-n),this.paint(s[0],s[1],h(e,n)))}}return i}),define("view/controller",["model/game","model/figure","Keyboard","model/stream","model/ticker","view-dom","utils"],function(t,i,e,n,s,o,r){function h(t){var i;return i=t>=29?1:t>=19?2:[48,43,38,33,28,23,18,13,8,6,5,5,5,4,4,4,3,3,3][t],Math.round(1e3*i/60)}function a(t,i,e){return[0,40,100,300,1200][i]*(t+1)*Math.pow(e,2)}function u(e){this.game=new t(e),this.game.over=!0,this.view=new o(window.matrix,e),this.figureView=new o(window.figure,2),this.nextView=new o(window.next,2),this.figureStream=new n,this.currentFigureStream=this.figureStream.nth(1),this.ticker=new s,this.points=0,this.lines=0,this.pointStream=new n,this.figureGenerator={get:function(){return i.get(r.rand(19))}},this.setupEvents(),this.setupAnimations()}function c(t,i){r.hide(window.figure),t.clear(),i.list.forEach(function(e){t.paint(e.x-2,e.y-2,i.color)}),setTimeout(r.show.bind(null,window.figure),0)}return r.extend(u.prototype,{updateLines:function(t,i){this.lines=!i*this.lines+t,this.level=Math.floor(this.lines/10),window.level.innerHTML=this.level,this.ticker.setInterval(h(this.level))},updatePoints:function(t,i){this.points=!i*this.points+t,window.points.innerHTML=this.points},onUpdateState:function(){var t=window.figure.style,i=this.game;t.left=(15+i.position<<4)+"px",t.top=(15-i.distance-5<<4)+"px",this.view.rotate(-90*i.angle)},onGameOver:function(t){"over"===t&&(this.ticker.stop(),r.hide(window.playfield),r.show(window.gameOver),r.pressAnyKey(this.back))},onUpdateRadius:function(t){t&&this.figureStream.push(this.figureGenerator.get()),this.view.fillRings(t)},onKeyPress:function(t){return this.game.over||this.animation&&("tick"===t||"drop"===t)||this.paused&&"pause"!==t?void 0:"pause"===t?this.togglePause():void this.game[t]()},togglePause:function(){this.paused?(this.ticker.start(),r.show(window.game),r.hide(window.keySheet),window.pauseHint.innerHTML="Press <kbd>P</kbd> for pause / help."):(this.ticker.stop(),r.hide(window.game),r.show(window.keySheet),window.pauseHint.innerHTML="Press <kbd>P</kbd> to continue playing."),this.paused=!this.paused},setupEvents:function(){this.pointStream.on(this.updatePoints.bind(this)),this.figureStream.on(c.bind(null,this.nextView)),this.currentFigureStream.on(c.bind(null,this.figureView)),this.currentFigureStream.on(this.game.next.bind(this.game)),this.ticker.stream.on(this.game.tick.bind(this.game,!0));var t=this.game.streams;t.position.on(this.onUpdateState.bind(this)),this.pointStream.append(t.drop.map(function(t){var i=Math.floor(t.hard/3)+Math.floor(t.soft/5);return 5===i&&(i=7),(i+1)*(this.level+1)}.bind(this))),t.size.on(this.onUpdateRadius.bind(this)),t.misc.on(this.onGameOver.bind(this)),e.on(this.onKeyPress.bind(this)),window.controls.onclick=function(t){var i=t.target,e=(i.dataset||{}).code;e&&this.onKeyPress(e)}.bind(this)},onCollapse:function(t){this.animation=!0;var i=this.view,e=i.ANIMATION_TIME;this.ticker.stop(),t.remove.forEach(function(t){i.burn.apply(i,t)}),this.updateLines(t.layers.length),this.pointStream.push(a(this.level,t.layers.length,t.wave)),setTimeout(function(){t.move.forEach(function(t){i.move.apply(i,t)}),t.merge.forEach(function(t){i.merge(t)})},1.1*e),t.wave===t.totalWaves&&setTimeout(function(){this.animation=!1,this.zen||this.ticker.start()}.bind(this),2.2*e)},onCellSet:function(t){this.view.paint.apply(this.view,t)},setupAnimations:function(){var t=this.view,i=t.ANIMATION_TIME,e=this.game.model.streams;e.set.on(this.onCellSet.bind(this)),e.collapse.cooldown(2.2*i).on(this.onCollapse.bind(this))},reset:function(t){this.back=t,this.animation=!1,this.updatePoints(0,!0),this.updateLines(0,!0),this.view.clear(),this.game.reset(),this.togglePause(),this.togglePause(),this.zen?r.hide(window.stats):r.show(window.stats),r.hide(window.gameOver),this.game.model.set(0,0,[255,255,255]),this.ticker.stop(),this.ticker.setInterval(h(0)),this.zen||this.ticker.start(),this.figureStream.push(this.figureGenerator.get()),this.figureStream.push(this.figureGenerator.get()),r.show(window.playfield)}}),u}),define("view/menu",["Keyboard","view-dom","utils"],function(t,i,e){function n(e){function n(t,i){return[t*u+i*h,i*u-t*h]}this.direction=0,this.angle=0,this.items=e;var s=this.view=new i(window.menuView,35),o=[255,255,255],r=[-2,-1,0,1,2];[new i(window.menuLeft,2),new i(window.menuRight,2)].forEach(function(t,i){r.forEach(function(e){r.forEach(function(n){Math.abs(n)+Math.abs(e)<=2&&0>=n*(1-2*i)&&t.paint(n,e,o)})})});var h,a=[0,1,0,-1,0],u=a[0];e.forEach(function(t,i){function e(){return t.color}h=u,u=a[i+1];var o,r,c=20;for(o=t.lines.length-1;o>=0;o--)r=t.lines[o],s.drawBitmap(r,{offset:c,getXY:n,getColor:e}),c+=r.length+1}),t.on(function(t){({left:1,right:1,drop:1})[t]&&this[t]()}.bind(this)),window.menuLeft.onclick=this.left.bind(this),window.menuRight.onclick=this.right.bind(this),window.menuView.onclick=this.drop.bind(this),this.back=this.back.bind(this)}return e.extend(n.prototype,{redraw:function(){this.view.rotate(-90*this.angle)},left:function(){this.out||(this.direction+=3,this.direction&=3,this.angle--,this.redraw())},right:function(){this.out||(this.direction+=1,this.direction&=3,this.angle++,this.redraw())},drop:function(){if(!this.out){this.out=!0,e.hide(window.menu);var t=this.items[this.direction];e.show(t.root),t.enter(this.back)}},back:function(){if(this.out){this.out=!1;var t=this.items[this.direction];e.hide(t.root),t.leave(),e.show(window.menu)}}}),n}),define("model/records",["utils"],function(t){function i(){this.load()}var e=[{name:"Alpha Pi",points:1e5},{name:"Delta Pi",points:5e4},{name:"Kappa Sigma",points:31337},{name:"Beta Gamma",points:25e3},{name:"Alpha Sigma",points:15e3},{name:"Beta Pi",points:1e4},{name:"Beta Pi",points:5e3},{name:"Beta Pi",points:2500},{name:"Ignatiy Konyachko",points:1e3},{name:"",points:0}],n="rotatris.records";return t.extend(i.prototype,{load:function(){try{this.table=JSON.parse(localStorage.getItem(n))||e}catch(t){this.table=e}},save:function(){try{localStorage.setItem(n,JSON.stringify(this.table))}catch(t){}},position:function(t){for(var i=0;10>i&&!(t>this.table[i].points);i++);return i},add:function(t,i,e){this.table.splice(e,0,{name:t,points:i}),this.table=this.table.slice(0,10+(10===e))}}),i}),define("view/records",["model/records","Keyboard","utils"],function(t,i,e){function n(){this.data=new t}var s=window.records,o=s.innerHTML;return e.extend(n.prototype,{drawTable:function(){s.innerHTML=o+this.data.table.map(function(t,i){var e=i>=10;return"<tr"+(e?' style="color:#ccc;"':"")+"><td>"+(e?"":i+1)+"</td><td>"+t.name+'</td><td class="score">'+t.points+"</td></tr>"}).join("")},drawWith:function(t,e){var n=this.data,o=n.position(t);10>o?n.add("<form><input maxlengh=20></form>",t,o):n.add("<em>Your score</em>",t,10),this.drawTable();var r=s.querySelector("form");if(!r)return void e();i.disable(),r.onsubmit=function(t){t&&t.preventDefault();var s=this.parentNode,r=this.firstChild.value;s.textContent=r,r=s.innerHTML,n.table[o].name=r,n.save(),i.enable(),e()};var h=s.querySelector("input");h.onblur=function(){""!==this.value&&this.parentNode.onsubmit()},h.focus()}}),n}),define("view/social",["utils"],function(){}),require(["view/controller","view/menu","view/records","view/social","Keyboard","view-dom","utils"],function(t,i,e,n,s,o,r){r.hide(window.menu);var h=document.body.classList;"ontouchstart"in document.body&&h.add("touch");var a=navigator.userAgent;(/Macintosh/.test(a)||/like Mac OS/.test(a))&&h.add("apple");var u=new t(15),c={ro:[31804,26214,26307,31939,27843,26214,26172],ta:[8094,1599,1587,1587,1599,1587,1587],tr:[8126,1587,1587,1598,1590,1587,1587],is:[415,432,432,414,387,387,446],game:[63412447,101703128,202170328,216849118,208656600,107796696,65853663],over:[126644158,214723635,409390131,409390910,409390134,214142003,126062515],mew:[13040387,15123251,16171446,14610870,13550078,13025484,13039820],zen:[1040227,55411,104571,204399,399463,792675,1040227],mode:[831463199,999922072,1068554456,900782302,833673432,832149912,831463199],info:[14212924,14473318,14604483,14409411,14276803,14211174,14211132],top:[2072126,406323,418227,418238,418224,406320,400944],ten:[1040227,202867,202875,204399,202855,202851,204643]},d=new o(window.gameOver,14);d.drawBitmap(c.game,{}),d.drawBitmap(c.over,{offset:-8});var f,l=new e;new i([{root:window.playfield,lines:[c.mew,c.game],color:r.colorCodeToRGB(5),enter:function(t){u.zen=!1,u.reset(function(){r.show(window.records),r.hide(window.gameOver),l.drawWith(u.points,function(){r.pressAnyKey(t)})})},leave:function(){r.hide(window.records)}},{root:window.playfield,lines:[c.zen,c.mode],color:r.colorCodeToRGB(2),enter:function(t){u.zen=!0,u.reset(t)},leave:function(){r.hide(window.gameOver)}},{root:window.about,lines:[c.game,c.info],color:r.colorCodeToRGB(6),enter:function(t){r.show(window.keySheet),r.show(window.scoringSheet),r.pressAnyKey(t)},leave:function(){r.hide(window.keySheet),r.hide(window.scoringSheet),f=window.gameInfo.offsetHeight}},{root:window.records,lines:[c.top,c.ten],color:r.colorCodeToRGB(3),enter:function(t){l.drawTable(),r.pressAnyKey(t)},leave:function(){}}]),["ro","ta","tr","is"].map(function(t){var i=document.createElement("div");i.id="intro-"+t,i.className="intro",window.intro.appendChild(i);var e=new o(i,7);return e.drawBitmap(c[t],{offset:-4}),e});var p=!0;s.on(function(t){"drop"===t&&(p=!1)}),setTimeout(function(){p&&r.show(window.menu)},1800)}),define("view/app.js",function(){});