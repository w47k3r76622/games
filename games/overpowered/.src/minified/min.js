(function(){var t=window,i=document,e=function(){return i.querySelector.apply(i,arguments)},n=t.requestAnimationFrame||t.mozRequestAnimationFrame,r=function(t){e("#game-message").textContent=t},s=function(t){e("#game-label").textContent=t},o=Math.PI,a=function(t,i){return{x:t,y:i}},h=function(t,i){return{r:t,th:i}},l=function(t){return Math.pow(t,2)},u=function(t,i){return Math.sqrt(l(t.x-i.x)+l(t.y-i.y))},c=function(t,i){return a(t.x+(i.x-t.x)/2,t.y+(i.y-t.y)/2)},f=Math.sin,p=Math.cos,d=Math.abs,g=Math.min,y=Math.max,v=Math.random,_=function(t,i){if(typeof i==="undefined"){i=t;t=0}return t+v()*(i-t)},x=function(t){return t[Math.floor(_(t.length))]},m=function(t){return v()<t},w=function(t,i){return a(t.x+i.x,t.y+i.y)},b=function(t,i){return a(t.x-i.x,t.y-i.y)},k=function(t,i){return a(t.x*i.x,t.y*i.y)},S=function(t,i){return a(t.x*i,t.y*i)},D=function(t){return a(t.r*p(t.th),t.r*f(t.th))},C=function(t){return h(Math.sqrt(t.x*t.x+t.y*t.y),Math.atan2(t.y,t.x))},z=function(t,i,e){if(!i){return a(e.x,e.y)}if(!e){return a(i.x,i.y)}if(i.x===e.x){return a(i.x,e.y)}var n=(t-i.x)/(e.x-i.x);return a(t,i.y+n*(e.y-i.y))},E=function(t,i){return Math.round(t/i)*i},M=function(t,i){return Math.floor(t/i)*i},A=function(t,i){return Math.ceil(t/i)*i},R=function(t,i){return y(g(t,y.apply(null,i)),g.apply(null,i))},P=function(t){return a(t.x,t.y)},T=function(t,i,e){e=e||1;var n=[];for(var r=t;r<i;r+=e){n.push(r)}return n},B=function(t,i){return t+_(-i,i)},I=function(t){if(t.reset)t.reset()},F=function(t){if(t.tick&&!t.skip_tick)t.tick()},j=function(t){if(t.draw)t.draw()},U=function(){};var W={"do":function(t,i,e){i=i||{};t.save();for(var n in i){t[n]=i[n]}t.beginPath();e();if(i.cls){t.closePath()}if(i.fll){t.fill()}if(i.strk){t.stroke()}t.restore()},shapeStyle:function(t,i){var e={fillStyle:t,strk:0,fll:1,cls:1};for(var n in i){e[n]=i[n]}return e},lineStyle:function(t,i){var e={strokeStyle:t,strk:1,fll:0,cls:0,lineWidth:.1};for(var n in i){e[n]=i[n]}return e},clr:function(t,i,e){i=i||a(0,0);e=e||a(t.canvas.width,t.canvas.height);t.clearRect(i.x,i.y,e.x-i.x,e.y-i.y)},clrp:function(i,e,n,r){this.clr(t.fader.ctx,e,n);t.fader.ctx.globalAlpha=r;t.fader.ctx.drawImage(i.canvas,t.fader.size.x,t.fader.size.y,t.fader.ctx.canvas.width/q.x,t.fader.ctx.canvas.height/q.y);this.clr(i,e,n);i.drawImage(t.fader.canvas,t.fader.size.x,t.fader.size.y,i.canvas.width/q.x,i.canvas.height/q.y)},f:function(t,i){i=i||this.shapeStyle("#fff");this.do(t,i,function(){t.fillRect(0,0,t.canvas.width,t.canvas.height)})},l:function(t,i,e,n){n=n||this.lineStyle("#fff");this.do(t,n,function(){t.moveTo(i.x,i.y);t.lineTo(e.x,e.y);t.moveTo(e.x,e.y)})},r:function(t,i,e,n){n=n||this.shapeStyle("#fff");this.do(t,n,function(){t.rect(i.x,i.y,e.x-i.x,e.y-i.y)})},c:function(t,i,e,n){this.a(t,i,e,0,2*Math.PI,n)},a:function(t,i,e,n,r,s){s=s||this.lineStyle("#fff");this.do(t,s,function(){t.arc(i.x,i.y,e,n,r,false)})},b:function(t,i,e,n,r,s){s=s||this.lineStyle("#fff");this.do(t,s,function(){t.moveTo(i.x,i.y);t.bezierCurveTo(n.x,n.y,r.x,r.y,e.x,e.y)})},p:function(t,i,e){e=e||this.lineStyle("#fff");this.do(t,e,function(){t.moveTo(i[0].x,i[0].y);i.forEach(function(i){t.lineTo(i.x,i.y)})})}};var q=a(30,30),L=a((t.innerWidth-20)/q.x,t.innerHeight/q.y),O=a(4,4),H=2,G=[-25,1e3],Y=10,N=L.y*1.3,J=60,K=10,Q=80,V=.1,X=.1,Z=[G[0]+20,G[1]-20],$=a(.7,1.2),tt=.15,it=4,et=a(10,10),nt=8,rt=5,st=function(){return a(0,ji<rt?0:-9.8/2/R(Li*Li,[0,1e3]))},ot=.001,at=1e-4,ht=o/4,lt=.1,ut=.07,ct=function(t){return function(t){t+=1;t*=.2;return-y(0,1.5*Math.exp(-t/2)*t/1.5)}},ft=.001,pt=.3,dt=.3,gt=1/400,yt=1/30,vt=1,_t=a(.3,.6),xt=.3,mt=.05,wt=2*mt,bt=15,kt=1,St=15,Dt=a(.3,.2),Ct=a(.4,.05),zt=a(.5,.05),Et=5e-5,Mt=.1,At=.9,Rt=.01,Pt=[-20,1e3],Tt=.075,Bt=.5,It=1.8,Ft=50,jt=.05,Ut={x:.5,y:.3},Wt=.7,qt=.4,Lt=a(2,.25),Ot=a(-6,-.75),Ht=a(-10,-.75),Gt=a(-1.5,-.75),Yt=1,Nt="#eee",Jt="#1b1b1b",Kt=[[1,"#777788"],[.4,"#999999"],[0,"#cccccc"]],Qt="#fff",Vt="#fff",Xt="#666366",Zt="#555255",$t="#3E373E",ti="#636666",ii="#000",ei="#000",ni="#000",ri="#9eb",si="#eee",oi="#000",ai="#ddd",hi="#445",li="#aab",ui="#811",ci="#161",fi="#112",pi=[["#ddd",.3,.05],["#fff",.1,.05]];e("#game-message").style.color=fi;e("body").style.color=Nt;e("#game-intro").style.color=Nt;function di(t,i,n){this.canvas=e(t);this.ctx=this.canvas.getContext("2d");this.canvas.setAttribute("width",i.x*n.x);this.canvas.setAttribute("height",i.y*n.y);this.origin=a(0,0);this.size=i;this.scale=n;this.ctx.setTransform(n.x,0,0,-n.y,0,i.y*n.y);this.ctx.lineWidth=0;this.clear=function(){W.clr(this.ctx,this.origin,a(this.origin.x+this.size.x,this.origin.y+this.size.y))};this.clearPartial=function(t){W.clrp(this.ctx,this.origin,a(this.origin.x+this.size.x,this.origin.y+this.size.y),t)};this.moveBy=function(t){t=this.transCoords(t);this.ctx.translate(-t.x,-t.y);this.origin=w(this.origin,t)};this.transCoords=function(t){return a(t.x*this.scale.x/q.x,t.y*this.scale.y/q.y)}}var gi={tick:function(){this.focusOnPlayerDrone()},moveBy:function(i){game_origin=w(game_origin,i);t.fader.moveBy(i);t.bg1.moveBy(i);t.bg2.moveBy(i);t.stage.moveBy(i);t.windlayer.moveBy(i);xi.redraw_bg=true;Ci.tutorial.has_scrolled=true},focusOnPlayerDrone:function(){var t=Ci.drone.p.x-game_origin.x,i=Ci.drone.p.y-game_origin.y;if(t<O.x){this.moveBy(a(t-O.x,0))}if(L.x-t<O.x){this.moveBy(a(O.x-(L.x-t),0))}}};t.game_origin=a(0,0);t.fader=new di("#fader",L,q);t.bg1=new di("#game_background1",S(L,1/.9),S(q,.9));t.bg2=new di("#game_background2",S(L,1/.95),S(q,.95));t.stage=new di("#game_stage",L,q);t.windlayer=new di("#game_wind",L,q);t.overlay=new di("#game_overlay",L,q);t.introimg=new di("#intro-img",L,q);e("#game-layers").style.height=L.y*q.y+"px";var yi=function(t,i,e,n,r){this.origin=t;this.y0=t.y;this.xres=i;this.xres_offset=e[0]%i;this.xrange=e;this.y=n;this.thickness=r;this.yAt=function(t){return this.pointAt(t).y};this.pointAt=function(t){t=R(t,[this.xrange[0],this.xrange[1]]);var i=M(t-this.xres_offset,this.xres)+this.xres_offset;var e=A(t-this.xres_offset,this.xres)+this.xres_offset;return z(t,a(i,this.y[i]),a(e,this.y[e]))};this.getMin=function(t,i){t=M(t-this.xres_offset,this.xres)+this.xres_offset;i=A(i-this.xres_offset,this.xres)+this.xres_offset;var e=this;return g.apply(null,T(t,i+1,e.xres).map(function(t){return e.y[t]}))};this.getPolygon=function(t){var i=[];i.push(a(this.xrange[0],this.y0-t));for(var e=this.xrange[0];e<=this.xrange[1];e+=this.xres){i.push(a(e,this.y[e]))}i.push(a(this.xrange[1],this.y0-t));return i};this.pts=this.getPolygon(this.thickness);this.drawRepr=function(t){W.p(stage.ctx,this.pts,t)}};function vi(t,i){var e={};e[t.x]=t.y+i.y;e[t.x+i.x]=t.y+i.y;return new yi(a(t.x,t.y+i.y),i.x,[t.x,t.x+i.x],e,i.y)}t.buildings=[];function _i(i,e,n){this.container_platform=n||xi.ground;this.p=a(i,this.container_platform.getMin(i,i+e.y));this.size=e;this.platforms=[];this.people=[];this.emptied=false;this.door_p=w(this.p,a($.x+v()*(this.size.x-2*$.x),0));this.__proto__.setupPlatform.call(this,vi(this.p,this.size));t.buildings.push(this);this.peopleCounts={}}_i.prototype={prepopulate:function(t){t=t||this.peopleCounts;for(var i in t){var e=Si[i];for(var n=0;n<t[i];n++){var r=(new bi).init({platform:this,role:e});this.personEnter(r);Ji("foreground1",r)}}},tick:function(){if(!this.emptied&&u(Ci.drone.p,this.p)<nt){this.everyoneExits()}},draw:function(){this.platforms[0].drawRepr(W.shapeStyle($t));W.r(stage.ctx,this.door_p,w(this.door_p,$),W.shapeStyle(ti))},setupPlatform:function(t){this.platforms.push(t)},personEnter:function(t){t.hidden=true;t.platform=this;this.people.push(t)},personExit:function(){if(this.people.length===0){return}var t=this.people.shift();t.hidden=false;t.platform=this.container_platform;return t},everyoneExits:function(t){for(var i=0;i<this.people.length;i++){var e=this;Vi(i*50,function(){var i=t||_(-1,1);e.personExit().v=a(i*B(.1,.02),0)})}this.emptied=true},pointAt:function(){return a(this.door_p.x+$.x/2,this.door_p.y)},yAt:function(){return this.door_p.y}};var xi={ground:new yi(a(G[0],4),1,G,{}),pts:[],towers:[],buildings:[],redraw_bg:false,reset:function(){stage.clear();overlay.clear();windlayer.clearPartial(.95);if(this.redraw_bg||ji===0){bg2.clear();var t=bg1.ctx.createLinearGradient(0,0,0,bg1.size.y*1.2);Kt.forEach(function(i){t.addColorStop.apply(t,i)});W.r(bg1.ctx,bg1.origin,a(bg1.origin.x+bg1.size.x,bg1.origin.y+bg1.size.y),W.shapeStyle(t));this.towers.forEach(this.drawTower)}this.redraw_bg=false},tick:function(){},draw:function(){var t=W.shapeStyle(Jt);W.p(stage.ctx,this.pts,t);this.drawBoundaryFog()},drawBoundaryFog:function(){var t=a(G[0]-50,0),i=a(G[0]+50,L.y),e=a(G[1]+50,0),n=a(G[1]-50,L.y);var r=stage.ctx.createLinearGradient(t.x,0,i.x,0);var s=stage.ctx.createLinearGradient(e.x,0,n.x,0);r.addColorStop(.5,"white");r.addColorStop(1,"rgba(0, 0, 0, 0)");s.addColorStop(.5,"white");s.addColorStop(1,"rgba(0, 0, 0, 0)");W.r(stage.ctx,t,i,W.shapeStyle(r));W.r(stage.ctx,e,n,W.shapeStyle(s))},drawTower:function(t){var i=t.x-t.w/2;var e=t.x+t.w/2;var n=g(xi.ground.pointAt(i).y,xi.ground.pointAt(e).y);var r=W.shapeStyle(t.color);W.r(t.ctx,a(i,n-.5),a(e,n+t.h),r);if(t.dome){W.c(t.ctx,a(t.x,n+t.h),t.w/2*.8,r)}if(t.slant){var s=n+t.h-.1;var o=.9*t.w/2;var h=o*t.slant_ratio;var l=a(t.x,n+t.h);W.p(t.ctx,[a(t.x-o,s),a(t.x+o,s),a(t.x,s+h)],r)}},generate:function(){this.pts.push(a(this.ground.xrange[0],0));var t=this.generateTerrainFunction();for(var i=this.ground.xrange[0];i<this.ground.xrange[1];i+=this.ground.xres){this.ground.y[i]=this.ground.y0+t(i);this.pts.push(a(i,this.ground.y[i]))}this.pts.push(a(this.ground.xrange[1],0));for(var e=0;e<J;e++){this.generateTowerClump()}this.generatePeopleBuildings()},generateTowerClump:function(){var i=_.apply(t,Z);var e=K+_(-3,3);for(var n=0;n<e;n++){var r={x:_(i-Q/2,i+Q/2),w:_(4,7),h:_(5,22),ctx:x([bg1.ctx,bg2.ctx])};r.slant=m(V);if(r.slant){r.slant_ratio=_(1.2,1.5)}r.dome=!r.slant&&m(X);r.ctx=r.h>18?bg1.ctx:bg2.ctx;r.color=r.h>18?Xt:Zt;this.towers.push(r)}},generateTerrainFunction:function(){var t=function(t,i,e){return{m:t,f:i,p:e}};var i=[];for(var e=0;e<10;e++){var n=1/_(1,5);i.push(t(n,1/(n*100),_(0,100)))}for(var e=0;e<10;e++){var n=1/_(20,40);i.push(t(n,1/(n*100),_(0,100)))}return function(t){var e=0;i.forEach(function(i){e+=i.m*f(i.f*t+i.p+_(0,.05))});return e}},generatePeopleBuildings:function(){var t=tt*(G[1]-G[0]);var i=t/it;var e=(G[1]-G[0])/i;var n=T(L.x*2,G[1]-Y,e).forEach(function(t){var i=new _i(B(t,10),a(B(10,4),B(12,4)));i.peopleCounts={normal:it};xi.buildings.push(i)})}};function mi(t,i){i=i||{};this.name=t;this.drawRepr=i.draw||U}function wi(t){this.p=t||a(0,0);this.v=a(0,0);this.gravity=false;this.platform=xi.ground;this.stay_on_platform=false;this.tick=function(){this.p.x+=this.v.x;this.p.y+=this.v.y;if(this.gravity){this.v=w(this.v,st())}var t=this.platform.yAt(this.p.x);if(this.p.y<t){this.p.y=t;this.v.y=y(this.v.y,0)}if(this.stay_on_platform){this.p=this.platform.pointAt(this.p.x)}this.handleBehavior()};this.behaviors={idle:function(){return}};this.current_behavior="idle";this.current_behavior_timeleft=-1;this.current_behavior_params={};this.handleBehavior=function(){this.current_behavior_timeleft-=1;var t=false;if(this.current_behavior_timeleft<0){this.switchBehavior();t=true}this.behaviors[this.current_behavior].call(this,t)};this.switchBehavior=function(t){this.current_behavior=t||x(Object.keys(this.behaviors));this.current_behavior_timeleft=_(50,300)}}function bi(){var i=stage.ctx;this.p=a(0,0);this.color=ii;this.drone_distance=null;this.inventory_item=null;this.resistance=v();this.control_level=0;this.talking_dir=0;this.stay_on_platform=true;this.role=Si.normal;this.hidden=false;this.init=function(i){for(var e in i){this[e]=i[e]}this.addIdea(t.ideas.smalltalk);return this};this.behaviors={idle:function(t){if(t){this.v=a(0,0)}return},amble:function(t){if(Ci.drone.person===this){return}if(t){this.v=a(_(-1,1)/20,0)}},talk:function(t){var i=this.current_behavior_params.person;if(!i)return;var e=i.p.x-this.p.x;if(d(e)>kt){this.v=a(.5/20,0);if(e<0){this.v.x*=-1}this.current_behavior_timeleft+=1}else{this.v=a(0,0);this.talking_dir=d(e)/e;this.talking_idea=this.latest_idea;i.addIdea(this.talking_idea)}}};this.switchBehavior=function(t){if(!t){t=this.current_behavior==="amble"?"idle":"amble"}this.current_behavior=t;this.current_behavior_timeleft=_(50,100)};this.talkTo=function(t){this.current_behavior_params={person:t};this.switchBehavior("talk")};this.talkToClosestPerson=function(){this.talkTo(this.getClosestPerson())};this.getClosestPerson=function(){return t.p3};this.byRole=function(t){if(!(t in this.role)){console.warn("Uh oh, person role does not have method:",t);return}this.role[t].apply(this)};this.reset=function(){this.talking_dir=0;this.drone_distance=null;if(d(Ci.drone.p.x-this.p.x)<bt){Hi.push(this);this.drone_distance=u(this.p,Ci.drone.p)}};this.tick=function(){this.__proto__.tick.apply(this);if(this.control_level<this.resistance&&this.control_level>0){this.control_level-=mt;this.control_level=y(this.control_level,0)}this.byRole("tick")};this.draw=function(){if(this.hidden){return}var t=this.v.x;this.drawRepr(this.p,1.3,W.shapeStyle(ri,{globalAlpha:this.control_level*Ci.drone.controlStrength(this)}),t);this.drawRepr(this.p,1,W.shapeStyle(this.color),t);if(this.talking_dir!==0){this.drawSpeechSquiggles(this.talking_dir);this.talking_idea.drawRepr(w(this.p,a(this.talking_dir*.5,1.2)),Wt,W.shapeStyle(ai),{freeze:true})}this.byRole("draw")};this.drawRepr=function(t,e,n,r){r=r||0;var s=a(e*_t.x,e*_t.y);t=w(t,a(0,-(s.y-_t.y)/2));var o=r<0?1/3:1/2;var h=r>0?1/3:1/2;var l=s.x/3;var u=r<0?t.x:t.x-s.x/2;var c=r>0?t.x:t.x+s.x/2;W.r(i,a(t.x-s.x*o,t.y),a(t.x+s.x*h,t.y+s.y-l),n);W.c(i,a(t.x,t.y+s.y-l),l,n);W.c(i,a(t.x,t.y+s.y+l),l,n)};this.drawSash=function(t,e){e=e||1;var n=_t;W.p(i,[w(this.p,a(-e*n.x/2,0)),w(this.p,a(-e*n.x/2,n.x/4)),w(this.p,a(e*n.x/2,n.y-n.x/4)),w(this.p,a(e*n.x/2,n.y-n.x/2))],W.shapeStyle(t))};this.drawTopHat=function(t){var e=_t;var n=e.y+2*e.x/3;W.r(i,w(this.p,a(-e.x/4,n)),w(this.p,a(e.x/4,n+e.x)),W.shapeStyle(t));W.r(i,w(this.p,a(-e.x/2,n)),w(this.p,a(e.x/2,n+e.x/3)),W.shapeStyle(t))};this.drawSpeechSquiggles=function(t){var e=this.p.x+t*.2;var n=this.p.y+_t.y+.02;var r=W.lineStyle("#000",{lineWidth:.05});W.b(i,a(e,n),a(e+t*.3,n-.2),a(e+t*.1,n),a(e+t*.4,n-.1),r);n+=.1;W.b(i,a(e,n),a(e+t*.3,n+.2),a(e+t*.1,n),a(e+t*.4,n+.1),r);n-=.05;W.l(i,a(e+t*.2,n),a(e+t*.4,n),r)};this.hold=function(t){this.inventory_item=t;t.container=this};this.drop=function(){if(!this.inventory_item)return;this.inventory_item.p=this.platform.pointAt(this.inventory_item.p.x);this.inventory_item.platform=this.platform;this.inventory_item.container=null;this.inventory_item=null};this.itemInteract=function(){if(this.inventory_item){this.drop()}else{var t=this.getClosestItem();if(t&&u(this.p,t.p)<kt){this.hold(t)}}};this.useItem=function(){if(!this.inventory_item){this.tryToEnterBuilding()}else{this.inventory_item.use()}};this.getClosestItem=function(){if(Gi.length===0){return null}return Gi.reduce(function(t,i){return i.person_distance<t.person_distance?i:t},{person_distance:9999})};this.tryToEnterBuilding=function(){var i=this;t.buildings.forEach(function(t){if(u(i.p,t.door_p)<kt){t.personEnter(i);return}})};this.shoot=function(t){if(this.drone_distance===null||this.drone_distance>St){return}if(this.control_level>=1){return}var i=w(this.p,a(0,_t.y*.7));var e=Math.atan2(t.y-i.y,t.x-i.x);Ji("foreground2",new Pi(i,e))};this.ideas={};this.latest_idea=null;this.hasIdea=function(t){return t.name in this.ideas};this.addIdea=function(t){if(t===null){return}if(!this.hasIdea(t)){this.ideas[t.name]=0}this.ideas[t.name]+=1;this.latest_idea=t}}bi.prototype=new wi;function ki(t){this.draw=t.draw||U;this.onControl=t.onControl||U;this.tick=t.tick||U}var Si={normal:new ki({draw:function(){}}),guard:new ki({tick:function(){if(ji%Ft===0){this.shoot(Ci.drone.p_drawn)}},draw:function(){this.drawSash("#a21",-1);this.drawSash("#a21",1)}}),game_target:new ki({draw:function(){this.drawTopHat(ii);this.drawSash("#78c")},onControl:function(){r("You have won. Congratulations.")}})};var Di=function(i){var e=stage.ctx;this.p=i;this.p_drawn=i;this.gravity=true;this.energy=1;this.integrity=1;this.powered=true;this.rpm_scale=.83;this.control_t0=0;this.control_signal_target=null;this.attempting_control=true;this.rpm_scale=.83;this.rpm_diff=0;this.color="black";this.tilt=0;this.spin=0;this.offset=0;this.offsets={};this.person=null,this.boundify=function(){this.rpm_scale=R(this.rpm_scale,[0,1]);this.rpm_diff=R(this.rpm_diff,[-1,1]);this.tilt=this.spin>0?R(this.tilt,[-o/2,o/2]):this.tilt;this.energy=R(this.energy,[0,1]);this.integrity=R(this.integrity,[0,1]);this.p.y=g(this.p.y,N);this.p.x=R(this.p.x,G)};this.reset=function(){this.boundify();this.offset=0;for(var t in this.offsets){var i=ji-t;var e=this.offsets[t](i);if(d(e)<.001){delete this.offsets[t]}else{this.offset+=e}}};this.tick=function(){this.v=w(this.v,this.getLiftAccel());this.tilt+=this.spin;this.spin*=.8;this.tilt*=.9;this.v.x*=.95;this.rpm_diff+=this.rpm_diff>0?-.003:.003;this.__proto__.tick.apply(this);this.p_drawn=a(this.p.x,this.p.y+this.offset);this.drainEnergy();this.checkStats();this.boundify()};this.draw=function(){if(this.control_signal_target){W.l(e,this.p_drawn,this.control_signal_target,W.lineStyle(ri,{globalAlpha:this.controlStrength(this.control_signal_target)}));this.control_signal_target=null}this.drawRepr(this.p_drawn,1,W.shapeStyle(this.color),{tilt:this.tilt})};this.drawRepr=function(t,i,n,r){r=r||{};var s=r.tilt||0;var o=r.ctx||e;o.translate(t.x,t.y);o.rotate(-s);var h=W.lineStyle(n.fillStyle,{lineWidth:i*Ct.y});var l=i*Dt.x/2;var u=i*Dt.y/2;var c=i*Ct.x;var p=i*Ct.y/2;var d=i*zt.x/2;var g=i*zt.y/2;W.r(o,a(-l,-u),a(+l,+u),n);W.l(o,a(-c,+u+p),a(+c,+u+p),h);W.l(o,a(-c*.5,+u+p),a(-2.2*l,-1.8*u),h);W.l(o,a(+c*.5,+u+p),a(2.2*l,-1.8*u),h);function y(t,i){W.r(o,a(t-i*d,u+p*2+.05),a(t+i*d,u+p*2+.05+g*2),n);W.l(o,a(t,u+p),a(t,u+p*2+.1),h)}var v=.8;var _=r.rpm_scale?r.rpm_scale:this.rpm_scale;var x=this.powered&&typeof _!=="undefined"&&!r.freeze?_*ji:.8;y(i*Ct.x-.05,f(v*x));y(-i*Ct.x+.05,f(v*x));o.rotate(s);o.translate(-t.x,-t.y)};this.checkStats=function(){if(this.energy<=0){this.die("Your battery is drained. Refresh to play again.")}else if(this.integrity<=0){this.die("Structural integrity failure. Refresh to play again.")}};this.die=function(t){this.powered=false;this.rpm_scale=0;r(t||"You have died... for no reason. Refresh to play again.")};this.getLiftAccel=function(){var t=this.powered?-1.2*st().y*this.rpm_scale:0;var i=this.powered?this.rpm_diff*Rt:0;return a(i,t)};this.powerUp=function(){if(this.skip_tick||!this.powered){return}this.v.y+=.05;this.rpm_scale+=at};this.powerDown=function(){if(this.skip_tick||!this.powered){return}this.v.y-=.05;this.rpm_scale-=at};this.tiltLeft=function(){if(this.skip_tick||!this.powered){return}this.v.x-=ut;this.rpm_diff-=ot;this.tilt=-ht};this.tiltRight=function(){if(this.skip_tick||!this.powered){return}this.v.x+=ut;this.rpm_diff+=ot;this.tilt=ht};this.startTiltOffset=function(){if(this.p.y<xi.ground.y0+1){return}this.offsets[ji]=ct()};this.experienceWind=function(t,i){var e=i.th-t.th;this.spin+=.1/e;this.v=w(this.v,D(h(.03*i.r/t.r,i.th)))};this.controlStrength=function(t){return 1;t=t||this.person;if(!t){return 0}return.5+Math.atan(20-u(this.p,t.p))/o};this.uncontrol=function(){if(!this.person)return;this.person.color=ii;this.person.control_level=0;this.person.addIdea(t.ideas.drone);this.person.talkToClosestPerson();this.person=null};this.controlFull=function(t){if(t===this.person){return}this.uncontrol();this.person=t;this.person.color=ei;this.person.control_level=1;this.person.resistance=wt;this.person.byRole("onControl");Ci.tutorial.has_controlled=true};this.attemptControl=function(){var i=this.getClosestPerson();if(i&&m(l(this.controlStrength()))){i.control_level+=mt*2;this.control_signal_target=w(i.p,a(0,_t.y));i.addIdea(t.ideas.drone)}else{this.control_signal_target=null}if(i&&i.control_level>=i.resistance){this.controlFull(i)}};this.getClosestPerson=function(){if(Hi.length===0){return null}return Hi.reduce(function(t,i){return i.drone_distance<t.drone_distance?i:t},{drone_distance:9999})};this.fillEnergy=function(){this.energy=1};this.drainEnergy=function(){this.energy-=Et*this.rpm_scale};this.dockIntegrity=function(t){this.integrity-=t}};Di.prototype=new wi;var Ci={drone:new Di(a(8.5,9.5)),usingItem:false,tutorial_state:0,tick:function(){for(var t in this.inputControlMap){var i=this.inputControlMap[t];if(i.isDown&&typeof i.whenDown==="function"){i.whenDown()}}this.showTutorialMessage();this.showMouseMessages()},draw:function(){this.showScrollArrow()},showScrollArrow:function(){if(!Ci.tutorial.has_scrolled&&Ci.drone.p.x>L.x-O.x*4){var t=L.x-O.x;var i=L.y/2;var e=W.shapeStyle("white",{globalAlpha:.5});W.r(overlay.ctx,a(t,i),a(t+1,i+1),e);W.p(overlay.ctx,[a(t+1,i-.5),a(t+1,i+1.5),a(t+2,i+.5)],e)}},showTutorialMessage:function(){if(this.tutorial_state in zi){var i=zi[this.tutorial_state];t.label=i.msg;if(i.isDone()){this.tutorial_state+=1}}else{t.label=""}},showMouseMessages:function(){var i=false;Ei.forEach(function(t){if(d(mouse_p.x-t.obj.p.x)<Yt&&d(mouse_p.y-t.obj.p.y)<Yt){s(t.msg);i=true}});if(!i){s(t.label)}},inputControlMap:{65:{isDown:0,whenDown:function(){Ci.drone.tiltLeft()},onDown:function(){Ci.drone.startTiltOffset()},onUp:function(){Ci.tutorial.has_flown_sideways=true}},68:{isDown:0,whenDown:function(){Ci.drone.tiltRight()},onDown:function(){Ci.drone.startTiltOffset()},onUp:function(){Ci.tutorial.has_flown_sideways=true}},83:{isDown:0,whenDown:function(){Ci.drone.powerDown()},onUp:function(){Ci.tutorial.has_powered_up=true}},87:{isDown:0,whenDown:function(){Ci.drone.powerUp()},onUp:function(){Ci.tutorial.has_powered_up=true}},37:{isDown:0,whenDown:function(){if(m(Ci.drone.controlStrength())&&Ci.drone.person)Ci.drone.person.p.x-=xt},onUp:function(){Ci.tutorial.has_moved_human=true}},39:{isDown:0,whenDown:function(){if(m(Ci.drone.controlStrength())&&Ci.drone.person)Ci.drone.person.p.x+=xt},onUp:function(){Ci.tutorial.has_moved_human=true}},40:{isDown:0,onUp:function(){if(m(Ci.drone.controlStrength())){Ci.drone.person.itemInteract()}Ci.tutorial.has_pickedup_item=true}},38:{isDown:0,onUp:function(){Ci.drone.person.useItem();Ci.tutorial.has_used_item=true}},32:{isDown:0,whenDown:function(){Ci.drone.attemptControl()}}}};Ci.tutorial={has_scrolled:false,has_flown_sideways:false,has_powered_up:false,has_controlled:false,has_used_item:false,has_moved_human:false,has_pickedup_item:false};var zi=[{msg:"Fly left and right with A and D",isDone:function(){return Ci.tutorial.has_flown_sideways}},{msg:"Power your blades up and down with W and S",isDone:function(){return Ci.tutorial.has_powered_up}},{msg:"",isDone:function(){return Hi.length>0}},{msg:"Hold space to take control of a human",isDone:function(){return Ci.tutorial.has_controlled}},{msg:"Move your human with ←, →",isDone:function(){return Ci.tutorial.has_moved_human}},{msg:"Your human can pick something up with ↓",isDone:function(){return Ci.tutorial.has_pickedup_item}},{msg:"...and deliver it to you with ↑",isDone:function(){return Ci.tutorial.has_used_item}},{msg:"",isDone:U}];t.label=zi[0].msg;var Ei=[{obj:Ci.drone,msg:"DRONE"}];t.mouse_p=a(0,0);window.addEventListener("mousemove",function(i){var e=a(i.x/q.y+game_origin.x,(t.innerHeight-i.y)/q.y+game_origin.y);mouse_p=e});e("#mute").onclick=function(){ee.toggleMute();e("#mute").textContent=ee.muted?"unmute":"mute sound"};var Mi={};window.addEventListener("keydown",function(t){var i=Ci.inputControlMap[t.which];if(i){t.preventDefault();i.isDown=1;if((!(t.which in Mi)||!Mi[t.which])&&typeof i.onDown==="function"){i.onDown()}}Mi[t.which]=true});window.addEventListener("keyup",function(t){var i=Ci.inputControlMap[t.which];if(i){t.preventDefault();i.isDown=0;if(typeof i.onUp==="function"){i.onUp()}}Mi[t.which]=false});lightning={timeleft:-1,target:null,pts:[],onFinish:null,reset:function(){if(this.target){this.target.skip_tick=true}},tick:function(){if(this.timeleft>=0){this.timeleft-=1}else{this.target=null;if(typeof this.onFinish==="function"){this.onFinish();this.onFinish=null}}if(m(ft)){m(pt)?this.strikeDrone():this.strike()}},draw:function(){if(this.timeleft<0){return}var t=[["#aaf",.5,.05],["#aaf",.3,.05],["#aaf",.1,.5],["#ccf",.05,1]];var i=this.pts;t.forEach(function(t){W.p(stage.ctx,i,W.lineStyle(t[0],{lineWidth:t[1],globalAlpha:t[2]}))})},strikeDrone:function(){this.target=Ci.drone;this.strike(Ci.drone.p_drawn);var t=Ci.drone.color;Ci.drone.color="#bbf";this.onFinish=function(){Ci.drone.color=t;Ci.drone.dockIntegrity(dt)}},strike:function(t){if(!t){var i=_(L.x+game_origin.x);t=xi.ground.pointAt(i)}var e=a(t.x+_(-5,5),L.y);this.regenerate(e,t);this.timeleft=_(10,50)},regenerate:function(t,i){var e={p1:t,p2:i,children:[]};this.populateSegmentChildren(e,6);this.pts=this.getPoints(e);this.pts.push(e.p2);this.seg=e},populateSegmentChildren:function(t,i){i=i||0;if(i<0){return t}var e=u(t.p1,t.p2);midpt_offset=h(e*_(.07,.1),Math.asin((t.p2.x-t.p1.x)/e));if(v()<.5){midpt_offset.r*=-1}midpt_offset.th+=_(-o/4,o/4);midpt_offset=D(midpt_offset);var n=a(t.p1.x+(t.p2.x-t.p1.x)*_(.3,.7),t.p1.y+(t.p2.y-t.p1.y)*_(.3,.7));var r=w(n,midpt_offset);var s={p1:t.p1,p2:r,children:[]};var l={p1:r,p2:t.p2,children:[]};this.populateSegmentChildren(s,i-1);this.populateSegmentChildren(l,i-1);t.children.push(s);t.children.push(l)},getPoints:function(t){if(t.children.length===0){return[t.p1]}var i=this.getPoints(t.children[0]);return i.concat(this.getPoints(t.children[1]))}};var Ai=function(){this.remaining_propagations=0;this.curl=0;this.previous_angle=0;this.next_curl_dir=1;this.total_angle=0;this.curl_frequency=7;this.curl_amplitude=.1;this.propagation_length=1;this.num_propagations=[50,60];this.visible_gust_length=6;this.starting_angles=[0,o/16,-o/16];this.angle_window=[-o/4,o/4];this.height_window=[xi.ground.y0,L.y-4];this.pts=[];this.bezier_control_fraction=.18;this.bezier_controls={}};Ai.prototype={startGust:function(t){this.pts=[t];this.bezier_controls={};this.curl=0;this.remaining_propagations=_.apply(null,this.num_propagations);this.previous_angle=x(this.starting_angles);this.total_angle=0;this.propagation_frames=-1;this.next_curl_dir=x([1,-1]);Ji("foreground2",[this])},influenceDrone:function(){if(this.destroyed){return}if(this.pts.length<2){return}for(var t=this.getStart()-1;t<this.pts.length-2;t++){var i=C(b(Ci.drone.p_drawn,this.pts[t]));if(i.r<vt){Ci.drone.experienceWind(i,C(b(this.pts[t+1],this.pts[t])))}}},tick:function(){if(this.destroyed){return}this.propagation_frames+=1;if(this.remaining_propagations>0&&this.pts.length>0){var t=0;var i=this.curl_amplitude;if(ji%this.curl_frequency===0){if(this.next_curl_dir===1){this.curl=_(t,i)}this.curl*=this.next_curl_dir;this.next_curl_dir*=-1}var e=h(this.propagation_length,this.previous_angle+this.curl);this.pts.push(w(this.last(),D(e)));this.calculateNextControlPoint();this.previous_angle=e.th;this.total_angle+=this.previous_angle;this.remaining_propagations-=1;this.influenceDrone()}else{this.destroy()}},calculateNextControlPoint:function(){if(this.pts.length<2){return}if(this.pts.length===2){this.bezier_controls[0]=[this.pts[0],this.pts[0]]}else{var t=this.pts.length-2;var i=this.pts[t-1],e=this.pts[t],n=this.pts[t+1];var r=b(n,i);var s=C(r);var o=h(s.r*this.bezier_control_fraction*this.curl,s.th);var l=D(o);var u=a(e.x-l.x,e.y-l.y);var c=a(e.x+l.x,e.y+l.y);this.bezier_controls[t]=this.curl>0?[u,c]:[c,u]}},draw:function(){if(this.destroyed){return}if(this.pts&&this.pts.length<3){return}var t=this.pts;var i=this.bezier_controls;var e=this;pi.forEach(function(n){W.do(windlayer.ctx,W.lineStyle(n[0],{lineWidth:n[1],globalAlpha:n[2],lineCap:"round"}),function(){var n=e.getStart();windlayer.ctx.beginPath();windlayer.ctx.moveTo(t[n-1].x,t[n-1].y);for(var r=n;r<t.length-1;r++){var s=i[r-1][1];var o=i[r][0];var a=t[r];windlayer.ctx.bezierCurveTo(s.x,s.y,o.x,o.y,a.x,a.y)}})})},getStart:function(){var t=y(1,this.pts.length-this.visible_gust_length);if(this.remaining_propagations<this.visible_gust_length){t=Math.floor(this.pts.length-1-this.remaining_propagations)}return t},last:function(){if(this.pts.length<1){return null}return this.pts[this.pts.length-1]},destroy:function(){delete this.pts;delete this.bezier_controls;Ni(this);this.destroyed=true}};function Ri(t){this.p=t;this.platform=xi.ground;this.container=null;this.person_distance=null;this.reset=function(){if(!this.container&&Ci.drone.person){if(d(Ci.drone.person.p.x-this.p.x)<bt){Gi.push(this);this.person_distance=u(this.p,Ci.drone.person.p)}}};this.tick=function(){if(this.container){this.p=w(this.container.p,a(.45,.2))}if(!this.container){this.p=this.platform.pointAt(this.p.x)}}}var Pi=function(t,i){this.p=t;this.v=D(h(It,i));this.tick=function(){this.__proto__.tick.apply(this);if(u(this.p,Ci.drone.p_drawn)<Bt){this.onHit()}if(this.p.y<0||this.p.y>L.y){Ni(this)}};this.draw=function(){W.c(stage.ctx,this.p,Tt,W.shapeStyle(si))};this.onHit=function(){Ni(this);Ci.drone.dockIntegrity(jt)}};Pi.prototype=new wi;function Ti(t){this.item=new Ri(t);this.p=t;this.draw=function(){var t=.7+.3*f(.08*ji);t*=t;this.drawRepr(this.p,1.5,W.shapeStyle(Qt,{globalAlpha:t/4}));this.drawRepr(this.p,1.3,W.shapeStyle(Qt,{globalAlpha:t/2}));this.drawRepr(this.p,1.2,W.shapeStyle(Qt,{globalAlpha:t}));this.drawRepr(this.p,1,W.shapeStyle(oi))};this.use=function(){if(u(this.p,Ci.drone.p)>3*kt){return}Ni(this);if(this.container)this.container.drop();Ci.drone.fillEnergy()},this.drawRepr=function(t,i,e,n){n=n||stage.ctx;var r=i*Ut.x/2;var s=i*Ut.y;W.r(n,{x:t.x-r,y:t.y},{x:t.x+r,y:t.y+s},e);[-.2,.05].forEach(function(r){r*=i;W.r(n,{x:t.x+r,y:t.y+s},{x:t.x+r+.15*i,y:t.y+s+.1*i},e)})}}Ti.prototype=new Ri;var Bi={draw:function(){for(var t in this.displays){this.displays[t].call(this)}},displays:{energy:function(){var t=w(w(overlay.origin,overlay.size),Ot);(new Ti).drawRepr(t,1.3,W.shapeStyle(hi),overlay.ctx);t=w(t,a(.6,.06));W.r(overlay.ctx,t,w(t,Lt),W.shapeStyle(li));W.r(overlay.ctx,t,w(t,a(Lt.x*Ci.drone.energy,Lt.y)),W.shapeStyle(hi))},integrity:function(){var t=w(w(overlay.origin,overlay.size),Ht);Ci.drone.drawRepr(w(t,a(0,.2)),1.3,W.shapeStyle(hi),{ctx:overlay.ctx,freeze:true});t=w(t,a(1,.06));W.r(overlay.ctx,t,w(t,Lt),W.shapeStyle(li));W.r(overlay.ctx,t,w(t,a(Lt.x*Ci.drone.integrity,Lt.y)),W.shapeStyle(hi))},rpm:function(){this.drawDial(qt,w(w(overlay.origin,overlay.size),Gt),Ci.drone.rpm_scale,[.82,.85])}},drawDial:function(t,i,e,n){var r=w(i,D(h(t,0)));var s=w(i,D(h(t,o)));var a=w(i,D(h(t*.8,o*(1-e))));r.x+=.2;s.x-=.2;var l=W.lineStyle(hi,{lineWidth:.06});var n=n||[0,0];var u=o*(1-n[0]);var c=o*(1-n[1]);W.a(overlay.ctx,i,t,0,o,W.shapeStyle(li));W.a(overlay.ctx,i,t*.2,0,o,W.shapeStyle(hi));W.a(overlay.ctx,i,t,0,o,W.lineStyle(hi,{lineWidth:.13}));W.a(overlay.ctx,i,t,c,u,W.lineStyle(ci,{lineWidth:.13}));i.y+=.05;a.y+=.05;W.l(overlay.ctx,i,a,l)}};var Ii={tick:function(){Xi("Event tick");if(m(gt)){var t=a(game_origin.x-1,R(Ci.drone.p_drawn.y+_(-10,10),[xi.ground.y0+2,L.y-2]));Xi("p:",t);(new Ai).startGust(t)}}};t.object_groups={background:[],foreground1:[],foreground2:[],overlay:[]};var Fi=false;var ji=0;var Ui=0;var Wi=0;var qi=0;var Li=0;var Oi=500;var Hi=[];var Gi=[];function Yi(i){if(!Fi){return}n(Yi);var e=i-Wi;qi=1e3/e;Wi=i;if(ji===0){Ui=i}else{Li=(Wi-Ui)/ji}if(ji%Oi===0){console.group("Frame "+ji+" | "+i)}Hi=[];Gi=[];loop_objects.forEach(function(t){t.skip_tick=false});loop_objects.forEach(I);loop_objects.forEach(F);if(ji in t.schedule){t.schedule[ji].forEach(function(t){t()});delete t.schedule[ji]}loop_objects.forEach(j);Xi("Drone controls: ",Ci.drone.person);Xi("Person holds:   ",Ci.drone.person?Ci.drone.person.inventory_item:null);Xi("Drone energy:   ",Ci.drone.energy);Xi(" ");Xi(" ");if(ji%Oi===0){console.groupEnd()}if(ji in gameplay_frame_callbacks){gameplay_frame_callbacks[ji]()}ji+=1}function Ni(t){delete t.tick;delete t.draw}function Ji(i,e){if(!e.length){e=[e]}e.forEach(function(e){t.object_groups[i].push(e)});if(Fi){Ki()}
}function Ki(){t.loop_objects=object_groups.background.concat(object_groups.foreground1).concat(object_groups.foreground2).concat(object_groups.overlay)}function Qi(){Ki();Fi=true;ji=0;n(Yi)}t.schedule={};function Vi(i,e){var n=ji+i;if(!(n in t.schedule)){t.schedule[n]=[]}t.schedule[n].push(e)}function Xi(){if(ji%Oi!==0){return}console.debug.apply(console,arguments)}gameplay_frame_callbacks={};t.onFrame=function(t,i){gameplay_frame_callbacks[t]=i};t.onload=function(){function t(){if(Fi){return}ji+=1;n(t);introimg.clear();Ci.drone.drawRepr(a(L.x*.7,L.y*.4),10,W.shapeStyle("white"),{ctx:introimg.ctx,rpm_scale:.2})}n(t)};e("#start-game").onclick=Zi;e("#skip").onclick=Zi;function Zi(){e("#skip").style.display="none";e("#game-intro").style.display="none";e("#intro-img").style.display="none";xi.generate();t.ideas={smalltalk:new mi("smalltalk"),drone:new mi("drone",{draw:Ci.drone.drawRepr})};t.target=(new bi).init({p:a(_(500,1e3),3),v:a(-.05,0),role:Si.game_target});Ji("background",[Ii,Ci]);Ji("background",xi.buildings);Ji("foreground1",[Ci.drone,(new bi).init({p:a(L.x+5,3)}),(new bi).init({p:a(L.x+20,3),v:a(-.05,0),role:Si.guard}),target,new Ti(a(L.x+8,3))]);Ji("foreground2",[xi,lightning]);Ji("overlay",[gi,Bi]);xi.buildings.forEach(function(t){t.prepopulate()});Qi()}var $i=new(window.AudioContext||window.webkitAudioContext);var te=$i.createGain();te.connect($i.destination);te.gain.value=1;function ie(t){return t.map(function(t){var i=$i.createOscillator();i.connect(te);i.type="triangle";i.frequency.value=t;i.start();return i})}var ee={muted:false,volume:1,buzzes:[],startBuzz:function(){this.buzzes=ie([162,220,195],0)},toggleMute:function(){this.muted=!this.muted;te.gain.value=this.muted?0:this.volume}};ee.startBuzz()})();
