kontra.init(document.getElementById("myCanvas"));var mouseX=0,mouseY=0,mouseClicked=!1,mouseReleased=!1,pPressed=!1,rPressed=!1,catImage=new Image;catImage.src="imgs/cat1.jpeg";var titleImage=new Image;titleImage.src="imgs/title.png";var director=new GameDirector,grid=new GameGrid(128,64,6);grid.newGrid(0);var monitor=new GameMonitor(600,200);
window.onload=function(){kontra.canvas.addEventListener("mousemove",function(c){var e=kontra.canvas.getBoundingClientRect();mouseX=c.clientX-e.left;mouseY=c.clientY-e.top});document.body.onmouseup=function(){mouseClicked=!1;mouseReleased=!0};document.body.onmousedown=function(){mouseClicked=!0;mouseReleased=!1};window.onkeyup=function(c){80==c.keyCode?pPressed=!1:82==c.keyCode&&(rPressed=!1)};window.onkeydown=function(c){80==c.keyCode?pPressed=!0:82==c.keyCode&&(rPressed=!0)}};
var loop=kontra.gameLoop({update:function(){director.update();grid.flowUpdate()},render:function(){grid.render();monitor.render();kontra.context.drawImage(titleImage,600,32,256,128)}});
function GameGrid(c,e,d){this.grid=[];this.endIndex=this.startIndex=0;this.gridActive=!1;this.xOffset=c;this.yOffset=e;this.sinInput=0;this.draggingStatus=!1;this.draggingGridIndex=-1;this.draggingOffset={xOffset:0,yOffset:0};this.flowIndex=-1;this.prefillWidth=this.flowFill=0;this.speedMultiplier=1;this.flowSpeed=.1;this.startGrid=function(){this.gridActive=!0;this.newGrid();this.flowSpeed=.2;this.flowIndex=-1;this.prefillWidth=this.flowFill=0;this.speedMultiplier=1};this.stopGrid=function(){this.gridActive=
!1;this.draggingStatus&&0<this.grid[this.draggingGridIndex].fillAmount&&(this.draggingStatus=!1,this.draggingGridIndex=-1,this.draggingOffset={xOffset:0,yOffset:0})};this.increaseSpeed=function(){this.flowSpeed+=.1};this.flowUpdate=function(){if(this.gridActive)if(-1==this.flowIndex)100>this.flowFill?(this.flowFill+=.08,this.prefillWidth=(this.flowFill-0)/100*384):this.grid[this.startIndex].hidden?director.endGame(!1):this.grid[this.startIndex].checkFlow(3)?(this.flowIndex=this.startIndex,this.flowFill=
0,monitor.updateState(2)):director.endGame(!1);else{var d=this.flowIndex;if(100>this.grid[d].fillAmount)this.grid[d].fillAmount+=this.flowSpeed*this.speedMultiplier;else{var a=this.grid[d].getNextIndex(d,this.endIndex);-1==a?director.endGame(!1):-2==a?director.levelProgress():2==this.grid[a].pieceType?director.endGame(!1):this.grid[a].hidden?director.endGame(!1):(d=this.grid[d].checkEndFlow(),this.grid[a].checkFlow(d)?this.flowIndex=a:director.endGame(!1))}}};this.newGrid=function(){this.grid=[];
this.draggingStatus=!1;this.draggingGridIndex=-1;this.draggingOffset={xOffset:0,yOffset:0};this.flowFill=0;this.flowIndex=-1;this.prefillWidth=0;this.speedMultiplier=1;for(var f=Math.floor(6*Math.random()),a=d*d-Math.floor(6*Math.random()),b=generateGrid(f,a);null==b;)f=Math.floor(6*Math.random()),a=d*d-Math.floor(6*Math.random()),b=generateGrid(f,a);this.startIndex=f;this.endIndex=a;for(f=0;f<d;f++)for(a=0;a<d;a++){var c=b[f*d+a];this.grid.push(new GridSpace(64*f+this.xOffset,64*a+this.yOffset,c.rotation,
c.pieceType))}};this.render=function(){var d="default",a=kontra.context;a.font="48px Trebuchet MS";a.beginPath();roundRect(a,this.xOffset-16,this.yOffset-32,408,424,4);a.fillStyle="#393E41";a.fill();if(this.gridActive){for(g=0;g<this.grid.length;g++){this.draggingGridIndex!=g&&this.grid[g].render();var b=this.grid[g].x,c=this.grid[g].y;if(mouseX>b&&mouseX<b+64){if(mouseY>c&&mouseY<c+64)if(this.grid[g].hidden)a.beginPath(),a.rect(b,c,64,64),d=.75*Math.abs(Math.sin(this.sinInput)),a.fillStyle="rgba(252, 255, 85,"+
d+")",a.fill(),d="pointer",mouseClicked&&(mouseClicked=!1,this.grid[g].hidden&&(this.grid[g].hidden=!1));else if(this.draggingGridIndex!=g&&2!=this.grid[g].pieceType&&0==this.grid[g].fillAmount&&(a.beginPath(),a.rect(b,c,64,64),d=.75*Math.abs(Math.sin(this.sinInput)),a.fillStyle="rgba(252, 255, 85,"+d+")",a.fill(),d="pointer",mouseClicked&&(mouseClicked=!1,this.draggingStatus=!0,this.draggingGridIndex=g,this.draggingOffset.xOffset=mouseX-this.grid[g].x,this.draggingOffset.yOffset=mouseY-this.grid[g].y),
mouseReleased&&this.draggingStatus)){mouseReleased=!1;var e=this.grid[g].rotation;b=this.grid[g].pieceType;c=this.draggingGridIndex;this.grid[g].rotation=this.grid[c].rotation;this.grid[g].pieceType=this.grid[c].pieceType;this.grid[c].rotation=e;this.grid[c].pieceType=b;this.draggingStatus=!1;this.draggingGridIndex=-1;this.draggingOffset={xOffset:0,yOffset:0}}this.sinInput+=.001}}if(this.draggingStatus)if(0<this.grid[this.draggingGridIndex].fillAmount)this.draggingStatus=!1,this.draggingGridIndex=
-1,this.draggingOffset={xOffset:0,yOffset:0};else if(d="pointer",mouseReleased)this.draggingStatus=mouseReleased=!1,this.draggingGridIndex=-1,this.draggingOffset={xOffset:0,yOffset:0};else switch(this.grid[this.draggingGridIndex].pieceType){case 0:showBentPiece(mouseX-this.draggingOffset.xOffset,mouseY-this.draggingOffset.yOffset,this.grid[this.draggingGridIndex].rotation,0,0);break;case 1:showStraightPiece(mouseX-this.draggingOffset.xOffset,mouseY-this.draggingOffset.yOffset,this.grid[this.draggingGridIndex].rotation,
0,0)}128<mouseX&&265>mouseX&&470<mouseY&&502>mouseY&&(d="pointer",mouseClicked&&(mouseClicked=!1,this.speedMultiplier=45))}else for(var g=0;g<this.grid.length;g++)this.grid[g].render();document.body.style.cursor=d;b=this.grid[this.startIndex].x;c=this.grid[this.startIndex].y;a.beginPath();a.rect(b-16,c+16,16,32);a.fillStyle="#92CDD3";a.fill();a.beginPath();a.moveTo(b-16,c+24);a.quadraticCurveTo(b-40,c+24,b-40,c+48);a.lineTo(b-24,c+48);a.quadraticCurveTo(b-24,c+40,b-16,c+40);a.closePath();a.fill();
e=Math.PI;a.translate(this.xOffset-64,512);a.rotate(e);a.beginPath();a.moveTo(-16,24);a.quadraticCurveTo(-40,24,-40,48);a.lineTo(-24,48);a.quadraticCurveTo(-24,40,-16,40);a.closePath();a.fill();a.rotate(-e);a.translate(-(this.xOffset-64),-512);a.beginPath();a.moveTo(b-40,c+48);a.lineTo(b-40,465);a.lineTo(b-24,465);a.lineTo(b-24,c+48);a.closePath();a.fill();a.beginPath();a.rect(0,472,80,16);a.fill();a.beginPath();a.moveTo(b-16,c+16);a.lineTo(b-16,c+48);a.lineTo(b,c+32);a.closePath();a.fillStyle="#ffff00";
a.fill();b=this.grid[this.endIndex].x;c=this.grid[this.endIndex].y;a.beginPath();a.rect(b+64,c+16,16,32);a.fillStyle="#92CDD3";a.fill();a.beginPath();a.moveTo(b+64+16,c+24);a.quadraticCurveTo(b+64+40,c+24,b+64+40,c+48);a.lineTo(b+64+24,c+48);a.quadraticCurveTo(b+64+24,c+40,b+64+16,c+40);a.closePath();a.fill();e=1.5*Math.PI;a.translate(b+64,448);a.rotate(e);a.beginPath();a.moveTo(-16,24);a.quadraticCurveTo(-40,24,-40,48);a.lineTo(-24,48);a.quadraticCurveTo(-24,40,-16,40);a.closePath();a.fill();a.rotate(-e);
a.translate(-(b+64),-448);a.beginPath();a.moveTo(b+64+40,c+48);a.lineTo(b+64+40,465);a.lineTo(b+64+24,465);a.lineTo(b+64+24,c+48);a.closePath();a.fill();a.beginPath();a.rect(560,472,64,16);a.fill();a.beginPath();a.moveTo(b+64,c+16);a.lineTo(b+64,c+48);a.lineTo(b+64+16,c+32);a.closePath();a.fillStyle="#ffff00";a.fill();a.beginPath();roundRect(a,this.xOffset,470,128,32,4);a.fillStyle="#E2C24F";a.fill();a.font="24px Trebuchet MS";a.fillStyle="#000000";a.fillText("Speed Up",this.xOffset+16,500);a.beginPath();
a.rect(this.xOffset,56,this.prefillWidth,8);a.fillStyle="lime";a.fill();a.font="16px Courier New";a.fillStyle="#FFFFFF";a.fillText("Prefill",this.xOffset,50)}}
function GridSpace(c,e,d,f){this.x=c;this.y=e;this.rotation=d;this.pieceType=f;this.flowDirection=this.fillAmount=0;this.hidden=!0;1==this.pieceType&&1<this.rotation&&(this.rotation=Math.round(Math.random()));this.getNextIndex=function(a,b){switch(this.checkEndFlow()){case 0:if(36>a+1&&0!=(a+1)%6)return a+1;break;case 1:if(0<a-6)return a-6;break;case 2:if(0<=a-1&&0!=a%6)return a-1;break;case 3:if(a==b)return-2;if(36>a+6)return a+6}return-1};this.checkEndFlow=function(){switch(this.pieceType){case 0:switch(this.rotation){case 0:return 0==
this.flowDirection?2:3;case 1:return 0==this.flowDirection?3:0;case 2:return 0==this.flowDirection?0:2;case 3:return 0==this.flowDirection?1:2}break;case 1:return 0==this.rotation?0==this.flowDirection?2:0:0==this.flowDirection?1:3}return-1};this.checkFlow=function(a){switch(this.pieceType){case 0:switch(this.rotation){case 0:if(0==a)return this.flowDirection=1,!0;if(1==a)return this.flowDirection=0,!0;break;case 1:if(1==a)return this.flowDirection=1,!0;if(2==a)return this.flowDirection=0,!0;break;
case 2:if(2==a)return this.flowDirection=1,!0;if(3==a)return this.flowDirection=0,!0;break;case 3:if(3==a)return this.flowDirection=1,!0;if(0==a)return this.flowDirection=0,!0}break;case 1:if(0==this.rotation){if(0==a)return this.flowDirection=1,!0;if(2==a)return this.flowDirection=0,!0}else{if(1==a)return this.flowDirection=0,!0;if(3==a)return this.flowDirection=1,!0}}return!1};this.render=function(){var a=kontra.context;if(this.hidden)a.beginPath(),a.rect(this.x,this.y,64,64),a.fillStyle="#393E41",
a.fill(),a.beginPath(),a.rect(this.x+4,this.y+4,56,56),a.fillStyle="#D3D0CB",a.fill(),a.fillStyle="#393E41",a.fillText("?",this.x+24,this.y+50);else switch(this.pieceType){case 0:showBentPiece(this.x,this.y,this.rotation,this.flowDirection,this.fillAmount);break;case 1:showStraightPiece(this.x,this.y,this.rotation,this.flowDirection,this.fillAmount);break;case 2:showBlockingPiece(this.x,this.y)}}}
function GameDirector(){this.level=this.gameState=0;this.update=function(){pPressed?(pPressed=!1,0==this.gameState&&this.startGame()):rPressed&&(rPressed=!1,2==this.gameState&&this.startGame())};this.startGame=function(){this.level=0;this.gameState=1;monitor.updateState(1);monitor.updateLevel(0);grid.startGrid()};this.levelProgress=function(){this.level++;5==this.level?(monitor.updateLevel(this.level),this.endGame(!0)):(monitor.updateState(1),monitor.updateLevel(this.level),grid.stopGrid(),grid.startGrid())};
this.endGame=function(c){this.gameState=2;c?monitor.updateState(3):monitor.updateState(4);grid.stopGrid()}}
function GameMonitor(c,e){this.x=c;this.y=e;this.state=this.level=this.ellipsisTicks=this.ellipsisProgress=0;this.updateState=function(d){this.state=d;this.ellipsisProgress=this.ellipsisTicks=0};this.updateLevel=function(d){this.level=d};this.render=function(){var d=kontra.context;d.beginPath();roundRect(d,this.x-16,this.y-16,364,316,4);d.fillStyle="#E2C24F";d.fill();d.beginPath();roundRect(d,this.x+16,this.y+16,300,256,4);d.fillStyle="white";d.fill();d.drawImage(catImage,this.x+75,this.y+56,192,
168);var c=33.6*this.level;d.beginPath();d.rect(this.x+75,this.y+56,192,168-c);d.fillStyle="white";d.fill();d.fillStyle="#2e2e2e";d.fillText("Download Progress "+this.level+"/5",this.x+24,this.y+32);d.font="24px Courier New";switch(this.state){case 0:d.fillStyle="#2e2e2e";d.fillText("Press [p] to start!",this.x+36,this.y+265);break;case 1:c="";for(var a=0;a<this.ellipsisProgress;)c+=".",a++;d.fillStyle="#2e2e2e";d.fillText("Starting Download"+c,this.x+24,this.y+265);this.ellipsisTicks++;25<=this.ellipsisTicks&&
(this.ellipsisProgress++,this.ellipsisTicks=0,3<this.ellipsisProgress&&(this.ellipsisProgress=0));break;case 2:c="";for(a=0;a<this.ellipsisProgress;)c+=".",a++;d.fillStyle="#2e2e2e";d.fillText("Downloading"+c,this.x+24,this.y+265);this.ellipsisTicks++;25<=this.ellipsisTicks&&(this.ellipsisProgress++,this.ellipsisTicks=0,3<this.ellipsisProgress&&(this.ellipsisProgress=0));break;case 3:d.fillStyle="#2e2e2e";d.fillText("Downloaded!",this.x+36,this.y+265);break;case 4:d.fillStyle="#2e2e2e",d.fillText("Connecting failed...",
this.x+24,this.y+245),d.fillText("Press [r] to reset.",this.x+24,this.y+265)}}}
function Computer(c,e){this.x=c;this.y=e;this.mouth=0;this.render=function(){var d=this.x,c=this.y,a=kontra.context;a.beginPath();a.rect(d+32,c+150,160,32);a.fillStyle="#424242";a.fill();roundRect(a,d,c,220,165,4);a.fillStyle="#393E41";a.fill();roundRect(a,d+16,c+16,188,133,4);a.fillStyle="white";a.fill();roundRect(a,d+16,c+16,188,133,4);a.strokeStyle="#424242";a.stroke();a.beginPath();a.rect(d+78,c+46,16,32);a.rect(d+126,c+46,16,32);a.fillStyle="#F1F1F1";a.fill();a.beginPath();var b=Math.atan2(mouseY-
(62+c),mouseX-(86+d));0>b&&(b+=2*Math.PI);var e=4*Math.cos(b);b=4*Math.sin(b);a.rect(d+82+e,c+50+b,8,24);b=Math.atan2(mouseY-(62+c),mouseX-(134+d));0>b&&(b+=2*Math.PI);e=4*Math.cos(b);b=4*Math.sin(b);a.rect(d+130+e,c+50+b,8,24);a.fillStyle="#353535";a.fill();0==this.mouth?(a.beginPath(),a.rect(d+86,c+120,48,4),a.fillStyle="#353535",a.fill()):(1==this.mouth?(a.beginPath(),a.moveTo(d+76,c+120),a.quadraticCurveTo(d+110,c+135,d+86+58,c+120)):(a.beginPath(),a.moveTo(d+76,c+120),a.quadraticCurveTo(d+110,
c+105,d+86+58,c+120)),a.lineWidth=2,a.strokeStyle="#353535",a.stroke())}}
function showStraightPiece(c,e,d,f,a){var b=kontra.context;a=(a-0)/100*64;b.beginPath();b.rect(c,e,64,64);b.fillStyle="#E5F3F6";b.fill();d?(b.beginPath(),f?b.rect(c,e,a,64):b.rect(c+64,e,-a,64),b.fillStyle="lime",b.fill(),b.beginPath(),b.moveTo(c,e),b.lineTo(c+64,e),b.lineTo(c+64,e+16),b.lineTo(c,e+16),b.moveTo(c,e+64),b.lineTo(c+64,e+64),b.lineTo(c+64,e+64-16),b.lineTo(c,e+64-16),b.fillStyle="#191919",b.fill(),b.beginPath(),b.rect(c,e+64-16-4,64,-8)):(b.beginPath(),f?b.rect(c,e,64,a):b.rect(c,e+
64,64,-a),b.fillStyle="lime",b.fill(),b.beginPath(),b.moveTo(c,e),b.lineTo(c,e+64),b.lineTo(c+16,e+64),b.lineTo(c+16,e),b.moveTo(c+64,e),b.lineTo(c+64,e+64),b.lineTo(c+64-16,e+64),b.lineTo(c+64-16,e),b.fillStyle="#191919",b.fill(),b.beginPath(),b.rect(c+64-16-4,e,-8,64));b.fillStyle="rgba(255, 255, 255, 0.75)";b.fill();b.beginPath();b.moveTo(c,e);b.lineTo(c,e+64);b.lineTo(c+64,e+64);b.lineTo(c+64,e);b.closePath();b.strokeStyle="#FFFFFF";b.lineWidth=2;b.stroke()}
function showBentPiece(c,e,d,f,a){var b=kontra.context;a=(a-0)/100*-.5+.5;b.beginPath();b.rect(c,e,64,64);b.fillStyle="#E5F3F6";b.fill();var h=0,k=c,g=e,l=0,m=0;f?l=a:m=a;switch(d){case 1:h=Math.PI/2;k=c+64;break;case 2:h=Math.PI/2*2;k=c+64;g=e+64;break;case 3:h=Math.PI/2*3,g=e+64}b.translate(k,g);b.rotate(h);b.beginPath();b.arc(64,0,64,Math.PI*(.5+l),Math.PI*(1-m));b.stroke();b.lineTo(64,0);b.closePath();b.fillStyle="lime";b.fill();b.beginPath();b.moveTo(0,0);b.lineTo(0,64);b.lineTo(64,64);b.lineTo(64,
48);b.bezierCurveTo(64,48,16,48,16,0);b.closePath();b.moveTo(64,0);b.lineTo(64,16);b.bezierCurveTo(48,16,48,0,48,0);b.closePath();b.fillStyle="#191919";b.fill();b.beginPath();b.moveTo(26,8);b.bezierCurveTo(26,8,26,38,56,38);b.strokeStyle="rgba(255, 255, 255, 0.75)";b.lineWidth=8;b.stroke();b.rotate(-h);b.translate(-k,-g);b.beginPath();b.moveTo(c,e);b.lineTo(c,e+64);b.lineTo(c+64,e+64);b.lineTo(c+64,e);b.closePath();b.strokeStyle="#FFFFFF";b.lineWidth=2;b.stroke()}
function showBlockingPiece(c,e){var d=kontra.context;d.beginPath();d.rect(c,e,64,64);d.fillStyle="#191919";d.fill();d.beginPath();d.moveTo(c+8,e+8);d.lineTo(c+64-8,e+64-8);d.moveTo(c+8,e+64-8);d.lineTo(c+64-8,e+8);d.strokeStyle="#FF1D1D";d.lineWidth=8;d.stroke();d.beginPath();d.moveTo(c,e);d.lineTo(c,e+64);d.lineTo(c+64,e+64);d.lineTo(c+64,e);d.closePath();d.strokeStyle="#FFFFFF";d.lineWidth=2;d.stroke()}
function roundRect(c,e,d,f,a,b){c.beginPath();c.moveTo(e+b,d);c.lineTo(e+b+f,d);c.quadraticCurveTo(e+b+f+b,d,e+b+f+b,d+b);c.lineTo(e+b+f+b,d+b+a);c.quadraticCurveTo(e+b+f+b,d+b+a+b,e+b+f,d+b+a+b);c.lineTo(e+b,d+b+a+b);c.quadraticCurveTo(e,d+b+a+b,e,d+b+a);c.lineTo(e,d+b);c.quadraticCurveTo(e,d,e+b,d)}
function generateGrid(c,e){for(var d=[],f=0;36>f;f++){var a=!1;.4>Math.random()&&f!=c&&f!=e&&(a=!0);d.push({blocking:a,visited:!1,parent:-1})}for(f=[c];0<f.length;)if(a=f.shift(),!d[a].visited&&!d[a].blocking){d[a].visited=!0;if(a===e){var b=[];b.push(a);for(a=d[a].parent;a!=c;)b.push(a),a=d[a].parent;b.push(c);a=[];for(f=0;f<b.length;f++)if(0==f){var h=b[f]-b[f+1];1==h?a.push({pieceType:0,rotation:0}):-1==h?a.push({pieceType:0,rotation:1}):6==h&&a.push({pieceType:1,rotation:1})}else if(f==b.length-
1)h=b[f]-b[f-1],1==h?a.push({pieceType:0,rotation:3}):-1==h?a.push({pieceType:0,rotation:2}):-6==h&&a.push({pieceType:1,rotation:1});else{h=b[f]-b[f+1];var k=b[f]-b[f-1];1==h?-1==k?a.push({pieceType:1,rotation:0}):6==k?a.push({pieceType:0,rotation:3}):-6==k&&a.push({pieceType:0,rotation:0}):-1==h?1==k?a.push({pieceType:1,rotation:0}):6==k?a.push({pieceType:0,rotation:2}):-6==k&&a.push({pieceType:0,rotation:1}):6==h?1==k?a.push({pieceType:0,rotation:3}):-1==k?a.push({pieceType:0,rotation:2}):-6==k&&
a.push({pieceType:1,rotation:1}):-6==h&&(1==k?a.push({pieceType:0,rotation:0}):-1==k?a.push({pieceType:0,rotation:1}):6==k&&a.push({pieceType:1,rotation:1}))}for(f=[];0<a.length;)b=Math.round(Math.random()*(a.length-1)),f.push(a[b]),a.splice(b,1);a=f;b=[];for(f=0;f<d.length;f++)d[f].blocking?b.push({pieceType:2,rotation:0}):0<a.length?.25>Math.random()?b.push({pieceType:Math.round(Math.random()),rotation:Math.round(3*Math.random())}):(h=a.shift(),b.push({pieceType:h.pieceType,rotation:h.rotation})):
b.push({pieceType:Math.round(Math.random()),rotation:Math.round(3*Math.random())});return b}b=a-6;0<=b&&!d[b].blocking&&!d[b].visited&&(f.push(b),d[b].parent=a);b=a+6;b<d.length&&!d[b].blocking&&!d[b].visited&&(f.push(b),d[b].parent=a);b=a+1;b<d.length&&0!=b%6&&!d[b].blocking&&!d[b].visited&&(f.push(b),d[b].parent=a);b=a-1;0<=b&&0!=(b+1)%6&&!d[b].blocking&&!d[b].visited&&(f.push(b),d[b].parent=a)}return null}loop.start();