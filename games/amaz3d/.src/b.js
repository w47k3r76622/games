!function(){function e(e,t,r){var a=Math.max(0,Math.min(1,(r-e)/(t-e)));return a*a*(3-2*a)}function t(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function r(e,t,r){return e===t?e:e*(1-r)+t*r}function a(e,t,a){return e.map(function(e,n){return r(e,t[n],a)})}function n(e,t){var r=e[0]-t[0],a=e[1]-t[1],n=e[2]-t[2];return Math.sqrt(r*r+a*a+n*n)}function i(e,t,r){var a=t[0],n=t[1],i=t[2];return e[0]=a*r[0]+n*r[3]+i*r[6],e[1]=a*r[1]+n*r[4]+i*r[7],e[2]=a*r[2]+n*r[5]+i*r[8],e}function o(e,t){var r=t[0],a=t[1],n=t[2],i=Math.cos(e),o=Math.sin(e);return[r*r*(1-i)+i,r*a*(1-i)-n*o,r*n*(1-i)+a*o,r*a*(1-i)+n*o,a*a*(1-i)+i,a*n*(1-i)-r*o,r*n*(1-i)-a*o,a*n*(1-i)+r*o,n*n*(1-i)+i]}function u(e){P.useProgram(e[0])}function f(e,t){return e[t]||(e[t]=P.getUniformLocation(e[0],t))}function m(){var e=P.createTexture();return P.bindTexture(P.TEXTURE_2D,e),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,P.NEAREST),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,P.NEAREST),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),e}function v(e,t){return P.activeTexture(P.TEXTURE0+t),P.bindTexture(P.TEXTURE_2D,e),t}function l(e,t,r){var a=t[0],n=t[1],i=t[2],o=t[3],c=t[4],u=t[5],f=t[6],m=t[7],v=t[8],l=r[0],h=r[1],s=r[2],d=r[3],x=r[4],b=r[5],p=r[6],g=r[7],T=r[8];return e[0]=l*a+h*o+s*f,e[1]=l*n+h*c+s*m,e[2]=l*i+h*u+s*v,e[3]=d*a+x*o+b*f,e[4]=d*n+x*c+b*m,e[5]=d*i+x*u+b*v,e[6]=p*a+g*o+T*f,e[7]=p*n+g*c+T*m,e[8]=p*i+g*u+T*v,e}function h(e){for(var t=0;t<e.length;t++)if(e[t].identifier===J)return e[t];return null}function s(e){return[e.clientX,e.clientY]}function d(e){return q.map(function(r,a){return{dot:t(e,r),a:r,i:a}}).sort(function(e,t){return t.dot-e.dot})}function x(e,t){var r=Math.floor(t/e[2]),a=t-r*e[2];return t=r,[r=Math.floor(t/e[1]),t-r*e[1],a]}function b(e,t){return(t[0]*e[1]+t[1])*e[2]+t[2]}function p(e,t,r){var a=t>r?[r,t]:[t,r];e.push(a)}function g(e,t,r){if(t>r){var a=t;t=r,r=a}return e.some(function(e){return e[0]===t&&e[1]===r})}function T(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}function E(e,t,r){var a=b(e.dim,t),n=b(e.dim,T(t,r));return g(e.e,a,n)?1:0}function M(e,t){return q.map(function(r){return E(e.map,t,r)})}function R(e){function t(e){return b(u,e)}function r(e){return e[0]>=0&&e[0]<u[0]&&e[1]>=0&&e[1]<u[1]&&e[2]>=0&&e[2]<u[2]}function a(e){return q.map(function(t){return T(e,t)}).filter(r)}function n(e){return Math.floor(e*Math.random())}function i(e,r,n,i){var o;v.push(t(e));var c=[];for(o=0;o<n;o++){var u=a(e).map(function(e){var r=t(e);return{pos:e,i:r,explored:-1!==v.indexOf(r),random:Math.random()}}).sort(function(e,t){return 9*(e.explored-t.explored)+e.random-t.random})[0];if(u.explored&&Math.random()>i)break;u.explored||v.push(u.i),p(c,t(e),u.i),e=u.pos}return c.length>=r&&(m=m.concat(c)),o}var o=Math.round(2+2*Math.log(1+.3*e)),c=1-Math.exp(-.05*e),u=[o,o,o],f=u[0]*u[1]*u[2],m=[],v=[],l=u.map(n);i(l,0,0===e?Math.round(3+3*Math.random()):Math.floor(f*Math.max(.1,.8+.6*Math.random()-Math.random()*Math.random()*Math.random()-.4*c)),1);for(var h=x(u,v[Math.floor(2+(v.length-3)/2)]),s=0===e?0:Math.floor((.5*(Math.random()-.5)+c)*f),d=0;d<10&&s>0;d++)s-=i(x(u,function(){for(var e=0;e<100;e++){var t=n(f);if(-1===v.indexOf(t))return t}return n(f)}()),10,10+Math.random()*s,.3);return{e:m,k:l,i:h,dim:u}}function D(e){var t=R(e);return{acc:0,level:e,status:1,statusChangeT:0,gameTime:30+20*t.dim[0],map:t,marble:t.i,cubeR:[1,0,0,0,1,0,0,0,1]}}function y(e,r,c){(e=Object.assign({},e)).statusChangeT+=c;var u=e.level;2===e.status&&e.statusChangeT>3&&(e=D(u+1)),L&&k[32]&&(!u||e.statusChangeT>3)&&((e=D(u+1)).statusChangeT=2.5);var f,m;if(1===e.status){f=0===u?document.title:"Level "+u,m=0===u?U?"Drag to rotate":"Arrows + Shift / XBox controller":"",e.gameTime-=c,e.gameTime<30&&(m=Math.ceil(e.gameTime)),e.cubeR=e.cubeR.slice(0);r.d.forEach(function(t,r){if(t){var a=[0,0,0];a[2-r]=1,l(e.cubeR,e.cubeR,o(4*c*t,a))}});var v=[];i(v,[0,-1,0],e.cubeR);var h=e.marble.map(Math.floor),s=e.marble.map(Math.ceil),x=n(h,e.marble),b=M(e,h);M(e,s);if(0===x){var p=d(v).filter(function(e){return b[e.i]})[0];p&&p.dot>0?e.marble=p.a.map(function(e,t){return h[t]+.001*e}):e.acc=0}else{var g=t(h.map(function(e,t){return e-s[t]}),v);e.acc=(e.acc+.003)*(.9+.1*Math.abs(g));var T=Math.max(0,Math.min(x-e.acc*g,1));e.marble=a(h,s,T)}n(e.marble,e.map.k)<.01?(e.status=2,e.statusChangeT=0):e.gameTime<=0&&(e.status=3,e.statusChangeT=0)}return 2===e.status&&(f="Well Done!"),3===e.status&&(f="GameOver lvl "+e.level,m="Reload to restart – @greweb 2017"),e.text=f,e.subtext=m,e}function A(e,t){return Math.abs(e)<t?0:e}function _(){var e=(k[39]||k[68])-(k[37]||k[65]||k[81]),t=(k[40]||k[83])-(k[38]||k[87]||k[90]),r=k[16]?[e,0,t]:[0,e,t],a=navigator.getGamepads?navigator.getGamepads():[];if(a[0]){var n=a[0].axes,i=a[0].buttons;n.length>=2&&(r[1]+=A(n[0],.2),r[2]+=A(n[1],.2)),n.length>=4&&(r[0]+=A(n[2],.2),r[2]+=A(n[3],.2)),i.length>7&&(r[0]+=i[7].value-i[6].value)}if(V&&Y){var o=Y[0]-V[0],c=Y[1]-V[1];r[1]-=o/100,r[2]-=c/100}return{d:r}}function S(e){requestAnimationFrame(S),H||(H=e),Q=Math.min(100,e-H),H=e,Z+=Q,w($,null);var t=$;w($=y(t,_(),Q/1e3),t)}function w(t,r){P.bindFramebuffer(P.FRAMEBUFFER,null),u(W);var a=t.status,n=t.map;if(r&&t.text===r.text||($t.textContent=t.text),r&&t.subtext===r.subtext||($f.textContent=t.subtext||" "),!r||n!==r.map){var i=n.dim[0]*n.dim[1]*n.dim[2];K=new Uint8Array(i);for(var o=0;o<i;o++)K[o]=M(t,x(n.dim,o)).reduce(function(e,t){return e<<1|t},0)<<2;v(G,0),P.texImage2D(P.TEXTURE_2D,0,P.LUMINANCE,K.length,1,0,P.LUMINANCE,P.UNSIGNED_BYTE,K),P.uniformMatrix3fv(f(W,"cubeR"),!1,t.cubeR),P.uniform3fv(f(W,"key"),n.k),P.uniform3fv(f(W,"marble"),t.marble),P.uniform1i(f(W,"mapT"),0),P.uniform3fv(f(W,"mapDim"),n.dim),P.uniform1f(f(W,"time"),Z/1e3);var c=0,m=0,l=0,h=0;1===a&&(c=e(30,0,t.gameTime),m=e(3,0,t.gameTime),l=e(3,0,t.statusChangeT)),2===a&&(h=e(0,3,t.statusChangeT)),3===a&&(c=1,m=1),P.uniform1f(f(W,"hurry"),c),P.uniform1f(f(W,"dead"),m),P.uniform1f(f(W,"boot"),l),P.uniform1f(f(W,"boom"),h),P.drawArrays(P.TRIANGLES,0,3)}}var L=!1,U="ontouchstart"in document,P=c.getContext("webgl")||c.getContext("experimental-webgl"),C=Math.min(window.screen&&Math.min(screen.width,screen.height)||500,500),I=C,z=C,X=(Math.random(),U?1:devicePixelRatio),F=I*X,O=z*X;c.width=F,c.height=O,c.style.width=I+"px",c.style.height=z+"px";P.viewport(0,0,F,O),P.pixelStorei(P.UNPACK_FLIP_Y_WEBGL,!0);var N=P.createBuffer();P.bindBuffer(P.ARRAY_BUFFER,N),P.bufferData(P.ARRAY_BUFFER,new Float32Array([-1,-1,-1,4,4,-1]),P.STATIC_DRAW);for(var W=function(e,t){var r,a=P.VERTEX_SHADER,n=e;r=P.createShader(a),P.shaderSource(r,n),P.compileShader(r);var i=r;if(L&&!P.getShaderParameter(r,P.COMPILE_STATUS))throw P.getShaderInfoLog(r);a=P.FRAGMENT_SHADER,n=t,r=P.createShader(a),P.shaderSource(r,n),P.compileShader(r);var o=r;if(L&&!P.getShaderParameter(r,P.COMPILE_STATUS))throw P.getShaderInfoLog(r);var c=P.createProgram();if(P.attachShader(c,i),P.attachShader(c,o),P.linkProgram(c),L&&!P.getProgramParameter(c,P.LINK_STATUS))throw P.getProgramInfoLog(c);P.useProgram(c);var u=P.getAttribLocation(c,"p");return P.enableVertexAttribArray(u),P.vertexAttribPointer(u,2,P.FLOAT,!1,0,0),[c]}("attribute vec2 p;varying vec2 uv;void main(){gl_Position=vec4(p,0.0,1.0);uv=p;}","precision highp float;varying vec2 uv;uniform sampler2D mapT;uniform float time,hurry,boot,dead,boom;uniform vec3 key,marble,mapDim;uniform mat3 cubeR;vec3 a;float b(float c,float d){return min(c,d);}vec2 b(vec2 c,vec2 d){return mix(c,d,step(d.x,c.x));}float e(vec2 f){return min(f.x,f.y);}float e(vec3 f){return min(min(f.x,f.y),f.z);}float g(vec3 f){return max(max(f.x,f.y),f.z);}vec3 h(inout vec3 i,vec3 j){vec3 k=floor((i+j*0.5)/j);i=mod(i+j*0.5,j)-j*0.5;return k;}float l(vec3 i,vec2 m){vec2 n=abs(vec2(length(i.xz),i.y))-m;return min(max(n.x,n.y),0.0)+length(max(n,0.0));}float o(vec3 i,vec3 p){return g(abs(i)-p);}float q(vec3 i,float r){return length(i)-r;}float s(vec3 t){return texture2D(mapT,vec2((t[2]+mapDim[2]*(t[1]+mapDim[1]*t[0])+0.5)/(mapDim[0]*mapDim[1]*mapDim[2]),0.5)).r;}vec3 u;vec2 v(vec3 i,float f,vec3 t){f*=2.;float w=floor(f);f-=w;f*=2.;float x=floor(f);f-=x;f*=2.;float y=floor(f);f-=y;f*=2.;float z=floor(f);f-=z;f*=2.;float A=floor(f);f-=A;f*=2.;float B=floor(f);float C=0.03*hurry;float D=0.18;float E=D;float F=0.3;i-=C*u;float r=q(i,E);r=mix(r,b(r,l(i-vec3(0.0,0.25,0.0),vec2(D,0.25))),y);r=mix(r,b(r,l(i-vec3(0.0,-0.25,0.0),vec2(D,0.25))),z);r=mix(r,b(r,l(i.yxz-vec3(0.0,-0.25,0.0),vec2(D,0.25))),x);r=mix(r,b(r,l(i.yxz-vec3(0.0,0.25,0.0),vec2(D,0.25))),w);r=mix(r,b(r,l(i.yzx-vec3(0.0,0.25,0.0),vec2(D,0.25))),A);r=mix(r,b(r,l(i.yzx-vec3(0.0,-0.25,0.0),vec2(D,0.25))),B);return vec2(r,0.99*smoothstep(0.6,0.3,length((i+t-marble)/mapDim)));}vec2 G(vec3 i){float H=o(i-mapDim/2.+0.5,mapDim/2.-0.5);vec2 n=vec2(99.,0.0);float I=time*floor(1.+5.*hurry);float J=3.;u=vec3(cos(J*i.y+I),sin(J*i.z+I),cos(J*i.x+I));if(H<=.5){vec3 t=h(i,vec3(1.0));float K=s(t);if(K!=0.){n=b(n,v(i,K,t));}else{n=b(n,vec2(0.03+e(vec3(mix(0.5-i.x,0.5+i.x,step(0.,a.x)),mix(0.5-i.y,0.5+i.y,step(0.,a.y)),mix(0.5-i.z,0.5+i.z,step(0.,a.z)))/(1.0+a)),0.));}}else{n=vec2(H,0.0);}return n;}vec2 L(vec3 i,float M){float I=3.*time+M;float J=10.+M;float N=0.03+.02*M;return vec2(q(i+N*vec3(cos(J*i.x+I),sin(J*i.y+I),cos(J*i.z+I)),0.4),M*1.2);}vec2 O(vec3 i){i.z-=2.2*mapDim.z;vec2 n=vec2(30.0-i.z,0.0);i=cubeR*i;i+=mapDim/2.0-0.5;n=b(n,G(i));n=b(n,L(i-marble,1.+3.*boom));n=b(n,L(i-key,0.+4.*boom));n.x*=1.-2.*boot+3.*boot*boot;n.x+=boom*boom;return n;}vec3 P(float Q,vec3 R){return mix(vec3(0.9),vec3(0.3,0.7,1.1),Q*Q*0.6);}float S(float Q){return 0.2+0.4*step(3.,Q)*step(Q,3.999);}vec2 T(vec3 a){int U=12+int(60.*(1.-dead)*(1.-hurry*hurry)*(1.+.1*cos(mix(2.*time,20.*time,hurry))));float V=0.1;vec2 W;for(int X=0;X<60;++X){vec3 i=a*V;W=O(i);V+=W.x;if(W.x<0.002||X>U) return vec2(V,W.y);}return vec2(V,W.y);}vec3 Y(vec3 i){return normalize(vec3(O(i+vec3(.01,0.,0.)).x-O(i-vec3(.01,0.,0.)).x,O(i+vec3(0.,.01,0.)).x-O(i-vec3(0.,.01,0.)).x,O(i+vec3(0.,0.,.01)).x-O(i-vec3(0.,0.,.01)).x));}void main(){a=normalize(vec3(uv,2.5));vec2 W=T(a);float Z=W.y;float ba=W.x;vec3 bb=a*ba;vec3 R=Y(bb);vec3 bc=normalize(vec3(0.1,0.3,-1.0));gl_FragColor=vec4(mix(P(Z,R)*(.1+mix(vec3(1.),vec3(1.,.0,.0),dead)*(mix(dot(bc,R),1.,.8)+pow(dot(-a,normalize(reflect(bc,R))),4.)*S(Z))),vec3(1.),smoothstep(8.0,22.0,ba)),1.0);}"),G=m(),k={},B=0;B<99;++B)k[B]=0;var J,j,V,Y;U?(addEventListener("touchstart",function(e){if(!J){e.preventDefault();var t=e.changedTouches[0];J=t.identifier,j=Date.now(),V=s(t)}}),addEventListener("touchmove",function(e){var t=h(e.changedTouches);t&&(e.preventDefault(),Y=s(t))}),addEventListener("touchend",function(e){h(e.changedTouches)&&(e.preventDefault(),Y=J=V=null)}),addEventListener("touchcancel",function(e){h(e.changedTouches)&&(e.preventDefault(),Y=J=V=null)})):(addEventListener("keydown",function(e){e.which>=37&&e.which<=40&&e.preventDefault(),k[e.which]=1}),addEventListener("keyup",function(e){e.which>=37&&e.which<=40&&e.preventDefault(),k[e.which]=0}));var q=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]];requestAnimationFrame(S),L&&console.log("DEBUG on");var Q,H,K,Z=0,$=D(0)}();