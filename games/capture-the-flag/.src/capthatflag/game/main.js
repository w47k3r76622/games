function dst(t,e,n,a){return Math.sqrt((n-t)*(n-t)+(a-e)*(a-e))}function diff(t,e,n,a){return{x:t-n,y:e-a}}function norm(t,e){var n=dst(0,0,t,e);return n>0?{x:t/n,y:e/n}:{x:0,y:0}}function removeDeadObjs(t,e,n){for(var a=0;a<t.length;a++)t[a][e]==n&&t.splice(a,1)}function Player(t,e,n,a){this.x=t||0,this.y=e||0,this.isOut=0,this.path=null,this.tmpPath=null,this.carryingFlag=!1,this.maxPathDist=.1*canW,this.maxPathLen=2,this.pathLen=0,this.r=.025*canW,this.speed=3,this.team=n,this.number=a,this.col=n?"#3399FF":"#FF5050",this.outln=n?"#0033CC":"#CC0000",this.disabledCol=n?"#444499":"#994444",this.draw=function(){ctx.fillStyle=this.isOut?this.disabledCol:this.col,ctx.strokeStyle=this.outln,ctx.lineWidth=5,ctx.setLineDash([1,0]),ctx.beginPath(),ctx.arc(this.x,this.y,this.r,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.closePath()},this.update=function(){if(this.path&&!this.isOut){var t=diff(this.path.x,this.path.y,this.x,this.y),e=dst(0,0,t.x,t.y);if(e<this.speed){this.x=this.path.x,this.y=this.path.y;var n=this.path;this.path=n.nextPathNode,this.path&&(this.path.previousPathNode=this),n.destroy()}else{var a=norm(t.x,t.y);a.x*=this.speed,a.y*=this.speed,this.x+=a.x,this.y+=a.y}}},this.tagYouAreOut=function(){this.isOut=!0,this.carryingFlag=!1;var t=function(e){e&&e.destroy&&!e.shouldBeDeleted&&(e.shouldBeDeleted=!0,t(e.previousPathNode),t(e.nextPathNode),e.destroy())};t(this.path)},this.contains=function(t){if(t.team==this.team)return!1;var e=dst(t.x,t.y,this.x,this.y);return t.r?e<this.r+t.r:e<this.r},this.toString=function(){return"["+this.team+":"+this.number+"]"}}function NeutralZone(){this.percentW=.03*canW,this.center=canW/2,this.left=this.center-this.percentW,this.right=this.center+this.percentW,this.draw=function(){ctx.lineWidth=0,ctx.fillStyle="#999999",ctx.fillRect(this.left,0,2*this.percentW,canH),ctx.lineWidth=5,ctx.strokeStyle="#666666",ctx.setLineDash([10,5]),ctx.beginPath(),ctx.moveTo(this.left,0),ctx.lineTo(this.left,canH),ctx.moveTo(this.right,0),ctx.lineTo(this.right,canH),ctx.stroke(),ctx.closePath()},this.contains=function(t){var e=this.left<t.x&&t.x<this.right;return e}}function Flag(t){this.x=t?.05*canW:.95*canW,this.y=canH/2,this.carried=0,this.r=.07*canW,this.team=t,this.flagSize=.01*canW,this.flagCol=t?"#3399FF":"#FF5050",this.flagOutln=t?"#0033CC":"#CC0000",this.col="#999999",this.outln="#666666",this.draw=function(){this.carried||(ctx.fillStyle=this.col,ctx.strokeStyle=this.outln,ctx.lineWidth=5,ctx.setLineDash([10,7]),ctx.beginPath(),ctx.arc(this.x,this.y,this.r,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.closePath())},this.drawTop=function(){ctx.fillStyle=this.flagOutln,ctx.strokeStyle=this.flagCol,ctx.lineWidth=1,ctx.setLineDash([1,0]),ctx.beginPath(),ctx.moveTo(this.x,this.y),ctx.lineTo(this.x-this.flagSize,this.y-this.flagSize),ctx.lineTo(this.x+this.flagSize,this.y-this.flagSize),ctx.lineTo(this.x,this.y),ctx.fill(),ctx.stroke(),ctx.closePath()},this.update=function(){this.carried&&!this.carried.isOut?(this.x=this.carried.x,this.y=this.carried.y):this.carried=null},this.contains=function(t){if(this.carried)return!1;if(t.previousPathNode&&this.team!==t.team||!t.previousPathNode&&this.team===t.team)return!1;var e=dst(t.x,t.y,this.x,this.y);return e<this.r}}function PathNode(t,e,n,a,i){this.previousPathNode=n,this.nextPathNode=a,this.x=t,this.y=e,this.r=.01*canW,this.team=i,this.col="#777777",this.invalidColor="#ff9999",this.invalid=!1,this.shouldBeDeleted=!1,this.draw=function(){this.invalid?(ctx.fillStyle=this.invalidColor,ctx.strokeStyle=this.invalidColor,ctx.setLineDash([10,7])):(ctx.fillStyle=this.col,ctx.strokeStyle=this.col,ctx.setLineDash([1,0])),ctx.lineWidth=15,ctx.beginPath(),ctx.arc(this.x,this.y,this.r,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.closePath(),this.previousPathNode&&(ctx.beginPath(),ctx.moveTo(this.x,this.y),ctx.lineTo(this.previousPathNode.x,this.previousPathNode.y),ctx.fill(),ctx.stroke(),ctx.closePath())},this.contains=function(t){return dst(this.x,this.y,t.x,t.y)<this.r},this.destroy=function(){this.previousPathNode=null,this.nextPathNode=null,this.shouldBeDeleted=!0}}function AI(t,e,n){function a(t){function e(e,n){return dst(t.x,t.y,e.x,e.y)>dst(t.x,t.y,n.x,n.y)?-1:1}var n=[];return l.others.forEach(function(t){if(!t.isOut){for(var a=!1,i=0;i<n.length;i+=1)if(-1==e(n[i],t)){n.splice(i,0,t),a=!0;break}a||n.push(t)}}),n}function i(t){return l.team.teamNumber?t.x<canW/2:t.x>canW/2}function s(){l.state.others.attacking=[],l.others.forEach(function(t){i(t)&&l.state.others.attacking.push(t)})}function o(){var t=0;l.others.forEach(function(e){t+=e.isOut?1:0}),l.state.others.out=t}function r(){l.state.defenders=[],l.team.forEach(function(t){"defend"==t.aiRole&&l.state.defenders.push(t)})}function h(){var t=0;l.team.forEach(function(e){t+=e.isOut?1:0}),l.state.out=t}function c(){l.state.desired={save:0,defend:0,attack:0},l.state.out<=0?l.team.flag.carried?(l.state.desired.save=2,l.state.desired.attack=1):l.state.others.out<=0?(l.state.desired.attack=1,l.state.desired.defend=2):l.state.others.out>0&&(l.state.desired.attack=2,l.state.desired.defend=1):1==l.state.out?l.team.flag.carried?(l.state.desired.save=1,l.state.desired.attack=1):(l.state.desired.attack=1,l.state.desired.defend=1):l.state.out>=2&&(l.team.flag.carried?(l.state.desired.save=1,l.state.desired.attack=0):(l.state.desired.attack=1,l.state.desired.defend=0))}var l=this;this.team=t,this.others=e,this.neutralZones=n,this.state={others:{},desired:{}},this.getRoles=function(){s(),o(),h(),c();var t=this.state;this.team.forEach(function(e){e.enemyTarget=null,t.desired.defend>0?(e.aiRole="defend",t.desired.defend-=1):t.desired.attack>0&&(e.aiRole="attack",t.desired.attack-=1)}),r()},this.getMoves=function(){var t=this.state;this.getRoles();var e=[];return this.team.forEach(function(n){if(!n.isOut){var i={num:n.number,team:n.team,path:[]};if("defend"==n.aiRole){if(t.others.attacking.length>0){var s=a(n),o={x:s[0].x,y:s[0].y},r=diff(o.x,o.y,l.team.flag.x,l.team.flag.y);r.x*=.5,r.y*=.5,l.getPath(n,{x:o.x-r.x,y:o.y-r.y},i.path)}}else if("save"==n.aiRole){var s=a(n),o={x:s[0].x,y:s[0].y},h=(o.x-canW/2)/2+o.x;l.getPath(n,{x:o.x-h,y:o.y},i.path)}else"attack"==n.aiRole&&(n.carryingFlag?l.getPath(n,{x:l.team.flag.x,y:l.team.flag.y},i.path):l.getPath(n,{x:l.others.flag.x,y:l.others.flag.y},i.path));e.push(i)}}),e},this.getPath=function(t,e,a){function i(e,a,i){function s(t){t.contains(u)&&(h=!0)}var o={x:e.x,y:e.y};dst(e.x,e.y,i.x,i.y)>t.maxPathDist?(o.x+=a.x*t.maxPathDist,o.y+=a.y*t.maxPathDist):(o.x=i.x,o.y=i.y);for(var r=.5*dst(o.x,o.y,e.x,e.y),h=!1,c=0;10>c;c+=1){h=!1;var l={x:(2*Math.random()-1)*r,y:(2*Math.random()-1)*r},u={x:e.x+a.x*r+l.x,y:e.y+a.y*r+l.y};if(n.forEach(s),!h)return u}return console.error("Could not find position"),e}var s=diff(e.x,e.y,t.x,t.y),o=norm(s.x,s.y),r=i(t,o,e),h=i(r,o,e);a.push(r),a.push(h)}}function Server(){function t(t){console.log("RESPONSE"),c&&c(t)}function e(){console.log("DISCONNECTED"),document.getElementById("msg").innerHTML="Other Player Disconnected",setTimeout(function(){location.reload()},3e3)}function n(t){console.log("READY"),document.getElementById("msg").innerHTML="Found Another Player, Starting...",setTimeout(function(){document.getElementById("msg").innerHTML=""},2e3),l&&l(t)}function a(t){}function i(){r=!0,console.log("connecting"),o.connected||(o=io(document.location.href)),o.on("response",t),o.on("sync",a),o.on("ready",n),o.on("disconnect",e)}function s(t,e){console.log("Send data to server"),t.b?setTimeout(function(){e(t)},10):(console.log("EMIT STEP"),c=e,o.emit("step",t))}var o={},r=!1,h=5e3,c=null,l=null,u=null;this.joinGameOrCreateGame=function(t){i(),l=function(e){u&&clearTimeout(u),myTeamNumber=e.teamNumber,playAgainstAI=e.playAgainstAI,t()},u=setTimeout(function(){var t=l;l=null,document.getElementById("msg").innerHTML="Couldn't Find Another Player.<br>Playing Against AI.",setTimeout(function(){document.getElementById("msg").innerHTML=""},2e3),t&&t({id:"LOCAL GAME",teamNumber:1,playAgainstAI:!0}),o.emit("quit",{})},h)},this.send=function(t,e,n){s({a:t,b:e},n)},this.roundOver=function(){},this.sendSync=function(t,e){o.emit("clientsync",{})}}var canvas=null,ctx=null,canX=0,canY=0,canW=800,canH=450,mouseState={x:0,y:0,down:!1},lastMouseState={x:0,y:0,down:!1},lastKeyState={up:0,down:0,left:0,right:0,space:0},keyState={up:0,down:0,left:0,right:0,space:0},WAIT_FOR_SERVER="waitforserver",SETUP="setup",NEW_TURN="newturn",PICK_PLAYER="pickplayer",SELECT_PATH="selectpath",ADD_PATH="addpath",SEND_DATA_TO_SERVER="senddatatoserver",MOVE_PLAYERS="moveplayers",TEAM_0_WIN="team0win",TEAM_1_WIN="team1win",team0Score=0,team1Score=0,myTeamNumber=0,playAgainstAI=!1;window.onload=function(){function t(t){for(var e=0,n=0;t&&!isNaN(t.offsetLeft)&&!isNaN(t.offsetTop);)e+=t.offsetLeft-t.scrollLeft,n+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{top:n,left:e}}function e(){lastMouseState.x=mouseState.x,lastMouseState.y=mouseState.y,lastMouseState.down=mouseState.down,lastKeyState.up=keyState.up,lastKeyState.right=keyState.right,lastKeyState.left=keyState.left,lastKeyState.down=keyState.down,lastKeyState.space=keyState.space}function n(t){function e(t){for(var e={num:t.number,team:t.team,path:[]},n=t.tmpPath;n;)e.path.push({x:n.x,y:n.y}),n=n.nextPathNode;L.push(e)}if(console.log("New Game State: "+t),P=t,P==SETUP){r=[],r.push(new NeutralZone),l=new Flag(0),r.push(l),u=new Flag(1),r.push(u),h=[],h.teamNumber=0,h.flag=l,h.score=0;var a=canW-.3*canW,i=.3*canH,s=.5*canH,o=.7*canH;h.push(new Player(a,i,0,1)),h.push(new Player(a,s,0,2)),h.push(new Player(a,o,0,3)),c=[],c.teamNumber=1,c.flag=u,c.score=0;var N=.3*canW;c.push(new Player(N,i,1,1)),c.push(new Player(N,s,1,2)),c.push(new Player(N,o,1,3)),myTeamNumber?(document.getElementById("msg").innerHTML="Blue Team",d=c,f=h):(document.getElementById("msg").innerHTML="Red Team",d=h,f=c),setTimeout(function(){document.getElementById("msg").innerHTML=""},2e3),playAgainstAI&&(x=new AI(f,d,[r[0],r[1]])),y=[],y.push(l),y.push(u),h.forEach(function(t){y.push(t)}),c.forEach(function(t){y.push(t)}),p=[],r.forEach(function(t){p.push(t)}),y.forEach(function(t){p.push(t)}),v=[],n(NEW_TURN)}else if(P==NEW_TURN){S.startTime=(new Date).getTime(),S.timer=setTimeout(function(){keyState.space=1,lastKeyState.space=0,S.element&&(S.element.style.visibility="hidden")},S.totalTime),S.element=document.getElementById("timer"),S.element&&(S.element.style.visibility="visible"),S.update=function(){if(S.element){var t=S.diff(),e=Math.floor(S.totalTime/1e3+1-t/1e3);S.element.innerHTML=e+""}},S.diff=function(){return(new Date).getTime()-S.startTime};var A=function(t){t.pathLen=0};h.forEach(A),c.forEach(A),n(m&&x?SEND_DATA_TO_SERVER:PICK_PLAYER)}else if(P==PICK_PLAYER)g&&(g.previousPathNode&&(g.previousPathNode.nextPathNode=null),g.destroy(),g=null),E=null;else if(P==SELECT_PATH)if(g&&(g.update=null),E&&E.pathLen<E.maxPathLen){var _=new PathNode(0,0,g,null,E.team);null==_.previousPathNode?_.previousPathNode=E:_.previousPathNode.nextPathNode=_,_.update=function(){var t=diff(mouseState.x,mouseState.y,_.previousPathNode.x,_.previousPathNode.y);if(dst(0,0,t.x,t.y)>E.maxPathDist){var e=norm(t.x,t.y);t.x=e.x*E.maxPathDist,t.y=e.y*E.maxPathDist}this.x=_.previousPathNode.x+t.x,this.y=_.previousPathNode.y+t.y;var n=this;this.invalid=!1,r.forEach(function(t){t.contains(n)&&(n.invalid=!0)})},g=_,y.push(g),p.push(g),v.push(g)}else g=null,n(PICK_PLAYER);else if(P==ADD_PATH)E&&(E.pathLen+=1,E.tmpPath||(E.tmpPath=g)),n(SELECT_PATH);else if(P==SEND_DATA_TO_SERVER){n(PICK_PLAYER),P=SEND_DATA_TO_SERVER;var L=[],D=null;m?D=m.getMoves():(L=[],d.forEach(e),D=L);var I=null;x&&(I=x.getMoves()),T.send(D,I,function(t){var e=function(t,e,n){var a=[];t.path.forEach(function(t){a.push(new PathNode(t.x,t.y,null,null,n))});for(var i=0;i<a.length;i+=1)a[i].previousPathNode=i-1>=0?a[i-1]:null,a[i].nextPathNode=i+1<a.length?a[i+1]:null;e.forEach(function(e){if(e.number===t.num&&!e.isOut){var n=function(t){t&&t.destroy&&!t.shouldBeDeleted&&(t.shouldBeDeleted=!0,n(t.previousPathNode),n(t.nextPathNode),t.destroy())};n(e.tmpPath),e.tmpPath=a[0],e.tmpPath&&(e.tmpPath.previousPathNode=e,a.forEach(function(t){p.push(t),v.push(t)}))}})};t.a.forEach(function(t){e(t,d,d.teamNumber)}),t.b.forEach(function(t){e(t,f,f.teamNumber)}),n(MOVE_PLAYERS)})}else if(P==MOVE_PLAYERS){var R=function(t){t.path=t.tmpPath,t.tmpPath=null};h.forEach(R),c.forEach(R)}else P==TEAM_0_WIN?(T.roundOver(),team0Score+=1,document.getElementById("0").innerHTML=""+team0Score,document.getElementById("msg").innerHTML="Red Team Scored!",setTimeout(function(){document.getElementById("msg").innerHTML="",n(SETUP)},3e3)):P==TEAM_1_WIN&&(T.roundOver(),team1Score+=1,document.getElementById("1").innerHTML=""+team1Score,document.getElementById("msg").innerHTML="Blue Team Scored!",setTimeout(function(){document.getElementById("msg").innerHTML="",n(SETUP)},3e3))}canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");var a=t(canvas);canX=a.left,canY=a.top;var i=function(t){mouseState.x=t.clientX-canX,mouseState.y=t.clientY-canY},s=function(t){mouseState.down=!0},o=function(t){mouseState.down=!1};canvas.onmousemove=i,canvas.onmousedown=s,canvas.onmouseup=o,canvas.ontouchmove=i,canvas.ontouchstart=s,canvas.ontouchend=o,document.getElementById("0").innerHTML=team0Score,document.getElementById("1").innerHTML=team1Score;var r=null,h=null,c=null,l=null,u=null,d=null,f=null,m=null,x=null,y=[],p=[],v=[],E=null,g=null,P=null,T=new Server,S={totalTime:3e3};n(WAIT_FOR_SERVER),T.joinGameOrCreateGame(function(){n(SETUP)}),setInterval(function(){if(ctx.fillStyle="#33CC33",ctx.fillRect(0,0,canW,canH),P!=WAIT_FOR_SERVER){if(y.forEach(function(t){t.update&&t.update()}),p.forEach(function(t){t.draw&&t.draw()}),l.drawTop(),u.drawTop(),S.update(),P==PICK_PLAYER&&mouseState.down&&!lastMouseState.down)E=null,d.some(function(t){return t.contains(mouseState)&&!t.isOut?(E=t,n(SELECT_PATH),!0):void 0});else if(P!=PICK_PLAYER&&P!=SELECT_PATH||!keyState.space||lastKeyState.space)if(P!=SELECT_PATH||!mouseState.down||lastMouseState.down||g.invalid){if(P==MOVE_PLAYERS){var t=function(t){t.inNeutralZone=!1};h.forEach(t),c.forEach(t),r.forEach(function(t){var e=function(e){t.contains(e)&&(e.inNeutralZone=!0)};h.forEach(e),c.forEach(e)}),h.forEach(function(t){t.inNeutralZone||c.forEach(function(e){!e.inNeutralZone&&t.contains(e)&&(t.x<canW/2?t.tagYouAreOut():e.tagYouAreOut())})});var a=!0;h.forEach(function(t){t.isOut||(a=!1),!u.carried&&t.contains({x:u.x,y:u.y})&&(u.carried=t,t.carryingFlag=!0)});var i=!0;c.forEach(function(t){t.isOut||(i=!1),!l.carried&&t.contains({x:l.x,y:l.y})&&(l.carried=t,t.carryingFlag=!0)}),v&&0==v.length?n(NEW_TURN):l.x<canW/2||a?n(TEAM_1_WIN):(u.x>canW/2||i)&&n(TEAM_0_WIN)}}else n(ADD_PATH);else n(SEND_DATA_TO_SERVER);removeDeadObjs(y,"update",!1),removeDeadObjs(y,"shouldBeDeleted",!0),removeDeadObjs(p,"shouldBeDeleted",!0),removeDeadObjs(v,"shouldBeDeleted",!0),e()}},1e3/30)};