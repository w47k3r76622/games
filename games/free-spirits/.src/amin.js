const A={R:50,ng:0,dn:{},sc:0,X:new Array(15),nX:0,ts:[]};function d(b){return document.getElementById(b)}function a(){var b=d("c");A.w=b.width=window.innerWidth-20,A.w2=A.w/2,A.h=b.height=window.innerHeight-120,A.h2=A.h/2,A.g=b.getContext("2d"),A.T=new T,A.I=new I,A.M=new M,mX(),b.addEventListener("click",oc),a2()}function a2(){if(A.nX<A.X.length){setTimeout(a2,20);return}sb(),mk(),draw(),msg("There are 10 ghosts within","250 metres of here.","","Liberate them all","before the Moon sets"),d("i").innerHTML="Endless terrain, plain JS, 2D canvas"}function draw(){A.ts=[];var b=A.g,g=A.I;if(b.fillStyle="#224",b.fillRect(0,0,A.w,A.h),A.M.set){msg("The Moon has set");return}A.M.draw(b);var i,j,c=g.x,m=Math.round(c),e=g.y,n=Math.round(e),k=[],o=!0&m;for(i=m-A.R;i<=m+A.R;i++,o=!o){var p=i-c,D=p*p,q=!0&n;for(j=n-A.R;j<=n+A.R;j++,q=!q){var r=j-e,E=Math.sqrt(D+r*r),F=Math.atan2(p,r)*g.RD,s=nm(F-g.b);-90<s&&s<90&&k.push({x:i,y:j,d:E,db:s,o:o&&q})}}k.sort(function(b,c){return c.d-b.d});for(var t=0;t<k.length;t++){var u=k[t];if(u.o){var c=u.x,e=u.y,v=!0;if(-7===c|| -7===e)b.fillStyle="#555",b.strokeStyle="#444",v=!1;else{var w=c*c+e*e;b.fillStyle=62001<=w&&w<=63001?"#554":"#405040",b.strokeStyle="#843"}var x=c-1,y=c+1,z=e-1,C=e+1,l=[g.sXY(x,C),g.sXY(y,C),g.sXY(y,z),g.sXY(x,z)];b.beginPath(),b.moveTo(l[0].x,l[0].y);for(var h=1;h<4;h++)b.lineTo(l[h].x,l[h].y);if(b.fill(),b.stroke(),v){var f=A.T.f(c,e);f<5|| -13===f||14===f?(f=Math.abs(f),df(b,f,A.X[f],c,e)):50<f&&f<250&&(h=(c*c-e)*Math.PI&7,df(b,f,A.X[5+h],c,e))}}}A.GD&&A.GD.draw(),d("s").innerHTML="Score: "+A.sc,d("i").innerHTML=g.toString()}function df(m,g,c,h,i){var b=A.I.sXY(h,i),j=5/b.d,e=c.height*j,f=c.width*j,k=b.x-f/2,l=b.y-e;m.drawImage(c,k,l,f,e),g<50&&A.ts.push({x:k,y:l,w:f,h:e,d:b.d,f:g,tx:h,ty:i})}function I(){this.HT=3,this.x=0,this.y=0,this.z=A.T.h(0,0)+this.HT,this.b=0,this.DR=Math.PI/180,this.RD=1/this.DR,this.toString=function(){return" ("+this.x.toFixed(1)+", "+this.y.toFixed(1)+", "+this.z.toFixed(1)+") "+this.b+"&deg;"},this.fwd=function(b){var c=this.b*this.DR;this.x+=b*Math.sin(c),this.y+=b*Math.cos(c),this.z=A.T.h(this.x,this.y)+this.HT,draw()},this.tn=function(b){this.b=nm(this.b+b),draw()},this.sXY=function(g,h){var b=g-this.x,c=h-this.y,e=Math.sqrt(b*b+c*c),i=nm(Math.atan2(b,c)*this.RD-this.b),j=i*this.DR,l=Math.sin(j),m=Math.cos(j),f=e*m;f<.001&&(f=.001);var k=425/f,n=k*e*l+A.w2,o=A.h2-k*(A.T.h(g,h)-this.z);return{x:n,y:o,d:e,db:i}}}function nm(b){return b< -180?b+360:b>180?b-360:b}function T(){this.P=[],this.A=[1,15,10,5,16],this.B=[14,3,17,13,7];for(var b=0;b<=127;b++)this.P.push(parseInt("01357adhlnonlhfeeefgjnqtvxyyzzyyxxwusqnkhgfffggijjihgeca85322334568abcdddeeeffgghijlnqtvuuutttssrqponljhgffeeddccba9876544321100"[b],36));this.M={},this.M["185,185"]=-13,this.M["185,-185"]=-13,this.M["-185,-185"]=-13,this.M["-185,185"]=-13,this.h=function(e,f){var b,c=0;for(b=0;b<5;b++)c+=this.P[(this.A[b]*e+this.B[b]*f)/8&127];return c/16},this.f=function(c,e){var f=this.M[c+","+e];if(f)return f;var b,g=0,h=Math.round(c),i=Math.round(e);for(b=0;b<5;b++)g+=this.P[(this.B[b]*h+this.A[b]*i)/8&127];return 4095&Math.floor(g*h*i/128)}}function fwd(){A.I.fwd(1)}function left(){A.I.tn(-15)}function right(){A.I.tn(15)}function back(){A.I.tn(180)}function sb(){var b,c="";for(b=0;b<B.length;b++)c+=mb(B[b]);for(b=0,d("b").innerHTML=c;b<B.length;b++)d(B[b].i).addEventListener("click",B[b].f)}function mb(b){return'<button class="B" id="'+b.i+'" title="Alternative key '+b.a+'">'+b.t+"<br/>"+b.k+"</button>"}const B=[{i:"L",t:"Left",k:"&#8592;",a:"a",f:left},{i:"F",t:"Forward",k:"&#8593;",a:"w",f:fwd},{i:"R",t:"Right",k:"&#8594;",a:"d",f:right},{i:"B",t:"Back",k:"&#8595;",a:"s",f:back}],K=[{f:left,k:"Left|ArrowLeft|l|L"},{f:fwd,k:"Up|ArrowUp|f|F"},{f:right,k:"Right|ArrowRight|r|R"},{f:back,k:"Down|ArrowDown|b|B"}];function mk(){A.KT={};for(var b=0;b<K.length;b++)for(var e=K[b],f=e.k.split("|"),c=0;c<f.length;c++)A.KT[f[c]]=e.f;window.addEventListener("keydown",function(b){A.KT[b.key]&&A.KT[b.key]()})}function oc(l){for(var b,i=d("c"),f=i.getBoundingClientRect(),m=(l.clientX-f.left)*i.width/f.width,n=(l.clientY-f.top)*i.height/f.height,o=1e3,e=0;e<A.ts.length;e++){var c=A.ts[e];m>c.x&&m<c.x+c.w&&n>c.y&&n<c.y+c.h&&c.d<o&&(o=c.d,b=c)}if(b){var j=b.x,k=b.y,p=A.g;switch(b.f){case 4:var g=b.tx,h=b.ty;if(A.dn[g+","+h])A.sc--,play(1),msg("Already done","","Lose a point");else if(g*g+h*h>62500)play(2),msg("Sorry","","That's outside","the 250m radius");else{for(A.sc+=10,A.dn[g+","+h]=1,A.ng++,A.v=[j,k],e=0;e<18;e++)A.v.push(j+random(0,b.w)),A.v.push(k+random(0,b.h));A.sz=b.w,play(4),ag()}break;case 13:A.GD?A.GD.dt():A.GD=new GD;break;case 14:play(3),msg("Just a bone");break;default:play(0),p.fillStyle="#700",p.fillRect(j,k,b.w,b.h),A.sc--,msg("No ghost here","","Lose a point")}}}function random(b,c){return b+Math.random()*(c-b)}function ag(){draw();var e=A.g,c=A.v,i=c[0],j=c[1],f=2;e.fillStyle="#fff",e.globalAlpha=.3;for(var b=0;b<6;b++){e.beginPath(),e.moveTo(i,j);for(var g=0;g<3;g++,f+=2)e.lineTo(c[f],c[f+1]);e.closePath(),e.fill()}for(b=0,e.globalAlpha=1;b<c.length;b+=2)c[b]+=random(-A.sz,A.sz),c[b+1]-=random(0,A.sz/2);var h=!1;for(b=1;b<c.length;b+=2)if(c[b]>0){h=!0;break}h?setTimeout(ag,40):(draw(),10===A.ng&&msg("Well done!","","You liberated all 10 ghosts"))}function msg(){var g=arguments,e=g.length;if(e>0){var c=A.g;c.font="20px sans-serif";var b,j,f=0;for(b=0;b<e;b++)(j=c.measureText(g[b]).width)>f&&(f=j);var h=(A.w-f)/2-10,m=(A.w+f)/2+10,k=25*e/2+10,i=A.h2-k,n=A.h2+k;c.fillStyle="#fff",c.fillRect(h,i,m-h,n-i);var o=h+10,l=i+25;for(b=0,c.fillStyle="#000";b<e;b++)c.fillText(g[b],o,l),l+=25}}function mX(){for(var g=new Array(15),i=new Array(15),f=0;f<5;f++){var c=100,e=200,b=cc(f,g,c,e);switch(b.fillStyle="#986",b.strokeStyle="#000",f){case 2:dp(b,[0,e,0,20,c/2,0,c,20,c,e]);break;case 3:dp(b,[0,e,0,30,30,30,30,0,c-30,0,c-30,30,c,30,c,e]);break;case 4:dp(b,[0,e,0,30,30,0,c-30,0,c,30,c,e]);break;default:b.fillRect(0,0,c,e),b.strokeRect(0,0,c,e)}b.fillStyle="#000",b.font="24px serif";var h="R. I. P.";b.fillText(h,(c-b.measureText(h).width)/2,e/2),pim(f,i,g)}for(;f<13;f++){(b=cc(f,g,c=250,e=500)).fillStyle=b.strokeStyle="#555";var k=c/2,j=random(.4*e,.7*e);dl(b,k,e,j,90,random(15,25));for(var l=0;l<random(6,12);l++)dl(b,k,e-random(.5*j,j),random(.2*c,.8*c),random(10,170),random(2,10));pim(f,i,g)}(b=cc(f=13,g,c=200,e=80)).fillStyle="#aaa",b.strokeStyle="#00f",b.fillRect(0,0,c,e),b.strokeRect(0,0,c,e),b.font="16px serif",b.fillStyle="#00f";var h="GHOST DETECTOR";b.fillText(h,(c-b.measureText(h).width)/2,30),h="Click to use",b.fillText(h,(c-b.measureText(h).width)/2,55),pim(f,i,g),(b=cc(f=14,g,c=100,e=30)).fillStyle="#ccc",b.strokeStyle="#000",dp(b,[10,0,15,0,25,7,75,7,85,0,90,0,100,5,100,10,97,15,100,20,100,25,90,30,85,30,75,23,25,23,15,30,10,30,0,25,0,20,3,15,0,10,0,5]),pim(f,i,g)}function cc(b,c,e,f){return c[b]=document.createElement("canvas"),c[b].width=e,c[b].height=f,c[b].getContext("2d")}function pim(b,c,e){c[b]=new Image,c[b].i=b,c[b].onload=function(){A.X[this.i]=this,A.nX++},c[b].src=e[b].toDataURL("image/png")}function dp(b,c){b.beginPath(),b.moveTo(c[0],c[1]);for(var e=2;e<c.length;e+=2)b.lineTo(c[e],c[e+1]);b.closePath(),b.fill(),b.stroke()}function dl(b,c,e,f,h,i){var g=h*A.I.DR;b.lineWidth=i,b.beginPath(),b.moveTo(c,e),b.lineTo(c+f*Math.cos(g),e-f*Math.sin(g)),b.stroke(),b.lineWidth=1}function GD(){A.T.M={},this.draw=function(){var b=A.X[13],c=b.width,e=b.height;A.g.drawImage(b,0,0,c,e),A.ts.push({x:0,y:0,w:c,h:e,d:0,f:13,tx:0,ty:0})},this.dt=function(){for(var e=Math.round(A.I.x),f=Math.round(A.I.y),b=e-20;b<=e+20;b++)for(var c=f-20;c<=f+20;c++)if((1&b)==1&&(1&c)==1&&4===A.T.f(b,c)&&!A.dn[b+","+c]){msg("There is a ghost","within 20m");return}msg("No ghost within 20m")},draw(),this.draw()}function M(){this.b=180,this.y=40,this.c="#ddd",this.draw=function(c){c.fillStyle=this.c;var b=A.I,e=nm(b.b-this.b);if(-90<e&&e<90){var f=1e4,g=this.b*b.DR,h=b.x+f*Math.sin(g),i=b.y+f*Math.cos(g),j=b.sXY(h,i);c.beginPath(),c.ellipse(j.x,this.y,40,40,0,0,2*Math.PI),c.fill()}},this.update=function(){this.b=nm(this.b+1),this.y+=2,this.set=!1;var c=.7*A.h2,f=1.2*A.h2;if(this.y>f)this.set=!0,clearInterval(this.t);else if(this.y>c){var e=(this.y-c)/(f-c),b=221,g=b,h=b,i=b-100,j=g-60;this.c=mcc(Math.round(b-e*i),Math.round(g-e*j),Math.round((1-e)*h))}},this.t=setInterval(um,6e4)}function um(){A.M.update()}function mcc(f,g,h){var b=f.toString(16),c=g.toString(16),e=h.toString(16);return f<16&&(b="0"+b),g<16&&(c="0"+c),h<16&&(e="0"+e),"#"+b+c+e}function play(i){if(!A.ac){if(!AudioContext||(A.ac=new AudioContext,!A.ac))return;setTimeout(cuckoo,random(6e4,3e5))}var b,c,f=A.ac.destination,e=A.ac.currentTime;switch(i){case 0:b=new OscillatorNode(A.ac,{type:"triangle",frequency:50});break;case 1:b=new OscillatorNode(A.ac,{type:"square",frequency:50});break;case 2:b=new OscillatorNode(A.ac,{type:"sine",frequency:50});break;case 3:b=new OscillatorNode(A.ac,{type:"sine",frequency:400});break;case 4:for(var g=0;g<9;g++){b=new OscillatorNode(A.ac,{type:"sine",frequency:random(800,2200)}),c=new GainNode(A.ac,{gain:.005}),b.connect(c),c.connect(f);var h=g/2;b.start(e+h),b.stop(e+h+2)}return;case 5:b=new OscillatorNode(A.ac,{type:"sine",frequency:622.25}),c=new GainNode(A.ac,{gain:.005}),b.connect(c),c.connect(f),b.start(),b.stop(e+.5),(b=new OscillatorNode(A.ac,{type:"sine",frequency:466.16})).connect(c),b.start(e+.5),b.stop(e+1);return}b.connect(f),b.start(),b.stop(e+.2)}function cuckoo(){play(5),setTimeout(cuckoo,random(6e4,3e5))}