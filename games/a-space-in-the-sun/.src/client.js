var _audC=new(window.AudioContext||window.webkitAudioContext),_aud_MV=1;function tone(t,e){if(!_audC||!_aud_MV)return{f:function(){return this},v:function(){return this}};var n=_audC.currentTime,o=_audC.createOscillator(),a=_audC.createGain();return e&&(o.type=e),o.frequency.value=0,a.gain.value=0,o.connect(a),a.connect(_audC.destination),o.start(0),o.stop(n+t),{f:function(){if(1==arguments.length)return o.frequency.value=arguments[0],this;for(var e=0;e<arguments.length;e+=1)o.frequency.linearRampToValueAtTime(arguments[e],n+e/(arguments.length-1)*t);return this},v:function(){if(1==arguments.length)return a.gain.value=arguments[0]*_aud_MV,this;for(var e=0;e<arguments.length;e+=1)a.gain.linearRampToValueAtTime(arguments[e]*_aud_MV,n+e/(arguments.length-1)*t);return this}}}var ae={clk:()=>{tone(.2,"triangle").f(200,220,200).v(.1,.3,0),tone(.2,"triangle").f(220,200,220).v(.3,.1,0)},crack:()=>{tone(.6).f(600,100).v(.1,0),setTimeout(()=>{tone(.1,"square").f(220,120,100).v(.5,.6,.3),tone(.15,"square").f(120,80,100).v(.2,.3,.5,.3)},500),setTimeout(()=>{tone(.5+Math.random(),"sawtooth").f(80,60,30,20,100,80,50).v(.1,0,.1,.05,0,.05,0,.1),tone(.1+Math.random(),"sawtooth").f(20,100,30,20,60,20,50).v(.03,0,.02,.05,0,.05,0,.05)},800)},growth:()=>{setTimeout(()=>{tone(2).f(120,420).v(0,.3),tone(2).f(220,420).v(0,.3),tone(2).f(320,420).v(0,.3)},1300)},flt_in:()=>{tone(.4).f(150,240,250).v(.1,.2,.3,0)},flt_out:()=>{tone(.4).f(250,240,150).v(.1,.2,.3,0)},discard:()=>{tone(.33).f(420,440).v(.1,.3,.3,.3,.2,.1,0)},slide:()=>{tone(1).f(100,440).v(.1,.3,.1,.3,.1,.5,.6,0)},death:()=>{tone(2).f(100,300,100,300).v(.3,.5,.1,0),tone(2).f(200,100,200,100).v(.1,.2,.5,0)},weird:()=>{tone(3).f(120,420).v(0,.3),tone(3).f(220,420).v(0,.3),tone(3).f(320,420).v(0,.3)}};function mk_brd(r){let o=null,a=(e,t,o,n,a)=>{for(e.classList.toggle("ub",0==t),e.classList.toggle("p0",0==o),e.classList.toggle("p1",1==o),e.classList.toggle("ht",!!n),i=0;i<5;i+=1)e.classList.toggle("l"+i,t&1<<i);if(0<a&&!e.g_lev){for(i=0;i<5;i+=1)t&1<<i&&(4==i?cloneM(e,"llev",3,"xx","ll").forEach((e,t)=>{let n=e.querySelector("svg");n.style.transform="rotateZ("+(120*t+20*Math.random()-10)+"deg) rotateX(-90deg)",cloneM(e,"leaf"+o,3,"p","hl").forEach((e,t)=>{e.style.transform="translateZ("+50*Math.random()/r.s+"vh) rotateZ("+60*Math.floor(6*Math.random())+"deg) rotateX("+(-20-10*Math.random())+"deg)"})}):cloneM(e,"leaf"+o,Math.floor(2+2*Math.random()),"p","l"+i).forEach(e=>{let t=e.querySelector(".rigs");t.style.transform="translateZ(5px) translateY("+30*-Math.random()+"%) rotateZ("+(.5<Math.random()?60:-60)+"deg) rotateX("+15*-Math.random()+"deg)"}));e.g_lev=a}setTimeout(()=>{for(i=0;i<6;i+=1)e.classList.toggle("g"+i,a>=i)},10)},l=(e,t)=>{let n=t%r.s,o=Math.floor(t/r.s);return o>=r.s&&(e.classList.toggle("pq",!0),e.classList.toggle("pq"+(o>r.s?"1":"0"),!0),e.style.transform="translateZ("+((n?2:120/r.s)-n)+"vh)",e.style.opacity=n?.5:1,o==r.s&&(n=-1.2),o==r.s+1&&(n=r.s+.2),o=t%r.s*1.1+2),t<0&&(n=r.s/2,o=20),e.style.left=100*n/r.s+"%",e.style.top=100*o/r.s+"%",e.style.width=e.style.height=100/r.s+"%",e};ge("gamebrd").innerHTML="";let s=new Array(r.s*(r.s+2)).fill(0).map((e,t)=>{let n=clone("gamebrd","tile");return r.txt[t]&&(n.querySelector("span").textContent=r.txt[t]),n.style.transform="rotateY("+(2*Math.random()-1)+"deg) rotateX("+(2*Math.random()-1)+"deg) rotateZ("+(4*Math.random()-2)+"deg)",cloneM(n,["crack1","crack2"],4,"l","ex"),l(n,t),n.onclick=()=>{o&&o(t)},n}),n=null;return{setT:(e,t,n,o)=>a(s[e],t,n,o),setClk:e=>{o=e},setB:(e,t)=>{ge("gban").textContent=e,ge_gone("gban",!1),clearTimeout(n),n=setTimeout(()=>ge_gone("gban","true"),t||1e3)},flat:e=>{e?ae.flt_out():ae.flt_in(),gecl("game","isI",!!r.isI),gecl("game","p1",e&&r.tn%2),gecl("game","p0",e&&!(r.tn%2))},update:()=>{r.p.forEach((e,t)=>{ge_qs("p"+t,"h2").textContent=e.n,ge_qs("p"+t,"h3").textContent=e.sc?e.sc+"%":""}),ge_gone("hlp",!(r.p[1].hlp&&hlp[r.tn])),ge("hlp").textContent=hlp[r.tn],s.forEach((e,t)=>{l(e,t),t<r.s*r.s?a(e,r.tls[t],r.own[t],!1,r.tg[t]):t-r.s<r.s*r.s?a(e,r.p[0].ft[t-r.s*r.s],-1):a(e,r.p[1].ft[t-r.s*r.s-r.s],-1)})},animateM:(e,t)=>{let n=r.s*(r.s+e);gecl("gamebrd","slow",!0);for(let e=0;e<r.s;e+=1)l(s[n+e],0==e?t:n+e-1);setTimeout(()=>{s[n].style.transform="translateZ(-1vh)",-1!=t?ae.crack():ae.discard(),1<r.gt&&ae.growth(),setTimeout(()=>gecl("gamebrd","slow",!1),800)},1e3)}}}function selTurnSoon(e,t,n,o,a,r){setTimeout(()=>selTurn(e,t,n,o,a,r),1e3)}function selTurn(t,n,e,o,a,r){if("l"==o.t){let e=t.legalM();if(0==e.length)return void r(-2);n.setClk(e=>r(e)),e.forEach(e=>n.setT(e,a,-1,!0)),n.setB("Select tile to crack",2e3),n.setClk(e=>r(e))}"r"==o.t&&(n.setB("Waiting for "+o.n+" to play...",6e4),lobby.waitMsg(e=>r(e.move))),"a"==o.t&&setTimeout(()=>r(bestM(t,o.pp,o.pp.d).m),500+1e3*Math.random())}function bestM(t,n,o){let e=t.legalM();return 0==e.length?{m:-2,sc:0}:e.map(e=>({m:e,sc:ai_eval_mv(t.gs,n,e,o)})).sort((e,t)=>t.sc-e.sc)[0]}function ai_eval_mv(a,e,t,n){let o=a.tn%2,r=1^o,l=h_gsc(a);if(l.move(t),0<n){var s=bestM(l,e,n-2);return l.move(s.m),bestM(l,e,n-1).sc}let i=2*l.gs.p[o].tsc-l.gs.p[r].tsc;l.gs.winner==o&&(i+=1e4),l.gs.winner==r&&(i-=1e4);let c=l.gs.tls.reduce((e,t,n)=>{if(0!=l.gs.tls[n])return e;var o=l.playOutcome(n,-1,0);return-1<=o&&e[o].push(n),e},{"-1":[],0:[],1:[]}),u=(o,e)=>e.reduce((e,t,n)=>{n=Math.abs(o%a.s-n%a.s)+Math.abs(o/a.s-n/a.s);return Math.min(n,e)},2*a.s);s=c[o].length<2?-10:2*c[o].length;let g=0;c[-1].forEach(e=>{var t=u(e,c[o]),e=u(e,c[r]);t<=e?g+=t<3?3:1:g-=e<3?3:1});n=Math.random();return i*e.s+s*e.o+g*e.p+n*e.r}function pubTurn(e,t,n,o,a,r){"r"==o.t&&lobby.msg({move:a})}function startGame(o){document.body.classList.toggle("ms",!1);let a=h_gs(o),r=mk_brd(o);r.flat(!1),r.update(),r.setB("Starting Game...",500);let l=()=>{r.update(),setTimeout(()=>{if(0<=o.winner)return r.setB(o.p[o.winner].n+" WON!",5e4),void setTimeout(()=>{lobby.gamedone()},5e3);r.flat(!0);let t=o.tn%2,n=o.p[t].ft[0];r.setB(o.p[t].n+"'s turn"),selTurnSoon(a,r,t,o.p[t],n,e=>{pubTurn(a,r,t,o.p[t?0:1],e,n),r.setClk(null),r.flat(!1),r.update(),e<0?r.setB(o.p[t].n+" was forced to discard ("+(o.dCnt+1)+")"):r.setB(o.p[t].n+" played"),a.move(e),r.animateM(t,e),setTimeout(l,0==o.gt?100:2e3)})},1<o.gt?3e3:500)};l()}function startGameD(e,t,n){startGame(m_gs(e.bs,e.bs%2,e.it,e.dt,t,n))}function m_gs(e,t,n,o,a,r){let l=e=>(x=1&(e>>1^e>>3),y=1&(e>>0^e>>2),e^(x<<1|x<<3)^(y<<0|y<<2)),s=new Array(5).fill(o).flat().sort(()=>Math.random()-.5),i={tn:0,s:e,winner:-1,tls:new Array(e*e).fill(0),own:new Array(e*e).fill(-1),tg:new Array(e*e).fill(0),txt:new Array(e*e).fill(""),gt:0,p:[{...a,ft:s},{...r,ft:s.map(e=>l(e))}]},c=h_gs(i);return"intro"===t?((r=(n,e)=>{e.forEach((e,t)=>{e===+e?i.tls[t+n]=e:i.txt[t+n]=e})})(0,["A",6,10]),r(8,[3,12]),r(15,[10,9,..."PACE"]),r(21,[..."IN"]),r(28,[..."THE",6,10]),r(38,[3,12]),r(45,[10,9,..."UN"]),i.isI=!0):(t&&c.add(Math.floor(i.s*i.s/2),31,-1,-1),n.forEach((e,t)=>((e,t)=>{let n;for(;n=Math.floor(Math.random()*i.s*i.s),t&&(n=Math.floor(n/i.s)*i.s),!c.canPlace(n,e););c.add(n,e,t?0:-1,-1),c.add(i.s*i.s-1-n,l(e),t?1:-1,-1)})(e,0==t))),i}function h_gsc(e){return h_gs({...e,tls:[...e.tls],own:[...e.own],tg:[...e.tg],p:[{...e.p[0],ft:[...e.p[0].ft]},{...e.p[1],ft:[...e.p[1].ft]}]})}function h_gs(a){let r=(t,n)=>{var e;0<=a.own[t]||0<=(e=i(t,a.tls[t],n))&&(a.own[t]=e,[0,1,2,3].forEach(e=>{e=s(t,e).i;0<=e&&r(e,n)}))},l=()=>{var e=a.s*a.s*2,t=o=>a.tls.reduce((e,t,n)=>e+(a.own[n]==o?a.tg[n]:0),0),n=o=>a.tls.reduce((e,t,n)=>e+(a.own[n]==o?16&t?5:2:0),0);a.p[0].sc=Math.round(100*t(0)/e),a.p[1].sc=Math.round(100*t(1)/e),a.p[0].tsc=Math.round(100*n(0)/e),a.p[1].tsc=Math.round(100*n(1)/e),50<a.p[0].sc&&(a.winner=0),50<a.p[1].sc&&(a.winner=1),4<a.dCnt&&(a.winner=a.p[0].sc>a.p[1].sc?0:1)},o=(e,t,n,o)=>{a.tls[e]=t,-1!=(a.own[e]=n)&&(a.tg[e]=1),r(e,o),l()},s=(e,t)=>{var n=e%a.s+[0,1,0,-1][t],t=Math.floor(e/a.s)+[-1,0,1,0][t];if(n<0||n>=a.s||t<0||t>=a.s)return{t:0,o:-1,i:-1};n=t*a.s+n;return{i:n,t:a.tls[n],o:a.own[n]}},i=(o,a,e)=>{let t=[0,1,2,3].map(e=>{var t=1<<e,n=1<<(e+2)%4,e=s(o,e);return 0==e.t?-2:-1==a?e.t&n?e.o:-1:0<e.t&&!!(e.t&n)!=!!(a&t)?-999:a&t?e.o:-1});return t.includes(-999)?-999:t.includes(e)?e:t.includes(1^e)?1^e:t.includes(-1)?-1:-2},c=(e,t,n)=>0==a.tls[e]&&[-1,-2,n].includes(i(e,t,n));return{add:o,canPlay:c,legalM:()=>{let n=a.tn%2,o=a.p[n].ft[0];return a.tls.map((e,t)=>c(t,o,n)?t:-1).filter(e=>0<=e)},canPlace:(e,t)=>{if(0!=a.tls[e])return!1;t=i(e,t,0);return[-2].includes(t)},move:e=>{var t=a.tn%2,n=a.p[t].ft.shift();e<(a.gt=0)?a.dCnt+=1:(a.dCnt=0,o(e,n,-1,t),a.gt=1),a.tn+=1,a.tg.forEach((e,t)=>{a.own[t]<0||e<(16&a.tls[t]?5:2)&&(a.tg[t]=e+1,a.gt=2)}),l()},gs:a,playOutcome:i}}var hlp=["Welcome to the Courtyard.\n\nIt's your turn first.\nSelect a tile in the sun to crack to allow your plant to grow.","Now my turn, I'll select my tile to crack.","The goal is to grow your plant so try to crack tiles you can grow towards.\n You can see the upcoming crack patterns on the left so you can plan ahead.","I'm not really trying to win this game, so I'll just keep out of your way.","If your vine spreads into a open hole it will root and grow upwards increasing your domination","My turn, seems like you're getting the hang of this.","The goal is to take all the space in the sun. \nYour domination of the space is shown on the left.\n You win if you can dominate 50% of the space in the sun.","If niether player can play for two turns the player with the highest domination wins."];function _init_lobby(){let o=null,n=null,a=e=>{n=e},r=null;try{r=io({upgrade:!1,transports:["websocket"]}),r.on("connect",()=>{}),r.on("lobby",e=>{let t=e.available.filter(e=>e.nick!=ge("nick").value).map(e=>({t:"Play with "+e.nick,lt:e.level,u:e,em:"🔗"}));console.log(t),t.length||(t=[{t:"No opponent",lt:"There are no others players in the lobby right now.",em:"😞"}]),menu("Player vs Player Online: Select Opponent",!0,t,(e,t)=>{r.emit("reqstart",{opponent:e.u.id})})}),r.on("disconnect",()=>{}),r.on("gm",e=>{let t=n;n=null,t&&t(e)}),r.on("playstart",e=>{var t={n:e.op,t:"r"},n={n:ge("nick").value,t:"l"};e.lead?(t=m_gs(o.bs,o.bs%2,o.it,o.dt,n,t),l(t),startGame(t)):a(e=>{e.p[0].t="r",e.p[1].t="l",startGame(e)})}),r.on("playend",()=>{gamedone()}),r.on("error",()=>{})}catch(e){}let l=e=>{r.emit("gm",e)};geclk("bck",()=>{ae.discard(),leave_mp()}),menu=(e,t,n,o)=>{ge("menu").innerHTML="",ge_qs("bot","legend").textContent=e,n.forEach((e,t)=>{let n=clone("menu","menui");qs_txt(n,"h1",e.em),qs_txt(n,"h2",e.t),qs_txt(n,"h3",e.lt),n.onclick=()=>{ae.clk(),o(e,t)}}),ge_gone("bck",!t)};let s=e=>{o=e,r.emit("el",{nick:ge("nick").value,level:e.t}),ge_no("top",!0)};return leave_mp=()=>{o&&r.emit("ll",{}),o=null,reset()},gamedone=()=>{o&&r.emit("reqend"),document.body.classList.toggle("ms",!0)},reset=()=>{document.body.classList.toggle("ms",!0),ge_gone("top",!1),menu("Select Game Type",!1,m_main,(e,t)=>{switch(t){case 0:startGame(m_gs(5,!0,[23,21,26],[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],{n:ge("nick").value,t:"l"},{n:"Teacher",t:"a",hlp:1,pp:{s:0,o:0,p:-2,r:1,d:0}}));break;case 1:menu("Player vs Computer: Board Type",!0,m_gt,(n,e)=>{menu("Player vs Computer: Opponent",!0,m_ais,(e,t)=>{p1={n:ge("nick").value,t:"l"},p2={n:e.t,t:"a",pp:e.pp},startGameD(n,p1,p2)})});break;case 2:menu("Player vs Player Local: Board Type",!0,m_gt,(e,t)=>{p1={n:ge("nick").value,t:"l"},p2={n:"Player 2",t:"l"},startGameD(e,p1,p2)});break;case 3:menu("Player vs Player Online: Board Type",!0,m_gt,(e,t)=>{s(e)})}})},{waitMsg:a,msg:l,menu:menu,enter_mp:s,reset:reset,gamedone:gamedone}}var lobby=null;function start_lobby(){lobby=lobby||_init_lobby(),ge("nick").value=oneof(["Ficus","Bigno","Loni","Wist","Hede"])+oneof(["cena","spernum","viren","teria","ra"])+" "+oneof(["Tricus","Radin","Mader","Iber","Rom"])+oneof(["ika","canna","bea"])+ +new Date%100;let n=m_gs(7,"intro"),e=mk_brd(n);e.update(),e.flat(!1),lobby.menu("Welcome to A Space in the Sun",!1,[{t:"GROW",lt:"Tap here to begin",em:"🌱"}],()=>{document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen(),document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(),e.setB("",1),n.own.forEach((e,t)=>{n.own[t]=t<20?0:1,n.tg[t]=1}),setTimeout(()=>{e.update(),e.flat(!0),setTimeout(()=>{n.own.forEach((e,t)=>{n.tg[t]=2}),e.update()},500)},500),lobby.reset()})}function init(){start_lobby()}let m_main=[{t:"Learn to Play",em:"🎓",lt:"Quick tutorials to learn to play"},{t:"Play vs Computer",em:"💻",lt:"Play against various AI opponents"},{t:"Player vs Local Player",em:"🎎",lt:"Play against a friend on one device"},{t:"Player vs Online Player",em:"🔗",lt:"Play against a human online"}],m_ais=[{t:"The Newbee Crawler",em:"💻",lt:"Not very good, does it's best to survive.",pp:{s:4,o:1,p:0,r:5,d:0}},{t:"The Trumpet Vine",em:"💻",lt:"A novice player, good to learn against.",pp:{s:5,o:2,p:1,r:5,d:1}},{t:"Westrin Creeper",em:"💻",lt:"Efficient, opportunistic, aggressive",pp:{s:5,o:5,p:2,r:10,d:2}},{t:"Honeysuckle",em:"💻",lt:"Conservative, skilled - hard to beat.",pp:{s:5,o:1,p:0,r:0,d:2}},{t:"The Oxford Ivy",em:"💻",lt:"Learned; deep thinking; a dangerous opponent",pp:{s:5,o:1,p:0,r:0,d:3}}],m_gt=[{t:"7 x 7 Standard Board",em:"🎪",bs:7,it:[7,19,31],dt:[3,6,9,5,10,12,7,11,13,14,15,7,7,11,14,15,15,15],lt:"Standard courtyard for a quick game"},{t:"7 x 7 Sparse Board",em:"🏛️",bs:7,it:[7,31],dt:[3,6,9,5,10,12,7,11,13,14,15,7,7,11,14,15,15,15,7,13,5,10],lt:"A Harsh open space for a gritty fight."},{t:"6 x 6 Expert Fast Kill",bs:6,em:"🎯",lt:"Fast and tight quick game",it:[7,21,26,31],dt:[3,6,9,5,10,12,7,11,13,14,15,7,15,15]},{t:"9 x 9 Large Board",bs:9,em:"🥋",lt:"A large busy courtyard for a longer game",it:[23,21,21,26,26,19,31,31],dt:[3,6,9,5,10,12,7,11,13,14,15,7,7,11,14,15,15,15,7,15,5,5,10,10]}],ge=e=>document.getElementById(e),gecl=(e,t,n)=>ge(e).classList.toggle(t,n),geclk=(e,t)=>ge(e).onclick=t,ge_gone=(e,t)=>gecl(e,"gone",t),ge_no=(e,t)=>gecl(e,"no",t),cloneIn=(e,t,n)=>{n=document.querySelector("#"+t).content.querySelector(n).cloneNode(!0);return e.appendChild(n),n},clone=(e,t)=>cloneIn(ge(e),t,"*"),ge_qs=(e,t)=>ge(e).querySelector(t),qs_txt=(e,t,n)=>e.querySelector(t).textContent=n,oneof=e=>Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:e,cloneM=(o,a,e,r,l)=>new Array(e).fill(0).map((e,t)=>{let n=cloneIn(o,oneof(a),"*");return n.classList.toggle(r+t,!0),n.classList.toggle(l,!0),n});