function vec(t,e){return{x:t||0,y:e||0,copy:function(t){return this.x=t.x,this.y=t.y,this},add:function(t){this.x+=t.x,this.y+=t.y}}}function getSuper(t){var e={};for(var i in t)t[i]&&t[i].call&&(e[i]=function(e){return function(){e.apply(t,arguments)}}(t[i]));return e}function rand(t,e){return void 0===t&&(t=0,e=1),void 0===e&&(e=t,t=0),t+Math.random()*(e-t)}function pick(t,e){return e?t[rnd.integer(t.length-1)]:t[~~rand(t.length)]}function invoke(t,e,i){for(var s=t.length;s--;)t[s]&&t[s][e]&&t[s][e](s,i)}function merge(t,e){for(var i in e)"undefined"==typeof t[i]&&(t[i]=e[i]);return t}function path(t,e){G.ctx.beginPath(),G.ctx.moveTo(t[0].x,t[0].y);for(var i=1;i<t.length;i++)G.ctx.lineTo(t[i].x,t[i].y);(e||void 0===e)&&G.ctx.closePath()}function pathA(t,e){G.ctx.beginPath(),G.ctx.moveTo(t[0],t[1]);for(var i=2;i<t.length;i+=2)G.ctx.lineTo(t[i],t[i+1]);(e||void 0===e)&&G.ctx.closePath()}function line(t,e,i,s,n){G.ctx.beginPath(),G.ctx.moveTo(t,e),G.ctx.lineTo(i,s),stroke(n)}function circle(t,e,i){G.ctx.beginPath(),G.ctx.arc(t,e,i,0,PI2)}function rect(t,e,i,s){G.ctx.beginPath(),G.ctx.rect(t,e,i,s)}function fill(t){t&&(G.ctx.fillStyle=t),G.ctx.fill()}function stroke(t,e){t&&(G.ctx.strokeStyle=t),e&&(G.ctx.lineWidth=e),G.ctx.stroke(),G.ctx.lineWidth=1}function dist(t,e){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function clamp(t,e,i){return e>t?e:t>i?i:t}function circleRect(t,e){var i=clamp(t.x,e.x,e.x+e.width),s=clamp(t.y,e.y,e.y+e.height),n=t.x-i,r=t.y-s;return n*n+r*r<=t.radius*t.radius}function pointInView(t,e){return t>=G.camera.x&&t<G.camera.x+W&&e>=G.camera.y&&e<G.camera.y+H}function contains(t,e,i){return e>=t.x&&e<t.x+t.width&&i>=t.y&&i<t.y+t.height}function lerp(t,e,i){return t*(i-e)+e}function angleBetween(t,e){return atan2(e.y-t.y,e.x-t.x)}function formatTime(t){t=~~t;for(var e=""+max(0,t%60),i=""+~~max(0,t/60);e.length<2;)e="0"+e;for(;i.length<2;)i="0"+i;return i+":"+e}function linear(t,e,i,s){return t/s*i+e}function swing(t,e,i,s){return i*(.5-Math.cos(t/s*Math.PI)/2)+e}function easeOutBounce(t,e,i,s){return(t/=s)<1/2.75?i*(7.5625*t*t)+e:2/2.75>t?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:2.5/2.75>t?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e}function tween(t,e,i,s,n,r,a){r=r||linear;var h=0,o={update:function(o){h=min(n,h+G.dt),t[e]=r(h,i,s-i,n),h==n&&(a&&a.call(t),G.tweens.splice(o,1))}};G.tweens.push(o)}function drawTextLine(t){for(var e=t.text.length,i=5,s=0;e>s;s++){var n=LETTERS[t.text.charAt(s)];if(n)for(var r=0;i>r;r++)for(var a=0;i>a;a++)1===n[r][a]&&G.ctx.rect(t.x+a*t.scale+(t.scale*i+t.hspacing)*s,t.y+r*t.scale,t.scale,t.scale)}}function drawText(t){merge(t,{vspacing:0,hspacing:2,scale:3});var e=5,i=(""+t.text).toUpperCase().split("\n"),s=i.length,n=e*t.scale,r=0;G.ctx.beginPath();for(var a=0;s>a;a++){var h=i[a],o=n*h.length+(h.length-1)*t.hspacing,l=t.x,c=t.y+(n+t.vspacing)*a;"center"==t.halign?l=t.x-o/2:"right"==t.halign&&(l=t.x-o),"center"==t.valign?c=t.y-n/2:"bottom"==t.valign&&(c=t.y-n),h.length>i[r].length&&(r=a),drawTextLine({text:h,x:~~l,y:~~c,hspacing:t.hspacing,scale:t.scale})}}function particle(t){var e=merge({update:function(t){this.x+=this.vx*G.dt,this.y+=this.vy*G.dt,(this.d-=G.dt)<0&&G.particles.splice(t,1)}},t);return G.particles.push(e),e}function RandomGenerator(t){void 0===t&&(t=Date.now());var e=1664525,i=1013904223,s=Math.pow(2,32),n=t;this.seed=function(t){n=t},this.nextInt=function(){return n=(e*n+i)%s},this.nextFloat=function(){return this.nextInt()/s},this.i=function(t,e){return void 0===t&&(t=0,e=1),void 0===e&&(e=t,t=0),Math.floor(t+this.nextFloat()*(e-t+1))},this.f=function(t,e){return void 0===t&&(t=0,e=1),void 0===e&&(e=t,t=0),t+this.nextFloat()*(e-t)},this.pick=function(t){return t[this.i(t.length-1)]}}function initAI(t){}function ai(t){if(!((t.nextBehaviourCheck-=G.dt)>0||t.behaviours.length)){var e=G.world[t.team.name],i=G.world[t.team.enemy.name],s={condition:function(){var s=G.world.sectors.filter(function(s){var n=shipsAround(s,e,2*SHIP_ATTACK_RADIUS),r=shipsAround(s,i,2*SHIP_ATTACK_RADIUS);return s.team!==t.team&&(n>=r&&4>n||i.length-1<e.length)});return this.target=s.sort(function(e,i){return dist(e,t)-dist(i,t)})[0],!!s.length},behaviour:function(){return new MoveTo(this.target)}},n={condition:function(){return t.underAttack&&shipsAround(t,e,2*SHIP_ATTACK_RADIUS)-rand(2)<shipsAround(t,i,2*SHIP_ATTACK_RADIUS)},behaviour:function(){var e={},i=0;do e.x=t.x+rand(-1,1)*SHIP_EVADE_RADIUS,e.y=t.y+rand(-1,1)*SHIP_EVADE_RADIUS;while(G.world.shipOnLine(t,e,2*SHIP_ATTACK_RADIUS)&&i++<20);return new MoveTo(e)}},r={condition:function(){return!!(this.target=e.filter(function(t){return shipsAround(t,i,SHIP_ATTACK_RADIUS)>pick([2,3])})[0])&&!G.world.shipOnLine(t,this.target)},behaviour:function(){return new MoveTo(this.target)}},a={condition:function(){var e=t.getClosestEnemy();return e&&shipsAround(e,i,2*SHIP_ATTACK_RADIUS)-2<shipsAround(t,i,2*SHIP_ATTACK_RADIUS)},behaviour:function(){return t.target=t.getClosestEnemy(),new MoveTo(t)}},h={condition:function(){return this.base=pick(G.world.sectors.filter(function(s){return s.team===t.team&&shipsAround(s,i,2*SECTOR_CONQUER_RADIUS)>shipsAround(s,e,2*SECTOR_CONQUER_RADIUS)})),!!this.base},behaviour:function(){return new MoveTo(this.base)}},o=[s,n,a,h,r],l=pick(o.filter(function(t){return rand()<G.world.aiSmart&&t.condition()}));l&&t.addBehaviour(l.behaviour()),t.nextBehaviourCheck=2.5}}function shipsAround(t,e,i){return e.filter(function(e){return dist(t,e)<i}).length}function MoveTo(t){this.target={x:t.x,y:t.y},this.name="MoveTo",this.ship=null,this.pathTimeout=.8,this.oncomplete=null,this.done=function(){return dist(this.ship,this.target)<SHIP_TARGET_SEPARATION},this.render=function(){(this.pathTimeout-=G.dt)<0||(line(this.ship.x,this.ship.y,this.target.x,this.target.y,"hsla(160, 100%, 50%, 0.3)"),circle(this.target.x,this.target.y,3),fill("hsla(160, 100%, 50%, 0.3)"))},this.logic=function(t){return this.done()?(this.ship.behaviours.splice(t,1),void(this.oncomplete&&this.oncomplete(this))):(this.ship.angle=atan2(this.target.y-this.ship.y,this.target.x-this.ship.x),this.ship.vx=cos(this.ship.angle)*this.ship.speed,void(this.ship.vy=sin(this.ship.angle)*this.ship.speed))}}function Ship(t,e,i){this.x=t,this.y=e,this.radius=SHIP_RADIUS,this.angle=0,this.vx=0,this.vy=0,this.speed=150,this.health=1,this.showHealth=0,this.inView=0,this.lastShot=0,this.points=[],this.behaviours=[],this.underAttack=0,this.nextBehaviourCheck=1;for(var s=[1,0,-.4,1,-1,.8,-.5,0,-1,-.8,-.4,-1],n=0;s&&n<s.length;n+=2)this.points.push(vec(s[n]*this.radius,s[n+1]*this.radius));this.halting=function(){return abs(this.vx)<4||abs(this.vy)<4},this.getClosestEnemy=function(){var t=this;return G.world.ships.filter(function(e){return e.team!==t.team&&dist(t,e)<SHIP_ATTACK_RADIUS}).sort(function(e,i){return dist(t,e)-dist(t,i)})[0]},this.getClosestAlly=function(){var t=this;return G.world.ships.filter(function(e){return e.team===t.team}).sort(function(e,i){return dist(t,e)-dist(t,i)})[0]},this.addBehaviour=function(t){for(var e=this.behaviours.length;e--;)this.behaviours[e].name===t.name&&this.behaviours.splice(e,1);t.ship=this,this.behaviours.push(t)},this.shoot=function(t){G.now-this.lastShot>=SHIP_SHOT_INTERVAL&&(bullet(this.x,this.y,this.radius,this.angle,this),this.lastShot=G.now)},this.shootAt=function(t,e){this.angle=angleBetween(this,t),this.shoot(e)},this.moveTo=function(t){this.addBehaviour(new MoveTo(t))},this.update=function(t){if(this.dead())return G.world.ships.splice(t,1),G.world[this.team.name].splice(G.world[this.team.name].indexOf(this),1),void(this.inView&&(G.shaking=.15));if(this.team!==ENEMY||0!==G.world.aiDelay||G.world.gameOver||ai(this),invoke(this.behaviours,"logic"),this.underAttack&&rand()<G.world.aiSmart&&!this.target&&(this.target=this.getClosestEnemy()),this.halting()){var e=!this.target||dist(this,this.target)>SHIP_ATTACK_RADIUS||G.world.shipOnLine(this,this.target);e&&(this.target=this.getClosestEnemy()),this.target&&this.shootAt(this.target)}this.vx*=SHIP_FRICTION,this.vy*=SHIP_FRICTION,this.x+=this.vx*G.dt,this.y+=this.vy*G.dt,this.x=max(this.radius,min(this.x,G.world.width-this.radius)),this.y=max(this.radius,min(this.y,G.world.height-this.radius)),this.inView=circleRect(this,G.camera),this.underAttack-=G.dt},this.render=function(){invoke(this.behaviours,"render"),this.inView&&(G.ctx.save(),G.ctx.translate(~~this.x,~~this.y),rect(-10,13,HEALTH_BAR_WIDTH,HEALTH_BAR_HEIGHT/2),fill("hsl(0, 0%, 10%)"),rect(-10,13+HEALTH_BAR_HEIGHT/2,HEALTH_BAR_WIDTH,HEALTH_BAR_HEIGHT/2),fill("hsl(0, 0%, 30%)"),rect(-10,13,this.health*HEALTH_BAR_WIDTH,HEALTH_BAR_HEIGHT),fill("hsl(100, 100%, 30%)"),rect(-10,13+HEALTH_BAR_HEIGHT/2,this.health*HEALTH_BAR_WIDTH,HEALTH_BAR_HEIGHT/2),fill("hsl(100, 100%, 50%)"),G.ctx.rotate(this.angle),G.ctx.lineWidth=1,path(this.points),fill(this.team.fillColor),stroke(this.team.strokeColor),G.ctx.restore())},this.receiveDamage=function(t){this.health-=t.dmg,this.underAttack=SHIP_UNDER_ATTACK,t.explode()},this.dead=function(){return this.health<=0}}function Sector(t,e,i,s){this.x=t,this.y=e,this.radius=i,this.team=null,this.nextHoming=rand(5,13),this.circles=[],this.playerConquerTime=0,this.enemyConquerTime=0,this.render=function(){var t=G.tick/8+(this.team?this.team.phaseOffset:.2*PI);G.ctx.save(),circle(this.x,this.y,this.radius),fill(this.team?this.team.fillColor:"rgba(200,200,200,0.3)"),stroke(this.team?this.team.strokeColor:"rgb(200,200,200)"),circle(this.x,this.y,this.radius/10+Math.sin(t)*this.radius/15),stroke(),G.ctx.beginPath(),G.ctx.arc(this.x,this.y,this.radius,t,t+PI/4),stroke(0,5);var e=60,i=3;this.playerConquerTime>0&&this.playerConquerTime<SECTOR_CONQUER_TIME&&(rect(this.x-e/2,this.y-6*i,e,i),fill("hsl(0, 0%, 0%)"),rect(this.x-e/2,this.y-6*i,e*(this.playerConquerTime/SECTOR_CONQUER_TIME),i),fill("hsla(140, 100%, 55%, 0.8)")),this.enemyConquerTime>0&&this.enemyConquerTime<SECTOR_CONQUER_TIME&&(rect(this.x-e/2,this.y-4*i,e,i),fill("hsl(0, 0%, 0%)"),rect(this.x-e/2,this.y-4*i,e*(this.enemyConquerTime/SECTOR_CONQUER_TIME),i),fill("hsla(0, 100%, 55%, 0.8)")),G.ctx.globalAlpha=.8;for(var s=0;s<this.circles.length;s++)this.circles[s]<=0||(circle(this.x,this.y,this.circles[s]),stroke(0,.5),this.circles[s]-=3);G.ctx.globalAlpha=1,G.ctx.restore()},this.update=function(t){if((this.nextHoming-=G.dt)<=0){this.circles.length=0;for(var t=4;t--;)this.circles.push(80*t);this.nextHoming=rand(13,25)}var e,i=G.world.getShipsAround(this,SECTOR_CONQUER_RADIUS),s=i.filter(function(t){return t.team===PLAYER&&t.underAttack<=0&&t.halting()}),n=i.filter(function(t){return t.team===ENEMY&&t.underAttack<=0&&t.halting()}),r=this;e=s.length>n.length?PLAYER:s.length<n.length?ENEMY:null;var a=0,h=0;e===PLAYER&&this.team!==PLAYER?(a=1,h=-1,s.forEach(function(t){rand()<rand()&&t.shootAt(r)})):e===ENEMY&&this.team!==ENEMY&&(h=1,a=-1,n.forEach(function(t){rand()<G.world.aiSmart&&t.shootAt(r)}));var o=clamp(.1*abs(s.length-n.length),.1,.4);this.playerConquerTime=clamp(this.playerConquerTime+a*o*G.dt,0,SECTOR_CONQUER_TIME),this.enemyConquerTime=clamp(this.enemyConquerTime+h*o*G.dt,0,SECTOR_CONQUER_TIME);this.playerConquerTime===SECTOR_CONQUER_TIME&&this.team!==PLAYER?(G.world.playerWins++,this.team===ENEMY&&G.world.enemyWins--,this.team=PLAYER,this.nextHoming=0,G.shaking=.2):this.enemyConquerTime===SECTOR_CONQUER_TIME&&this.team!==ENEMY&&(G.world.enemyWins++,this.team===PLAYER&&G.world.playerWins--,this.team=ENEMY,this.nextHoming=0,G.shaking=.2)}}function Bullet(t,e,i,s){this.sx=t,this.sy=e,this.x=t,this.y=e,this.angle=i,this.cos=cos(i),this.sin=sin(i),this.length=10,this.owner=s,this.type=BULLET,merge(this,this.type),this.target=null,this.prev=[vec().copy(this),vec().copy(this),vec().copy(this)],this.update=function(t){if(this.prev[2].copy(this.prev[1]),this.prev[1].copy(this.prev[0]),this.prev[0].copy(this),this.target){var e=Math.atan2(this.target.y-this.y,this.target.x-this.x);if(this.cos=cos(e),this.sin=sin(e),(this.disappear-=G.dt)<=0)return void G.world.bullets.splice(t,1)}this.sx+=this.cos*this.speed*G.dt,this.sy+=this.sin*this.speed*G.dt,this.x=this.sx+this.cos*this.length,this.y=this.sy+this.sin*this.length,contains(G.world,this.sx,this.sy)||G.world.bullets.splice(t,1)},this.render=function(){if(pointInView(this.sx,this.sy))for(var t=0;3>t;t++)circle(this.prev[t].x,this.prev[t].y,3-t),fill(this.owner.team.strokeColor)},this.explode=function(t,e){for(var i=0;5>i;i++){var s=PI2/5*i;particle({x:this.x+10*cos(s),y:this.y+10*sin(s),r:rand(1,2),vx:cos(s)*rand(50,100)*e,vy:sin(s)*rand(50,100)*e,d:rand(.4,.7),render:function(){G.ctx.globalAlpha=this.d,circle(this.x,this.y,this.r),fill(t),G.ctx.globalAlpha=1}})}}}function bullet(t,e,i,s,n,r){i*=1.5;var a=new Bullet(t+cos(s)*i,e+sin(s)*i,s,n,r);return G.world.bullets.push(a),a}function Cursor(){return this.x=this.y=0,this.down=!1,this.mousedown=function(t,e){this.x=t.x+G.camera.x,this.y=t.y+G.camera.y,this.down=!0},this.mousemove=function(t){this.x=t.x+G.camera.x,this.y=t.y+G.camera.y},this.mouseup=function(t){this.x=t.x+G.camera.x,this.y=t.y+G.camera.y,this.down=!1},this.render=function(){},this.sup=getSuper(this)}function SelectionCursor(){var t=Cursor.call(this);this.ships=[],this.posDown=vec(),this.points0=[vec(0,0),vec(-20,-7),vec(-18,0)],this.points1=[vec(0,0),vec(-20,7),vec(-18,0)],this.isCallingGoTo=!1,this.mousedown=function(e,i){if(t.mousedown(e,i),this.posDown.x=this.x,this.posDown.y=this.y,this.isCallingGoTo=i,i){var s=this;this.ships.forEach(function(t,e,i){var n=PI2/i.length*e,r=rand(10,30);t.moveTo({x:s.x-cos(n)*r,y:s.y-sin(n)*r})})}},this.mouseup=function(e){if(t.mouseup(e),!this.isCallingGoTo){var i={x:min(this.posDown.x,this.x),y:min(this.posDown.y,this.y)};i.width=max(this.posDown.x,this.x)-i.x,i.height=max(this.posDown.y,this.y)-i.y,this.ships=G.world.player.filter(function(t){return circleRect(t,i)})}},this.render=function(){(0!=this.x||0!=this.y)&&(G.ctx.save(),G.ctx.translate(this.x,this.y),G.ctx.rotate(-PI/2-PI/6),path(this.points0),fill("hsl(100, 100%, 60%)"),path(this.points1),fill("hsl(100, 80%, 71%)"),G.ctx.restore(),this.down&&!this.isCallingGoTo&&G.scene===PlayScene&&(rect(this.posDown.x,this.posDown.y,this.x-this.posDown.x,this.y-this.posDown.y),fill("hsla(100, 100%, 860%, 0.1)"),stroke("hsl(100, 100%, 60%)",.5)))}}function AttackCursor(){var t=Cursor.call(this);this.mouseup=function(e){t.mouseup(e);var i=this,s=G.world.enemies.filter(function(t){return dist(t,i)<t.radius})[0];if(s){var n=G.world.player.filter(function(t){return dist(s,t)<2*SHIP_ATTACK_RADIUS});n.forEach(function(t){t.shootAt(s)})}},this.render=function(){G.ctx.save(),G.ctx.translate(this.x,this.y),circle(0,0,7),fill("hsla(0, 100%, 60%, 0.5)"),circle(0,0,3),stroke("hsla(0, 100%, 60%)"),G.ctx.beginPath(),G.ctx.rect(-1,-20,2,13),G.ctx.rect(7,-1,13,2),G.ctx.rect(-1,7,2,13),G.ctx.rect(-20,-1,13,2),fill("hsl(0, 100%, 60%)");var t=G.tick/10;G.ctx.beginPath(),G.ctx.arc(0,0,10,t,t+PI/4),stroke("hsl(0, 100%, 80%)",1),G.ctx.beginPath(),G.ctx.arc(0,0,10,t+PI,t+PI+PI/4),stroke("hsl(0, 100%, 80%)",1),G.ctx.beginPath(),G.ctx.arc(0,0,10,t+PI/2,t+PI/2+PI/4),stroke("hsl(0, 100%, 80%)",1),G.ctx.beginPath(),G.ctx.arc(0,0,10,t+PI/2+PI,t+PI/2+PI+PI/4),stroke("hsl(0, 100%, 80%)",1),G.ctx.restore()}}function cache(t,e,i){var s=document.createElement("canvas");return s.width=t,s.height=e,i(s.getContext("2d"),t,e)||s}function World(){this.x=this.y=0,this.width=W,this.height=H,this.sectors=[],this.ships=[],this.player=[],this.enemies=[],this.bullets=[],this.particles=[],this.accumPlayerWins=0,this.aiDelay=4,this.playingTime=0,this.init=function(){G.level++,this.sectors.length=0,this.ships.length=0,this.player.length=0,this.enemies.length=0,this.bullets.length=0,this.particles.length=0,this.aiSmart=.2+(1-Math.exp(-(G.level-.8)/12)),this.playerWins=2,this.enemyWins=2,this.gameOver=!1,this.gameWon=!1,this.reload=0;var t=min(13,G.rnd.i(G.level+3,G.level+6)),e=4/3;for(this.width=max(1700,2.5*t*SECTOR_RADIUS*2),this.height=this.width/e,this.winSize=1/(t+4),G.initBackground();t--;){var i=new Sector(0,0,SECTOR_RADIUS*rand(.8,1));do i.x=rand(SECTOR_RADIUS,this.width-SECTOR_RADIUS),i.y=rand(.3*this.height,.8*this.height);while(this.sectors.filter(function(t){return dist(t,i)<3.5*SECTOR_CONQUER_RADIUS}).length);this.sectors.push(i)}var s=this.width/2-3*SECTOR_RADIUS;this.spawnShipsAround(s,2*SECTOR_RADIUS,SECTOR_RADIUS+5,6,PLAYER,!0),this.spawnShipsAround(s+6*SECTOR_RADIUS,2*SECTOR_RADIUS,SECTOR_RADIUS+10,6,PLAYER,!0),this.spawnShipsAround(s,this.height-2*SECTOR_RADIUS,SECTOR_RADIUS+5,6,ENEMY,!0),this.spawnShipsAround(s+6*SECTOR_RADIUS,this.height-2*SECTOR_RADIUS,SECTOR_RADIUS+10,6,ENEMY,!0),tween(G.camera,"x",0,this.width/2-W/2,2.5,swing),tween(G.camera,"y",G.camera.y,0,2.5,swing)},this.spawnShipsAround=function(t,e,i,s,n,r){for(var a=0;s>a;a++){var h=a*PI2/s,o=this.spawnShip(t+cos(h)*i,e+sin(h)*i,n);o.angle=h}if(r){var l=new Sector(t,e,i-10);l.team=n,this.sectors.push(l)}},this.spawnShip=function(t,e,i){var s=new Ship(t,e);return s.team=i,this[i.name].push(s),this.ships.push(s),s},this.getShipsAround=function(t,e){return e||(e=SHIP_ATTACK_RADIUS),this.ships.filter(function(i){return dist(i,t)<e})},this.shipOnLine=function(t,e,i){i||(i=SHIP_ATTACK_RADIUS);for(var s={},n=max(.1,i/dist(t,e)),r=0;1>=r;r+=n)if(s.x=lerp(r,t.x,e.x),s.y=lerp(r,t.y,e.y),this.getShipsAround(s,i).length)return!0;return!1},this.update=function(){invoke(this.ships,"update"),invoke(this.bullets,"update"),invoke(this.sectors,"update"),invoke(this.particles,"update");for(var t=0;t<this.ships.length;t++)for(var e=this.ships[t],i=t+1;i<this.ships.length;i++){var s=this.ships[i],n=s.x-e.x,r=s.y-e.y,a=Math.sqrt(n*n+r*r),h=s.radius+e.radius;if(h>a){var o=n/a,l=r/a,c=(h-a)/2;e.x-=c*o,e.y-=c*l,s.x+=c*o,s.y+=c*l;var u=.2,d=(s.vx-e.vx)*o+(s.vy-e.vy)*l,x=-(1+u)*d;x/=2,e.vx-=x*o,e.vy-=x*l,s.vx+=x*o,s.vy+=x*l}}for(var i=0;i<this.bullets.length;i++)for(var s=this.bullets[i],t=0;t<this.ships.length;t++){var f=this.ships[t];if(f.team!==s.owner.team&&dist(s,f)<f.radius){f.receiveDamage(s),s.explode(f.team.strokeColor,1),f.inView&&(G.shaking=.1),this.bullets.splice(i--,1);break}}for(var i=0;i<this.bullets.length;i++)for(var s=this.bullets[i],t=0;t<this.sectors.length;t++){var p=this.sectors[t];if(s.team!==p.team&&dist(s,p)<.5*p.radius){s.explode(p.team?p.team.strokeColor:"white",.5),this.bullets.splice(i--,1);break}}G.keys[37]?G.camera.x-=CAMERA_SPEED*G.dt:G.keys[39]?G.camera.x+=CAMERA_SPEED*G.dt:G.keys[38]?G.camera.y-=CAMERA_SPEED*G.dt:G.keys[40]&&(G.camera.y+=CAMERA_SPEED*G.dt),G.camera.x=max(0,min(G.camera.x,this.width-W)),G.camera.y=max(0,min(G.camera.y,this.height-H)),this.playerWins=max(0,this.playerWins),this.enemyWins=max(0,this.enemyWins),!this.gameOver&&(this.playingTime+=G.dt),this.aiDelay=max(0,this.aiDelay-G.dt),this.gameOver||(0===this.player.length?this.endGame(!1):this.enemyWins===this.sectors.length?this.endGame(!1):this.playerWins===this.sectors.length&&this.endGame(!0))},this.renderStats=function(){G.ctx.save(),G.ctx.translate(W/2,0);var t=100,e=8,i=1.4*t;G.ctx.save(),pathA([-60-t,0,-60,0,-45,e,-60-1.2*t,e]),stroke(PLAYER.strokeColor),G.ctx.clip();var s=min(1,this.playerWins*this.winSize);rect(-45-i*s,0,i,e),fill("hsl(65, 100%, 50%)"),rect(-45-i*s,e/2,i,e/2),fill("hsl(65, 100%, 20%)"),G.ctx.restore(),G.ctx.save(),pathA([60+t,0,60,0,45,e,60+1.2*t,e]),stroke(ENEMY.strokeColor),G.ctx.clip();var s=min(1,this.enemyWins*this.winSize);rect(45,0,i*s,e),fill("hsl(65, 100%, 50%)"),rect(45,e/2,i*s,e/2),fill("hsl(65, 100%, 20%)"),G.ctx.restore(),G.ctx.save(),pathA([-60-t,e,-45,e,-30,2*e,-60-1.2*t,2*e]),stroke(PLAYER.strokeColor),G.ctx.clip();var s=this.player.length/12;rect(-30-i*s,e,i,e),fill("hsl(140, 100%, 50%)"),rect(-30-i*s,e+e/2,i,e/2),fill("hsl(140, 100%, 20%)"),G.ctx.restore(),G.ctx.save(),pathA([60+t,e,45,e,30,2*e,60+1.2*t,2*e]),stroke(ENEMY.strokeColor),G.ctx.clip(),s=this.enemies.length/12,rect(30,e,i*s,e),fill("hsl(0, 100%, 50%)"),rect(30,e+e/2,i*s,e/2),fill("hsl(0, 100%, 20%)"),G.ctx.restore(),pathA([-60,0,60,0,30,30,-30,30]),fill("hsla(0, 0%, 50%, 1)"),pathA([-45,15,45,15,30,30,-30,30]),fill("hsla(0, 0%, 15%, 1)"),drawText({text:formatTime(this.playingTime),x:0,y:13,scale:2,halign:"center",valign:"center"}),fill("hsl(0, 50%, 100%)"),G.ctx.restore()},this.renderHud=function(){G.ctx.save(),G.ctx.translate(G.camera.x-G.shake.x,G.camera.y-G.shake.y),this.renderStats(),drawText({x:W/2}),G.ctx.restore()},this.render=function(){G.ctx.save(),drawText({x:G.camera.x+W/2,y:G.camera.y+H/2,text:G.level,halign:"center",valign:"center",scale:25}),fill("rgba(30, 30, 30, 0.3)"),invoke(this.bullets,"render"),invoke(this.sectors,"render"),invoke(this.particles,"render"),invoke(this.ships,"render"),this.renderHud();var t=150,e=3*t/4,i=20,s=H-e-i;G.ctx.save(),G.ctx.translate(G.camera.x+i,G.camera.y+s),rect(0,0,t,e),fill("rgba(0, 0, 0, 0.3)"),stroke("rgb(30, 30, 30)",1),rect(~~(G.camera.x/this.width*t),~~(G.camera.y/this.height*e),~~(W/this.width*t),~~(H/this.height*e)),fill("rgb(20,20,20)"),G.world.sectors.forEach(function(i){var s=i.x/G.world.width*t,n=i.y/G.world.height*e;circle(~~s,~~n,min(i.radius/G.world.width*t,i.radius/G.world.height*e)),fill(i.team?i.team.fillColor:"rgb(150, 150, 150)")}),G.world.ships.forEach(function(i){var s=i.x/G.world.width*t,n=i.y/G.world.height*e;rect(~~s,~~n,1,1),fill(i.team.strokeColor)}),G.ctx.restore(),this.reload>0&&(G.ctx.translate(G.camera.x,G.camera.y),G.world.reload-=G.dt,rect(0,H/3,W,H/3),fill("rgb(80,80,80)"),this.gameWon?(drawText({x:W/2,y:H/2.8,text:"Round Won",hspacing:3,scale:5,halign:"center"}),fill("rgb(10,250,20)"),this.reload<6&&(drawText({x:W/2,y:H/2.2,text:"You secured all sectors. Get ready for round "+(G.level+1),hspacing:3,vspacing:3,scale:3,halign:"center"}),fill("rgb(1,1,1)")),this.reload<0&&G.world.init()):(drawText({x:W/2,y:H/2.8,text:"Game Over",hspacing:3,scale:5,halign:"center"}),fill("rgb(220,0,20)"),this.reload<6&&(drawText({x:W/2,y:H/2.2,text:"You survived "+G.level+" rounds and secured "+this.accumPlayerWins+" sectors\nin "+formatTime(this.playingTime)+" minutes",hspacing:3,vspacing:3,scale:3,halign:"center"}),fill("rgb(1,1,1)"),drawText({x:W/2,y:H/2+40,text:"Best stat: "+G.getData("won")+" sectors",hspacing:1,scale:2,halign:"center"}),fill("rgb(20,130,10)")),this.reload<0&&window.location.reload())),G.ctx.restore()},this.endGame=function(t){this.gameOver=!0,this.gameWon=t,this.accumPlayerWins+=this.playerWins,G.saveData("won",max(G.getData("won"),this.accumPlayerWins)),G.world.reload=7,tween(G,"flashAlpha",.7,0,1,swing)}}function Game(){G=this,G.init=function(){G.el=document.getElementById("game"),G.wrap=document.getElementById("wrap"),G.f=document.getElementById("f"),G.ctx=G.el.getContext("2d"),G.fullScreen=!1,G.el.width=W,G.el.height=H,G.shake=vec(),G.shaking=!1,G.camera=vec(),G.camera.width=W,G.camera.height=H,G.scale=vec(1,1),G.mouse=vec(),G.cursor=G.selectionCursor=new SelectionCursor,G.atkCursor=new AttackCursor,G.keys=[],G.particles=[],G.tweens=[],G.flashAlpha=0,G.bgAlpha=1,G.rnd=new RandomGenerator;var t=localStorage&&localStorage.bs;G.data=t?JSON.parse(t):{won:0},G.scene,G.level=0,G.world=new World(G),G.paused=!1,G.dt=1/FPS,G.accum=0,G.elapsed=0,G.now,G.lt,G.tick=0,G.wrap.style.opacity=1,G.bindEvents(),G.resize(),G.initBackground()},G.getData=function(t){return G.data[t]},G.saveData=function(t,e){G.data[t]=e,localStorage&&(localStorage.bs=JSON.stringify(G.data))},G.bindEvents=function(){function t(t,e,i){t.attachEvent?t.attachEvent("on"+e,i):t.addEventListener(e,i,!1)}function e(t){var e=G.el.getBoundingClientRect();G.mouse.x=(t.pageX-e.left)*G.scale.x,G.mouse.y=(t.pageY-e.top)*G.scale.y}t(window,"contextmenu",function(t){t.preventDefault()}),t(document,"drag",function(t){t.preventDefault()}),t(window,"blur",function(){G.paused=1}),t(window,"focus",function(){G.paused=0}),t(G.f,"click",G.toggleFullScreen),t(G.el,"mousedown",function(t){e(t),G.cursor.mousedown(G.mouse,3==t.which),t.preventDefault()}),t(G.el,"mouseup",function(t){e(t),G.cursor.mouseup(G.mouse),t.preventDefault()}),t(G.wrap,"mousemove",function(t){e(t),G.cursor.mousemove(G.mouse),t.preventDefault()}),t(document,"keydown",function(t){var e=t.keyCode;G.keys[e]=!0}),t(document,"keyup",function(t){var e=t.keyCode;G.keys[e]=!1})},G.resize=function(){var t,e,i=W/H;window.innerWidth/window.innerHeight>i?(e=.9*window.innerHeight,t=e*i):(t=.9*window.innerWidth,e=t/i),t=~~t,e=~~e;var s=~~(t/W*12);G.wrap.style.width=t+"px",G.wrap.style.height=e+"px",G.wrap.style.marginLeft=Math.floor((window.innerWidth-t)/2-s)+"px",G.wrap.style.marginTop=Math.floor((window.innerHeight-e)/2-s)+"px",G.wrap.style.border=s+"px solid rgb(10,10,10)",G.scale.x=W/t,G.scale.y=H/e},G.toggleFullScreen=function(t){document.fullscreenEnabled?G.fullScreen?document.exitFullscreen():document.body.requestFullscreen():document.webkitFullscreenEnabled?G.fullScreen?document.webkitExitFullscreen():document.body.webkitRequestFullscreen():document.mozFullScreenEnabled&&(G.fullscreen?document.mozCancelFullScreen():document.body.mozRequestFullScreen()),G.fullScreen=!G.fullScreen,G.resize(),t.preventDefault()},G.initBackground=function(){G.hexGrid=cache(G.world.width,G.world.height,function(t,e,i){function s(e,i,s){t.beginPath(),t.moveTo(e+l/2,i),t.lineTo(e+l,i+r/2),t.lineTo(e+l,i+3*r/2),t.lineTo(e+l/2,i+o),t.lineTo(e,i+1.5*r),t.lineTo(e,i+r/2),t.closePath(),s?t.fill():t.stroke()}var n=30*Math.PI/180,r=20,a=Math.cos(n)*r,h=Math.sin(n)*r,o=2*r,l=2*a,c=ceil(i/(h+r)),u=ceil(e/l),d=5;c-=floor(d*c/(h+r))-2,u-=floor(d*u/l)-2,t.strokeStyle="rgb(20,20,20)",t.translate(-l,-o);for(var G=0;c>G;G++)for(var x=0;u>x;x++)rand()<.55&&s(x*(l+d)+G%2*l/2,G*(h+r+d),!1)}),G.astralBodies=cache(G.world.width,G.world.height,function(t,e,i){for(var s=~~(.25*e);s--;)t.beginPath(),t.arc(rand(e),rand(i),rand(.1,.3),0,PI2),t.fillStyle="rgba(255,255,255,"+rand(.3,.6)+")",t.fill();for(s=~~(.25*e);s--;)t.beginPath(),t.arc(rand(e),rand(i),rand(.3,.6),0,PI2),t.fillStyle="rgba(255,255,255,"+rand(.5,.8)+")",t.fill();for(s=~~(.1*i);s--;)t.beginPath(),t.arc(rand(e),rand(i),rand(.8,1.2),0,PI2),t.fillStyle="rgba(255,255,255,"+rand(.5,.8)+")",t.fill()})},G.updateCursor=function(){G.keys[70]&&(G.cursor!=G.atkCursor?G.cursor=G.atkCursor:G.cursor==G.atkCursor&&(G.cursor=G.selectionCursor),G.keys[70]=!1),G.cursor.mousemove(G.mouse)};var t,e;G.logic=function(){G.paused||G.scene.update(),G.updateCursor(),(t!==window.innerWidth||e!==window.innerHeight)&&(t=window.innerWidth,e=window.innerHeight,G.resize()),(G.shaking-=G.dt)>0?(G.shake.x=rand(-4,4),G.shake.y=rand(-4,4)):G.shake.x=G.shake.y=0,invoke(G.tweens,"update"),invoke(G.particles,"update")},G.render=function(){G.ctx.clearRect(0,0,W,H),G.ctx.save(),G.ctx.translate(-G.camera.x+G.shake.x,-G.camera.y+G.shake.y),G.ctx.globalAlpha=G.bgAlpha,G.ctx.drawImage(G.hexGrid,G.camera.x+G.shake.x,G.camera.y+G.shake.y,W,H,G.camera.x-G.shake.x,G.camera.y-G.shake.y,W,H),G.ctx.drawImage(G.astralBodies,G.camera.x+G.shake.x,G.camera.y+G.shake.y,W,H,G.camera.x-G.shake.x,G.camera.y-G.shake.y,W,H),G.ctx.globalAlpha=1,G.scene.render(),invoke(G.particles,"render"),G.cursor.render(),G.flashAlpha&&(rect(G.camera.x,G.camera.y,W,H),fill("rgba(255, 255, 255, "+G.flashAlpha+")")),G.ctx.restore()},G.loop=function(){G.now=Date.now(),G.dt=G.lt?Math.min(1,(G.now-G.lt)/1e3):0,G.lt=G.now,G.logic(),G.tick++,G.render(),requestAnimationFrame(G.loop)},G.playScene=function(t){G.scene=t,G.scene.init()},G.init()}var W=920,H=640,FPS=60,CAMERA_SPEED=420,CAMERA_LERP=.05,PI=Math.PI,PI2=2*Math.PI,MAX_TRAIL_LENGTH=5,SHIP_FRICTION=.9,SHIP_RADIUS=8,SHIP_SHOT_INTERVAL=500,SHIP_ATTACK_RADIUS=100,SHIP_TARGET_SEPARATION=50,SHIP_EVADE_RADIUS=300,SHIP_UNDER_ATTACK=3,SECTOR_RADIUS=50,SECTOR_BAR_WIDTH=150,SECTOR_BAR_HEIGHT=5,SECTOR_BAR_OFFSET=5,SECTOR_CONQUER_RADIUS=1.7*SECTOR_RADIUS,SECTOR_CONQUER_TIME=3,HEALTH_BAR_HEIGHT=3,HEALTH_BAR_WIDTH=20,ENEMY={name:"enemies",strokeColor:"hsl(0, 100%, 50%)",fillColor:"hsla(0, 100%, 50%, 0.2)",phaseOffset:PI},PLAYER={name:"player",strokeColor:"hsl(140, 100%, 50%)",fillColor:"hsla(140, 100%, 50%, 0.2)",phaseOffset:PI/4},BULLET={speed:150,disappear:2,dmg:.15,color:"hsl(0, 90%, 60%)"};PLAYER.enemy=ENEMY,ENEMY.enemy=PLAYER;var LETTERS={0:[[,1,1,1],[1,,,,1],[1,,,,1],[1,,,,1],[,1,1,1]],1:[[,,1,,],[,1,1,,],[,,1,,],[,,1,,],[1,1,1,1,1]],2:[[1,1,1,1],[,,,,1],[,1,1,1],[1,,,,],[1,1,1,1,1]],3:[[1,1,1,1],[,,,,1],[,1,1,1,1],[,,,,1],[1,1,1,1]],4:[[1,,,1],[1,,,1],[1,1,1,1,1],[,,,1],[,,,1]],5:[[1,1,1,1,1],[1,,,,],[1,1,1,1],[,,,,1],[1,1,1,1]],6:[[,1,1,1],[1,,,,],[1,1,1,1],[1,,,,1],[,1,1,1]],7:[[1,1,1,1,1],[,,,,1],[,,,1],[,,1,,],[,,1,,]],8:[[,1,1,1],[1,,,,1],[,1,1,1],[1,,,,1],[,1,1,1]],9:[[,1,1,1],[1,,,,1],[,1,1,1,1],[,,,,1],[,1,1,1]],"":[[,1,1,1],[1,,,,1],[1,,,,1],[1,,,,1],[,1,1,1]],A:[[1,1,1,1,1],[1,,,,1],[1,1,1,1,1],[1,,,,1],[1,,,,1]],B:[[1,1,1,1],[1,,,1],[1,1,1,1,1],[1,,,,1],[1,1,1,1,1]],C:[[1,1,1,1,1],[1,,,,],[1,,,,],[1,,,,],[1,1,1,1,1]],D:[[1,1,1,,],[1,,,1],[1,,,,1],[1,,,,1],[1,1,1,1,1]],E:[[1,1,1,1,1],[1,,,,],[1,1,1,,],[1,,,,],[1,1,1,1,1]],F:[[1,1,1,1,1],[1,,,,],[1,1,1,,],[1,,,,],[1,,,,]],G:[[1,1,1,1,1],[1,,,,],[1,,1,1,1],[1,,,,1],[1,1,1,1,1]],H:[[1,,,,1],[1,,,,1],[1,1,1,1,1],[1,,,,1],[1,,,,1]],I:[[1,1,1,1,1],[,,1,,],[,,1,,],[,,1,,],[1,1,1,1,1]],L:[[1,,,,],[1,,,,],[1,,,,],[1,,,,],[1,1,1,1,1]],M:[[1,,,,1],[1,1,,1,1],[1,,1,,1],[1,,,,1],[1,,,,1]],N:[[1,,,,1],[1,1,,,1],[1,,1,,1],[1,,,1,1],[1,,,,1]],O:[[1,1,1,1,1],[1,,,,1],[1,,,,1],[1,,,,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,,,,1],[1,1,1,1,1],[1,,,,],[1,,,,]],R:[[1,1,1,1,1],[1,,,,1],[1,1,1,1,1],[1,,,1],[1,,,,1]],S:[[1,1,1,1,1],[1,,,,],[1,1,1,1,1],[,,,,1],[1,1,1,1,1]],T:[[1,1,1,1,1],[,,1,,],[,,1,,],[,,1,,],[,,1,,]],U:[[1,,,,1],[1,,,,1],[1,,,,1],[1,,,,1],[1,1,1,1,1]],V:[[1,,,,1],[1,,,,1],[1,,,,1],[,1,,1],[,,1,,]],W:[[1,,,,1],[1,,,,1],[1,,1,,1],[1,1,,1,1],[1,,,,1]],Y:[[1,,,,1],[1,,,,1],[1,1,1,1,1],[,,1,,],[,,1,,]],":":[[,,,,],[,,1,,],[,,,,],[,,1,,],[,,,,]],"'":[[,,1,,],[,,1,,],[,,,,],[,,,,],[,,,,]],".":[[,,,,],[,,,,],[,,,,],[,,,,],[,,1,,]]},floor=Math.floor,ceil=Math.ceil,min=Math.min,max=Math.max,round=Math.round,pow=Math.pow,cos=Math.cos,sin=Math.sin,atan2=Math.atan2,abs=Math.abs,MenuScene={init:function(){G.bgAlpha=.3,this.titleY=.7*H,this.translateY=H,this.title={x0:0,x1:W};var t=this;tween(this.title,"x0",0,W/2,1.6,easeOutBounce,function(){tween(G,"bgAlpha",.2,1,2,swing),tween(t,"titleY",.7*H,H/4,1,swing),tween(t,"translateY",H,0,1,swing)}),tween(this.title,"x1",W,W/2,1.6,easeOutBounce),this.playerSector=new Sector(W/8,.55*H,SECTOR_RADIUS),this.playerSector.team=PLAYER,this.enemySector=new Sector(3.5*W/4-50,.52*H,SECTOR_RADIUS),this.enemySector.team=ENEMY,this.target=new Sector(W/2,.55*H,SECTOR_RADIUS),this.sectors=[this.playerSector,this.enemySector,this.target],this.cursor=new SelectionCursor,this.cursor.x=.9*W,this.cursor.y=.85*H},render:function(){G.ctx.save(),drawText({x:this.title.x0-2,y:this.titleY,text:"Battle",scale:8,halign:"right",valign:"center",hspacing:4}),fill("hsl(140, 100%, 60%)"),drawText({x:this.title.x1+2,y:this.titleY,text:"surge",scale:8,valign:"center",hspacing:4}),fill("hsl(0, 100%, 100%)"),G.ctx.translate(0,this.translateY),drawText({x:this.playerSector.x,y:this.playerSector.y-80,text:"Your secured sector",scale:1.8,halign:"center",valign:"bottom",hspacing:2}),fill("hsl(0, 100%, 100%)"),drawText({x:this.enemySector.x,y:this.enemySector.y-80,text:"Enemy's secured sector",scale:1.8,halign:"center",valign:"bottom",hspacing:2}),fill("hsl(0, 100%, 100%)"),drawText({x:this.target.x,y:this.target.y-80,text:"The target",scale:1.8,halign:"center",valign:"bottom",hspacing:2}),fill("hsl(0, 100%, 100%)"),invoke(this.sectors,"render"),drawText({x:W/2,y:H-30,text:"Goal: Secure all sectors to win.",scale:2,halign:"center",valign:"bottom",hspacing:2}),fill("hsl(0, 100%, 100%)");var t=15;G.ctx.globalAlpha=1+Math.sin(.4*G.tick),circle(this.cursor.x,this.cursor.y,t-0*Math.sin(.4*G.tick)),stroke("hsl(0, 100%, 80%)"),G.ctx.globalAlpha=1,this.cursor.render(),G.ctx.restore()},update:function(){1===G.bgAlpha&&G.cursor.down&&dist(this.cursor,G.mouse)<15&&(tween(G,"flashAlpha",1,0,2.5,swing),G.playScene(PlayScene));
}},PlayScene={init:function(){G.world.init()},update:function(){G.world.update()},render:function(){G.world.render()}};window.onload=function(){G=new Game,G.playScene(MenuScene),G.loop()};