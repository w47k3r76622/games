<body>
<p id="p">Press any key to play</p>
<script>addEventListener('keydown',e=>document.querySelector('p').remove(),{once:true});let e=(t,o=4,n=10,r=0,i=[],l=[])=>{let s=t,c=o,a=n,h=r,u=i,d=l,p=e=>{var t=[],o=s.x+s.width/2,n=s.y+s.height/2,r=e.y<n,i=e.x<o,l=e.x+e.width>o,c=e.y+e.height>n;return r&&l&&t.push(0),i&&r&&t.push(1),i&&c&&t.push(2),l&&c&&t.push(3),t},f=t=>{var o=s.width/2,n=s.height/2,r=s.x,i=s.y;const l=(t,r)=>e({x:t,y:r,width:o,height:n});d[0]=l(r+o,i),d[1]=l(r,i),d[2]=l(r,i+n),d[3]=l(r+o,i+o)};return{insert:e=>{var t,o=0;if(d.length){for(t=p(e),o=0;o<t.length;o++)d[t[o]].insert(e);return e}if(u.push(e),u.length>c&&h<a){for(d.length||f(),o=0;o<u.length;o++){t=p(u[o]);for(var n=0;n<t.length;n++)d[t[n]].insert(u[o])}u=[]}return e},retrieve:e=>{var t=p(e),o=u;if(d.length)for(var n=0;n<t.length;n++)o=o.concat(d[t[n]].retrieve(e));return o=o.filter(function(e,t){return o.indexOf(e)>=t})},getIndex:p,split:f,clear:e=>{u=[];for(let e=0;e<d.length;e++)d.length&&d[e].clear();d=[]}}},t=(e,o)=>{if(isNaN(e))return 1;let n=((e=!0)=>[1,16/15,9/8,1.2,5/4,4/3,e?45/32:25/18])(),r=n.length-1;return o<=r?e*n[o]:(o-=r,t(t(e,r),o))};var o=new AudioContext;function n(e,t=[]){this.ac=o,this.createFxNodes(),this.fx=[],this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=t}n.prototype.createFxNodes=function(){let e=this.gain=this.ac.createGain();return this.lp=this.ac.createBiquadFilter(),this.lp.type="lowpass",this.lp.frequency.value=22e3,e.connect(e=this.lp),this.hp=this.ac.createBiquadFilter(),this.hp.type="highpass",this.hp.frequency.value=80,e.connect(e=this.hp),e.connect(this.ac.destination),this},n.prototype.createOscillator=function(){if(this.stop(),this.o=this.ac.createOscillator(),this.o.type=this.shape,this.gain.value=.2,"kick"==this.role){var e=this.ac.createWaveShaper();return e.curve=function(e=50){for(var t,o=44100,n=new Float32Array(o),r=Math.PI/180,i=0;i<o;++i)t=2*i/o-1,n[i]=(3+e)*t*20*r/(Math.PI+e*Math.abs(t));return n}(100),e.oversample="2x",this.o.connect(e),e.connect(o.destination),this}return this.o.connect(this.gain),this.o.connect(o.destination),this},n.prototype.scheduleNote=function(e,t){var o=60/this.tempo*this.notes[e][1],n=o*(1-(this.staccato||0));return this.setFrequency(this.notes[e][0],t),this.smoothing&&this.notes[e][0]&&this.slide(e,t,n),"kick"==this.role?this.o.frequency.exponentialRampToValueAtTime(1,t+n):this.setFrequency(0,t+n),t+o},n.prototype.getNextNote=function(e){return this.notes[e<this.notes.length-1?e+1:0]},n.prototype.getSlideStartDelay=function(e){return e-Math.min(e,60/this.tempo*this.smoothing)},n.prototype.slide=function(e,t,o){var n=this.getNextNote(e),r=this.getSlideStartDelay(o);return this.setFrequency(this.notes[e][0],t+r),this.rampFrequency(n[0],t+o),this},n.prototype.setFrequency=function(e,t){return this.o instanceof OscillatorNode&&this.o.frequency.setValueAtTime(e,t),this},n.prototype.rampFrequency=function(e,t){return this.o.frequency.linearRampToValueAtTime(e,t),this},n.prototype.play=function(e){return e="number"==typeof e?e:this.ac.currentTime,this.createOscillator(),this.o.start(e+1),this.notes.forEach(function(t,o){e=this.scheduleNote(o,e)}.bind(this)),this.o.stop(e),this},n.prototype.stop=function(){return this.o instanceof OscillatorNode&&(this.o.stop(0),this.o.frequency.cancelScheduledValues(0),this.o=null),this};var r=(e,o=(e=>1),n=[])=>n.map((n,r)=>[isNaN(n)?0:t(e,n),o(r)]),i=(e,t,o)=>{var r=new n(t,o);return r.staccato=.55,r.gain.gain.value=1,r.type="sawtooth",r.hp.frequency.value=1200,r.role="lead",function(){return r.play(e),r}},l=(e,t,o)=>{const r=new n(t,o);return r.staccato=.55,r.gain.gain.value=1,r.type="triangle",function(){return r.play(e),r}},s=(e,t,o)=>{var r=new n(t,o);return r.gain.gain.value=.9,r.role="kick",r.shape="sine",r.lp.frequency.value=240,r.hp.frequency.value=32,function(){return r.play(e),r}},c=e=>60/e;const{abs:a,sin:h,cos:u,pow:d,sqrt:p,floor:f,ceil:y,random:m,PI:v,max:g,min:k}=Math;var x,w;!function(e){e[e.kick=0]="kick",e[e.tenor=1]="tenor",e[e.alto=2]="alto",e[e.hat=3]="hat"}(x||(x={})),function(e){e[e.B=0]="B",e[e.C=1]="C",e[e.A=2]="A"}(w||(w={}));const b={[w.C]:{rgb:[255,0,0]},[w.B]:{rgb:[0,0,255]},[w.A]:{rgb:[0,255,0]}},q={[x.kick]:{colorMod:(e,t)=>t%2?255:0,text:"K",rgb:[255,50,0]},[x.tenor]:{colorMod:(e,t)=>t%2?255:0,text:"T",rgb:[255,250,0]},[x.alto]:{colorMod:(e,t)=>255==e?175:e,text:"A",rgb:[0,250,50]},[x.hat]:{colorMod:(e,t)=>255,text:"H",rgb:[0,250,255]}},j={[w.A]:{tonic:88,bpm:70,voices:{[x.kick]:[7,1,12,5],[x.tenor]:[4,7,2,5],[x.alto]:[12,4,0],[x.hat]:[12,4,0,12,7,0,4,7]}},[w.B]:{tonic:108,bpm:90,voices:{[x.kick]:[7,1,12,5],[x.tenor]:[4,0,4],[x.alto]:[0,4,7],[x.hat]:[10,0,0,10,12,11,9,0]}},[w.C]:{tonic:128,bpm:140,voices:{[x.kick]:[7,1,12,5],[x.tenor]:[12,4,7],[x.alto]:[7,4,7,0],[x.hat]:[10,0,0,10,12,11,9,0]}}},S=[(e,t)=>B(e,2*t+5),(e,t)=>B(e,51+t),(e,t)=>B(e,91-t),(e,t)=>e/t,(e,t)=>B(e,4)/t,(e,t)=>B(e,3)/(2*(t+1)),(e,t)=>t+100,(e,t)=>e-5*t,(e,t)=>e+3],D=(e,t,o)=>f(S[e%S.length](t,o))%255,I=(e,t={})=>Object.assign({},t,e),O=(e,t)=>e.objectID!=t.objectID&&!(e.x>t.x+t.width||e.x+t.width<t.x||e.y>t.y+t.height||e.y+t.height<t.y),A={drone(e,t){const o=t.reduce((t,o)=>((e,t)=>{const o=Object.assign({},t),n=[[x.kick,x.hat],[x.tenor,x.alto]];let r=0;for(let t of n)t.includes(e)&&(r=t[0]==e?1:2,o[e].volume=o[e].volume-r);return o})(e.room.role,e.ee),t),n=t.map(e=>e.objectID),r=e.dd.filter(e=>!n.includes(e.objectID)),i=e.pu.concat(t.map(e=>H(e)));return I({dd:r,ee:o,pu:i},e)},el(e,t){var o;if(t.length<1)return;if(0==e.level&&1!=t.length)return e;const n={clan:(null===(o=t[0])||void 0===o?void 0:o.clan)||0,role:0==e.level?x.kick:t[0].role};return I({ee:Y(e.ee,n.clan,n.role),room:n,drops:[],level:e.level+1},e)},shot:(e,t)=>e,pickup(e,t){const o=t.map(e=>e.objectID),n=e.pu.filter(e=>!o.includes(e.objectID)),r=Y(e.ee,e.ee[e.room.role].clan||e.room.clan,e.room.role,1);return I({ee:r,pu:n},e)}},N=k(1200,innerWidth),T=k(800,innerHeight),E=k(100,N/6),M={cw:N,ch:T},F=()=>F.prev++;F.prev=0;const B=(e,t=3)=>e*d(10,-t),R=e=>!isNaN(e)&&"number"==typeof e,C=(e,t=((e,t)=>e))=>{if(3!=e.length)return"";const[o,n,r]=e.map(t).map(e=>e.toString());return`rgb(${o},${n},${r})`},P=(e=0,t=1)=>f(m()*(f(t)-y(e)+1))+y(e),W=(e,t=1)=>{let o=e.lastwalk?"x":"y";return Object.assign(Object.assign({},e),{lastwalk:!e.lastwalk,[o]:Math.random()<.5?e[o]+1:e[o]-1})},L=(e,t=7)=>I({x:e.x>0?e.x-=t:0},e),$=(e,t=7)=>I({x:e.x<N-80?e.x+=t:N-80},e),V=(e,t=7)=>I({y:e.y>=0?e.y-=t:80},e),G=(e,t=7)=>I({y:e.y<=T?e.y+=t:T},e),H=(e={})=>I({objectID:F(),name:"pickup"},e),U=(e=3)=>{const t=[],o=N/e,n=(T+E)/2,r=2*N/e/e;for(let e=0;e<3;e++){const i=o+e*r,l=n;t.push(z({x:i,y:l,role:x.kick,clan:w[w[e]]}))}return t},z=(e={})=>I(e,Object.assign(Object.assign({clan:"",x:0,y:0,radius:E,dr:(e,t)=>f(E*a(h(t.objectID+B(e)))),width:0,height:0},e),{name:"el",objectID:F()})),K=(e,t)=>{let o={ArrowRight:$,ArrowLeft:L,ArrowDown:G,ArrowUp:V};return Object.keys(o).includes(t)?o[t](e):e},J=(e,t)=>{let o=t.ss;return _.controls.includes("f")&&(o=o.concat(((e={})=>I(e,{objectID:F(),name:"shot",x:0,y:0,radius:0,dr:(e,t,o)=>{const n=f(N/3),r=(+new Date-t.start)/t.duration;return r>1?0:f(n*r)},start:+new Date,duration:2e3}))({start:+new Date,x:t.pp.x,y:t.pp.y,duration:200})),_.controls=_.controls.filter(e=>"f"!=e)),I({ss:o.filter(e=>1!==f(+new Date/(e.start+e.duration))),pp:_.controls.reduce(K,t.pp)},t)},Q=(e,t)=>{const o=e.dr(t,e);return I({radius:o,width:o/2,height:o/2},e)},X=(e,t)=>(e.insert(t),e),Y=(e,t,o,n=2)=>{if(e[o].clan!=t){const r=j[t];e[o].clan=t,e[o].volume=n,e[o].bpm=r.bpm,e[o].tonic=r.tonic,e[o].melody=r.voices[o]}else e[o].volume+=n;return e},Z=e=>({[x.kick]:e=>.5,[x.tenor]:e=>e%2==1?.85:.05,[x.alto]:e=>.95,[x.hat]:e=>1/(e+1)})[e];function _(){const t={pp:{objectID:F(),name:"pp",width:80,height:80,x:N/2,y:T/5,volume:100,speed:100,luck:100},ee:{[x.kick]:{volume:1},[x.tenor]:{volume:1},[x.alto]:{volume:1},[x.hat]:{volume:1}},dd:[],ss:[],pu:[],drops:U(),room:{clan:null,role:x.kick},level:0},n=(e,t,o)=>{var n;if(1==o.volume)return void(void 0!==o.sequencer&&(o.sequencer.stop(),delete o.sequencer));const a=function(e){return{[x.kick]:s,[x.tenor]:i,[x.alto]:i,[x.hat]:l}[e]||i}(t),h=function(e,t,o=[]){var n=c(t),r=e%(n*o.length);return o.findIndex((e,t)=>r<=(t+1)*n)}(e,o.bpm,o.melody);if(void 0===o.sequencer){const n=r(o.tonic,Z(t),o.melody),i=a(e,o.bpm,n);return o.sequencer=i(),void(o.sequencer.o.onended=(()=>{delete o.sequencer}))}void 0===(null===(n=null==o?void 0:o.sequencer)||void 0===n?void 0:n.o.onended)&&h==o.melody.length-1&&(c(o.bpm),r(o.tonic,Z(t),o.melody),o.sequencer.o.onended=(()=>{delete o.sequencer}))},a=(e,t)=>o=>{t.ss.forEach((t,n)=>{o.strokeStyle=C([(t.x+t.y)%100,t.x%255,t.y%200]),o.arc(t.x,t.y,t.radius,0,2*v),o.lineWidth=e%20,o.stroke()})},h=(e,t,o)=>{const n=(k(300,200)-50)/4;o(e=>{e.font="15px sans-serif",e.lineWidth=10,e.strokeStyle="black",e.fillStyle="rgba(255,255,255,0.3)",e.fillRect(15,15,300,200),e.strokeRect(15,15,300,200)}),Object.values(t.ee).forEach((e,t)=>{let r=y(4*e.volume/10)-1;for(let e=0;e<4;e++)o(o=>{o.lineWidth=2;const i=x[t];o.measureText(i);let l=n+40*t+5,s=70+20*e;0==e&&(o.lineWidth=1,o.strokeStyle="white",o.fillText(i,50,l)),o.arc(100+s,l,10,0,2*v),o.strokeStyle="white",o.stroke(),r>=e&&(o.fillStyle=C(q[t].rgb),o.fill())})})},u=(e,t)=>{const o="!*!";return e=>{e.font="50px monospace";const n=e.measureText(o);t.pp.height=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent,t.pp.width=n.width,e.fillStyle="white",e.strokeStyle="black",e.strokeText(o,t.pp.x,t.pp.y),e.fillText(o,t.pp.x,t.pp.y)}},d=(e,t,o)=>n=>{for(let r=0;r<N/t;r++){let i=r*B(e,o+3)%255;for(let l=0;l<T/t;l++){let s=D(l,B(e),o),c=D(l+o,B(e),o);n.fillStyle=`rgb(${i}, ${s}, ${c})`,n.fillRect(r*t-r,l*t-l,r*t+t,l*t+t)}}},p=(e=4,t=[],o)=>{if(0===e)return t;let n=((e={})=>I({objectID:F(),name:"drone",x:.7*Math.random()*N,y:.7*Math.random()*T,width:40,height:40,lastwalk:!1},e))();return O(n,o)?p(e,t,o):p(e-1,t.concat(n),o)},m=(e,t)=>("function"==typeof m.prev&&removeEventListener("keydown",m.prev),addEventListener("keydown",m.prev=(e=>((e,t,o)=>{if(!0===e.repeat)return;"f"==e.key&&_.controls.includes(e.key)?_.controls=_.controls.filter(t=>t!==e.key):_.controls=_.controls.concat(e.key);const n=t=>{e.key===t.key&&(_.controls=_.controls.filter(t=>t!==e.key),removeEventListener("keyup",n))};addEventListener("keyup",n)})(e))),t),g=e=>Object.keys(e).map(e=>parseInt(e)).filter(R),j=(e,t,r,i)=>{i.clear();let l=J(0,t);var s;if(l=((e,t)=>I({ss:t.ss.map(e=>Q(e,+new Date)),drops:t.drops.map(t=>Q(t,e)),dd:t.dd.map(W)},t))(e,l),i=((e,t,o)=>[t.pp,...t.dd,...t.drops,...t.pu,...t.ss].reduce(X,o))(0,l,i),s=(l=((e,t)=>t.retrieve(e.pp).filter(t=>O(t,e.pp)).reduce((t,o,n,r)=>I(A[o.name](e,r),t),e))(l,i)).ee,Object.values(s).every(e=>e.volume>=6)&&alert("Good job you winner!"),l.ss.length>0&&l.dd.length>0){let e=l.ss.reduce((e,t,o)=>{const n=i.retrieve(t).filter(e=>O(e,t));return e.filter(e=>!n.includes(e))},l.dd),t=l.dd.filter(t=>!e.includes(t)).reduce((e,t,o)=>e.concat(H(t)),l.pu);l=I({dd:e,pu:t},l)}Object.values(l.ee).some(e=>e.volume<1)&&location.reload(),t.level!=l.level?((e,t)=>{Object.entries(e.ee).forEach(([e,o])=>n(t.currentTime,parseInt(e),o))})(l=(e=>{const t=((e,t)=>{const o=g(w).filter(t=>t!=e);return{clan:o[P(0,o.length-1)],role:t%4}})(e.room.clan,e.level),o=p(1+f(1.5*e.level),[],e.pp);return I({dd:o,room:t,pu:[]},e)})(l),o):0==l.dd.length&&0==l.drops.length&&(l=(e=>{const t=z({name:"el",x:N/2,y:T/2,clan:e.room.clan,role:e.room.role});return I({drops:[t]},e)})(l)),m(e,l),((e,t,o)=>{if(o(e=>e.clearRect(0,0,N,T)),0==t.level)return o(d(e+1500,30,t.level)),S(e,t,o),o(a(e,t)),void h(0,t,o);t.drops.length>0?((e,t,o)=>{o(((e,t)=>{const o=[0,0,0];return n=>{((e,t)=>{let o=g(w),n=(T-40)/3;e.fillStyle=C(b[o[0]].rgb),e.fillRect(0,n,20,n+40),e.fillStyle=C(b[o[1]].rgb),e.fillRect(N-0-20,n,N-0+20,n+40)})(n,t.room.clan),t.drops.forEach(({x:t,y:r,width:i,height:l},s)=>{for(let i=0;i<3;i++){o[s]=e/s%255;const l=0+B(e)+v*i/4,c=Math.PI/4+l;n.fillStyle=C(o),n.arc(t,r,30,l,c),n.stroke(),n.fill()}})}})(e,t)),o(u(0,t))})(e,t,o):((e,t,o)=>{o(d(e,30,t.level)),o(((e,t)=>{const o=b[t.room.clan],n=q[t.room.role];return e=>{e.font="50px monospace",t.dd.forEach((t,r)=>{const{x:i,y:l}=t,s=n.text,c=e.measureText(s);t.width=c.width,e.fillStyle=C(o.rgb,n.colorMod),e.fillText(s,f(i+50),f(l+50))})}})(0,t)),o(((e,t)=>e=>{e.font="50px monospace",t.pu.forEach((t,o)=>{const{x:n,y:r}=t;e.fillStyle="white",e.fillRect(n,r,50,50)})})(0,t)),o(a(e,t)),o(u(0,t))})(e,t,o),h(0,t,o)})(e,l,r),requestAnimationFrame(e=>j(e,l,r,i))},S=(e,t,o)=>{g(w),t.drops.forEach((t,n)=>{for(let r=0;r<3;r++)o(o=>{const i=b[n];o.fillStyle=o.strokeStyle=C(i.rgb),o.arc(t.x,B(e)/(r+2)+t.y,t.radius,e+r/v,e+n*v/4+v/4),o.fill(),o.stroke()})}),o(u(0,t)),o(e=>{e.font="25px sans-serif",["Use arrow keys to move","Choose your Bassline","F to fire","Daze the dd to collect essence","Assemble all 4 parts to find your track!"].reduce((t,o)=>(e.fillText(o,50,T-t),t-50),250)})};((t,o,n)=>{const{cw:r,ch:i}=n,l=document.createElement("canvas");l.width=r,l.height=i;let s=l.getContext("2d");document.body.appendChild(l);const c=e({x:0,y:0,width:r,height:i},3,4);o(0,t,e=>{s.beginPath(),s.lineWidth=t.level%4+6,e(s),s.closePath()},c)})(t,j,M)}_.controls=[],addEventListener("keydown",_,{once:!0});</script></body>