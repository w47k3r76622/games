function DistanceFromLevelCenter(a,b){var c={x:getLevelWidth()/2,y:getLevelHeight()/2};return{x:Math.abs(a-c.x),y:Math.abs(c.y-b)}}function drawBackWalls(a){for(i=0;i<a.length;i++)drawBackWall(a[i].x,a[i].y,ctx)}function drawWalls(a){for(i=0;i<a.length;i++)drawWall(a[i].x,a[i].y,ctx)}function Checkbox(a,b,c,d,e){var f=this;f.checkbox_size=20,f.x=a,f.y=b,f.label=c,f.enabled=e,f.draw=function(a){a.lineWidth=2,a.strokeStyle="#ffffff",a.fillStyle="#000000",a.fillRect(f.x-f.checkbox_size/2,f.y-f.checkbox_size/2,f.checkbox_size,f.checkbox_size),a.strokeRect(f.x-f.checkbox_size/2,f.y-f.checkbox_size/2,f.checkbox_size,f.checkbox_size),f.enabled&&(a.beginPath(),a.moveTo(f.x-f.checkbox_size/2,f.y+f.checkbox_size/2),a.lineTo(f.x+f.checkbox_size/2,f.y-f.checkbox_size/2),a.stroke()),a.font="16px Verdana",a.fillStyle="#ffffff",a.fillText(f.label,f.x+f.checkbox_size,f.y)},f.checkForToggle=function(a){console.log("checking for a click");var b=getMousePos(a);b.x>f.x-f.checkbox_size/2&&b.y>f.y-f.checkbox_size/2&&b.x<f.x+f.checkbox_size/2&&b.y<f.y+f.checkbox_size/2&&(f.enabled=!f.enabled,console.log("a thing happened"),null!=d&&d(f.enabled))}}function getMousePos(a){var b=canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}}function checkForToggleClick(a){checkboxToggleFadeEffect.checkForToggle(a),checkboxToggleWaveyEffect.checkForToggle(a)}function updatePlayableCanvas(){var a=levels[currentLevel].map,b=a[0].length*TILE,c=a.length*TILE;console.log("level dimensions = "+b+"x"+c);var d=Math.max(b,c),e=playableCanvasSize/d;console.log("scale = "+e),levelViewTransform.sx=e,levelViewTransform.sy=e,console.log("level dimensions after = "+b*e+"x"+c*e);levelViewTransform.tx=playableCanvasRect().x,levelViewTransform.ty=playableCanvasRect().y+(playableCanvasSize-c*e)/2,console.log(levelViewTransform)}function setLevelWalls(){levelWalls=[];for(var a=levels[currentLevel].map,b=0;b<a.length;b++)for(var c=0;c<a[b].length;c++)1==a[b][c]&&levelWalls.push({x:c,y:b})}function initLevel(a){a!=currentLevel?(currentLevel!=-1&&(player.win(),levels[currentLevel].map=copyMap(resetLevelTo)),resetLevelTo=copyMap(levels[a].map)):(player.lose(),levels[a].map=copyMap(resetLevelTo)),currentLevel=a,updateMessage(levels[currentLevel].message),setLevelWalls(),updatePlayableCanvas(),bombs=[],explosions=[],rubble=[];var b=levels[a].start;player.x=b.x,player.y=b.y}function copyMap(a){for(var b=[],c=0;c<a.length;c++){b.push([]);for(var d=0;d<a[c].length;d++)b[c].push(a[c][d])}return b}function loseLevel(){initLevel(currentLevel),loseShakeFactor=MAX_SHAKE}function initGame(){ctx.fillStyle="#000000",ctx.fillRect(0,0,canvas.width,canvas.height),initLevel(0),gameLoop()}function timestamp(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()}function gameLoop(){now=timestamp(),dt=(now-last)/1e3,updateGame(dt),drawGame(ctx),last=now,requestAnimFrame(gameLoop)}function updateBombTicks(){for(var a=bombs.length-1;a>=0;a--){var b=bombs[a];b.ticks--,b.ticks<=0&&(bombs.splice(a,1),doExplodeAt(b.x,b.y,b.power))}}function updateExplosions(){for(var a=explosions.length-1;a>=0;a--){var b=explosions[a];b.size--,b.size<=0&&explosions.splice(a,1)}}function makeRubble(a,b,c){for(var d=0;d<c;d++){var e=a*TILE+Math.random()*TILE,f=b*TILE+Math.random()*TILE,g={x:e,y:f,dx:16*Math.random()-8,dy:10*Math.random()-5,t:0,size:5,rotation:2*Math.random()*Math.PI};rubble.push(g)}}function updateRubble(){for(var a=rubble.length-1;a>=0;a--){var b=rubble[a];b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height||b.t>=RUBBLE_LIFE?rubble.splice(a,1):(b.x+=b.dx,b.y+=b.dy,b.rotation+=Math.abs(b.dx*b.dy),b.dx*=.99,b.dy+=.4,b.t+=dt)}}function breakTileAndAwardPoints(a,b){setTile(a,b,0),makeRubble(a,b,20),player.levelScore++}function objectAt(a,b,c,d){for(var e=0;e<c.length;e++){var f=c[e];if(f.x==a&&f.y==b&&("undefined"==typeof d||"undefined"!=typeof d&&d(f)))return e}return-1}function bombAt(a,b){return objectAt(a,b,bombs)}function explosionAt(a,b){return objectAt(a,b,explosions,function(a){return a.size>=24})}function doExplodeAt(a,b,c){explosions.push({x:a,y:b,size:TILE});for(var d in DIRECTION)for(var e=DIRECTION[d],f=0;f<=c;){var g={x:a+e.x*f,y:b+e.y*f},h=breakableTileAt(g.x,g.y),i=solidTileAt(g.x,g.y);if(i&&0==h){f=0;break}if(explosions.push({x:g.x,y:g.y,size:TILE}),h){breakTileAndAwardPoints(g.x,g.y);break}var j=bombAt(g.x,g.y);if(j!=-1){var k=bombs[j].power;bombs.splice(j,1),doExplodeAt(g.x,g.y,k)}f++}}function updateGame(a){if(solidTileAt(player.x+player.dx,player.y+player.dy)&&player.stop(),goalTileAt(player.x+player.dx,player.y+player.dy)){player.stop();var b=currentLevel+1;b>=levels.length&&(b=0,player.levelScore+player.score>player.highScore&&(player.highScore=player.levelScore+player.score),player.score=0,player.levelScore=0),initLevel(b)}lethalTileAt(player.x+player.dx,player.y+player.dy)&&(player.stop(),loseLevel()),0!=player.dx||0!=player.dy?player.movesSinceStationary++:player.movesSinceStationary>0&&(updateBombTicks(),player.movesSinceStationary=0),player.x+=player.dx,player.y+=player.dy,loseShakeFactor>1&&(loseShakeFactor*=.95),bombFlash=!bombFlash,updateExplosions(),updateRubble()}function placeBomb(){0==player.dx&&0==player.dy&&bombs.push({x:player.x,y:player.y,ticks:3,power:bombPower})}function solidTileAt(a,b){var c=tileAt(a,b);return 1==c||2==c}function breakableTileAt(a,b){return 2==tileAt(a,b)}function goalTileAt(a,b){return 3==tileAt(a,b)}function lethalTileAt(a,b){return 4==tileAt(a,b)||explosionAt(a,b)!=-1}function tileAt(a,b,c){var d=levels[currentLevel].map;return b<0||b>=d.length||a<0||a>=d[b].length?4:d[b][a]}function setTile(a,b,c){var d=levels[currentLevel].map;b<0||b>=d.length||a<0||a>=d[b].length||(d[b][a]=c)}function yWave(a){if(0==waveyEffectEnabled)return 0;var b=1e3-loseShakeFactor;return 6*Math.sin(now/b+a*TILE)}function fadeStrength(){return.05+(wasJustHurt()?.45:0)}function drawSquare(a,b,c,d,e,f){"undefined"==typeof f&&(f={x:0,y:0});var g=c;if("array"==typeof c){var h=d.createLinearGradient((a+.5)*TILE,(b+.5)*TILE,5,a*TILE,b*TILE,e);h.addColorStop(0,c[0]),h.addColorStop(1,c[1]),g=h}d.fillStyle=g,d.beginPath();var i={x:f.x+(TILE-e)/2,y:f.y+(TILE-e)/2};d.moveTo(a*TILE+i.x,b*TILE+yWave(a)+i.y),d.lineTo((a+1)*TILE-i.x,b*TILE+yWave(a+1)+i.y),d.lineTo((a+1)*TILE-i.x,(b+1)*TILE+yWave(a+1)-i.y),d.lineTo(a*TILE+i.x,(b+1)*TILE+yWave(a)-i.y),d.fill(),loseShakeFactor>1&&(d.fillStyle="rgba(255, 0, 0, "+loseShakeFactor/MAX_SHAKE+")",d.moveTo(a*TILE+i.x,b*TILE+yWave(a)+i.y),d.lineTo((a+1)*TILE-i.x,b*TILE+yWave(a+1)+i.y),d.lineTo((a+1)*TILE-i.x,(b+1)*TILE+yWave(a+1)-i.y),d.lineTo(a*TILE+i.x,(b+1)*TILE+yWave(a)-i.y),d.fill())}function drawFace(a,b,c,d,e,f){"undefined"==typeof f&&(f=!1);var g={x:(a+.3)*e,y:(b+.3)*e},h={x:(a+.7)*e,y:(b+.3)*e},i={x:(a+.5)*e,y:(b+.5)*e};d.fillStyle=c,d.beginPath(),d.arc(g.x,g.y+yWave(a),.1*e,0,2*Math.PI),d.fill(),d.beginPath(),d.arc(h.x,h.y+yWave(a),.1*e,0,2*Math.PI),d.fill(),d.beginPath();var j=f||wasJustHurt();d.arc(i.x,j?i.y+yWave(a)+.3*e:i.y+yWave(a),.4*e,j?Math.PI:0,j?2*Math.PI:Math.PI),d.fill()}function wasJustHurt(){return loseShakeFactor>50}function playableCanvasRect(){return{x:(canvas.width-playableCanvasSize)/2,y:(canvas.height-playableCanvasSize)/2,w:playableCanvasSize,h:playableCanvasSize}}function drawWaveyLine(a,b,c){var d=levels[currentLevel].map[0].length;a.strokeStyle="#ffffff",a.lineWidth=5,a.moveTo(b.x,b.y+yWave(0)),a.beginPath();for(var e=0;e<=d;e++){var f=e/d,g={x:b.x*f+c.x*(1-f),y:b.y*f+c.y*(1-f)};a.lineTo(g.x,g.y+yWave(e))}a.stroke()}function drawPlayableCanvas(a){var b=playableCanvasRect();drawWaveyLine(a,{x:b.x+b.w,y:b.y},{x:b.x,y:b.y}),drawWaveyLine(a,{x:b.x+b.w,y:b.y},{x:b.x+b.w,y:b.y+b.h}),drawWaveyLine(a,{x:b.x+b.w,y:b.y+b.h},{x:b.x,y:b.y+b.h}),drawWaveyLine(a,{x:b.x,y:b.y+b.h},{x:b.x,y:b.y})}function drawGame(a){fadeEffectEnabled?a.fillStyle="rgba(0, 0, 0, "+fadeStrength()+")":a.fillStyle="#000000",a.fillRect(0,0,canvas.width,canvas.height),options.draw(a),a.translate(levelViewTransform.tx,levelViewTransform.ty),a.scale(levelViewTransform.sx,levelViewTransform.sy),drawPlayer(d,c,a),drawBackWalls(levelWalls);for(var b=levels[currentLevel].map,c=0;c<b.length;c++)for(var d=0;d<b[c].length;d++)b[c][d]>1&&tileDraw[b[c][d]](d,c,a);drawWalls(levelWalls);for(var e=0;e<bombs.length;e++){var f=bombs[e];drawSquare(f.x,f.y,bombFlash?"#ffffff":"#ff3300",a,TILE),a.fillStyle="#000000",a.font="30px Verdana",a.fillText(f.ticks,f.x*TILE,(f.y+1)*TILE+yWave(f.x))}for(var g=0;g<explosions.length;g++){var h=explosions[g];drawSquare(h.x,h.y,bombFlash?"#ffffff":"#ffff00",a,h.size)}for(var i=0;i<rubble.length;i++){var j=rubble[i];a.fillStyle=COLOUR.BREAKABLE,a.save(),a.translate(j.x,j.y),a.rotate(-j.rotation),a.fillRect(-j.size/2,-j.size/2,j.size,j.size),a.restore()}a.scale(1/levelViewTransform.sx,1/levelViewTransform.sy),a.translate(-levelViewTransform.tx,-levelViewTransform.ty),drawPlayableCanvas(a),a.fillStyle="#ffffff",a.font="30px Arial",a.fillText("Score : "+(player.score+player.levelScore),30,50),a.fillText("Best : "+player.highScore,30,80),a.font="18px Arial",a.fillText(currentMessage,30,580)}function onKeyDown(a){var b=!1;switch(a.keyCode){case KEY.DOWN:player.setDirection(DIRECTION.DOWN),b=!0;break;case KEY.RIGHT:player.setDirection(DIRECTION.RIGHT),b=!0;break;case KEY.UP:player.setDirection(DIRECTION.UP),b=!0;break;case KEY.LEFT:player.setDirection(DIRECTION.LEFT),b=!0;break;case KEY.SPACE:levels[currentLevel]!=level_6&&placeBomb(),levels[currentLevel]==level_7&&updateMessage("Bombs count down with each move you make."),b=!0;break;case KEY.R:loseLevel()}b&&a.preventDefault()}function updateMessage(a){currentMessage=a}var canvas=document.getElementById("jindo-canvas"),ctx=canvas.getContext("2d"),COLOUR={WALL:"#990000",WALL_BACK:"#450000",BREAKABLE_BORDER:"#454545",BREAKABLE:"#676767",EXIT:"#00ff00",LETHAL:"#ff0000",LETHAL_FADEOUT:"rgba(255, 255, 0, 0)"},level_1={map:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,3,0,0],[0,1,1,1,0,0,0,0],[0,1,0,1,0,0,0,0],[0,0,0,0,0,2,0,1],[0,1,0,0,0,0,1,1],[0,1,1,0,1,0,0,0],[0,0,0,0,0,0,0,0]],start:{x:2,y:5},message:"Bombs will blow up 2 tiles in each direction"},level_2={map:[[0,0,0,0,1,0,1,0,0,0],[0,0,0,1,0,0,0,1,0,0],[0,0,2,0,0,0,0,0,0,0],[0,1,0,2,0,2,0,1,0,0],[0,0,0,0,1,3,1,0,0,0],[0,1,0,0,0,2,2,0,0,0],[0,0,2,0,0,0,0,0,0,0]],start:{x:4,y:2},message:"Break more blocks for a higher score"},level_3={map:[[1,1,1,1,1,1,1,1],[1,0,0,1,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,2,0,0,0,1],[4,2,0,0,0,0,0,1],[1,0,1,0,0,0,0,1],[3,0,0,0,0,0,2,1],[1,1,4,4,4,4,1,1]],start:{x:6,y:1},message:"Watch out for hazards"},level_4={map:[[0,2,0,3,0,0,0,0,2,0],[1,0,2,0,0,0,0,0,0,0],[0,0,0,2,2,0,0,2,0,0],[1,0,0,0,0,0,2,0,0,1],[0,0,0,0,0,0,0,0,0,0],[0,4,0,0,0,2,0,0,1,0],[1,0,0,2,0,0,0,1,0,0],[0,0,0,0,2,0,2,0,0,0]],start:{x:2,y:5},message:"Good luck!"},level_5={map:[[0,1,0,0,0,0,0],[0,0,0,0,0,0,1],[0,2,0,0,0,0,0],[0,0,0,2,0,3,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,1,0,0,0,0,0]],start:{x:1,y:6},message:"Don't be too close to your bomb when it explodes!"},level_6={map:[[1,1,1,1,1,1,1,1,1],[1,3,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1]],start:{x:1,y:3},message:"Use ARROW KEYS to move"},level_7={map:[[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,1,1,1,1,0,1],[1,0,1,0,0,1,0,1],[1,0,1,0,0,1,0,1],[1,0,1,1,1,1,0,1],[1,0,2,0,3,2,0,1],[1,1,1,1,1,1,1,1]],start:{x:1,y:6},message:"Press SPACE to place a bomb"},level_8={map:[[0,2,0,2,0,0,0,0],[2,0,0,0,2,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[2,0,0,0,2,0,2,0],[0,2,0,2,0,0,0,0],[0,0,0,2,0,0,0,0],[0,0,0,2,0,0,0,0],[0,0,0,3,0,0,0,0]],start:{x:3,y:5},message:""},level_9={map:[[4,4,1,4,4,4,4,4,4],[4,0,0,0,0,0,0,0,4],[4,0,0,0,0,0,0,2,4],[4,0,0,0,0,0,0,0,4],[4,4,2,4,4,1,0,2,4],[4,0,0,0,2,0,0,0,4],[2,0,0,0,0,0,0,0,4],[4,0,0,0,0,2,0,0,4],[4,0,0,2,4,0,0,0,2],[4,2,0,0,4,0,2,0,4],[4,4,3,4,4,4,4,4,4]],start:{x:2,y:2},message:""},level_10={map:[[0,0,0,3,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,2,0,0,4],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,1,0,0,0,2,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,2,0],[0,0,2,0,0,0,0,0,0,0,0],[0,2,0,0,0,0,0,0,2,0,0],[0,0,0,4,0,0,0,0,1,0,0]],start:{x:5,y:4},message:""},level_11={map:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3],[3,2,2,0,0,0,0,0,0,0,0,0,0,0,2,2,3],[3,2,2,0,2,2,2,2,2,2,2,2,2,0,2,2,3],[3,2,2,0,2,0,0,0,0,0,0,0,2,0,2,2,3],[3,2,2,0,2,0,2,2,2,2,2,0,2,0,2,2,3],[3,2,2,0,2,0,2,0,0,0,2,0,2,0,2,2,3],[3,2,2,0,2,0,2,0,0,0,2,0,2,0,2,2,3],[3,2,2,0,2,0,2,0,0,0,2,0,2,0,2,2,3],[3,2,2,0,2,0,2,2,2,2,2,0,2,0,2,2,3],[3,2,2,0,2,0,0,0,0,0,0,0,2,0,2,2,3],[3,2,2,0,2,2,2,2,2,2,2,2,2,0,2,2,3],[3,2,2,0,0,0,0,0,0,0,0,0,0,0,2,2,3],[3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],start:{x:8,y:7},message:"Bonus round"},player={x:0,y:0,dx:0,dy:0,levelScore:0,score:0,highScore:0,movesSinceStationary:0,stop:function(){this.dx=0,this.dy=0},win:function(){this.score+=this.levelScore,this.levelScore=0},lose:function(){this.levelScore=0},setDirection:function(a){0==this.dx&&0==this.dy&&(this.dx=a.x,this.dy=a.y)}},drawPlayer=function(a,b,c){drawSquare(player.x,player.y,"#ffcc00",c,TILE),drawFace(player.x,player.y,"#000000",c,TILE)},drawBackWall=function(a,b,c){drawSquare(a,b,COLOUR.WALL_BACK,c,TILE)},drawWall=function(a,b,c){var d=DistanceFromLevelCenter(a,b);drawSquare(a,b,COLOUR.WALL,c,TILE,d)},checkboxToggleWaveyEffect=new Checkbox(700,500,"Waves",function(a){waveyEffectEnabled=a},!0),checkboxToggleFadeEffect=new Checkbox(700,530,"Fades",function(a){fadeEffectEnabled=a},!0),options={draw:function(a){checkboxToggleWaveyEffect.draw(a),checkboxToggleFadeEffect.draw(a)}},drawHazard=function(a,b,c){c.fillStyle="#ff6600";for(var d=0;d<10;d++)c.beginPath(),c.arc((a+Math.random())*TILE,(b+Math.random())*TILE,1,0,2*Math.PI),c.fill();drawFace(a,b,"#ff6600",c,TILE,!0)},drawBreakableBlock=function(a,b,c){drawSquare(a,b,COLOUR.BREAKABLE_BORDER,c,TILE),drawSquare(a,b,COLOUR.BREAKABLE,c,22)},drawExit=function(a,b,c){drawSquare(a,b,COLOUR.EXIT,c,TILE),drawSquare(a,b,"#000000",c,22),drawSquare(a,b,COLOUR.EXIT,c,12)},tileDraw=[null,drawWall,drawBreakableBlock,drawExit,drawHazard];const TILE=32,RUBBLE_LIFE=1.25,MAX_SHAKE=500;var waveyEffectEnabled=!0,fadeEffectEnabled=!0,KEY={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,R:82};const playableCanvasSize=400;var levelViewTransform={tx:0,ty:0,sx:1,sy:1},bombs=[],explosions=[],rubble=[],bombPower=2,bombFlash=!1,loseShakeFactor=1,DIRECTION={UP:{x:0,y:-1},RIGHT:{x:1,y:0},DOWN:{x:0,y:1},LEFT:{x:-1,y:0}},getLevelWidth=function(){return levels[currentLevel].map[0].length},getLevelHeight=function(){return levels[currentLevel].map.length},resetLevelTo={},levels=[level_6,level_7,level_1,level_5,level_2,level_3,level_8,level_4,level_9,level_10,level_11],currentLevel=-1,currentMessage="",levelWalls=[],now,dt,last=timestamp();window.addEventListener("keydown",onKeyDown,!1),canvas.addEventListener("mousedown",checkForToggleClick,!1),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();